(function () {
    //start兼容event 火狐
	function __firefox(){
        HTMLElement.prototype.__defineGetter__("runtimeStyle", __element_style);
        window.constructor.prototype.__defineGetter__("event", __window_event);
        Event.prototype.__defineGetter__("srcElement", __event_srcElement);
    }

    function __element_style(){
        return this.style;
    }

    function __window_event(){
        return __window_event_constructor();
    }

    function __event_srcElement(){
        return this.target;
    }

    function __window_event_constructor(){
        if(document.all){
            return window.event;
        }

        var _caller = __window_event_constructor.caller;
        
        while(_caller != null){
            var _argument = _caller.arguments[0];

            if(_argument){
                var _temp = _argument.constructor;
                
                if(_temp.toString().indexOf("Event") != -1){
                    return _argument;
                }
            }

            _caller = _caller.caller;
        }

        return null;
    }

    if(window.addEventListener && (isFirefox = navigator.userAgent.indexOf("Firefox") > 0)){
        __firefox();
    }
	//end 兼容event 火狐
    
    var jfgrid = {};

    //通用方法
    //计算+-*/ 解决js精度问题
    jfgrid.floatTool = function() {
    
        /*
         * 判断obj是否为一个整数
         */
        function isInteger(obj) {
            return Math.floor(obj) === obj;
        }
        
        /*
         * 将一个浮点数转成整数，返回整数和倍数。如 3.14 >> 314，倍数是 100
         * @param floatNum {number} 小数
         * @return {object}
         *   {times:100, num: 314}
         */
        function toInteger(floatNum) {
            var ret = {times: 1, num: 0};

            if (isInteger(floatNum)) {
                ret.num = floatNum;
                return ret;
            }

            var strfi  = floatNum + '';
            var dotPos = strfi.indexOf('.');
            var len    = strfi.substr(dotPos + 1).length;
            var times  = Math.pow(10, len);
            var intNum = parseInt(floatNum * times + 0.5, 10);

            ret.times  = times;
            ret.num    = intNum;

            return ret;
        }
        
        /*
         * 核心方法，实现加减乘除运算，确保不丢失精度
         * 思路：把小数放大为整数（乘），进行算术运算，再缩小为小数（除）
         *
         * @param a {number} 运算数1
         * @param b {number} 运算数2
         * @param digits {number} 精度，保留的小数点数，比如 2, 即保留为两位小数
         * @param op {string} 运算类型，有加减乘除（add/subtract/multiply/divide）
         *
         */
        function operation(a, b, op) {
            var o1 = toInteger(a);
            var o2 = toInteger(b);
            var n1 = o1.num;
            var n2 = o2.num;
            var t1 = o1.times;
            var t2 = o2.times;
            var max = t1 > t2 ? t1 : t2;
            var result = null;

            switch (op) {
                case 'add':
                    if (t1 === t2) { // 两个小数位数相同
                        result = n1 + n2;
                    } 
                    else if (t1 > t2) { // o1 小数位 大于 o2
                        result = n1 + n2 * (t1 / t2);
                    } 
                    else { // o1 小数位 小于 o2
                        result = n1 * (t2 / t1) + n2;
                    }

                    return result / max;
                case 'subtract':
                    if (t1 === t2) {
                        result = n1 - n2;
                    } 
                    else if (t1 > t2) {
                        result = n1 - n2 * (t1 / t2);
                    } 
                    else {
                        result = n1 * (t2 / t1) - n2;
                    }

                    return result / max;
                case 'multiply':
                    result = (n1 * n2) / (t1 * t2);
                    
                    return result;
                case 'divide':
                    return result = function() {
                        var r1 = n1 / n2;
                        var r2 = t2 / t1;
                        return operation(r1, r2, 'multiply');
                    }();
            }
        }
        
        // 加减乘除的四个接口
        function add(a, b) {
            return operation(a, b, 'add');
        }
        function subtract(a, b) {
            return operation(a, b, 'subtract');
        }
        function multiply(a, b) {
            return operation(a, b, 'multiply');
        }
        function divide(a, b) {
            return operation(a, b, 'divide');
        }
        
        // exports
        return {
            add: add,
            subtract: subtract,
            multiply: multiply,
            divide: divide
        };
    }();

    //判断一个字符串是否为标准JSON格式
    jfgrid.isJsonString = function(str){
        try{
            if(typeof JSON.parse(str) == "object"){
                return true;
            }
        } catch(e){}
        return false;
    }

    //判断一个变量是否为纯数字，null/""/undefined/"34rt"/"34e" 不为数字，34/"34"/"34e10"为数字
    jfgrid.isRealNum = function(val){
        if(val === "" || val ==null){
            return false;
        }
        if(!isNaN(val)){
            return true;
        }else{
            return false;
        }
    }

    //data:[["1","dd","haha", {d:"xyz", color:"#ffffff", bg:"#000000",fa:"宋体|微软雅黑|...",size:"20px",weight:"normal|bold",style:"normal|italic",decoration:"underline|line-through|overline"},"哈啊哈哈"],[],[],[]]
    var defaultSetting = {
        container: "jfgrid", //容器的ID
        column: 60, //空表格默认的列数量
        row: 84, //空表格默认的行数据量
        allowCopy: true, //是否允许拷贝
        showtoolbar: true, //是否第二列显示工具栏
        showinfobar: true, //是否显示顶部名称栏
        showsheetbar: true, //是否显示底部表格名称区域
        showstatisticBar: true, //是否显示底部计数栏
        pointEdit: false, //是否是编辑器插入表格模式
        pointEditUpdate: null, //编辑器表格更新函数
        pointEditZoom: 1, //编辑器表格编辑时缩放比例
        // menu: "undo|redo|freezenrow|freezencolumn|download|share|chart|pivot",
        data: [{ "name": "Sheet1", color: "", "status": "1", "order": "0", "data": [], "config": {}, "index":0 }, { "name": "Sheet2", color: "", "status": "0", "order": "1", "data": [], "config": {}, "index":1  }, { "name": "Sheet3", color: "", "status": "0", "order": "2", "data": [], "config": {}, "index":2  }], //客户端sheet数据[shee1, sheet2, sheet3]
        title: "Luckysheet Demo", //表格的名称
        userInfo: '<i style="font-size:16px;color:#ff6a00;" class="fa fa-taxi" aria-hidden="true"></i> rabbit', //右上角的用户信息展示样式
        userMenuItem: [{url:"www.baidu.com", "icon":'<i class="fa fa-folder" aria-hidden="true"></i>', "name":"我的表格"}, {url:"www.baidu.com", "icon":'<i class="fa fa-sign-out" aria-hidden="true"></i>', "name":"退出登陆"}], //点击右上角的用户信息弹出的菜单
        myFolderUrl: "www.baidu.com", //左上角<返回按钮的链接
        config: {}, //表格行高、列宽、合并单元格、公式等设置
        fullscreenmode: true, //是否全屏模式，非全屏模式下，标记框不会强制选中。
        devicePixelRatio: window.devicePixelRatio, //设备比例，比例越大表格分标率越高
        allowEdit: true, //是否允许前台编辑
        loadUrl: "", // 配置loadUrl的地址，luckysheet会通过ajax请求表格数据，默认载入status为1的sheet数据中的所有data，其余的sheet载入除data字段外的所有字段
        loadSheetUrl: "", //配置loadSheetUrl的地址，参数为gridKey（表格主键） 和 index（sheet主键合集，格式为[1,2,3]），返回的数据为sheet的data字段数据集合
        gridKey: "", // 表格唯一标识符
        updateUrl: "", //表格数据的更新地址
        updateImageUrl: "", //缩略图的更新地址
        allowUpdate: false, //是否允许编辑后的后台更新
        functionButton: "", //右上角功能按钮，例如'<button id="" class="btn btn-primary" style="padding:3px 6px;font-size: 12px;margin-right: 10px;">下载</button>    <button id="" class="btn btn-primary btn-danger" style="    padding:3px 6px;    font-size: 12px;    margin-right: 10px;">分享</button>    <button id="jfgrid-share-btn-title" class="btn btn-primary btn-danger" style="    padding:3px 6px;    font-size: 12px;    margin-right: 10px;">秀数据</button>'
        showConfigWindowResize: true, //图表和数据透视表的配置会在右侧弹出，设置弹出后表格是否会自动缩进
        enableAddRow: true,//允许增加行
        enableAddCol: true,//允许增加列
        enablePage: false,//允许加载下一页
        autoFormatw: false,  //自动格式化超过4位数的数字为 亿万格式 例：true or "true" or "TRUE"
        accuracy: undefined,  //设置传输来的数值的精确位数，小数点后n位 传参数为数字或数字字符串，例： "0" 或 0
        pageInfo:{
            // "allFront": [],
            // "isTpshow": "",
            // "pageSize": 5000,
            // "totalPage": 10,
            // "currentPage": 0,
            // "pageUrl": "",
            // "id": '',
            // "dfs": [],
            // "filter": [],
            // "sort": [],
            // "startDate": '',
            // "endDate": '',
            // 'isNow': "",
            // 'gdateNum': ""

            // rptapp
            'queryExps':'',
            'reportId':'',
            'fields':'',
            'mobile':'',
            'frezon':'',
            'currentPage':'',
            "totalPage":10,
            "pageUrl":"",
        },
        editMode: false, //是否为编辑模式
        chartConfigChange: null,//图表插件中图表更新触发的自定义方法
        beforeCreateDom: null,//表格创建之前的方法
        fireMousedown: null //单元格数据下钻
    };

    //dom变量
    var gridHTML =  '<div class="jfgrid">' +
                        '<canvas id="jfgridTableContentF" style="display:none;" class="jfgridTableContent"></canvas>' + 
                        '<div class="jfgrid-work-area jfgrid-noselected-text">' + 
                            '<div class="jfgrid-share-logo" title="${logotitle}"></div>' + 
                            '<div id ="jfgrid_info_detail" class="jfgrid_info_detail">' + 
                                '<div data-tips="返回" id="jfgrid_info_detail_title" class="jfgrid_info_detail_title">' + 
                                    '<i style="margin-left: -2px;" class="fa fa-chevron-left" aria-hidden="true"></i>' + 
                                '</div>' + 
                                '<div>' + 
                                    '<input data-tips="表格重命名" id="jfgrid_info_detail_input" class="jfgrid_info_detail_input jfgrid-mousedown-cancel" value="无标题的电子表格" tabindex="0" dir="ltr" aria-label="重命名" style="visibility: visible; width: 149px;" data-tooltip="重命名">' + 
                                '</div>' + 
                                '<div id="jfgrid_info_detail_update" class="jfgrid_info_detail_update"> 新打开 </div>' + 
                                '<div id="jfgrid_info_detail_save" class="jfgrid_info_detail_save"> 待更新 </div>' + 
                                '<div class="jfgrid_info_detail_user"> ${functionButton} <span id="jfgrid_info_detail_user"></span> </div>' + 
                            '</div>' + 
                            '<div id="jfgrid-wa-editor" class="jfgrid-wa-editor"> ${menu} </div>' + 
                            '<div id="jfgrid-wa-calculate" class="jfgrid-wa-calculate">' + 
                                '<div class="jfgrid-wa-calculate-size" id="jfgrid-wa-calculate-size"></div>' + 
                                '<div class="jfgrid-wa-calculate-help">' + 
                                    '<div class="jfgrid-wa-calculate-help-box">' + 
                                        '<div spellcheck="false" aria-hidden="false" id="jfgrid-helpbox">' +
                                            '<div id="jfgrid-helpbox-cell" class="jfgrid-helpbox-cell-input jfgrid-mousedown-cancel" tabindex="0" contenteditable="true" dir="ltr" aria-autocomplete="list"></div>' +
                                        '</div>' + 
                                    '</div>' +  
                                    '<div class="jfgrid-wa-calculate-help-tool">' +
                                        '<i class="fa fa-caret-down" aria-hidden="true" style="margin-top: 7px;"></i>' +
                                    '</div>' + 
                                '</div>' + 
                                '<div id="jfgrid-wa-functionbox-cancel" class="jfgrid-wa-functionbox">' +
                                    '<span><i class="fa fa-remove" aria-hidden="true"></i></span>' +
                                '</div>' + 
                                '<div id="jfgrid-wa-functionbox-confirm" class="jfgrid-wa-functionbox">' +
                                    '<span><i class="fa fa-check" aria-hidden="true"></i></span>' +
                                '</div>' + 
                                '<div id="jfgrid-wa-functionbox-fx" class="jfgrid-wa-functionbox">' + 
                                    '<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAQAAAD9CzEMAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAAAAmJLR0QA/4ePzL8AAAAJcEhZcwAADsMAAA7DAcdvqGQAAAAHdElNRQfdBg4KFCeL2MAqAAACOUlEQVRYw+3Wy2+MURjH8U9Hp0VLVTTRUupWqfs9xEpE3ULSsLK0qVg0rJAgiD/A2kpCQkJC0rhEJMJampBSFYle0BYNMUNKTY+F0bi10zFjIZnvuzrPe57fc3mfnPeQI0eO/5+8tHaPVW22cn1aNYlnO5nlzmgzIAiazcm2/FoPBEHMY+2uKcqufKlGQcIt29RYYl6azU3JLh8E99VkuzHfKHZekHDw38hT5Zmg17L0XSMj2jVXGTq9+lcBZilAp1j6AfKHfVtmh1IDauWjQoPPIp64IpF+qD+xSKfw23PV6GxV0KdFHJWKJLwQR0SbgezkT1SFSivcE3SrM9U005WlIzF8Bf1eokAUMQ89T9oLjdWfPOwixssT1/9niZFMUakJ+Kg3uV7olKtOm4kx6jU6qzqTRq33VnBHIahy0z0dgmPy7NGjx23ThnIeSQUTlKA7OZrjNNvtHNaoc8hFm+33MpMK9giCU4PJFGKrz7o8dVnF8M6pK4iYDLoGh/MT2jw32TuHU+WeOkC+KQi/CPXqwA2PUueXigIz8UnnT9b5ZmF68sNnFKBEFbq9/sFW7bioLxYpzjzAamV4pAtElahwQtQRb1WaZ4rtxqVUGZLv/7IDyfVGl1zXbpOJmgTnXXBXZfrCk9RabKmTYoIWc5P2o2La1RslYr8OPe5a9zeZ7/TGMx0Sgvf2Dt4hamyxMnmCFVllgxl/15oGcUHwRYt9mdyBhrrdlFtgtkIvNGvN3vmfI0eO/5Ov+PeiZHME+tcAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTYtMDktMTdUMTU6MTk6MDcrMDg6MDARPBuqAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDEzLTA2LTE0VDEwOjIwOjM5KzA4OjAw59f0jAAAAE10RVh0c29mdHdhcmUASW1hZ2VNYWdpY2sgNy4wLjEtNiBRMTYgeDg2XzY0IDIwMTYtMDktMTcgaHR0cDovL3d3dy5pbWFnZW1hZ2ljay5vcmfd2aVOAAAAGHRFWHRUaHVtYjo6RG9jdW1lbnQ6OlBhZ2VzADGn/7svAAAAF3RFWHRUaHVtYjo6SW1hZ2U6OkhlaWdodAA3Nkv1+ekAAAAWdEVYdFRodW1iOjpJbWFnZTo6V2lkdGgANzazWjlkAAAAGXRFWHRUaHVtYjo6TWltZXR5cGUAaW1hZ2UvcG5nP7JWTgAAABd0RVh0VGh1bWI6Ok1UaW1lADEzNzExNzY0MzntxStTAAAAEHRFWHRUaHVtYjo6U2l6ZQA5OTdClByG1AAAAF90RVh0VGh1bWI6OlVSSQBmaWxlOi8vL2hvbWUvd3d3cm9vdC9zaXRlL3d3dy5lYXN5aWNvbi5uZXQvY2RuLWltZy5lYXN5aWNvbi5jbi9zcmMvMTExNTkvMTExNTkzNy5wbmeOkn0GAAAAAElFTkSuQmCC" alt="" style="vertical-align:middle"/>' +
                                '</div>' + 
                                '<div id="jfgrid-functionbox-container" class="jfgrid-mousedown-cancel">' +
                                    '<div class="jfgrid-mousedown-cancel" dir="ltr">' +
                                        '<div spellcheck="false" aria-hidden="false" id="jfgrid-functionbox">' +
                                            '<div id="jfgrid-functionbox-cell" class="jfgrid-functionbox-cell-input jfgrid-mousedown-cancel" tabindex="0" contenteditable="true" dir="ltr" aria-autocomplete="list" aria-label="D4"></div>' +
                                        '</div>' +
                                    '</div>' +
                                '</div>' +   
                            '</div>' + 
                        '</div>' + 
                        '<div class="jfgrid-grid-container jfgrid-scrollbars-enabled">' + 
                            '<div class="jfgrid-grid-window">' + 
                                '<div class="jfgrid-help-sub"></div>' + 
                                '<div class="jfgrid-grid-window-1" id="jfgrid-grid-window-1">' +
                                    '<canvas id="jfgridTableContent" class="jfgridTableContent"></canvas>' + 
                                    '<table class="jfgrid-grid-window-2" cellspacing="0" cellpadding="0" dir="ltr" tabindex="-1" >' + 
                                        '<tbody>' + 
                                            '<tr>' + 
                                                '<td valign="top" class="jfgrid-paneswrapper">' + 
                                                    '<div class="jfgrid-left-top" id="jfgrid-left-top"> </div>' + 
                                                '</td>' + 
                                                '<td valign="top" class="jfgrid-paneswrapper">' + 
                                                    '<div id="jfgrid-cols-h-c" class="jfgrid-cols-h-c">' +
                                                        '<div class="jfgrid-cols-change-size" id="jfgrid-cols-change-size"></div>' +  
                                                        '<div class="jfgrid-cols-menu-btn jfgrid-mousedown-cancel" id="jfgrid-cols-menu-btn"><i class="fa fa-caret-down jfgrid-mousedown-cancel" aria-hidden="true"></i></div>' +  
                                                        '<div class="jfgrid-cols-h-hover" id="jfgrid-cols-h-hover"></div>' +  
                                                        '<div id="jfgrid-cols-h-selected"></div>' +  
                                                        '<div class="jfgrid-grdusedrange"></div>' +  
                                                        '<div class="jfgrid-grdblkflowpush"></div>  ${columnHeader}' +
                                                    '</div>' +
                                                '</td>' +
                                            '</tr>' +
                                            '<tr>' +
                                                '<td valign="top" class="jfgrid-paneswrapper">' + 
                                                    '<div class="jfgrid-rows-h" id="jfgrid-rows-h">' + 
                                                        '<div class="jfgrid-rows-change-size" id="jfgrid-rows-change-size"></div>' + 
                                                        '<div class="jfgrid-rows-h-hover" id="jfgrid-rows-h-hover"></div>' + 
                                                        '<div id="jfgrid-rows-h-selected"></div>' +  
                                                        '<div class="jfgrid-grdusedrange"></div>' +  
                                                        '<div class="jfgrid-grdblkflowpush"></div> ${rowHeader}' +
                                                    '</div>' + 
                                                '</td>' +  
                                                '<td valign="top" class="jfgrid-paneswrapper">' +
                                                    '<div class="jfgrid-cell-loading" id="jfgrid-cell-loading">' +
                                                        '<div class="jfgrid-cell-loading-inner">' +
                                                            '<i class="fa fa-circle-o-notch fa-spin"></i>' +
                                                            '<span></span>' +
                                                        '</div>' +
                                                    '</div>' + 
                                                    '<div class="jfgrid-cell-freezen"></div>' + 
                                                    '<div class="jfgrid-scrollbars jfgrid-scrollbar-ltr jfgrid-scrollbar-x" id="jfgrid-scrollbar-x"><div></div></div>' + 
                                                    '<div class="jfgrid-scrollbars jfgrid-scrollbar-ltr jfgrid-scrollbar-y" id="jfgrid-scrollbar-y"><div></div></div>' + 
                                                    '<div class="jfgrid-cell-main " id="jfgrid-cell-main">' +
                                                        '<div id="jfgrid-formula-functionrange"></div>' +  
                                                        '<div id="jfgrid-formula-functionrange-select" class="jfgrid-selection-copy jfgrid-formula-functionrange-select">' +
                                                            '<div class="jfgrid-selection-copy-top jfgrid-copy"></div>' +
                                                            '<div class="jfgrid-selection-copy-right jfgrid-copy"></div>' +
                                                            '<div class="jfgrid-selection-copy-bottom jfgrid-copy"></div>' +
                                                            '<div class="jfgrid-selection-copy-left jfgrid-copy"></div>' +
                                                            '<div class="jfgrid-selection-copy-hc"></div>' +
                                                        '</div>' +  
                                                        '<div class="jfgrid-row-count-show jfgrid-count-show" id="jfgrid-row-count-show"></div>' +
                                                        '<div class="jfgrid-column-count-show jfgrid-count-show" id="jfgrid-column-count-show"></div>' +
                                                        '<div class="jfgrid-change-size-line" id="jfgrid-change-size-line"></div>' +  
                                                        '<div class="jfgrid-cell-selected-focus" id="jfgrid-cell-selected-focus"></div>' +  
                                                        '<div id="jfgrid-selection-copy"></div>' +  
                                                        '<div id="jfgrid-chart-rangeShow"></div>' +
                                                        '<div class="jfgrid-cell-selected-extend" id="jfgrid-cell-selected-extend"></div>' +  
                                                        '<div class="jfgrid-cell-selected-move" id="jfgrid-cell-selected-move"></div>' +  
                                                        '<div id="jfgrid-cell-selected-boxs">' +
                                                            '<div id="jfgrid-cell-selected" class="jfgrid-cell-selected">' +
                                                                '<div class="jfgrid-cs-inner-border"></div>' +
                                                                '<div class="jfgrid-cs-fillhandle"></div>' +
                                                                '<div class="jfgrid-cs-inner-border"></div>' +
                                                                '<div class="jfgrid-cs-draghandle-top jfgrid-cs-draghandle"></div>' +
                                                                '<div class="jfgrid-cs-draghandle-bottom jfgrid-cs-draghandle"></div>' +
                                                                '<div class="jfgrid-cs-draghandle-left jfgrid-cs-draghandle"></div>' +
                                                                '<div class="jfgrid-cs-draghandle-right jfgrid-cs-draghandle"></div>' +
                                                            '</div>' +
                                                        '</div>' +
                                                        '<div id="jfgrid-postil-showBoxs"></div>' +
                                                        '<div id="jfgrid-multipleRange-show"></div>' +  
                                                        '<div id="jfgrid-dynamicArray-hightShow"></div>' +  
                                                        '<div class="jfgrid-cell-copy"></div>' +  
                                                        '<div class="jfgrid-grdblkflowpush"></div>  ${flow}' + 
                                                    '</div>' + 
                                                '</td>' + 
                                            '</tr>' + 
                                        '</tbody>' + 
                                    '</table>' + 
                                '</div>' + 
                                '<div class="jfgrid-sheet-area jfgrid-noselected-text" id="jfgrid-sheet-area">' +
                                    '<div id="jfgrid-sheets-add" class="btn btn-default jfgrid-sheets-add"><i class="fa fa-plus"></i></div>' +
                                    '<div id="jfgrid-sheets-m" class="btn btn-default jfgrid-sheets-m"><i class="fa fa-bars"></i></div>' +
                                    '<div class="jfgrid-sheet-container" id="jfgrid-sheet-container">' +
                                        '<div class="docs-sheet-fade docs-sheet-fade-left" style="display: none;">' +
                                            '<div class="docs-sheet-fade3"></div>' +
                                            '<div class="docs-sheet-fade2"></div>' +
                                            '<div class="docs-sheet-fade1"></div>' +
                                        '</div>' +
                                        '<div class="docs-sheet-fade docs-sheet-fade-right" style="display: none;">' +
                                            '<div class="docs-sheet-fade1"></div>' +
                                            '<div class="docs-sheet-fade2"></div>' +
                                            '<div class="docs-sheet-fade3"></div>' +
                                        '</div>' +
                                        '<div class="jfgrid-sheet-container-c" id="jfgrid-sheet-container-c"></div>' +
                                    '</div>' +
                                    '<div id="jfgrid-sheets-leftscroll" class="btn btn-default jfgrid-sheets-scroll"><i class="fa fa-caret-left"></i></div>' +
                                    '<div id="jfgrid-sheets-rightscroll" class="btn btn-default jfgrid-sheets-scroll"><i class="fa fa-caret-right"></i></div>' +
                                '</div>' + 
                            '</div>' + 
                            '<div class="jfgrid-stat-area">' + 
                                '<div class="jfgrid-sta-c">' +
                                    '<div class="jfgrid-sta-content" id="jfgrid-sta-content"></div>' +  
                                    '<div class="jfgrid-bottom-content" id="jfgrid-bottom-content-show"></div>' +  
                                '</div>' + 
                            '</div>' + 
                        '</div>' +
                        '<div id="jfgird-copy-content" contenteditable="true"></div>' +
                        '<input id="jfgird-copy-btn" type="button" data-clipboard-target="jfgird-copy-content">' +
                        '<div id="testdpidiv" style="height: 1in; left: -100%; position: absolute; top: -100%; width: 1in;"></div>' +
                    '</div>',
        columeHeader_word = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z'],
        columeHeader_word_index = { 'A': 0, 'B': 1, 'C': 2, 'D': 3, 'E': 4, 'F': 5, 'G': 6, 'H': 7, 'I': 8, 'J': 9, 'K': 10, 'L': 11, 'M': 12, 'N': 13, 'O': 14, 'P': 15, 'Q': 16, 'R': 17, 'S': 18, 'T': 19, 'U': 20, 'V': 21, 'W': 22, 'X': 23, 'Y': 24, 'Z': 25 },
        flow = '<div id="jfgrid-cell-flow_${index}" class="jfgrid-cell-flow jfgridsheetchange" style="width:${width}px;"><div class="jfgrid-cell-flow-clip"><div class="jfgrid-grdblkpush"></div>${flow}</div></div>',
        colsmenuHTML = '',
        rightclickHTML = '<div class="jfgrid-cols-menu jfgrid-rightgclick-menu jfgrid-mousedown-cancel" id="jfgrid-rightclick-menu"><div class="jfgrid-cols-menuitem jfgrid-mousedown-cancel jfgrid-copy-btn" id="jfgrid-copy-btn" data-clipboard-action="copy" data-clipboard-target="#jfgird-copy-content"><div class="jfgrid-cols-menuitem-content jfgrid-mousedown-cancel">复制</div></div><div class="jfgrid-cols-menuitem jfgrid-cols-submenu jfgrid-mousedown-cancel" id="jfgridcopyfor"><div class="jfgrid-cols-menuitem-content jfgrid-mousedown-cancel">复制为<span class="jfgrid-submenu-arrow" style="user-select: none;">►</span></div></div><div class="jfgrid-cols-menuitem jfgrid-mousedown-cancel" id="jfgrid-copy-paste"><div class="jfgrid-cols-menuitem-content jfgrid-mousedown-cancel">粘贴</div></div>            <div id="jfgrid-cols-rows-add"><div class="jfgrid-menuseparator jfgrid-mousedown-cancel" role="separator"></div>    <div class="jfgrid-cols-menuitem jfgrid-mousedown-cancel"><div class="jfgrid-cols-menuitem-content jfgrid-mousedown-cancel">向<span class="jfgrid-cols-rows-shift-left">左</span>增加<input type="text" class="jfgrid-mousedown-cancel" placeholder="数字" value="1" style="width:40px;height:18px;margin-left:5px;"/><span class="jfgrid-cols-rows-shift-word jfgrid-mousedown-cancel">列</span><button id="jfgrid-add-lefttop" class="btn btn-primary jfgrid-copy-btn jfgrid-mousedown-cancel" style="margin-left:5px;padding:2px 3px;line-height:12px;font-size:12px;">确认</button></div></div>     <div class="jfgrid-cols-menuitem jfgrid-mousedown-cancel"><div class="jfgrid-cols-menuitem-content jfgrid-mousedown-cancel">向<span class="jfgrid-cols-rows-shift-right">右</span>增加<input type="text" class="jfgrid-mousedown-cancel" placeholder="数字" value="1" style="width:40px;height:18px;margin-left:5px;"/><span class="jfgrid-cols-rows-shift-word jfgrid-mousedown-cancel">列</span><button id="jfgrid-add-rightbottom" class="btn btn-primary jfgrid-copy-btn jfgrid-mousedown-cancel" style="margin-left:5px;padding:2px 3px;line-height:12px;font-size:12px;">确认</button></div></div><div class="jfgrid-cols-menuitem jfgrid-mousedown-cancel" id="jfgrid-del-selected"><div class="jfgrid-cols-menuitem-content jfgrid-mousedown-cancel">删除选中<span class="jfgrid-cols-rows-shift-word jfgrid-mousedown-cancel">列</span></div></div><div class="jfgrid-cols-menuitem jfgrid-mousedown-cancel"><div class="jfgrid-cols-menuitem-content jfgrid-mousedown-cancel"><span class="jfgrid-cols-rows-shift-word jfgrid-mousedown-cancel">列</span><span class="jfgrid-cols-rows-shift-size jfgrid-mousedown-cancel">宽</span><input type="number" class="jfgrid-mousedown-cancel rcsize" min="0" max="255" placeholder="数字" value="" style="width:40px;height:18px;margin-left:5px;">px<button id="jfgrid-rows-cols-changesize" class="btn btn-primary jfgrid-copy-btn jfgrid-mousedown-cancel" style="margin-left:5px;padding:2px 3px;line-height:12px;font-size:12px;">确认</button></div></div></div>       <div id="jfgrid-cols-rows-shift"> <div class="jfgrid-menuseparator jfgrid-mousedown-cancel" role="separator"></div><div id="jfgridorderbyasc" class="jfgrid-cols-menuitem jfgrid-mousedown-cancel"><div class="jfgrid-cols-menuitem-content jfgrid-mousedown-cancel">A-Z顺序排列</div></div><div class="jfgrid-cols-menuitem jfgrid-mousedown-cancel" id="jfgridorderbydesc"><div class="jfgrid-cols-menuitem-content jfgrid-mousedown-cancel">Z-A降序排列</div></div></div>                <div id="jfgrid-cols-rows-data"><div class="jfgrid-menuseparator jfgrid-mousedown-cancel" role="separator"></div><div id="jfgrid-delete-text" class="jfgrid-cols-menuitem jfgrid-mousedown-cancel"><div class="jfgrid-cols-menuitem-content jfgrid-mousedown-cancel">清除内容</div></div><div id="jfgridmatrix" class="jfgrid-cols-menuitem jfgrid-cols-submenu jfgrid-mousedown-cancel"><div class="jfgrid-cols-menuitem-content jfgrid-mousedown-cancel">矩阵操作选区<span class="jfgrid-submenu-arrow" style="user-select: none;">►</span></div></div><div id="jfgridorderby" class="jfgrid-cols-menuitem jfgrid-mousedown-cancel"><div class="jfgrid-cols-menuitem-content jfgrid-mousedown-cancel">排序选区</div></div><div class="jfgrid-cols-menuitem jfgrid-mousedown-cancel" id="jfgridfilter"><div class="jfgrid-cols-menuitem-content jfgrid-mousedown-cancel">筛选选区</div></div><div class="jfgrid-cols-menuitem jfgrid-mousedown-cancel" id="jfgriddatavisual"><div class="jfgrid-cols-menuitem-content jfgrid-mousedown-cancel">图表生成</div></div></div>      </div> <div class="jfgrid-cols-menu jfgrid-rightgclick-menu jfgrid-rightgclick-menu-sub jfgrid-mousedown-cancel" id="jfgridcopyfor_sub"><div class="jfgrid-cols-menuitem jfgrid-mousedown-cancel"><div class="jfgrid-cols-menuitem-content jfgrid-mousedown-cancel">Json<button id="jfgrid-copy-json-head" data-clipboard-action="copy" data-clipboard-target="#jfgird-copy-content" class="btn btn-primary jfgrid-copy-btn jfgrid-mousedown-cancel" style="margin-left:5px;padding:2px 3px;line-height:12px;font-size:12px;">首行为标题</button><button id="jfgrid-copy-json-nohead" class="btn btn-primary jfgrid-copy-btn jfgrid-mousedown-cancel" data-clipboard-action="copy" data-clipboard-target="#jfgird-copy-content" style="margin-left:5px;padding:2px 3px;line-height:12px;font-size:12px;">无标题</button></div></div><div data-clipboard-action="copy" data-clipboard-target="#jfgird-copy-content" class="jfgrid-cols-menuitem jfgrid-copy-btn jfgrid-mousedown-cancel" id="jfgrid-copy-array1"><div class="jfgrid-cols-menuitem-content jfgrid-mousedown-cancel">一维数组</div></div><div id="jfgrid-copy-array2" data-clipboard-action="copy" data-clipboard-target="#jfgird-copy-content" class="jfgrid-cols-menuitem jfgrid-copy-btn jfgrid-mousedown-cancel"><div class="jfgrid-cols-menuitem-content jfgrid-mousedown-cancel">二维数组</div></div><div class="jfgrid-cols-menuitem jfgrid-mousedown-cancel"><div class="jfgrid-cols-menuitem-content jfgrid-mousedown-cancel"><div class="jfgrid-mousedown-cancel">多维数组</div><div><input type="number" min="1" class="jfgrid-mousedown-cancel"placeholder="行" style="width:40px;height:18px;" id="jfgrid-copy-arraymore-row"/>×<input type="number" min="1" class="jfgrid-mousedown-cancel" placeholder="列" style="width:40px;height:18px;" id="jfgrid-copy-arraymore-col"/><button id="jfgrid-copy-arraymore-confirm" data-clipboard-action="copy" data-clipboard-target="#jfgird-copy-content" class="btn btn-primary jfgrid-copy-btn jfgrid-mousedown-cancel" style="margin-left:5px;padding:2px 3px;line-height:12px;font-size:12px;">确认</button></div></div></div><div class="jfgrid-menuseparator jfgrid-mousedown-cancel" role="separator"></div><div id="jfgrid-copy-diagonal" data-clipboard-action="copy" data-clipboard-target="#jfgird-copy-content" class="jfgrid-cols-menuitem jfgrid-copy-btn jfgrid-mousedown-cancel"><div class="jfgrid-cols-menuitem-content jfgrid-mousedown-cancel">对角线</div></div><div data-clipboard-action="copy" data-clipboard-target="#jfgird-copy-content" id="jfgrid-copy-antidiagonal" class="jfgrid-cols-menuitem jfgrid-copy-btn jfgrid-mousedown-cancel"><div class="jfgrid-cols-menuitem-content jfgrid-mousedown-cancel">反对角线</div></div><div class="jfgrid-cols-menuitem jfgrid-mousedown-cancel"><div class="jfgrid-cols-menuitem-content jfgrid-mousedown-cancel">对角偏移<input type="number" class="jfgrid-mousedown-cancel" placeholder="偏移量" id="jfgrid-copy-diagonaloffset-value" value="1" style="width:40px;height:18px;margin-left:5px;"/>列<button id="jfgrid-copy-diagonaloffset" class="btn btn-primary jfgrid-copy-btn jfgrid-mousedown-cancel" data-clipboard-action="copy" data-clipboard-target="#jfgird-copy-content" style="margin-left:5px;padding:2px 3px;line-height:12px;font-size:12px;">确认</button></div></div><div id="jfgrid-copy-boolvalue" data-clipboard-action="copy" data-clipboard-target="#jfgird-copy-content" class="jfgrid-cols-menuitem jfgrid-copy-btn jfgrid-mousedown-cancel"><div class="jfgrid-cols-menuitem-content jfgrid-mousedown-cancel">布尔值</div></div></div><div class="jfgrid-cols-menu jfgrid-rightgclick-menu jfgrid-rightgclick-menu-sub jfgrid-mousedown-cancel" id="jfgridmatrix_sub"><div class="jfgrid-cols-menuitem jfgrid-mousedown-cancel"><div class="jfgrid-cols-menuitem-content jfgrid-mousedown-cancel">翻转<button class="btn btn-primary jfgrid-mousedown-cancel" style="margin-left:5px;padding:2px 3px;line-height:12px;font-size:12px;" id="jfgrid-matrix-turn-up">上下</button><button class="btn btn-primary jfgrid-mousedown-cancel" style="margin-left:5px;padding:2px 3px;line-height:12px;font-size:12px;" id="jfgrid-matrix-turn-left">左右</button></div></div><div class="jfgrid-cols-menuitem jfgrid-mousedown-cancel"><div class="jfgrid-cols-menuitem-content jfgrid-mousedown-cancel">翻转<button class="btn btn-primary jfgrid-mousedown-cancel" style="margin-left:5px;padding:2px 3px;line-height:12px;font-size:12px;" id="jfgrid-matrix-turn-cw">顺时针</button><button class="btn btn-primary jfgrid-mousedown-cancel" style="margin-left:5px;padding:2px 3px;line-height:12px;font-size:12px;" id="jfgrid-matrix-turn-anticw">逆时针</button></div></div><div class="jfgrid-cols-menuitem jfgrid-mousedown-cancel"><div class="jfgrid-cols-menuitem-content jfgrid-mousedown-cancel" id="jfgrid-matrix-turn-trans">转置</div></div><div class="jfgrid-menuseparator jfgrid-mousedown-cancel" role="separator"></div><div class="jfgrid-cols-menuitem jfgrid-mousedown-cancel"><div class="jfgrid-cols-menuitem-content jfgrid-mousedown-cancel"><div class="jfgrid-mousedown-cancel">矩阵计算</div><div  class="jfgrid-mousedown-cancel"><select class="jfgrid-mousedown-cancel" style="height:24px;" id="jfgrid-matrix-cal-type"><option value="plus">加</option><option value="minus">减</option><option value="multiply">乘</option><option value="divided">除</option><option value="power">次方</option><option value="root">次方根</option><option value="log">log</option></select><input type="number" id="jfgrid-matrix-cal-value" class="jfgrid-mousedown-cancel" placeholder="数值" value="2" style="width:40px;height:18px;margin-left:5px;"/><button id="jfgrid-matrix-cal-confirm" class="btn btn-primary jfgrid-mousedown-cancel" style="margin-left:5px;padding:2px 3px;line-height:12px;font-size:12px;">确定</button></div></div></div><div class="jfgrid-cols-menuitem jfgrid-mousedown-cancel"><div class="jfgrid-cols-menuitem-content jfgrid-mousedown-cancel">删除两端0值<button class="btn btn-primary jfgrid-mousedown-cancel" style="margin-left:5px;padding:2px 3px;line-height:12px;font-size:12px;" id="jfgrid-matrix-delezero-row">按行</button><button class="btn btn-primary jfgrid-mousedown-cancel" style="margin-left:5px;padding:2px 3px;line-height:12px;font-size:12px;" id="jfgrid-matrix-delezero-column">按列</button></div></div><div class="jfgrid-cols-menuitem jfgrid-mousedown-cancel"><div class="jfgrid-cols-menuitem-content jfgrid-mousedown-cancel">删除重复值<button class="btn btn-primary jfgrid-mousedown-cancel" style="margin-left:5px;padding:2px 3px;line-height:12px;font-size:12px;" id="jfgrid-matrix-delerpt-row">按行</button><button class="btn btn-primary jfgrid-mousedown-cancel" style="margin-left:5px;padding:2px 3px;line-height:12px;font-size:12px;" id="jfgrid-matrix-delerpt-column">按列</button></div></div><div class="jfgrid-cols-menuitem jfgrid-mousedown-cancel"><div class="jfgrid-cols-menuitem-content jfgrid-mousedown-cancel">生成新矩阵</div></div></div>',
        pivottableconfigHTML = '<div class="jfgrid-cols-menu jfgrid-rightgclick-menu jfgrid-mousedown-cancel" id="jfgrid-pivotTable-config-option"> <div class="jfgrid-cols-menuitem jfgrid-mousedown-cancel"> <div class="jfgrid-cols-menuitem-content jfgrid-mousedown-cancel"> <div class="jfgrid-mousedown-cancel"> <span class="jfgrid-mousedown-cancel">排序</span> <select class="jfgrid-mousedown-cancel" style="height:24px;" id="jfgrid-pivotTable-config-option-order"> <option selected="selected" value="default">无排序</option> <option value="asc">升序</option> <option value="desc">降序</option> </select> </div> </div> </div> <div class="jfgrid-cols-menuitem jfgrid-mousedown-cancel"> <div class="jfgrid-cols-menuitem-content jfgrid-mousedown-cancel"> <div class="jfgrid-mousedown-cancel"> <span class="jfgrid-mousedown-cancel">排序依据</span> <select class="jfgrid-mousedown-cancel" style="height:24px;" id="jfgrid-pivotTable-config-option-orderby"> </select> </div> </div> </div> <div class="jfgrid-cols-menuitem jfgrid-mousedown-cancel"> <div class="jfgrid-cols-menuitem-content jfgrid-mousedown-cancel"> <div class="jfgrid-mousedown-cancel"> <span class="jfgrid-mousedown-cancel">显示总计</span> <select class="jfgrid-mousedown-cancel" style="height:24px;" id="jfgrid-pivotTable-config-option-stastic"> <option  value="0">否</option> <option value="1" selected="selected">是</option> </select> </div> </div> </div> </div>',
        pivottablesumHTML = '<div class="jfgrid-cols-menu jfgrid-rightgclick-menu jfgrid-mousedown-cancel" id="jfgrid-pivotTable-config-option-sumtype"> <div class="jfgrid-cols-menuitem jfgrid-mousedown-cancel" sumtype="SUM"> <div class="jfgrid-cols-menuitem-content jfgrid-mousedown-cancel"> <span class="jfgrid-mousedown-cancel">求和</span> <span class="jfgrid-submenu-arrow jfgrid-mousedown-cancel" style="user-select: none;"><i class="fa fa-check jfgrid-mousedown-cancel" aria-hidden="true"></i></span> </div> </div> <div class="jfgrid-cols-menuitem jfgrid-mousedown-cancel" sumtype="COUNT"> <div class="jfgrid-cols-menuitem-content jfgrid-mousedown-cancel"> <span class="jfgrid-mousedown-cancel">数值计数</span> <span class="jfgrid-submenu-arrow jfgrid-mousedown-cancel" style="user-select: none;"><i class="fa fa-check jfgrid-mousedown-cancel" aria-hidden="true"></i></span> </div> </div> <div class="jfgrid-cols-menuitem jfgrid-mousedown-cancel" sumtype="COUNTA"> <div class="jfgrid-cols-menuitem-content jfgrid-mousedown-cancel"> <span class="jfgrid-mousedown-cancel">计数</span> <span class="jfgrid-submenu-arrow jfgrid-mousedown-cancel" style="user-select: none;"><i class="fa fa-check jfgrid-mousedown-cancel" aria-hidden="true"></i></span> </div> </div> <div class="jfgrid-cols-menuitem jfgrid-mousedown-cancel" sumtype="COUNTUNIQUE"> <div class="jfgrid-cols-menuitem-content jfgrid-mousedown-cancel"> <span class="jfgrid-mousedown-cancel">去重计数</span> <span class="jfgrid-submenu-arrow jfgrid-mousedown-cancel" style="user-select: none;"><i class="fa fa-check jfgrid-mousedown-cancel" aria-hidden="true"></i></span> </div> </div> <div class="jfgrid-cols-menuitem jfgrid-mousedown-cancel" sumtype="AVERAGE"> <div class="jfgrid-cols-menuitem-content jfgrid-mousedown-cancel"> <span class="jfgrid-mousedown-cancel">平均值</span> <span class="jfgrid-submenu-arrow jfgrid-mousedown-cancel" style="user-select: none;"><i class="fa fa-check jfgrid-mousedown-cancel" aria-hidden="true"></i></span> </div> </div> <div class="jfgrid-cols-menuitem jfgrid-mousedown-cancel" sumtype="MAX"> <div class="jfgrid-cols-menuitem-content jfgrid-mousedown-cancel"> <span class="jfgrid-mousedown-cancel">最大值</span> <span class="jfgrid-submenu-arrow jfgrid-mousedown-cancel" style="user-select: none;"><i class="fa fa-check jfgrid-mousedown-cancel" aria-hidden="true"></i></span> </div> </div> <div class="jfgrid-cols-menuitem jfgrid-mousedown-cancel" sumtype="MIN"> <div class="jfgrid-cols-menuitem-content jfgrid-mousedown-cancel"> <span class="jfgrid-mousedown-cancel">最小值</span> <span class="jfgrid-submenu-arrow jfgrid-mousedown-cancel" style="user-select: none;"><i class="fa fa-check jfgrid-mousedown-cancel" aria-hidden="true"></i></span> </div> </div> <div class="jfgrid-cols-menuitem jfgrid-mousedown-cancel" sumtype="MEDIAN"> <div class="jfgrid-cols-menuitem-content jfgrid-mousedown-cancel"> <span class="jfgrid-mousedown-cancel">中位数</span> <span class="jfgrid-submenu-arrow jfgrid-mousedown-cancel" style="user-select: none;"><i class="fa fa-check jfgrid-mousedown-cancel" aria-hidden="true"></i></span> </div> </div> <div class="jfgrid-cols-menuitem jfgrid-mousedown-cancel" sumtype="PRODUCT"> <div class="jfgrid-cols-menuitem-content jfgrid-mousedown-cancel"> <span class="jfgrid-mousedown-cancel">乘积</span> <span class="jfgrid-submenu-arrow jfgrid-mousedown-cancel" style="user-select: none;"><i class="fa fa-check jfgrid-mousedown-cancel" aria-hidden="true"></i></span> </div> </div> <div class="jfgrid-cols-menuitem jfgrid-mousedown-cancel" sumtype="STDEV"> <div class="jfgrid-cols-menuitem-content jfgrid-mousedown-cancel"> <span class="jfgrid-mousedown-cancel">标准差</span> <span class="jfgrid-submenu-arrow jfgrid-mousedown-cancel" style="user-select: none;"><i class="fa fa-check jfgrid-mousedown-cancel" aria-hidden="true"></i></span> </div> </div> <div class="jfgrid-cols-menuitem jfgrid-mousedown-cancel" sumtype="STDEVP"> <div class="jfgrid-cols-menuitem-content jfgrid-mousedown-cancel"> <span class="jfgrid-mousedown-cancel">整体标准差</span> <span class="jfgrid-submenu-arrow jfgrid-mousedown-cancel" style="user-select: none;"><i class="fa fa-check jfgrid-mousedown-cancel" aria-hidden="true"></i></span> </div> </div> <div class="jfgrid-cols-menuitem jfgrid-mousedown-cancel" sumtype="VAR"> <div class="jfgrid-cols-menuitem-content jfgrid-mousedown-cancel"> <span class="jfgrid-mousedown-cancel">方差</span> <span class="jfgrid-submenu-arrow jfgrid-mousedown-cancel" style="user-select: none;"><i class="fa fa-check jfgrid-mousedown-cancel" aria-hidden="true"></i></span> </div> </div> <div class="jfgrid-cols-menuitem jfgrid-mousedown-cancel" sumtype="VARP"> <div class="jfgrid-cols-menuitem-content jfgrid-mousedown-cancel"> <span class="jfgrid-mousedown-cancel">整体方差</span> <span class="jfgrid-submenu-arrow jfgrid-mousedown-cancel" style="user-select: none;"><i class="fa fa-check jfgrid-mousedown-cancel" aria-hidden="true"></i></span> </div> </div> </div>',
        sheetHTML = '<div style="${style}" id="jfgrid-sheets-item${index}" data-index="${index}" class="jfgrid-sheets-item ${active}"><span class="jfgrid-sheets-item-name" spellcheck ="false" contenteditable="false">${name}</span> <span class="jfgrid-sheets-item-menu jfgrid-mousedown-cancel"><i class="fa fa-sort-desc jfgrid-mousedown-cancel"></i></span>${colorset}</div>',
        columnHeaderHTML = '<div class="jfgrid-cols-h-cells jfgridsheetchange"  id="jfgrid-cols-h-cells_${index}" style="width:${width}px;"> <div class="jfgrid-cols-h-cells-c"> <div class="jfgrid-grdblkpush"></div>${column}</div></div>',
        sheetselectlistHTML = '<div class="jfgrid-cols-menu jfgrid-rightgclick-menu jfgrid-mousedown-cancel" id="jfgrid-sheet-list">${item}</div>',
        sheetselectlistitemHTML = '<div class="jfgrid-cols-menuitem jfgrid-mousedown-cancel"  id="jfgrid-sheet-btn${index}" data-index="${index}"><div class="jfgrid-cols-menuitem-content jfgrid-mousedown-cancel" style="${style}" ><span class="icon jfgrid-mousedown-cancel">${icon}</span>${name}</div></div>',
        inputHTML = '<div dir="ltr"><div class="jfgrid-input-box-index" id="jfgrid-input-box-index"></div><div id="jfgrid-input-box" spellcheck="false" aria-hidden="false" class="jfgrid-input-box"><div class="jfgrid-cell-input editable" tabindex="0" role="combobox" contenteditable="true" id="jfgrid-rich-text-editor" dir="ltr" g_editable="true" aria-autocomplete="list"></div></div></div>',
        modelHTML = '<div id="${id}" style="${style}" class="jfgrid-modal-dialog ${addclass}" tabindex="0" role="dialog" aria-labelledby=":41e" dir="ltr"> <div class="jfgrid-modal-dialog-title jfgrid-modal-dialog-title-draggable"> <span class="jfgrid-modal-dialog-title-text" role="heading">${title}</span>	 <span class="jfgrid-modal-dialog-title-close" role="button" tabindex="0" aria-label="关闭"><i class="fa fa-times" aria-hidden="true"></i></span> </div> <div class="jfgrid-modal-dialog-content">${content}</div> <div class="jfgrid-modal-dialog-buttons">	 ${botton} </div></div>',
        
        maskHTML = '<div class="jfgrid-modal-dialog-mask" id="jfgrid-modal-dialog-mask"></div>',
        filtermenuHTML = '<div class="jfgrid-cols-menu jfgrid-mousedown-cancel jfgrid-filter-menu" id="jfgrid-${menuid}-menu"><div id="jfgrid-${menuid}-orderby-asc" class="jfgrid-cols-menuitem jfgrid-mousedown-cancel"><div class="jfgrid-cols-menuitem-content jfgrid-mousedown-cancel">以A-Z升序排列</div></div><div id="jfgrid-${menuid}-orderby-desc" class="jfgrid-cols-menuitem jfgrid-mousedown-cancel"><div class="jfgrid-cols-menuitem-content jfgrid-mousedown-cancel"><div style="width:205px;" class="jfgrid-mousedown-cancel">以Z-A降序排列</div></div></div> <div class="jfgrid-menuseparator jfgrid-mousedown-cancel" role="separator"></div><div id="jfgrid-${menuid}-orderby-color" class="jfgrid-cols-menuitem jfgrid-cols-submenu jfgrid-mousedown-cancel"><div class="jfgrid-cols-menuitem-content jfgrid-mousedown-cancel" style="position: relative;">按颜色筛选<span class="jfgrid-submenu-arrow" style="user-select: none;right: 0;">►</span></div></div><div class="jfgrid-menuseparator jfgrid-mousedown-cancel" role="separator"></div> <div class="jfgrid-cols-menuitem jfgrid-mousedown-cancel" id="jfgrid-${menuid}-bycondition" style="padding-top:0px;padding-bottom:0px;"><div class="jfgrid-cols-menuitem-content jfgrid-mousedown-cancel"><i class="fa fa-caret-right" aria-hidden="true"></i> 按条件过滤</div></div> <div class="jfgrid-${menuid}-bycondition" style="display:none;"><div class="jfgrid-flat-menu-button jfgrid-mousedown-cancel" id="jfgrid-${menuid}-selected"><span class="jfgrid-mousedown-cancel" data-value="null" data-type="0">无</span><div class="jfgrid-mousedown-cancel"><i class="fa fa-sort" aria-hidden="true"></i></div></div><div class="jfgrid-${menuid}-selected-input"><input type="text" placeholder="输入筛选值" class="jfgrid-mousedown-cancel" /></div><div class="jfgrid-${menuid}-selected-input jfgrid-${menuid}-selected-input2"><span>从</span><input type="text" placeholder="范围开始" class="jfgrid-mousedown-cancel" /><span>到</span><input type="text" placeholder="范围结束" class="jfgrid-mousedown-cancel" /></div></div> <div class="jfgrid-menuseparator jfgrid-mousedown-cancel" role="separator"></div> <div class="jfgrid-cols-menuitem jfgrid-mousedown-cancel" id="jfgrid-${menuid}-byvalue" style="padding-top:0px;padding-bottom:0px;"><div class="jfgrid-cols-menuitem-content jfgrid-mousedown-cancel"><i class="fa fa-caret-right" aria-hidden="true"></i> 按值过滤</div></div> <div class="jfgrid-${menuid}-byvalue"><div class="jfgrid-cols-menuitem jfgrid-mousedown-cancel"><div class="jfgrid-cols-menuitem-content jfgrid-mousedown-cancel jfgrid-mousedown-${menuid}-byvalue-btn"><span id="jfgrid-${menuid}-byvalue-btn-all" class="jfgrid-mousedown-cancel">全选</span> - <span id="jfgrid-${menuid}-byvalue-btn-clear" class="jfgrid-mousedown-cancel">清除</span> - <span id="jfgrid-${menuid}-byvalue-btn-contra" class="jfgrid-mousedown-cancel">反选</span> <div><i class="fa fa-${menuid} jfgrid-mousedown-cancel" aria-hidden="true"></i></div></div></div><div class="jfgrid-cols-menuitem jfgrid-mousedown-cancel" style="padding-left:3px; padding-right:3px;"><div class="jfgrid-cols-menuitem-content jfgrid-mousedown-cancel"><input type="text" placeholder="按照值进行筛选" class="jfgrid-mousedown-cancel" id="jfgrid-${menuid}-byvalue-input" /><div class="jfgrid-${menuid}-byvalue-input-icon jfgrid-mousedown-cancel"><i class="fa fa-search jfgrid-mousedown-cancel" aria-hidden="true"></i></div></div></div><div class="jfgrid-cols-menuitem jfgrid-mousedown-cancel"><div id="jfgrid-${menuid}-byvalue-select" class="jfgrid-cols-menuitem-content jfgrid-mousedown-cancel"></div></div></div> <div class="jfgrid-menuseparator jfgrid-mousedown-cancel" role="separator"></div> <div class="jfgrid-cols-menuitem jfgrid-mousedown-cancel"><div class="jfgrid-cols-menuitem-content jfgrid-mousedown-cancel"><div class="btn btn-primary jfgrid-mousedown-cancel" id="jfgrid-${menuid}-confirm">确 认</div> <div class="btn btn-default jfgrid-mousedown-cancel" id="jfgrid-${menuid}-cancel">取 消</div> <div class="btn btn-danger jfgrid-mousedown-cancel" id="jfgrid-${menuid}-initial">清除筛选</div></div></div> </div>',
        filtersubmenuHTML = '<div style="z-index:1004;overflow-y:auto;" class="jfgrid-filter-submenu jfgrid-cols-menu jfgrid-mousedown-cancel" id="jfgrid-${menuid}-submenu"><div data-value="null" data-type="0" class="jfgrid-cols-menuitem jfgrid-mousedown-cancel"><div class="jfgrid-cols-menuitem-content jfgrid-mousedown-cancel">无</div></div><div class="jfgrid-cols-menuitem jfgrid-mousedown-cancel" data-value="cellnull"  data-type="0"><div class="jfgrid-cols-menuitem-content jfgrid-mousedown-cancel">单元格为空</div></div><div class="jfgrid-cols-menuitem jfgrid-mousedown-cancel" data-value="cellnonull"  data-type="0"><div class="jfgrid-cols-menuitem-content jfgrid-mousedown-cancel">单元格有数据</div></div><div class="jfgrid-cols-menuitem jfgrid-mousedown-cancel" data-value="textinclude"><div class="jfgrid-cols-menuitem-content jfgrid-mousedown-cancel">文本包含</div></div><div class="jfgrid-cols-menuitem jfgrid-mousedown-cancel" data-value="textnotinclude"><div class="jfgrid-cols-menuitem-content jfgrid-mousedown-cancel">文本不包含</div></div><div class="jfgrid-cols-menuitem jfgrid-mousedown-cancel" data-value="textstart"><div class="jfgrid-cols-menuitem-content jfgrid-mousedown-cancel">文本开头为</div></div><div class="jfgrid-cols-menuitem jfgrid-mousedown-cancel" data-value="textend"><div class="jfgrid-cols-menuitem-content jfgrid-mousedown-cancel">文本结尾为</div></div><div class="jfgrid-cols-menuitem jfgrid-mousedown-cancel" data-value="textequal"><div class="jfgrid-cols-menuitem-content jfgrid-mousedown-cancel">文本等于</div></div>  <div class="jfgrid-menuseparator jfgrid-mousedown-cancel" role="separator"></div>  <div class="jfgrid-cols-menuitem jfgrid-mousedown-cancel" data-value="dateequal"><div class="jfgrid-cols-menuitem-content jfgrid-mousedown-cancel">日期等于</div></div><div class="jfgrid-cols-menuitem jfgrid-mousedown-cancel" data-value="datelessthan"><div class="jfgrid-cols-menuitem-content jfgrid-mousedown-cancel">日期早于</div></div><div class="jfgrid-cols-menuitem jfgrid-mousedown-cancel" data-value="datemorethan"><div class="jfgrid-cols-menuitem-content jfgrid-mousedown-cancel">日期晚于</div></div> <div class="jfgrid-menuseparator jfgrid-mousedown-cancel" role="separator"></div> <div class="jfgrid-cols-menuitem jfgrid-mousedown-cancel" data-value="morethan"><div class="jfgrid-cols-menuitem-content jfgrid-mousedown-cancel">大于</div></div><div class="jfgrid-cols-menuitem jfgrid-mousedown-cancel" data-value="moreequalthan"><div class="jfgrid-cols-menuitem-content jfgrid-mousedown-cancel">大于等于</div></div><div class="jfgrid-cols-menuitem jfgrid-mousedown-cancel" data-value="lessthan"><div class="jfgrid-cols-menuitem-content jfgrid-mousedown-cancel">小于</div></div><div class="jfgrid-cols-menuitem jfgrid-mousedown-cancel" data-value="lessequalthan"><div class="jfgrid-cols-menuitem-content jfgrid-mousedown-cancel">小于等于</div></div><div class="jfgrid-cols-menuitem jfgrid-mousedown-cancel" data-value="equal"><div class="jfgrid-cols-menuitem-content jfgrid-mousedown-cancel">等于</div></div><div class="jfgrid-cols-menuitem jfgrid-mousedown-cancel" data-value="noequal"><div class="jfgrid-cols-menuitem-content jfgrid-mousedown-cancel">不等于</div></div><div class="jfgrid-cols-menuitem jfgrid-mousedown-cancel" data-value="include"  data-type="2"><div class="jfgrid-cols-menuitem-content jfgrid-mousedown-cancel">介于</div></div><div class="jfgrid-cols-menuitem jfgrid-mousedown-cancel" data-value="noinclude" data-type="2"><div class="jfgrid-cols-menuitem-content jfgrid-mousedown-cancel">不在其中</div></div> </div>',
        sheetconfigHTML = ' <div class="jfgrid-cols-menu jfgrid-rightgclick-menu jfgrid-mousedown-cancel" id="jfgrid-rightclick-sheet-menu"> <div class="jfgrid-cols-menuitem jfgrid-mousedown-cancel" id="jfgridsheetconfigdelete"> <div class="jfgrid-cols-menuitem-content jfgrid-mousedown-cancel">删除</div> </div> <div class="jfgrid-cols-menuitem jfgrid-mousedown-cancel" id="jfgridsheetconfigcopy"> <div class="jfgrid-cols-menuitem-content jfgrid-mousedown-cancel">复制</div> </div> <div class="jfgrid-cols-menuitem jfgrid-mousedown-cancel" id="jfgridsheetconfigrename"> <div class="jfgrid-cols-menuitem-content jfgrid-mousedown-cancel">重命名</div> </div> <div class="jfgrid-cols-menuitem jfgrid-cols-submenu jfgrid-mousedown-cancel" id="jfgridsheetconfigcolor"> <div class="jfgrid-cols-menuitem-content jfgrid-mousedown-cancel"> 更改颜色 <span class="jfgrid-submenu-arrow" style="user-select: none;">►</span> </div> </div> <div class="jfgrid-menuseparator jfgrid-mousedown-cancel" role="separator"></div> <div class="jfgrid-cols-menuitem jfgrid-mousedown-cancel" id="jfgridsheetconfighide"> <div class="jfgrid-cols-menuitem-content jfgrid-mousedown-cancel">隐藏</div> </div> <div class="jfgrid-cols-menuitem jfgrid-mousedown-cancel" id="jfgridsheetconfigshow"> <div class="jfgrid-cols-menuitem-content jfgrid-mousedown-cancel">取消隐藏</div> </div> <div class="jfgrid-menuseparator jfgrid-mousedown-cancel" role="separator"></div> <div id="jfgridsheetconfigmoveleft" class="jfgrid-cols-menuitem jfgrid-mousedown-cancel"> <div class="jfgrid-cols-menuitem-content jfgrid-mousedown-cancel">向左移</div> </div> <div class="jfgrid-cols-menuitem jfgrid-mousedown-cancel" id="jfgridsheetconfigmoveright"> <div class="jfgrid-cols-menuitem-content jfgrid-mousedown-cancel">向右移</div> </div> </div> <div class="jfgrid-cols-menu jfgrid-rightgclick-menu jfgrid-rightgclick-menu-sub jfgrid-mousedown-cancel" id="jfgridsheetconfigcolor_sub"><div id="jfgridsheetconfigcolorreset" class="jfgrid-cols-menuitem jfgrid-mousedown-cancel"><div class="jfgrid-cols-menuitem-content jfgrid-mousedown-cancel">重置颜色</div></div> <div class="jfgrid-mousedown-cancel"> <div class="jfgrid-mousedown-cancel"> <input type="text" id="jfgridsheetconfigcolorur" /> </div> </div> </div>'
        ;

    
    var jfgridPivotTableHTML = '<div id="jfgrid-modal-dialog-slider-pivot" class="jfgrid-modal-dialog-slider jfgrid-modal-dialog-slider-pivot"> <div class="jfgrid-modal-dialog-slider-title"> <span>数据透视表</span> <span id="jfgrid-modal-dialog-slider-close" title="关闭"><i class="fa fa-times" aria-hidden="true"></i></span> </div> <div class="jfgrid-modal-dialog-slider-content"> <div class="jfgrid-modal-dialog-slider-range"> <div id="jfgrid-dialog-pivotTable-range"></div> <div id="jfgrid-dialog-pivotTable-range-seleted">编辑范围</div> </div> <div class="jfgrid-modal-dialog-slider-list-title"> 选择需要添加到数据透视表的字段 <span title="清除所有已选字段" id="jfgrid-dialog-pivotTable-clearitem">清除</span></div> <div id="jfgrid-modal-dialog-pivotTable-list" class="jfgrid-modal-dialog-slider-list jfgrid-scrollbars"> </div> <div class="jfgrid-modal-dialog-slider-config-c"> <div class="jfgrid-modal-dialog-slider-config jfgrid-modal-dialog-config-filter"> <div> <span><i class="fa fa-filter jfgrid-mousedown-cancel" aria-hidden="true"></i> 筛选</span> </div> <div id="jfgrid-modal-dialog-config-filter" class="jfgrid-modal-dialog-slider-config-list jfgrid-scrollbars"> </div> </div> <div class="jfgrid-modal-dialog-slider-config jfgrid-modal-dialog-config-row"> <div> <span><i class="fa fa-list-alt" aria-hidden="true"></i> 行</span> </div> <div id="jfgrid-modal-dialog-config-row" class="jfgrid-modal-dialog-slider-config-list jfgrid-scrollbars"> </div> </div> <div class="jfgrid-modal-dialog-slider-config jfgrid-modal-dialog-config-column"> <div> <span><i class="fa fa-indent" aria-hidden="true"></i> 列</span> </div> <div id="jfgrid-modal-dialog-config-column" class="jfgrid-modal-dialog-slider-config-list jfgrid-scrollbars"> </div> </div> <div class="jfgrid-modal-dialog-slider-config jfgrid-modal-dialog-config-value"> <div> <span><i class="fa fa-cube" aria-hidden="true"></i> 数值</span> <span style="float: right;margin-right: 10px;display:none;" id="jfgridpivottablevaluecolrowshow"><label style="padding:0px 5px;margin:0px;font-size:12px;height:15px;line-height:15px;" title="统计字段显示为列" for="jfgridpivottablevaluecolrow">列</label> <input type="radio" checked="checked" value="1" name="jfgridpivottablevaluecolrow" id="jfgridpivottablevaluecolrow" /> <label style="padding:0px 5px;margin:0px;font-size:12px;height:15px;line-height:15px;" title="统计字段显示为行" for="jfgridpivottablevaluecolrow1">行</label> <input type="radio" value="0" name="jfgridpivottablevaluecolrow" id="jfgridpivottablevaluecolrow1" /></span></div> <div id="jfgrid-modal-dialog-config-value" class="jfgrid-modal-dialog-slider-config-list jfgrid-scrollbars"> </div> </div> </div> </div> </div>';

    var jfgridAlternateformatHtml = '<div id="jfgrid-modal-dialog-slider-alternateformat" class="jfgrid-modal-dialog-slider jfgrid-modal-dialog-slider-alternateformat" style="display: block;">'+
                                        '<div class="jfgrid-modal-dialog-slider-title">'+
                                            '<span>交替颜色</span>'+
                                            '<span class="jfgrid-model-close-btn" title="关闭">'+
                                                '<i class="fa fa-times" aria-hidden="true"></i>'+
                                            '</span>'+
                                        '</div>'+
                                        '<div class="jfgrid-modal-dialog-slider-content">'+
                                            '<div class="textTitle">应用范围</div>'+
                                            '<div id="jfgrid-alternateformat-range">'+
                                                '<input class="formulaInputFocus" placeholder="请选择应用范围"/>'+
                                                '<i class="fa fa-table" aria-hidden="true"></i>'+
                                            '</div>'+
                                            '<div id="jfgrid-alternateformat-checkbox">'+
                                                '<div class="cf">'+
                                                    '<input type="checkbox" id="jfgrid-alternateformat-rowHeader"/>'+
                                                    '<label for="jfgrid-alternateformat-rowHeader">页眉</label>'+
                                                '</div>'+
                                                '<div class="cf">'+
                                                    '<input type="checkbox" id="jfgrid-alternateformat-rowFooter"/>'+
                                                    '<label for="jfgrid-alternateformat-rowFooter">页脚</label>'+
                                                '</div>'+
                                            '</div>'+
                                            '<div class="textTitle">格式样式</div>'+
                                            '<div id="jfgrid-alternateformat-modelList" class="cf"></div>'+
                                            '<div class="textTitle">自定义</div>'+
                                            '<div id="jfgrid-alternateformat-modelCustom" class="cf"></div>'+
                                            '<div id="jfgrid-alternateformat-modelToning">'+
                                                '<div class="toningbox header">'+
                                                    '<div class="toningShow"> 页眉 </div>'+
                                                    '<div class="jfgrid-color-menu-button-indicator" title="点击选择文本颜色" style="border-bottom-color: #000;margin-right: 10px;"> <div class="jfgrid-icon jfgrid-inline-block"> <div aria-hidden="true" class="jfgrid-icon-img-container jfgrid-icon-img jfgrid-icon-text-color" style="user-select: none;"> </div> </div> </div>'+
                                                    '<div class="jfgrid-color-menu-button-indicator" title="点击选择单元格颜色" style="border-bottom-color: #fff;"> <div class="jfgrid-icon jfgrid-inline-block"> <div aria-hidden="true" class="jfgrid-icon-img-container jfgrid-icon-img jfgrid-icon-cell-color" style="user-select: none;"> </div> </div> </div>'+
                                                '</div>'+
                                                '<div class="toningbox ctOne">'+
                                                    '<div class="toningShow"> 颜色1 </div>'+
                                                    '<div class="jfgrid-color-menu-button-indicator" title="点击选择文本颜色" style="border-bottom-color: #000;margin-right: 10px;"> <div class="jfgrid-icon jfgrid-inline-block"> <div aria-hidden="true" class="jfgrid-icon-img-container jfgrid-icon-img jfgrid-icon-text-color" style="user-select: none;"> </div> </div> </div>'+
                                                    '<div class="jfgrid-color-menu-button-indicator" title="点击选择单元格颜色" style="border-bottom-color: #fff;"> <div class="jfgrid-icon jfgrid-inline-block"> <div aria-hidden="true" class="jfgrid-icon-img-container jfgrid-icon-img jfgrid-icon-cell-color" style="user-select: none;"> </div> </div> </div>'+
                                                '</div>'+
                                                '<div class="toningbox ctTwo">'+
                                                    '<div class="toningShow"> 颜色2 </div>'+
                                                    '<div class="jfgrid-color-menu-button-indicator" title="点击选择文本颜色" style="border-bottom-color: #000;margin-right: 10px;"> <div class="jfgrid-icon jfgrid-inline-block"> <div aria-hidden="true" class="jfgrid-icon-img-container jfgrid-icon-img jfgrid-icon-text-color" style="user-select: none;"> </div> </div> </div>'+
                                                    '<div class="jfgrid-color-menu-button-indicator" title="点击选择单元格颜色" style="border-bottom-color: #fff;"> <div class="jfgrid-icon jfgrid-inline-block"> <div aria-hidden="true" class="jfgrid-icon-img-container jfgrid-icon-img jfgrid-icon-cell-color" style="user-select: none;"> </div> </div> </div>'+
                                                '</div>'+
                                                '<div class="toningbox footer">'+
                                                    '<div class="toningShow"> 页脚 </div>'+
                                                    '<div class="jfgrid-color-menu-button-indicator" title="点击选择文本颜色" style="border-bottom-color: #000;margin-right: 10px;"> <div class="jfgrid-icon jfgrid-inline-block"> <div aria-hidden="true" class="jfgrid-icon-img-container jfgrid-icon-img jfgrid-icon-text-color" style="user-select: none;"> </div> </div> </div>'+
                                                    '<div class="jfgrid-color-menu-button-indicator" title="点击选择单元格颜色" style="border-bottom-color: #fff;"> <div class="jfgrid-icon jfgrid-inline-block"> <div aria-hidden="true" class="jfgrid-icon-img-container jfgrid-icon-img jfgrid-icon-cell-color" style="user-select: none;"> </div> </div> </div>'+
                                                '</div>'+
                                            '</div>'+
                                            '<button id="jfgrid-alternateformat-remove" class="btn btn-default" style="margin: 10px;">移除交替颜色</button>'+
                                        '</div>'+
                                    '</div>';

    var jfgridchartpointconfigHTML = '<div class="jfgrid-chart-point-config"> <div class="jfgrid-chart-point-config-set"> <div class="jfgrid-chart-point-config-left"> <div class="jfgrid-chart-point-config-left-top"> <div class="jfgrid-chart-point-searchcondition"> <div class="jfgrid-datavisual-content-row" style="margin-bottom: 0px;margin-top: 0px;height: 30px;"> <div class="jfgrid-datavisual-content-column jfgrid-datavisual-content-column-title jfgrid-datavisual-content-column-2x" style="width:10%;white-space:nowrap;">选择维度</div> <div class="jfgrid-datavisual-content-column jfgrid-datavisual-content-column-right jfgrid-datavisual-content-column-2x" style="width:80%;"> <select data-tips="维度选择" name="jfgridpointconfigsearchdim" id="jfgridpointconfigsearchdim"> </select> </div> </div> <div class="jfgrid-datavisual-content-row" style="margin-bottom: 0px;margin-top: 3px;height: 30px;"> <div class="jfgrid-datavisual-content-column jfgrid-datavisual-content-column-title jfgrid-datavisual-content-column-2x" style="width:10%;">排序</div> <div class="jfgrid-datavisual-content-column jfgrid-datavisual-content-column-right jfgrid-datavisual-content-column-2x" style="width:80%;"> <label data-tips="无排序" for="jfgridpointconfigsearchorderno">无排序</label> <input type="radio" checked="checked" value="0" name="jfgridpointconfigsearchorder" id="jfgridpointconfigsearchorderno"> <label data-tips="升序" for="jfgridpointconfigsearchorderasc">升序</label> <input type="radio" value="1" name="jfgridpointconfigsearchorder" id="jfgridpointconfigsearchorderasc"> <label data-tips="降序" for="jfgridpointconfigsearchorderdesc">降序</label> <input type="radio" value="2" name="jfgridpointconfigsearchorder" id="jfgridpointconfigsearchorderdesc"> </div> </div> <div class="jfgrid-datavisual-content-row" style="margin-bottom: 0px;margin-top: 5px;height: 30px;"> <div class="jfgrid-datavisual-content-column jfgrid-datavisual-content-column-right jfgrid-datavisual-content-column-2x" style="width:90%;text-align: left;"> <select data-width="70" data-tips="按照什么方式查询" name="jfgridpointconfigsearchtype" id="jfgridpointconfigsearchtype"> <option value="0" selected="selected">按照名称</option> <option value="1">按排序前%</option> </select> <input data-tips="查询关于点的关键字" id="jfgridpointconfigsearchcontent" type="text" class="jfgrid-datavisual-config-input-no" style="width:40%;" placeholder="查询内容" /> <button id="jfgridpointconfigsearchcomfirm" class="btn btn-primary jfgrid-model-conform-btn">查询</button> </div> </div> </div> </div> <div class="jfgrid-chart-point-config-left-mid"> <span id="jfgrid-chart-point-btn-all" class="jfgrid-mousedown-cancel">全选</span> - <span id="jfgrid-chart-point-btn-clear" class="jfgrid-mousedown-cancel">清除</span> - <span id="jfgrid-chart-point-btn-contra" class="jfgrid-mousedown-cancel">反选</span><span style="text-decoration:none;color:#8D8D8D;float:right;margin-right:40px;cursor:default;" class="jfgrid-mousedown-cancel">可以直接框选数据点</span> </div> <div class="jfgrid-chart-point-config-left-bottom"> <div class="jfgrid-chart-point-searchitem-c jfgrid-noselected-text">  </div> </div> </div> <div class="jfgrid-chart-point-config-right"> <div class="jfgrid-chart-point-itemconfig"> <div class="jfgrid-datavisual-content-row" style="font-size: 16px;font-weight: bold;"> 数据点设置 </div> <div class="jfgrid-datavisual-content-row"> <div class="jfgrid-datavisual-content-column jfgrid-datavisual-content-column-title jfgrid-datavisual-content-column-2x" style="width:10%;white-space:nowrap;">图形颜色</div> <div class="jfgrid-datavisual-content-column jfgrid-datavisual-content-column-right jfgrid-datavisual-content-column-2x" style="width:80%;"> <input data-tips="颜色" class="jfgrid-datavisual-config-colorOpacity" id="scattersingleitemstylecolor" type="text" data-bigclass="scattersingle" data-attr="itemstyle" data-func="color" /> </div> </div> <div class="jfgrid-datavisual-content-row"> <div class="jfgrid-datavisual-content-column jfgrid-datavisual-content-column-title jfgrid-datavisual-content-column-2x" style="width:10%;white-space:nowrap;">图形大小</div> <div class="jfgrid-datavisual-content-column jfgrid-datavisual-content-column-right jfgrid-datavisual-content-column-2x" style="width:80%;"> <select data-sliderdiy="scattersingleallsymbolsizeslider" data-tips="点大小设置" name="scattersingleallsymbolsize" id="scattersingleallsymbolsize" data-width="50" data-bigclass="scattersingle" data-attr="all" data-func="symbolsize"> <option value="4" selected="selected">4px</option> <option value="6">6px</option> <option value="8">8px</option> <option value="10">10px</option> <option value="12">12px</option> <option value="14">14px</option> <option value="16">16px</option> <option value="diy">自定义</option> </select> </div> </div> <div class="jfgrid-datavisual-content-row" style="display:none;"> <div data-tips="滑动修改点大小" id="scattersingleallsymbolsizeslider" data-bigclass="scattersingle" data-attr="all" data-func="symbolsize" class="jfgrid-datavisual-config-slider" style="width:70%;" data-min="1" data-max="50" data-step="1"></div> <input data-tips="自定义点大小" data-sliderid="scattersingleallsymbolsizeslider" id="scattersingleallsymbolsizesliderdiy" type="text" class="jfgrid-datavisual-config-input" data-bigclass="scattersingle" data-attr="all" data-func="symbolsize" placeholder="请输入" style="width:10%;margin-left:10px;text-align:center;margin-right: 2px;" /><label for="scattersingleallsymbolsizesliderdiy">px</label> </div> <div class="jfgrid-datavisual-content-row"> <div class="jfgrid-datavisual-content-column jfgrid-datavisual-content-column-title jfgrid-datavisual-content-column-2x" style="width:10%;white-space:nowrap;">图形形状</div> <div class="jfgrid-datavisual-content-column jfgrid-datavisual-content-column-right jfgrid-datavisual-content-column-2x" style="width:80%;"> <select data-tips="点类型设置" data-width="70" name="scattersingleallsymboltype" id="scattersingleallsymboltype" data-bigclass="scattersingle" data-attr="all" data-func="symboltype"> <option value="emptyCircle" selected="selected">空心圆</option> <option value="circle">圆形</option> <option value="emptyRectangle">空心矩形</option> <option value="rect">矩形</option> <option value="roundRect">圆角矩形</option> <option value="emptyTriangle">空心三角</option> <option value="triangle">三角形</option> <option value="emptyDiamond">空心菱形</option> <option value="diamond">菱形</option> <option value="droplet">水滴</option> <option value="pin">标注</option> <option value="arrow">箭头</option> <option value="heart">心形</option> <option value="star">星星</option> </select> </div> </div> <div class="jfgrid-datavisual-content-rowsplit-sub"></div> <div class="jfgrid-datavisual-content-row"> <div class="jfgrid-datavisual-content-column jfgrid-datavisual-content-column-title jfgrid-datavisual-content-column-2x" style="width:10%;white-space:nowrap;">边框粗细</div> <div class="jfgrid-datavisual-content-column jfgrid-datavisual-content-column-right jfgrid-datavisual-content-column-2x" style="width:80%;"> <select data-sliderdiy="scattersingleitemstyleborderwidthslider" data-tips="点边框粗细" name="scattersingleitemstyleborderwidth" id="scattersingleitemstyleborderwidth" data-width="50" data-bigclass="scattersingle" data-attr="itemstyle" data-func="borderwidth"><option value="0" selected="selected">无</option> <option value="1">1px</option> <option value="2">2px</option> <option value="3">3px</option> <option value="4">4px</option> <option value="5">5px</option> <option value="6">6px</option> <option value="7">7px</option> <option value="8">8px</option> <option value="diy">自定义</option> </select> </div> </div> <div class="jfgrid-datavisual-content-row" style="display:none;"> <div data-tips="滑动修改边框粗细" id="scattersingleitemstyleborderwidthslider" data-bigclass="scattersingle" data-attr="itemstyle" data-func="borderwidth" class="jfgrid-datavisual-config-slider" style="width:70%;" data-min="12" data-max="100" data-step="1"></div> <input data-tips="自定义边框粗细" data-sliderid="scattersingleitemstyleborderwidthslider" id="scattersingleitemstyleborderwidthsliderdiy" type="text" class="jfgrid-datavisual-config-input" data-bigclass="scattersingle" data-attr="itemstyle" data-func="borderwidth" placeholder="请输入" style="width:10%;margin-left:10px;text-align:center;margin-right: 2px;" /><label for="scattersingleitemstyleborderwidthsliderdiy">%</label> </div> <div class="jfgrid-datavisual-content-row"> <div class="jfgrid-datavisual-content-column jfgrid-datavisual-content-column-title jfgrid-datavisual-content-column-2x" style="width:10%;white-space:nowrap;">边框样式</div> <div class="jfgrid-datavisual-content-column jfgrid-datavisual-content-column-right jfgrid-datavisual-content-column-2x" style="width:80%;"> <select data-tips="点边框类型设置" data-width="50" name="scattersingleitemstyleborderlinetype" id="scattersingleitemstyleborderlinetype" data-bigclass="scattersingle" data-attr="itemstyle" data-func="borderlinetype"> <option value="solid" selected="selected">实线</option> <option value="dashed">虚线</option> <option value="dotted">点线</option> </select> </div> </div> <div class="jfgrid-datavisual-content-row"> <div class="jfgrid-datavisual-content-column jfgrid-datavisual-content-column-title jfgrid-datavisual-content-column-2x" style="width:10%;white-space:nowrap;">边框颜色</div> <div class="jfgrid-datavisual-content-column jfgrid-datavisual-content-column-right jfgrid-datavisual-content-column-2x" style="width:80%;"> <input data-tips="点边框颜色" class="jfgrid-datavisual-config-colorOpacity" id="scattersingleitemstyleborderlinecolor" type="text" data-bigclass="scattersingle" data-attr="itemstyle" data-func="borderlinecolor" /> </div> </div> <div class="jfgrid-datavisual-content-rowsplit-sub"></div> <div class="jfgrid-datavisual-content-row"> <div class="jfgrid-datavisual-content-column jfgrid-datavisual-content-column-title jfgrid-datavisual-content-column-2x" style="width:10%;white-space:nowrap;"><i class="fa fa-th-large" aria-hidden="true"></i> 文字标签</div> <div class="jfgrid-datavisual-content-column jfgrid-datavisual-content-column-right jfgrid-datavisual-content-column-2x" style="width:80%;"> <label data-tips="显示数据点的标签" data-bigclass="scattersingle" data-attr="label" data-func="labelshow" for="scattersinglelabellabelshow">显示</label> <input type="radio" checked="checked" value="1" name="scattersinglelabellabelshow" id="scattersinglelabellabelshow" data-bigclass="scattersingle" data-attr="label" data-func="labelshow"> <label data-tips="隐藏数据点的标签" data-bigclass="scattersingle" data-attr="label" data-func="labelshow" for="scattersinglelabellabelshow1">隐藏</label> <input type="radio" value="0" name="scattersinglelabellabelshow" id="scattersinglelabellabelshow1" data-bigclass="scattersingle" data-attr="label" data-func="labelshow"> </div> </div> <div class="jfgrid-datavisual-content-row" style="height:auto;line-height: initial;margin-left:auto;" showfor="scattersinglelabellabelshow1" hidefor="scattersinglelabellabelshow"> <div class="jfgrid-datavisual-content-row"> <div class="jfgrid-datavisual-content-column jfgrid-datavisual-content-column-title jfgrid-datavisual-content-column-2x" style="width:40%;">数值比例</div> <div class="jfgrid-datavisual-content-column jfgrid-datavisual-content-column-right jfgrid-datavisual-content-column-2x" style="width:50%;"> <select data-tips="刻度数值放大比例" name="scattersinglelabelformatratio" id="scattersinglelabelformatratio" data-bigclass="scattersingle" data-attr="label" data-func="formatratio"> <option value="0.01">乘以100</option> <option value="0.1">乘以10</option> <option value="1" selected="selected">默认</option> <option value="10">除以10</option> <option value="100">除以100</option> <option value="1000">除以1000</option> <option value="10000">除以1万</option> <option value="100000">除以10万</option> <option value="1000000">除以一百万</option> <option value="10000000">除以一千万</option> <option value="100000000">除以一亿</option> <option value="1000000000">除以十亿</option> </select> </div> </div> <div class="jfgrid-datavisual-content-row"> <div class="jfgrid-datavisual-content-column jfgrid-datavisual-content-column-title jfgrid-datavisual-content-column-2x" style="width:40%;white-space: nowrap;">小数位数</div> <div class="jfgrid-datavisual-content-column jfgrid-datavisual-content-column-right jfgrid-datavisual-content-column-2x" style="width:50%;"> <select data-tips="数值小数点位数" name="scattersinglelabelfloatlen" id="scattersinglelabelfloatlen" data-bigclass="scattersingle" data-attr="label" data-func="floatlen"> <option value="auto" selected="selected">自动显示</option> <option value="0">整数</option> <option value="1">1位小数</option> <option value="2">2位小数</option> <option value="3">3位小数</option> <option value="4">4位小数</option> <option value="5">5位小数</option> <option value="6">6位小数</option> <option value="7">7位小数</option> <option value="8">8位小数</option> </select> </div> </div> <div class="jfgrid-datavisual-content-row"> <div class="jfgrid-datavisual-content-column jfgrid-datavisual-content-column-title jfgrid-datavisual-content-column-2x" style="width:20%;">标签格式</div> <div class="jfgrid-datavisual-content-column jfgrid-datavisual-content-column-right jfgrid-datavisual-content-column-2x" style="width:70%;"> <select data-sliderdiy="scattersinglelabelcontentformatslider" data-tips="标签显示格式" name="scattersinglelabelcontentformat" id="scattersinglelabelcontentformat" data-bigclass="scattersingle" data-attr="label" data-func="contentformat"> <option value="default" selected="selected">默认</option> <option value="1">仅数据名</option> <option value="2">数据名+2维数值</option> <option value="5">数据名+全部数值</option> <option value="diy">自定义</option> </select> </div> </div> <div style="display:none;"> <div class="jfgrid-datavisual-content-row" id="scattersinglelabelcontentformatslider"> <div style="text-align:center; width:60px; display:inline-block;">数据名称</div> <label data-tips="是否显示数据名" data-bigclass="scattersingle" data-attr="label" data-func="scattersingledatalabelshow" for="scattersinglelabeldatalabelshow" style="font-weight:bold;"><i class="fa fa-eye" aria-hidden="true"></i></label> <input type="checkbox" checked="checked" name="scattersinglelabeldatalabelshow" id="scattersinglelabeldatalabelshow" data-bigclass="scattersingle" data-attr="label" data-func="scattersingledatalabelshow"> <input data-tips="显示在数据名前部文字" placeholder="前缀" id="scattersinglelabeldatalabelprefix" type="text" class="jfgrid-datavisual-config-input" style="width:60px;height:19px;" data-bigclass="scattersingle" data-attr="label" data-func="scattersingledatalabelprefix" /> <input data-tips="显示在数据名尾部文字" placeholder="后缀" id="scattersinglelabeldatalabelsuffix" type="text" class="jfgrid-datavisual-config-input" style="width:60px;height:19px;" data-bigclass="scattersingle" data-attr="label" data-func="scattersingledatalabelsuffix" /> <label data-tips="是否在数据名后换行" data-bigclass="scattersingle" data-attr="label" data-func="scattersingledatalabelline" for="scattersinglelabeldatalabelline" style="font-weight:bold;">换行</label> <input type="checkbox" checked="checked" name="scattersinglelabeldatalabelline" id="scattersinglelabeldatalabelline" data-bigclass="scattersingle" data-attr="label" data-func="scattersingledatalabelline"> </div> </div> <div class="jfgrid-datavisual-content-row" > <div class="jfgrid-datavisual-content-column jfgrid-datavisual-content-column-title jfgrid-datavisual-content-column-2x" style="width:10%;white-space:nowrap;">标签位置</div> <div class="jfgrid-datavisual-content-column jfgrid-datavisual-content-column-right jfgrid-datavisual-content-column-2x" style="width:80%;"> <select data-sliderdiy="scattersinglelabellabelplaceslider" data-tips="标签距离图形位置" data-width="70" name="scattersinglelabellabelplace" id="scattersinglelabellabelplace" data-bigclass="scattersingle" data-attr="label" data-func="labelplace"> <option value="top" selected="selected">顶端</option> <option value="left">左侧</option> <option value="right">右侧</option> <option value="bottom">底部</option> <option value="inside">内部居中</option> <option value="diy">自定义</option> <option value="insideLeft">内部左侧</option> <option value="insideRight">内部右侧</option> <option value="insideTop">内部顶端</option> <option value="insideBottom">内部底端</option> <option value="insideTopLeft">内部左上</option> <option value="insideBottomLeft">内部左下</option> <option value="insideTopRight">内部右上</option> <option value="insideBottomRight">内部右下</option> </select> </div> </div> <div class="jfgrid-datavisual-content-row" style="display:none;height:65px;"> <div data-tips="滑动修改点文本水平位置" id="scattersinglelabellabelplaceslider" data-bigclass="scattersingle" data-attr="label" data-func="labelplacediy" class="jfgrid-datavisual-config-slider" style="width:70%;" data-min="-100" data-max="100" data-step="1"></div> <input data-tips="自定义点文本水平位置" data-sliderid="scattersinglelabellabelplaceslider" id="scattersinglelabellabelplacesliderdiy" type="text" class="jfgrid-datavisual-config-input" data-bigclass="scattersingle" data-attr="label" data-func="labelplacediy" placeholder="请输入" style="width:10%;margin-left:10px;text-align:center;margin-right: 2px;" /><label for="scattersinglelabellabelplacesliderdiy">px</label> <br /> <div data-tips="滑动修改点文本垂直位置" id="scattersinglelabellabelplaceslider1" data-bigclass="scattersingle" data-attr="label" data-func="labelplacediy" class="jfgrid-datavisual-config-slider" style="width:70%;" data-min="-100" data-max="100" data-step="1"></div> <input data-tips="自定义点文本垂直位置" data-sliderid="scattersinglelabellabelplaceslider1" id="scattersinglelabellabelplaceslider1diy" type="text" class="jfgrid-datavisual-config-input" data-bigclass="scattersingle" data-attr="label" data-func="labelplacediy" placeholder="请输入" style="width:10%;margin-left:10px;text-align:center;margin-right: 2px;" /><label for="scattersinglelabellabelplaceslider1diy">px</label> </div> <div class="jfgrid-datavisual-content-row"> <label data-tips="加粗" data-bigclass="scattersingle" data-attr="label" data-func="labelbold" for="scattersinglelabellabelbold" style="font-weight:bold;"><i class="fa fa-bold" aria-hidden="true"></i></label> <input type="checkbox" name="scattersinglelabellabelbold" id="scattersinglelabellabelbold" data-bigclass="scattersingle" data-attr="label" data-func="labelbold"> <label data-tips="斜体" data-bigclass="scattersingle" data-attr="label" data-func="labelitalic" for="scattersinglelabellabelitalic" class="jfgrid-datavisual-content-column-italic"><i class="fa fa-italic" aria-hidden="true"></i></label> <input type="checkbox" name="scattersinglelabellabelitalic" id="scattersinglelabellabelitalic" data-bigclass="scattersingle" data-attr="label" data-func="labelitalic"> <select data-sliderdiy="scattersinglelabellabelfontsizeslider" data-width="50" data-tips="字体大小" name="scattersinglelabellabelfontsize" id="scattersinglelabellabelfontsize" data-bigclass="scattersingle" data-attr="label" data-func="labelfontsize"> <option value="12">12px</option> <option value="14">14px</option> <option value="16">16px</option> <option value="18">18px</option> <option value="20">20px</option> <option value="22">22px</option> <option value="24">24px</option> <option value="30">30px</option> <option value="36">36px</option> <option value="diy">自定义</option> </select> <input data-tips="字体颜色" class="jfgrid-datavisual-config-color" id="scattersinglelinelabelcolor" type="text" data-bigclass="scattersingle" data-attr="label" data-func="labelcolor" /> </div> <div class="jfgrid-datavisual-content-row" style="display:none;"> <div data-tips="滑动修改字体大小" id="scattersinglelabellabelfontsizeslider" data-bigclass="scattersingle" data-attr="label" data-func="labelfontsize" class="jfgrid-datavisual-config-slider" style="width:70%;" data-min="12" data-max="100" data-step="1"></div> <input data-tips="自定义字体大小" data-sliderid="scattersinglelabellabelfontsizeslider" id="scattersinglelabellabelfontsizesliderdiy" type="text" class="jfgrid-datavisual-config-input" data-bigclass="scattersingle" data-attr="label" data-func="labelfontsize" placeholder="请输入" style="width:10%;margin-left:10px;text-align:center;margin-right: 2px;" /><label for="scattersinglelabellabelfontsizesliderdiy">px</label> </div> </div> </div> </div> </div> <div class="jfgrid-chart-point-config-chart"> <div id="jfgrid-chart-point-config-chart-c" class="jfgrid-chart-point-config-chart-c"> </div> </div> </div>';
    var jfgridToolHTML = '<div id="jfgrid-tooltip-up" class="jfk-tooltip" role="tooltip" aria-hidden="true" style="left: 505px; top: 410px;"><div class="jfk-tooltip-contentId">组合图表</div><div class="jfk-tooltip-arrow jfk-tooltip-arrowup" style="left: 35.5px;"><div class="jfk-tooltip-arrowimplbefore"></div><div class="jfk-tooltip-arrowimplafter"></div></div></div>';

    var menuToolBar = '<div class="jfgrid-toolbar-left-theme"> </div> <div class="jfgrid-toolbar-button jfgrid-inline-block" data-tips="撤销 (Ctrl+Z)" id="jfgrid-icon-undo" role="button" style="user-select: none;"> <div class="jfgrid-toolbar-button-outer-box jfgrid-inline-block" style="user-select: none;"> <div class="jfgrid-toolbar-button-inner-box jfgrid-inline-block" style="user-select: none;"> <div class="jfgrid-icon jfgrid-inline-block " style="user-select: none;"> <div aria-hidden="true" class="jfgrid-icon-img-container jfgrid-icon-img jfgrid-icon-undo" style="user-select: none;"> </div> </div> </div> </div> </div> <div class="jfgrid-toolbar-button jfgrid-inline-block" data-tips="重做 (Ctrl+Y)" id="jfgrid-icon-redo" role="button" style="user-select: none;"> <div class="jfgrid-toolbar-button-outer-box jfgrid-inline-block" style="user-select: none;"> <div class="jfgrid-toolbar-button-inner-box jfgrid-inline-block" style="user-select: none;"> <div class="jfgrid-icon jfgrid-inline-block " style="user-select: none;"> <div aria-hidden="true" class="jfgrid-icon-img-container jfgrid-icon-img jfgrid-icon-redo" style="user-select: none;"> </div> </div> </div> </div> </div> <div class="jfgrid-toolbar-button jfgrid-inline-block" data-tips="格式刷" id="jfgrid-icon-paintformat" role="button" style="user-select: none;"> <div class="jfgrid-toolbar-button-outer-box jfgrid-inline-block" style="user-select: none;"> <div class="jfgrid-toolbar-button-inner-box jfgrid-inline-block" style="user-select: none;"> <div class="jfgrid-icon jfgrid-inline-block " style="user-select: none;"> <div aria-hidden="true" class="jfgrid-icon-img-container jfgrid-icon-img jfgrid-icon-paintformat" style="user-select: none;"> </div> </div> </div> </div> </div> <!--<div class="jfgrid-toolbar-separator jfgrid-inline-block" style="user-select: none;"> </div> <div class="jfgrid-toolbar-zoom-combobox jfgrid-toolbar-combo-button jfgrid-inline-block" data-tips="缩放" id="jfgrid-icon-zoom" style="user-select: none;"> <div class="jfgrid-toolbar-combo-button-outer-box jfgrid-inline-block" style="user-select: none;"> <div class="jfgrid-toolbar-combo-button-inner-box jfgrid-inline-block" style="user-select: none;"> <div aria-posinset="4" aria-setsize="7" class="jfgrid-inline-block jfgrid-toolbar-combo-button-caption" style="user-select: none;"> <input aria-label="缩放比例" class="jfgrid-toolbar-combo-button-input jfgrid-toolbar-textinput jfgrid-mousedown-cancel" role="combobox" style="user-select: none;" tabindex="-1" type="text" value="100%"/> </div> <div class="jfgrid-toolbar-combo-button-dropdown jfgrid-inline-block " style="user-select: none;"> </div> </div> </div> </div> --> <div class="jfgrid-toolbar-separator jfgrid-inline-block" style="user-select: none;"> </div> <div class="jfgrid-toolbar-button jfgrid-inline-block" data-tips="货币格式" id="jfgrid-icon-currency" role="button" style="user-select: none;"> <div class="jfgrid-toolbar-button-outer-box jfgrid-inline-block" style="user-select: none;"> <div class="jfgrid-toolbar-button-inner-box jfgrid-inline-block" style="user-select: none;"> ¥ </div> </div> </div> <div class="jfgrid-toolbar-button jfgrid-inline-block" data-tips="百分比格式" id="jfgrid-icon-percent" role="button" style="user-select: none;"> <div class="jfgrid-toolbar-button-outer-box jfgrid-inline-block" style="user-select: none;"> <div class="jfgrid-toolbar-button-inner-box jfgrid-inline-block" style="user-select: none;"> % </div> </div> </div> <div class="jfgrid-toolbar-button jfgrid-inline-block" data-tips="减少小数位数" id="jfgrid-icon-fmt-decimal-decrease" role="button" style="user-select: none;"> <div class="jfgrid-toolbar-button-outer-box jfgrid-inline-block" style="user-select: none;"> <div class="jfgrid-toolbar-button-inner-box jfgrid-inline-block" style="user-select: none;"> <div class="jfgrid-icon jfgrid-inline-block toolbar-decimal-icon" style="user-select: none;"> <div aria-hidden="true" class="jfgrid-icon-img-container jfgrid-icon-img jfgrid-icon-decimal-decrease" style="user-select: none;"> </div> </div> </div> </div> </div> <div class="jfgrid-toolbar-button jfgrid-inline-block" data-tips="增加小数位数" id="jfgrid-icon-fmt-decimal-increase" role="button" style="user-select: none;"> <div class="jfgrid-toolbar-button-outer-box jfgrid-inline-block" style="user-select: none;"> <div class="jfgrid-toolbar-button-inner-box jfgrid-inline-block" style="user-select: none;"> <div class="jfgrid-icon jfgrid-inline-block toolbar-decimal-icon" style="user-select: none;"> <div aria-hidden="true" class="jfgrid-icon-img-container jfgrid-icon-img jfgrid-icon-decimal-increase" style="user-select: none;"> </div> </div> </div> </div> </div> <div class="jfgrid-toolbar-menu-button jfgrid-inline-block" data-tips="更多格式" id="jfgrid-icon-fmt-other" role="button" style="user-select: none;"> <div class="jfgrid-toolbar-menu-button-outer-box jfgrid-inline-block" style="user-select: none;"> <div class="jfgrid-toolbar-menu-button-inner-box jfgrid-inline-block" style="user-select: none;"> <div class="jfgrid-toolbar-menu-button-caption jfgrid-inline-block" style="user-select: none;"> 123 </div> <div class="jfgrid-toolbar-menu-button-dropdown jfgrid-inline-block " style="user-select: none;"> </div> </div> </div> </div> <div class="jfgrid-toolbar-separator jfgrid-inline-block" style="user-select: none;"> </div> <div class="jfgrid-toolbar-select jfgrid-toolbar-menu-button jfgrid-inline-block" data-tooltip="字体样式" id="jfgrid-icon-font-family" role="button" style="user-select: none;"> <div class="jfgrid-toolbar-menu-button-outer-box jfgrid-inline-block" style="user-select: none;"> <div class="jfgrid-toolbar-menu-button-inner-box jfgrid-inline-block" style="user-select: none;"> <div class="jfgrid-toolbar-menu-button-caption jfgrid-inline-block" style="user-select: none;"> 微软雅黑 </div> <div class="jfgrid-toolbar-menu-button-dropdown jfgrid-inline-block " style="user-select: none;"> </div> </div> </div> </div> <div class="jfgrid-toolbar-separator jfgrid-inline-block" style="user-select: none;"> </div> <div class="jfgrid-toolbar-zoom-combobox jfgrid-toolbar-combo-button jfgrid-inline-block" data-tips="字号大小" id="jfgrid-icon-font-size" style="user-select: none;"> <div class="jfgrid-toolbar-combo-button-outer-box jfgrid-inline-block" style="user-select: none;"> <div class="jfgrid-toolbar-combo-button-inner-box jfgrid-inline-block" style="user-select: none;"> <div aria-posinset="4" aria-setsize="7" class="jfgrid-inline-block jfgrid-toolbar-combo-button-caption" style="user-select: none;"> <input aria-label="字号大小" class="jfgrid-toolbar-combo-button-input jfgrid-toolbar-textinput jfgrid-mousedown-cancel" role="combobox" style="user-select: none;" tabindex="-1" type="text" value="10"/> </div> <div class="jfgrid-toolbar-combo-button-dropdown jfgrid-inline-block " style="user-select: none;"> </div> </div> </div> </div> <div class="jfgrid-toolbar-separator jfgrid-inline-block" style="user-select: none;"> </div> <div class="jfgrid-toolbar-button jfgrid-inline-block" data-tips="粗体 (Ctrl+B)" id="jfgrid-icon-bold" role="button" style="user-select: none;"> <div class="jfgrid-toolbar-button-outer-box jfgrid-inline-block" style="user-select: none;"> <div class="jfgrid-toolbar-button-inner-box jfgrid-inline-block" style="user-select: none;"> <div class="jfgrid-icon jfgrid-inline-block " style="user-select: none;"> <div aria-hidden="true" class="jfgrid-icon-img-container jfgrid-icon-img jfgrid-icon-bold" style="user-select: none;"> </div> </div> </div> </div> </div> <div class="jfgrid-toolbar-button jfgrid-inline-block" data-tips="斜体 (Ctrl+I)" id="jfgrid-icon-italic" role="button" style="user-select: none;"> <div class="jfgrid-toolbar-button-outer-box jfgrid-inline-block" style="user-select: none;"> <div class="jfgrid-toolbar-button-inner-box jfgrid-inline-block" style="user-select: none;"> <div class="jfgrid-icon jfgrid-inline-block " style="user-select: none;"> <div aria-hidden="true" class="jfgrid-icon-img-container jfgrid-icon-img jfgrid-icon-italic" style="user-select: none;"> </div> </div> </div> </div> </div> <div class="jfgrid-toolbar-button jfgrid-inline-block" data-tips="删除线 (Alt+Shift+5)" id="jfgrid-icon-strikethrough" role="button" style="user-select: none;"> <div class="jfgrid-toolbar-button-outer-box jfgrid-inline-block" style="user-select: none;"> <div class="jfgrid-toolbar-button-inner-box jfgrid-inline-block" style="user-select: none;"> <div class="jfgrid-icon jfgrid-inline-block " style="user-select: none;"> <div aria-hidden="true" class="jfgrid-icon-img-container jfgrid-icon-img jfgrid-icon-strikethrough" style="user-select: none;"> </div> </div> </div> </div> </div> <div class="jfgrid-toolbar-button-split-left jfgrid-toolbar-button jfgrid-inline-block" data-tips="文本颜色" id="jfgrid-icon-text-color" role="button" style="user-select: none;"> <div class="jfgrid-toolbar-button-outer-box jfgrid-inline-block" style="user-select: none;"> <div class="jfgrid-toolbar-menu-button-inner-box jfgrid-inline-block" style="user-select: none;"> <div class="jfgrid-toolbar-menu-button-caption jfgrid-inline-block" style="user-select: none;"> <div class="jfgrid-color-menu-button-indicator" style="border-bottom-color: rgb(0, 0, 0); user-select: none;"> <div class="jfgrid-icon jfgrid-inline-block " style="user-select: none;"> <div aria-hidden="true" class="jfgrid-icon-img-container jfgrid-icon-img jfgrid-icon-text-color" style="user-select: none;"> </div> </div> </div> </div> </div> </div> </div> <div class="jfgrid-toolbar-button-split-right jfgrid-toolbar-menu-button jfgrid-inline-block" data-tips="颜色选择..." id="jfgrid-icon-text-color-menu" role="button" style="user-select: none;"> <div class="jfgrid-toolbar-menu-button-outer-box jfgrid-inline-block" style="user-select: none;"> <div class="jfgrid-toolbar-menu-button-inner-box jfgrid-inline-block" style="user-select: none;"> <div class="jfgrid-toolbar-menu-button-dropdown jfgrid-inline-block " style="user-select: none;"> </div> </div> </div> </div> <div class="jfgrid-toolbar-separator jfgrid-inline-block" style="user-select: none;"> </div> <div class="jfgrid-toolbar-button-split-left jfgrid-toolbar-button jfgrid-inline-block" data-tips="单元格颜色" id="jfgrid-icon-cell-color" role="button" style="user-select: none;"> <div class="jfgrid-toolbar-button-outer-box jfgrid-inline-block" style="user-select: none;"> <div class="jfgrid-toolbar-menu-button-inner-box jfgrid-inline-block" style="user-select: none;"> <div class="jfgrid-toolbar-menu-button-caption jfgrid-inline-block" style="user-select: none;"> <div class="jfgrid-color-menu-button-indicator" style="border-bottom-color: rgb(255, 255, 255); user-select: none;"> <div class="jfgrid-icon jfgrid-inline-block " style="user-select: none;"> <div aria-hidden="true" class="jfgrid-icon-img-container jfgrid-icon-img jfgrid-icon-cell-color" style="user-select: none;"> </div> </div> </div> </div> </div> </div> </div> <div class="jfgrid-toolbar-button-split-right jfgrid-toolbar-menu-button jfgrid-inline-block" data-tips="颜色选择..." id="jfgrid-icon-cell-color-menu" role="button" style="user-select: none;"> <div class="jfgrid-toolbar-menu-button-outer-box jfgrid-inline-block" style="user-select: none;"> <div class="jfgrid-toolbar-menu-button-inner-box jfgrid-inline-block" style="user-select: none;"> <div class="jfgrid-toolbar-menu-button-dropdown jfgrid-inline-block " style="user-select: none;"> </div> </div> </div> </div> <div class="jfgrid-toolbar-button-split-left jfgrid-toolbar-button jfgrid-inline-block" data-tips="边框" id="jfgrid-icon-border-all" role="button" style="user-select: none;"> <div class="jfgrid-toolbar-button-outer-box jfgrid-inline-block" style="user-select: none;"> <div class="jfgrid-toolbar-button-inner-box jfgrid-inline-block" style="user-select: none;"> <div class="jfgrid-icon jfgrid-inline-block " style="user-select: none;"> <div aria-hidden="true" class="jfgrid-icon-img-container jfgrid-icon-img jfgrid-icon-border-all" style="user-select: none;"> </div> </div> </div> </div> </div> <div class="jfgrid-toolbar-button-split-right jfgrid-toolbar-menu-button jfgrid-inline-block" data-tips="边框类型..." id="jfgrid-icon-border-menu" role="button" style="user-select: none;"> <div class="jfgrid-toolbar-menu-button-outer-box jfgrid-inline-block" style="user-select: none;"> <div class="jfgrid-toolbar-menu-button-inner-box jfgrid-inline-block" style="user-select: none;"> <div class="jfgrid-toolbar-menu-button-dropdown jfgrid-inline-block " style="user-select: none;"> </div> </div> </div> </div> <div class="jfgrid-toolbar-button-split-left jfgrid-toolbar-button jfgrid-inline-block" data-tips="合并单元格" id="jfgrid-icon-merge-button" role="button" style="user-select: none;"> <div class="jfgrid-toolbar-button-outer-box jfgrid-inline-block" style="user-select: none;"> <div class="jfgrid-toolbar-button-inner-box jfgrid-inline-block" style="user-select: none;"> <div class="jfgrid-icon jfgrid-inline-block " style="user-select: none;"> <div aria-hidden="true" class="jfgrid-icon-img-container jfgrid-icon-img jfgrid-icon-merge" style="user-select: none;"> </div> </div> </div> </div> </div> <div class="jfgrid-toolbar-button-split-right jfgrid-toolbar-menu-button jfgrid-inline-block" data-tips="选择合并类型..." id="jfgrid-icon-merge-menu" role="button" style="user-select: none;"> <div class="jfgrid-toolbar-menu-button-outer-box jfgrid-inline-block" style="user-select: none;"> <div class="jfgrid-toolbar-menu-button-inner-box jfgrid-inline-block" style="user-select: none;"> <div class="jfgrid-toolbar-menu-button-dropdown jfgrid-inline-block " style="user-select: none;"> </div> </div> </div> </div> <div class="jfgrid-toolbar-separator jfgrid-inline-block" style="user-select: none;"> </div> <div class="jfgrid-toolbar-button-split-left jfgrid-toolbar-button jfgrid-inline-block" data-tips="水平对齐" id="jfgrid-icon-align" role="button" style="user-select: none;"> <div class="jfgrid-toolbar-button-outer-box jfgrid-inline-block" style="user-select: none;"> <div class="jfgrid-toolbar-menu-button-inner-box jfgrid-inline-block" style="user-select: none;"> <div class="jfgrid-toolbar-menu-button-caption jfgrid-inline-block" style="user-select: none;"> <div class="jfgrid-icon jfgrid-inline-block " style="user-select: none;"> <div aria-hidden="true" class="jfgrid-icon-img-container jfgrid-icon-img jfgrid-icon-align-left" style="user-select: none;"> </div> </div> </div> </div> </div> </div> <div class="jfgrid-toolbar-button-split-right jfgrid-toolbar-menu-button jfgrid-inline-block" data-tips="对齐方式..." id="jfgrid-icon-align-menu" role="button" style="user-select: none;"> <div class="jfgrid-toolbar-menu-button-outer-box jfgrid-inline-block" style="user-select: none;"> <div class="jfgrid-toolbar-menu-button-inner-box jfgrid-inline-block" style="user-select: none;"> <div class="jfgrid-toolbar-menu-button-dropdown jfgrid-inline-block " style="user-select: none;"> </div> </div> </div> </div> <div class="jfgrid-toolbar-button-split-left jfgrid-toolbar-button jfgrid-inline-block" data-tips="垂直对齐" id="jfgrid-icon-valign" role="button" style="user-select: none;"> <div class="jfgrid-toolbar-button-outer-box jfgrid-inline-block" style="user-select: none;"> <div class="jfgrid-toolbar-menu-button-inner-box jfgrid-inline-block" style="user-select: none;"> <div class="jfgrid-toolbar-menu-button-caption jfgrid-inline-block" style="user-select: none;"> <div class="jfgrid-icon jfgrid-inline-block " style="user-select: none;"> <div aria-hidden="true" class="jfgrid-icon-img-container jfgrid-icon-img jfgrid-icon-valign-bottom" style="user-select: none;"> </div> </div> </div> </div> </div> </div> <div class="jfgrid-toolbar-button-split-right jfgrid-toolbar-menu-button jfgrid-inline-block" data-tips="对齐方式..." id="jfgrid-icon-valign-menu" role="button" style="user-select: none;"> <div class="jfgrid-toolbar-menu-button-outer-box jfgrid-inline-block" style="user-select: none;"> <div class="jfgrid-toolbar-menu-button-inner-box jfgrid-inline-block" style="user-select: none;"> <div class="jfgrid-toolbar-menu-button-dropdown jfgrid-inline-block " style="user-select: none;"> </div> </div> </div> </div> <div class="jfgrid-toolbar-button-split-left jfgrid-toolbar-button jfgrid-inline-block" data-tips="文本换行" id="jfgrid-icon-textwrap" role="button" style="user-select: none;"> <div class="jfgrid-toolbar-button-outer-box jfgrid-inline-block" style="user-select: none;"> <div class="jfgrid-toolbar-menu-button-inner-box jfgrid-inline-block" style="user-select: none;"> <div class="jfgrid-toolbar-menu-button-caption jfgrid-inline-block" style="user-select: none;"> <div class="jfgrid-icon jfgrid-inline-block " style="user-select: none;"> <div aria-hidden="true" class="jfgrid-icon-img-container jfgrid-icon-img jfgrid-icon-textwrap-overflow" style="user-select: none;"> </div> </div> </div> </div> </div> </div> <div class="jfgrid-toolbar-button-split-right jfgrid-toolbar-menu-button jfgrid-inline-block" data-tips="换行方式..." id="jfgrid-icon-textwrap-menu" role="button" style="user-select: none;"> <div class="jfgrid-toolbar-menu-button-outer-box jfgrid-inline-block" style="user-select: none;"> <div class="jfgrid-toolbar-menu-button-inner-box jfgrid-inline-block" style="user-select: none;"> <div class="jfgrid-toolbar-menu-button-dropdown jfgrid-inline-block " style="user-select: none;"> </div> </div> </div> </div> <div class="jfgrid-toolbar-button-split-left jfgrid-toolbar-button jfgrid-inline-block" data-tips="文本旋转" id="jfgrid-icon-rotation" role="button" style="user-select: none;"> <div class="jfgrid-toolbar-button-outer-box jfgrid-inline-block" style="user-select: none;"> <div class="jfgrid-toolbar-menu-button-inner-box jfgrid-inline-block" style="user-select: none;"> <div class="jfgrid-toolbar-menu-button-caption jfgrid-inline-block" style="user-select: none;"> <div class="jfgrid-icon jfgrid-inline-block " style="user-select: none;"> <div aria-hidden="true" class="jfgrid-icon-img-container jfgrid-icon-img jfgrid-icon-rotation-none" style="user-select: none;"> </div> </div> </div> </div> </div> </div> <div class="jfgrid-toolbar-button-split-right jfgrid-toolbar-menu-button jfgrid-inline-block" data-tips="旋转方式..." id="jfgrid-icon-rotation-menu" role="button" style="user-select: none;"> <div class="jfgrid-toolbar-menu-button-outer-box jfgrid-inline-block" style="user-select: none;"> <div class="jfgrid-toolbar-menu-button-inner-box jfgrid-inline-block" style="user-select: none;"> <div class="jfgrid-toolbar-menu-button-dropdown jfgrid-inline-block " style="user-select: none;"> </div> </div> </div> </div> <div class="jfgrid-toolbar-separator jfgrid-inline-block" style="user-select: none;"> </div> <div class="jfgrid-toolbar-button-split-left jfgrid-toolbar-button jfgrid-inline-block" data-tips="冻结首行" id="jfgrid-freezen-btn-horizontal" role="button" style="user-select: none;"> <div class="jfgrid-toolbar-button-outer-box jfgrid-inline-block" style="user-select: none;"> <div class="jfgrid-toolbar-button-inner-box jfgrid-inline-block" style="user-select: none;"> <div class="jfgrid-toolbar-menu-button-caption jfgrid-inline-block" style="user-select: none;"> <i class="fa fa-list-alt"> </i> 冻结首行 </div> </div> </div> </div> <div class="jfgrid-toolbar-button-split-right jfgrid-toolbar-menu-button jfgrid-inline-block" data-tips="更多选项..." id="jfgrid-icon-freezen-menu" role="button" style="user-select: none;"> <div class="jfgrid-toolbar-menu-button-outer-box jfgrid-inline-block" style="user-select: none;"> <div class="jfgrid-toolbar-menu-button-inner-box jfgrid-inline-block" style="user-select: none;"> <div class="jfgrid-toolbar-menu-button-dropdown jfgrid-inline-block " style="user-select: none;"> </div> </div> </div> </div> <div class="jfgrid-toolbar-separator jfgrid-inline-block" style="user-select: none;"> </div> <div class="jfgrid-toolbar-menu-button jfgrid-inline-block" data-tips="排序和筛选" id="jfgrid-icon-autofilter" role="button" style="user-select: none;"> <div class="jfgrid-toolbar-menu-button-outer-box jfgrid-inline-block" style="user-select: none;"> <div class="jfgrid-toolbar-button-inner-box jfgrid-inline-block" style="user-select: none;"> <div class="jfgrid-icon jfgrid-inline-block " style="user-select: none;"> <div aria-hidden="true" class="jfgrid-icon-img-container jfgrid-icon-img jfgrid-icon-autofilter" style="user-select: none;"> </div> </div> <div class="jfgrid-toolbar-menu-button-dropdown jfgrid-inline-block " style="user-select: none;margin-left: 0px;margin-right: 4px;"> </div> </div> </div> </div> <div class="jfgrid-toolbar-menu-button jfgrid-inline-block" data-tips="查找替换" id="jfgrid-icon-seachmore" role="button" style="user-select: none;"> <div class="jfgrid-toolbar-menu-button-outer-box jfgrid-inline-block" style="user-select: none;"> <div class="jfgrid-toolbar-button-inner-box jfgrid-inline-block" style="user-select: none;"> <div class="jfgrid-toolbar-menu-button-caption jfgrid-inline-block" style="user-select: none;font-size: 14px;"> <i class="fa fa-search" aria-hidden="true"></i> </div> <div class="jfgrid-toolbar-menu-button-dropdown jfgrid-inline-block" style="user-select: none;margin-left: 0px;margin-right: 4px;"> </div> </div> </div> </div> <div class="jfgrid-toolbar-button-split-left jfgrid-toolbar-button jfgrid-inline-block" data-tips="自动求和" id="jfgrid-icon-function" role="button" style="user-select: none;"> <div class="jfgrid-toolbar-button-outer-box jfgrid-inline-block" style="user-select: none;"> <div class="jfgrid-toolbar-button-inner-box jfgrid-inline-block" style="user-select: none;"> <div class="jfgrid-icon jfgrid-inline-block " style="user-select: none;"> <div aria-hidden="true" class="jfgrid-icon-img-container jfgrid-icon-img jfgrid-icon-function" style="user-select: none;"> </div> </div> <div class="jfgrid-toolbar-menu-button-caption jfgrid-inline-block" style="user-select: none;"> 求和 </div> </div> </div> </div> <div class="jfgrid-toolbar-button-split-right jfgrid-toolbar-menu-button jfgrid-inline-block" data-tips="更多函数..." id="jfgrid-icon-function-menu" role="button" style="user-select: none;"> <div class="jfgrid-toolbar-menu-button-outer-box jfgrid-inline-block" style="user-select: none;"> <div class="jfgrid-toolbar-menu-button-inner-box jfgrid-inline-block" style="user-select: none;"> <div class="jfgrid-toolbar-menu-button-dropdown jfgrid-inline-block " style="user-select: none;"> </div> </div> </div> </div><div class="jfgrid-toolbar-menu-button jfgrid-inline-block" data-tips="条件格式" id="jfgrid-icon-conditionformat" role="button" style="user-select: none;"> <div class="jfgrid-toolbar-menu-button-outer-box jfgrid-inline-block" style="user-select: none;"> <div class="jfgrid-toolbar-menu-button-inner-box jfgrid-inline-block" style="user-select: none;"> <div class="jfgrid-toolbar-menu-button-caption jfgrid-inline-block" style="user-select: none;"> 条件格式 </div> <div class="jfgrid-toolbar-menu-button-dropdown jfgrid-inline-block " style="user-select: none;"> </div> </div> </div> </div> <div class="jfgrid-toolbar-menu-button jfgrid-inline-block" data-tips="批注" id="jfgrid-icon-postil" role="button" style="user-select: none;"> <div class="jfgrid-toolbar-menu-button-outer-box jfgrid-inline-block" style="user-select: none;"> <div class="jfgrid-toolbar-menu-button-inner-box jfgrid-inline-block" style="user-select: none;"> <div class="jfgrid-toolbar-menu-button-caption jfgrid-inline-block" style="user-select: none;"> 批注 </div> <div class="jfgrid-toolbar-menu-button-dropdown jfgrid-inline-block " style="user-select: none;"> </div> </div> </div> </div> <div class="jfgridfulltoolbar" id="jfgrid-pivot-btn-title"> <i aria-hidden="true" class="fa fa-cube"> </i> 数据透视表 </div> <div class="jfgridfulltoolbar" id="jfgrid-chart-btn-title"> <i class="fa fa-pie-chart"> </i> 图表 </div> <div class="jfgridfulltoolbar" id="jfgrid-chart-btn-screenshot"> <i class="fa fa-object-group"> </i> 截图 </div> <div class="jfgridfulltoolbar" id="jfgrid-splitColumn-btn-title"> <i class="fa fa-gg"> </i> 分列 </div>';
    var jfgridlodingHTML = '<div id="jfgridloadingdata" style="width:100%;text-align:center;position:absolute;top:0px;height:100%;font-size: 16px;z-index:1000000000;background:#fff;"><div style="position:relative;top:45%;width:100%;"> <div class="jfgridLoaderGif"></div>  <span>正在准备！请稍后</span></div></div>';

    // var menusetting = {
    //     menu_selectall: '<div id="jfgrid-selectall-btn-title"><i class="fa fa-i-cursor"></i> 全选</div>',
    //     menu_copy: '<div id="jfgrid-copy-btn-title"><i class="fa fa-copy"></i> 复制</div>',
    //     menu_undo: '<div id="jfgrid-redo-btn-title"><i class="fa fa-reply"></i> 撤销</div>',
    //     menu_redo: '<div id="jfgrid-undo-btn-title"><i class="fa fa-share"></i> 恢复</div>',
    //     menu_paste: '<div id="jfgrid-paste-btn-title"><i class="fa fa-clipboard"></i> 粘贴</div>',
    //     menu_download: '<div id="jfgrid-download-btn-title"><i class="fa fa-cloud-download"></i> 下载</div>',
    //     menu_share: '<div id="jfgrid-share-btn-title"><i class="fa fa-share-alt"></i> 分享</div>',
    //     menu_chart: '<div id="jfgrid-chart-btn-title"> <i class="fa fa-pie-chart"></i> 图表生成</div>',
    //     menu_pivot: '<div id="jfgrid-pivot-btn-title"> <i class="fa fa-cube" aria-hidden="true"></i> 数据透视表</div>',
    //     menu_freezenrow: '<div id="jfgrid-freezen-btn-horizontal"><i class="fa fa-list-alt"></i> 冻结首行</div>',
    //     menu_freezencolumn: '<div id="jfgrid-freezen-btn-vertical"><i class="fa fa-indent"></i> 冻结首列</div>',
    // };


    jfgrid.jfcolor = [
        "#c1232b",
        "#27727b",
        "#fcce10",
        "#e87c25",
        "#b5c334",
        "#fe8463",
        "#9bca63",
        "#fad860",
        "#f3a43b",
        "#60c0dd",
        "#d7504b",
        "#c6e579",
        "#f4e001",
        "#f0805a",
        "#26c0c0",
        "#c12e34",
        "#e6b600",
        "#0098d9",
        "#2b821d",
        "#005eaa",
        "#339ca8",
        "#cda819",
        "#32a487",
        "#3fb1e3",
        "#6be6c1",
        "#626c91",
        "#a0a7e6",
        "#c4ebad",
        "#96dee8"
    ];

    var keycode = {

        BACKSPACE: 8,
        TAB: 9,
        ENTER: 13,
        SHIFT: 16,
        CTRL: 17,
        PAUSE: 19,
        CAPSLOCK: 20,
        ESC: 27,

        SPACE: 33,
        PAGEUP: 33,
        PAGEDOWN: 34,
        END: 35,
        HOME: 36,
        LEFT: 37,
        UP: 38,
        RIGHT: 39,
        DOWN: 40,
        INSERT: 45,
        DELETE: 46,

        WIN: 91,
        WIN_R: 92,
        MENU: 93,

        F1: 112,
        F2: 113,
        F3: 114,
        F4: 115,
        F5: 116,
        F6: 117,
        F7: 118,
        F8: 119,
        F9: 120,
        F10: 121,
        F11: 122,
        F12: 123,
        NUMLOCK: 144,
        SCROLLLOCK: 145
    };

    //动态表格
    var visibledatarow = [], visibledatacolumn = [], rowsplit = [], rowsplitlen = 20000, colsplit = [], colsplitlen = 12000, ch_width = 0, rh_height = 0, iscopyself = true;

    //各个部分高度设定
    var toolbarHeight = 35, infobarHeight = 30, calculatebarHeight = 30, rowHeaderWidth = 46, columeHeaderHeight = 20, cellMainSrollBarSize = 12, sheetBarHeight = 27, statisticBarHeight = 23, copyType = "normal", copysetting = [], jfgridTableContentHW = [0, 0];

    var defaultcollen = 73, defaultrowlen = 19;
    jfgrid.defaultcollen = defaultcollen;
    jfgrid.defaultrowlen = defaultrowlen;

    var jfgird_select_status = false,
        jfgird_select_save = [{ "row": [0, 0], "column": [0, 0] }],
        jfgrid_selection_range = [],
        jfgrid_copy_save = {},
        jfgrid_paste_iscut = false, jfgird_filter_save = { "row": [], "column": [] };
    
    //条件格式规则
    var jfgrid_conditionformat_save = [];

    var clearjfundo = true, sourcechange = true, config = {}, filterchage = true, jfgridCellUpdate = [], jfgridRightHeadClickIs = "column";

    var jfgird_sheet_move_status = false, jfgird_sheet_move_data = [], jfgird_scroll_status = false;
    var jfgridisrefreshdetail = true, jfgridisrefreshtheme = true, jfgridcurrentisPivotTable = false;

    var jfgridautoadjust = null, jfgridautoadjustmousedown = 2, jfgridautoscrollp = [0, 0];

    var devicePixelRatio = 1;
    var jfgriddefaultstyle = null;
    var jfgrid_shiftkeydown = false;

    jfgrid.flowdata = null;
    jfgrid.currentSheetIndex = 0;
    jfgrid.jfgrid_shiftpositon = null;

    var jfcountfuncTimeout = null, jfautoscrollTimeout = null;

    jfgrid.jfredo = [];
    jfgrid.jfundo = [];

    jfgrid.modelHTML = modelHTML;

    var jfgrid_CFiconsImg = new Image();
    jfgrid_CFiconsImg.src = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAZoAAAGACAYAAACUS6SeAAAACXBIWXMAAC4jAAAuIwF4pT92AAAKTWlDQ1BQaG90b3Nob3AgSUNDIHByb2ZpbGUAAHjanVN3WJP3Fj7f92UPVkLY8LGXbIEAIiOsCMgQWaIQkgBhhBASQMWFiApWFBURnEhVxILVCkidiOKgKLhnQYqIWotVXDjuH9yntX167+3t+9f7vOec5/zOec8PgBESJpHmomoAOVKFPDrYH49PSMTJvYACFUjgBCAQ5svCZwXFAADwA3l4fnSwP/wBr28AAgBw1S4kEsfh/4O6UCZXACCRAOAiEucLAZBSAMguVMgUAMgYALBTs2QKAJQAAGx5fEIiAKoNAOz0ST4FANipk9wXANiiHKkIAI0BAJkoRyQCQLsAYFWBUiwCwMIAoKxAIi4EwK4BgFm2MkcCgL0FAHaOWJAPQGAAgJlCLMwAIDgCAEMeE80DIEwDoDDSv+CpX3CFuEgBAMDLlc2XS9IzFLiV0Bp38vDg4iHiwmyxQmEXKRBmCeQinJebIxNI5wNMzgwAABr50cH+OD+Q5+bk4eZm52zv9MWi/mvwbyI+IfHf/ryMAgQAEE7P79pf5eXWA3DHAbB1v2upWwDaVgBo3/ldM9sJoFoK0Hr5i3k4/EAenqFQyDwdHAoLC+0lYqG9MOOLPv8z4W/gi372/EAe/tt68ABxmkCZrcCjg/1xYW52rlKO58sEQjFu9+cj/seFf/2OKdHiNLFcLBWK8ViJuFAiTcd5uVKRRCHJleIS6X8y8R+W/QmTdw0ArIZPwE62B7XLbMB+7gECiw5Y0nYAQH7zLYwaC5EAEGc0Mnn3AACTv/mPQCsBAM2XpOMAALzoGFyolBdMxggAAESggSqwQQcMwRSswA6cwR28wBcCYQZEQAwkwDwQQgbkgBwKoRiWQRlUwDrYBLWwAxqgEZrhELTBMTgN5+ASXIHrcBcGYBiewhi8hgkEQcgIE2EhOogRYo7YIs4IF5mOBCJhSDSSgKQg6YgUUSLFyHKkAqlCapFdSCPyLXIUOY1cQPqQ28ggMor8irxHMZSBslED1AJ1QLmoHxqKxqBz0XQ0D12AlqJr0Rq0Hj2AtqKn0UvodXQAfYqOY4DRMQ5mjNlhXIyHRWCJWBomxxZj5Vg1Vo81Yx1YN3YVG8CeYe8IJAKLgBPsCF6EEMJsgpCQR1hMWEOoJewjtBK6CFcJg4Qxwicik6hPtCV6EvnEeGI6sZBYRqwm7iEeIZ4lXicOE1+TSCQOyZLkTgohJZAySQtJa0jbSC2kU6Q+0hBpnEwm65Btyd7kCLKArCCXkbeQD5BPkvvJw+S3FDrFiOJMCaIkUqSUEko1ZT/lBKWfMkKZoKpRzame1AiqiDqfWkltoHZQL1OHqRM0dZolzZsWQ8ukLaPV0JppZ2n3aC/pdLoJ3YMeRZfQl9Jr6Afp5+mD9HcMDYYNg8dIYigZaxl7GacYtxkvmUymBdOXmchUMNcyG5lnmA+Yb1VYKvYqfBWRyhKVOpVWlX6V56pUVXNVP9V5qgtUq1UPq15WfaZGVbNQ46kJ1Bar1akdVbupNq7OUndSj1DPUV+jvl/9gvpjDbKGhUaghkijVGO3xhmNIRbGMmXxWELWclYD6yxrmE1iW7L57Ex2Bfsbdi97TFNDc6pmrGaRZp3mcc0BDsax4PA52ZxKziHODc57LQMtPy2x1mqtZq1+rTfaetq+2mLtcu0W7eva73VwnUCdLJ31Om0693UJuja6UbqFutt1z+o+02PreekJ9cr1Dund0Uf1bfSj9Rfq79bv0R83MDQINpAZbDE4Y/DMkGPoa5hpuNHwhOGoEctoupHEaKPRSaMnuCbuh2fjNXgXPmasbxxirDTeZdxrPGFiaTLbpMSkxeS+Kc2Ua5pmutG003TMzMgs3KzYrMnsjjnVnGueYb7ZvNv8jYWlRZzFSos2i8eW2pZ8ywWWTZb3rJhWPlZ5VvVW16xJ1lzrLOtt1ldsUBtXmwybOpvLtqitm63Edptt3xTiFI8p0in1U27aMez87ArsmuwG7Tn2YfYl9m32zx3MHBId1jt0O3xydHXMdmxwvOuk4TTDqcSpw+lXZxtnoXOd8zUXpkuQyxKXdpcXU22niqdun3rLleUa7rrStdP1o5u7m9yt2W3U3cw9xX2r+00umxvJXcM970H08PdY4nHM452nm6fC85DnL152Xlle+70eT7OcJp7WMG3I28Rb4L3Le2A6Pj1l+s7pAz7GPgKfep+Hvqa+It89viN+1n6Zfgf8nvs7+sv9j/i/4XnyFvFOBWABwQHlAb2BGoGzA2sDHwSZBKUHNQWNBbsGLww+FUIMCQ1ZH3KTb8AX8hv5YzPcZyya0RXKCJ0VWhv6MMwmTB7WEY6GzwjfEH5vpvlM6cy2CIjgR2yIuB9pGZkX+X0UKSoyqi7qUbRTdHF09yzWrORZ+2e9jvGPqYy5O9tqtnJ2Z6xqbFJsY+ybuIC4qriBeIf4RfGXEnQTJAntieTE2MQ9ieNzAudsmjOc5JpUlnRjruXcorkX5unOy553PFk1WZB8OIWYEpeyP+WDIEJQLxhP5aduTR0T8oSbhU9FvqKNolGxt7hKPJLmnVaV9jjdO31D+miGT0Z1xjMJT1IreZEZkrkj801WRNberM/ZcdktOZSclJyjUg1plrQr1zC3KLdPZisrkw3keeZtyhuTh8r35CP5c/PbFWyFTNGjtFKuUA4WTC+oK3hbGFt4uEi9SFrUM99m/ur5IwuCFny9kLBQuLCz2Lh4WfHgIr9FuxYji1MXdy4xXVK6ZHhp8NJ9y2jLspb9UOJYUlXyannc8o5Sg9KlpUMrglc0lamUycturvRauWMVYZVkVe9ql9VbVn8qF5VfrHCsqK74sEa45uJXTl/VfPV5bdra3kq3yu3rSOuk626s91m/r0q9akHV0IbwDa0b8Y3lG19tSt50oXpq9Y7NtM3KzQM1YTXtW8y2rNvyoTaj9nqdf13LVv2tq7e+2Sba1r/dd3vzDoMdFTve75TsvLUreFdrvUV99W7S7oLdjxpiG7q/5n7duEd3T8Wej3ulewf2Re/ranRvbNyvv7+yCW1SNo0eSDpw5ZuAb9qb7Zp3tXBaKg7CQeXBJ9+mfHvjUOihzsPcw83fmX+39QjrSHkr0jq/dawto22gPaG97+iMo50dXh1Hvrf/fu8x42N1xzWPV56gnSg98fnkgpPjp2Snnp1OPz3Umdx590z8mWtdUV29Z0PPnj8XdO5Mt1/3yfPe549d8Lxw9CL3Ytslt0utPa49R35w/eFIr1tv62X3y+1XPK509E3rO9Hv03/6asDVc9f41y5dn3m978bsG7duJt0cuCW69fh29u0XdwruTNxdeo94r/y+2v3qB/oP6n+0/rFlwG3g+GDAYM/DWQ/vDgmHnv6U/9OH4dJHzEfVI0YjjY+dHx8bDRq98mTOk+GnsqcTz8p+Vv9563Or59/94vtLz1j82PAL+YvPv655qfNy76uprzrHI8cfvM55PfGm/K3O233vuO+638e9H5ko/ED+UPPR+mPHp9BP9z7nfP78L/eE8/sl0p8zAAAAIGNIUk0AAHolAACAgwAA+f8AAIDpAAB1MAAA6mAAADqYAAAXb5JfxUYAAHBbSURBVHja7J13mFxV+cc/M7OzLbvpjZBKQhISUgAhgAlVkADSRcDyky4iYAAhAmpQQtMIiqigYkV6FRHphgBBKSGBkB5IIb1sdrO72dmZ+f3xniGTzZR755a5s/t+nmefTGbuPec7Z8497ynveU9on5m3YJMuwNnAt4B9gA3A48CPgY0UyPxJUzN/MLMShxwDXAMcAmwGbgD+UlBKhzVn/+yqqwrVFwIuBL7tZnkyYwaK98yaNb/QW6uBk4DLgfHAduDfwI+ApYUmOnHiKC+0AowAfgh8EYgAvwF+AMTd1OlQ40nAtcB+QIMpzx8Cy70oT8U6YZvXn2x+tN8A44ByYE/gMmA18B9g7wB9v58AzwNfADoBA4A/m4c5KPwWuCdDef4X6KVVtF1yGPAx8IDpAFUBPYGvAguBucCRAdJ7CvAecA7QA+gKfB94DKgMiMargaeAQ0159gK+BrwNqLUoIUNzFPAw0C3L5+XmAXoZ6B+A7/ZNM3rJxDTgl2Y0UUwmAxdl+WwI8HOtou2OzwFP5+hERIAxwDPAhADoHQvcbxrvTB3PZ4HaImscDmSbmukO/F6rXWkYmgnAP4wxyUd/U/m6FPF7lQO35bnmMuCvQLSIOs/J8/npQIVW03bDPjaejWrgn8boFJPpRks2jgReKfLo+yygLMfnhwCDtPoF29CMMUam2ka6Y8wDVV2k73Uw0NvCdV9F1kOqiqQzX+WvQqfP2gsDkWlcO79nD/McFWuGoAJZk8nHAcBM8x2LwRAL1+ytVTC4hmawqeiFNHaHInPQkSJ8rxob156ILBp2LYLOkAu/kRJ8egEvFWgw+iPT0cXocJTnGSmkMxJ4zfxbDJ1WjKYSQEPTC3jBYW/qJODX+L8WMhuos3H9JDP876NVQnGZLsbIDHOQxt5mVqGTz9rrgTdtjtpmmhGOouQ1NF2MkRnmQh4XATf7/L02GyO3zcY944FZZhSnKG5QDfwLd9ZZJiBOBOU+f4evAAtsjt5eIVhec0oADU21qdDjXMxnKnCJz99tJuIpt97GPcOA14HRWjUUh5QDTyAL0W5xFPAn/J2OXoV4k75j455aZMr9ZK0GSiZDE0XWVQ7zIK+7kI2efvKO+S6f2LinnzFSB2v1UAokAvwNONaDtM82z5KfbDBG7lUb91Qi+2z+T6uDkm5oQsAfkSknrx6+P5kK6ycLkTWYj2zc0x14EYkqoCh2CCGbcL/sYR6XIDve/WQbsu/rKZvP/B+BKVotOjbpHiW/RNx9vZ5OeByZv32vwDQmG51DsOdJYne/TCdk09xXgUcdfN9DkE2urwGbXCjDLsDvEG+5rcCTSASENVqdA8HtwAU+5HOjGWn8psD7RxmDNRZ7TgZ2p+1CyMbjzkZzoR3izyGOSf8DVrrUFv0S2cvWgqyl3Qgs0SrsnaH5IfAdn/LsgrgTH2rzR031FC/ysXzKzSjsBex5sQGci2wa7ZXWIzzZ5vRDW6oR76NJ5v9VprE4wxie/2qVLirXIaFQ/OIu03l52OZ93wTuxd/NytOQdZv/2bzvGMRzNeWY1Aqch2y2djLqvK9Nx/prSKidc8wzprhI2PxoN/qcby/Tg7CzN+BbPhuZ9JHNWTbvmW4qcvr362xGH/sXqCOCrJ9NylKezwB9tUoXjfPM7+4nEdPg2pmOHoXE1itGRIyLbV7/VdNODGvTOXY6xf8rMs/e1AAPoc5Anhia64uU9zDsxSD6VhHL6ds2e2DX5RjNPYd9t/GQeThOymO8r9cqXTSKVfblyNRuZ4vXX4D/LtLpowarcdGGmPYhksXAPkhh671T8zzPVfi/HaNDGJo9LF77EWAlhvetNvK342s/oojlZGe387UWRnN2A4/ebNHQnqpVumhYfY5WIfu18vFzZO3ACt2QfWBW2KeIZVSB9ZhjV5A7MnQVst5rZ3PoNy0akckUL3xWuzU0b1h8OI5FNkLm4zc2jI2dDZUbi1hOG2xce6iFawYg61TdLVx7iemFWaGzVumi8YbFenQcsMLCtS8jrsxWz3tpKIHnCGCLxeusRK7ugkytWYl1dpIZIVmJUhLFXhgrxYKhud3Cw3GUMTZWuQ5ZuM/HEzbSfLqI5fSkjWuten+Nwto5GVNt5P2KVumike8EwTrEYeNDG2k+jkQZz8cyrHtxPlHEMnoLObfKTYPUC2ubYi/Cusfc+9jb6K1YMDTP5xhO1plh5GKb6SYRL7an8/Ss7Cye/gg5LMpvmhCPGatML9JvuQR/3GqVzLyU47dvBE6jMK/A35B9zS/1rH3X/GvV0DxVpDK6zsa1P8H61KHbsxdnaHV239CALGSex65TRNsQd793Ckw7bob+r2X5MU8E1tqsABOQHdfNPpbRbJvTDffZNExuPRyTsTfFp7jPDchO+LVtjMyZyFSYk9HS3VmesSuw546bRDaT3oi/02hbsrQF2XgT2SIQ91FjI/AldC+N66Rv2PwjcpLeoUjI/FkuVMTUD/d7Y1i24GyD4Xrg66bn3gfrIcwxUxDftZnfJxTmUn2jGdJf6sNvmBp16sMRDP6CuKEfjBzP/KbNDlWu+rsNcQqJIGGSbkKmo+wSM52hn5jnyM5xzIcj0+J2PNe2m05nzKbOvyPrML/24XdrQQKIvqVV2FtDkyrsVz1oCN0Ox7EDawuqIIt/PynAyHyALNyudtAwdMXbaAstZkrmHa3KgSJms/dudSRyHfamn6zMOnxq4/pTTaNvx8hsAk5w0ID/BnGaucnD3yuJzOg8o1XXG9r7oVoRJFyL3T0Os5BgnKtdqLxeOTHETfovazVWfOAi4BGbo5+V5jlyOkqYDvzCw+92HTKbo6ihsU3Kz/58m/c9jbhyb3FBQwvZ16mccpk+HIpP/BCJJmAnztl84PNY23tnhSke1fefYW/vn6KG5jO6IN50dsNU/AGZimpyUUtqnWqei2neSuHBFBXFKiHECcFuiKo3kVBJK13UkkQ2XLo5Q3A/cI3+zGpoCuVeYGIBw/ML8cbLpQ44GncW7H+Hu/P0ipKNb2Mv/BLIOscXsLa52y6tZobgPy6k9SIy9ZzUn1kNTaF80ca1CeByxDXVy0q3AZmSW+UgjaeRSAH6cCh+MNnm9X9CHAYaPdTUiERBn+sgjbdMGi36EwfT0Fhp4BIB+F5Wp75akLDgfp1YuBw4nsLOpXkDeyFJFMUp221ce5sZIbT6oKvOjJoKmSFYgkxlN+rPG1xDk8+luIlgbBq0Emaj3jT6D/msbR7i7tlo857j9eFoN6x04VnzAysRBJLIQv1Un0fahcwQrEK2LOjG5oAbmnxeH48he1yKzfQ8lWkdEjn6pSLpewtxVGix+HAcj/2D15Tg8mCekf/7uOs84kTnm3lmBL4G3FkkfXZmCOrMtUu1+vlPmc3r/4UsRl+Y5Ue/MiDfa7UZNfyT3Q9XW4as4RR7J/1LyE7k+5Aw722JmYf8Apyt6yjBYw4Su+8nGT7bioSxCQIJJAzVv9j9wL4G4HTEu7OYzEPWkv6BRDloS9xcc4mbxnvWrPmB+IEmThxVEhW+EGeAi82PNtf0aFYju4UPCtiQ9H/AOGT9ZRUyrfcY4tsflHAtTyIhzi/NUJ79kHAfi1HaIzchMdBmI7H7NpsRxEFmRBMU1iMenFORM6l2GM2HB8DIpD/rQ0x5vmnKcxMyA7M3sJ/RrJTIiAZkHva3WDsGoNisQTzKLg+wxjpjWH6t1bFDUY1sgEyav4TpfScCqLUJWey/LcDl2YRELnikBH77k5EDEsebkeG/KF50en8MzfxJU/WRd4MZM7QMFKschhy/nD6tW4XExTsL2U1/BR3wfKHUVFCxp6Y8nJK6po3BrgK+gawfTQIW6IimKI9kM4rSjvgcsh+qS5bPI8AYZOPjUbgYTXjixFFWGvAIsmbY3fzb9nWuz3Yga7h3k8VrzmEDPhwYbUYBb2L9VNFUg/4dY8hHmbZvCTKd/jNkbcxrRpL97K+eSJifw9XQKIrihH2AZ3MYmXSqEWeWI/HOA60PEl7mc0APYzScHAdebXrs1yBrjlchO/Cd0h/4K3BE2nv1yHTTneR3q+6OBJ8dl6Hhv96MJCfhvdPN2eSOF3cYMJBguLa7a2hGvVb8eHLtYvruqquCo0Wn8YLIQGTxvJeNe3oYw3SIB41gZyRK+TCPvu9Y4DkkUsA/HKTTAwlKO7jN+7XAz5HF/kvzGJvpGYxMOoMR54xvelwHBlu4ZkB7NDRhff4VxXN6Ie7s/Qvszb9s00BZ4bseGpkUEeTQw04O0rg+TwN9CRIMN9dIYYKFfD7nR8fewjWh9vgAhB1WgM3m73qUFF8CPkRCcSR9+ms1eZ6kxR84uhgj46RR39uMCjq5qOsMn75/byQieqGcbuGac5GTTbMZGysLvT20qgbP0HzJDDVTi4A3aSP3GX9GFhsjPuYZMXn+RYs/UFQjrqtjXEhrAuJEUO6StmE+lsP3HdxrdRR4DvBwlvKxEkm6m1bXYBma/mTe8zHDg+F9KfJQB81b2ZVyJObeIS6meRQSIdmNToyf+3VGOrjXztrUaYgXWUUBhqYC8UxTAmBouiCLk/2z9JAecrHHVapcgr1z2N3ieiRqg1J8IsDfkKCPbnM27kQb93OjipN1h6dsXn8iMs1Ynfae1dNydVTjEWU2H57780wDHImc7X2JawpnVgantKzv6TkTWcD1y+g+CNyi1TkQhJCoGV/2uDOzFvixgzQeBg70qUycbIb7MbKTfqCNe44xHeITkb02dgzNp1qFizuiuQsJVJmPb2H/VL72xuv4d3rf28D56GFoQeF2JBCq19zosEP3K5wdHmYHJxHdNxrDYfdY6FQsti42DI1Th4Awspb2JSRWoRuUIxs5601Z/AUY2l4NzVSblfpOZD7ZbWqR8A2fIHPMXnlxJUwet5k8C+F+vD9y+VO8P9FQsc51wNU+5neXGT0XOso4GtnJPx8JTPk8Mv39G2QH+/eQTZfFrl+LjOH42OZ9hyAef1an7pxMnU0GFiLBO59Gotmf5fB7p6ZgLwJqjCH8OhL9e3IpPRhWps5OQjY82SFqKuwhuBcpuRqYiQSi82P6YyCyw/lYJOJzIQ/brchu8G94NB1xGnqEQFA4r4DnxCkRZMf8RmSqtpDRwkU5Pu9sjE91AMp3ObJz/kUkFI1VDjDPoJeG5qtmpBFuMxL5i2k3nnbQkcg0BVuDxMo7gBKJjZZvRDMBeIDCvNN6Il43XVzSer1PRqYt43G2T+jCAhsBK+m+hRIUirWXrNw0Op1dTrcaibc2IUBlvBIJQ/NRAd/FK0OzN7JhNJylw/2AMZB2yTeLVF2Ejo0nhmYvdvfesMu+Zujnhjvm2UUsJyd5t5iRh5vxqm435aoEhz0sXrcKCf2Sj59j7QTWVAPpZiesCvH2mhTAcl6DTKPN8SDtQgzNVezuTt3WIDyNhOSxyiVkD76ZzomzZs0vD8ohbIUYmi7IoVxu7Is50WKh5WPPIpaT07zrkLUUNw6Gewbv134U+7xh4ZoNyJn1VmJZvWw6OHGL+Te49D1SI6QvBLisNyDrS28HwNAcYOGaLsiU3xAL156ETJmFLP5WnUrh4QhnEf847uxmTnENcra4E1YXsZzcyHsp4o3iZGH1Q1OOcZSgkc+9vM50uj60kebjwGUWrlsGvOfCdyhDXOWPd7ls6jwo783GGL7uYprdC7hnq8XremFt8+73sD4D9DbWPeoCZ2juxRuPsd/hbL73gSKWk1t5v2V6qYW4Im9Czm+vQwkiL5F9zrwRmT79bwHp/ibPCDaJBMh06t6e8nA6tYTKvM6MEP9TREPzQ6xPcbo9qju7VH6otoZmKvB/HuVVaXpo/Qu8fzrezMvmYw7uLro9jf2pr1bEjXUJSpC5wTw/a9sYmdQGXiejpbszvB9HTuL8h0PdISTK8lds3vc84tJbTBrMCOzfLqRVyNTZm/i3Zy69Tn2plNqDdEPzVdxZS8lFP2Nsqgss3MOQmGp+nNewAlmQPQz39xHcanqqVvku3niuKe7zF8Q1/jAzihmKHGDmlMuMwdkCbEPW6j6P83A0IVMXv2nzvv+Y0Y9fvfnO5rvOR6ahlwLvINNHM3FnDbdQ9+b7kdM7/aDFzGyUlMdpah/NocB9+HMWwoGIO+A5BfQC6pENcVdT+lyGnLORb+PVPVl6s0pwiSGHdblJ0oyE3XYE+Tn2Y+S9ifP1Rrsd4ieREFde4mTD5q+RdZhpHupLmtHTC6X2QKQMzSP4GwzzLMTdN/8I6rBm2ilxZI71NbI7XrwCXK7ttuIRl5vRsh3eMZ2jeh91nuaDkXFqaEDCAvVCTvz0gmvN6KnkCJthc78i5D0dCT7YkalD5pcz7e5fisyZt6Ao7lNlGkY7zAO+yK4OKVY2czvtLZ7uU5m40au9zCNjcCvw01KtbGG8jTJrZWTT0VlF5iCkV+LOvhtFycQEoKuN6z9C9q5savO+lViAOxxqHe5TmfzZhTRS01vPuKjLj7iJnhua85EFNj/3ZsRNnv+nzzsgXkM3ID75683rp7VYFA+xEyx2CRJBeUOBowCnbUvYpzL5lUvptJjZCDf2+PwT/73aXKcMCTXxlD53RWc6JRS7SCl5rG4c/QTZV5dt0/LLFkYcTj2kluB9nMMluOuq3Ygcq5JrDRYL5XYm7WD6vEyfN5eYMUPLQCklliFhUXKFmlllPs91FsxU05B+PsvnryOL2E54AjjDw7JIIjvy3R411CHR319DTiC2a/j89Ozz1tDMnzRVHzlF8Rcrh3j5sVfsXNMIDs6i8RjybwqsQ/YMnYl4h40w7y9FTvF8GDnfyQkPIftUDvGgDLYi3ndPelTGaxEvvVexvtdnFeJl127WaHVEoyj+86DpQWdbe3gfd6N952rQPocccfBlJGrHKmRT9XRkvdAKCfOdHvRIZxyZhrrNGLVo2mchcjs1VJM5uvJyxJPrYazHKyuUJcbYvEb+Y1NyeaKWrqEZ9dqtgRCiIyufuOqqYOnpmFOOc4AfAT/J0sP200lmE+LheGVQCidL2Pst5D6kzRMNEyeOcivJecg02jNkjorfYurFFW52MoJyhEDpjGhmVhY3//a7cVQpDjchi89XIgvdjUjssB8Ci7V42iX/RaYpT0M2dY4HtgP/An6A/aOqS2dEU8A9XZAd7d9CjkjdYIbaP0aOhu3YtF+DGEJO9fy2/u6uUI1ETE6avwQyRZTQonHEPsZYH2PK91dIWJigHK3RiETJLoWDC7+JbEAdbUa+T5myXG83IbuG5mTgj+waqmFPI+ZiYDZwgY89sj2Rk0ArkXnaKvOXel1ptKa/rmxzTRVyBvd7wJ3I/pXt+rzuxm/bTF2kfvcTkc1/urnUOocjYZ/Sp1CqkMC2ZyF7zK5AQhAp1jkN2dyY3tu7ARiFxFbc4VZGqSm1Yk9NuTi115Y7TR1M0Q85+fN4YCI215DsGJqjkIWzbDHRypGFupcR7xAvF7MipuE7H/cCgR4E/N00mBfizt6iEOLZc4Xpae1AFgSnYf9skqh5YHoCnwKLfOylTSb7/PgQJDDj17Wds8SBpm51yVG3xyBz+UfhfZTersjR4HYX2TtlaQuWIlGmH0GiTPvFOPP8VmQxQM8iUY/9iNE2wjyrDUgAUjunn1aZ9uJMk0YYcSZ4xDxnfpxHdVgbI5POIKPjTDsJWt1xOwHZvW4l8GZ/86N28bAgrjYjJy+iTfcCHjOF7dTI3IdEqh5rHuIa02i/bvRboQb4mTGAc5C9D/ONsbkO66fxOeGcPJ+fTu5z05Wd0zr/tPhsVJtrx3ioJ2Ke1QtN47hX2t8QMwOQ7S9bWzAUOdtmKd7ufWnLLXnq4FHI4XQ9PNTQ34xCFyDTys+b5/S7Fu/vaTqgtwD7me8TZed04DvAHj6UZb4D1U7B5hHSVgzNGGNk7JwhM8ZU4GqPHg6vPWQipnF32jh/M8dI8l5knSsX5UhI8KsyNE69ERfUe32oeIMs9MJ6qR3JW4bP2yynHuY56u+Rpq/gzd6UVKP5EOJp5TVVFvM50MwoeFGePUzaR7R5vxa4A1krytcxvhnYN8fnQ43B8ZoBFmZXbJVhPkMz2FT0QhqRQ5EjkN3uce9jGlk/pjic9B7yGZEQcoZFrgOTTgUOzpPOuRYqhlNCLtSljkxvMxItpIHrj0xHe2HIvT62OYwcVOg1lTbamX2AWbgfqPN6Mm98TXEpcrZUrufkIAv5HBSQOl1utyJko5fpTTux/ieZxtTNKa4ePhbmjx0aRCsN+C/JfubMEItpDEIJKl2MkRnmII29zaxCJ5e1DfXh++9rsR47YQty0qad0eVMZHrKLawcZXAhEiE6m1GMWUijWyk+BOEcD8cLDh+OFBfh7hHRW30sHyfHGFhdAAwBvyDzdGCTxTRqUYJINbJHwo11lgmIR6SbBxT6FRH4Uh/yOANxkLFKHyQszOEu5W+1Q/41xGkhmsVg5qN7ezE01aZCj3Mxn6mIa5wbzMe/0/2cjMRetHn9DHY/otpqQL1qlKBRjgSDdHMN5CjgT7g3Hb3Ip7I414c8PkEceN61cU9n0xH4kgv52/GyPZPMpxpbMTRd8McByFNDE0XWVQ7zIK+7yO/NYIUY8DufysdJ5NRbsO+K+FNjlFNY3c+jhiZYRJD9HF4shJ9tniU3eMyn8vBrF/M6JBjlf2zcU4V4iH3NYd52t0OcbO6psmlooASnz8Jteu9/RNZVvHr4/mR6ZU6ZhvinB9nQLEWm3pps3ncLO0/Ts7oPoUbb9sAQQhZ9vXTtvQR3vI8eR6aPvGaLj+W/DdlC8A8b95QBfyH7WqkVfoz9vYPHsatH76b2amjSN2z+EtmZ7PV0wuOm1/Geg3TqETfCVMTZHcYo1JmGvRHx5jrZhUrrhOcQn/MnbI46ppvfZpbF62td+F0OMRX4NRsVPt8Q/3dI5ICtSBj2nwBr2rmhuR3ZSOw1NyJ7q37jII2EeUamI8c0p/ah1LEzFE4lEoLECZsd3LsvEnVkLPacIexGPUmtldZQ2JryRuTsHrvehUcD/0aiU/s1ooki3qw9gTfMSNApnZGtFieZ+vOPdOOb+jF+SG43WzfpYgr2UPKfdZGLFjM9kYkfuWBkwJ1QNM+bwn/aprG5EXEtt4KTqbNzkfDrvdKM68kOe7rVpqJNSpueuMT08k/EflSEUuE6dl9n85K7TKfgYYedqcty/I5PFtHQnGdGh34G//0JslH2/QLuXcjO6CiDbdw30bQTj/hgaL6C7Ozvl9bGnWmjrcnWUX2CnbNVVYiH3anGgP43bH7MG31+IHshi3Be7A24HplacwO3Trd7yRS43fSO99jQTEeiF/Rq0zN5Eti/wDQjyDrfpCy/+zNA33ZoZM7D/6O4I8BfcWc6ui01pvE5xoW0Cpk6G10EIwOynODEcWk54slmtxM9AevbKQo1NNcgZwb1S3uvkzFwBzuog/dnqYM9U8972DTMxWAYEqrCTaYi4dfdws1jVF9F5o4bPGoU7HIMO9eCMo06n8O+e3sI2QF9Up5ORrHqnJcU6zuVA4+aDoKbsw7P457rbyGG5iKKd4zJN3G2Z2mFKbuPCpgJsEIhLs4HI+u/2fJ9jsLc8O8i93pkL+AHYazvfv8IcS3Oh52T1I50sXJcnaMgnUwruMlMY2zcds8uZI0m3znuvcwUgJ355pvJHxEBvN+RXgysPkersLb29nNkethqD3e8S9+juxmBu+mWXYih2aeIv2UFzjdBf4qsI8/1QF8hI5qryb1Bv5DOpdVtKyeHkcUgKw/HsViba/2NDWPjVkM+BXENdhsvjguYZYyNm1FYC5k6O9TCNQOQ9TQrPahL2NU1OxedaX9YeY42IJ5GKyxc+zLiymw1QrcbI+XeJt8DXC6bQgzNpiL/nm7kvx6ZUnrXZW3dPHre+yFLGr0tPu9WO/a9w4iXTL6H4yjsue5dh4Txz8cTLhT6Fab3ZwerD2+jR5X4ddPguGVsCjE0Vr2/Rpk/K70bq7THc1byPXR1iCPEhzbSfJzsC/XpLMOZF2dqRPYq7m7UdmJonijib/km7nhipQzWUbi7HaMQQ7PW4nXDkDiPVgyNVf4RRuZib87xcEzG/kFmScSL7ekc12zE+eLpZUhkVDvUYX0+vdHDyjzbjBK3upBWIWs004v0EC/B+hEJpcRLOcq0ETkTpRBvu9+QfS0t9ax9F2fhZAYaI2N3usrq81HI6OARZCG5GHzf5fTqgC8iWweKZWhuxr+QQ+ksBS5Pzdldj3jNpJ+SuA3ZA/JOgRnEzdD/tSyjpBNtWNlsFvUX2AsTU4csgltdpHM6tRdBDgSbgUwnXofENLsI2czZz7zvtAIUskZzH+5551llg+m4tNfTOG8A/q9NvW5E3EdfdjhaujvLM3YF9jYntmUIspPebjTj/2F902ghI5qkMc434e802mbTCXSbejOL8aILaRViaB5Fjhvx+3k/Dlid7tXxR8RN7VDkZL1ZOD8LvhGJI/R7Y1i24M7GvQvMg2fXyBxnHpBzLN7jZI0mjIT4ONmHH7RQ9+YbkUV/P4IepkbHS2jf/AVx705tiHvTYYcqffS+DXG2iCCOJTfh7ATO4abhs3vMxCzzPFsdmRY6ao8BPzAdoj7YC2VzpBkNRm3csx3nRz53ZvcNsFvTOpNuhOMp1L35DvO8f9+H5yDV9i+B3d0HW3A/JEUdsoPfLQ4yFciOkalH9qTMtjkCcDJ19nWfjIwTQ5NqwLribVSIFtM7fYeOQczFaZL0Hv515J5Gs0NPJEK7XSPzimlAttto8JyGoIkjXlxWOcN0RO0YmU3IXjcnhjuMxC87wuP65eSolOvM836Jx8/7yellWYqHVV2PPf/6BmNk3iigYXZiaM7zsUycxDpLGq1Pe6QtbtJ/GSVI/ABZm7HDv81IJjXSt7qfw89YZ99GNiXaOVr8E2R3/lsO8z7NByPjZEST3rl80CNtqfbkxbYWuNSws/em0fRSZhU4AnCyRrOfj2VS5UIP5GwPeuGpSn2/tuuB4xSb1z+NbMRN73wFzdDcaEYydsLofwB8HljgQv6n+/Q9dzi8P46sJb7ggbZrMz3vpWhorM5xNpqRzEwHIwAnazRVPpbJHBfSSM2pznNR1604C/qoeEc/G9c+ikx/txTQs64HWj3+LqmI2XYjWs9CYpOtdknHCJ9+u/tcSKPFdDbecvl5z7ifsRQNjZWGsNH0vv7j0Ag4MTQrfSwTt85lr0MWMd1YsP8d7q0nKO5jdc3jfsRDMlOUAiuGxg+PscsRT067I7RjXR5thXz67e52KZ1UZ9yNzuX9uZ73UjQ0v87zeZOx1C/luMbK5rbN2Ntc15YXfSqPjTiLvNqWDeYBXOUgjaeRxcYkSlCxcujZH5AplmwbnK0cK+3HtJndEzL/gKynNLmsww+Pyg+Aj11Mb7MxNssdpPFPZF0m6ZahsdJwJHwYNv4xxzD9FPLPPf6N3HsPms0D5sQZ4Kd4u+ET0wCcj/uBOpebyldIb/QN7IVOUYrD9DwN1m+QUO+5fkcr0y7/8+G71Nn83hd6VD+9jmaQwJu9MKkQY4Xsb3sL2SeWMy6fXUOTL0ZTE95vxkuaxvUbSCiXTUbXn5AF+OctNtCnGGPyH2Og4ubBuxeJYup0V/Ji0+Bu9qgc3jaVwytvsXnYP9pgnjFQjSi5WOnCs+aUTchRDq9m6KxdieytytexvN70sLOxDH+OILHSwCeQKbYbPBxpP4Q3mz1TMxdnWmzfCh2NfcGm0V5iRpN5n3e7YbjvJ/d+i8dw7hFh1dj81fw56R38xfx5xdPIPoXhyL6FSmR9qFva667m39TrSsQrLv11F/N5Ajnk6gfY21dQKG8ha13PWpgmWWWMTB1KPh4Evpejo/c+7jpl5PrNjjT1c7QZGb9pY4S8EdnXdoVpBEchHl9LTFvwM9wJsZSPBxC35mwRp1tMx/QhH2YYjkcOEjyMXffxhMwznY1OWZ6xpUhkiEdwP5p8W+aa5/1f5PfMTdUdSwMLu4bmX8gi74VZpluu7LBNx8ysznCNuOMVZl3HYc1upvgScirffWRe/I2ZxukCnK3r7MpVVwXr950xw83U5iCnwP4kw2dbzUjbTxaZv0JoQryNbi3irxNHNmlmOlOlHjmW4iWftGzBvmNCoFoyxMPw76aDm+l5fxuZVbL8vBdysNDFSNjrS4CRxqI9ZR6cjZ59fXcbT8UeTyI7wr9qfn//fvf2y03I0b9XImfJNJppkR9iP4itIiP8CWZ09Q1gr7R26n0tHls8i5xDdZYZKY5GplqfMbMptiNbF2JoUmeJJNv0KIo1YvAH7w3dMchRq4cg6zo34O20nl3qEI+/Xwf8IQmZEfe3kWjEG5Bw+z8OoEF8BOvnxLvCxImjaMf4Prpqx+XZgMSodOUUZLuG5mTE4yt9CmVPZPf3xchC2AXaI7PNT4xhSdEJ+DMSWdfdxdTUFFD7Ndy/bTN1kaqfJ5oer6vOKu284VZKnKDUTzuG5ihkITrbonA5sgD2sumVr/JB/56mMU5fVK80hjD9db5F+Bpkb82diNtzg4+/wTfbGJl0piEB9K7A2z0pIeBck88+iEPHayZ/u2eoRJFF4Z5mOmMR/rk6Tyb7/PgQ5IC8r2vzo42jEkxDM8E0wFY2aPVH5vgm4Z0HUgj4pZkecWvT6UHIAthGMyp7yofyL0c8VHJxGRJT6lxkIc6LsrzPGLx0YzEZmc67xOLwucYYpgvYdRFxPXJu0G0+GJx8xz+cbvTt0EdfUfzDSiM9xhgZO6HoxxhjU+2R7suREzy9iGzQE3HNPMyH8j8Ya+dzfxVZZ/Aifto5bYxM247IvcgZKPkM5gvIZrK2niq9kU1y9/pQnoPyfF6FnMehKEqADM1gYzAKeTgPRfzbIy5rDgFXe1wuEWQPgNfYCe9/IhKmvavLGr5lobx/bQx7Nk41RjMX52L/7JNC6oYbnStFUXwyNL1ML7W/g/RPMo2Um8HmhjrUZJUDgT08zmM29qYXJyFuxn1c1GDlnPjUVOXlWT4fYjGNQfrIKYoamhRdjJEZ5kIeFwE3u6i5t4/l82OP099sjLGdHb/jkfDmg13SYNXxIYSstWTalGs1OGGtPnKKooYGZF3laWCci/lMxb2jQ/3cC3GWD3nMRDz61tu4ZxgS5220C/nbjTI9g92nLq3GNqvWR05R1NBEkXUVLxbC70KCTDplCf6ccZHqxfvBO6bMP7FxTz9jpA52mPct2PcO/KnpPKSwem6PGhpF6eCGJoRsxjzJo7wiSITloxymk0A25fmBn1GIFyJrMB/ZuKe7GZEc4yDfpWbkZvdsjlvYedCR1am/Gn3kFKXjkb6P5pfkjszsBuWIm+6RWDt8LBs3mxHApAAbmsmmPIcAFTbui9rMpxMSg+iryJG7hfAccmzCEzZHHdNNHZpl8fpaF+rPIcjG29dcGtl2QQLFnogEtHwSidSwRpsHRXHX0PyQ3O6rbtIFcdM9lMJPpGtEjhz+MuIyu8O8V4ccWrYdWRM6zaHWQsJyh9g9DIrXlJvR4gsUvkn2eTOafdqmsbkR6yd8Opk6OxfZ9Nkr7bc5md3PU7FDNbJHLNVhqTL15gxjeP6rTYSiuGNozsOfw4nS6YUcOXAohceeiiE7+TPxfReMDFhfe0jnWxQnTHgnZArsHgdpvIQcdvZPm0bheI8NzXR2P4+8sxl9HIVE6bVLBFmPnJSlfj4DjAXWajOhKM4II6fkFYNhuBQZtA3fwz136kKmzr5VxN/z2y6k8Soy7edFvLdC1miOyWBk0kfHz2HfDT8E/Irc65G9ivhsKEq7MzRWNyV+BMy3cJ2dEN1Huvx9pgC3u5heIYZmRBF/z5EupTPTGJt6l/UVskYz1cLo+GXsbeK92WKH4FRtIhTFHUPzhoXrViHn02+2cO1vbBgbN48mvQKJzusmhegr5pknbobAn2WMjZuBUQuZOjvEwjUDkHW/7hauvcSC8UrRWZsIRXHH0OQbAWxA5sHthP2/DmsuyE+49D2+A9zhQfkUskbzdBF/zyddTu914DgXjU0hhsaq99co8+d0hJTOK9pEKIo7huZ5sq9p1Jlerd2DzJKm8X86T89/ugvf4RLENTtkU58VCpk6+xHwcRF+yyYkTL/bzDaj2a0upFXIGs30Ij0bS5AjBRRFcUjKvfl682C1dR89Bdm1XghxJBLAc+zu2bMB+BLOPXouBO62aWTqTONlZS2nEEOzATm/ZwbiJuvXUZazKXzaLoIcFzAe8ebbhriJN6S9vhXZpOkkWkIhazT3IVNj03x8LjaYDtYGbSIUxT1DAxIV4H7E5bgrMkfvdL2h0RiU3yP7Erbg3oa48xBXXrtGZjLW5vJTxrYQ1iMnOV6ARFq2c5LpZcB3beb3CYW7VIeR83dO9qG+FerefKPpAF3qg8ZUHVmizYOiuG9oAFpwtgEu24P7ZZfT/Bqym9uOkalH9nu8ifWYa9sd6twBrLB4bcgYYLtG5gNkHWV1gRq/7pORcWJoUga4K95Gr2hB9l+9o02DonhnaEqB/YE/YO8Aq+3GyLxhs8HzK9ZZxIzOzrd53yxkL8gWhyNDv3AS6yxptNbiTTy+uEn/ZW0WFMVdSvG0weuQkCtWaTRGZlYBPWs/DE0VEv/NrpF5Glmk3+Iw//18/O2cHkXdYkajr3mg7TJk6lhRFDU0tgJpNiJrQzPbvN/J4v3bPP4uXdgZY8wOf0CmeJpc0FDl4283x4U0Uut+81zUdSuy/0tRFDU0toxEI+I1l2kvhNWNeNs9/i73AhNt3jMd8baLu6RhpY+/3QyX0qlDgqq6sWD/O7KHuFEUpYMamrkWrmk2Pf4XsnxudW3Ka0PzRRvXJoDLgRuwvg/ICi/69LttxHqUZytsQKYOVzlI42lkH1ZSmwJFCY6hsfJAJjzWfFeez1uQGFX/znGNlbNwNgMfevxdrE59tSD7XO7yQMNP8X4tKo6sQbkdqHM5sv5WyLk0byDrPXFtBhQlWIYmn6tuE95vcnsAme7IRIMxMs/lSeNhcoe/aQb+z4cG2EoInpRb9kMeaVhsGtzNHqX/thl5eBWaZx5ytEGjzXuOx98TVBWlw2LXvfl+cu9jeAzZO+I1FyFuqJcAo02D8Qqyc32BxR72Gch+nHMRl+lOyHrF86aX78eGvelGR68sn68zjajX+zqeRnbfDwd6ItEMqpCTLFOvu5p/U68rEe+99NddzOcJY8x/AHzqQzm+hThUPEt+j8RVxsjU6eOvKME0NP8yo4kLs0xjXOm6wplZI7g8aP4KJQH8xfxZ03FYc/bPnypo0/pqTr47ddBYW2OzDPgiT11q3+AdVlB5NOKOV1ixeAn4ChKypluGz2PIZt0LcLauo3jMxRdfHBgt99xzj/4gRTA0ABcjJxpegpx/sgF4CgkmuVGL1CZPXfo/Tr57HHIq6KlAD9Mz/w5PXaqnO9rjSTOy/aqpp57Xz1JpFLXxVkrF0NQg0zhHIsEX+yLOAT2R6Z8DTI/4FdNDbyjSd2qrcwgypQMyXbI8cDqfurStzkmm0fROZ67RWWlTB/za/BWDPZCp3QPwbo9SEzKdei+FxwwsFZ19kaC/JyKH25UhzjG5PEIbzAg2E0l2j0QeQyKuP4Ksm6oXYhEMzTDgWmTBONselt7mb4LpSW5HFu1vw8Jax/xJU934Lp7rdIlS0VlcZswoRdWnIFOxtT7k9SXgKiRW3VPtVOcYxP2+d5v3y8m9FtetAJ0HA2eZTt2ZqKOIq+TyOqtEdkx/iMxrd7KRbidzz4emcfQyVL7qVILAvsiaYa2PedYi3oj7tkOd5WZ00dvn3/EE3NtYrOQxNEORhdNrsRdXLFNlucakNcwD/apTCQo/ACqKkG+Fybu96TzJPDfF4EJkmk7x0NDsjxzhO97FfMYjQS33dzFN1emuTsUZRxUx7yPboc4Di6gzQqG+m0pG2q7RDEM2O/byIK8+Ju1Dcb7OoDrd1ak4p6edi+NlYbb0q6KuTyVNtVGSYQgloKo+Rpd1zXT7tIlIq+UgG7280llR1srofqsZ0WctvWrqiYQTxBNhNjTUsnBdXz78dE92tJZ5odPW1F6nUIgxkQj7lpWxRzhMp1CIeDJJXTLJikSCD1pbmR+P2wlb0kWrtDeGpgp41KNGMb2iPYYsvBUaeVh1uqtT8ZGWqggrxnRl3dBaEpHdz+3bQhWfjuhMOJ6kz9J6Bs7bSnmT/1FyOlc1ccK+7/P5oUuIRjLnf8TwBcTiEV5fOox/fjCObU1VvuvsFApxXHk5R0ajRNt+GArRExgaiXBkNMrmZJJnW1qYFYupW5nPpE+dTQPG+ZDnWJyd/6463dWp+MSGwZ14++T+rBneOaORSScRCbFmeGfePrk/GwZ38lXngYOWc9NJj3PE8IVZjUyKaCTOEcMXctNJj3PgoOW+6hwdiXBjdTXHZjIyGegeCvG1igqmVFXRORTSClkEQzMUmOJjvlMobDFbdbqrU/GJT8Z1Y8HE3sTL7IUXjJeFWTCxN5+M6+aLzi+NncP5E2dSUdZq676KslbOnziTk8bO8ccYlpXxnaoqagswGCMiEa6tqqKbGhvfDc1UsNQpcIuoydMuqtNdnYoPrN6nCyvGdHWUxooxXVm9j7fLBl8YOZ8Tx7xPoc1vCDhhzPt8YeR8N+RkXfjZOxLhm5WVjs446RkOc1lVVS4XUJ1dc9nQ1CKbB/3mLOwt+KlOd3UqPrC9WznL93NnNLJ8v25s71buic7+3TZz6n7uxG49db93GNDNcTDwjPOFFaEQ51VWFhQ7qy17hsOcWpHV03ub1l53Dc3x2Ns86BadTN5WUZ3u6lR8YNkB3UmG3ZmiSYZDLDuguyc6v7z/25SF3TlKqiyc4Iz93/ZE59HRKN1dnPI6IhqldzisFdUHQ3N0EfM/2qNrVadSdBq6l7O1r7ueWFv7VtHQ3d1RzYBumxnZd42raY7su8aNUc1ujdWR0Wjg01Qyl/PYIuY/1qNrVadSdDYMqimJdA8c7I23mNvpDotEPPEW26+sTCurD4ZmaBHzH+rRtapTKTp1fSpLIt29e6/zRKfb6Q6NRDzR2S0Uood6oHluaDoXMf/OHl2rOpWi01xbVhLp9q71Zt3b7XR7e2gMdJ3Ge0OjKIoHxMq96YHHKtxNt1N5iyc6O1U4OtV9t8WtMg8NTYa0m7UGu2toiunGt82ja1WnUnQicW+2YkRa3U23Je6NQWxpdTTy2s3jwctAPK3J3cp0h9Zgdw3N0iLmv9Sja1WnUnQqtreWRLqbt3vjje92uhsTCc9+q01J3Z/ptaGZW8T853p0repUik7N5h0lke6KzT080el2usvj3oxp6pNJNnhoxBQxNC8VMf+XPLpWdSpFp8dKb04D7rHK3XTnrBroic73Vw1wNb2F8TjbPRh5zGlt1XgzPhiaZ5Ez6f2m0eRtFdXprk7Fa0OzqtH1EP/lTXHXDdjcVQPY2lTtappbm6p532UD1grMisVcTTMJvOpymkpmQ1OPnCHuNw+YvC2PcFWnqzoVjwklkgx6f4uraQ56fwuhhLv979ZEmGfmunuixTNzx9GacN+p9d+xGPUujmr+29rKKp0288XQANwK+GnWY8BtBdynOt3VqXhM3yX1dPvUnTPpun3aRN+l3vQlZi0Zzodr+rmS1odr+jFr6d5Ok8kYIHZ7Mslfd+xwZaprUzLJQzuyrnepB6cHhmYJcIeP+d4JLC7gPtXprk7FB0a+tp5OW5ztVem0pYWRr633LHh9Evjda4ezaquzSNOrtnbjd68dTjLpeM9L1uHQ+62tPObQ2NQnk/yqqSnXmo8u23hgaEBOafTDa2kuzk+uVJ3u6VQ8piyWYOwLa+i6rrA9gF3XNTP2hTWUxbyd4mmKlfPzF77IwnV9C7p/4bq+/PyFL9IUK/e8TF+IxfhTczOFmO9PEwlub2riU50yK4qhaQJOBzZ4mN8Gk4eT1UzV6a5OxQ9j05Jg3xfXsNc7mylrSVi+Z693NrPvi2ss3+OU7S0V3PnSsTzyzoE0tlgzGI0t5TzyzoHc+dKxbG+p8K1MZ7e2cmNjI/+z6DXWnEzyj5YWbm5sZL0aGX/rf5v/LwGOQ7yX+ric1zrkvJQlLqSlOt3VqTinGcgZ7TKUhD0/qqPvknrW7VXDpv7V1PesIB7d2d+LxBLUbtxBj1WN9FnWQMTaKKbZTZ2JZIgXF4xi1tK9OXjIUsYPWMGQHhupjO5cdmyORVm+qSdzVg5k9vKhNMeibuu0tEayMZHg983NPB0Os19ZGaMjEXqGQnQxscu2JhKsTCT4MB7n7dZWmqw7EmzXKu2doQF4F5gIPIZ7Yefnmp63m42i6lQjEyTmAAdbuTASS9Bv4Tb6LZS2NFYZIV4WItKaJNocLzRv13U2x6K8umgkry4aCUBtZTMVZTF2tEapb670Wucb2DjIb30iwb9bWvi3O79lE7BQq7R7hHP0xCcAt+PMeypm0pjgUaOoOpWgcG+hN0ab41Q2tBZqZOzmXbDO+uZKNjbUFmpk7OZ9D7C5SL/lfeh0tC+GJjXMvRYYDfzeZsE3AX8w916Lt5FQVWdbrrpKa7b//Am4vwj53m/ybm86NwKnAVt91vkOMFWrs7tYCa+6GLgQmAKcCBwJjAeGAF3NNVuB5WZo/ArwDNDghsBRoWlWL10MXDg/Oc2WzlGhaZZ1znenzItanopnJIFvAP8Fvmt+Ty9ZjrjQ3409V9xg69y1k/QfYIx5Vo5G9tZUA7k8DroChfhWrzYjmVutdAJnzZofmIo3ceKodmFo2lbS9L9ElveLhjEcD1Kc3fl2SNc5wlTwY035zQKuBpZp+11SJIBfmr8eQJe2F8Sj4fDy/bqNbexafmhrNDwyGQ7tmQzJdaEkdaFEcnVZLLGgemvszSHvbX4/EsvoHlUHbPJSZ2U0Fj51/Dtj9+y69dDKaGxkWTixZziU7AKQSIbqWhPh1c2x6II1dV3ffOy9A95vjkW90AmwCsg6RL+npiYMHGgM0ThgEJDaDLQF+AR4H3j5rqam9z6IxzPF2on50JGzrNN0AtqVW5wVQzPMTNecDWSL+93b/E0ALkY8Nh5AdqsXey3hOGTaqRm4FHguYL/B54Dn0yodwKnAJOAY7C2gKsFhU3oj+9rXhnQz9e9CIFcQsPHACXW9K1kzvHYF8Dvg7kl/W77FD533fPXPtnTu3Xsdh+298DOdF9//f1v8KNx7amqs6pwAnAlwWVXVTp0NDVt8qge2dQKf6TRGqOQJ7TPzlmyfVSIbAaeQ4RAii7Qgu9Z/RI51hfmTsk+JjnrtViffr4cZFaSOON5mpgoKWmTMpbPAdZHPAS+wc8qsLRsLNjYzZmhT78cIOn/9DAHfBm7K8TvnYyvwA+DXuXq6OevnzMrA6OSwZifPkX86czxDFqbOfNNZClNn2ZwBhgJvmpGMk22+5cA1Jq1hRfh+J6UZGczrEwM0knkhTyXsaa4Zr016SVIDPAH8ykFjg7n3LuBxk6bqVJ0lRSZDsz/wusuN23hk3WF/H79b1Bi5tlxOYYuFfhsZNTalzWDTwTrZxTRPNmkOVp2qs5QNzTBkDaOPB3n1MWn7NbK5FBiZ4f0DgHNKxMiosSlNepnfa18P0t7XpN1LdarOUjQ0VcCjHn+RXsgO+SqPv1dPZF0oG9PJ7SIZJCOjxqa0iJg67mWHahgynVKmOlVnqRmaaYjbndeMxftowz/O05gPAr5TQkZGjU3pcC3iMeg1E8k8Naw6VWdgDc1QxLvML6Z4aPn3RVwJ83E90L2EjIwam+DT39Qrv7je5Kk6VWdJGJqpyOK5X0TxLszDnRaHlt2AG0rMyKixCTZXIzvX/aLa5Kk6VWfgDU0tshnTb84iy3GtDjgF2XlrlW/jrSeHF0ZGjU0wqQTOLUK+52JvzVN1dkydRTc0x5N9x7+XdMJGGHALVCCRje3ec3MJGhk1NsFjMrvu2fKLziZv1ak6A21oji5i/m7mfRmwd4EjqwNL0MiosQkWXyiR50h1dkydRTc0Y4uYv1t590FCNRRCqICRUC729tHIpBub54G9tL0vGsU09ONUp+oMuqEZWsT83cr7JofD1yNwLzTNz3w2Mil6IRGgleKwdxHzHq46VWfQDU3nIubvRt7jgfNcSOc23NkIVcyh9LHa3pd0XfYjb9XZMXUW3dCUOne69D1GuWSwikkcpSM+S2HVqTqD/nBsK2L+TvP+MnC4i3puxLkH3vNFLM8Xtb0v2brsV96qs2PqLLqhWVrE/J3kXYlMd7lJX5xvhLoa2FCEstxACYamaEcsL2Ley1Sn6gy6oZlbxPyd5H0l3px3frUxOE6M57E4P8LWrpE5EjkOVim9uuxn3qqzY+osuqF5qYj5F5r3HsD3PdJUg0yhOWEO4hTgh7FJGZkPta0vKi8XMe9XVKfqDLqheRbYXoS8G03ehXAL3p44dx6wTwkYGzUyweEfQFMR8m0GnlGdqjPohqYeeLAIeT9g8rbL54BveKytDHf2pHhpbNTIBIttwMNFyPchoE51qs6gGxpMoxrzMd8YhS3kh4Bf4M9RzCfhjkebF8ZGjUwwuQVo9TG/1gI7RKqzY+osuqFZAtzhY753AosLuO8s4FAfdf7UJaPmprFRIxNcFgJ3+ZjfXcAC1ak6S8XQgJx66YcXw1wKP2Fzms/lcyBwpktpuWFs1MgEnxuA+T7kMx9n5ympzo6ps+iGpgk4HW/3gGwweTQWcO9eFCe2z624F6zSibFRI1MaNAIn+/AcnVzgc6Q6O7bOohsakCm044B1HuS1zqS9pMD77y1SGQ0G7nMxvUKMzXo1MiXFEuSsEC8anQ0m7SWqU3WWqqEBeBeYiLvTaHNNmu86SGNCEcvpEJfTs2Ns1gNHqZEpOd4BPg984GKaH5g031GdqrPUDU3KMk9Azmlx4o0WM2lMcMES/7eI5TTbgzStGBs1MqXNYlP3Z+DMK6kV+LlJa7HqVJ2lRq6w+M3AtcDvkRha5wDVFtNtAv6OuDC7VUAXAn82lj3kU/kkgdfx7kzwlLF5EejR5rN1yAl6rhqZiy++ODCV75577ukIxqYRCWt0DzAVOBvrZ703IfvNbvWhoVGdHVNn0Q1NunW+EJiCHA52JHIGzBB2HvC1FQkuNwcJi/AM0OCy1mXApHbYEM0BDjIjv6ONcXsOuA74WAcF7Wp0cz7wXeAEM1Idl+U5eh8JbfIs/kfoVZ0dU2fRDU3bHn76XyLL+0Vj/pMbaswPmm4Qu5iP69oYxH+OOqVXQzF0zjr1/Ew6Uz2eo5FoDZ/pnPjEHxqKVKS2ytODDkZ7IxWJ40HVqTo7CqF9Zt6S75phyBTa2Vg/q2W7GfrdhoW1mfmTpmb/8KqrrH4Xz3UyY4ZjnbNOPd+RzolP/MHaWlcWrTamzjwvzw4ydaYoHZ5cI5pKZIPkFKDcZrqdgAuQmGR3Aj9C1ny8IBA6Z516vi86Z516fl6dEyeOKvnyVBSl/ZDN62wo8Kbp0ZY7SL8ccSR40/SQ3UZ1dkydiqKUuKHZH/G0Gu9iPuOBWSZtt1CdHVOnoiglbmiGIR5PfTzIq49J240erursmDoVRSlxQ1MFPAr08jC/XsBjWPcnz4Tq7Jg6FUVpB4ZmGuLf7TVjcRaFWXV2TJ2KopS4oRmKeBn5xRQKm0pRnR1Tp6Io7cDQTAWiPuYbNXnaRXV2TJ2KopS4oalFNuX5zVkmb6uozo6pU1GUdmBojsf6zm836WTytorq7Jg6FUVpB4bm6CLmf7RH16rO9qNTUZR2YGjGFjH/sR5dqzrbj05FUdqBoRlaxPyHenSt6mw/OhVFaQeGpnMR8+/s0bWqs/3oVBSlHRgaRVEURfHU0BTzJLdtHl2rOtuPTkVR2oGhWVrE/Jd6dK3qbD86FUVpB4ZmbhHzn+vRtaqz/ehUFKUdGJqXipj/Sx5dqzrbj05FUdqBoXkWOevdbxpN3lZRnR1Tp6Io7cDQ1AMPFiHvB0zeVlGdHVOnoijtwNAA3ArEfMw3BtxWwH2qs2PqVBSlHRiaJcAdPuZ7J7C4gPtUZ8fUqShKOzA0IKcf+uENNBfnJ0Kqzo6nU1GUdmBomoDTgQ0e5rfB5NHoIA3V2TF1KorSDgwNyFTKccA6D/JaZ9Je4kJaqrNj6lQUpR0YGoB3gYm4O50y16T5rotpqs6OqVNRlHZgaFI93AnA7TjzSoqZNCZ41KNVnR1Tp6IoJURon5m35Ltmb+Aa4Byg2mK6TcDfEVdWS15G8ydNzfzBzEprOT51qTOdJ99tzRvqsObM7191laXbZ516viOdE5/4gzWdM2ZkfPviiy+2Wjc8/93vuecefQKVgp4j38jyHCn2KLNwzWLgQmAKcCJwJDAeGAJ0NddsBZYDc4BXgGeABl+/iRiKC3nqUns6T77bV53GUFw469Tzbemc+MQfGnyuG6XxuyveYLWDZ7UjpqihaVecfHdJyJz4xB9KpUQbkAgCD+rj0mEZCnwPmAz0BdYD/7YzY1EghwJTgdHARuBfyF6srS6lvwdwHXAS0AP4ELgBeEF/cv8NzTDgWnJPofQyfwcBFyFTKPcj8/R+bdBTnRbQ6SrFJieYTkZN2nv9gfNNHf4G8KgH+U5Cgq9Gzf/3Ms/DhcBpwFsO0z8GeDhtdI5J/1/A4cDr+tP7Y2gqgRuB7wLl5r1VSEDE2cBCYLN5vzswAjgYON5UxAtMJbwT+BHg1Zi6ves8AdjTR52KDUa9dmug9GRd6yyM4aYxztYhqjIdoI/MaMBNbkwzMun0A140z+9rBaZ9LPCk0d+WiOkInqS123tDMwx4DBhr/j8LuNkMlxNZ7nkD+CPiyfZFMySdiCwoH4ds2HPbAymfzu7AZaaHAvAf4K4A6gxKeSpKOt8nvyNIOXC9Gd24ybgcn9WYkcfxwEyb6X4BeCKLkUmxj/707pLJvXl/0xCOReZCv2aGsf/K0SimkzDXHmbu3WrSmmXSdot8Oochi9TTkIXsI83rOeazoOgMSnkqweeL5ndvMqPfv5hRuVcca6Pxdpu6PJ93Ms/FUTbSPBJ4yoLx3KRVzVtDMwx4DugDLAIOMEPjQkiaew8w00J9TNrDXBoh5NP5B2BAhnsHmM+CorOQ8lzksk4l+HwbmWb9PDIN2w34OvBfZGrVC/aweF0vD/J+0cI11cA/LBq6wxGvSCuu+s9rdfPO0FQhi3q9zJTMJGCZC3ksM73xJSbtx/IMW/NhRedgk2c2DkPcdIuhM4TsUdnHvM5HCBiFeN6ETRqTXNSpBJ9LgV9lmYHYA++OXggV8Tv/FGixaGyeMqO9XM/7sxaNzFZkel3xyNBMQ+ZF65A1gPUu5rPeVIStyLTPNAdpWdFppZc/tAg6RyELp4uA+UholiE50hgCvI0stH5g/kaZtCabtJ3qVILNd0zDl6vRP6Edfu/FwHlmJG/F2DxpnrO2TLJhZFqBr+JtgNkObWiGIhvzUhV7qYt5VCOLd8uQhXlMXoVM+VjVWWEhrYocIzAvdIaQRcgRadeNRxYzh2ZJYya7rsPsY0ZJITOi+Y5DnUqwuRz4pYWRRXU7/f73I1OGVoxNpTE2x6e9N9EYmU4W7o8jDg16zLiHhmYq4ko4i8LXENrSHXgE2Gb+/o3sHp9l8irED/P7HujMVsHd1jkMcRdtS39TLkPbGJlXybzQu0+aUXGqUwkuVyCu7Famr95qx+XwW+Bii8amwnTmvoSsZT3Lrvt/8hmZR7TaeWdoaoGzzf9vtviDWjEyLwBnIH7pIcSD5QkgFVztbJO3VbzQmY2kyQPgLJd0xnPcMyDN2Aw1r/vneTDa6rRbnkpw+S5y8qkVIxNH9py0Z36H7COz4qVZbkb9z1p8HuKIN+fDWu28NTTHm6HlajPqcMvIZHK9PRBYaf6qkRhaVjnB3OOWznz82+js1GY4XqjOZYhrdT5j8wqZveVSvMeuzg//LrA8Fe/oCQwke3T0XEyxYWSSprf/Ugco0/uQNZu4RWPT2aKR+QYaXskXQ3O0ef2MxR5DoUYmvRKk5kGPtJH2US7qtEIiTefRLuk8A4kGkMvY5DIyq4Azc+g8Uqt0UdkfeBNZTP4EWMPOdTQrXAn83Eb9vIBdXfXbO38GzrVobKwYmW8i0cYVHwxNarf6bB+MzErkMKw3zf/H2UjfLZ12eLNN3k51LgWOyGNschmZI8gcDaCQ8lTcZTQSEuXgtPd6Ix5j+bzGAK4GrMakTxmZ+zpgOf/VjEKcGJu4GR39Tautf4YmtQi9oM1nZWSONVSokakHvowcirXIvLeXDa3ZdBaKlTWeRW3ydkNnIcYmZWSW5tG5l1bponET2b2/voPsg8lmbL6H7Bux2khegIQn8ppkQMv674gbciHGJlV+f9Eq66+hSc1lpkI+9EHcBOuQEPF/IfeimhUjsw3Z95Hyjtli/u1sQ2tbnblYa+EaK/uEvNJpx9iszGNkCtWpuEu+UCjfBu7OYGyuQaJyW20kz/fJyIBM/VmhGPtOHkIcYOycBJtAoj//Saur/4amLY8CJ5veWTkS5uJ5oIsDI3M8/obdnpun8m8E3g9A+Sddvk4JNpcAv04zNlOxvqs/Nd3zZx/1Wg3F8mKRynMJsN3m85bQalgcQ7PNvO6C7DqfmOG6g5G4Wl1cMjLd0j63SrrOfMTIva/kWos9Ia90plyYB1hIbwCyp2Yvl3Uq7vKyxeu+hewNuY6drv5WjMy5+D/dcyv5j6NoYaeLvZ+MN+1PVxv3RBDniXO1uvpvaFJTMiPIvYM23dg4Hcnsbf61E0stXacV7jOjsfTpqVXmPauLqHu3ydsNnanNmANspJkyNkPz6FymVbpoXA80Wrz2ImC6DSPzf8giuN8sRDYyZhs1NCFrJR/4rGucaX96FHBvythcoFXWX0Mz17w+BJlOWm3B2DidLjvU/DvXhtZ0nVb5GzDINPojzGs7niZu6xxG9h3/VozNK1mMTSE6FXeZj+yhanQxzdQ+j/uL+L2eMKOHe5H1wphpI+4z7z/qs56xpv3p6SCNkPk+F2m19c/QpDZ7ncjOoHKNeYyNEyOT2iRqZ7oB08imdFrdCNcJ8fi5xfx9B2txj9rqfMklnY/kMTIryb/P5mGXylNxn1fNb+GGsYmb0XcQ9nksQTaGDkTWbVNHOS/yWce+yHqQG8cShJApzG9rtfXH0DxrhsZ7IpGL/2MayUIeFisL/8eaBrMR2dRolWfMPSmd+egPvAP8Ajlj/DTz+h2LI4p0nc+6oHMv0wPMZWRSB7TlMjb7s+t6TaHlqXjDfxAPy+0O0oibDt8DAflOIeTMl5+ZGYGfI5GS/TxGYLTpSFkxMklgh8Xv9SvsbapVCjQ09ewMwXBdWq/c7jSAVe+y682/D5i8rVKf9uBdZ+H635N5nWSE+QyfdUZy3LPKGJilpveYz9hEXNCpeMdMY2waCjQyZyPuu0FgD2M8XwCuMgZwCnK65evYW2sslFE2jcwUJLCmlfYrhETIvkKrrbeGBsS7JIZ4nH0tbRrAqrGxamS+avKIUdhhTZl0ZhvN5Br1fDHPA+KFziXI4momI3MEuzocLCH7PpuF7IwO4FSn4h2vmWfCjrFpNUYmKFGEOyGx9CZl+fwQYwC83L+1j8mjt8XrrzQzFy/YNDZ3mnsVDw3NEiSQH0i4jCE2jI1VIzPEDFMxP+riAvRm05kpr3wM8llnEpm++yjtuneR0/8yebUtRY6fndPGyJxm0trLBZ2K98ZmssWRZixgRgYkivSYPNcMQyIbeMEAY2T62DAyd6b9/2XTflmdxpyB7HVSPDI0IKc0zkX80p9P60HkMjapHf/5jExv0zPqavKY5kBzNp3prLSQzuoi6JyPzDUPN9MBnwOW50hjGbImsy8y5TfKpOGmTsVbZplnZJsFI/NowLSfbfG6r3iQdwiZ0u9r8fqr0zp36byKvWnMu9CYgZ4amibgdGRH/TAkKOS+aT/W8ey62z517PEbefLYFwn6uLe5/3SceeXk0pniY9ObzPXwLy+SzqQZfXyEtR3/SeQo50XIruYxJq1hLulUvOd18/xkCku0wzTojwVQt9VTW4d4kPcX2Om2n49ryB2Q1M7IMoIcXKh4ZGhSUz7HAetM5XkDWQcAWRAchoSnOdZ8ni+S8tdMGnuZNI8jc/Rhu+TSmeK8LCObley+M7iYOu3wNdNoDXFZp+KPsZmA7EupM9M5LyDrH48FVPMmi9dt8SDvYy1eNxVrAUlnmefFSqzEL2h19dbQgKwbTDRTMrWIO2O6F83T5gFpzJHmZHPPX00ac02a77qoPZfOsGmA90OmlV41f9PMe0sCpNPKb+SHTsV7UmtsXZEjho8F/hdgvcWMdWZlQ+Z12HOCecOisemiVdVdynL0xCcgR8ROMb2uScAKJDLAG2b6J9Xj6Y6sOxxiGsWB5v0YMm/6I/LHTCp0xJBP5wvsdN/ujuwRCqLOTOV5qNE5wCedipLOrchR5pU5rvEq1tlHeT6/Aeux4tKZDRxjjGjXLNdohA2XCe0zM+9vtTcyB3oO2c/baEsTsqP5Nix6Q82flCUG5sxKq9/FF50clqV9v+qqYOmcMUNrt1I4O5+7U81IulOWevkN0p0YDnPY/9n5HPVAYqi1dQZIkH9NxgrjgKfY3fs0DpxEapO2PkeejmjSWYyc4TDFjAaORHa4D0nrEWxFFtfnIJs9n6GwzWpOUJ2K4j6pWGffQ6ad+iKOQM+bjo9XYWg2Ia7/M8wz0oJMH9+GO6fsvo8451yBeNX2Mc/mT7EXckqxYWgms/Ps8fORXb9nmh+5GtkA9QQyBfVgEfWqTkXxn1SsM79ZbEYXXtGARNGerj+xt6Smzj5FQk2AnKrXD9jMznNOUryKrDO86rYQi1NnRddpceqs+Dp1yK+UItanoP1BnyNXDU3b/Rwhcu/xmGkaSMfRgrMamMzGpmg6Lc0973xIiqdTHwxFUQJGuMD7DkPmMV9DPDiCiupUFEUpUUOTYiKyKPg6slAYVFSnoihKiRqaFIciC96z2XkIVxBRnYqiKCVqaFJMAP4J/Bdx3Q0F9HurTkVRlBI1NCkOBP6BhNc4KcANpOpUFEUpUUOT4gBk9+07wCkBbiBVp6IoSokamhT7IRsU30PC2tcEtDxUp6IoSokamhTjkLhI64BLA1wuqlNRFMUHQxP3MN9qJAKxG6hOd3UqiqL4Zmi8DOIYY9ezvZ2gOt3VqSiK4iplPuc3F7gdOSNmfYDLRXUqiqKUmKF5Azmk6J/kjvlVbFSnoihKiRma55BT+v4T8HJQnYqiKCVkaBLA48jxru8F+LurTkVRlBIzNC3A3/D21D3VqSiK0gENzXbg98jpkSsD/F1Vp6IoSokZmi3A3cixxBsD/B1Vp6IoSokZmrXAz4HfAvUB/m6qU1EUJeCGZivQJe3/y4CfAn8CmgP0HVSnoihKgMkVGeAyZI2gHnGpHWF63UFrFFWnoihKiY5o/mH+go7qVBRFKdERjaIoiqKooVEURVHU0CiKoihqaBRFURRFDY2iKIqihkZRFEVRdiWU/E8Fo0LTPgX2MO+tnZ+ctofvSg7Lsp1kZmX6/3bRmfY6WDqfunRXnSffHRydiqIoRRrRXGAa7tXA+QHWqzoVRVFKcUTjwEg9D4SAY5BzU7we0ahOHdEEkilXrPUzu0OQI7yHAzOBKXf8ou+qYuls2B5mwIAYx03eSjwO8Xgo9VE34FFgLHLc+LkTJ47a4YXObdsijB7dxJFHb6OxMUzS3rmzruls2RGiulOCE760lepOCVp2hNws6oJ1Fhsn0ZvPAI42r78MPBTQ76g6lfZEGXAHMMH8/xRgA/DtYgmKhGFHc4jWVohEIB7/7KOngEnm9dmmE3V2AMtUdXqME2eAi7O8DhqqU2lP7JVmZFKGp6iNTUV5gk2byti4sYyqqs8G4kPTGsUUpwWwPFVngA1NH+DwtP8fZt4LGqpTaW/0zvBe16I2ImXQ3BxmyeJKQjtblJ4ZLo0HsDxVZ4ANzalABJgPLDCvTw3g91OdSqnRBTgPuBQYk+HzUIC0HgGcQhKqq+OsXFHBpo0RKisTIEeRt6XVSzGhUB6dmfFdZ97yDL5O3wzNmebfR4CHzesvB/D7qU6llKgBbgamAz8BbkMW/NNJBkTrr4FXgCeAuRUVyZ5btkRYtqySikr/JaYW/8Ph3DqzjAwCV54B1umboRmITO2AeEA8Yl4fDgwI0HdTnUqpMQlZ1O+LeBhNBs4NoM7jgEvS/j8GmBEOw7o1UVpjoVyjC08oiyTZVh8mFttlZJNRZ6mUZ0c3NNciUztzgA/N33vmvakB+m5tdX5QAjo/CLBOxXsOyfDeoQHUeUSG9yaEw5BIiNeZ34amsirBmk/LWbMmSk1NPDXCyaizVMqzIxuak4Bvmdc/Ar5o/m40733LXFNsMumkBHQSUJ2Ku0SyvF9u49piEsvw3g6QqatQEVaRysqguSnM4oVVhMPJlIasOkulPDuiobkQmdYJA38GnjY97qmIf/efzGePmGuLRTadlIBOAqhTcdfA7Ad8BTgggxHJtLhRrDWZPoj77OAMn8UtvuebzmSSwTU1cZYvq2Dt2ijV1Ymi6QyF5C9ZmuVZFENTARwPvAzca3pczyD7PA5B1hEON68vNp+Vm2tfNvdW+PA9rOhMEVSdbSmmTsUbJpvf9PfIsd4nBlTnocBi4DHz7wmloLO8InnCtvoIixdWEo0W32ciVHrl6d2I01T+84D+QNS838181jdtOB8DbjXTOnF2XT+4FnHLO8VMAU0FjjR/LUjcr1ZgS1paq4A/As/aeEid6sToCaJOfNapeDNiCZtRSCbX0+lAP/O6CvEqeyZgvdcw8CBQm9ZGPAp0B5qCrDOZ5NFoWbL7+g3RpuYdIVJrRr5WgDLYvj3M9u0hunZN0LIjUirl6bmheRhxq8zGZuBxxAtigXlvFPCltGtOMu/NB34I/B24ygwVuyOeVZk4Lu0HyEchOke30Zk+LA2Szmx4qVNxl1rgeuBgYDnwY/Nvih5IjKp0RiBurOt81noVEu5oBXA5u+7R6Mfu3o6VwEjESSXQOiPh5MhkkvcS8RChUBKfth19pjMSSV5eXx9p+eTjCgYMaAlaeRbV0PwWuNr8f7lp2NaZXtla4CPT4NUi88rDgYva/IIh4G4zxbPI/F2ILGbvY3ryIWSe8sfAEHPfvTa02tH5OaPzwjw1bUERddrBC52Ku0xBNlnWABOR3fqnszM4aqcs91X6rPNaM5JOsTc7Y+xBZoeE1Ggt8DqTEPHZIWE3nRXlyaM/Xl7JmLFNRKPJ8lgsFITyLLqhuQbxcLjONFiXmQdklRkRPG96XnvmSesIdnXTWw0sND2RF41Vv8nkkUQ2pv3AhlYrOkemTU3YIc5O12IvdTrFTZ2Ku1ycNpKNINOeg9JGNdmaPr8XE65r8/+jzEhrblody1b3VKcFndHy5NimpvDchoYwvXu3xrMYmnhHejhS88k3INGD64GDgHeRRfQPjZHYs4C09wReMmkcArxj0q43ed1g8yGzorOfw/LwWqdbuKFTcZd+ed4Lym9TleG9/gEsz5LVmUzSPxIRF+ukPpGfGZoUjyObhBYAvUzDvR9wCzCtgLSnmV7255CzE3qZEc4Ek1ehuK0zhV86neK2TsWf5ysoZNqf0aI63dcZCukDkO1B+Mj0lucA1ciZKFWIZ9R0G+nebO6pBh5A5qffRxZKP3JBdyad1QXoTO+V/N3onOODTie9Jy90Kt6QLBFNqrP96wxcj2srspN+PbIAd5l5/wbgLgtp/grxvsHcO8ykdaxJ2y3a6vyOTZ3pXG7SWG/S9ENnIXipU1EUxdeh/Xp2hkH5Ttp1cyyk+V5a2pea1zeaNN3GiU4CoJOA6VQURfHN0AD8BdlQNAA40Ly3j4U0U9ccaO5tMml5RaE6CYBOAqhTURTFN0PTAMw2rw8y/46ykOaoNvfMNml5RaE6CYBOAqhTURTFN0MD8LH5d2CGBnwJslP9NPO6raEZ2CYNL7GiMxupe5YXQacd/NSpKIrim6HZbv6NIJ5Og4CNyCL/aOQ0uCfM68vMZ4PMtZG0nrzXWNGZjUibNPzSaRc/dSqKovhmaIaaf9eYxvs2xOvpV+zq095i3tsbuN30vteYz/by4XtY1ZmJlM5hPuu0i586FUVRXKMsx2flyNGyAP9FAmZ+HwmzcQayZtDHfL7OXPMcO6Ml9zb/TkSiGMc8+g6F6mxIuweThp86U9QgwTCDolNRFMU3Q/N50wjWAW8gmwW/j+zl6JLlnjrgl8gu/TfM/7sYY/OKR99BdSqKopSooUkdzvM8srj+ADvdhj9FwqCkFqaHAMcgsZ1+YEYSZ5l7v2zS8qphVJ1KUAlleY2F93HpekUpCUPTF3GprUQW2K8G/sbu0UcjwNeAn5kG9C12TvecwM7Q+V414KpTCRrpoUiyRetNtPnN8z2jTsObRPO8V2bhvvJsn6fF94rabG981Zknn/aos6hkcwYYhITcB1kTqDQ96PHI+fbZzrj+s7nmFXPPYeazkSZNt1GdSlCoy/DehrTX29oYlZTRSPfKzHQA2uY2/88UEWKrDZ2ZjFlDG52ZSH8/li3dROKziMV1DhtGT3Xm+d3ao87ijmhmhd/d7c2Jif3T96G0IscJ3zor/K6Vg1FXT0zs/wVk/WFaWmGMmhV+95MMeTnRn1Fnhgc6o04go07gE5fLuVR0lhyzZs13dP/EiaPckvIAcEHa7/MWsLRNw/I0cDI7p7+eZedx3CDHaqxjp1PIduDJNvksM2lPSKtPD9jQ+ZAZKadYC/yvjXF8AZm6TfEBu54G+whyoF86fw2FksQTIRKJEKFQciGE5rLrqaIvBkFnm/8vRM64ae86AzmiWWJ6Uq8Ch84Kv3uzRSMjD3/43cSs8LvTgUNNGpvZdVOnW+yiE4kabeeU8AQS7Vl1Kk6ZbozCemAWcKUxAulch6yzrTdG5Zo2n8811yw0HYzfAfe3uaYVOc1zlknnSVOfrHIBsq9ss8nvKHYPdf8Vo3OzyWdym88/AM5BNiBvRE7XvSUUgkQilH4Gy5dMo7sZ+HebBrloOjPk1RF0FndEk8VQLEbOOP+MjRsX1SBrA0ea6Zwh7PSWqkMWsueYaZ5/9uw5vGFW+N3/mesd8+TmBzO9vYvOUChEMpm0pdMMc/PqPKX7Wa7pNNjSGQ6HGxKJhHs6n3wy62emHAmHwyQSiULKMy+nnHKKqxW5kPrp8rO0CnHUyMVHiCt7rg7FfebPK3aQO1IGZpT1RQsjuAcAGraHGTAgxtlf3UQ8DmknStabv4RpHLd7pXPbtgijRzdx5NHbaGwM09IS2k1nDlzT2bIjRHWnBCd8aSvVnRI0NYVtl6cXOp2O/G1yCLKfcjgwE5hSZuEBHgZcC6Gzy8urO0WjnYhGKwmHo4RCMiBKJhO9E4lY71iseUIstv3ilpbG7Rs3LnoAuK1nz+F+9byHAddWVFSe06NH7+q+ffegS5daKisriETCvPnmgow6IfkAssHTV53ZyvOQQ0YSjyd6Nzfv6F1XVz9h/fp1F69fv6axtTX2oOnl+Knz+2Vl0bN69uxd3bt3b7p160KnTtU0NcVYtmwd9fXbfSnPjz7aeeROeXk54XCY1tZWamtr2bhx0bBIJPL9aLT8rJ49U797Z6qrqygrk/rZ2pro3djY1LuubtuEtWvXXLxx4/rGLVuWPhiPx29Zu7b7kvr6esrKykgkErS07Nzfu88++xBAyoA70qbOTjHTM98ulqBIGHY0h2hthUgE4jtXHJ9i596xs82U4dkBLFPV6XH9LMthYCqBaaFQeEpVVbfyysquhMORLD3gCOFwhLKySqqqupJIxDs1N2+9oKlpyzc2blx0J/Cjnj2HN2e8+bDm3LJTn2fvgVcC02pqaq8cOHCv6MCB/ams3NVBI5lMEgqFcupMJhN3ImsnnurMV56RSJiysggVFVG6dKlh4MA9iMX2rV6x4tPzPv54ydfr67fd4UhnfiqBH1dVVX934MDB0UGD+lNdvetZbS0tccLhEOGwg/J0yIcfflgJTKuu7nTlgAGDo4MGDaCyspxQKLzbyYbl5WHKy2vp0qWWAQP2oLm5pfqTT1aet3Llx1+fPXv2HcCPxo0b10xpsFfaQ5x6sM8upqGpKE+waVMZGzeWMXhwC7FYBCQKxqQ2l54WwPJUnT7Uz7IsRmYo8GhFRe34Tp16EQ7bc24IhyNUV/egsrJL+fbtG67ZsaP+2I0bF33Zg9HN0HA4/NigQUPHDR8+jKqqCsc6zfTHEg8qScHlGY2WMXToQAYO7BddtGjpNR9/vGRyLBY7zQud4XD48X79BowdOXI4NTWdAlme77///tBQKPTYnnsOHDdy5AiqqysJh/Mf8RMKQSgUprq6khEjhjJgwJ7RBQsWXrN69Yovvv/++2eMGTOmFNa9emd4r2sxBYXLoHlbmCWLKxmy12cjwp4ZLo0HsDxVpw/1M5zByOwPvF5T03t8be0ethvFXRueMmpr96Cmpvd4YJZJ2y32j0ajb4wf/7lx48aNtm1kcukEXNXpVnlGo2WMHj2C/fc/aExlZeUbbuuMRqNvjho1Zuz48WNsGxm/ynPevHn7R6PRN0ePHjduzJjR1NRUWzIyu2sMU1NTzZgxoxk9ety4aDT6xrx58/YPwIPaBTgPOeRuTCZ7GaBG5QjgFJJQXR1n5YoKNm2MUFmZgMwxBlu9FBMK5dGZGd915i3PYOssqH6G2xiZYcBztbV79KmsdK+TVFnZldraPfoAz5k8nDIsGo3+e7/9Duo9cGA/T3TiTvBKT8pzjz16cdBBh/SqrKx83i2d0Wj0hX33HddryJBBlJWVBbI8Fy5cOCwajT6/777jew0e3J+KinLn0z4V5Qwe3J999x3fKxqNPr9w4cJiBi2tQTzIpgM/Qda6hre5Jijn0f8acax4AphbUZHsuWVLhGXLKqmo9F9iytMtQ59jF51ZRgaBK8+A6iy4fobTjEwV8GhNTe9eFRW1riusqKilpqZ3L+Axk1ehVIXD4cf23Xe/nv369fJUJxKPrGCdXpZn9+5dOOCAg3qUlZU94VRnOBx+bMSIUd3799+DSCQcyPJcuHBhFfDoyJH79thzzz6uGUOAsrIy9tyzLyNH7tsDeMzkVQwmIWstfYFuiBvsuQFscI4DLkn7/xhgRjgM69ZEaY2Fco0uPKEskmRbfZhYbJeRTUadpVKeAdRZcP1Mb1WmVVTUjnOz552ph1tRUTsW2XhYKNMGDRo6duDAPQKv0+vy7NWrO3vvPXLfcDj848KnG0I37rnnwLEDB/YnEokEsjzLy8sBpvXvP2jcgAH9XDUyO41NhAED+tG//6CxwDSTp98ckuG9QwPY4ByR4b0J4bBEBojH8d3QVFYlWPNpOWvWRKmpiadGOBl1lkp5BlBnwfUzbEYzQ0Oh8JROnXp5rrRTp96EQuEpBU6hDa2pqb1y+PBhhDyuySmdBU75+Faew4btRW1t5+8WqrOysmrKiBF7U14eDWx5zps3b2hVVdWVw4cP91RneXmU4cOHU1VVfeW8efO8nELLZtHLbVxbTDKFTNkBMnUVKsIqUlkZNDeFWbywinA4mdKQVWeplGeRcL1+pkY0U6uqukWdLFRbJRyOUFXVLcrOc2vs9L6nDhy4V5mThX8/dPpZnpFImOHD9ymLRCLX2f+O4esHDBhUVlVVGfTf/bqBA/cqq6mp9lxnTU01AwcOKQuFQtd59ADvh+wUPyDDQ5ppfrtYazJ9EPfZwRk+i1t8zzedySSDa2riLF9Wwdq1UaqrE0XTKd6Nu/1wpVCentXP8MaNi2ohdLaXUzyZplIgdJbkbZna8vKKcwYO3NN3nYAtnX6X5x579Ka8vOIrdnVGImVfGTx4oGdTZm6U55NPPlkbiZSdNXjwQMJh77vK4XAIKZOyrzz55JNuL65NBp4Bfg/8AziRYHIoEs3iMfPvCaWgs7wiecK2+giLF1YSjRbfZyJUeuXpWf0MA8eXl1d3yrYZ06vebXl5dSfgeBu3Hd+zZ+/qysrywOv0vzxD9OvXv9quzl69eldXVlYEvjx79epT7ccodqdBrKBXrz52yzPVI4ySParudOSMoSpgD8RrJ2hTY2HgwbTOQBnwKM4cTnzRmUzyaLQsWbV+Q5TmHSHCYf9FRcpg+/Yw27eHqChPBK08i1Y/w8DR0Wgn37+xyfNoG7cc3afPHiWhsxjl2atXb9s6e/fu7flalxvl2bdvX397oiEwedrRWWse1BeQYJhD2nzeg10j7wKMoDhurFchkaN/y+7z7v2AAW1tLzuPuQi0zkg4OTKZhEQ8RCiU9F1nJJIsb2wM88nHFYTDySCVZ1HrZxkwtqyswvcaZPIca+OWsZ0715aEzmKUZ21tp3Zbnl27dvFdp8nTjs4pyCa2GuSo7a7A6eyM0p2t91Hp81e7FjmiIsXebQxqeY7ecOB1JiHis0PCbjorypNHf7y8kjFjm4hGk+VpQUaLWZ5FrZ9hYGgk4r8rp8lzqI1bhlZXV5SEzmKUp9m8aLM8q30f0RRSnlVV/s8ymDzt6LzYPMSpRuQUdj2cLltB+72Y0NbJ4ag2BjXbInRcdVrTGS1Pjm1qCtPQECYaTQZFZ1HrZxjoHC7CZKbJs7ONWzqHw2GSyaTtv0Qi6bvOUijPaLRwr7iUgZJgpdb/jOOBLZ2pKMz+jrxsl2e/PO8FZUd/Jqvdn+BRsjqTSfpHIuJinUwGRmdR62fJHAUKMHv2AoIV6ik4JBIJ3/KqqalizJjCTpKOx+M888yijvKzhAOoaQe7nz/fojrd1xkKaf1Mz2ibn41Um4Zxm41bVGcOWlpitnXGYoXH5LM7kkn9tbbGbetsbfW/PE2e2xwmkwxg45JUnR1SZ1HrZxhYGo/731EweS61cYvqzEF9faNtnY2NjSR9HNsnk0kaG+3rbGpq8r08TZ5LURTFFUMzt7XV/2gH8fgOkCilVlGdOdi8eYttndu21fuu0+RpS+fWrXW+6zR5ztUmQlHcMTQvxWLbfc+4pWU7wEs2blGdWUgkkqxZ86ltnevXr/d9RLN+/XrbOteuXevromoyCWvXrrWrU1GUHIbm2ZaWxu2JhH/edolEnJaWxkZkk5NVVGcW1q/fSkPDVts6N2xY39jc7N/oq7l5Bxs2rG+yr3NdEXSus6tTUZRshqZnz+H1kHywuXmrjw/yViD5gORtmaLplLyDqTMeT7Bs2XISibhtnfF468OffLKSeDzug844klfrQ3Z0nnLKKfXxeOtDH3+8wpGbup3R4ccfryAeb33wlFNOqdcmQlHcGdEA3NrUtCXmRy88kYjT1LQlhsTRsYvqbMOKFevZuHF1QToTicT0FSs+bm1qavZcZ1NTMytXftyaSCRutntvMpm8ecWK5a0NDY2e69y+vZEVK5a3JpPJW7R5UBQXDU3PnsOXJJOJO7ZvX+/Dg7yeZDJxZ8+ewxcXcLvvOpFoq4HUuWlTPYsXLyCRiBess7m56Y6FCxen3KM9oaUlxsKFi2lsbLyjEJ1jxoxZ0tTU+PNFixb5orOpqfGOMWPGLNbmQVHcHdEATNuxo36ul1M+zc1b2bGjfi4OT65UnbB163bmz19IY+NWRzqTyeSPVq9eMW/FilWeTKHF43FWrFjF6tUr5hWqs6WlBWDaqlWfzF258tPUXhxXaW1tZeXKT1m9+pN5wDSTp6Iobhqanj2HNwGnNzSs37Bjh/tT0zt21NPQsH4DcHrPnsOdzIH4phMIpM716+v44IOFbNq0yhWdiUTitIUL529etWoN8bh7myPj8QSrVq1h4cL5mxOJxGlOdI4YMaIJOH3Bgg82rV691lVj09oaZ/XqdSxY8MGmZDJ52ogRIxq1aVAUb0Y09Ow5fAlwXH39mnVu9sSbm7dSX79mHXCcycMpnus0eQRKZyzWytKla5g/fwEbN65wVWcsFjvmgw/e37h8+Se0trY6TrC1tZXlyz/hgw/e3xiLxY5xQ+eIESOWxGKxYz/4YM6Gjz9eyY4dzkcdO3a08PHHK/nggzkbYrHYsSNGjFji4vMVyvIaC+/j0vWKUvT6uVusm549h78LTGxoWD+3vn4NiUThjU4iEae+fg0NDevnAhNN2m7hmU6TdmB0xmJxVqzYwJw5y1i0aD5bt67xRGcsFjtk/vx5H8yZM4+GhsL3AjU0bGfOnHnMnz/vg1gsdoibOseMGfNuLBY7dP78ufPmzfuQhobGguK8JRIJGhoamTfvQ+bPnzsvFosdOmbMmHddfpDT3eSyDcHSxWcKHV+WI81CiOZ5r8zCfeXZPk+L7xW18F2KpjNPPu1RZ1HrZ8agambUMWHHjvrbt2z5ONbYuAk7HlSJRJzGxk1s2bI8tmNH/e3ABJdGMplGDK7qdGmEULDOeDxJS0sr27Y18umnm5k/fyVvv72QhQsX8umnCzzXmUgkDly9esXPXn/99daPPlqUChljicbGRj76aBGvv/566+rVK36WSCQO9ELnuHHjliQSiYNWrfrk9jfeeL114cKlNDY2k0gkcm7sTCbFwDQ2NrNw4VLeeOP11lWrPrk9kUgcNG7cOKc6M4Uv2JD2elubhzb1UDak/X9dhjQ2t/l/Jg8TO8PlTI1FQxudmUh/P5Yt3UTis4jFdQ4bRk915vnd2qPOotbPrEJ79hzeDFy7ceOi3zc2brqmsXHzOeXl1dXRaCei0UrC4WgqND2JRIJEIkYs1kwstp2WlsYmSP4duK1A7zJbM17AtclkwpFOCvPacl3n7NkfBUHn95qaGu9dvHjB1KVLF5/ds2fvqt69e9OtWxeqq6soKyv7bHqssbGJLVvqWL9+PRs3rm9OJOIPJBKJW0KhkKc6R48e3VxbW3vt7Nmzf79kyYKpy5aJzr59+9K1axeqqqooK4sYnXGamprYurWOtWvXfqYzHo/fcvDBBy+ur3dlDe0B4IK0h/8tdo2Vtg14Gjg5bXrhWWBL2jUvmYe5j/n/duDJNvksM2lPSM1Smryt8hDwtbT/rwX+16bxeQE4Ju29D4AFaf9/BPhhm3T/GgoliSdCJBIhQqHkQgjNZdczZF4Mgs42/1+IhBpq7zqLWj9Dr732oSWVGzcuqgFOBI4ExiNHgXZN61EtB+YArwDP9Ow5vMFKuo890p07fpH9qN4pV6wF4PAjZ1stUFs621js7K1vUwVnnT056+cPPvAvACqrdpS8zlAoRDKZJBwOk0gkbOkMh8MNiUTiszSc6sxH/wGDHNXPVSs/yZtHLp1p9bQ/cAdwGLAIOXnxjTaX7WOu2Q+YB1wOzG8zw/BN4BpTPx4Brmd3J4pDgNuB4cBMYModv+i7ykp5TblibYVpdA4HVgFnAR+1uawbcs7954y+s8216ZwN3Gx0PgR8Z/v2MHv2j3Hc5K0kEhCPhwYCjyIHyP0POGfixFGbvdS5vSG8qv/AFo6bXEc8DvF4aDedGbJzVWcsFvooGk0y+YSt9OjRSlNTuKDydFPnrFnzi1o/Q9+9fE034H7gWKwdL9oCPAycf/qXN7cYY1GJnEP9lSxziW1pNVb+bKDOiqExlaognUDLhIPfAzmWtGCdFhtGRzrNe6rTBZ39BwxqMcbEM52KouQnDPwCmIz1M6zLzVDx+sce6c5jj3QH+IF5L2oxjTKT5502tBasM+091dmBdK5a+UlqxOKHTkVRchiaQrtr6fcd50Iabl6rOlWn3zoVRclhaHoWeG+ftNdupJEP1ak6g6xTUZQchkZRlCzo+oyiqKFRFEVR1NAoiqIoamgURVEURQ2NoiiKooZGURRFUdTQKIqiKGpoFEVRlHZlaOoKvDc9mJsbaeRDdarOIOtUFCWHoXm0wHsfS3vtRhr5UJ2qM8g6FUXJQhlwFVALfAFrx3a2mgfw9rT3bgX6IefXWwl+mEDOUvieDa2qU3UGWaeiKDkMTR0SPt0JLcC3zJ9XqE7VGWSdiqLkMDQdgrdm7+c4jbPO9jZ9t/BDpznfR1EUxZKh6QLci/WpiTgyNXE5Ow/AKgfuAk6zODWRRA6WuhjrC7WqU3UGWaeiKDkMzQzgTJv3XYwcRXqT+f9U4CKbaXwFOafa6n2qU3UGWaeiKFkIA2cUeO/paa/dSCMfqlN1Blmnoig5DE2XAu/t3mZ6w2ka+VCdqjPIOhVFyWFoFEVRFEUNjaIoiqKGRlEURVHU0CiKoihqaBRFURQ1NIqiKIqihkZRFEVRQ6MoiqJ0BEOzscB716W9diONfKhO1RlknYqi5DA0/yrw3mfTXj/nQhr5UJ2qM8g6FUXJYWguNw9zq8V7WoC/Ajenvfdj4G/sjJabj1bzEE+xoVV1qs4g61QUJQv/PwAlukJhy2ScjQAAAABJRU5ErkJggg==";

    jfgrid.getjfgird_select_save = function () {
        return jfgird_select_save;
    };

    jfgrid.setjfgird_select_save = function (v) {
        jfgird_select_save = v;
    };
    
    jfgrid.getjfgird_scroll_status = function () {
        return jfgird_scroll_status;
    };

    jfgrid.setjfgird_scroll_status = function (v) {
        jfgird_scroll_status = v;
    };

    var jfgridConfigsetting = {
        allowCopy: true,
        showtoolbar: true,
        showinfobar: true,
        showsheetbar: true,
        showstatisticBar: true,
        pointEdit: false,
        pointEditUpdate: null,
        pointEditZoom: 1,
        showConfigWindowResize: true,
        enableAddRow: true,
        enableAddCol: true,
        enablePage: true,
        pageInfo: null,
        autoFormatw: false,
        accuracy: undefined,
        editMode: false,
        chartConfigChange: null,
        beforeCreateDom: null,
        total: 0
    }
    jfgrid.jfgridConfigsetting = jfgridConfigsetting;

    var jfgriddefaultstyle = {
        font: 'normal '+ Math.ceil(10*devicePixelRatio) +'pt 微软雅黑, "Helvetica Neue", Helvetica, Arial, "PingFang SC", "Hiragino Sans GB", "Heiti SC", "Microsoft YaHei", "WenQuanYi Micro Hei", sans-serif',
        fillStyle: "#000000",
        textBaseline: "middle",
        strokeStyle: "#dfdfdf",
        rowFillStyle: "#5e5e5e",
        textAlign: 'center'
    }
    jfgrid.jfgriddefaultstyle = jfgriddefaultstyle;

    //编辑器qksheet表格编辑所需一些方法
    jfgrid.setjfgrid_pointEditZoom = function(v){
        jfgridConfigsetting.pointEditZoom = v;
    }

    // 替换temp中的${xxx}为指定内容 ,temp:字符串，这里指html代码，dataarry：一个对象{"xxx":"替换的内容"}
    // 例：jfgrid.replaceHtml("${image}",{"image":"abc","jskdjslf":"abc"})   ==>  abc
    jfgrid.replaceHtml = function (temp, dataarry) {
        return temp.replace(/\$\{([\w]+)\}/g, function (s1, s2) { var s = dataarry[s2]; if (typeof (s) != "undefined") { return s; } else { return s1; } });
    };

    //是否为非编辑模式
    jfgrid.isEditMode = function(){
        if(jfgrid.jfgridConfigsetting.editMode){
            return true;
        }
        else{
            return false;
        }
    }

    //太平秀编辑器 数据初始化（针对 合并单元格）
    jfgrid.flowdataInit = function(flowdata){
        var data = [];
        var cfg_merge = {}, mclist = {};

        for(var r = 0; r < flowdata.length; r++){
            var dataRow = [];

            for(var c = 0; c < flowdata[r].length; c++){
                if(flowdata[r][c] != null && flowdata[r][c].mc != null){
                    var cell = $.extend(true, {}, flowdata[r][c]);

                    if(cell.mc.rs != null){
                        mclist[cell.mc.r + "_" + cell.mc.c] = [r, c];

                        cell.mc.r = r;
                        cell.mc.c = c;

                        cfg_merge[r + "_" + c] = cell.mc;
                    }
                    else{
                        if((cell.mc.r + "_" + cell.mc.c) in mclist){
                            var mcArr = mclist[cell.mc.r + "_" + cell.mc.c];

                            cell.mc.r = mcArr[0];
                            cell.mc.c = mcArr[1];
                        }
                    }

                    dataRow.push(cell);
                }
                else{
                    dataRow.push(flowdata[r][c]);
                }
            }

            data.push(dataRow);
        }

        if(JSON.stringify(cfg_merge).length > 2){
            return { "data": data, "config": { "merge": cfg_merge } };
        }
        else{
            return { "data": data };
        }
    }

    //判断数据类型
    jfgrid.getObjType = function(obj){
        var toString = Object.prototype.toString;

        var map = {
            '[object Boolean]':  'boolean',
            '[object Number]':   'number',
            '[object String]':   'string',
            '[object Function]': 'function',
            '[object Array]':    'array',
            '[object Date]':     'date',
            '[object RegExp]':   'regExp',
            '[object Undefined]':'undefined',
            '[object Null]':     'null',
            '[object Object]':   'object'
        }

        // if(obj instanceof Element){
        //     return 'element';
        // }

        return map[toString.call(obj)];
    }

    jfgrid.func_methods = {
        //单元格数据生成一维数组
        getCellDataArr: function(rangeObj, nullCellType, isNeglectNullCell){
            var dataArr = [];

            if(rangeObj.data == null){
                if(!isNeglectNullCell){
                    if(nullCellType == "number"){
                        dataArr.push(0);
                    }
                    else if(nullCellType == "text"){
                        dataArr.push("");
                    }
                }
            }
            else{
                if(jfgrid.getObjType(rangeObj.data) == "array"){
                    for(var i = 0; i < rangeObj.data.length; i++){
                        for(var j = 0; j < rangeObj.data[i].length; j++){
                            if(rangeObj.data[i][j] != null && !jfgrid.func_methods.isRealNull(rangeObj.data[i][j].v)){
                                dataArr.push(rangeObj.data[i][j].v);
                            }
                            else{
                                if(!isNeglectNullCell){
                                    if(nullCellType == "number"){
                                        dataArr.push(0);
                                    }
                                    else if(nullCellType == "text"){
                                        dataArr.push("");
                                    }
                                }
                            }
                        }
                    }
                }
                else{
                    if(jfgrid.func_methods.isRealNull(rangeObj.data.v)){
                        if(!isNeglectNullCell){
                            if(nullCellType == "number"){
                                dataArr.push(0);
                            }
                            else if(nullCellType == "text"){
                                dataArr.push("");
                            }
                        }
                    }
                    else{
                        dataArr.push(rangeObj.data.v);
                    }
                }
            }

            return dataArr;
        },
        //单元格数据生成二维数组
        getCellDataDyadicArr: function(rangeObj, nullCellType){
            var dataArr = [];

            if(rangeObj.data == null){
                var rowArr = [];

                if(nullCellType == "number"){
                    rowArr.push(0);
                }
                else if(nullCellType == "text"){
                    rowArr.push("");
                }

                dataArr.push(rowArr);
            }
            else{
                if(jfgrid.getObjType(rangeObj.data) == "array"){
                    for(var i = 0; i < rangeObj.data.length; i++){
                        var rowArr = [];

                        for(var j = 0; j < rangeObj.data[i].length; j++){
                            var value;

                            if(rangeObj.data[i][j] != null && !jfgrid.func_methods.isRealNull(rangeObj.data[i][j].v)){
                                value = rangeObj.data[i][j].v;
                            }
                            else{
                                if(nullCellType == "number"){
                                    value = 0;
                                }
                                else if(nullCellType == "text"){
                                    value = "";
                                }
                            }

                            rowArr.push(value);
                        }

                        dataArr.push(rowArr);
                    }
                }
                else{
                    var rowArr = [];

                    var value = rangeObj.data.v;

                    if(jfgrid.func_methods.isRealNull(value)){
                        if(nullCellType == "number"){
                            value = 0;
                        }
                        else if(nullCellType == "text"){
                            value = "";
                        }
                    }

                    rowArr.push(value);

                    dataArr.push(rowArr);
                }
            }

            return dataArr;
        },
        //数组数据生成一维数组
        getDataArr: function(arr, isNeglectNaN){
            var dataArr = [];

            if(isNeglectNaN == null){
                isNeglectNaN = false;
            }

            if(jfgrid.getObjType(arr[0]) == "array"){
                for(var i = 0; i < arr.length; i++){
                    for(var j = 0; j < arr[i].length; j++){
                        if(isNeglectNaN && !jfgrid.func_methods.isRealNum(arr[i][j])){
                            continue;
                        }

                        dataArr.push(arr[i][j]);
                    }
                }
            }
            else{
                for(var i = 0; i < arr.length; i++){
                    if(isNeglectNaN && !jfgrid.func_methods.isRealNum(arr[i])){
                        continue;
                    }

                    dataArr.push(arr[i]);
                }   
            }

            return dataArr;
        },
        getDataDyadicArr: function(arr){
            var dataArr = [];

            if(jfgrid.getObjType(arr[0]) == "array"){
                for(var i = 0; i < arr.length; i++){
                    var rowArr = [];

                    for(var j = 0; j < arr[i].length; j++){
                        rowArr.push(arr[i][j]);
                    }

                    dataArr.push(rowArr);
                }
            }
            else{
                var rowArr = [];

                for(var i = 0; i < arr.length; i++){
                    rowArr.push(arr[i]);
                }   

                dataArr.push(rowArr);
            }

            return dataArr;
        },
        //是否是规则二维数组
        isDyadicArr: function(arr){
            var isDyadic = true;

            if(arr.length > 1){
                var collen = arr[0].length;

                for(var i = 1; i < arr.length; i++){
                    if(arr[i].length != collen){
                        isDyadic = false;
                        break;
                    }
                }
            }

            return isDyadic;
        },
        //获取单个单元格数据，数组第一个值
        getFirstValue: function(data, nullCellType){
            if(nullCellType == null){
                nullCellType = "number";
            }

            var value;

            if(jfgrid.getObjType(data) == "array"){
                if(jfgrid.getObjType(data[0]) == "array"){
                    if(!jfgrid.func_methods.isDyadicArr(data)){
                        return jfgrid.formula.error.v;
                    }

                    value = data[0][0];
                }
                else{
                    value = data[0];
                }
            }
            else if(jfgrid.getObjType(data) == "object" && data.startCell != null){
                if(data.data == null){
                    if(nullCellType == "number"){
                        value = 0;
                    }
                    else if(nullCellType == "text"){
                        value = "";
                    }
                }
                else{
                    var cell_r = window.jfgridCurrentRow;
                    var cell_c = window.jfgridCurrentColumn;

                    if(data.rowl == 1 && data.coll == 1){
                        value = data.data;

                        if(value == null || jfgrid.func_methods.isRealNull(value.v)){
                            if(nullCellType == "number"){
                                value = 0;
                            }
                            else if(nullCellType == "text"){
                                value = "";
                            }
                        }
                        else{
                            value = value.v;
                        }
                    }
                    else{
                        if(data.data[0][0].mc != null && data.data[0][0].mc.rs == data.rowl && data.data[0][0].mc.cs == data.coll){
                            value = data.data[0][0];

                            if(value == null || jfgrid.func_methods.isRealNull(value.v)){
                                if(nullCellType == "number"){
                                    value = 0;
                                }
                                else if(nullCellType == "text"){
                                    value = "";
                                }
                            }
                            else{
                                value = value.v;
                            }
                        }
                        else if(data.rowl == 1 || data.coll == 1){
                            var cellrange = jfgrid.formula.getcellrange(data.startCell);
                            var str = cellrange.row[0],
                                edr = str + data.rowl - 1,
                                stc = cellrange.column[0],
                                edc = stc + data.coll - 1;

                            if(data.rowl == 1){
                                if(cell_c < stc || cell_c > edc){
                                    return jfgrid.formula.error.v;
                                }

                                value = data.data[0][cell_c - stc];
                            }
                            else if(data.coll == 1){
                                if(cell_r < str || cell_r > edr){
                                    return jfgrid.formula.error.v;
                                }

                                value = data.data[cell_r - str][0];
                            }

                            if(value == null || jfgrid.func_methods.isRealNull(value.v) || value.mc != null){
                                if(nullCellType == "number"){
                                    value = 0;
                                }
                                else if(nullCellType == "text"){
                                    value = "";
                                }
                            }
                            else{
                                value = value.v;
                            }
                        }
                        else{
                            return jfgrid.formula.error.v;
                        }
                    }
                }
            }
            else{
                value = data;
            }

            return value;
        },
        //获取单元格的逻辑值
        getCellBoolen: function(data){
            var cumulative = jfgrid.func_methods.getFirstValue(data);

            if(jfgrid.func_methods.valueIsError(cumulative)){
                return cumulative;
            }

            if(jfgrid.getObjType(cumulative) == "boolean"){
                
            }
            else if(jfgrid.getObjType(cumulative) == "string" && (cumulative.toLowerCase() == "true" || cumulative.toLowerCase() == "false")){
                if(cumulative.toLowerCase() == "true"){
                    cumulative = true;
                }
                else if(cumulative.toLowerCase() == "false"){
                    cumulative = false;
                }
            }
            else if(jfgrid.func_methods.isRealNum(cumulative)){
                cumulative = parseFloat(cumulative);

                cumulative = cumulative == 0 ? false : true;
            }
            else{
                return jfgrid.formula.error.v;
            }

            return cumulative;
        },
        //获取单元格的日期
        getCellDate: function(data){
            var date_text;

            if(jfgrid.getObjType(data) == "array"){
                if(jfgrid.getObjType(data[0]) == "array"){
                    if(!jfgrid.func_methods.isDyadicArr(data)){
                        return jfgrid.formula.error.v;
                    }

                    date_text = data[0][0];
                }
                else{
                    date_text = data[0];
                }
            }
            else if(jfgrid.getObjType(data) == "object" && data.startCell != null){
                if(data.data == null || jfgrid.getObjType(data.data) == "array" || jfgrid.func_methods.isRealNull(data.data.v)){
                    return jfgrid.formula.error.v;
                }

                date_text = data.data.v;

                if(data.data.ct != null && data.data.ct.t == "d"){
                    date_text = jfgrid.mask.update("YYYY-MM-DD h:mm:ss", date_text);
                }
            }
            else{
                date_text = data;
            }

            return date_text;
        },
        getCellrangeDate: function(data){
            var date = [];

            if(jfgrid.getObjType(data) == "array"){
                if(jfgrid.getObjType(data[0]) == "array" && !jfgrid.func_methods.isDyadicArr(data)){
                    return jfgrid.formula.error.v;
                }

                date = date.concat(jfgrid.func_methods.getDataArr(data, false));
            }
            else if(jfgrid.getObjType(data) == "object" && data.startCell != null){
                if(data.data == null){
                    date.push(0);
                }
                else{
                    if(jfgrid.getObjType(data.data) == "array"){
                        for(var i = 0; i < data.data.length; i++){
                            for(var j = 0; j < data.data[i].length; j++){
                                if(data.data[i][j] != null && !jfgrid.func_methods.isRealNull(data.data[i][j].v)){
                                    var value = data.data[i][j].v;

                                    if(data.data[i][j].ct != null && data.data[i][j].ct.t == "d"){
                                        value = jfgrid.mask.update("YYYY-MM-DD h:mm:ss", value);
                                    }

                                    date.push(value);
                                }
                                else{
                                    date.push(0);
                                }
                            }
                        }
                    }
                    else{
                        var value = data.data.v;

                        if(data.data.ct != null && data.data.ct.t == "d"){
                            value = jfgrid.mask.update("YYYY-MM-DD h:mm:ss", value);
                        }

                        date.push(value);
                    }
                }
            }
            else{
                date.push(data);
            }

            return date;
        },
        //是否是纯数字
        isRealNum: function(val){
            if(val == null || val.toString().replace(/\s/g, "") == ""){
                return false;
            }

            if(typeof val == "boolean"){
                return false;
            }

            if(!isNaN(val)){
                return true;
            }
            else{
                return false;
            }
        },
        //是否是空值
        isRealNull: function(val){
            if(val == null || val.toString().replace(/\s/g, "") == ""){
                return true;
            }
            else{
                return false;
            }
        },
        //是否是错误类型
        valueIsError: function(value){
            var isError = false;

            for(x in jfgrid.formula.error){
                if(value == jfgrid.formula.error[x]){
                    isError = true;
                    break;
                }
            }

            return isError;
        },
        //获取正则字符串（处理 . * ? ~* ~?）
        getRegExpStr: function(str){
            return str.replace("~*", "\\*").replace("~?", "\\?").replace(".", "\\.").replace("*", ".*").replace("?", ".");
        },
        //阶乘
        factorial: function(num){
            if (num == 0 || num == 1) { 
                return 1; 
            } 
            else { 
                return (num * jfgrid.func_methods.factorial(num - 1)); 
            } 
        },
        //双阶乘
        factorialDouble: function(num){
            if (num <= 0) { 
                return 1; 
            } 
            else { 
                return (num * jfgrid.func_methods.factorialDouble(num - 2)); 
            } 
        },
        //总体方差
        variance: function(num_arr){
            var sum = 0, count = 0;

            for(var i = 0; i < num_arr.length; i++){
                var number = num_arr[i];

                sum += number;
                count++;
            }

            var avg = sum / count;

            var sum_variance = 0;

            for(var j = 0; j < num_arr.length; j++){
                var number = num_arr[j];
     
                sum_variance += (number - avg) * (number - avg);
            }

            return sum_variance / count;
        },
        //样本方差
        variance_s: function(num_arr){
            var sum = 0, count = 0;

            for(var i = 0; i < num_arr.length; i++){
                var number = num_arr[i];

                sum += number;
                count++;
            }

            var avg = sum / count;

            var sum_variance = 0;

            for(var j = 0; j < num_arr.length; j++){
                var number = num_arr[j];
     
                sum_variance += (number - avg) * (number - avg);
            }

            return sum_variance / (count - 1);
        },
        //总体标准偏差
        standardDeviation: function(num_arr){
            var sum = 0, count = 0;

            for(var i = 0; i < num_arr.length; i++){
                var number = num_arr[i];

                sum += number;
                count++;
            }

            var avg = sum / count;

            var sum_variance = 0;

            for(var j = 0; j < num_arr.length; j++){
                var number = num_arr[j];
     
                sum_variance += (number - avg) * (number - avg);
            }

            return Math.sqrt(sum_variance / count);
        },
        //样本标准偏差
        standardDeviation_s: function(num_arr){
            var sum = 0, count = 0;

            for(var i = 0; i < num_arr.length; i++){
                var number = num_arr[i];

                sum += number;
                count++;
            }

            var avg = sum / count;

            var sum_variance = 0;

            for(var j = 0; j < num_arr.length; j++){
                var number = num_arr[j];
     
                sum_variance += (number - avg) * (number - avg);
            }

            return Math.sqrt(sum_variance / (count - 1));
        },
        //是否是闰年
        isLeapYear: function(year){
            return new Date(year, 1, 29).getMonth() === 1;
        },
        //2月是否有29
        feb29Between: function(date1, date2){
            var year1 = moment(date1).year();
            var mar1year1 = moment().set({ 'year': year1, 'month': 2, 'date': 1 });

            if (jfgrid.func_methods.isLeapYear(year1) && moment(date1) < moment(mar1year1) && moment(date2) >= moment(mar1year1)) {
                return true;
            }

            var year2 = moment(date2).year();
            var mar1year2 = moment().set({ 'year': year2, 'month': 2, 'date': 1 });
            
            return (jfgrid.func_methods.isLeapYear(year2) && moment(date2) >= moment(mar1year2) && moment(date1) < moment(mar1year2));
        },
        //SQL 查询
        findResultIndex: function(database, criterias){
            var matches = {};
                    
            for (var i = 1; i < database[0].length; ++i) {
                matches[i] = true;
            }

            var maxCriteriaLength = criterias[0].length;

            for (i = 1; i < criterias.length; ++i) {
                if (criterias[i].length > maxCriteriaLength) {
                    maxCriteriaLength = criterias[i].length;
                }
            }

            for (var k = 1; k < database.length; ++k) {
                for (var l = 1; l < database[k].length; ++l) {
                    var currentCriteriaResult = false;
                    var hasMatchingCriteria   = false;
  
                    for (var j = 0; j < criterias.length; ++j) {
                        var criteria = criterias[j];
    
                        if (criteria.length < maxCriteriaLength) {
                            continue;
                        }

                        var criteriaField = criteria[0];
    
                        if (database[k][0] !== criteriaField) {
                            continue;
                        }
    
                        hasMatchingCriteria = true;
    
                        for (var p = 1; p < criteria.length; ++p) {
                            currentCriteriaResult = currentCriteriaResult || eval(database[k][l] + criteria[p]);  // jshint ignore:line
                        }
                    }
  
                    if (hasMatchingCriteria) {
                        matches[l] = matches[l] && currentCriteriaResult;
                    }
                }
            }

            var result = [];

            for (var n = 0; n < database[0].length; ++n) {
                if (matches[n]) {
                    result.push(n - 1);
                }
            }
            
            return result;
        },
        findField: function(database, title){
            var index = null;
                    
            for (var i = 0; i < database.length; i++) {
                if (database[i][0] == title) {
                    index = i;
                    break;
                }
            }

            if (index == null) {
                return jfgrid.formula.error.v;
            }
            
            return index;
        },
        rest: function(array, idx){
            idx = idx || 1;
                    
            if (!array || typeof array.slice !== 'function') {
                return array;
            }
            
            return array.slice(idx);
        },
        compact: function(array){
            if (!array) { 
                return array; 
            }
            
            var result = [];
            
            for (var i = 0; i < array.length; ++i) {
                if (!array[i]) { 
                    continue; 
                }
                
                result.push(array[i]);
            }
                
            return result;
        }
    }

    //颜色 16进制转rgb
    jfgrid.hexToRgb = function (hex) {
        var color = [], rgb = [];
        hex = hex.replace(/#/, "");
        if (hex.length == 3) { // 处理 "#abc" 成 "#aabbcc"
            var tmp = [];
            for (var i = 0; i < 3; i++) {
                tmp.push(hex.charAt(i) + hex.charAt(i));
            }
            hex = tmp.join("");
        }
        for (var i = 0; i < 3; i++) {
            color[i] = "0x" + hex.substr(i + 2, 2);
            rgb.push(parseInt(Number(color[i])));
        }
        return 'rgb(' + rgb.join(",") + ')';
    };

    //颜色 rgb转16进制
    jfgrid.rgbTohex = function(color) {
        if(color.indexOf("rgba") > -1){
            var rgb = color.replace("rgba(", "").replace(")", "").split(',');
        }
        else{
            var rgb = color.replace("rgb(", "").replace(")", "").split(',');
        }
        
        var r = parseInt(rgb[0]);
        var g = parseInt(rgb[1]);
        var b = parseInt(rgb[2]);
     
        var hex = "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
        return hex;
    };

    //列下标  字母转数字
    jfgrid.jfgridABCatNum = function (abc) {
        abc = abc.toUpperCase();
        var abc_len = abc.length;
        if (abc_len == 0) {
            return NaN;
        }

        var abc_array = abc.split("");
        var wordlen = columeHeader_word.length;
        var ret = 0;
        for (var i = abc_len - 1; i >= 0; i--) {
            if (i == abc_len - 1) {
                ret += columeHeader_word_index[abc_array[i]];
            }
            else {
                ret += Math.pow(wordlen, abc_len - i - 1) * (columeHeader_word_index[abc_array[i]] + 1);
            }
        }
        return ret;
    };

    //列下标  数字转字母
    jfgrid.jfgridchatatABC = function (index) {
        var wordlen = columeHeader_word.length;
        if (index < wordlen) {
            return columeHeader_word[index];
        }
        else {
            var last = 0, pre = 0, ret = "";
            var i = 1, n = 0;
            while (index >= (wordlen / (wordlen - 1)) * (Math.pow(wordlen, i++) - 1)) {
                n = i;
            }
            var index_ab = index - (wordlen / (wordlen - 1)) * (Math.pow(wordlen, n - 1) - 1);//970
            last = index_ab + 1;

            for (var x = n; x > 0; x--) {
                var last1 = last, x1 = x;//-702=268, 3
                if (x == 1) {
                    last1 = last1 % wordlen;
                    if (last1 == 0) {
                        last1 = 26;
                    }
                    return ret + columeHeader_word[last1 - 1];
                }
                last1 = Math.ceil(last1 / Math.pow(wordlen, x - 1));
                //last1 = last1 % wordlen;
                ret += columeHeader_word[last1 - 1];
                if (x > 1) {
                    last = last - (last1 - 1) * wordlen;
                }
            }
        }
    };

    //计算字符串字节长度
    jfgrid.getByteLen = function (val) {
        if(val == null){return 0}
        var len = 0;
        for (var i = 0; i < val.length; i++) {
            var a = val.charAt(i);
            if (a.match(/[^\x00-\xff]/ig) != null) {
                len += 2;
            }
            else {
                len += 1;
            }
        }
        return len;
    };

    jfgrid.ceateABC = function (index) {
        var wordlen = columeHeader_word.length;
        if (index < wordlen) {
            return columeHeader_word;
        }
        else {
            var relist = [];
            var i = 2, n = 0;
            while (index < (wordlen / (wordlen - 1)) * (Math.pow(wordlen, i) - 1)) {
                n = i;
                i++;
            }
            for (var x = 0; x < n; x++) {

                if (x == 0) {
                    relist = relist.concat(columeHeader_word);
                }
                else {
                    relist = relist.concat(jfgrid.createABCdim(x), index);
                }
            }
        }
    };

    jfgrid.convertRowColumn = function (a) {
        if (a.length == 0) {
            return [];
        }
        var b = [];
        for (var j = 0; j < a[0].length; j++) {
            b[j] = [];
            for (var i = 0; i < a.length; i++) {
                b[j][i] = a[i][j];
            }

        }
        return b;
    };

    jfgrid.createABCdim = function (x, count) {
        var chwl = columeHeader_word.length;
        if (x == 1) {
            var ret = [];
            var c = 0, con = true;
            for (var i = 0; i < chwl; i++) {
                var b = columeHeader_word[i];
                for (var n = 0; n < chwl; n++) {
                    var bq = b + columeHeader_word[n];
                    ret.push(bq);
                    c++;
                    if (c > index) {
                        return ret;
                    }
                }
            }
        }
        else if (x == 2) {
            var ret = [];
            var c = 0, con = true;
            for (var i = 0; i < chwl; i++) {
                var bb = columeHeader_word[i];
                for (var w = 0; w < chwl; w++) {
                    var aa = columeHeader_word[w];
                    for (var n = 0; n < chwl; n++) {
                        var bqa = bb + aa + columeHeader_word[n];
                        ret.push(bqa);
                        c++;
                        if (c > index) {
                            return ret;
                        }
                    }
                }
            }

        }
    };

    jfgrid.jfshowloading = function (txt) {
        $("#jfgrid-cell-loading").find("span").text(txt).end().show();
    };

    jfgrid.jfhideloading = function () {
        $("#jfgrid-cell-loading").hide();
    };

    jfgrid.browser = {
        mobilecheck: function() {
            var a = !1;
            return function(b) {
                (/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(b) || /1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(b.substr(0, 4))) && (a = !0);
            }(navigator.userAgent || navigator.vendor || window.opera), document.body && document.body.clientWidth && document.body.clientHeight && document.body.clientWidth < 350 && document.body.clientHeight < 500 && (a = !0), a;
        },
        iphoneCheck: function() {
            var a = !1;
            return /iPhone/i.test(navigator.userAgent) && (a = !0), !0;
        },
        isWeixin:function() {
            var a = navigator.userAgent.toLowerCase();
            return "micromessenger" == a.match(/MicroMessenger/i) ? !0 : !1;
        },
        isAndroid:function() {
            var a = navigator.userAgent,
                b = (navigator.appVersion, a.indexOf("Android") > -1 || a.indexOf("Linux") > -1);
            return b;
        },
        tabletCheck:function() {
            var a = /ipad|android|android 3.0|xoom|sch-i800|playbook|tablet|kindle/i.test(navigator.userAgent.toLowerCase());
            return a;
        },
        BrowserType: function() {
            var userAgent = navigator.userAgent; //取得浏览器的userAgent字符串
            var isOpera = userAgent.indexOf("Opera") > -1; //判断是否Opera浏览器
            var isIE = userAgent.indexOf("compatible") > -1 && userAgent.indexOf("MSIE") > -1 && !isOpera; //判断是否IE浏览器
            var isIE11 = userAgent.indexOf('Trident') > -1 && userAgent.indexOf("rv:11.0") > -1;
            var isEdge = userAgent.indexOf("Edge") > -1; //判断是否IE的Edge浏览器
            var isFF = userAgent.indexOf("Firefox") > -1; //判断是否Firefox浏览器
            var isSafari = userAgent.indexOf("Safari") > -1 && userAgent.indexOf("Chrome") == -1; //判断是否Safari浏览器
            var isChrome = userAgent.indexOf("Chrome") > -1 && userAgent.indexOf("Safari") > -1; //判断Chrome浏览器
            if (isIE) {
                var reIE = new RegExp("MSIE (\\d+\\.\\d+);");
                reIE.test(userAgent);
                var fIEVersion = parseFloat(RegExp["$1"]);
                if (fIEVersion == 7) {
                    return "IE7";
                } else if (fIEVersion == 8) {
                    return "IE8";
                } else if (fIEVersion == 9) {
                    return "IE9";
                } else if (fIEVersion == 10) {
                    return "IE10";
                // } else if (fIEVersion == 11) {
                //     return "IE11";
                } else {
                    return "0";
                } //IE版本过低
            } //isIE end
            if (isFF) {
                return "FF";
            }
            if (isOpera) {
                return "Opera";
            }
            if (isSafari) {
                return "Safari";
            }
            if (isChrome) {
                return "Chrome";
            }
            if (isEdge) {
                return "Edge";
            }
            if (isIE11) {
                return "IE11";
            }
        }, //myBrowser() end
        //判断是否是IE浏览器
        isIE: function() {
            var userAgent = navigator.userAgent; //取得浏览器的userAgent字符串
            var isOpera = userAgent.indexOf("Opera") > -1; //判断是否Opera浏览器
            var isIE = userAgent.indexOf("compatible") > -1 && userAgent.indexOf("MSIE") > -1 && !isOpera; //判断是否IE浏览器
            var isIE11 = userAgent.indexOf('Trident') > -1 && userAgent.indexOf("rv:11.0") > -1;
            if (isIE || isIE11) {
                return "1";
            } else {
                return "-1";
            }
        },
        //判断是否是IE浏览器，包括Edge浏览器
        IEVersion: function() {
            var userAgent = navigator.userAgent; //取得浏览器的userAgent字符串
            var isOpera = userAgent.indexOf("Opera") > -1; //判断是否Opera浏览器
            var isIE = userAgent.indexOf("compatible") > -1 && userAgent.indexOf("MSIE") > -1 && !isOpera; //判断是否IE浏览器
            var isIE11 = userAgent.indexOf('Trident') > -1 && userAgent.indexOf("rv:11.0") > -1;
            var isEdge = userAgent.indexOf("Windows NT 6.1; Trident/7.0;") > -1 && !isIE; //判断是否IE的Edge浏览器
            if (isIE) {
                var reIE = new RegExp("MSIE (\\d+\\.\\d+);");
                reIE.test(userAgent);
                var fIEVersion = parseFloat(RegExp["$1"]);
                if (fIEVersion == 7) {
                    return "IE7";
                } else if (fIEVersion == 8) {
                    return "IE8";
                } else if (fIEVersion == 9) {
                    return "IE9";
                } else if (fIEVersion == 10) {
                    return "IE10";
                // } else if (fIEVersion == 11) {
                //     return "IE11";
                } else {
                    return "0";
                } //IE版本过低
            } else if (isEdge) {
                return "Edge";
            } else if (isIE11) {
                return "IE11";
            } else {
                return "-1"; //非IE
            }
        },
        jfgridrefreshfixednum:null,
        jfgridrefreshfixed:function(){
            var _this = this;
            if(_this.jfgridrefreshfixednum==null){
                if(_this.BrowserType()=="FF"){
                    _this.jfgridrefreshfixednum = 5;
                }
                else{
                    _this.jfgridrefreshfixednum = 0;
                }
            }

            return _this.jfgridrefreshfixednum;
        }
    };

    jfgrid.controlHistory = {
        redo: function (e) {
            if (jfgrid.jfredo.length == 0) {
                return;
            }

            var ctr = jfgrid.jfredo.pop();
            jfgrid.jfundo.push(ctr);
            clearjfundo = false;
            
            if (jfgrid.sheetmanage.hasSheet(ctr.sheetIndex) && jfgrid.currentSheetIndex != ctr.sheetIndex) {
                jfgrid.sheetmanage.changeSheetExec(ctr.sheetIndex);
            }

            if (ctr.type == "datachange") {
                //如果有单元格为null,则对应公式应该删除
                for(var s = 0; s < ctr.range.length; s++){
                    var st_r = ctr.range[s].row[0];
                    var ed_r = ctr.range[s].row[1];
                    var st_c = ctr.range[s].column[0];
                    var ed_c = ctr.range[s].column[1];

                    for(var r = st_r;r < ed_r + 1; r++){
                        for(var c = st_c; c < ed_c +1; c++){
                            if(ctr.data[r][c] == null){
                                jfgrid.formula.delFunctionGroup(r,c);
                            }
                        }
                    }
                }
                jfgrid.formula.execFunctionGroup(null, null, null, null, ctr.data);//取之前的数据

                jfgrid.jfrefreshgrid(ctr.data, ctr.range, ctr.config, ctr.cdformat, ctr.RowlChange);
            }
            else if (ctr.type == "pasteCut") {
                var s = {
                    "sheetIndex": ctr.source["sheetIndex"],
                    "data": ctr.source["curData"],
                    "curData": ctr.source["data"],
                    "config": ctr.source["curConfig"],
                    "curConfig": ctr.source["config"],
                    "cdformat": ctr.source["curCdformat"],
                    "curCdformat": ctr.source["cdformat"],
                    "range": ctr.source["range"]
                }
                var t = {
                    "sheetIndex": ctr.target["sheetIndex"],
                    "data": ctr.target["curData"],
                    "curData": ctr.target["data"],
                    "config": ctr.target["curConfig"],
                    "curConfig": ctr.target["config"],
                    "cdformat": ctr.target["curCdformat"],
                    "curCdformat": ctr.target["cdformat"],
                    "range": ctr.target["range"]
                }
                jfgrid.jfrefreshgrid_pastcut(s, t, ctr.RowlChange);
            }
            else if (ctr.type == "cellchange") {
                jfgrid.formula.execFunctionGroup(ctr.uprow, ctr.upcolumn, ctr.value);
                jfgrid.jfrefreshcell(ctr.value, ctr.uprow, ctr.upcolumn);
            }
            else if (ctr.type == "rangechange") {
                //如果有单元格为null,则对应公式应该删除
                for(var s = 0; s < ctr.range.length; s++){
                    var st_r = ctr.range[s].row[0];
                    var ed_r = ctr.range[s].row[1];
                    var st_c = ctr.range[s].column[0];
                    var ed_c = ctr.range[s].column[1];

                    for(var r = st_r;r < ed_r + 1; r++){
                        for(var c = st_c; c < ed_c +1; c++){
                            if(ctr.data[r][c] == null){
                                jfgrid.formula.delFunctionGroup(r,c);
                            }
                        }
                    }
                }
                jfgrid.formula.execFunctionGroup(null, null, null, null, ctr.data);//取之前的数据
                
                jfgrid.jfrefreshrange(ctr.data, ctr.range, ctr.cdformat);
            }
            else if (ctr.type == "resize") {
                config = ctr.config;
                jfgridfile[jfgrid.sheetmanage.getSheetIndex(ctr.sheetIndex)].config = config;

                if(ctr.ctrlType == "resizeR"){
                    jfgrid.server.saveParam("cg", ctr.sheetIndex, ctr.config["rowlen"], { "k": "rowlen" });
                }
                else if(ctr.ctrlType == "resizeC"){
                    jfgrid.server.saveParam("cg", ctr.sheetIndex, ctr.config["columlen"], { "k": "columlen" });
                }

                jfgrid.jfrefreshgrid_rhcw(jfgrid.flowdata.length, jfgrid.flowdata[0].length);
            }
            else if (ctr.type == "cellRowChange") {
                jfgrid.jfrefreshgridall(ctr.data[0].length, ctr.data.length, ctr.data, ctr.config, ctr.range, ctr.ctrlType, ctr.ctrlValue, ctr.cdformat);
            }
            else if (ctr.type == "extend") {
                jfgrid.jfrefreshgridall(ctr.data[0].length, ctr.data.length, ctr.data, ctr.config, ctr.range, "dele", ctr.ctrlValue);
            }
            else if (ctr.type == "dele") {
                var ctrlValue1 = $.extend(true, {}, ctr.ctrlValue);
                ctrlValue1.restore = true;
                jfgrid.jfrefreshgridall(ctr.data[0].length, ctr.data.length, ctr.data, ctr.config, ctr.range, "extend", ctrlValue1);
            }
            else if (ctr.type == "addRC") { //增加行列撤销操作
                var ctrlValue = $.extend(true, {}, ctr.ctrlValue);
                if(ctrlValue.direction == "rightbottom"){
                    ctrlValue.index = ctrlValue.index + 1;
                }

                jfgrid.jfrefreshgrid_adRC(ctr.data, ctr.config, "delRC", ctrlValue, ctr.calc, ctr.filterObj, ctr.cf, ctr.af, ctr.freezen);
            }
            else if (ctr.type == "delRC") { //删除行列撤销操作
                var ctrlValue = $.extend(true, {}, ctr.ctrlValue);
                ctrlValue.restore = true;
                ctrlValue.direction = "lefttop";

                jfgrid.jfrefreshgrid_adRC(ctr.data, ctr.config, "addRC", ctrlValue, ctr.calc, ctr.filterObj, ctr.cf, ctr.af, ctr.freezen);
            }
            else if (ctr.type == "datachangeAll") {
                jfgrid.formula.execFunctionGroup();
                jfgrid.jfrefreshgridall(ctr.data[0].length, ctr.data.length, ctr.data, null, ctr.range, "datachangeAll", ctr.ctrlValue);
            }
            else if (ctr.type == "datachangeAll_filter_clear") {
                jfgrid.createFilterOptions(ctr.filter_save);

                $("#jfgrid-filter-options-sheet" + jfgrid.currentSheetIndex + " .jfgrid-filter-options").each(function(i){
                    var $top = $(this);
                    var item = ctr.optiongroups[i];
                    jfgrid.labelFilterOptionState($top, item.optionstate, item.rowhidden, item.caljs, false, item.st_r, item.ed_r, item.cindex, item.st_c, item.ed_c);
                });

                jfgrid.server.saveParam("fsr", jfgrid.currentSheetIndex, { "filter": ctr.optiongroups, "filter_select": ctr.filter_save });

                //config
                config = ctr.config;
                jfgridfile[jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex)].config = config;

                if(config["rowhidden"] == null){
                    config["rowhidden"] = {};
                }

                jfgrid.server.saveParam("cg", jfgrid.currentSheetIndex, config["rowhidden"], { "k": "rowhidden" });

                //行高、列宽 刷新  
                jfgrid.jfrefreshgrid_rhcw(jfgrid.flowdata.length, jfgrid.flowdata[0].length);

                // var $t = $("#jfgrid-filter-options-sheet" + jfgrid.currentSheetIndex + " .jfgrid-filter-options").eq(0);
                // jfgrid.filterseletedbyindex($t.data("str"), $t.data("edr"), $t.data("stc"), $t.data("edc"));
                $("#jfgrid-filter-menu, #jfgrid-filter-submenu").hide();
            }
            else if (ctr.type == "datachangeAll_filter") {
                var $top = $("#jfgrid-filter-options-sheet" + jfgrid.currentSheetIndex + " .jfgrid-filter-options").eq(ctr["optionsindex"]);
                var st_r = $top.data("str"), 
                    ed_r = $top.data("edr"), 
                    cindex = $top.data("cindex"), 
                    st_c = $top.data("stc"), 
                    ed_c = $top.data("edc");

                jfgrid.labelFilterOptionState($top, jfgrid.json.hasKey(ctr.rowhidenPre), ctr.rowhidenPre, ctr.caljs, true, st_r, ed_r, cindex, st_c, ed_c);

                //config
                config = ctr.config;
                jfgridfile[jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex)].config = config;

                if(config["rowhidden"] == null){
                    config["rowhidden"] = {};
                }

                jfgrid.server.saveParam("cg", jfgrid.currentSheetIndex, config["rowhidden"], { "k": "rowhidden" });

                //行高、列宽 刷新  
                jfgrid.jfrefreshgrid_rhcw(jfgrid.flowdata.length, jfgrid.flowdata[0].length);
                
                // jfgrid.filterseletedbyindex(st_r, ed_r, st_c, ed_c);
                $("#jfgrid-filter-menu, #jfgrid-filter-submenu").hide();
            }
            else if (ctr.type == "filtershow") {
                $('#jfgrid-filter-selected-sheet' + ctr.sheetIndex + ', #jfgrid-filter-options-sheet' + ctr.sheetIndex).remove();
                
                if(jfgrid.server.allowUpdate){
                    jfgrid.server.saveParam("all", ctr.sheetIndex, null, { "k": "filter_select" });
                }
            }
            else if(ctr.type == "pivotTable_change"){
                jfgridfile[jfgrid.sheetmanage.getSheetIndex(ctr.sheetIndex)].pivotTable = ctr.pivotTable;

                jfgrid.pivotTable.getCellData(ctr.sheetIndex);
                jfgrid.pivotTable.initialPivotManage(true);

                jfgrid.pivotTable.refreshPivotTable();
            }
            else if (ctr.type == "addSheet") {
                jfgrid.sheetmanage.deleteSheet(ctr.index);
                jfgrid.sheetmanage.changeSheetExec(ctr.currentSheetIndex);
                $("#jfgrid-input-box").removeAttr("style");
                $("#jfgrid-sheet-list, #jfgrid-rightclick-sheet-menu").hide();
            }
            else if (ctr.type == "copySheet") {
                jfgrid.sheetmanage.deleteSheet(ctr.index);
                jfgrid.sheetmanage.changeSheetExec(ctr.copyindex);
            }
            else if (ctr.type == "deleteSheet") {
                var isDupName = false;

                for(var i = 0; i < jfgridfile.length; i++){
                    if(jfgridfile[i].name == ctr.name){
                        isDupName = true;
                    }
                }

                if(!isDupName){
                    jfgrid.sheetmanage.createSheetbydata(ctr, "isrenew");
                    $("#jfgrid-input-box").removeAttr("style");
                    $("#jfgrid-sheet-list, #jfgrid-rightclick-sheet-menu").hide();
                }
            }
            else if (ctr.type == "sheetName") {
                jfgridfile[jfgrid.sheetmanage.getSheetIndex(ctr.sheetIndex)].name = ctr.oldtxt;
                $("#jfgrid-sheets-item" + ctr.sheetIndex).find(".jfgrid-sheets-item-name").html(ctr.oldtxt);

                jfgrid.server.saveParam("all", ctr.sheetIndex, ctr.oldtxt, { "k": "name" });
            }
            else if (ctr.type == "sheetColor") {
                jfgridfile[jfgrid.sheetmanage.getSheetIndex(ctr.sheetIndex)].color = ctr.oldcolor;
                
                var jfgridcurrentSheetitem = $("#jfgrid-sheets-item" + ctr.sheetIndex);
                jfgridcurrentSheetitem.find(".jfgrid-sheets-item-color").remove();

                if(ctr.oldcolor != null){
                    jfgridcurrentSheetitem.append('<div class="jfgrid-sheets-item-color" style=" position: absolute; width: 100%; height: 3px; bottom: 0px; left: 0px; background-color: ' + ctr.oldcolor + ';"></div>');
                }

                jfgrid.server.saveParam("all", ctr.sheetIndex, ctr.oldcolor, { "k": "color" });
            }
            else if (ctr.type == "insertChart") {
                //chartMix
                jfgrid.chartparam.jfgridInsertChartTosheetChange = false;
                !!window.store && store.commit("deleteChart",ctr.chart_json.chart_id);//同步store中数据
                jfgrid.chartparam.jfgridInsertChartTosheetChange = true;
            }
            else if (ctr.type == "moveChart") {
                //回到上一次的状态
                $("#" + ctr.chart_id + "_c").css({ "top": ctr.y, "left": ctr.x });
                $("#jfgrid-scrollbar-y").scrollTop(ctr.scrollTop1);
                $("#jfgrid-scrollbar-x").scrollLeft(ctr.scrollLeft1);

                !!window.store && store.commit({
                    type:"updateChartItem",
                    key:"left",
                    value:ctr.x,
                    chartId:ctr.chart_id
                });

                !!window.store && store.commit({
                    type:"updateChartItem",
                    key:"top",
                    value:ctr.y,
                    chartId:ctr.chart_id
                });

                jfgrid.server.saveParam("c", ctr.sheetIndex, { "left":ctr.x, "top":ctr.y, "scrollTop": ctr.scrollTop1, "scrollLeft": ctr.scrollLeft1  }, { "op":"xy", "cid": ctr.chart_id });
                // jfgrid.server.saveParam("c", ctr.sheetIndex, { "left":ctr.x, "top":ctr.y }, { "op":"xy", "cid": ctr.chart_id });
            }
            else if (ctr.type == "resizeChart") {//chartMix,增加位置x，y
                $("#" + ctr.chart_id + "_c").css({ "height": ctr.myHeight1, "width": ctr.myWidth1 ,"top": ctr.y, "left": ctr.x });
                $("#jfgrid-scrollbar-y").scrollTop(ctr.scrollTop1);
                $("#jfgrid-scrollbar-x").scrollLeft(ctr.scrollLeft1);
                !!window.store && store.commit({
                    type:"updateChartItem",
                    key:"height",
                    value:ctr.myHeight1,
                    chartId:ctr.chart_id
                });

                !!window.store && store.commit({
                    type:"updateChartItem",
                    key:"width",
                    value:ctr.myWidth1,
                    chartId:ctr.chart_id
                });

                !!window.store && store.commit({
                    type:"updateChartItem",
                    key:"left",
                    value:ctr.x,
                    chartId:ctr.chart_id
                });

                !!window.store && store.commit({
                    type:"updateChartItem",
                    key:"top",
                    value:ctr.y,
                    chartId:ctr.chart_id
                });
                //resize
                !!window.generator && generator.resize(ctr.chart_id);

                jfgrid.server.saveParam("c", ctr.sheetIndex, { "width":ctr.myWidth1, "height":ctr.myHeight1,"top": ctr.y, "left": ctr.x, "scrollTop": ctr.scrollTop1, "scrollLeft": ctr.scrollLeft1  }, { "op":"wh", "cid": ctr.chart_id});
            }
            else if (ctr.type == "updateChartRange") {
                //console.log(ctr.p_chart_id);
                jfgrid.chartparam.jfgrid_chart_redo_click = true;
                jfgrid.chartparam.jfgridInsertChartTosheetChange = false;
                jfgrid.updateChartTosheet("updateChartRange",ctr.p_sheetIndex, ctr.p_dataSheetIndex, ctr.p_option, ctr.p_chartType, ctr.p_selfOption, ctr.p_defaultOption, ctr["p_row"], ctr["p_column"], ctr.p_chart_selection_color, ctr.p_chart_id, ctr.p_chart_selection_id, ctr.p_chartStyle, ctr.p_rangeConfigCheck, ctr.p_rangeRowCheck, ctr.p_rangeColCheck, ctr.p_chartMarkConfig, ctr.p_chartTitleConfig, ctr.p_chartTheme);
                jfgrid.chartparam.jfgridInsertChartTosheetChange = true;
                jfgrid.chartparam.jfgrid_chart_redo_click = false;

                jfgrid.chartrangechange(ctr["p_row"], ctr["p_column"], ctr.p_sheetIndex, ctr.p_dataSheetIndex, ctr.p_chart_selection_id,ctr.p_rangeConfigCheck, ctr.p_rangeRowCheck, ctr.p_rangeColCheck, ctr.p_chart_id );

                if(!jfgrid.isEditMode()){
                    // $("#jfgrid-data-visualization").hide();
                    // jfgrid.jfgridsizeauto();
                    !!window.generator && generator.hideChartSettingComponent();
                }
            }
            else if (ctr.type == "updateChartType") {
                //console.log(ctr.p_chart_id);
                jfgrid.chartparam.jfgrid_chart_redo_click = true;
                jfgrid.chartparam.jfgridInsertChartTosheetChange = false;
                jfgrid.updateChartTosheet("updateChartType",ctr.p_sheetIndex, ctr.p_dataSheetIndex, ctr.p_option, ctr.p_chartType, ctr.p_selfOption, ctr.p_defaultOption, ctr["p_row"], ctr["p_column"], ctr.p_chart_selection_color, ctr.p_chart_id, ctr.p_chart_selection_id, ctr.p_chartStyle, ctr.p_rangeConfigCheck, ctr.p_rangeRowCheck, ctr.p_rangeColCheck, ctr.p_chartMarkConfig, ctr.p_chartTitleConfig, ctr.p_chartTheme);
                jfgrid.chartparam.jfgridInsertChartTosheetChange = true;
                jfgrid.chartparam.jfgrid_chart_redo_click = false;


                //jfgrid.chartrangechange(ctr["p_row"], ctr["p_column"], ctr.p_sheetIndex, ctr.p_dataSheetIndex, ctr.p_chart_selection_id,ctr.p_rangeConfigCheck, ctr.p_rangeRowCheck, ctr.p_rangeColCheck );

                jfgrid.chartTypeChange(ctr.p_chartType,ctr.p_selfOption,ctr.p_defaultOption,ctr.p_chartStyle,ctr.p_chartMarkConfig,ctr.p_chartTitleConfig,ctr.p_chart_id);

                if(!jfgrid.isEditMode()){
                    // $("#jfgrid-data-visualization").hide();
                    // jfgrid.jfgridsizeauto();
                    !!window.generator && generator.hideChartSettingComponent();
                }
            }
            else if (ctr.type == "updateChartTheme") {
                if(jfgrid.chartparam.jfgridcurrentChart!=null){
                    jfgrid.chartparam.jfgridcurrentChart.dispose();
                }

                var chartTheme = "default0000";
                if(ctr.p_chartTheme != null && ctr.p_chartTheme.length > 0 && jfgrid.getObjType(ctr.p_chartTheme) != "object" && ctr.p_chartTheme != "default0000"){
                    chartTheme = eval('('+ ctr.p_chartTheme +')');
                }

                jfgrid.chartparam.jfgridcurrentChart = jgridChart = echarts.init($("#" + ctr.p_chart_id).find(".jfgrid-modal-dialog-content").get(0), chartTheme);

                jfgrid.chartparam.jfgrid_chart_default_config = eval('('+ ctr.p_defaultOption +')');
                jfgrid.chartparam.jfgrid_chart_self_config = eval('('+ ctr.p_selfOption +')');
                var $t = $("#"+ctr.p_chart_id);
                jfgrid.chartparam.jfgrid_chart_redo_click = true;
                $t.mousedown();
                jfgrid.chartparam.jfgridCurrentChartMove = false;
                $t.mouseup();
                jfgrid.chartparam.jfgrid_chart_redo_click = false;

                jfgrid.chartparam.jfgridcurrentChart.setOption(jfgrid.chartparam.jfgrid_chart_default_config);
                jfgrid.chartparam.jfgridcurrentChart.setOption(jfgrid.jfgridChartConfigHanddle(ctr.p_chartType, "theme", jfgrid.chartparam.jfgrid_chart_self_config));

                // jfgrid.chartparam.jfgridcurrentChart.setOption(jfgrid.chartparam.jfgrid_chart_default_config);
                // jfgrid.chartparam.jfgridcurrentChart.setOption(jfgrid.jfgridChartConfigHanddle(jgridCurrentChartType.data("type"), "theme", jfgrid.chartparam.jfgrid_chart_self_config));

                $t.attr("chartTheme", ctr.p_chartTheme);

                if(jfgrid.server.allowUpdate){
                    jfgrid.server.saveParam("c", ctr.p_sheetIndex, {"chartTheme": ctr.p_chartTheme}, { "op": "update", "cid": ctr.p_chart_id});
                }

                if(!jfgrid.isEditMode()){
                    // $("#jfgrid-data-visualization").hide();
                    // jfgrid.jfgridsizeauto();
                    !!window.generator && generator.hideChartSettingComponent();
                }
            }
            else if (ctr.type == "updateChart") {
                //console.log(ctr.p_chart_id);
                jfgrid.chartparam.jfgridInsertChartTosheetChange = false;
                jfgrid.updateChartTosheet(ctr.p_sheetIndex, ctr.p_dataSheetIndex, ctr.p_option, ctr.p_chartType, ctr.p_selfOption, ctr.p_defaultOption, ctr["p_row"], ctr["p_column"], ctr.p_chart_selection_color, ctr.p_chart_id, ctr.p_chart_selection_id, ctr.p_chartStyle, ctr.p_rangeConfigCheck, ctr.p_rangeRowCheck, ctr.p_rangeColCheck, ctr.p_chartMarkConfig, ctr.p_chartTitleConfig, ctr.p_chartTheme);
                jfgrid.chartparam.jfgridInsertChartTosheetChange = true;

                if(!jfgrid.isEditMode()){
                    // $("#jfgrid-data-visualization").hide();
                    // jfgrid.jfgridsizeauto();
                    !!window.generator && generator.hideChartSettingComponent();
                }
            }
            else if (ctr.type == "updateChartAll") {
                //console.log(ctr.p_chart_id);
                var chart_json = ctr.pre_Chart_json;//取上一次的数据
                jfgrid.chartparam.jfgridInsertChartTosheetChange = false;
                !!window.generator && generator.patchVueSet(chart_json);
                !!window.generator && generator.generateChart(chart_json.defaultOption, chart_json.chartTheme, chart_json.chartAllType, $("#" + chart_json.chart_id).get(0));
                // !!window.store && store.commit("showNeedRangeShow",chart_json.chart_id);
                jfgrid.chartparam.jfgridInsertChartTosheetChange = true;
            }
            else if (ctr.type == "deleteChart") {
                //chartMix
                jfgrid.chartparam.jfgridInsertChartTosheetChange = false;
                !!window.store && store.commit("insertChart", ctr.chart_json);
                jfgrid.chartparam.jfgridInsertChartTosheetChange = true;
            }
            else if (ctr.type == "mergeChange") {
                jfgrid.jfrefreshgrid(ctr.data, ctr.range, ctr.config);
            }
            else if (ctr.type == "updateCF"){
                var historyRules = ctr["data"]["historyRules"];

                for(var i = 0; i < historyRules.length; i++){
                    //条件规则
                    var sheetIndex = historyRules[i]["sheetIndex"];
                    jfgridfile[jfgrid.sheetmanage.getSheetIndex(sheetIndex)]["jfgrid_conditionformat_save"] = historyRules[i]["jfgrid_conditionformat_save"];
                
                    if(jfgrid.server.allowUpdate){
                        jfgrid.server.saveParam("all", sheetIndex, historyRules[i]["jfgrid_conditionformat_save"], { "k": "jfgrid_conditionformat_save" });
                    }
                }

                //刷新一次表格
                jfgrid.conditionformat.ref();
            }
            else if (ctr.type == "updateAF"){
                var historyRules = ctr["data"]["historyRules"];

                var index = jfgrid.sheetmanage.getSheetIndex(ctr["sheetIndex"]);

                jfgridfile[index]["jfgrid_alternateformat_save"] = $.extend(true, [], historyRules);

                setTimeout(function () {
                    jfgrid.jfgridrefreshgrid();
                }, 1);
            }
            else if (ctr.type == "borderChange"){
                if(ctr.config["borderInfo"] == null){
                    jfgrid.server.saveParam("cg", ctr.sheetIndex, [], { "k": "borderInfo" });
                }
                else{
                    jfgrid.server.saveParam("cg", ctr.sheetIndex, ctr.config["borderInfo"], { "k": "borderInfo" });
                }

                config = ctr.config;
                jfgridfile[jfgrid.sheetmanage.getSheetIndex(ctr.sheetIndex)].config = config;

                setTimeout(function () {
                    jfgrid.jfgridrefreshgrid();
                }, 1);
            }
            else if (ctr.type == "postil"){
                jfgrid.postil.ref(ctr.data, ctr.rc);

                for(var i = 0; i < ctr.rc.length; i++){
                    var r = ctr.rc[i].split("_")[0];
                    var c = ctr.rc[i].split("_")[1];

                    if(ctr.data[r][c] != null && ctr.data[r][c].ps != null){
                        jfgrid.postil.buildPs(r, c, ctr.data[r][c].ps);
                    }
                    else{
                        jfgrid.postil.buildPs(r, c, null);
                    }
                }
            }
            
            jfgrid.cleargridelement(e);
            clearjfundo = true;
        },
        undo: function () {
            if (jfgrid.jfundo.length == 0) {
                return;
            }

            var ctr = jfgrid.jfundo.pop();
            jfgrid.jfredo.push(ctr);
            clearjfundo = false;

            if (jfgrid.sheetmanage.hasSheet(ctr.sheetIndex) && jfgrid.currentSheetIndex != ctr.sheetIndex) {
                jfgrid.sheetmanage.changeSheetExec(ctr.sheetIndex);
            }

            if (ctr.type == "datachange") {
                jfgrid.formula.execFunctionGroup();

                jfgrid.jfrefreshgrid(ctr.curdata, ctr.range, ctr.curConfig, ctr.curCdformat, ctr.RowlChange);
            }
            else if (ctr.type == "pasteCut") {
                jfgrid.jfrefreshgrid_pastcut(ctr.source, ctr.target, ctr.RowlChange);
            }
            else if (ctr.type == "cellchange") {
                jfgrid.formula.execFunctionGroup(ctr.uprow, ctr.upcolumn, ctr.curvalue);
                jfgrid.jfrefreshcell(ctr.curvalue, ctr.uprow, ctr.upcolumn);
            }
            else if (ctr.type == "rangechange") {
                jfgrid.formula.execFunctionGroup();
                jfgrid.jfrefreshrange(ctr.curdata, ctr.range, ctr.curCdformat);
            }
            else if (ctr.type == "resize") {
                config = ctr.curconfig;
                jfgridfile[jfgrid.sheetmanage.getSheetIndex(ctr.sheetIndex)].config = config;

                if(ctr.ctrlType == "resizeR"){
                    jfgrid.server.saveParam("cg", ctr.sheetIndex, ctr.curconfig["rowlen"], { "k": "rowlen" });
                }
                else if(ctr.ctrlType == "resizeC"){
                    jfgrid.server.saveParam("cg", ctr.sheetIndex, ctr.curconfig["columlen"], { "k": "columlen" });
                }

                jfgrid.jfrefreshgrid_rhcw(jfgrid.flowdata.length, jfgrid.flowdata[0].length);
            }
            else if (ctr.type == "cellRowChange") {
                jfgrid.jfrefreshgridall(ctr.curdata[0].length, ctr.curdata.length, ctr.curdata, ctr.curconfig, ctr.currange, ctr.ctrlType, ctr.ctrlValue, ctr.curCdformat);
            }
            else if (ctr.type == "extend") {
                jfgrid.jfrefreshgridall(ctr.curdata[0].length, ctr.curdata.length, ctr.curdata, ctr.curconfig, ctr.currange, ctr.ctrlType, ctr.ctrlValue);
            }
            else if (ctr.type == "dele") {
                var ctrlValue1 = $.extend(true, {}, ctr.ctrlValue);
                ctrlValue1.restore = true;
                jfgrid.jfrefreshgridall(ctr.curdata[0].length, ctr.curdata.length, ctr.curdata, ctr.curconfig, ctr.currange, ctr.ctrlType, ctr.ctrlValue);
            }
            else if (ctr.type == "addRC") { //增加行列重做操作
                jfgrid.jfrefreshgrid_adRC(ctr.curData, ctr.curConfig, "addRC", ctr.ctrlValue, ctr.curCalc, ctr.curFilterObj, ctr.curCf, ctr.curAf, ctr.curFreezen);
            }
            else if (ctr.type == "delRC") { //删除行列重做操作
                jfgrid.jfrefreshgrid_adRC(ctr.curData, ctr.curConfig, "delRC", ctr.ctrlValue, ctr.curCalc, ctr.curFilterObj, ctr.curCf, ctr.curAf, ctr.curFreezen);
            }
            else if (ctr.type == "datachangeAll") {
                jfgrid.formula.execFunctionGroup();
                jfgrid.jfrefreshgridall(ctr.curdata[0].length, ctr.curdata.length, ctr.curdata, null, ctr.currange, "datachangeAll", ctr.ctrlValue);
            }
            else if (ctr.type == "datachangeAll_filter_clear") {
                jfgrid.server.saveParam("fsc", jfgrid.currentSheetIndex, null);
                
                //config
                config = ctr.curconfig;
                jfgridfile[jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex)].config = config;

                jfgrid.server.saveParam("cg", jfgrid.currentSheetIndex, {}, { "k": "rowhidden" });

                //行高、列宽 刷新  
                jfgrid.jfrefreshgrid_rhcw(jfgrid.flowdata.length, jfgrid.flowdata[0].length);
                

                $("#jfgrid-filter-menu .jfgrid-filter-selected-input").hide().find("input").val();
                $("#jfgrid-filter-selected span").data("type", "0").data("type", null).text("无");

                $('#jfgrid-filter-selected-sheet' + jfgrid.currentSheetIndex + ', #jfgrid-filter-options-sheet' + jfgrid.currentSheetIndex).remove();
                $("#jfgrid-filter-menu, #jfgrid-filter-submenu").hide();
            }
            else if (ctr.type == "datachangeAll_filter") {
                var $top = $("#jfgrid-filter-options-sheet" + jfgrid.currentSheetIndex + " .jfgrid-filter-options").eq(ctr["optionsindex"]);
                var st_r = $top.data("str"), 
                    ed_r = $top.data("edr"), 
                    cindex = $top.data("cindex"), 
                    st_c = $top.data("stc"), 
                    ed_c = $top.data("edc");

                jfgrid.labelFilterOptionState($top, jfgrid.json.hasKey(ctr.rowhidden), ctr.rowhidden, ctr.caljs, true, st_r, ed_r, cindex, st_c, ed_c);

                //config
                config = ctr.curconfig;
                jfgridfile[jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex)].config = config;

                jfgrid.server.saveParam("cg", jfgrid.currentSheetIndex, config["rowhidden"], { "k": "rowhidden" });

                //行高、列宽 刷新  
                jfgrid.jfrefreshgrid_rhcw(jfgrid.flowdata.length, jfgrid.flowdata[0].length);

                // jfgrid.filterseletedbyindex(st_r, ed_r, st_c, ed_c);
                $("#jfgrid-filter-menu, #jfgrid-filter-submenu").hide();
            }
            else if (ctr.type == "filtershow") {
                jfgird_select_save = [ctr.filter_save];
                filterchage = false;
                jfgrid.createFilter();
                filterchage = true;
                jfgrid.server.saveParam("all", ctr.sheetIndex, ctr.filter_save, { "k": "filter_select" });
            }
            else if (ctr.type == "pivotTable_change") {
                jfgridfile[jfgrid.sheetmanage.getSheetIndex(ctr.sheetIndex)].pivotTable = ctr.pivotTablecur;
                //console.log(ctr.pivotTablecur);
                jfgrid.pivotTable.getCellData(ctr.sheetIndex);
                jfgrid.pivotTable.initialPivotManage(true);

                jfgrid.pivotTable.refreshPivotTable();
            }
            else if (ctr.type == "addSheet") {
                jfgrid.sheetmanage.createSheetbydata(ctr.sheetconfig);
                $("#jfgrid-input-box").removeAttr("style");
                $("#jfgrid-sheet-list, #jfgrid-rightclick-sheet-menu").hide();
            }
            else if (ctr.type == "copySheet") {
                jfgrid.sheetmanage.copySheet(ctr.copyindex);
            }
            else if (ctr.type == "deleteSheet") {
                jfgrid.sheetmanage.deleteSheet(ctr.index);
                if (ctr.order == 0) {
                    jfgrid.sheetmanage.changeSheetExec(jfgridfile[0].index);
                }
                else {
                    jfgrid.sheetmanage.changeSheetExec(jfgridfile[ctr.order - 1].index);
                }
                
                $("#jfgrid-input-box").removeAttr("style");
                $("#jfgrid-sheet-list, #jfgrid-rightclick-sheet-menu").hide();
            }
            else if (ctr.type == "sheetName") {
                jfgridfile[jfgrid.sheetmanage.getSheetIndex(ctr.sheetIndex)].name = ctr.txt;
                $("#jfgrid-sheets-item" + ctr.sheetIndex).find(".jfgrid-sheets-item-name").html(ctr.txt);
                
                jfgrid.server.saveParam("all", ctr.sheetIndex, ctr.txt, { "k": "name" });
            }
            else if (ctr.type == "sheetColor") {
                jfgridfile[jfgrid.sheetmanage.getSheetIndex(ctr.sheetIndex)].color = ctr.color;

                var jfgridcurrentSheetitem = $("#jfgrid-sheets-item" + ctr.sheetIndex);
                jfgridcurrentSheetitem.find(".jfgrid-sheets-item-color").remove();
                
                if(ctr.color != null){
                    jfgridcurrentSheetitem.append('<div class="jfgrid-sheets-item-color" style=" position: absolute; width: 100%; height: 3px; bottom: 0px; left: 0px; background-color: ' + ctr.color + ';"></div>');
                }
                
                jfgrid.server.saveParam("all", ctr.sheetIndex, ctr.color, { "k": "color" });
            }
            else if (ctr.type == "insertChart") {
                //chartMix
                jfgrid.chartparam.jfgridInsertChartTosheetChange = false;
                !!window.store && store.commit("insertChart", ctr.chart_json);
                jfgrid.chartparam.jfgridInsertChartTosheetChange = true;
            }
            else if (ctr.type == "moveChart") {
                $("#" + ctr.chart_id + "_c").css({ "top": ctr.myTop, "left": ctr.myLeft });
                $("#jfgrid-scrollbar-y").scrollTop(ctr.scrollTop);
                $("#jfgrid-scrollbar-x").scrollLeft(ctr.scrollLeft);
                !!window.store && store.commit({
                    type:"updateChartItem",
                    key:"left",
                    value:ctr.myLeft,
                    chartId:ctr.chart_id
                });

                !!window.store && store.commit({
                    type:"updateChartItem",
                    key:"top",
                    value:ctr.myTop,
                    chartId:ctr.chart_id
                });
                
                jfgrid.server.saveParam("c", ctr.sheetIndex, { "left":ctr.myLeft, "left":ctr.myTop, "scrollTop": ctr.scrollTop, "scrollLeft": ctr.scrollLeft  }, { "op":"xy", "cid": ctr.chart_id});
                // jfgrid.server.saveParam("c", ctr.sheetIndex, { "left":ctr.myLeft, "top":ctr.myTop }, { "op":"xy", "cid": ctr.chart_id});
            }
            else if (ctr.type == "resizeChart") {
                $("#" + ctr.chart_id + "_c").css({ "height": ctr.myHeight, "width": ctr.myWidth,"top": ctr.myTop, "left": ctr.myLeft });
                $("#jfgrid-scrollbar-y").scrollTop(ctr.scrollTop);
                $("#jfgrid-scrollbar-x").scrollLeft(ctr.scrollLeft);

                !!window.store && store.commit({
                    type:"updateChartItem",
                    key:"height",
                    value:ctr.myHeight,
                    chartId:ctr.chart_id
                });

                !!window.store && store.commit({
                    type:"updateChartItem",
                    key:"width",
                    value:ctr.myWidth,
                    chartId:ctr.chart_id
                });

                !!window.store && store.commit({
                    type:"updateChartItem",
                    key:"left",
                    value:ctr.myLeft,
                    chartId:ctr.chart_id
                });

                !!window.store && store.commit({
                    type:"updateChartItem",
                    key:"top",
                    value:ctr.myTop,
                    chartId:ctr.chart_id
                });

                !!window.generator && generator.resize(ctr.chart_id);
                jfgrid.server.saveParam("c", ctr.sheetIndex, { "width":ctr.myWidth, "height":ctr.myHeight,"top":  ctr.myTop, "left": ctr.myLeft, "scrollTop": ctr.scrollTop, "scrollLeft": ctr.scrollLeft  }, { "op":"wh", "cid": ctr.chart_id});
            }
            else if (ctr.type == "updateChartRange") {
                //console.log(ctr.p_chart_id);
                jfgrid.chartparam.jfgrid_chart_redo_click = true;
                jfgrid.chartparam.jfgridInsertChartTosheetChange = false;
                jfgrid.updateChartTosheet("updateChartRange",ctr.sheetIndex, ctr.dataSheetIndex, ctr.option, ctr.chartType, ctr.selfOption, ctr.defaultOption, ctr["row"], ctr["column"], ctr.chart_selection_color, ctr.chart_id, ctr.chart_selection_id, ctr.chartStyle, ctr.rangeConfigCheck, ctr.rangeRowCheck, ctr.rangeColCheck, ctr.chartMarkConfig, ctr.chartTitleConfig, ctr.chartTheme);
                jfgrid.chartparam.jfgridInsertChartTosheetChange = true;
                jfgrid.chartparam.jfgrid_chart_redo_click = false;

                jfgrid.chartrangechange(ctr["row"], ctr["column"], ctr.sheetIndex, ctr.dataSheetIndex, ctr.chart_selection_id,ctr.rangeConfigCheck, ctr.rangeRowCheck, ctr.rangeColCheck, ctr.chart_id);

                // $("#jfgrid-data-visualization").hide();
                // jfgrid.jfgridsizeauto();
                !!window.generator && generator.hideChartSettingComponent();

            }
            else if (ctr.type == "updateChartType") {
                //console.log(ctr.p_chart_id);
                jfgrid.chartparam.jfgrid_chart_redo_click = true;
                jfgrid.chartparam.jfgridInsertChartTosheetChange = false;
                jfgrid.updateChartTosheet("updateChartType",ctr.sheetIndex, ctr.dataSheetIndex, ctr.option, ctr.chartType, ctr.selfOption, ctr.defaultOption, ctr["row"], ctr["column"], ctr.chart_selection_color, ctr.chart_id, ctr.chart_selection_id, ctr.chartStyle, ctr.rangeConfigCheck, ctr.rangeRowCheck, ctr.rangeColCheck, ctr.chartMarkConfig, ctr.chartTitleConfig, ctr.chartTheme);
                jfgrid.chartparam.jfgridInsertChartTosheetChange = true;
                jfgrid.chartparam.jfgrid_chart_redo_click = false;

                //jfgrid.chartrangechange(ctr["p_row"], ctr["p_column"], ctr.p_sheetIndex, ctr.p_dataSheetIndex, ctr.p_chart_selection_id,ctr.p_rangeConfigCheck, ctr.p_rangeRowCheck, ctr.p_rangeColCheck );

                jfgrid.chartTypeChange(ctr.chartType,ctr.selfOption,ctr.defaultOption,ctr.chartStyle,ctr.chartMarkConfig,ctr.chartTitleConfig,ctr.chart_id);

                // $("#jfgrid-data-visualization").hide();
                // jfgrid.jfgridsizeauto();
                !!window.generator && generator.hideChartSettingComponent();

            }
            else if (ctr.type == "updateChartTheme") {
                if(jfgrid.chartparam.jfgridcurrentChart!=null){
                    jfgrid.chartparam.jfgridcurrentChart.dispose();
                }

                var chartTheme = "default0000";
                if(ctr.chartTheme != null && ctr.chartTheme.length > 0 && jfgrid.getObjType(ctr.chartTheme) != "object" && ctr.chartTheme != "default0000"){
                    chartTheme = eval('(' + ctr.chartTheme + ')');
                }

                jfgrid.chartparam.jfgridcurrentChart = jgridChart = echarts.init($("#" + ctr.chart_id).find(".jfgrid-modal-dialog-content").get(0), chartTheme);

                jfgrid.chartparam.jfgrid_chart_default_config = eval('('+ ctr.defaultOption +')');
                jfgrid.chartparam.jfgrid_chart_self_config = eval('('+ ctr.selfOption +')');
                var $t = $("#" + ctr.chart_id);
                jfgrid.chartparam.jfgrid_chart_redo_click = true;
                $t.mousedown();
                jfgrid.chartparam.jfgridCurrentChartMove = false;
                $t.mouseup();
                jfgrid.chartparam.jfgrid_chart_redo_click = false;

                jfgrid.chartparam.jfgridcurrentChart.setOption(jfgrid.chartparam.jfgrid_chart_default_config);
                jfgrid.chartparam.jfgridcurrentChart.setOption(jfgrid.jfgridChartConfigHanddle(ctr.chartType, "theme", jfgrid.chartparam.jfgrid_chart_self_config));

                // jfgrid.chartparam.jfgridcurrentChart.setOption(jfgrid.chartparam.jfgrid_chart_default_config);
                // jfgrid.chartparam.jfgridcurrentChart.setOption(jfgrid.jfgridChartConfigHanddle(jgridCurrentChartType.data("type"), "theme", jfgrid.chartparam.jfgrid_chart_self_config));

                $t.attr("chartTheme", ctr.chartTheme);
                jfgrid.server.saveParam("c", ctr.sheetIndex, {"chartTheme": ctr.chartTheme}, { "op": "update", "cid": ctr.chart_id});

                // $("#jfgrid-data-visualization").hide();
                // jfgrid.jfgridsizeauto();
                !!window.generator && generator.hideChartSettingComponent();

            }
            else if (ctr.type == "updateChart") {
                jfgrid.chartparam.jfgridInsertChartTosheetChange = false;
                jfgrid.updateChartTosheet(ctr.sheetIndex, ctr.dataSheetIndex, ctr.option, ctr.chartType, ctr.selfOption, ctr.defaultOption, ctr["row"], ctr["column"], ctr.chart_selection_color, ctr.chart_id, ctr.chart_selection_id, ctr.chartStyle, ctr.rangeConfigCheck, ctr.rangeRowCheck, ctr.rangeColCheck, ctr.chartMarkConfig, ctr.chartTitleConfig, ctr.chartTheme);
                jfgrid.chartparam.jfgridInsertChartTosheetChange = true;

                // $("#jfgrid-data-visualization").hide();
                // jfgrid.jfgridsizeauto();
                !!window.generator && generator.hideChartSettingComponent();
            }
            else if (ctr.type == "updateChartAll") {
                //console.log(ctr.p_chart_id);
                var chart_json = ctr.chart_json;//取下一次的数据
                jfgrid.chartparam.jfgridInsertChartTosheetChange = false;
                !!window.generator && generator.patchVueSet(chart_json);
                !!window.generator && generator.generateChart(chart_json.defaultOption, chart_json.chartTheme, chart_json.chartAllType, $("#" + chart_json.chart_id).get(0));
                // !!window.store && store.commit("showNeedRangeShow",chart_json.chart_id);
                jfgrid.chartparam.jfgridInsertChartTosheetChange = true;
            }
            else if (ctr.type == "deleteChart") {
                //chartMix
                jfgrid.chartparam.jfgridInsertChartTosheetChange = false;
                !!window.store && store.commit("deleteChart",ctr.chart_json.chart_id);//同步store中数据
                jfgrid.chartparam.jfgridInsertChartTosheetChange = true;
            }
            else if (ctr.type == "mergeChange") {
                jfgrid.jfrefreshgrid(ctr.curData, ctr.range, ctr.curConfig);
            }
            else if (ctr.type == "updateCF"){
                var currentRules = ctr["data"]["currentRules"];

                for(var i = 0; i < currentRules.length; i++){
                    //条件规则
                    var sheetIndex = currentRules[i]["sheetIndex"];
                    jfgridfile[jfgrid.sheetmanage.getSheetIndex(sheetIndex)]["jfgrid_conditionformat_save"] = currentRules[i]["jfgrid_conditionformat_save"];
                    
                    if(jfgrid.server.allowUpdate){
                        jfgrid.server.saveParam("all", sheetIndex, currentRules[i]["jfgrid_conditionformat_save"], { "k": "jfgrid_conditionformat_save" });
                    }
                }

                //刷新一次表格
                jfgrid.conditionformat.ref();
            }
            else if (ctr.type == "updateAF"){
                var currentRules = ctr["data"]["currentRules"];

                var index = jfgrid.sheetmanage.getSheetIndex(ctr["sheetIndex"]);

                jfgridfile[index]["jfgrid_alternateformat_save"] = $.extend(true, [], currentRules);

                setTimeout(function () {
                    jfgrid.jfgridrefreshgrid();
                }, 1);
            }
            else if (ctr.type == "borderChange"){
                jfgrid.server.saveParam("cg", ctr.sheetIndex, ctr.curconfig["borderInfo"], { "k": "borderInfo" });

                config = ctr.curconfig;
                jfgridfile[jfgrid.sheetmanage.getSheetIndex(ctr.sheetIndex)].config = config;

                setTimeout(function () {
                    jfgrid.jfgridrefreshgrid();
                }, 1);
            }
            else if (ctr.type == "postil"){
                jfgrid.postil.ref(ctr.curdata, ctr.rc);

                for(var i = 0; i < ctr.rc.length; i++){
                    var r = ctr.rc[i].split("_")[0];
                    var c = ctr.rc[i].split("_")[1];

                    if(ctr.curdata[r][c] != null && ctr.curdata[r][c].ps != null){
                        jfgrid.postil.buildPs(r, c, ctr.curdata[r][c].ps);
                    }
                    else{
                        jfgrid.postil.buildPs(r, c, null);
                    }
                }
            }
            
            clearjfundo = true;
        }
    };

    jfgrid.editor = {
        //worker+blob实现深拷贝替换extend
        deepCopyFlowDataState:false,
        deepCopyFlowDataCache:"",
        deepCopyFlowDataWorker:null,
        deepCopyFlowData:function(flowData){
            var _this = this;
            if(_this.deepCopyFlowDataState){
                if(_this.deepCopyFlowDataWorker != null){
                    _this.deepCopyFlowDataWorker.terminate();  
                }
                return _this.deepCopyFlowDataCache;
            }
            else{
                if(flowData == null){
                    flowData = jfgrid.flowdata;
                }

                return $.extend(true, [], flowData);
            }
        },
        webWorkerFlowDataCache:function(flowData){
            var _this = this;

            try{
                if(_this.deepCopyFlowDataWorker != null){//存新的webwork前先销毁以前的
                    _this.deepCopyFlowDataWorker.terminate();
                }

                var funcTxt = 'data:text/javascript;chartset=US-ASCII,onmessage = function (e) { postMessage(e.data); };';
                _this.deepCopyFlowDataState = false;
                //var worker_blob = new Blob([funcTxt]);

                //适配IE
                if(jfgrid.browser.isIE() == 1){
                    var response = "self.onmessage=function(e){postMessage(e.data);}";
                    var worker = new Worker('./plugins/Worker-helper.js');
                    worker.postMessage(response);
                }else{
                    var worker = new Worker(funcTxt);
                }

                _this.deepCopyFlowDataWorker = worker;
                worker.postMessage(flowData);
                worker.onmessage = function(e) { 
                    _this.deepCopyFlowDataCache = e.data;
                    _this.deepCopyFlowDataState = true;
                };
            }
            catch(e){
                _this.deepCopyFlowDataCache = $.extend(true,[],flowData);
            }
        },
        // webWorkerFlowDataCache:function(flowData){
        //     var _this = this;
        //     _this.deepCopyFlowDataState = false;
        //     var funcTxt = 'data:text/javascript;chartset=US-ASCII,onmessage = function (e) { postMessage(e.data); };';
        //     //var worker_blob = new Blob([funcTxt]); 
        //     var worker = new Worker(funcTxt);
        //     _this.deepCopyFlowDataWorker = worker;
        //     worker.postMessage(flowData);
        //     worker.onmessage = function(e) { 
        //         _this.deepCopyFlowDataCache = e.data;
        //         console.log("onmessage: e.data",e.data);
        //         _this.deepCopyFlowDataState = true;
        //         //_this.deepCopyFlowDataWorker = null;
        //         worker.terminate();
        //     };

        // },
        controlHandler: function (dataChe) {
            var d = jfgrid.editor.deepCopyFlowData(jfgrid.flowdata);//取数据

            var last = jfgird_select_save[jfgird_select_save.length - 1];
            var curR = last["row"] == null ? 0 : last["row"][0];
            var curC = last["column"] == null ? 0 : last["column"][0];
            var rlen = dataChe.length, clen = dataChe[0].length;

            var addr = curR + rlen - d.length, addc = curC + clen - d[0].length;
            if(addr > 0 || addc > 0){
                d = jfgrid.datagridgrowth([].concat(d), addr, addc, true);
            }

            for (var r = 0; r < rlen; r++) {
                var x = [].concat(d[r + curR]);
                for (var c = 0; c < clen; c++) {
                    var value = "";
                    if (dataChe[r] != null && dataChe[r][c] != null) {
                        value = dataChe[r][c];
                    }
                    x[c + curC] = value;
                }
                d[r + curR] = x;
            }

            if (addr > 0 || addc > 0) {
                jfgrid.jfrefreshgridall(d[0].length, d.length, d, null, jfgird_select_save, "datachangeAll");
            }
            else {
                jfgrid.jfrefreshrange(d, jfgird_select_save);
            }
        },
        clearRangeByindex: function (st_r, ed_r, st_c, ed_c, sheetIndex) {
            var index = jfgrid.sheetmanage.getSheetIndex(sheetIndex);
            var d = $.extend(true, [], jfgridfile[index]["data"]);
            
            for (var r = st_r; r <= ed_r; r++) {
                var x = [].concat(d[r]);
                for (var c = st_c; c <= ed_c; c++) {
                    jfgrid.formula.delFunctionGroup(r, c);
                    jfgrid.formula.execFunctionGroup(r, c, "");
                    //var value = "";
                    //if (dataChe[r] != null && dataChe[r][c] != null) {
                    //    value = dataChe[r][c];
                    //}
                    x[c] = null;
                }
                d[r] = x;
            }

            //jfgrid.flowdata = flowdata_new = data;

            if(sheetIndex == jfgrid.currentSheetIndex){
                var rlen = ed_r - st_r + 1, clen = ed_c - st_c + 1;
                if (rlen > 5000) {
                    jfgrid.jfrefreshgrid(d, st_r, ed_r, st_c, ed_c);
                }
                else {
                    jfgrid.jfrefreshrange(d, { "row": [st_r, ed_r], "column": [st_c, ed_c] });
                }
            }
            else{
                jfgridfile[index]["data"] = d;
            }
        },
        controlHandlerD: function (dataChe) {
            var d = jfgrid.editor.deepCopyFlowData(jfgrid.flowdata);//取数据

            var last = jfgird_select_save[jfgird_select_save.length - 1];
            var r1 = last["row"][0], r2 = last["row"][1];
            var c1 = last["column"][0], c2 = last["column"][1];
            var rlen = dataChe.length, clen = dataChe[0].length;

            var addr = r1 + rlen - d.length, addc = c1 + clen - d[0].length;
            if(addr >0 || addc > 0){
                d = jfgrid.datagridgrowth([].concat(d), addr, addc, true);
            }

            for(var r = r1; r <= r2; r++){
                for(var c = c1; c <= c2; c++){
                    d[r][c] = null;
                }
            }

            for(var i = 0; i < rlen; i++){
                for(var j = 0; j < clen; j++){
                    d[r1 + i][c1 + j] = dataChe[i][j];
                }
            }

            var range = [
                { "row": [r1, r2], "column": [c1, c2] },
                { "row": [r1, r1 + rlen - 1], "column": [c1, c1 + clen - 1] }
            ];

            jfgrid.jfrefreshgrid(d, range);
        }
    };

    jfgrid.selection = {
        clearcopy: function (e) {
            var clipboardData = window.clipboardData; //for IE
            if (!clipboardData) { // for chrome
                if (!!e) {
                    clipboardData = e.originalEvent.clipboardData;
                }
            }
            var cpdata = " ";
            copyType = "normal";
            copysetting = [];

            jfgrid_selection_range = [];
            jfgrid.selectionCopyShow();
            jfgrid_copy_save = {};
            
            if (!clipboardData) {
                var textarea = $("#jfgird-copy-content").css("visibility", "hidden");
                textarea.val(cpdata);
                textarea.focus();
                textarea.select();
                // 等50毫秒，keyPress事件发生了再去处理数据
                setTimeout(function () { textarea.blur().css("visibility", "visible"); }, 10);
            }
            else {
                //e.clipboardData.getData('text');//可以获取用户选中复制的数据
                clipboardData.setData('Text', cpdata);
                return false;//否则设不生效
            }
        },
        getHtmlBorderStyle:function(type, color){
            var style = "";
            var borderType = {"0":"none", "1":"Thin", "2":"Hair", "3":"Dotted", "4":"Dashed", "5":"DashDot", "6":"DashDotDot", "7":"Double", "8":"Medium", "9":"MediumDashed", "10":"MediumDashDot", "11":"MediumDashDotDot", "12":"SlantedDashDot", "13":"Thick"};
            type = borderType[type.toString()];

            if(type.indexOf("Medium") > -1){
                style += "1pt ";
            }
            else if(type == "Thick"){
                style += "1.5pt ";
            }
            else {
                style += "0.5pt ";    
            }

            if(type == "Hair"){
                style += "double ";
            }
            else if(type.indexOf("DashDotDot") > -1){
                style += "dotted ";
            }
            else if(type.indexOf("DashDot") > -1){
                style += "dashed ";
            }
            else if(type.indexOf("Dotted") > -1){
                style += "dotted "; 
            }
            else if(type.indexOf("Dashed") > -1){
                style += "dashed ";
            }
            else{
                style += "solid ";
            }

            return style + color + ";";
        },
        copy: function (e) {//copy事件
            var clipboardData = window.clipboardData; //for IE
            if (!clipboardData) { // for chrome
                clipboardData = e.originalEvent.clipboardData;
            }

            jfgrid_selection_range = [];
            //copy范围
            var minR = jfgird_select_save[0].row[0], maxR = jfgird_select_save[0].row[1];
            var minC = jfgird_select_save[0].column[0], maxC = jfgird_select_save[0].column[1];
            var copyRange = [], RowlChange = false, HasMC = false;
            for(var s = 0; s < jfgird_select_save.length; s++){
                if(jfgird_select_save[s].row[0] < minR){
                    minR = jfgird_select_save[s].row[0];
                }

                if(jfgird_select_save[s].row[1] > maxR){
                    maxR = jfgird_select_save[s].row[1];
                }

                if(jfgird_select_save[s].column[0] < minC){
                    minC = jfgird_select_save[s].column[0];
                }

                if(jfgird_select_save[s].column[1] > maxC){
                    maxC = jfgird_select_save[s].column[1];
                }

                for(var copyR = jfgird_select_save[s].row[0]; copyR <= jfgird_select_save[s].row[1]; copyR++){
                    if (config["rowhidden"] != null && config["rowhidden"][copyR] != null) {
                        continue;
                    }

                    if (config["rowlen"] != null && (copyR in config["rowlen"])){
                        RowlChange = true;
                    }

                    for(var copyC = jfgird_select_save[s].column[0]; copyC <= jfgird_select_save[s].column[1]; copyC++){
                        var cell = jfgrid.flowdata[copyR][copyC];

                        if(jfgrid.getObjType(cell) == "object" && ("mc" in cell) && cell.mc.rs != null){
                            HasMC = true;
                        }
                    }
                }

                jfgrid_selection_range.push({ "row": jfgird_select_save[s].row, "column": jfgird_select_save[s].column });
                copyRange.push({ "row": jfgird_select_save[s].row, "column": jfgird_select_save[s].column });
            }

            jfgrid.selectionCopyShow();

            //qksheet内copy保存
            jfgrid_copy_save = { 
                "dataSheetIndex": jfgrid.currentSheetIndex, 
                "copyRange": copyRange, 
                "RowlChange": RowlChange, 
                "HasMC": HasMC 
            };

            //copy范围数据拼接成table 赋给剪贴板
            var _this = this;
            
            if(config["borderInfo"] && config["borderInfo"].length > 0){ //边框
                var borderInfoCompute = jfgrid.getBorderInfoCompute();
            }

            var cpdata = "", d = jfgrid.editor.deepCopyFlowData(jfgrid.flowdata);
            var r_first = !0, c_first = !0, colgroup = "";
            for (var r = minR; r <= maxR; r++) {
                var row = [];
                if (config["rowhidden"] != null && config["rowhidden"][r] != null) {
                    continue;
                }
                cpdata += '<tr>';

                for (var c = minC; c <= maxC; c++) {
                    var column = '<td ${span} style="${style}">';

                    if (d[r] != null && d[r][c] != null) {
                        var style = "", span = "";

                        if(r == minR){
                            if(config == null || config["columlen"] == null || config["columlen"][c.toString()] == null){
                                colgroup += '<colgroup width="72px"></colgroup>';
                            }
                            else {
                                colgroup += '<colgroup width="'+ config["columlen"][c.toString()] +'px"></colgroup>';
                            }
                        }

                        if(c == minC){
                            if(config == null || config["rowlen"] == null || config["rowlen"][r.toString()] == null){
                                style += 'height:19px;';
                            }
                            else {
                                style += 'height:'+ config["rowlen"][r.toString()] + 'px;';
                            }
                        }

                        var reg = /^(w|W)((0?)|(0\.0+))$/;
                        var c_value;
                        if(d[r][c].ct != null && d[r][c].ct.fa != null && d[r][c].ct.fa.match(reg)){
                            c_value = jfgrid.getcellvalue(r, c, d);
                        }
                        else{
                            c_value = jfgrid.getcellvalue(r, c, d, "m");
                        }

                        style += jfgrid.menuButton.getStyleByCell(d, r, c);

                        if(jfgrid.getObjType(d[r][c]) == "object" && ("mc" in d[r][c])){
                            if("rs" in d[r][c]["mc"]){
                                span = 'rowspan="'+ d[r][c]["mc"].rs +'" colspan="'+ d[r][c]["mc"].cs +'"';

                                //边框
                                if(borderInfoCompute && borderInfoCompute[r + "_" + c]){
                                    var bl_obj = { "color": {}, "style": {} }, 
                                        br_obj = { "color": {}, "style": {} }, 
                                        bt_obj = { "color": {}, "style": {} }, 
                                        bb_obj = { "color": {}, "style": {} };

                                    for(var bd_r = r; bd_r < (r + d[r][c]["mc"].rs); bd_r++){
                                        for(var bd_c = c; bd_c < (c + d[r][c]["mc"].cs); bd_c++){
                                            if(bd_r == r && borderInfoCompute[bd_r + "_" + bd_c] && borderInfoCompute[bd_r + "_" + bd_c].t){
                                                var linetype = borderInfoCompute[bd_r + "_" + bd_c].t.style;
                                                var bcolor = borderInfoCompute[bd_r + "_" + bd_c].t.color;

                                                if(bt_obj["style"][linetype] == null){
                                                    bt_obj["style"][linetype] = 1;
                                                }
                                                else{
                                                    bt_obj["style"][linetype] = bt_obj["style"][linetype] + 1;
                                                }

                                                if(bt_obj["color"][bcolor] == null){
                                                    bt_obj["color"][bcolor] = 1;
                                                }
                                                else{
                                                    bt_obj["color"][bcolor] = bt_obj["color"][bcolor] + 1;
                                                }
                                            }

                                            if(bd_r == (r + d[r][c]["mc"].rs - 1) && borderInfoCompute[bd_r + "_" + bd_c] && borderInfoCompute[bd_r + "_" + bd_c].b){
                                                var linetype = borderInfoCompute[bd_r + "_" + bd_c].b.style;
                                                var bcolor = borderInfoCompute[bd_r + "_" + bd_c].b.color;

                                                if(bb_obj["style"][linetype] == null){
                                                    bb_obj["style"][linetype] = 1;
                                                }
                                                else{
                                                    bb_obj["style"][linetype] = bb_obj["style"][linetype] + 1;
                                                }

                                                if(bb_obj["color"][bcolor] == null){
                                                    bb_obj["color"][bcolor] = 1;
                                                }
                                                else{
                                                    bb_obj["color"][bcolor] = bb_obj["color"][bcolor] + 1;
                                                }
                                            }

                                            if(bd_c == c && borderInfoCompute[bd_r + "_" + bd_c] && borderInfoCompute[bd_r + "_" + bd_c].l){
                                                var linetype = borderInfoCompute[r + "_" + c].l.style;
                                                var bcolor = borderInfoCompute[bd_r + "_" + bd_c].l.color;
                                                
                                                if(bl_obj["style"][linetype] == null){
                                                    bl_obj["style"][linetype] = 1;
                                                }
                                                else{
                                                    bl_obj["style"][linetype] = bl_obj["style"][linetype] + 1;
                                                }

                                                if(bl_obj["color"][bcolor] == null){
                                                    bl_obj["color"][bcolor] = 1;
                                                }
                                                else{
                                                    bl_obj["color"][bcolor] = bl_obj["color"][bcolor] + 1;
                                                }
                                            }

                                            if(bd_c == (c + d[r][c]["mc"].cs - 1) && borderInfoCompute[bd_r + "_" + bd_c] && borderInfoCompute[bd_r + "_" + bd_c].r){
                                                var linetype = borderInfoCompute[bd_r + "_" + bd_c].r.style;
                                                var bcolor = borderInfoCompute[bd_r + "_" + bd_c].r.color;

                                                if(br_obj["style"][linetype] == null){
                                                    br_obj["style"][linetype] = 1;
                                                }
                                                else{
                                                    br_obj["style"][linetype] = br_obj["style"][linetype] + 1;
                                                }

                                                if(br_obj["color"][bcolor] == null){
                                                    br_obj["color"][bcolor] = 1;
                                                }
                                                else{
                                                    br_obj["color"][bcolor] = br_obj["color"][bcolor] + 1;
                                                }
                                            }
                                        }
                                    }

                                    var rowlen = d[r][c]["mc"].rs, collen = d[r][c]["mc"].cs;

                                    if(JSON.stringify(bl_obj).length > 23){
                                        var bl_color = null, bl_style = null;

                                        for(x in bl_obj.color){
                                            if(bl_obj.color[x] >= (rowlen / 2)){
                                                bl_color = x;
                                            }
                                        }

                                        for(x in bl_obj.style){
                                            if(bl_obj.style[x] >= (rowlen / 2)){
                                                bl_style = x;
                                            }
                                        }

                                        if(bl_color != null && bl_style != null){
                                            style += "border-left:" + _this.getHtmlBorderStyle(bl_style, bl_color);
                                        }
                                    }

                                    if(JSON.stringify(br_obj).length > 23){
                                        var br_color = null, br_style = null;

                                        for(x in br_obj.color){
                                            if(br_obj.color[x] >= (rowlen / 2)){
                                                br_color = x;
                                            }
                                        }

                                        for(x in br_obj.style){
                                            if(br_obj.style[x] >= (rowlen / 2)){
                                                br_style = x;
                                            }
                                        }

                                        if(br_color != null && br_style != null){
                                            style += "border-right:" + _this.getHtmlBorderStyle(br_style, br_color);
                                        }
                                    }

                                    if(JSON.stringify(bt_obj).length > 23){
                                        var bt_color = null, bt_style = null;

                                        for(x in bt_obj.color){
                                            if(bt_obj.color[x] >= (collen / 2)){
                                                bt_color = x;
                                            }
                                        }

                                        for(x in bt_obj.style){
                                            if(bt_obj.style[x] >= (collen / 2)){
                                                bt_style = x;
                                            }
                                        }

                                        if(bt_color != null && bt_style != null){
                                            style += "border-top:" + _this.getHtmlBorderStyle(bt_style, bt_color);
                                        }
                                    }

                                    if(JSON.stringify(bb_obj).length > 23){
                                        var bb_color = null, bb_style = null;

                                        for(x in bb_obj.color){
                                            if(bb_obj.color[x] >= (collen / 2)){
                                                bb_color = x;
                                            }
                                        }

                                        for(x in bb_obj.style){
                                            if(bb_obj.style[x] >= (collen / 2)){
                                                bb_style = x;
                                            }
                                        }

                                        if(bb_color != null && bb_style != null){
                                            style += "border-bottom:" + _this.getHtmlBorderStyle(bb_style, bb_color);
                                        }
                                    }
                                }
                            }
                            else{
                                continue;
                            }
                        }
                        else{
                            //边框
                            if(borderInfoCompute && borderInfoCompute[r + "_" + c]){
                                //左边框
                                if(borderInfoCompute[r + "_" + c].l){
                                    var linetype = borderInfoCompute[r + "_" + c].l.style;
                                    var bcolor = borderInfoCompute[r + "_" + c].l.color;
                                    style += "border-left:" + _this.getHtmlBorderStyle(linetype, bcolor);
                                }

                                //右边框
                                if(borderInfoCompute[r + "_" + c].r){
                                    var linetype = borderInfoCompute[r + "_" + c].r.style;
                                    var bcolor = borderInfoCompute[r + "_" + c].r.color;
                                    style += "border-right:" + _this.getHtmlBorderStyle(linetype, bcolor);
                                }

                                //下边框
                                if(borderInfoCompute[r + "_" + c].b){
                                    var linetype = borderInfoCompute[r + "_" + c].b.style;
                                    var bcolor = borderInfoCompute[r + "_" + c].b.color;
                                    style += "border-bottom:" + _this.getHtmlBorderStyle(linetype, bcolor);
                                }

                                //上边框
                                if(borderInfoCompute[r + "_" + c].t){
                                    var linetype = borderInfoCompute[r + "_" + c].t.style;
                                    var bcolor = borderInfoCompute[r + "_" + c].t.color;
                                    style += "border-top:" + _this.getHtmlBorderStyle(linetype, bcolor);
                                }
                            }
                        }

                        column = jfgrid.replaceHtml(column, {"style":style, "span":span});

                        if(c_value == null){
                            c_value = jfgrid.getcellvalue(r, c, d);
                        }

                        if(c_value == null){
                            c_value = "";
                        }
                        column += c_value;
                    }
                    else {
                        var style = "";
                        
                        //边框
                        if(borderInfoCompute && borderInfoCompute[r + "_" + c]){
                            //左边框
                            if(borderInfoCompute[r + "_" + c].l){
                                var linetype = borderInfoCompute[r + "_" + c].l.style;
                                var bcolor = borderInfoCompute[r + "_" + c].l.color;
                                style += "border-left:" + _this.getHtmlBorderStyle(linetype, bcolor);
                            }

                            //右边框
                            if(borderInfoCompute[r + "_" + c].r){
                                var linetype = borderInfoCompute[r + "_" + c].r.style;
                                var bcolor = borderInfoCompute[r + "_" + c].r.color;
                                style += "border-right:" + _this.getHtmlBorderStyle(linetype, bcolor);
                            }

                            //下边框
                            if(borderInfoCompute[r + "_" + c].b){
                                var linetype = borderInfoCompute[r + "_" + c].b.style;
                                var bcolor = borderInfoCompute[r + "_" + c].b.color;
                                style += "border-bottom:" + _this.getHtmlBorderStyle(linetype, bcolor);
                            }

                            //上边框
                            if(borderInfoCompute[r + "_" + c].t){
                                var linetype = borderInfoCompute[r + "_" + c].t.style;
                                var bcolor = borderInfoCompute[r + "_" + c].t.color;
                                style += "border-top:" + _this.getHtmlBorderStyle(linetype, bcolor);
                            }
                        }

                        column += "";
                        if(r == minR){
                            if(config == null || config["columlen"] == null || config["columlen"][c.toString()] == null){
                                colgroup += '<colgroup width="72px"></colgroup>';
                            }
                            else {
                                colgroup += '<colgroup width="'+ config["columlen"][c.toString()] +'px"></colgroup>';
                            }
                        }

                        if(c == minC){
                            if(config == null || config["rowlen"] == null || config["rowlen"][r.toString()] == null){
                                style += 'height:19px;';
                            }
                            else {
                                style += 'height:'+ config["rowlen"][r.toString()] + 'px;';
                            }
                        }

                        column = jfgrid.replaceHtml(column, {"style":style, "span":""});
                    }

                    column += '</td>';
                    cpdata += column;
                }

                cpdata += "</tr>";
            }
            cpdata = '<table data-type="jfgrid_copy_action_table">' + colgroup + cpdata + '</table>';

            //console.log(jfgrid_selection_range, jfgird_select_save);
            /*if (cpdata.length == 0) {
                return;
            }*/

            iscopyself = true;
            copyType = "normal";
            copysetting = [];
            // cpdata = cpdata.substring(0, cpdata.length);
            // cpdata = cpdata.substring(0, cpdata.length - 1);
            if (!clipboardData) {
                var textarea = $("#jfgird-copy-content");
                textarea.html(cpdata);
                textarea.focus();
                textarea.select();
                document.execCommand("selectAll");
                document.execCommand("Copy");
                // 等50毫秒，keyPress事件发生了再去处理数据
                setTimeout(function () { 
                    $("#jfgird-copy-content").blur(); 
                }, 10);
            }
            else {
                //e.clipboardData.getData('text');//可以获取用户选中复制的数据
                clipboardData.setData('Text', cpdata);
                return false;//否则设不生效
            }
        },
        copybyformat: function (e, txt) {//copy事件
            var clipboardData = window.clipboardData; //for IE
            if (!clipboardData) { // for chrome
                clipboardData = e.originalEvent.clipboardData;
            }

            jfgrid_selection_range = [{ "row": jfgird_select_save[0].row, "column": jfgird_select_save[0].column }];
            jfgrid.selectionCopyShow();

            var cpdata = txt;

            /*if (cpdata.length == 0) {
                return;
            }*/
            iscopyself = true;
            copyType = "normal";
            copysetting = [];
            if (!clipboardData) {
                var textarea = $("#jfgird-copy-content");
                textarea.text(cpdata);
                textarea.focus();
                textarea.select();
                document.execCommand("selectAll");
                document.execCommand("Copy");
                // 等50毫秒，keyPress事件发生了再去处理数据
                setTimeout(function () { textarea.blur(); }, 10);
            }
            else {
                //e.clipboardData.getData('text');//可以获取用户选中复制的数据
                clipboardData.setData('Text', cpdata);
                return false;//否则设不生效
            }
        },
        isPasteAction:false, 
        paste: function (e, triggerType) {//paste事件
            var textarea = $("#jfgird-copy-content");
            var $t = this;
            textarea.focus();
            textarea.select();
            // 等50毫秒，keyPress事件发生了再去处理数据
            setTimeout(function () {
                var data = textarea.html();

                if (data.indexOf("jfgrid_copy_action_table") >- 1 && jfgrid_copy_save["copyRange"] != null && jfgrid_copy_save["copyRange"].length > 0) {
                    if(jfgrid_paste_iscut){
                        jfgrid_paste_iscut = false;
                        jfgrid.selection.pasteHandlerOfCutPaste(jfgrid_copy_save);
                        jfgrid.selection.clearcopy(e);
                    }
                    else{
                        jfgrid.selection.pasteHandlerOfCopyPaste(jfgrid_copy_save);
                    }
                    // textarea.html("");
                    // textarea.blur();
                }
                else if (triggerType != "btn") {
                    $t.pasteHandler(data);
                    // textarea.html("");
                    // textarea.blur();
                }
                else {
                    if(jfgrid.isEditMode()){
                        alert("在表格中进行复制粘贴: Ctrl + C 进行复制, Ctrl + V 进行粘贴, Ctrl + X 进行剪切");
                    }
                    else{
                        jfgrid.tooltip.info("在表格中进行复制粘贴", "<span style='line-height: 1.0;font-size:36px;font-weight: bold;color:#666;'>Ctrl + C</span>&nbsp;&nbsp;进行复制<br/><span style='line-height: 1.0;font-size:36px;font-weight: bold;color:#666;'>Ctrl + V</span>&nbsp;&nbsp;进行粘贴<br/><span style='line-height: 1.0;font-size:36px;font-weight: bold;color:#666;'>Ctrl + X</span>&nbsp;&nbsp;进行剪切");
                    }
                }
            }, 10);
        },
        pasteHandler: function (data, borderInfo) {
            if(jfgird_select_save.length > 1){
                if(jfgrid.isEditMode()){
                    alert("不能对多重选择区域执行此操作，请选择单个区域，然后再试");
                }
                else{
                    jfgrid.tooltip.info('<i class="fa fa-exclamation-triangle"></i>提示', "不能对多重选择区域执行此操作，请选择单个区域，然后再试"); 
                }
            }

            if (typeof (data) == "object") {
                if (data.length == 0) { return; };

                var cfg = $.extend(true, {}, config);
                if(cfg["merge"] == null){
                    cfg["merge"] = {};
                }

                if(JSON.stringify(borderInfo).length > 2 && cfg["borderInfo"] == null){
                    cfg["borderInfo"] = [];
                }

                var copyh = data.length, copyc = data[0].length;

                var minh = jfgird_select_save[0].row[0], maxh = minh + copyh - 1;            //应用范围首尾行
                var minc = jfgird_select_save[0].column[0], maxc = minc + copyc - 1;         //应用范围首尾列

                //应用范围包含部分合并单元格，则return提示
                var hasPartMC = false;
                if(cfg["merge"] != null){
                    hasPartMC = jfgrid.hasPartMC(cfg, minh, maxh, minc, maxc);
                }
                
                if(hasPartMC){
                    if(jfgrid.isEditMode()){
                        alert("不能对合并单元格做部分更改");
                    }
                    else{
                        jfgrid.tooltip.info('<i class="fa fa-exclamation-triangle"></i>提示', "不能对合并单元格做部分更改");  
                    }

                    return;
                }
                
                var d = jfgrid.editor.deepCopyFlowData(jfgrid.flowdata);//取数据
                var rowMaxLength = d.length;
                var cellMaxLength = d[0].length;

                //若应用范围超过最大行或最大列，增加行列
                var addr = maxh - rowMaxLength + 1, addc = maxc - cellMaxLength + 1;
                if(addr > 0 || addc > 0){
                    d = jfgrid.datagridgrowth([].concat(d), addr, addc, true);
                }

                if(cfg["rowlen"] == null){
                    cfg["rowlen"] = {};
                }
                
                var RowlChange = false;
                var offsetMC = {};
                for (var h = minh; h <= maxh; h++) {
                    var x = [].concat(d[h]);
                    
                    var currentRowLen = defaultrowlen;
                    if(cfg["rowlen"][h] != null){
                        currentRowLen = cfg["rowlen"][h];
                    }

                    for (var c = minc; c <= maxc; c++) {
                        if(jfgrid.getObjType(x[c]) == "object" && ("mc" in x[c])){
                            if("rs" in x[c].mc){
                                delete cfg["merge"][x[c]["mc"].r + "_" + x[c]["mc"].c];
                            }

                            delete x[c].mc;
                        }

                        var value = null;
                        if (data[h - minh] != null && data[h - minh][c - minc] != null) {
                            value = data[h - minh][c - minc];
                        }

                        x[c] = $.extend(true, {}, value);

                        if(value != null && "mc" in x[c]){
                            if(x[c]["mc"].rs != null){
                                x[c]["mc"].r = h;
                                x[c]["mc"].c = c;

                                cfg["merge"][x[c]["mc"].r + "_" + x[c]["mc"].c] = x[c]["mc"];

                                offsetMC[value["mc"].r + "_" + value["mc"].c] = [x[c]["mc"].r, x[c]["mc"].c]; 
                            }
                            else{
                                x[c] = { "mc": { r: offsetMC[value["mc"].r + "_" + value["mc"].c][0], c: offsetMC[value["mc"].r + "_" + value["mc"].c][1] } }                                        
                            }
                        }

                        if(borderInfo[(h - minh) + "_" + (c - minc)]){
                            var bd_obj = {
                                "rangeType": "cell",
                                "value": { 
                                    "row_index": h, 
                                    "col_index": c, 
                                    "l": borderInfo[(h - minh) + "_" + (c - minc)].l, 
                                    "r": borderInfo[(h - minh) + "_" + (c - minc)].r,
                                    "t": borderInfo[(h - minh) + "_" + (c - minc)].t,
                                    "b": borderInfo[(h - minh) + "_" + (c - minc)].b 
                                }
                            }

                            cfg["borderInfo"].push(bd_obj);
                        }
                        
                        var fontset = jfgridfontformat(x[c]);
                        var oneLineTextHeight = jfgrid.menuButton.getTextSize("田", fontset)[1];
                        //比较计算高度和当前高度取最大高度
                        if(oneLineTextHeight > currentRowLen){
                            currentRowLen = oneLineTextHeight;
                            RowlChange = true;
                        }
                    }
                    d[h] = x;

                    if(currentRowLen != defaultrowlen){
                        cfg["rowlen"][h] = currentRowLen;
                    }
                }

                jfgird_select_save = [{ "row": [minh, maxh], "column": [minc, maxc] }];
                
                if(addr > 0 || addc > 0 || RowlChange){
                    jfgrid.jfrefreshgrid(d, jfgird_select_save, cfg, null, true);
                }
                else{
                    jfgrid.jfrefreshgrid(d, jfgird_select_save, cfg);
                    jfgrid.selectHightlightShow();
                }
            }
            else {
                data = data.replace(/\r/g, "");
                var dataChe = [];
                var che = data.split("\n"), colchelen = che[0].split("\t").length;
                for (var i = 0; i < che.length; i++) {
                    if (che[i].split("\t").length < colchelen) {
                        continue;
                    }
                    dataChe.push(che[i].split("\t"));
                }
                
                var d = jfgrid.editor.deepCopyFlowData(jfgrid.flowdata);//取数据

                var last = jfgird_select_save[jfgird_select_save.length - 1];
                var curR = last["row"] == null ? 0 : last["row"][0];
                var curC = last["column"] == null ? 0 : last["column"][0];
                var rlen = dataChe.length, clen = dataChe[0].length;

                //应用范围包含部分合并单元格，则return提示
                var hasPartMC = false;
                if(config["merge"] != null){
                    hasPartMC = jfgrid.hasPartMC(config, curR, curR + rlen - 1, curC, curC + clen - 1);
                }
                
                if(hasPartMC){
                    if(jfgrid.isEditMode()){
                        alert("不能对合并单元格做部分更改");
                    }
                    else{
                        jfgrid.tooltip.info('<i class="fa fa-exclamation-triangle"></i>提示',"不能对合并单元格做部分更改");  
                    }
                    return;
                }

                var addr = curR + rlen - d.length, addc = curC + clen - d[0].length;
                if(addr > 0 || addc > 0){
                    d = jfgrid.datagridgrowth([].concat(d), addr, addc, true);
                }

                for (var r = 0; r < rlen; r++) {
                    var x = [].concat(d[r + curR]);
                    for (var c = 0; c < clen; c++) {
                        var cell = {};

                        var mask = jfgrid.mask.genarate(dataChe[r][c]);
                        cell.v = mask[2];
                        cell.ct = mask[1];
                        cell.m = mask[0];

                        x[c + curC] = cell;
                    }
                    d[r + curR] = x;
                }

                last["row"] = [curR, curR + rlen - 1];
                last["column"] = [curC, curC + clen - 1];

                if (addr > 0 || addc > 0) {
                    jfgrid.jfrefreshgrid(d, jfgird_select_save, null, null, true);
                }
                else {
                    jfgrid.jfrefreshgrid(d, jfgird_select_save);
                    jfgrid.selectHightlightShow();
                }
            }
        },
        pasteHandlerOfCutPaste: function(copyRange){
            var cfg = $.extend(true, {}, config);
            if(cfg["merge"] == null){
                cfg["merge"] = {};
            }

            //复制范围
            var copyHasMC = copyRange["HasMC"];
            var copyRowlChange = copyRange["RowlChange"];

            var copySheetIndex = copyRange["dataSheetIndex"];
            var copyData = $.extend(true, [], jfgrid.getdatabyselection({"row": copyRange["copyRange"][0].row, "column": copyRange["copyRange"][0].column}, copySheetIndex));

            var copyh = copyData.length, copyc = copyData[0].length;

            //应用范围
            var last = jfgird_select_save[jfgird_select_save.length - 1];
            var minh = last["row_focus"], maxh = minh + copyh - 1;         //应用范围首尾行
            var minc = last["column_focus"], maxc = minc + copyc - 1;      //应用范围首尾列

            //应用范围包含部分合并单元格，则提示
            var hasPartMC = false;
            if(cfg["merge"] != null){
                hasPartMC = jfgrid.hasPartMC(cfg, minh, maxh, minc, maxc);
            }
            
            if(hasPartMC){
                if(jfgrid.isEditMode()){
                    alert("不能对合并单元格做部分更改");
                }
                else{
                    jfgrid.tooltip.info('<i class="fa fa-exclamation-triangle"></i>提示',"不能对合并单元格做部分更改");  
                }
                return;
            }

            var d = jfgrid.editor.deepCopyFlowData(jfgrid.flowdata);//取数据
            var rowMaxLength = d.length;
            var cellMaxLength = d[0].length;

            var addr = copyh + minh - rowMaxLength, addc = copyc + minc - cellMaxLength;
            if(addr > 0 || addc > 0){
                d = jfgrid.datagridgrowth([].concat(d), addr, addc, true);
            }

            var borderInfoCompute = jfgrid.getBorderInfoCompute(copySheetIndex);
            
            //剪切粘贴在当前表操作，删除剪切范围内数据和合并单元格
            if(jfgrid.currentSheetIndex == copySheetIndex){
                for(var i = copyRange["copyRange"][0].row[0]; i <= copyRange["copyRange"][0].row[1]; i++){
                    for(var j = copyRange["copyRange"][0].column[0]; j <= copyRange["copyRange"][0].column[1]; j++){
                        var cell = d[i][j];

                        if(jfgrid.getObjType(cell) == "object" && ("mc" in cell)){
                            if("rs" in cell["mc"]){
                                delete cfg["merge"][cell["mc"].r + "_" + cell["mc"].c];
                            }
                            delete cell["mc"];
                        }

                        d[i][j] = null;
                    }
                }

                //边框
                if(cfg["borderInfo"] && cfg["borderInfo"].length > 0){
                    var source_borderInfo = [];

                    for(var i = 0; i < cfg["borderInfo"].length; i++){
                        var bd_rangeType = cfg["borderInfo"][i].rangeType;

                        if(bd_rangeType == "range"){
                            var bd_range = cfg["borderInfo"][i].range;
                            var bd_emptyRange = [];

                            for(var j = 0; j < bd_range.length; j++){
                                bd_emptyRange = bd_emptyRange.concat(jfgrid.conditionformat.CFSplitRange(bd_range[j], {"row": copyRange["copyRange"][0].row, "column": copyRange["copyRange"][0].column}, {"row": [minh, maxh], "column": [minc, maxc]}, "restPart"));
                            }

                            cfg["borderInfo"][i].range = bd_emptyRange;

                            source_borderInfo.push(cfg["borderInfo"][i]);
                        }
                        else if(bd_rangeType == "cell"){
                            var bd_r = cfg["borderInfo"][i].value.row_index;
                            var bd_c = cfg["borderInfo"][i].value.col_index;

                            if(!(bd_r >= copyRange["copyRange"][0].row[0] && bd_r <= copyRange["copyRange"][0].row[1] && bd_c >= copyRange["copyRange"][0].column[0] && bd_c <= copyRange["copyRange"][0].column[1])){
                                source_borderInfo.push(cfg["borderInfo"][i]);
                            }
                        }
                    }

                    cfg["borderInfo"] = source_borderInfo;
                }
            }

            var offsetMC = {};
            for (var h = minh; h <= maxh; h++) {
                var x = [].concat(d[h]);

                for (var c = minc; c <= maxc; c++) {
                    if(borderInfoCompute[(copyRange["copyRange"][0].row[0] + h - minh) + "_" + (copyRange["copyRange"][0].column[0] + c - minc)]){
                        var bd_obj = {
                            "rangeType": "cell",
                            "value": {
                                "row_index": h,
                                "col_index": c,
                                "l": borderInfoCompute[(copyRange["copyRange"][0].row[0] + h - minh) + "_" + (copyRange["copyRange"][0].column[0] + c - minc)].l,
                                "r": borderInfoCompute[(copyRange["copyRange"][0].row[0] + h - minh) + "_" + (copyRange["copyRange"][0].column[0] + c - minc)].r,
                                "t": borderInfoCompute[(copyRange["copyRange"][0].row[0] + h - minh) + "_" + (copyRange["copyRange"][0].column[0] + c - minc)].t,
                                "b": borderInfoCompute[(copyRange["copyRange"][0].row[0] + h - minh) + "_" + (copyRange["copyRange"][0].column[0] + c - minc)].b
                            }
                        }

                        if(cfg["borderInfo"] == null){
                            cfg["borderInfo"] = [];
                        }

                        cfg["borderInfo"].push(bd_obj);
                    }
                    else if(borderInfoCompute[h + "_" + c]){
                        var bd_obj = {
                            "rangeType": "cell",
                            "value": {
                                "row_index": h,
                                "col_index": c,
                                "l": null,
                                "r": null,
                                "t": null,
                                "b": null
                            }
                        }

                        if(cfg["borderInfo"] == null){
                            cfg["borderInfo"] = [];
                        }

                        cfg["borderInfo"].push(bd_obj);
                    }

                    if(jfgrid.getObjType(x[c]) == "object" && ("mc" in x[c])){
                        if("rs" in x[c].mc){
                            delete cfg["merge"][x[c]["mc"].r + "_" + x[c]["mc"].c];
                        }
                        delete x[c].mc;
                    }

                    var value = null;
                    if (copyData[h - minh] != null && copyData[h - minh][c - minc] != null) {
                        value = copyData[h - minh][c - minc];
                    }

                    x[c] = $.extend(true, {}, value);

                    if(value != null && copyHasMC && ("mc" in x[c])){
                        if(x[c]["mc"].rs != null){
                            x[c]["mc"].r = h;
                            x[c]["mc"].c = c;

                            cfg["merge"][x[c]["mc"].r + "_" + x[c]["mc"].c] = x[c]["mc"];

                            offsetMC[value["mc"].r + "_" + value["mc"].c] = [x[c]["mc"].r, x[c]["mc"].c]; 
                        }
                        else{
                            x[c] = { "mc": { r: offsetMC[value["mc"].r + "_" + value["mc"].c][0], c: offsetMC[value["mc"].r + "_" + value["mc"].c][1] } }                                        
                        }
                    }
                }
                d[h] = x;
            }

            last["row"] = [minh, maxh];
            last["column"] = [minc, maxc];
            
            //若有行高改变，重新计算行高改变
            if(copyRowlChange){
                if(jfgrid.currentSheetIndex != copySheetIndex){
                    cfg = jfgrid.rowlenByRange(d, minh, maxh, cfg);
                }
                else{
                    cfg = jfgrid.rowlenByRange(d, copyRange["copyRange"][0].row[0], copyRange["copyRange"][0].row[1], cfg);
                    cfg = jfgrid.rowlenByRange(d, minh, maxh, cfg);
                }
            }

            if(jfgrid.currentSheetIndex != copySheetIndex){
                //跨表操作
                var sourceData = $.extend(true, [], jfgridfile[jfgrid.sheetmanage.getSheetIndex(copySheetIndex)]["data"]);
                var sourceConfig = $.extend(true, {}, jfgridfile[jfgrid.sheetmanage.getSheetIndex(copySheetIndex)]["config"]);

                var sourceCurData = $.extend(true, [], sourceData);
                var sourceCurConfig = $.extend(true, {}, sourceConfig);
                if(sourceCurConfig["merge"] == null){
                    sourceCurConfig["merge"] = {};
                }

                var source_r1 = copyRange["copyRange"][0].row[0], source_r2 = copyRange["copyRange"][0].row[1];
                var source_c1 = copyRange["copyRange"][0].column[0], source_c2 = copyRange["copyRange"][0].column[1];

                for(var source_r = source_r1; source_r <= source_r2; source_r++){
                    for(var source_c = source_c1; source_c <= source_c2; source_c++){
                        var cell = sourceCurData[source_r][source_c];

                        if(jfgrid.getObjType(cell) == "object" && ("mc" in cell)){
                            if("rs" in cell["mc"]){
                                delete sourceCurConfig["merge"][cell["mc"].r + "_" + cell["mc"].c];
                            }
                            delete cell["mc"];
                        }
                        sourceCurData[source_r][source_c] = null;
                    }
                }

                if(copyRowlChange){
                    sourceCurConfig = jfgrid.rowlenByRange(sourceCurData, source_r1, source_r2, sourceCurConfig);
                }

                //边框
                if(sourceCurConfig["borderInfo"] && sourceCurConfig["borderInfo"].length > 0){
                    var source_borderInfo = [];

                    for(var i = 0; i < sourceCurConfig["borderInfo"].length; i++){
                        var bd_rangeType = sourceCurConfig["borderInfo"][i].rangeType;

                        if(bd_rangeType == "range"){
                            var bd_range = sourceCurConfig["borderInfo"][i].range;
                            var bd_emptyRange = [];

                            for(var j = 0; j < bd_range.length; j++){
                                bd_emptyRange = bd_emptyRange.concat(jfgrid.conditionformat.CFSplitRange(bd_range[j], {"row": copyRange["copyRange"][0].row, "column": copyRange["copyRange"][0].column}, {"row": [minh, maxh], "column": [minc, maxc]}, "restPart"));
                            }

                            sourceCurConfig["borderInfo"][i].range = bd_emptyRange;

                            source_borderInfo.push(sourceCurConfig["borderInfo"][i]);
                        }
                        else if(bd_rangeType == "cell"){
                            var bd_r = sourceCurConfig["borderInfo"][i].value.row_index;
                            var bd_c = sourceCurConfig["borderInfo"][i].value.col_index;

                            if(!(bd_r >= copyRange["copyRange"][0].row[0] && bd_r <= copyRange["copyRange"][0].row[1] && bd_c >= copyRange["copyRange"][0].column[0] && bd_c <= copyRange["copyRange"][0].column[1])){
                                source_borderInfo.push(sourceCurConfig["borderInfo"][i]);
                            }
                        }
                    }

                    sourceCurConfig["borderInfo"] = source_borderInfo;
                }

                //条件格式
                var source_cdformat = $.extend(true, [], jfgridfile[jfgrid.sheetmanage.getSheetIndex(copySheetIndex)]["jfgrid_conditionformat_save"]);
                var source_curCdformat = $.extend(true, [], source_cdformat);
                var ruleArr = [];
                if(source_curCdformat != null && source_curCdformat.length > 0){
                    for(var i = 0; i < source_curCdformat.length; i++){
                        var source_curCdformat_cellrange = source_curCdformat[i].cellrange;
                        var emptyRange = [];
                        var emptyRange2 = [];

                        for(var j = 0; j < source_curCdformat_cellrange.length; j++){
                            var range = jfgrid.conditionformat.CFSplitRange(source_curCdformat_cellrange[j], {"row": copyRange["copyRange"][0].row, "column": copyRange["copyRange"][0].column}, {"row": [minh, maxh], "column": [minc, maxc]}, "restPart");
                            emptyRange = emptyRange.concat(range);

                            var range2 = jfgrid.conditionformat.CFSplitRange(source_curCdformat_cellrange[j], {"row": copyRange["copyRange"][0].row, "column": copyRange["copyRange"][0].column}, {"row": [minh, maxh], "column": [minc, maxc]}, "operatePart");
                            if(range2.length > 0){
                                emptyRange2 = emptyRange2.concat(range2);
                            }
                        }

                        source_curCdformat[i].cellrange = emptyRange;

                        if(emptyRange2.length > 0){
                            var ruleObj = $.extend(true, {}, source_curCdformat[i]);
                            ruleObj.cellrange = emptyRange2;
                            ruleArr.push(ruleObj);
                        }
                    }
                }

                var target_cdformat = $.extend(true, [], jfgridfile[jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex)]["jfgrid_conditionformat_save"]);
                var target_curCdformat = $.extend(true, [], target_cdformat);
                if(ruleArr.length > 0){
                    target_curCdformat = target_curCdformat.concat(ruleArr);
                }

                var source = {
                    "sheetIndex": copySheetIndex,
                    "data": sourceData,
                    "curData": sourceCurData,
                    "config": sourceConfig,
                    "curConfig": sourceCurConfig,
                    "cdformat": source_cdformat,
                    "curCdformat": source_curCdformat,
                    "range": {
                        "row": copyRange["copyRange"][0].row,
                        "column": copyRange["copyRange"][0].column
                    }
                }
                var target = {
                    "sheetIndex": jfgrid.currentSheetIndex,
                    "data": jfgrid.flowdata,
                    "curData": d,
                    "config": $.extend(true, {}, config),
                    "curConfig": cfg,
                    "cdformat": target_cdformat,
                    "curCdformat": target_curCdformat,
                    "range": {
                        "row": [minh, maxh],
                        "column": [minc, maxc]
                    }
                }
            }
            else{
                //条件格式
                var cdformat = $.extend(true, [], jfgridfile[jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex)]["jfgrid_conditionformat_save"]);
                var curCdformat = $.extend(true, [], cdformat);
                if(curCdformat != null && curCdformat.length > 0){
                    for(var i = 0; i < curCdformat.length; i++){
                        var cellrange = curCdformat[i].cellrange;
                        var emptyRange = [];

                        for(var j = 0; j < cellrange.length; j++){
                            var range = jfgrid.conditionformat.CFSplitRange(cellrange[j], {"row": copyRange["copyRange"][0].row, "column": copyRange["copyRange"][0].column}, {"row": [minh, maxh], "column": [minc, maxc]}, "allPart");
                            emptyRange = emptyRange.concat(range);
                        }

                        curCdformat[i].cellrange = emptyRange;
                    }
                }

                //当前表操作
                var source = {
                    "sheetIndex": jfgrid.currentSheetIndex,
                    "data": jfgrid.flowdata,
                    "curData": d,
                    "config": $.extend(true, {}, config),
                    "curConfig": cfg,
                    "cdformat": cdformat,
                    "curCdformat": curCdformat,
                    "range": {
                        "row": copyRange["copyRange"][0].row,
                        "column": copyRange["copyRange"][0].column
                    }
                }
                var target = {
                    "sheetIndex": jfgrid.currentSheetIndex,
                    "data": jfgrid.flowdata,
                    "curData": d,
                    "config": $.extend(true, {}, config),
                    "curConfig": cfg,
                    "cdformat": cdformat,
                    "curCdformat": curCdformat,
                    "range": {
                        "row": [minh, maxh],
                        "column": [minc, maxc]
                    }
                }
            }

            if(addr > 0 || addc > 0){
                jfgrid.jfrefreshgrid_pastcut(source, target, true);
            }
            else{
                jfgrid.jfrefreshgrid_pastcut(source, target, copyRowlChange);
            }
        },
        pasteHandlerOfCopyPaste: function(copyRange){
            var cfg = $.extend(true, {}, config);
            if(cfg["merge"] == null){
                cfg["merge"] = {};
            }

            //复制范围
            var copyHasMC = copyRange["HasMC"];
            var copyRowlChange = copyRange["RowlChange"];
            var copySheetIndex = copyRange["dataSheetIndex"];

            var arr = [], isSameRow = false;
            for(var i = 0; i < copyRange["copyRange"].length; i++){
                var arrData = jfgrid.getdatabyselection({"row": copyRange["copyRange"][i].row, "column": copyRange["copyRange"][i].column}, copySheetIndex);
                if(copyRange["copyRange"].length > 1){
                    if(copyRange["copyRange"][0].row[0] == copyRange["copyRange"][1].row[0] && copyRange["copyRange"][0].row[1] == copyRange["copyRange"][1].row[1]){
                        arrData = arrData[0].map(function(col, a){
                            return arrData.map(function(row){
                                return row[a];
                            });
                        });

                        arr = arr.concat(arrData);

                        isSameRow = true;
                    }
                    else if(copyRange["copyRange"][0].column[0] == copyRange["copyRange"][1].column[0] && copyRange["copyRange"][0].column[1] == copyRange["copyRange"][1].column[1]){
                        arr = arr.concat(arrData);
                    }
                }
                else{
                    arr = arrData;
                }
            }

            if(isSameRow){
                arr = arr[0].map(function(col, b){
                    return arr.map(function(row){
                        return row[b];
                    })
                })
            }

            var copyData = $.extend(true, [], arr);

            //多重选择选择区域 单元格如果有函数 则只取值 不取函数
            if(copyRange["copyRange"].length > 1){
                for(var i = 0; i < copyData.length; i++){
                    for(var j = 0; j < copyData[i].length; j++){
                        if(copyData[i][j] != null && copyData[i][j].f != null){
                            delete copyData[i][j].f;
                            delete copyData[i][j].spl;
                        }
                    }
                }
            }

            var copyh = copyData.length, copyc = copyData[0].length;

            //应用范围
            var last = jfgird_select_save[jfgird_select_save.length - 1];
            var minh = last["row"][0], maxh = last["row"][1];         //应用范围首尾行
            var minc = last["column"][0], maxc = last["column"][1];   //应用范围首尾列

            var mh = (maxh - minh + 1) % copyh;
            var mc = (maxc - minc + 1) % copyc;

            if(mh != 0 || mc != 0){ //若应用范围不是copydata行列数的整数倍，则取copydata的行列数
                maxh = minh + copyh - 1;
                maxc = minc + copyc - 1;
            }

            //应用范围包含部分合并单元格，则提示
            var hasPartMC = false;
            if(cfg["merge"] != null){
                hasPartMC = jfgrid.hasPartMC(cfg, minh, maxh, minc, maxc);
            }
            
            if(hasPartMC){
                if(jfgrid.isEditMode()){
                    alert("不能对合并单元格做部分更改");
                }
                else{
                    jfgrid.tooltip.info('<i class="fa fa-exclamation-triangle"></i>提示',"不能对合并单元格做部分更改");  
                }
                return;
            }

            var timesH = (maxh - minh + 1) / copyh;
            var timesC = (maxc - minc + 1) / copyc;

            var d = jfgrid.editor.deepCopyFlowData(jfgrid.flowdata);//取数据
            var rowMaxLength = d.length;
            var cellMaxLength = d[0].length;

            //若应用范围超过最大行或最大列，增加行列
            var addr = copyh + minh - rowMaxLength, addc = copyc + minc - cellMaxLength;
            if(addr > 0 || addc > 0){
                d = jfgrid.datagridgrowth([].concat(d), addr, addc, true);
            }

            var borderInfoCompute = jfgrid.getBorderInfoCompute(copySheetIndex);

            var mth = 0, mtc = 0, maxcellCahe = 0, maxrowCache = 0;
            for(var th = 1; th <= timesH; th++){
                for(var tc = 1; tc <= timesC; tc++){
                    mth = minh + (th - 1) * copyh;
                    mtc = minc + (tc - 1) * copyc;
                    maxrowCache = minh + th * copyh;
                    maxcellCahe = minc + tc * copyc;

                    //行列位移值 用于单元格有函数
                    var offsetRow = mth - copyRange["copyRange"][0].row[0];
                    var offsetCol = mtc - copyRange["copyRange"][0].column[0];

                    var offsetMC = {};
                    for (var h = mth; h < maxrowCache; h++) {
                        var x = [].concat(d[h]);

                        for (var c = mtc; c < maxcellCahe; c++) {
                            if(borderInfoCompute[(copyRange["copyRange"][0].row[0] + h - mth) + "_" + (copyRange["copyRange"][0].column[0] + c - mtc)]){
                                var bd_obj = {
                                    "rangeType": "cell",
                                    "value": {
                                        "row_index": h,
                                        "col_index": c,
                                        "l": borderInfoCompute[(copyRange["copyRange"][0].row[0] + h - mth) + "_" + (copyRange["copyRange"][0].column[0] + c - mtc)].l,
                                        "r": borderInfoCompute[(copyRange["copyRange"][0].row[0] + h - mth) + "_" + (copyRange["copyRange"][0].column[0] + c - mtc)].r,
                                        "t": borderInfoCompute[(copyRange["copyRange"][0].row[0] + h - mth) + "_" + (copyRange["copyRange"][0].column[0] + c - mtc)].t,
                                        "b": borderInfoCompute[(copyRange["copyRange"][0].row[0] + h - mth) + "_" + (copyRange["copyRange"][0].column[0] + c - mtc)].b
                                    }
                                }

                                if(cfg["borderInfo"] == null){
                                    cfg["borderInfo"] = [];
                                }

                                cfg["borderInfo"].push(bd_obj);
                            }
                            else if(borderInfoCompute[h + "_" + c]){
                                var bd_obj = {
                                    "rangeType": "cell",
                                    "value": {
                                        "row_index": h,
                                        "col_index": c,
                                        "l": null,
                                        "r": null,
                                        "t": null,
                                        "b": null
                                    }
                                }

                                if(cfg["borderInfo"] == null){
                                    cfg["borderInfo"] = [];
                                }

                                cfg["borderInfo"].push(bd_obj);
                            }

                            if(jfgrid.getObjType(x[c]) == "object" && "mc" in x[c]){
                                if("rs" in x[c].mc){
                                    delete cfg["merge"][x[c]["mc"].r + "_" + x[c]["mc"].c];
                                }
                                delete x[c].mc;
                            }

                            var value = null;
                            if (copyData[h - mth] != null && copyData[h - mth][c - mtc] != null) {
                                value = $.extend(true, {}, copyData[h - mth][c - mtc]);
                            }

                            if(value != null && value.f != null){
                                var func = value.f;

                                if(offsetRow > 0){
                                    func = "=" + jfgrid.formula.functionCopy(func, "down", offsetRow);
                                }

                                if(offsetRow < 0){
                                    func = "=" + jfgrid.formula.functionCopy(func, "up", Math.abs(offsetRow));
                                }

                                if(offsetCol > 0){
                                    func = "=" + jfgrid.formula.functionCopy(func, "right", offsetCol);
                                }

                                if(offsetCol < 0){
                                    func = "=" + jfgrid.formula.functionCopy(func, "left", Math.abs(offsetCol));
                                }

                                var funcV = jfgrid.formula.execfunction(func, h, c, true);

                                if(value.spl != null){
                                    value.f = funcV[2];
                                    value.v = funcV[1];
                                    value.spl = funcV[3].data;
                                }
                                else{
                                    value.f = funcV[2];
                                    value.v = funcV[1];

                                    if(value.ct != null && value.ct["fa"] != null){
                                        value.m = jfgrid.mask.update(value.ct["fa"], funcV[1]);
                                    }
                                }
                            }

                            x[c] = $.extend(true, {}, value);

                            if(value != null && copyHasMC && ("mc" in x[c])){
                                if(x[c]["mc"].rs != null){
                                    x[c]["mc"].r = h;
                                    x[c]["mc"].c = c;

                                    cfg["merge"][x[c]["mc"].r + "_" + x[c]["mc"].c] = x[c]["mc"];

                                    offsetMC[value["mc"].r + "_" + value["mc"].c] = [x[c]["mc"].r, x[c]["mc"].c]; 
                                }
                                else{
                                    x[c] = { "mc": { r: offsetMC[value["mc"].r + "_" + value["mc"].c][0], c: offsetMC[value["mc"].r + "_" + value["mc"].c][1] } }                                        
                                }
                            }
                        }

                        d[h] = x;
                    }
                }
            }

            //复制范围 是否有 条件格式
            if(copyRange["copyRange"].length == 1){
                var c_file = jfgridfile[jfgrid.sheetmanage.getSheetIndex(copySheetIndex)];
                var a_file = jfgridfile[jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex)];

                var c_r1 = copyRange["copyRange"][0].row[0],
                    c_r2 = copyRange["copyRange"][0].row[1],
                    c_c1 = copyRange["copyRange"][0].column[0],
                    c_c2 = copyRange["copyRange"][0].column[1];
                
                var ruleArr_cf = $.extend(true, [], c_file["jfgrid_conditionformat_save"]);
                var cdformat = $.extend(true, [], a_file["jfgrid_conditionformat_save"]);

                if(ruleArr_cf != null && ruleArr_cf.length > 0){
                    for(var i = 0; i < ruleArr_cf.length; i++){
                        var cf_range = ruleArr_cf[i].cellrange;

                        var emptyRange = [];

                        for(var th = 1; th <= timesH; th++){
                            for(var tc = 1; tc <= timesC; tc++){
                                mth = minh + (th - 1) * copyh;
                                mtc = minc + (tc - 1) * copyc;
                                maxrowCache = minh + th * copyh;
                                maxcellCahe = minc + tc * copyc;

                                for(var j = 0; j < cf_range.length; j++){
                                    var range = jfgrid.conditionformat.CFSplitRange(cf_range[j], {"row": [c_r1, c_r2], "column": [c_c1, c_c2]}, {"row": [mth, maxrowCache - 1], "column": [mtc, maxcellCahe - 1]}, "operatePart");
                                    if(range.length > 0){
                                        emptyRange = emptyRange.concat(range);
                                    }
                                }
                            }
                        }

                        if(emptyRange.length > 0){
                            ruleArr_cf[i].cellrange = emptyRange;
                            cdformat.push(ruleArr_cf[i]);
                        }
                    }
                }
            }

            last["row"] = [minh, maxh];
            last["column"] = [minc, maxc];

            if(copyRowlChange || addr > 0 || addc > 0){
                cfg = jfgrid.rowlenByRange(d, minh, maxh, cfg);

                if(copyRange["copyRange"].length == 1 && ruleArr_cf != null && ruleArr_cf.length > 0){
                    jfgrid.jfrefreshgrid(d, jfgird_select_save, cfg, cdformat, true);
                }
                else{
                    jfgrid.jfrefreshgrid(d, jfgird_select_save, cfg, null, true);
                }
            }
            else{
                if(copyRange["copyRange"].length == 1 && ruleArr_cf != null && ruleArr_cf.length > 0){
                    jfgrid.jfrefreshgrid(d, jfgird_select_save, cfg, cdformat);
                }
                else{
                    jfgrid.jfrefreshgrid(d, jfgird_select_save, cfg);
                }

                jfgrid.selectHightlightShow();
            }
        },
        pasteHandlerOfPaintModel: function(copyRange){
            var cfg = $.extend(true, {}, config);
            if(cfg["merge"] == null){
                cfg["merge"] = {};
            }

            //复制范围
            var copyHasMC = copyRange["HasMC"];
            var copyRowlChange = copyRange["RowlChange"];

            var copySheetIndex = copyRange["dataSheetIndex"];
            var copyData = $.extend(true, [], jfgrid.getdatabyselection({"row": copyRange["copyRange"][0].row, "column": copyRange["copyRange"][0].column}, copySheetIndex));

            //应用范围
            var last = jfgird_select_save[jfgird_select_save.length - 1];
            var minh = last["row"][0], maxh = last["row"][1];         //应用范围首尾行
            var minc = last["column"][0], maxc = last["column"][1];   //应用范围首尾列

            var copyh = copyData.length, copyc = copyData[0].length;

            if(minh == maxh && minc == maxc){
                //应用范围是一个单元格，自动增加到复制范围大小 (若自动增加的范围包含部分合并单元格，则提示)
                var hasPartMC = false;
                if(cfg["merge"] != null){
                    hasPartMC = jfgrid.hasPartMC(cfg, minh, minh + copyh - 1, minc, minc + copyc - 1);
                }
                
                if(hasPartMC){
                    if(jfgrid.isEditMode()){
                        alert("不能对合并单元格做部分更改");
                    }
                    else{
                        jfgrid.tooltip.info('<i class="fa fa-exclamation-triangle"></i>提示',"不能对合并单元格做部分更改");  
                    }
                    return;
                }

                maxh = minh + copyh - 1; 
                maxc = minc + copyc - 1;
            }

            var timesH = Math.ceil((maxh - minh + 1) / copyh);  //复制行 组数
            var timesC = Math.ceil((maxc - minc + 1) / copyc);  //复制列 组数

            var d = jfgrid.editor.deepCopyFlowData(jfgrid.flowdata);//取数据
            var cellMaxLength = d[0].length;
            var rowMaxLength = d.length;

            var borderInfoCompute = jfgrid.getBorderInfoCompute(copySheetIndex);

            var mth = 0, mtc = 0, record, row1, cell1, column, maxcellCahe = 0, maxrowCache = 0, editorable, olddata;
            for (var th = 1; th <= timesH; th++) {
                for (var tc = 1; tc <= timesC; tc++) {
                    mth = minh + (th - 1) * copyh;
                    mtc = minc + (tc - 1) * copyc;

                    maxrowCache = minh + th * copyh > rowMaxLength ? rowMaxLength : minh + th * copyh;
                    if(maxrowCache > (maxh + 1)){
                        maxrowCache = maxh + 1;
                    }

                    maxcellCahe = minc + tc * copyc > cellMaxLength ? cellMaxLength : minc + tc * copyc;
                    if(maxcellCahe > (maxc + 1)){
                        maxcellCahe = maxc + 1;
                    }

                    var offsetMC = {};
                    for (var h = mth; h < maxrowCache; h++) {
                        var x = [].concat(d[h]);

                        for (var c = mtc; c < maxcellCahe; c++) {
                            if(borderInfoCompute[(copyRange["copyRange"][0].row[0] + h - mth) + "_" + (copyRange["copyRange"][0].column[0] + c - mtc)]){
                                var bd_obj = {
                                    "rangeType": "cell",
                                    "value": {
                                        "row_index": h,
                                        "col_index": c,
                                        "l": borderInfoCompute[(copyRange["copyRange"][0].row[0] + h - mth) + "_" + (copyRange["copyRange"][0].column[0] + c - mtc)].l,
                                        "r": borderInfoCompute[(copyRange["copyRange"][0].row[0] + h - mth) + "_" + (copyRange["copyRange"][0].column[0] + c - mtc)].r,
                                        "t": borderInfoCompute[(copyRange["copyRange"][0].row[0] + h - mth) + "_" + (copyRange["copyRange"][0].column[0] + c - mtc)].t,
                                        "b": borderInfoCompute[(copyRange["copyRange"][0].row[0] + h - mth) + "_" + (copyRange["copyRange"][0].column[0] + c - mtc)].b
                                    }
                                }

                                if(cfg["borderInfo"] == null){
                                    cfg["borderInfo"] = [];
                                }

                                cfg["borderInfo"].push(bd_obj);
                            }
                            else if(borderInfoCompute[h + "_" + c]){
                                var bd_obj = {
                                    "rangeType": "cell",
                                    "value": {
                                        "row_index": h,
                                        "col_index": c,
                                        "l": null,
                                        "r": null,
                                        "t": null,
                                        "b": null
                                    }
                                }

                                if(cfg["borderInfo"] == null){
                                    cfg["borderInfo"] = [];
                                }

                                cfg["borderInfo"].push(bd_obj);
                            }

                            if(jfgrid.getObjType(x[c]) == "object" && ("mc" in x[c])){
                                if("rs" in x[c].mc){
                                    delete cfg["merge"][x[c]["mc"].r + "_" + x[c]["mc"].c];
                                }
                                delete x[c].mc;
                            }

                            var value = null;
                            if (copyData[h - mth] != null && copyData[h - mth][c - mtc] != null) {
                                value = copyData[h - mth][c - mtc];
                            }

                            if(value != null){
                                delete value["v"];
                                delete value["m"];
                                delete value["f"];
                                delete value["spl"];

                                if(jfgrid.getObjType(x[c]) == "object"){

                                }
                                else{
                                    x[c] = {"v": x[c] };
                                }

                                x[c] = $.extend(true, x[c], value);

                                if(copyHasMC && ("mc" in x[c])){
                                    if(x[c]["mc"].rs != null){
                                        x[c]["mc"].r = h;
                                        if(x[c]["mc"].rs + h >= maxrowCache){
                                            x[c]["mc"].rs = maxrowCache - h;
                                        }

                                        x[c]["mc"].c = c;
                                        if(x[c]["mc"].cs + c >= maxcellCahe){
                                            x[c]["mc"].cs = maxcellCahe - c;
                                        }

                                        cfg["merge"][x[c]["mc"].r + "_" + x[c]["mc"].c] = x[c]["mc"];

                                        offsetMC[value["mc"].r + "_" + value["mc"].c] = [x[c]["mc"].r, x[c]["mc"].c]; 
                                    }
                                    else{
                                        x[c] = { "mc": { r: offsetMC[value["mc"].r + "_" + value["mc"].c][0], c: offsetMC[value["mc"].r + "_" + value["mc"].c][1] } }                                        
                                    }
                                }

                                if(x[c].v != null){
                                    if(value["ct"] != null && value["ct"]["fa"] != null){
                                        var mask = jfgrid.mask.update(value["ct"]["fa"], x[c].v);
                                        x[c].m = mask;
                                    }
                                }
                            }
                        }
                        d[h] = x;
                    }
                }
            }

            //复制范围 是否有 条件格式
            var ruleArr = $.extend(true, [], jfgridfile[jfgrid.sheetmanage.getSheetIndex(copySheetIndex)]["jfgrid_conditionformat_save"]);
            var cdformat = $.extend(true, [], jfgridfile[jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex)]["jfgrid_conditionformat_save"]);

            if(ruleArr != null && ruleArr.length > 0){
                for(var i = 0; i < ruleArr.length; i++){
                    var cdformat_cellrange = ruleArr[i].cellrange;

                    var emptyRange = [];

                    for(var j = 0; j < cdformat_cellrange.length; j++){
                        var range = jfgrid.conditionformat.CFSplitRange(cdformat_cellrange[j], {"row": copyRange["copyRange"][0]["row"], "column": copyRange["copyRange"][0]["column"]}, {"row": [minh, maxh], "column": [minc, maxc]}, "operatePart");
                        if(range.length > 0){
                            emptyRange = emptyRange.concat(range);
                        }
                    }

                    if(emptyRange.length > 0){
                        ruleArr[i].cellrange = [{"row": [minh, maxh], "column": [minc, maxc]}];
                        cdformat.push(ruleArr[i]);
                    }
                }
            }

            last["row"] = [minh, maxh];
            last["column"] = [minc, maxc];

            if(copyRowlChange){
                cfg = jfgrid.rowlenByRange(d, minh, maxh, cfg);

                if(ruleArr != null && ruleArr.length > 0){
                    jfgrid.jfrefreshgrid(d, jfgird_select_save, cfg, cdformat, true);
                }
                else{
                    jfgrid.jfrefreshgrid(d, jfgird_select_save, cfg, null, true);
                }
            }
            else{
                if(ruleArr != null && ruleArr.length > 0){
                    jfgrid.jfrefreshgrid(d, jfgird_select_save, cfg, cdformat);
                }
                else{
                    jfgrid.jfrefreshgrid(d, jfgird_select_save, cfg);
                }

                jfgrid.selectHightlightShow();
            }
        },
        matchcopy: function (data1, data2) {
            var data1cache = [], data2cache = [], data1len, data2len;
            if (typeof (data1) == "object") {
                data1cache = data1;
            }
            else {
                data1cache = data1.split("\n");
                for (var i = 0; i < data1cache.length; i++) {
                    data1cache[i] = data1cache[i].split("\t");
                }
            }
            data1len = data1cache.length;

            if (typeof (data2) == "object") {
                data2cache = data2;
            }
            else {
                data2cache = data2.split("\n");
                for (var i = 0; i < data2cache.length; i++) {
                    data2cache[i] = data2cache[i].split("\t");
                }
            }

            data2len = data2cache.length;

            if (data1len != data2len) {
                return false;
            }


            for (var r1 = 0; r1 < data1len; r1++) {
                if (config["rowhidden"] != null && config["rowhidden"][r1] != null) {
                    continue;
                }
                for (var r2 = 0; r2 < data2len; r2++) {
                    if (data1cache[r1].length != data2cache[r2].length) {
                        return false;
                    }
                }
            }

            for (var r = 0; r < data1len; r++) {
                if (config["rowhidden"] != null && config["rowhidden"][r] != null) {
                    continue;
                }
                for (var c = 0; c < data1cache[0].length; c++) {
                    if (jfgrid.getcellvalue(r, c, data1cache) != jfgrid.getcellvalue(r, c, data2cache)) {
                        return false;
                    }
                }
            }

            return true;
        }
    };

    jfgrid.datecontroll = {
        isdatetime: function (s) {
            if (s == null || s.toString().length < 5) {
                return false;
            }
            else if(checkDateTime(s)){
                return true;
            }
            else {
                return false;
            }

            function checkDateTime(str){
                var reg1 = /^(\d{4})-(\d{1,2})-(\d{1,2})(\s(\d{1,2}):(\d{1,2})(:(\d{1,2}))?)?$/;
                var reg2 = /^(\d{4})\/(\d{1,2})\/(\d{1,2})(\s(\d{1,2}):(\d{1,2})(:(\d{1,2}))?)?$/;

                if(!reg1.test(str) && !reg2.test(str)){
                    return false;
                }

                var year = RegExp.$1,
                    month = RegExp.$2,
                    day = RegExp.$3;

                if(year < 1900){
                    return false;
                }

                if(month > 12){
                    return false;
                }

                if(day > 31){
                    return false;
                }

                if(month == 2){
                    if(new Date(year, 1, 29).getDate() == 29 && day > 29){
                        return false;
                    }
                    else if(new Date(year, 1, 29).getDate() != 29 && day > 28){
                        return false;
                    }
                }

                return true;
            }
        },
        diff: function (now, then) {
            return moment(now).diff(moment(then));
        }
    };

    jfgrid.isdatatype = function (s) {
        var type = "string";
        if (jfgrid.datecontroll.isdatetime(s)) {
            type = "date";
        }
        else if (!isNaN(parseFloat(s)) && !jfgrid.hasChinaword(s)) {
            type = "num";
        }
        return type;
    }

    jfgrid.isdatatypemulti = function (s) {
        var type = {};
        if (jfgrid.datecontroll.isdatetime(s)) {
            type["date"] = true;
        }

        if (!isNaN(parseFloat(s)) && !jfgrid.hasChinaword(s)) {
            type["num"] = true;
        }

        return type;
    }

    jfgrid.numfloatlen = function (n) {
        if (n != null && !isNaN(parseFloat(n)) && !jfgrid.hasChinaword(n)) {
            var value = numeral(n).value();
            var lens = value.toString().split(".");
            if (lens.length == 1) {
                lens = 0;
            }
            else {
                lens = lens[1].length;
            }
            return lens;
        }
        else {
            return null;
        }
    }

    jfgrid.range_config = function(rangeConfigCheck, rangeRowCheck, rangeColCheck){
        if(rangeConfigCheck){
            jfgrid.chartparam.jgridCurrentChartData = jfgrid.jgfridturntrans(jfgrid.chartparam.jgridCurrentChartData);
        }

        if (rangeRowCheck) {
            //jfgrid.chartparam.jgridCurrentChartData.shift();
        }
        else {
            var addrow = [];
            //旧图表转置功能和设置列行配合
            var c_st,c_length;
            if(rangeConfigCheck){
                c_st = jfgrid.chartparam.jgridCurrentChartSelection["row"][0];
                c_length = jfgrid.chartparam.jgridCurrentChartSelection["row"][1];
            }else{
                c_st = jfgrid.chartparam.jgridCurrentChartSelection["column"][0];
                c_length = jfgrid.chartparam.jgridCurrentChartSelection["column"][1]
            }
             
            for (var i = c_st; i <= c_length; i++) {
                if(rangeColCheck && i==c_st){//选中列为标签列时，先添加标题
                    addrow.push("");
                }else{
                    addrow.push(jfgrid.jfgridchatatABC(i));
                }
                
                
            }
            jfgrid.chartparam.jgridCurrentChartData.unshift(addrow);
        }

        if (rangeColCheck) {
            // for (var i = 0; i < jfgrid.chartparam.jgridCurrentChartData.length; i++) {
            //     jfgrid.chartparam.jgridCurrentChartData[i].shift();
            // }
        }
        else {
            //console.log(jfgrid.chartparam.jgridCurrentChartData, jfgrid.chartparam.jgridCurrentChartSelection);
            var curlen = jfgrid.chartparam.jgridCurrentChartData.length;
            //var $rowcheck = $("#jfgrid-datavisual-range-config-row");
            jfgrid.chartparam.jgridCurrentChartData[0].unshift(""); //无论rangeRowCheck为何值都添加
            for (var i = 1; i < curlen; i++) {
                // if(rangeRowCheck && i==0 || ){
                //     jfgrid.chartparam.jgridCurrentChartData[i].unshift("");
                // }
                // else{
                    var fix = 0;
                    if(rangeRowCheck){
                        fix = 1;
                    }
                    jfgrid.chartparam.jgridCurrentChartData[i].unshift(jfgrid.jfgridchatatABC(jfgrid.chartparam.jgridCurrentChartSelection["column"][0]) + (i + jfgrid.chartparam.jgridCurrentChartSelection["row"][0] + fix));
                // }
                
            }
            //jfgrid.chartparam.jgridCurrentChartData.unshift(addrow);
        }
    }

    jfgrid.numFormat = function (num, type) {
        if (num == null || isNaN(parseFloat(num)) || jfgrid.hasChinaword(num) || num == -Infinity || num == Infinity) {
            return null;
        }

        var floatlen = 6, ismustfloat = false;
        if (type == null || type == "auto") {
            if (num < 1) {
                floatlen = 6;
            }
            else {
                floatlen = 1;
            }
        }
        else {
            if (jfgrid.isdatatype(type) == "num") {
                floatlen = parseInt(type);
                ismustfloat = true;
            }
            else {
                floatlen = 6;
            }
        }

        var format = "", value = null;
        for (var i = 0; i < floatlen; i++) {
            format += "0";
        }

        if (!ismustfloat) {
            format = "[" + format + "]";
        }

        if(num >= 1e+21){
            value = parseFloat(numeral(num).value());
        }
        else{
            value = parseFloat(numeral(num).format("0." + format));
        }

        return value;
    }

    jfgrid.array = {
        transpose: function (getdata) {
            var arr = [];
            //console.log(getdata);
            if (getdata.length == 0) {
                return [];
            }

            if (getdata[0].length == 0) {
                return [];
            }

            for (var c = 0; c < getdata[0].length; c++) {
                var a = [];
                for (var r = 0; r < getdata.length; r++) {
                    var value = "";
                    if (getdata[r] != null && getdata[r][c] != null) {
                        value = jfgrid.getcellvalue(r, c, getdata);
                    }
                    //console.log(value);
                    a.push(value);
                }
                arr.push(a);
            }

            return arr;
        },
        minusClear:function(p, m){
            if(m.row[0]>p.row[1] || m.row[1]<p.row[0] || m.column[0]>p.column[1] || m.column[1]<p.column[0]){
                return null;
            }

            if(m.row[0]==p.row[0] && m.row[1]<p.row[1] && m.column[0]>p.column[0] && m.column[1]<p.column[1]){
                return [];
            }

            var ret = [], range = {row:[], column:[]};

            var row = null, column = [p.column[0], p.column[1]];
            if(m.row[1]>p.row[0] && m.row[1]<p.row[1]){
                row = [m.row[1]+1, p.row[1]];
            }
            else if(m.row[0]>p.row[0] && m.row[0]<p.row[1]){
                row = [p.row[0], m.row[0]-1];
            }

            if(row!=null){
                ret.push({"row":row, "column":column});
            }
            

            var row = [p.row[0], p.row[1]], column = null;
            if(m.column[1]>p.column[0] && m.column[1]<p.column[1]){
                column = [m.column[1]+1, p.column[1]];
            }
            else if(m.column[0]>p.column[0] && m.column[0]<p.column[1]){
                column = [p.column[0], m.column[0]-1];
            }

            if(column!=null){
                ret.push({"row":row, "column":column});
            }

            //console.log(ret);
            
            return ret;

            // for(var r =p.row[0];r<=p.row[1];r++){
            //     var 
            //     for(var c =p.column[0];c<=p.column[1];c++){

            //     }
            // }
        }
    }

    jfgrid.analysis = {
        "STDEVP": function (mean, array1d) {
            var cov = 0;
            for (var i = 0; i < array1d.length; i++) {
                var xi = array1d[i];
                cov += Math.pow(xi - mean, 2);
            }
            return jfgrid.numFormat(Math.sqrt(cov / array1d.length));
        },
        "STDEV": function (mean, array1d) {
            var cov = 0;
            for (var i = 0; i < array1d.length; i++) {
                var xi = array1d[i];
                cov += Math.pow(xi - mean, 2);
            }
            return jfgrid.numFormat(Math.sqrt(cov / (array1d.length - 1)));
        },
        "VARP": function (mean, array1d) {
            var cov = 0;
            for (var i = 0; i < array1d.length; i++) {
                var xi = array1d[i];
                cov += Math.pow(xi - mean, 2);
            }
            return jfgrid.numFormat(cov / array1d.length);
        },
        "VAR": function (mean, array1d) {
            var cov = 0;
            for (var i = 0; i < array1d.length; i++) {
                var xi = array1d[i];
                cov += Math.pow(xi - mean, 2);
            }
            return jfgrid.numFormat(cov / (array1d.length - 1));
        },
    };

    jfgrid.tooltip = {
        info: function (title, content) {
            $("#jfgrid-modal-dialog-mask").show();
            $("#jfgrid-info").remove();
            $("body").append(jfgrid.replaceHtml(modelHTML, { "id": "jfgrid-info", "addclass": "", "title": title, "content": content, "botton": '<button class="btn btn-default jfgrid-model-close-btn">&nbsp;&nbsp;关闭&nbsp;&nbsp;</button>', "style": "z-index:100003" }));
            var $t = $("#jfgrid-info").find(".jfgrid-modal-dialog-content").css("min-width", 300).end(), myh = $t.outerHeight(), myw = $t.outerWidth();
            var winw = $(window).width(), winh = $(window).height();
            var scrollLeft = $(document).scrollLeft(), scrollTop = $(document).scrollTop();
            $("#jfgrid-info").css({ "left": (winw + scrollLeft - myw) / 2, "top": (winh + scrollTop - myh) / 3 }).show();
        },
        confirm: function (title, content, func1, func2, name1, name2) {
            $("#jfgrid-modal-dialog-mask").show();
            $("#jfgrid-confirm").remove();
            if(name1==null){
                name1 = "确定";
            }
            if(name2==null){
                name2 = "取消";
            }
            $("body").append(jfgrid.replaceHtml(modelHTML, { "id": "jfgrid-confirm", "addclass": "", "style": "z-index:100003", "title": title, "content": content, "botton": '<button class="btn btn-primary jfgrid-model-conform-btn">&nbsp;&nbsp;'+ name1 +'&nbsp;&nbsp;</button><button class="btn btn-default jfgrid-model-cancel-btn">&nbsp;&nbsp;'+ name2 +'&nbsp;&nbsp;</button>' }));
            var $t = $("#jfgrid-confirm").find(".jfgrid-modal-dialog-content").css("min-width", 300).end(), myh = $t.outerHeight(), myw = $t.outerWidth();
            var winw = $(window).width(), winh = $(window).height();
            var scrollLeft = $(document).scrollLeft(), scrollTop = $(document).scrollTop();
            $("#jfgrid-confirm").css({ "left": (winw + scrollLeft - myw) / 2, "top": (winh + scrollTop - myh) / 3 }).show();
            $t.find(".jfgrid-model-conform-btn").click(function () {
                if (typeof func1 == 'function') {
                    func1();
                }
                $("#jfgrid-confirm").hide();
                $("#jfgrid-modal-dialog-mask").hide();  
            });
            $t.find(".jfgrid-model-cancel-btn").click(function () {
                if (typeof func2 == 'function') {
                    func2();
                }
                $("#jfgrid-confirm").hide();
                $("#jfgrid-modal-dialog-mask").hide();
            });
        },
        screenshot: function (title, content, imgurl) {
            $("#jfgrid-modal-dialog-mask").show();
            $("#jfgrid-confirm").remove();
            $("body").append(jfgrid.replaceHtml(modelHTML, { "id": "jfgrid-confirm", "addclass": "", "style": "z-index:100003", "title": title, "content": content, "botton": '<a style="text-decoration:none;color:#fff;" class="download btn btn-primary jfgrid-model-conform-btn">&nbsp;&nbsp;下载&nbsp;&nbsp;</a>&nbsp;&nbsp;<button class="btn btn-danger jfgrid-model-copy-btn">&nbsp;&nbsp;复制到剪切板&nbsp;&nbsp;</button><button class="btn btn-default jfgrid-model-cancel-btn">&nbsp;&nbsp;关闭&nbsp;&nbsp;</button>' }));
            var $t = $("#jfgrid-confirm").find(".jfgrid-modal-dialog-content").css("min-width", 300).end(), myh = $t.outerHeight(), myw = $t.outerWidth();
            var winw = $(window).width(), winh = $(window).height();
            var scrollLeft = $(document).scrollLeft(), scrollTop = $(document).scrollTop();
            $("#jfgrid-confirm").css({ "left": (winw + scrollLeft - myw) / 2, "top": (winh + scrollTop - myh) / 3 }).show();
            $t.find(".jfgrid-model-conform-btn").click(function () {
                if(jfgrid.browser.isIE() == "1"){
                    alert("下载功能IE浏览器不支持！");
                }
                else{
                    if (!!window.ActiveXObject || "ActiveXObject" in window){
                        if ($("#IframeReportImg").length === 0){
                            $('<iframe style="display:none;" id="IframeReportImg" name="IframeReportImg" onload="downloadImg();" width="0" height="0" src="about:blank"></iframe>').appendTo("body");
                        }
                        if ($('#IframeReportImg').attr("src") != imgurl) {
                            $('#IframeReportImg').attr("src",imgurl);
                        } else {
                            if ($('#IframeReportImg').src != "about:blank") {
                                window.frames["IframeReportImg"].document.execCommand("SaveAs");
                            }
                        }
                    }  
                }
            });
            $t.find(".jfgrid-model-cancel-btn").click(function () {
                $("#jfgrid-confirm").hide();
                $("#jfgrid-modal-dialog-mask").hide();
            });

            $('#jfgrid-confirm .jfgrid-model-copy-btn').click(function(){
                var dt = new clipboard.DT();
                dt.setData("text/html", "<img src='"+ imgurl +"'>");
                if(jfgrid.browser.isIE() == "1"){
                    alert("请在图片上右键点击'复制'");
                }
                else{
                    clipboard.write(dt);
                    alert("已成功复制（如果粘贴失败，请在图片上右键点击'复制图片'）");  
                }
            });
        },
        chartPointConfig: function (id, savefunc1, closefunc2) {
            $("body").append(jfgrid.replaceHtml(modelHTML, { "id": id, "addclass": "jfgrid-chart-point-config-c", "title": "数据点批量设置", "content": jfgridchartpointconfigHTML, "botton": '<button class="btn btn-danger jfgrid-model-save-btn">&nbsp;&nbsp;保存设置&nbsp;&nbsp;</button><button class="btn btn-default jfgrid-model-close-btn">&nbsp;&nbsp;取消&nbsp;&nbsp;</button>', "style": "z-index:100003;height:80%;width:80%;top:10%;left:10%;" }));
            $("#jfgrid-modal-dialog-mask").show();
            var winw = $(window).width(), winh = $(window).height();
            $("#" + id).find(".jfgrid-chart-point-config").css("height", winh - 160);
            $("#" + id).css({ "height": winh - 90, width: winw - 100, "left": 7, "top": 14 }).show().find(".jfgrid-model-save-btn").click(function () {
                if (typeof savefunc1 == 'function') {
                    savefunc1();
                }

                $("#" + id).hide();
                $("#jfgrid-modal-dialog-mask").hide();
            });

            $("#" + id).find(".jfgrid-model-save-btn").click(function () {
                if (typeof closefunc2 == 'function') {
                    closefunc2();
                }

                $("#" + id).hide();
                $("#jfgrid-modal-dialog-mask").hide();
            });

        },
        sheetConfig: function () {

        },
        hoverTipshowState:false,
        hoverTipshowTimeOut:null,
        createHoverTip:function (obj, to) {
	        $(obj).on("mouseover", to, function (e) {

	            if (jfgrid.tooltip.hoverTipshowState) {
	                return;
	            }
                clearTimeout(jfgrid.tooltip.hoverTipshowTimeOut);
                jfgrid.tooltip.hoverTipshowTimeOut = setTimeout(function(){

                
    	            var $t = $(e.currentTarget), toffset = $t.offset(), $toolup = $("#jfgrid-tooltip-up");
    	            var tips = $t.data("tips");
    	            if (tips == null || tips.length == 0) {
    	                tips = $t.prev().data("tips");
    	                if (tips == null || tips.length == 0) {
    	                    return;
    	                }
    	            }

    	            if ($toolup.length == 0) {
    	                $("body").append(jfgridToolHTML);
    	                $toolup = $("#jfgrid-tooltip-up");
    	            }

    	            $toolup.removeClass("jfk-tooltip-hide").find("div.jfk-tooltip-contentId").html(tips);
    	            var toolwidth = $toolup.outerWidth();
    	            $toolup.find("div.jfk-tooltip-arrow").css("left", (toolwidth) / 2);

                    var toolleft = toffset.left + ($t.outerWidth() - toolwidth) / 2;
                    if(toolleft<2){
                        toolleft = 2;
                        $toolup.find("div.jfk-tooltip-arrow").css("left", $t.outerWidth()/2);
                    }

    	            $toolup.css({ "top": toffset.top + $t.outerHeight() + 1, "left": toolleft });
                }, 300);

	        }).on("mouseout", to, function (e) {
	            jfgrid.tooltip.hoverTipshowState = false;
                clearTimeout(jfgrid.tooltip.hoverTipshowTimeOut);
	            $("#jfgrid-tooltip-up").addClass("jfk-tooltip-hide");
	        }).on("click", to, function (e) {
	            jfgrid.tooltip.hoverTipshowState = true;
                clearTimeout(jfgrid.tooltip.hoverTipshowTimeOut);
	            $("#jfgrid-tooltip-up").addClass("jfk-tooltip-hide");
	        });
        },
        popover:function(content, position, close, style, btntxt,exitsFuc){
            if(btntxt==null){
                btntxt = "关闭";
            }

            var htmldiv = '<div id="jfgridpopover" class="jfgridpopover"><div class="jfgridpopover-content">格式刷开启</div><div class="jfgridpopover-btn">'+ btntxt +'</div></div>';
            $("#jfgridpopover").remove();
            $("body").append(htmldiv);
            //var winW = $(window).width(),winH = $(window).height();
            $("#jfgridpopover .jfgridpopover-content").html(content);
            var w = $("#jfgridpopover").outerWidth(),h = $("#jfgridpopover").outerHeight();
            var pcss = {};

            if(position == 'topLeft'){
                pcss.top = "20px";
                pcss.left = "20px";
            }
            else if(position == 'topCenter'){
                pcss.top = "20px";
                pcss.left = "50%";
                pcss["margin-left"] = -w/2;
            }
            else if(position == 'topRight'){
                pcss.top = "20px";
                pcss.right = "20px";
            }
            else if(position == 'midLeft'){
                pcss.top = "50%";
                pcss["margin-top"] = -h/2;
                pcss.left = "20px";
            }
            else if(position == 'center'){
                pcss.top = "50%";
                pcss["margin-top"] = -h/2;
                pcss.left = "50%";
                pcss["margin-left"] = -w/2;
            }
            else if(position == 'midRight'){
                pcss.top = "50%";
                pcss["margin-top"] = -h/2;
                pcss.right = "20px";
            }
            else if(position == 'bottomLeft'){
                pcss.bottom = "20px";
                pcss.left = "20px";
            }
            else if(position == 'bottomCenter'){
                pcss.bottom = "20px";
                pcss.left = "50%";
                pcss["margin-left"] = -w/2;
            }
            else if(position == 'bottomRight'){
                pcss.bottom = "20px";
                pcss.right = "20px";
            }
            else{
                pcss.top = "20px";
                pcss.left = "50%";
                pcss["margin-left"] = -w/2;
            }

            if(style=="white"){
                pcss.background = "rgba(255,255,255,0.65)";
                pcss.color = "#000";
                $("#jfgridpopover .jfgridpopover-btn").css({"border":"1px solid #000"});
            }

            setTimeout(function(){
                $("#jfgridpopover .jfgridpopover-content").css({"margin-left": -$("#jfgridpopover .jfgridpopover-btn").outerWidth()/2});
            }, 1);
            $("#jfgridpopover").css(pcss).fadeIn();
            $("#jfgridpopover .jfgridpopover-btn").click(function(){
                if(typeof(exitsFuc) == "function"){
                    exitsFuc();
                }
            });

            if(close!=null && typeof(close)=="number"){
                setTimeout(function(){
                    $("#jfgridpopover").fadeOut().remove();
                    if(typeof(exitsFuc) == "function"){
                        exitsFuc();
                    }
                }, close);
            }

        }

    }

    jfgrid.mask = (function(){
        var SSF = ({});
        var make_ssf = function make_ssf(SSF) {
            SSF.version = '0.10.2';

            function _strrev(x) {
                var o = "",
                    i = x.length - 1;
                while (i >= 0) o += x.charAt(i--);
                return o;
            }

            function fill(c, l) {
                var o = "";
                while (o.length < l) o += c;
                return o;
            }

            function pad0(v, d) {
                var t = "" + v;
                return t.length >= d ? t : fill('0', d - t.length) + t;
            }

            function pad_(v, d) {
                var t = "" + v;
                return t.length >= d ? t : fill(' ', d - t.length) + t;
            }

            function rpad_(v, d) {
                var t = "" + v;
                return t.length >= d ? t : t + fill(' ', d - t.length);
            }

            function pad0r1(v, d) {
                var t = "" + Math.round(v);
                return t.length >= d ? t : fill('0', d - t.length) + t;
            }

            function pad0r2(v, d) {
                var t = "" + v;
                return t.length >= d ? t : fill('0', d - t.length) + t;
            }
            var p2_32 = Math.pow(2, 32);

            function pad0r(v, d) {
                if (v > p2_32 || v < -p2_32) return pad0r1(v, d);
                var i = Math.round(v);
                return pad0r2(i, d);
            }

            function isgeneral(s, i) {
                i = i || 0;
                return s.length >= 7 + i && (s.charCodeAt(i) | 32) === 103 && (s.charCodeAt(i + 1) | 32) === 101 && (s.charCodeAt(i + 2) | 32) === 110 && (s.charCodeAt(i + 3) | 32) === 101 && (s.charCodeAt(i + 4) | 32) === 114 && (s.charCodeAt(i + 5) | 32) === 97 && (s.charCodeAt(i + 6) | 32) === 108;
            }
            var days = [
                ['Sun', 'Sunday'],
                ['Mon', 'Monday'],
                ['Tue', 'Tuesday'],
                ['Wed', 'Wednesday'],
                ['Thu', 'Thursday'],
                ['Fri', 'Friday'],
                ['Sat', 'Saturday']
            ];
            var months = [
                ['J', 'Jan', 'January'],
                ['F', 'Feb', 'February'],
                ['M', 'Mar', 'March'],
                ['A', 'Apr', 'April'],
                ['M', 'May', 'May'],
                ['J', 'Jun', 'June'],
                ['J', 'Jul', 'July'],
                ['A', 'Aug', 'August'],
                ['S', 'Sep', 'September'],
                ['O', 'Oct', 'October'],
                ['N', 'Nov', 'November'],
                ['D', 'Dec', 'December']
            ];

            function init_table(t) {
                t[0] = 'General';
                t[1] = '0';
                t[2] = '0.00';
                t[3] = '#,##0';
                t[4] = '#,##0.00';
                t[9] = '0%';
                t[10] = '0.00%';
                t[11] = '0.00E+00';
                t[12] = '# ?/?';
                t[13] = '# ??/??';
                t[14] = 'm/d/yy';
                t[15] = 'd-mmm-yy';
                t[16] = 'd-mmm';
                t[17] = 'mmm-yy';
                t[18] = 'h:mm AM/PM';
                t[19] = 'h:mm:ss AM/PM';
                t[20] = 'h:mm';
                t[21] = 'h:mm:ss';
                t[22] = 'm/d/yy h:mm';
                t[37] = '#,##0 ;(#,##0)';
                t[38] = '#,##0 ;[Red](#,##0)';
                t[39] = '#,##0.00;(#,##0.00)';
                t[40] = '#,##0.00;[Red](#,##0.00)';
                t[45] = 'mm:ss';
                t[46] = '[h]:mm:ss';
                t[47] = 'mmss.0';
                t[48] = '##0.0E+0';
                t[49] = '@';
                t[56] = '"上午/下午 "hh"時"mm"分"ss"秒 "';
                t[65535] = 'General';
            }
            var table_fmt = {};
            init_table(table_fmt);

            function frac(x, D, mixed) {
                var sgn = x < 0 ? -1 : 1;
                var B = x * sgn;
                var P_2 = 0,
                    P_1 = 1,
                    P = 0;
                var Q_2 = 1,
                    Q_1 = 0,
                    Q = 0;
                var A = Math.floor(B);
                while (Q_1 < D) {
                    A = Math.floor(B);
                    P = A * P_1 + P_2;
                    Q = A * Q_1 + Q_2;
                    if ((B - A) < 0.00000005) break;
                    B = 1 / (B - A);
                    P_2 = P_1;
                    P_1 = P;
                    Q_2 = Q_1;
                    Q_1 = Q;
                }
                if (Q > D) {
                    if (Q_1 > D) {
                        Q = Q_2;
                        P = P_2;
                    } else {
                        Q = Q_1;
                        P = P_1;
                    }
                }
                if (!mixed) return [0, sgn * P, Q];
                var q = Math.floor(sgn * P / Q);
                return [q, sgn * P - q * Q, Q];
            }

            function parse_date_code(v, opts, b2) {
                if (v > 2958465 || v < 0) return null;
                var date = (v | 0),
                    time = Math.floor(86400 * (v - date)),
                    dow = 0;
                var dout = [];
                var out = {
                    D: date,
                    T: time,
                    u: 86400 * (v - date) - time,
                    y: 0,
                    m: 0,
                    d: 0,
                    H: 0,
                    M: 0,
                    S: 0,
                    q: 0
                };
                if (Math.abs(out.u) < 1e-6) out.u = 0;
                if (opts && opts.date1904) date += 1462;
                if (out.u > 0.9999) {
                    out.u = 0;
                    if (++time == 86400) {
                        out.T = time = 0;
                        ++date;
                        ++out.D;
                    }
                }
                if (date === 60) {
                    dout = b2 ? [1317, 10, 29] : [1900, 2, 29];
                    dow = 3;
                } else if (date === 0) {
                    dout = b2 ? [1317, 8, 29] : [1900, 1, 0];
                    dow = 6;
                } else {
                    if (date > 60) --date;
                    /* 1 = Jan 1 1900 in Gregorian */
                    var d = new Date(1900, 0, 1);
                    d.setDate(d.getDate() + date - 1);
                    dout = [d.getFullYear(), d.getMonth() + 1, d.getDate()];
                    dow = d.getDay();
                    if (date < 60) dow = (dow + 6) % 7;
                    if (b2) dow = fix_hijri(d, dout);
                }
                out.y = dout[0];
                out.m = dout[1];
                out.d = dout[2];
                out.S = time % 60;
                time = Math.floor(time / 60);
                out.M = time % 60;
                time = Math.floor(time / 60);
                out.H = time;
                out.q = dow;
                return out;
            }
            SSF.parse_date_code = parse_date_code;
            var basedate = new Date(1899, 11, 31, 0, 0, 0);
            var dnthresh = basedate.getTime();
            var base1904 = new Date(1900, 2, 1, 0, 0, 0);

            function datenum_local(v, date1904) {
                var epoch = v.getTime();
                if (date1904) epoch -= 1461 * 24 * 60 * 60 * 1000;
                else if (v >= base1904) epoch += 24 * 60 * 60 * 1000;
                return (epoch - (dnthresh + (v.getTimezoneOffset() - basedate.getTimezoneOffset()) * 60000)) / (24 * 60 * 60 * 1000);
            }

            function general_fmt_int(v) {
                return v.toString(10);
            }
            SSF._general_int = general_fmt_int;
            var general_fmt_num = (function make_general_fmt_num() {
                var gnr1 = /\.(\d*[1-9])0+$/,
                    gnr2 = /\.0*$/,
                    gnr4 = /\.(\d*[1-9])0+/,
                    gnr5 = /\.0*[Ee]/,
                    gnr6 = /(E[+-])(\d)$/;

                function gfn2(v) {
                    var w = (v < 0 ? 12 : 11);
                    var o = gfn5(v.toFixed(12));
                    if (o.length <= w) return o;
                    o = v.toPrecision(10);
                    if (o.length <= w) return o;
                    return v.toExponential(5);
                }

                function gfn3(v) {
                    var o = v.toFixed(11).replace(gnr1, ".$1");
                    if (o.length > (v < 0 ? 12 : 11)) o = v.toPrecision(6);
                    return o;
                }

                function gfn4(o) {
                    for (var i = 0; i != o.length; ++i)
                        if ((o.charCodeAt(i) | 0x20) === 101) return o.replace(gnr4, ".$1").replace(gnr5, "E").replace("e", "E").replace(gnr6, "$10$2");
                    return o;
                }

                function gfn5(o) {
                    return o.indexOf(".") > -1 ? o.replace(gnr2, "").replace(gnr1, ".$1") : o;
                }
                return function general_fmt_num(v) {
                    var V = Math.floor(Math.log(Math.abs(v)) * Math.LOG10E),
                        o;
                    if (V >= -4 && V <= -1) o = v.toPrecision(10 + V);
                    else if (Math.abs(V) <= 9) o = gfn2(v);
                    else if (V === 10) o = v.toFixed(10).substr(0, 12);
                    else o = gfn3(v);
                    return gfn5(gfn4(o));
                };
            })();
            SSF._general_num = general_fmt_num;

            function general_fmt(v, opts) {
                switch (typeof v) {
                    case 'string':
                        return v;
                    case 'boolean':
                        return v ? "TRUE" : "FALSE";
                    case 'number':
                        return (v | 0) === v ? general_fmt_int(v) : general_fmt_num(v);
                    case 'undefined':
                        return "";
                    case 'object':
                        if (v == null) return "";
                        if (v instanceof Date) return format(14, datenum_local(v, opts && opts.date1904), opts);
                }
                throw new Error("unsupported value in General format: " + v);
            }
            SSF._general = general_fmt;

            function fix_hijri() {
                return 0;
            }
            /*jshint -W086 */
            function write_date(type, fmt, val, ss0) {
                var o = "",
                    ss = 0,
                    tt = 0,
                    y = val.y,
                    out, outl = 0;
                switch (type) {
                    case 98:
                        /* 'b' buddhist year */ y = val.y + 543;
                        /* falls through */
                    case 121:
                        /* 'y' year */ switch (fmt.length) {
                            case 1:
                            case 2:
                                out = y % 100;
                                outl = 2;
                                break;
                            default:
                                out = y % 10000;
                                outl = 4;
                                break;
                        }
                        break;
                    case 109:
                        /* 'm' month */ switch (fmt.length) {
                            case 1:
                            case 2:
                                out = val.m;
                                outl = fmt.length;
                                break;
                            case 3:
                                return months[val.m - 1][1];
                            case 5:
                                return months[val.m - 1][0];
                            default:
                                return months[val.m - 1][2];
                        }
                        break;
                    case 100:
                        /* 'd' day */ switch (fmt.length) {
                            case 1:
                            case 2:
                                out = val.d;
                                outl = fmt.length;
                                break;
                            case 3:
                                return days[val.q][0];
                            default:
                                return days[val.q][1];
                        }
                        break;
                    case 104:
                        /* 'h' 12-hour */ switch (fmt.length) {
                            case 1:
                            case 2:
                                out = 1 + (val.H + 11) % 12;
                                outl = fmt.length;
                                break;
                            default:
                                throw 'bad hour format: ' + fmt;
                        }
                        break;
                    case 72:
                        /* 'H' 24-hour */ switch (fmt.length) {
                            case 1:
                            case 2:
                                out = val.H;
                                outl = fmt.length;
                                break;
                            default:
                                throw 'bad hour format: ' + fmt;
                        }
                        break;
                    case 77:
                        /* 'M' minutes */ switch (fmt.length) {
                            case 1:
                            case 2:
                                out = val.M;
                                outl = fmt.length;
                                break;
                            default:
                                throw 'bad minute format: ' + fmt;
                        }
                        break;
                    case 115:
                        /* 's' seconds */ if (fmt != 's' && fmt != 'ss' && fmt != '.0' && fmt != '.00' && fmt != '.000') throw 'bad second format: ' + fmt;
                        if (val.u === 0 && (fmt == "s" || fmt == "ss")) return pad0(val.S, fmt.length);
                        if (ss0 >= 2) tt = ss0 === 3 ? 1000 : 100;
                        else tt = ss0 === 1 ? 10 : 1;
                        ss = Math.round((tt) * (val.S + val.u));
                        if (ss >= 60 * tt) ss = 0;
                        if (fmt === 's') return ss === 0 ? "0" : "" + ss / tt;
                        o = pad0(ss, 2 + ss0);
                        if (fmt === 'ss') return o.substr(0, 2);
                        return "." + o.substr(2, fmt.length - 1);
                    case 90:
                        /* 'Z' absolute time */ switch (fmt) {
                            case '[h]':
                            case '[hh]':
                                out = val.D * 24 + val.H;
                                break;
                            case '[m]':
                            case '[mm]':
                                out = (val.D * 24 + val.H) * 60 + val.M;
                                break;
                            case '[s]':
                            case '[ss]':
                                out = ((val.D * 24 + val.H) * 60 + val.M) * 60 + Math.round(val.S + val.u);
                                break;
                            default:
                                throw 'bad abstime format: ' + fmt;
                        }
                        outl = fmt.length === 3 ? 1 : 2;
                        break;
                    case 101:
                        /* 'e' era */ out = y;
                        outl = 1;
                }
                if (outl > 0) return pad0(out, outl);
                else return "";
            }
            /*jshint +W086 */
            function commaify(s) {
                var w = 3;
                if (s.length <= w) return s;
                var j = (s.length % w),
                    o = s.substr(0, j);
                for (; j != s.length; j += w) o += (o.length > 0 ? "," : "") + s.substr(j, w);
                return o;
            }
            var write_num = (function make_write_num() {
                var pct1 = /%/g;

                function write_num_pct(type, fmt, val) {
                    var sfmt = fmt.replace(pct1, ""),
                        mul = fmt.length - sfmt.length;
                    return write_num(type, sfmt, val * Math.pow(10, 2 * mul)) + fill("%", mul);
                }

                function write_num_cm(type, fmt, val) {
                    var idx = fmt.length - 1;
                    while (fmt.charCodeAt(idx - 1) === 44) --idx;
                    return write_num(type, fmt.substr(0, idx), val / Math.pow(10, 3 * (fmt.length - idx)));
                }

                function write_num_exp(fmt, val) {
                    var o;
                    var idx = fmt.indexOf("E") - fmt.indexOf(".") - 1;
                    if (fmt.match(/^#+0.0E\+0$/)) {
                        if (val == 0) return "0.0E+0";
                        else if (val < 0) return "-" + write_num_exp(fmt, -val);
                        var period = fmt.indexOf(".");
                        if (period === -1) period = fmt.indexOf('E');
                        var ee = Math.floor(Math.log(val) * Math.LOG10E) % period;
                        if (ee < 0) ee += period;
                        o = (val / Math.pow(10, ee)).toPrecision(idx + 1 + (period + ee) % period);
                        if (o.indexOf("e") === -1) {
                            var fakee = Math.floor(Math.log(val) * Math.LOG10E);
                            if (o.indexOf(".") === -1) o = o.charAt(0) + "." + o.substr(1) + "E+" + (fakee - o.length + ee);
                            else o += "E+" + (fakee - ee);
                            while (o.substr(0, 2) === "0.") {
                                o = o.charAt(0) + o.substr(2, period) + "." + o.substr(2 + period);
                                o = o.replace(/^0+([1-9])/, "$1").replace(/^0+\./, "0.");
                            }
                            o = o.replace(/\+-/, "-");
                        }
                        o = o.replace(/^([+-]?)(\d*)\.(\d*)[Ee]/, function($$, $1, $2, $3) {
                            return $1 + $2 + $3.substr(0, (period + ee) % period) + "." + $3.substr(ee) + "E";
                        });
                    } else o = val.toExponential(idx);
                    if (fmt.match(/E\+00$/) && o.match(/e[+-]\d$/)) o = o.substr(0, o.length - 1) + "0" + o.charAt(o.length - 1);
                    if (fmt.match(/E\-/) && o.match(/e\+/)) o = o.replace(/e\+/, "e");
                    return o.replace("e", "E");
                }
                var frac1 = /# (\?+)( ?)\/( ?)(\d+)/;

                function write_num_f1(r, aval, sign) {
                    var den = parseInt(r[4], 10),
                        rr = Math.round(aval * den),
                        base = Math.floor(rr / den);
                    var myn = (rr - base * den),
                        myd = den;
                    return sign + (base === 0 ? "" : "" + base) + " " + (myn === 0 ? fill(" ", r[1].length + 1 + r[4].length) : pad_(myn, r[1].length) + r[2] + "/" + r[3] + pad0(myd, r[4].length));
                }

                function write_num_f2(r, aval, sign) {
                    return sign + (aval === 0 ? "" : "" + aval) + fill(" ", r[1].length + 2 + r[4].length);
                }
                var dec1 = /^#*0*\.([0#]+)/;
                var closeparen = /\).*[0#]/;
                var phone = /\(###\) ###\\?-####/;

                function hashq(str) {
                    var o = "",
                        cc;
                    for (var i = 0; i != str.length; ++i) switch ((cc = str.charCodeAt(i))) {
                        case 35:
                            break;
                        case 63:
                            o += " ";
                            break;
                        case 48:
                            o += "0";
                            break;
                        default:
                            o += String.fromCharCode(cc);
                    }
                    return o;
                }

                function rnd(val, d) {
                    var dd = Math.pow(10, d);
                    return "" + (Math.round(val * dd) / dd);
                }

                function dec(val, d) {
                    if (d < ('' + Math.round((val - Math.floor(val)) * Math.pow(10, d))).length) {
                        return 0;
                    }
                    return Math.round((val - Math.floor(val)) * Math.pow(10, d));
                }

                function carry(val, d) {
                    if (d < ('' + Math.round((val - Math.floor(val)) * Math.pow(10, d))).length) {
                        return 1;
                    }
                    return 0;
                }

                function flr(val) {
                    if (val < 2147483647 && val > -2147483648) return "" + (val >= 0 ? (val | 0) : (val - 1 | 0));
                    return "" + Math.floor(val);
                }

                function write_num_flt(type, fmt, val) {
                    if (type.charCodeAt(0) === 40 && !fmt.match(closeparen)) {
                        var ffmt = fmt.replace(/\( */, "").replace(/ \)/, "").replace(/\)/, "");
                        if (val >= 0) return write_num_flt('n', ffmt, val);
                        return '(' + write_num_flt('n', ffmt, -val) + ')';
                    }
                    if (fmt.charCodeAt(fmt.length - 1) === 44) return write_num_cm(type, fmt, val);
                    if (fmt.indexOf('%') !== -1) return write_num_pct(type, fmt, val);
                    if (fmt.indexOf('E') !== -1) return write_num_exp(fmt, val);
                    if (fmt.charCodeAt(0) === 36) return "$" + write_num_flt(type, fmt.substr(fmt.charAt(1) == ' ' ? 2 : 1), val);
                    var o;
                    var r, ri, ff, aval = Math.abs(val),
                        sign = val < 0 ? "-" : "";
                    if (fmt.match(/^00+$/)) return sign + pad0r(aval, fmt.length);
                    if (fmt.match(/^[#?]+$/)) {
                        o = pad0r(val, 0);
                        if (o === "0") o = "";
                        return o.length > fmt.length ? o : hashq(fmt.substr(0, fmt.length - o.length)) + o;
                    }
                    if ((r = fmt.match(frac1))) return write_num_f1(r, aval, sign);
                    if (fmt.match(/^#+0+$/)) return sign + pad0r(aval, fmt.length - fmt.indexOf("0"));
                    if ((r = fmt.match(dec1))) {
                        o = rnd(val, r[1].length).replace(/^([^\.]+)$/, "$1." + hashq(r[1])).replace(/\.$/, "." + hashq(r[1])).replace(/\.(\d*)$/, function($$, $1) {
                            return "." + $1 + fill("0", hashq(r[1]).length - $1.length);
                        });
                        return fmt.indexOf("0.") !== -1 ? o : o.replace(/^0\./, ".");
                    }
                    fmt = fmt.replace(/^#+([0.])/, "$1");
                    if ((r = fmt.match(/^(0*)\.(#*)$/))) {
                        return sign + rnd(aval, r[2].length).replace(/\.(\d*[1-9])0*$/, ".$1").replace(/^(-?\d*)$/, "$1.").replace(/^0\./, r[1].length ? "0." : ".");
                    }
                    if ((r = fmt.match(/^#{1,3},##0(\.?)$/))) return sign + commaify(pad0r(aval, 0));
                    if ((r = fmt.match(/^#,##0\.([#0]*0)$/))) {
                        return val < 0 ? "-" + write_num_flt(type, fmt, -val) : commaify("" + (Math.floor(val) + carry(val, r[1].length))) + "." + pad0(dec(val, r[1].length), r[1].length);
                    }
                    if ((r = fmt.match(/^#,#*,#0/))) return write_num_flt(type, fmt.replace(/^#,#*,/, ""), val);
                    if ((r = fmt.match(/^([0#]+)(\\?-([0#]+))+$/))) {
                        o = _strrev(write_num_flt(type, fmt.replace(/[\\-]/g, ""), val));
                        ri = 0;
                        return _strrev(_strrev(fmt.replace(/\\/g, "")).replace(/[0#]/g, function(x) {
                            return ri < o.length ? o.charAt(ri++) : x === '0' ? '0' : "";
                        }));
                    }
                    if (fmt.match(phone)) {
                        o = write_num_flt(type, "##########", val);
                        return "(" + o.substr(0, 3) + ") " + o.substr(3, 3) + "-" + o.substr(6);
                    }
                    var oa = "";
                    if ((r = fmt.match(/^([#0?]+)( ?)\/( ?)([#0?]+)/))) {
                        ri = Math.min(r[4].length, 7);
                        ff = frac(aval, Math.pow(10, ri) - 1, false);
                        o = "" + sign;
                        oa = write_num("n", r[1], ff[1]);
                        if (oa.charAt(oa.length - 1) == " ") oa = oa.substr(0, oa.length - 1) + "0";
                        o += oa + r[2] + "/" + r[3];
                        oa = rpad_(ff[2], ri);
                        if (oa.length < r[4].length) oa = hashq(r[4].substr(r[4].length - oa.length)) + oa;
                        o += oa;
                        return o;
                    }
                    if ((r = fmt.match(/^# ([#0?]+)( ?)\/( ?)([#0?]+)/))) {
                        ri = Math.min(Math.max(r[1].length, r[4].length), 7);
                        ff = frac(aval, Math.pow(10, ri) - 1, true);
                        return sign + (ff[0] || (ff[1] ? "" : "0")) + " " + (ff[1] ? pad_(ff[1], ri) + r[2] + "/" + r[3] + rpad_(ff[2], ri) : fill(" ", 2 * ri + 1 + r[2].length + r[3].length));
                    }
                    if ((r = fmt.match(/^[#0?]+$/))) {
                        o = pad0r(val, 0);
                        if (fmt.length <= o.length) return o;
                        return hashq(fmt.substr(0, fmt.length - o.length)) + o;
                    }
                    if ((r = fmt.match(/^([#0?]+)\.([#0]+)$/))) {
                        o = "" + val.toFixed(Math.min(r[2].length, 10)).replace(/([^0])0+$/, "$1");
                        ri = o.indexOf(".");
                        var lres = fmt.indexOf(".") - ri,
                            rres = fmt.length - o.length - lres;
                        return hashq(fmt.substr(0, lres) + o + fmt.substr(fmt.length - rres));
                    }
                    if ((r = fmt.match(/^00,000\.([#0]*0)$/))) {
                        ri = dec(val, r[1].length);
                        return val < 0 ? "-" + write_num_flt(type, fmt, -val) : commaify(flr(val)).replace(/^\d,\d{3}$/, "0$&").replace(/^\d*$/, function($$) {
                            return "00," + ($$.length < 3 ? pad0(0, 3 - $$.length) : "") + $$;
                        }) + "." + pad0(ri, r[1].length);
                    }
                    switch (fmt) {
                        case "###,##0.00":
                            return write_num_flt(type, "#,##0.00", val);
                        case "###,###":
                        case "##,###":
                        case "#,###":
                            var x = commaify(pad0r(aval, 0));
                            return x !== "0" ? sign + x : "";
                        case "###,###.00":
                            return write_num_flt(type, "###,##0.00", val).replace(/^0\./, ".");
                        case "#,###.00":
                            return write_num_flt(type, "#,##0.00", val).replace(/^0\./, ".");
                        default:
                    }
                    throw new Error("unsupported format |" + fmt + "|");
                }

                function write_num_cm2(type, fmt, val) {
                    var idx = fmt.length - 1;
                    while (fmt.charCodeAt(idx - 1) === 44) --idx;
                    return write_num(type, fmt.substr(0, idx), val / Math.pow(10, 3 * (fmt.length - idx)));
                }

                function write_num_pct2(type, fmt, val) {
                    var sfmt = fmt.replace(pct1, ""),
                        mul = fmt.length - sfmt.length;
                    return write_num(type, sfmt, val * Math.pow(10, 2 * mul)) + fill("%", mul);
                }

                function write_num_exp2(fmt, val) {
                    var o;
                    var idx = fmt.indexOf("E") - fmt.indexOf(".") - 1;
                    if (fmt.match(/^#+0.0E\+0$/)) {
                        if (val == 0) return "0.0E+0";
                        else if (val < 0) return "-" + write_num_exp2(fmt, -val);
                        var period = fmt.indexOf(".");
                        if (period === -1) period = fmt.indexOf('E');
                        var ee = Math.floor(Math.log(val) * Math.LOG10E) % period;
                        if (ee < 0) ee += period;
                        o = (val / Math.pow(10, ee)).toPrecision(idx + 1 + (period + ee) % period);
                        if (!o.match(/[Ee]/)) {
                            var fakee = Math.floor(Math.log(val) * Math.LOG10E);
                            if (o.indexOf(".") === -1) o = o.charAt(0) + "." + o.substr(1) + "E+" + (fakee - o.length + ee);
                            else o += "E+" + (fakee - ee);
                            o = o.replace(/\+-/, "-");
                        }
                        o = o.replace(/^([+-]?)(\d*)\.(\d*)[Ee]/, function($$, $1, $2, $3) {
                            return $1 + $2 + $3.substr(0, (period + ee) % period) + "." + $3.substr(ee) + "E";
                        });
                    } else o = val.toExponential(idx);
                    if (fmt.match(/E\+00$/) && o.match(/e[+-]\d$/)) o = o.substr(0, o.length - 1) + "0" + o.charAt(o.length - 1);
                    if (fmt.match(/E\-/) && o.match(/e\+/)) o = o.replace(/e\+/, "e");
                    return o.replace("e", "E");
                }

                function write_num_int(type, fmt, val) {
                    if (type.charCodeAt(0) === 40 && !fmt.match(closeparen)) {
                        var ffmt = fmt.replace(/\( */, "").replace(/ \)/, "").replace(/\)/, "");
                        if (val >= 0) return write_num_int('n', ffmt, val);
                        return '(' + write_num_int('n', ffmt, -val) + ')';
                    }
                    if (fmt.charCodeAt(fmt.length - 1) === 44) return write_num_cm2(type, fmt, val);
                    if (fmt.indexOf('%') !== -1) return write_num_pct2(type, fmt, val);
                    if (fmt.indexOf('E') !== -1) return write_num_exp2(fmt, val);
                    if (fmt.charCodeAt(0) === 36) return "$" + write_num_int(type, fmt.substr(fmt.charAt(1) == ' ' ? 2 : 1), val);
                    var o;
                    var r, ri, ff, aval = Math.abs(val),
                        sign = val < 0 ? "-" : "";
                    if (fmt.match(/^00+$/)) return sign + pad0(aval, fmt.length);
                    if (fmt.match(/^[#?]+$/)) {
                        o = ("" + val);
                        if (val === 0) o = "";
                        return o.length > fmt.length ? o : hashq(fmt.substr(0, fmt.length - o.length)) + o;
                    }
                    if ((r = fmt.match(frac1))) return write_num_f2(r, aval, sign);
                    if (fmt.match(/^#+0+$/)) return sign + pad0(aval, fmt.length - fmt.indexOf("0"));
                    if ((r = fmt.match(dec1))) {
                        o = ("" + val).replace(/^([^\.]+)$/, "$1." + hashq(r[1])).replace(/\.$/, "." + hashq(r[1]));
                        o = o.replace(/\.(\d*)$/, function($$, $1) {
                            return "." + $1 + fill("0", hashq(r[1]).length - $1.length);
                        });
                        return fmt.indexOf("0.") !== -1 ? o : o.replace(/^0\./, ".");
                    }
                    fmt = fmt.replace(/^#+([0.])/, "$1");
                    if ((r = fmt.match(/^(0*)\.(#*)$/))) {
                        return sign + ("" + aval).replace(/\.(\d*[1-9])0*$/, ".$1").replace(/^(-?\d*)$/, "$1.").replace(/^0\./, r[1].length ? "0." : ".");
                    }
                    if ((r = fmt.match(/^#{1,3},##0(\.?)$/))) return sign + commaify(("" + aval));
                    if ((r = fmt.match(/^#,##0\.([#0]*0)$/))) {
                        return val < 0 ? "-" + write_num_int(type, fmt, -val) : commaify(("" + val)) + "." + fill('0', r[1].length);
                    }
                    if ((r = fmt.match(/^#,#*,#0/))) return write_num_int(type, fmt.replace(/^#,#*,/, ""), val);
                    if ((r = fmt.match(/^([0#]+)(\\?-([0#]+))+$/))) {
                        o = _strrev(write_num_int(type, fmt.replace(/[\\-]/g, ""), val));
                        ri = 0;
                        return _strrev(_strrev(fmt.replace(/\\/g, "")).replace(/[0#]/g, function(x) {
                            return ri < o.length ? o.charAt(ri++) : x === '0' ? '0' : "";
                        }));
                    }
                    if (fmt.match(phone)) {
                        o = write_num_int(type, "##########", val);
                        return "(" + o.substr(0, 3) + ") " + o.substr(3, 3) + "-" + o.substr(6);
                    }
                    var oa = "";
                    if ((r = fmt.match(/^([#0?]+)( ?)\/( ?)([#0?]+)/))) {
                        ri = Math.min(r[4].length, 7);
                        ff = frac(aval, Math.pow(10, ri) - 1, false);
                        o = "" + sign;
                        oa = write_num("n", r[1], ff[1]);
                        if (oa.charAt(oa.length - 1) == " ") oa = oa.substr(0, oa.length - 1) + "0";
                        o += oa + r[2] + "/" + r[3];
                        oa = rpad_(ff[2], ri);
                        if (oa.length < r[4].length) oa = hashq(r[4].substr(r[4].length - oa.length)) + oa;
                        o += oa;
                        return o;
                    }
                    if ((r = fmt.match(/^# ([#0?]+)( ?)\/( ?)([#0?]+)/))) {
                        ri = Math.min(Math.max(r[1].length, r[4].length), 7);
                        ff = frac(aval, Math.pow(10, ri) - 1, true);
                        return sign + (ff[0] || (ff[1] ? "" : "0")) + " " + (ff[1] ? pad_(ff[1], ri) + r[2] + "/" + r[3] + rpad_(ff[2], ri) : fill(" ", 2 * ri + 1 + r[2].length + r[3].length));
                    }
                    if ((r = fmt.match(/^[#0?]+$/))) {
                        o = "" + val;
                        if (fmt.length <= o.length) return o;
                        return hashq(fmt.substr(0, fmt.length - o.length)) + o;
                    }
                    if ((r = fmt.match(/^([#0]+)\.([#0]+)$/))) {
                        o = "" + val.toFixed(Math.min(r[2].length, 10)).replace(/([^0])0+$/, "$1");
                        ri = o.indexOf(".");
                        var lres = fmt.indexOf(".") - ri,
                            rres = fmt.length - o.length - lres;
                        return hashq(fmt.substr(0, lres) + o + fmt.substr(fmt.length - rres));
                    }
                    if ((r = fmt.match(/^00,000\.([#0]*0)$/))) {
                        return val < 0 ? "-" + write_num_int(type, fmt, -val) : commaify("" + val).replace(/^\d,\d{3}$/, "0$&").replace(/^\d*$/, function($$) {
                            return "00," + ($$.length < 3 ? pad0(0, 3 - $$.length) : "") + $$;
                        }) + "." + pad0(0, r[1].length);
                    }
                    switch (fmt) {
                        case "###,###":
                        case "##,###":
                        case "#,###":
                            var x = commaify("" + aval);
                            return x !== "0" ? sign + x : "";
                        default:
                            if (fmt.match(/\.[0#?]*$/)) return write_num_int(type, fmt.slice(0, fmt.lastIndexOf(".")), val) + hashq(fmt.slice(fmt.lastIndexOf(".")));
                    }
                    throw new Error("unsupported format |" + fmt + "|");
                }
                return function write_num(type, fmt, val) {
                    return (val | 0) === val ? write_num_int(type, fmt, val) : write_num_flt(type, fmt, val);
                };
            })();

            function split_fmt(fmt) {
                var out = [];
                var in_str = false /*, cc*/ ;
                for (var i = 0, j = 0; i < fmt.length; ++i) switch (( /*cc=*/ fmt.charCodeAt(i))) {
                    case 34:
                        /* '"' */ in_str = !in_str;
                        break;
                    case 95:
                    case 42:
                    case 92:
                        /* '_' '*' '\\' */
                        ++i;
                        break;
                    case 59:
                        /* ';' */ out[out.length] = fmt.substr(j, i - j);
                        j = i + 1;
                }
                out[out.length] = fmt.substr(j);
                if (in_str === true) throw new Error("Format |" + fmt + "| unterminated string ");
                return out;
            }
            SSF._split = split_fmt;
            var abstime = /\[[HhMmSs]*\]/;

            function fmt_is_date(fmt) {
                var i = 0,
                    /*cc = 0,*/ c = "",
                    o = "";
                while (i < fmt.length) {
                    switch ((c = fmt.charAt(i))) {
                        case 'G':
                            if (isgeneral(fmt, i)) i += 6;
                            i++;
                            break;
                        case '"':
                            for (;
                                ( /*cc=*/ fmt.charCodeAt(++i)) !== 34 && i < fmt.length;) ++i;
                            ++i;
                            break;
                        case '\\':
                            i += 2;
                            break;
                        case '_':
                            i += 2;
                            break;
                        case '@':
                            ++i;
                            break;
                        case 'B':
                        case 'b':
                            if (fmt.charAt(i + 1) === "1" || fmt.charAt(i + 1) === "2") return true;
                            /* falls through */
                        case 'M':
                        case 'D':
                        case 'Y':
                        case 'H':
                        case 'S':
                        case 'E':
                            /* falls through */
                        case 'm':
                        case 'd':
                        case 'y':
                        case 'h':
                        case 's':
                        case 'e':
                        case 'g':
                            return true;
                        case 'A':
                        case 'a':
                            if (fmt.substr(i, 3).toUpperCase() === "A/P") return true;
                            if (fmt.substr(i, 5).toUpperCase() === "AM/PM") return true;
                            ++i;
                            break;
                        case '[':
                            o = c;
                            while (fmt.charAt(i++) !== ']' && i < fmt.length) o += fmt.charAt(i);
                            if (o.match(abstime)) return true;
                            break;
                        case '.':
                            /* falls through */
                        case '0':
                        case '#':
                            while (i < fmt.length && ("0#?.,E+-%".indexOf(c = fmt.charAt(++i)) > -1 || (c == '\\' && fmt.charAt(i + 1) == "-" && "0#".indexOf(fmt.charAt(i + 2)) > -1))) { /* empty */ }
                            break;
                        case '?':
                            while (fmt.charAt(++i) === c) { /* empty */ }
                            break;
                        case '*':
                            ++i;
                            if (fmt.charAt(i) == ' ' || fmt.charAt(i) == '*') ++i;
                            break;
                        case '(':
                        case ')':
                            ++i;
                            break;
                        case '1':
                        case '2':
                        case '3':
                        case '4':
                        case '5':
                        case '6':
                        case '7':
                        case '8':
                        case '9':
                            while (i < fmt.length && "0123456789".indexOf(fmt.charAt(++i)) > -1) { /* empty */ }
                            break;
                        case ' ':
                            ++i;
                            break;
                        default:
                            ++i;
                            break;
                    }
                }
                return false;
            }
            SSF.is_date = fmt_is_date;

            function eval_fmt(fmt, v, opts, flen) {
                var out = [],
                    o = "",
                    i = 0,
                    c = "",
                    lst = 't',
                    dt, j, cc;
                var hr = 'H';
                /* Tokenize */
                while (i < fmt.length) {
                    switch ((c = fmt.charAt(i))) {
                        case 'G':
                            /* General */ if (!isgeneral(fmt, i)) throw new Error('unrecognized character ' + c + ' in ' + fmt);
                            out[out.length] = {
                                t: 'G',
                                v: 'General'
                            };
                            i += 7;
                            break;
                        case '"':
                            /* Literal text */ for (o = "";
                                (cc = fmt.charCodeAt(++i)) !== 34 && i < fmt.length;) o += String.fromCharCode(cc);
                            out[out.length] = {
                                t: 't',
                                v: o
                            };
                            ++i;
                            break;
                        case '\\':
                            var w = fmt.charAt(++i),
                                t = (w === "(" || w === ")") ? w : 't';
                            out[out.length] = {
                                t: t,
                                v: w
                            };
                            ++i;
                            break;
                        case '_':
                            out[out.length] = {
                                t: 't',
                                v: " "
                            };
                            i += 2;
                            break;
                        case '@':
                            /* Text Placeholder */ out[out.length] = {
                                t: 'T',
                                v: v
                            };
                            ++i;
                            break;
                        case 'B':
                        case 'b':
                            if (fmt.charAt(i + 1) === "1" || fmt.charAt(i + 1) === "2") {
                                if (dt == null) {
                                    dt = parse_date_code(v, opts, fmt.charAt(i + 1) === "2");
                                    if (dt == null) return "";
                                }
                                out[out.length] = {
                                    t: 'X',
                                    v: fmt.substr(i, 2)
                                };
                                lst = c;
                                i += 2;
                                break;
                            }
                            /* falls through */
                        case 'M':
                        case 'D':
                        case 'Y':
                        case 'H':
                        case 'S':
                        case 'E':
                            c = c.toLowerCase();
                            /* falls through */
                        case 'm':
                        case 'd':
                        case 'y':
                        case 'h':
                        case 's':
                        case 'e':
                        case 'g':
                            if (v < 0) return "";
                            if (dt == null) {
                                dt = parse_date_code(v, opts);
                                if (dt == null) return "######";
                            }
                            o = c;
                            while (++i < fmt.length && fmt.charAt(i).toLowerCase() === c) o += c;
                            if (c === 'm' && lst.toLowerCase() === 'h') c = 'M';
                            if (c === 'h') c = hr;
                            out[out.length] = {
                                t: c,
                                v: o
                            };
                            lst = c;
                            break;
                        case 'A':
                        case 'a':
                            var q = {
                                t: c,
                                v: c
                            };
                            if (dt == null) dt = parse_date_code(v, opts);
                            if (fmt.substr(i, 3).toUpperCase() === "A/P") {
                                if (dt != null) q.v = dt.H >= 12 ? "P" : "A";
                                q.t = 'T';
                                hr = 'h';
                                i += 3;
                            } else if (fmt.substr(i, 5).toUpperCase() === "AM/PM") {
                                if (dt != null) q.v = dt.H >= 12 ? "PM" : "AM";
                                q.t = 'T';
                                i += 5;
                                hr = 'h';
                            } else {
                                q.t = "t";
                                ++i;
                            }
                            if (dt == null && q.t === 'T') return "";
                            out[out.length] = q;
                            lst = c;
                            break;
                        case '[':
                            o = c;
                            while (fmt.charAt(i++) !== ']' && i < fmt.length) o += fmt.charAt(i);
                            if (o.slice(-1) !== ']') throw 'unterminated "[" block: |' + o + '|';
                            if (o.match(abstime)) {
                                if (dt == null) {
                                    dt = parse_date_code(v, opts);
                                    if (dt == null) return "";
                                }
                                out[out.length] = {
                                    t: 'Z',
                                    v: o.toLowerCase()
                                };
                                lst = o.charAt(1);
                            } else if (o.indexOf("$") > -1) {
                                o = (o.match(/\$([^-\[\]]*)/) || [])[1] || "$";
                                if (!fmt_is_date(fmt)) out[out.length] = {
                                    t: 't',
                                    v: o
                                };
                            }
                            break;
                            /* Numbers */
                        case '.':
                            if (dt != null) {
                                o = c;
                                while (++i < fmt.length && (c = fmt.charAt(i)) === "0") o += c;
                                out[out.length] = {
                                    t: 's',
                                    v: o
                                };
                                break;
                            }
                            /* falls through */
                        case '0':
                        case '#':
                            o = c;
                            while ((++i < fmt.length && "0#?.,E+-%".indexOf(c = fmt.charAt(i)) > -1) || (c == '\\' && fmt.charAt(i + 1) == "-" && i < fmt.length - 2 && "0#".indexOf(fmt.charAt(i + 2)) > -1)) o += c;
                            out[out.length] = {
                                t: 'n',
                                v: o
                            };
                            break;
                        case '?':
                            o = c;
                            while (fmt.charAt(++i) === c) o += c;
                            out[out.length] = {
                                t: c,
                                v: o
                            };
                            lst = c;
                            break;
                        case '*':
                            ++i;
                            if (fmt.charAt(i) == ' ' || fmt.charAt(i) == '*') ++i;
                            break; // **
                        case '(':
                        case ')':
                            out[out.length] = {
                                t: (flen === 1 ? 't' : c),
                                v: c
                            };
                            ++i;
                            break;
                        case '1':
                        case '2':
                        case '3':
                        case '4':
                        case '5':
                        case '6':
                        case '7':
                        case '8':
                        case '9':
                            o = c;
                            while (i < fmt.length && "0123456789".indexOf(fmt.charAt(++i)) > -1) o += fmt.charAt(i);
                            out[out.length] = {
                                t: 'D',
                                v: o
                            };
                            break;
                        case ' ':
                            out[out.length] = {
                                t: c,
                                v: c
                            };
                            ++i;
                            break;
                        default:
                            // if ("¤฿BsBr₵₡₫ƒFtRs.₭kr£₤Lm₥₦₱PQRSkRp৲৳R$S/.〒₮₩¥NT￥zł₴₪៛руб€＄,$-+/():!^&'~{}<>=€acfijklopqrtuvwxzP".indexOf(c) === -1) throw new Error('unrecognized character ' + c + ' in ' + fmt);
                            if ("¤฿BsBr₵₡₫ƒFtRs.₭kr£₤Lm₥₦₱PQRSkRp৲৳R$S/.〒₮₩¥NT￥zł₴₪៛руб€＄,$-+/():!^&'~{}<>=€acfijklopqrtuvwxzP$￥LekdinAf$dhAflRial?￡BirrKzMOPPGKRsGsB/R$ррlevkrKMzBsPNuFBuKPkrRD$NfkCFA?CVEGMDFrCDHTGNAfLFdjKGSFGGHSRielKCFknKshLSLL￡LtRFRONArRfMWKRMMURsMROS/KMDLMTnRC$kr€GELCHFSLLSCRDbSZLSDGSOSSomFCFPTShT$VUVQUGXгрнsomWSTNT$FtDramRpZMWFCFA".indexOf(c) === -1) throw new Error('unrecognized character ' + c + ' in ' + fmt);
                            out[out.length] = {
                                t: 't',
                                v: c
                            };
                            ++i;
                            break;
                    }
                }
                var bt = 0,
                    ss0 = 0,
                    ssm;
                for (i = out.length - 1, lst = 't'; i >= 0; --i) {
                    switch (out[i].t) {
                        case 'h':
                        case 'H':
                            out[i].t = hr;
                            lst = 'h';
                            if (bt < 1) bt = 1;
                            break;
                        case 's':
                            if ((ssm = out[i].v.match(/\.0+$/))) ss0 = Math.max(ss0, ssm[0].length - 1);
                            if (bt < 3) bt = 3;
                            /* falls through */
                        case 'd':
                        case 'y':
                        case 'M':
                        case 'e':
                            lst = out[i].t;
                            break;
                        case 'm':
                            if (lst === 's') {
                                out[i].t = 'M';
                                if (bt < 2) bt = 2;
                            }
                            break;
                        case 'X':
                            /*if(out[i].v === "B2");*/ break;
                        case 'Z':
                            if (bt < 1 && out[i].v.match(/[Hh]/)) bt = 1;
                            if (bt < 2 && out[i].v.match(/[Mm]/)) bt = 2;
                            if (bt < 3 && out[i].v.match(/[Ss]/)) bt = 3;
                    }
                }
                switch (bt) {
                    case 0:
                        break;
                    case 1:
                        if (dt.u >= 0.5) {
                            dt.u = 0;
                            ++dt.S;
                        }
                        if (dt.S >= 60) {
                            dt.S = 0;
                            ++dt.M;
                        }
                        if (dt.M >= 60) {
                            dt.M = 0;
                            ++dt.H;
                        }
                        break;
                    case 2:
                        if (dt.u >= 0.5) {
                            dt.u = 0;
                            ++dt.S;
                        }
                        if (dt.S >= 60) {
                            dt.S = 0;
                            ++dt.M;
                        }
                        break;
                }
                /* replace fields */
                var nstr = "",
                    jj;
                for (i = 0; i < out.length; ++i) {
                    switch (out[i].t) {
                        case 't':
                        case 'T':
                        case ' ':
                        case 'D':
                            break;
                        case 'X':
                            out[i].v = "";
                            out[i].t = ";";
                            break;
                        case 'd':
                        case 'm':
                        case 'y':
                        case 'h':
                        case 'H':
                        case 'M':
                        case 's':
                        case 'e':
                        case 'b':
                        case 'Z':
                            out[i].v = write_date(out[i].t.charCodeAt(0), out[i].v, dt, ss0);
                            out[i].t = 't';
                            break;
                        case 'n':
                        case '(':
                        case '?':
                            jj = i + 1;
                            while (out[jj] != null && (
                                    (c = out[jj].t) === "?" || c === "D" || ((c === " " || c === "t") && out[jj + 1] != null && (out[jj + 1].t === '?' || out[jj + 1].t === "t" && out[jj + 1].v === '/')) || (out[i].t === '(' && (c === ' ' || c === 'n' || c === ')')) || (c === 't' && (out[jj].v === '/' || out[jj].v === ' ' && out[jj + 1] != null && out[jj + 1].t == '?')))) {
                                out[i].v += out[jj].v;
                                out[jj] = {
                                    v: "",
                                    t: ";"
                                };
                                ++jj;
                            }
                            nstr += out[i].v;
                            i = jj - 1;
                            break;
                        case 'G':
                            out[i].t = 't';
                            out[i].v = general_fmt(v, opts);
                            break;
                    }
                }
                var vv = "",
                    myv, ostr;
                if (nstr.length > 0) {
                    if (nstr.charCodeAt(0) == 40) /* '(' */ {
                        myv = (v < 0 && nstr.charCodeAt(0) === 45 ? -v : v);
                        ostr = write_num('(', nstr, myv);
                    } else {
                        myv = (v < 0 && flen > 1 ? -v : v);
                        ostr = write_num('n', nstr, myv);
                        if (myv < 0 && out[0] && out[0].t == 't') {
                            ostr = ostr.substr(1);
                            out[0].v = "-" + out[0].v;
                        }
                    }
                    jj = ostr.length - 1;
                    var decpt = out.length;
                    for (i = 0; i < out.length; ++i)
                        if (out[i] != null && out[i].t != 't' && out[i].v.indexOf(".") > -1) {
                            decpt = i;
                            break;
                        }
                    var lasti = out.length;
                    if (decpt === out.length && ostr.toUpperCase().indexOf("E") === -1) {
                        for (i = out.length - 1; i >= 0; --i) {
                            if (out[i] == null || 'n?('.indexOf(out[i].t) === -1) continue;
                            if (jj >= out[i].v.length - 1) {
                                jj -= out[i].v.length;
                                out[i].v = ostr.substr(jj + 1, out[i].v.length);
                            } else if (jj < 0) out[i].v = "";
                            else {
                                out[i].v = ostr.substr(0, jj + 1);
                                jj = -1;
                            }
                            out[i].t = 't';
                            lasti = i;
                        }
                        if (jj >= 0 && lasti < out.length) out[lasti].v = ostr.substr(0, jj + 1) + out[lasti].v;
                    } else if (decpt !== out.length && ostr.toUpperCase().indexOf("E") === -1) {
                        jj = ostr.indexOf(".") - 1;
                        for (i = decpt; i >= 0; --i) {
                            if (out[i] == null || 'n?('.indexOf(out[i].t) === -1) continue;
                            j = out[i].v.indexOf(".") > -1 && i === decpt ? out[i].v.indexOf(".") - 1 : out[i].v.length - 1;
                            vv = out[i].v.substr(j + 1);
                            for (; j >= 0; --j) {
                                if (jj >= 0 && (out[i].v.charAt(j) === "0" || out[i].v.charAt(j) === "#")) vv = ostr.charAt(jj--) + vv;
                            }
                            out[i].v = vv;
                            out[i].t = 't';
                            lasti = i;
                        }
                        if (jj >= 0 && lasti < out.length) out[lasti].v = ostr.substr(0, jj + 1) + out[lasti].v;
                        jj = ostr.indexOf(".") + 1;
                        for (i = decpt; i < out.length; ++i) {
                            if (out[i] == null || ('n?('.indexOf(out[i].t) === -1 && i !== decpt)) continue;
                            j = out[i].v.indexOf(".") > -1 && i === decpt ? out[i].v.indexOf(".") + 1 : 0;
                            vv = out[i].v.substr(0, j);
                            for (; j < out[i].v.length; ++j) {
                                if (jj < ostr.length) vv += ostr.charAt(jj++);
                            }
                            out[i].v = vv;
                            out[i].t = 't';
                            lasti = i;
                        }
                    }
                }
                for (i = 0; i < out.length; ++i)
                    if (out[i] != null && 'n(?'.indexOf(out[i].t) > -1) {
                        myv = (flen > 1 && v < 0 && i > 0 && out[i - 1].v === "-" ? -v : v);
                        out[i].v = write_num(out[i].t, out[i].v, myv);
                        out[i].t = 't';
                    }
                var retval = "";
                for (i = 0; i !== out.length; ++i)
                    if (out[i] != null) retval += out[i].v;
                return retval;
            }
            SSF._eval = eval_fmt;
            var cfregex = /\[[=<>]/;
            var cfregex2 = /\[(=|>[=]?|<[>=]?)(-?\d+(?:\.\d*)?)\]/;

            function chkcond(v, rr) {
                if (rr == null) return false;
                var thresh = parseFloat(rr[2]);
                switch (rr[1]) {
                    case "=":
                        if (v == thresh) return true;
                        break;
                    case ">":
                        if (v > thresh) return true;
                        break;
                    case "<":
                        if (v < thresh) return true;
                        break;
                    case "<>":
                        if (v != thresh) return true;
                        break;
                    case ">=":
                        if (v >= thresh) return true;
                        break;
                    case "<=":
                        if (v <= thresh) return true;
                        break;
                }
                return false;
            }

            function choose_fmt(f, v) {
                var fmt = split_fmt(f);
                var l = fmt.length,
                    lat = fmt[l - 1].indexOf("@");
                if (l < 4 && lat > -1) --l;
                if (fmt.length > 4) throw new Error("cannot find right format for |" + fmt.join("|") + "|");
                if (typeof v !== "number") return [4, fmt.length === 4 || lat > -1 ? fmt[fmt.length - 1] : "@"];
                switch (fmt.length) {
                    case 1:
                        fmt = lat > -1 ? ["General", "General", "General", fmt[0]] : [fmt[0], fmt[0], fmt[0], "@"];
                        break;
                    case 2:
                        fmt = lat > -1 ? [fmt[0], fmt[0], fmt[0], fmt[1]] : [fmt[0], fmt[1], fmt[0], "@"];
                        break;
                    case 3:
                        fmt = lat > -1 ? [fmt[0], fmt[1], fmt[0], fmt[2]] : [fmt[0], fmt[1], fmt[2], "@"];
                        break;
                    case 4:
                        break;
                }
                var ff = v > 0 ? fmt[0] : v < 0 ? fmt[1] : fmt[2];
                if (fmt[0].indexOf("[") === -1 && fmt[1].indexOf("[") === -1) return [l, ff];
                if (fmt[0].match(cfregex) != null || fmt[1].match(cfregex) != null) {
                    var m1 = fmt[0].match(cfregex2);
                    var m2 = fmt[1].match(cfregex2);
                    return chkcond(v, m1) ? [l, fmt[0]] : chkcond(v, m2) ? [l, fmt[1]] : [l, fmt[m1 != null && m2 != null ? 2 : 1]];
                }
                return [l, ff];
            }

            function format(fmt, v, o) {
                if (o == null) o = {};
                var sfmt = "";
                switch (typeof fmt) {
                    case "string":
                        if (fmt == "m/d/yy" && o.dateNF) sfmt = o.dateNF;
                        else sfmt = fmt;
                        break;
                    case "number":
                        if (fmt == 14 && o.dateNF) sfmt = o.dateNF;
                        else sfmt = (o.table != null ? (o.table) : table_fmt)[fmt];
                        break;
                }

                //new runze 增加万 亿 格式  
                //注："w":2万2500  "w0":2万2500  "w0.0":2万2500.2  "w0.00":2万2500.23......自定义精确度
                var reg = /^(w|W)((0?)|(0\.0+))$/;
                if(!!sfmt.match(reg)){
                    if(isNaN(v)){
                        return v;
                    }

                     //var v =300101886.436;
                    var acc = sfmt.slice(1); //取得0/0.0/0.00
                    var isNegative = false;
                    if(!isNaN(v) && Number(v) < 0){
                        isNegative = true;
                        v = Math.abs(v);
                    }
                    var vInt = parseInt(v);
                     
                    var vlength = vInt.toString().length;
                    if( vlength> 4){
                        if(vlength > 8){
                            var y =parseInt (v / 100000000);  //亿
                            var w = parseInt(jfgrid.floatTool.subtract(v,y*100000000) / 10000); //万
                            var q = jfgrid.floatTool.subtract(v,y*100000000 + w*10000);  //千以后
                            if(acc != ""){
                                q = numeral(q).format(acc); //处理精确度
                            }
                            v = y + "亿" + w + "万" + q;
                        }else{
                            var w = parseInt(v / 10000); //万
                            var q = jfgrid.floatTool.subtract(v,w*10000); //千以后
                            if(acc != ""){
                                q = numeral(q).format(acc); //处理精确度
                            }
                            v = w + "万" + q;
                        }
                        

                        if(v.indexOf("亿0万0") != -1){
                            v = v.replace("0万0","");
                        }else if(v.indexOf("亿0万") != -1){
                            v = v.replace("0万","");
                        }else if(v.indexOf("万0") != -1){
                            v = v.replace("万0","万");
                        }

                        //舍弃正则后顾断言写法，旧浏览器不识别（360 V9）
                        if (v.indexOf("亿") != -1 && v.indexOf("万") == -1) { //1亿/1亿111 => 1亿/1亿0111
                            var afterYi = v.substring(v.indexOf("亿") + 1);
                            if (afterYi.substring(0, 1) !== "." && afterYi != "") {
                                switch ((parseInt(afterYi) + "").length) {
                                    case 1:
                                        afterYi = "000" + afterYi;
                                        break;
                                    case 2:
                                        afterYi = "00" + afterYi;
                                        break;
                                    case 3:
                                        afterYi = "0" + afterYi;
                                        break;
                                }
                                v = v.substring(0, v.indexOf("亿") + 1) + afterYi;
                            }
                        } else if (v.indexOf("亿") == -1 && v.indexOf("万") != -1) { //3万0011
                            var afterWan = v.substring(v.indexOf("万") + 1);
                            if (afterWan.substring(0, 1) !== "." && afterWan != "") {
                                switch ((parseInt(afterWan) + "").length) {
                                    case 1:
                                        afterWan = "000" + afterWan;
                                        break;
                                    case 2:
                                        afterWan = "00" + afterWan;
                                        break;
                                    case 3:
                                        afterWan = "0" + afterWan;
                                        break;
                                }
                                v = v.substring(0, v.indexOf("万") + 1) + afterWan;
                            }
                        } else if (v.indexOf("亿") != -1 && v.indexOf("万") != -1) { //1亿0053万0611
                            var afterYi = v.substring(v.indexOf("亿") + 1,v.indexOf("万")),
                                afterWan = v.substring(v.indexOf("万") + 1);

                            switch ((parseInt(afterYi) + "").length) {
                                case 1:
                                    afterYi = "000" + afterYi;
                                    break;
                                case 2:
                                    afterYi = "00" + afterYi;
                                    break;
                                case 3:
                                    afterYi = "0" + afterYi;
                                    break;
                            }
                            v = v.substring(0, v.indexOf("亿") + 1) + afterYi + v.substring(v.indexOf("万"))
                            

                            if (afterWan.substring(0, 1) !== "." && afterWan != "") {
                                switch ((parseInt(afterWan) + "").length) {
                                    case 1:
                                        afterWan = "000" + afterWan;
                                        break;
                                    case 2:
                                        afterWan = "00" + afterWan;
                                        break;
                                    case 3:
                                        afterWan = "0" + afterWan;
                                        break;
                                }
                                v = v.substring(0, v.indexOf("万") + 1) + afterWan
                            }
                        }
       
                    }else{
                        if(acc != ""){
                            v = numeral(v).format(acc); //处理精确度
                        }
                    }
                    if(isNegative){
                        return '-' + v;
                    }else{
                        return v;
                    }
                    
                }

                if (isgeneral(sfmt, 0)) return general_fmt(v, o);
                if (v instanceof Date) v = datenum_local(v, o.date1904);
                var f = choose_fmt(sfmt, v);
                if (isgeneral(f[1])) return general_fmt(v, o);
                if (v === true) v = "TRUE";
                else if (v === false) v = "FALSE";
                else if (v === "" || v == null) return "";
                return eval_fmt(f[1], v, o, f[0]);
            }

            function load_entry(fmt, idx) {
                if (typeof idx != 'number') {
                    idx = +idx || -1;
                    for (var i = 0; i < 0x0188; ++i) {
                        if (table_fmt[i] == undefined) {
                            if (idx < 0) idx = i;
                            continue;
                        }
                        if (table_fmt[i] == fmt) {
                            idx = i;
                            break;
                        }
                    }
                    if (idx < 0) idx = 0x187;
                }
                table_fmt[idx] = fmt;
                return idx;
            }
            SSF.load = load_entry;
            SSF._table = table_fmt;
            SSF.get_table = function get_table() {
                return table_fmt;
            };
            SSF.load_table = function load_table(tbl) {
                for (var i = 0; i != 0x0188; ++i)
                    if (tbl[i] !== undefined) load_entry(tbl[i], i);
            };
            SSF.init_table = init_table;
            SSF.format = format;
        };
        make_ssf(SSF);

        var XLMLFormatMap /*{[string]:string}*/ = ({
            "General Number": "General",
            "General Date": SSF._table[22],
            "Long Date": "dddd, mmmm dd, yyyy",
            "Medium Date": SSF._table[15],
            "Short Date": SSF._table[14],
            "Long Time": SSF._table[19],
            "Medium Time": SSF._table[18],
            "Short Time": SSF._table[20],
            "Currency": '"$"#,##0.00_);[Red]\\("$"#,##0.00\\)',
            "Fixed": SSF._table[2],
            "Standard": SSF._table[4],
            "Percent": SSF._table[10],
            "Scientific": SSF._table[11],
            "Yes/No": '"Yes";"Yes";"No";@',
            "True/False": '"True";"True";"False";@',
            "On/Off": '"Yes";"Yes";"No";@'
        });

        var unescapexml = (function() {
            /* 22.4.2.4 bstr (Basic String) */
            var encregex = /&(?:quot|apos|gt|lt|amp|#x?([\da-fA-F]+));/g,
                coderegex = /_x([\da-fA-F]{4})_/g;
            return function unescapexml(text) {
                var s = text + '',
                    i = s.indexOf("<![CDATA[");
                if (i == -1) return s.replace(encregex, function($$, $1) {
                    return encodings[$$] || String.fromCharCode(parseInt($1, $$.indexOf("x") > -1 ? 16 : 10)) || $$;
                }).replace(coderegex, function(m, c) {
                    return String.fromCharCode(parseInt(c, 16));
                });
                var j = s.indexOf("]]>");
                return unescapexml(s.slice(0, i)) + s.slice(i + 9, j) + unescapexml(s.slice(j + 3));
            };
        })();

        function xlml_format(format, value) {
            var fmt = XLMLFormatMap[format] || unescapexml(format);
            if (fmt === "General") return SSF._general(value);
            return SSF.format(fmt, value);
        }

        jfgrid.xlml_format = xlml_format;
        jfgrid.SSF = SSF;

        var basedate = new Date(1899, 11, 31, 0, 0, 0);
        var dnthresh = basedate.getTime();
        var base1904 = new Date(1900, 2, 1, 0, 0, 0);

        function datenum(v, date1904) {
            var epoch = v.getTime();
            if (date1904) epoch -= 1462 * 24 * 60 * 60 * 1000;
            return (epoch - dnthresh) / (24 * 60 * 60 * 1000);
        }

        function datenum_local(v, date1904) {
            var epoch = Date.UTC(v.getFullYear(), v.getMonth(), v.getDate(), v.getHours(), v.getMinutes(), v.getSeconds());
            var dnthresh_utc = Date.UTC(1899, 11, 31, 0, 0, 0);

            if (date1904) epoch -= 1461 * 24 * 60 * 60 * 1000;
            else if (v >= base1904) epoch += 24 * 60 * 60 * 1000;
            return (epoch - dnthresh_utc) / (24 * 60 * 60 * 1000);
        }

        function numdate(v) {
            var out = new Date();
            out.setTime(v * 24 * 60 * 60 * 1000 + dnthresh);
            return out;
        }
        /* ISO 8601 Duration */
        function parse_isodur(s) {
            var sec = 0,
                mt = 0,
                time = false;
            var m = s.match(/P([0-9\.]+Y)?([0-9\.]+M)?([0-9\.]+D)?T([0-9\.]+H)?([0-9\.]+M)?([0-9\.]+S)?/);
            if (!m) throw new Error("|" + s + "| is not an ISO8601 Duration");
            for (var i = 1; i != m.length; ++i) {
                if (!m[i]) continue;
                mt = 1;
                if (i > 3) time = true;
                switch (m[i].slice(m[i].length - 1)) {
                    case 'Y':
                        throw new Error("Unsupported ISO Duration Field: " + m[i].slice(m[i].length - 1));
                    case 'D':
                        mt *= 24;
                        /* falls through */
                    case 'H':
                        mt *= 60;
                        /* falls through */
                    case 'M':
                        if (!time) throw new Error("Unsupported ISO Duration Field: M");
                        else mt *= 60;
                        /* falls through */
                    case 'S':
                        break;
                }
                sec += mt * parseInt(m[i], 10);
            }
            return sec;
        }
        var good_pd_date = new Date('2017-02-19T19:06:09.000Z');
        if (isNaN(good_pd_date.getFullYear())) good_pd_date = new Date('2/19/17');
        var good_pd = good_pd_date.getFullYear() == 2017;
        /* parses a date as a local date */
        function parseDate(str, fixdate) {
            var d = new Date(str);
            //console.log(d);
            if (good_pd) {
                if (fixdate > 0) d.setTime(d.getTime() + d.getTimezoneOffset() * 60 * 1000);
                else if (fixdate < 0) d.setTime(d.getTime() - d.getTimezoneOffset() * 60 * 1000);
                return d;
            }
            if (str instanceof Date) return str;
            if (good_pd_date.getFullYear() == 1917 && !isNaN(d.getFullYear())) {
                var s = d.getFullYear();
                if (str.indexOf("" + s) > -1) return d;
                d.setFullYear(d.getFullYear() + 100);
                return d;
            }
            var n = str.match(/\d+/g) || ["2017", "2", "19", "0", "0", "0"];
            var out = new Date(+n[0], +n[1] - 1, +n[2], (+n[3] || 0), (+n[4] || 0), (+n[5] || 0));
            if (str.indexOf("Z") > -1) out = new Date(out.getTime() - out.getTimezoneOffset() * 60 * 1000);
            return out;
        }

        jfgrid.parseDate = parseDate;

        /* TODO: stress test */
        function fuzzynum(s) {
            var v = Number(s);
            if(typeof s == "number"){
                return s;
            }
            if (!isNaN(v)) return v;
            var wt = 1;
            var ss = s.replace(/([\d]),([\d])/g, "$1$2").replace(/[$]/g, "").replace(/[%]/g, function() {
                wt *= 100;
                return "";
            });
            if (!isNaN(v = Number(ss))) return v / wt;
            ss = ss.replace(/[(](.*)[)]/, function($$, $1) {
                wt = -wt;
                return $1;
            });
            if (!isNaN(v = Number(ss))) return v / wt;
            return v;
        }

        jfgrid.fuzzynum = fuzzynum;

        function fuzzydate(s) {
            var o = new Date(s),
                n = new Date(NaN);
            var y = o.getYear(),
                m = o.getMonth(),
                d = o.getDate();
            if (isNaN(d)) return n;
            if (y < 0 || y > 8099) return n;
            if ((m > 0 || d > 1) && y != 101) return o;
            if (s.toLowerCase().match(/jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec/)) return o;
            if (s.match(/[^-0-9:,\/\\]/)) return n;
            return o;
        }

        jfgrid.fuzzydate = fuzzydate;

        return {
            //万 单位格式增加！！！
            genarate: function(value){
                var ret = [];
                var m = null, ct = {}, v = value;
                
                if(value == null){
                    return null;
                }

                if(value.toString().substr(0, 1) === "'"){
                    m = value.toString().substr(1);
                    ct = { "fa": "@", "t": "s" };
                }
                else if(value.toString().toUpperCase() === "TRUE"){
                    m = "TRUE";
                    ct = { "fa": "General", "t": "b" };
                    v = true;
                }
                else if(value.toString().toUpperCase() === "FALSE"){
                    m = "FALSE";
                    ct = { "fa": "General", "t": "b" };
                    v = false;
                }
                else if(jfgrid.func_methods.valueIsError(value)){
                    m = value.toString();
                    ct = { "fa": "General", "t": "e" };
                }
                else if(/^\d{6}(18|19|20)?\d{2}(0[1-9]|1[12])(0[1-9]|[12]\d|3[01])\d{3}(\d|X)$/i.test(value)){
                    m = value.toString();
                    ct = { "fa": "@", "t": "s" };
                }
                else if(jfgrid.func_methods.isRealNum(value) && Math.abs(parseFloat(value)) > 0 && (Math.abs(parseFloat(value)) >= 1e+11 || Math.abs(parseFloat(value)) < 1e-9)){
                    v = numeral(value).value();

                    var str = v.toExponential();
                    if(str.indexOf(".") > -1){
                        var strlen = str.split(".")[1].split("e")[0].length;
                        if(strlen > 5){
                            strlen = 5;
                        }

                        ct = { "fa": "#0."+ new Array(strlen + 1).join("0") +"E+00", "t": "n" }; 
                    }
                    else{
                        ct = { "fa": "#0.E+00", "t": "n" };
                    }

                    m = SSF.format(ct.fa, v);
                }
                else if(value.toString().indexOf("%") > -1){
                    var index = value.toString().indexOf("%");
                    var value2 = value.toString().substr(0, index);
                    var value3 = value2.replace(/,/g, "");

                    if(index == value.toString().length - 1 && jfgrid.func_methods.isRealNum(value3)){
                        if(value2.indexOf(".") > -1){
                            if(value2.indexOf(".") == value2.lastIndexOf(".")){
                                var value4 = value2.split(".")[0];
                                var value5 = value2.split(".")[1];

                                var len = value5.length;
                                if(len > 9){
                                    len = 9;
                                }

                                if(value4.indexOf(",") > -1){
                                    var isThousands = true;
                                    var ThousandsArr = value4.split(",");

                                    for(var i = 1; i < ThousandsArr.length; i++){
                                        if(ThousandsArr[i].length < 3){
                                            isThousands = false;
                                            break;
                                        }
                                    }

                                    if(isThousands){
                                        ct = { "fa": "#,##0." + new Array(len + 1).join("0") + "%", "t": "n" };
                                        v = numeral(value).value();
                                        m = SSF.format(ct.fa, v);
                                    }
                                    else{
                                        m = value.toString();
                                        ct = { "fa": "@", "t": "s" };
                                    }
                                }
                                else{
                                    ct = { "fa": "0." + new Array(len + 1).join("0") + "%", "t": "n" };
                                    v = numeral(value).value();
                                    m = SSF.format(ct.fa, v);
                                }
                            }
                            else{
                                m = value.toString();
                                ct = { "fa": "@", "t": "s" };
                            }
                        }
                        else if(value2.indexOf(",") > -1){
                            var isThousands = true;
                            var ThousandsArr = value2.split(",");

                            for(var i = 1; i < ThousandsArr.length; i++){
                                if(ThousandsArr[i].length < 3){
                                    isThousands = false;
                                    break;
                                }
                            }

                            if(isThousands){
                                ct = { "fa": "#,##0%", "t": "n" };
                                v = numeral(value).value();
                                m = SSF.format(ct.fa, v);
                            }
                            else{
                                m = value.toString();
                                ct = { "fa": "@", "t": "s" };
                            }
                        }
                        else{
                            ct = { "fa": "0%", "t": "n" };
                            v = numeral(value).value();
                            m = SSF.format(ct.fa, v);
                        }
                    }
                    else{
                        m = value.toString();
                        ct = { "fa": "@", "t": "s" };
                    }
                }
                else if(value.toString().indexOf(".") > -1){
                    if(value.toString().indexOf(".") == value.toString().lastIndexOf(".")){
                        var value1 = value.toString().split(".")[0];
                        var value2 = value.toString().split(".")[1];

                        var len = value2.length;
                        if(len > 9){
                            len = 9;
                        }

                        if(value1.indexOf(",") > -1){
                            var isThousands = true;
                            var ThousandsArr = value1.split(",");

                            for(var i = 1; i < ThousandsArr.length; i++){
                                if(!jfgrid.func_methods.isRealNum(ThousandsArr[i]) || ThousandsArr[i].length < 3){
                                    isThousands = false;
                                    break;
                                }
                            }

                            if(isThousands){
                                ct = { "fa": "#,##0." + new Array(len + 1).join("0"), "t": "n" };
                                v = numeral(value).value();
                                m = SSF.format(ct.fa, v);
                            }
                            else{
                                m = value.toString();
                                ct = { "fa": "@", "t": "s" };
                            }
                        }
                        else{
                            if(jfgrid.func_methods.isRealNum(value1) && jfgrid.func_methods.isRealNum(value2)){
                                ct = { "fa": "0." + new Array(len + 1).join("0"), "t": "n" };
                                v = numeral(value).value();
                                m = SSF.format(ct.fa, v);
                            }
                            else{
                                m = value.toString();
                                ct = { "fa": "@", "t": "s" };
                            }
                        }
                    }
                    else{
                        m = value.toString();
                        ct = { "fa": "@", "t": "s" };
                    }
                }
                else if(jfgrid.func_methods.isRealNum(value)){
                    m = value.toString();
                    ct = { "fa": "General", "t": "n" };
                    v = parseFloat(value);
                }
                else if (jfgrid.datecontroll.isdatetime(value) && (value.toString().indexOf(".") > -1 || value.toString().indexOf(":") > -1 || value.toString().length < 16)){
                    v = datenum_local(parseDate(value.toString().replace(/-/g, "/")));

                    if(v.toString().indexOf(".") > -1){
                        if(value.toString().length > 18){
                            ct.fa = "yyyy-MM-dd hh:mm:ss";
                        }
                        else if(value.toString().length > 11){
                            ct.fa = "yyyy-MM-dd hh:mm";
                        }
                        else{
                            ct.fa = "yyyy-MM-dd";
                        }
                    }
                    else{
                        ct.fa = "yyyy-MM-dd";
                    }
                    
                    ct.t = "d";
                    m = SSF.format(ct.fa, v);
                }
                else{
                    m = value;
                    ct.fa = "General";
                    ct.t = "g";
                }

                return [m, ct, v];
            },
            update:function(fmt, v){
               return SSF.format(fmt, v);
            },
            is_date:function(fmt, v){
               return SSF.is_date(fmt, v);
            },
            valueShowEs:function(r, c, d){
                var value = jfgrid.getcellvalue(r, c, d, "m");
                if(value == null){
                    value = jfgrid.getcellvalue(r, c, d, "v");
                }
                else{
                    if (!isNaN(fuzzynum(value))){
                        if(typeof(value) == "string" && value.indexOf("%") > -1){
                            
                        }
                        else{
                            value = jfgrid.getcellvalue(r, c, d, "v");
                        }
                    }
                    // else if (!isNaN(parseDate(value).getDate())){
                    else if (d[r][c].ct != null && d[r][c].ct.t == "d"){

                    }
                    else if (d[r][c].ct != null && d[r][c].ct.t == "b"){

                    }
                    else{
                        value = jfgrid.getcellvalue(r, c, d, "v");
                    }
                }
                return value;
            }
        }

    })();
    


    jfgrid.pivotTable = {
        pivotDatas: null,
        pivotSheetIndex: 0,
        pivotDataSheetIndex: 0,
        // getpivotdata:function(getid){
        //     for (var i = 0; i < this.pivotDatas;i++){
        //         if (this.pivotDatas[i].id == getid) {
        //             return this.pivotDatas[i];
        //         }
        //     }
        //     return null;
        // },
        // setpivotdata:function(data){
        //     pivotDatas.push(data);
        // },
        celldata: null,
        origindata: null,
        getCellData: function (cursheetindex, datasheetindex, data_select_save) {
            var sheetIndex;
            if (cursheetindex != null) {
                sheetIndex = cursheetindex;
            }
            else {
                sheetIndex = jfgrid.currentSheetIndex;
            }

            var realIndex = jfgrid.sheetmanage.getSheetIndex(sheetIndex);

            if (jfgrid.getObjType(jfgridfile[realIndex].pivotTable) != "object"){
                jfgridfile[realIndex].pivotTable = eval('('+ jfgridfile[realIndex].pivotTable +')');
            }

            if (jfgridfile[realIndex].pivotTable != null) {
                this.column = jfgridfile[realIndex].pivotTable.column;
                this.row = jfgridfile[realIndex].pivotTable.row;
                this.values = jfgridfile[realIndex].pivotTable.values;
                this.filter = jfgridfile[realIndex].pivotTable.filter;
                this.showType = jfgridfile[realIndex].pivotTable.showType;

                this.filterparm = jfgridfile[realIndex].pivotTable.filterparm;

                if (jfgridfile[realIndex].pivotTable.drawPivotTable != null) {
                    this.drawPivotTable = jfgridfile[realIndex].pivotTable.drawPivotTable;
                }
                else {
                    this.drawPivotTable = true;
                }

                if (jfgridfile[realIndex].pivotTable.pivotTableBoundary != null) {
                    this.pivotTableBoundary = jfgridfile[realIndex].pivotTable.pivotTableBoundary;
                }
                else {
                    this.pivotTableBoundary = [12, 6];
                }

                if (data_select_save != null) {
                    this.pivot_select_save = data_select_save;
                }
                else {
                    this.pivot_select_save = jfgridfile[realIndex].pivotTable.pivot_select_save;
                }

                if (datasheetindex != null) {
                    this.pivotDataSheetIndex = datasheetindex;
                }
                else {
                    this.pivotDataSheetIndex = jfgridfile[realIndex].pivotTable.pivotDataSheetIndex;
                }
            }
            else {
                this.column = null;
                this.row = null;
                this.values = null;
                this.filter = null;
                this.showType = null;

                this.filterparm = null;

                this.drawPivotTable = true;
                this.pivotTableBoundary = [12, 6];

                if (data_select_save != null) {
                    this.pivot_select_save = data_select_save;
                }
                else {
                    this.pivot_select_save = jfgird_select_save;
                }

                if (datasheetindex != null) {
                    this.pivotDataSheetIndex = datasheetindex;
                }
                else {
                    this.pivotDataSheetIndex = sheetIndex;
                }
            }

            var pivotrealIndex = jfgrid.sheetmanage.getSheetIndex(this.pivotDataSheetIndex);

            var otherfile = jfgridfile[pivotrealIndex];
            if(otherfile["data"] == null){
                otherfile["data"] = jfgrid.sheetmanage.buildGridData(otherfile);
            }
            this.origindata = jfgrid.getdatabyselectionD(otherfile.data, this.pivot_select_save);

            var rowhidden = {};
            if (this.filterparm != null) {
                for (var f in this.filterparm) {
                    for (h in this.filterparm[f]) {
                        if (h.rowhidden != null) {
                            rowhidden = $.extend(true, rowhidden, h.rowhidden);
                        }
                    }
                }
            }
            this.rowhidden = rowhidden;
            //this.pivot_select_save = $.extend(true, {}, this.pivot_select_save);

            this.pivotSheetIndex = sheetIndex;

            var newdata = [];
            for (var i = 0; i < this.origindata.length; i++) {
                if (this.rowhidden != null && this.rowhidden[i] != null) {
                    continue;
                }
                newdata.push([].concat(this.origindata[i]));
            }
            this.celldata = newdata;

            this.pivot_data_type = {};
            for (var c = 0; c < this.celldata[1].length; c++) {
                var type = jfgrid.isdatatype(this.celldata[1][c]);
                this.pivot_data_type[c.toString()] = type;
            }
        },
        pivot_data_type: {},
        pivot_select_save: null,
        column: null,
        row: null,
        values: null,
        filter: null,
        showType: null,
        rowhidden: null,
        selected: null,
        caljs: null,
        initial: true,
        filterparm: null,
        jfgrid_pivotTable_select_state: false,
        jgridCurrentPivotInput: null,
        movestate: false,
        moveitemposition: [],
        movesave: {},
        showvaluecolrow: function () {
            if ($("#jfgrid-modal-dialog-config-value .jfgrid-modal-dialog-slider-config-item").length >= 2) {
                $("#jfgridpivottablevaluecolrowshow").show();

                if (this.showType == "column") {
                    $("#jfgridpivottablevaluecolrow").prop("checked", true);
                    $("#jfgridpivottablevaluecolrowshow label[for='jfgridpivottablevaluecolrow']").addClass("ui-state-active");

                    $("#jfgridpivottablevaluecolrow1").prop("checked", false);
                    $("#jfgridpivottablevaluecolrowshow label[for='jfgridpivottablevaluecolrow1']").removeClass("ui-state-active");
                }
                else {
                    $("#jfgridpivottablevaluecolrow1").prop("checked", true);
                    $("#jfgridpivottablevaluecolrowshow label[for='jfgridpivottablevaluecolrow1']").addClass("ui-state-active");

                    $("#jfgridpivottablevaluecolrow").prop("checked", false);
                    $("#jfgridpivottablevaluecolrowshow label[for='jfgridpivottablevaluecolrow']").removeClass("ui-state-active");
                }
            }
            else {
                $("#jfgridpivottablevaluecolrowshow").hide();
            }
        },
        resetOrderby: function (obj) {
            var orderby = $("#jfgrid-modal-dialog-config-value .jfgrid-modal-dialog-slider-config-item").index(obj);
            $("#jfgrid-modal-dialog-config-row, #jfgrid-modal-dialog-config-column").find(".jfgrid-modal-dialog-slider-config-item").each(function () {
                if ($(this).data("orderby") == orderby) {
                    $(this).data("orderby", "self");
                }
            });
        },
        jfgridsliderlistclearfilter: function ($filter) {
            var $t = $filter.parent();
            var cindex = $t.data("index");

            var rowhidden = {}, selected = {}, d = jfgrid.pivotTable.origindata, filterdata = {};

            $t.data("rowhidden", "").find(".jfgrid-slider-list-item-filtered").hide();
            jfgrid.pivotTable.setDatatojsfile("selected", {}, cindex);
            jfgrid.pivotTable.setDatatojsfile("rowhidden", null, cindex);

            var newdata = [];
            for (var i = 0; i < d.length; i++) {
                if (rowhidden[i] != null) {
                    continue;
                }
                newdata.push([].concat(d[i]));
            }

            jfgrid.pivotTable.celldata = newdata;

            jfgrid.pivotTable.refreshPivotTable();
            $("#jfgrid-pivotTableFilter-menu, #jfgrid-pivotTableFilter-submenu").hide();
        },
        jfgridsliderlistitemfilter: function ($filter) {
            var $t = $filter.parent(), 
                toffset = $t.offset(), 
                $menu = $("#jfgrid-pivotTableFilter-menu"), 
                winH = $(window).height(), 
                winW = $(window).width();

            var cindex = $t.data("index");

            var rowhidden = $t.data("rowhidden");
            if(rowhidden == null || rowhidden == ""){
                rowhidden = {};
            }
            else if(jfgrid.getObjType(rowhidden) == "string"){
                rowhidden = JSON.parse(rowhidden);
            }

            $("body .jfgrid-cols-menu").hide();
            $("#jfgrid-pivotTableFilter-menu, #jfgrid-pivotTableFilter-submenu").hide();
            $("#jfgrid-pivotTableFilter-byvalue-input").val("");
            $("#jfgrid-pivotTableFilter-bycondition").next().hide();
            $("#jfgrid-pivotTableFilter-byvalue").next().show();

            $menu.data("index", cindex);

            $("#jfgrid-pivotTableFilter-menu .jfgrid-pivotTableFilter-selected-input").hide().find("input").val();
            $("#jfgrid-pivotTableFilter-selected span").data("type", "0").data("type", null).text("无");

            var byconditiontype = $t.data("byconditiontype");
            $("#jfgrid-pivotTableFilter-selected span").data("value", $t.data("byconditionvalue")).data("type", byconditiontype).text($t.data("byconditiontext"));

            if (byconditiontype == "2") {
                var $input = $("#jfgrid-pivotTableFilter-menu .jfgrid-pivotTableFilter-selected-input2").show().find("input");
                $input.eq(0).val($t.data("byconditionvalue1"));
                $input.eq(1).val($t.data("byconditionvalue2"));
            }
            else if (byconditiontype == "1") {
                $("#jfgrid-pivotTableFilter-menu .jfgrid-pivotTableFilter-selected-input").eq(0).show().find("input").val($t.data("byconditionvalue1"));
            }

            $("#jfgrid-pivotTableFilter-byvalue-select").empty().html('<div style="width:100%;text-align:center;position:relative;top:45%;font-size: 14px;"> <div class="jfgridLoaderGif"> </div> <span>数据量大！请稍后</span></div>');
            
            var rowhiddenother = {}; //其它筛选列的隐藏行
            $("#jfgrid-modal-dialog-pivotTable-list .jfgrid-modal-dialog-slider-list-item").not($t.get(0)).each(function () {
                var $t = $(this), rh = $t.data("rowhidden");

                if (rh == null || rh == "") {
                    return true;
                }

                if(jfgrid.getObjType(rh) == "string"){
                    rh = JSON.parse(rh);
                }
                
                for (var r in rh) {
                    rowhiddenother[r] = 0;
                }
            });

            var data = jfgrid.pivotTable.origindata;

            setTimeout(function () {
                //日期值
                var dvmap = {};  
                var dvmap_uncheck = {};

                //除日期以外的值
                var vmap = {}; 
                var vmap_uncheck = {};  

                for (var r = 1; r < data.length; r++) {
                    if(r in rowhiddenother){
                        continue;
                    }

                    if(data[r] == null){
                        continue;
                    }

                    var cell = data[r][cindex];

                    if(cell != null && cell.ct != null && cell.ct.t == "d"){ //单元格是日期
                        var v = jfgrid.mask.update("YYYY-MM-DD", cell.v);

                        var y = v.split("-")[0];
                        var m = v.split("-")[1];
                        var d = v.split("-")[2];

                        if(!(y in dvmap)){
                            dvmap[y] = {};
                        }

                        if(!(m in dvmap[y])){
                            dvmap[y][m] = {};
                        }

                        if(!(d in dvmap[y][m])){
                            dvmap[y][m][d] = 0;
                        }
                        
                        dvmap[y][m][d]++;

                        if(r in rowhidden){
                            dvmap_uncheck[y] = 0;
                            dvmap_uncheck[m] = 0;
                            dvmap_uncheck[d] = 0;
                        }
                    }
                    else{
                        if(cell == null || jfgrid.func_methods.isRealNull(cell.v)){
                            var v = null;
                            var m = null;
                        }
                        else{
                            var v = cell.v;
                            var m = cell.m;
                        }

                        if(!(v in vmap)){
                            vmap[v] = {};
                        }

                        if(!(m in vmap[v])){
                            vmap[v][m] = 0;                            
                        }

                        vmap[v][m]++;

                        if(r in rowhidden){
                            vmap_uncheck[v + "#$$$#" + m] = 0;
                        }
                    }
                }

                //遍历数据加到页面
                var item = [];

                if(JSON.stringify(dvmap).length > 2){
                    for(y in dvmap){
                        var ysum = 0;
                        var monthHtml = '';

                        for(m in dvmap[y]){
                            var msum = 0;
                            var dayHtml = '';

                            for(d in dvmap[y][m]){
                                var dayL = dvmap[y][m][d];
                                msum += dayL;

                                //月 小于 10
                                if(Number(m) < 10){
                                    var mT = "0" + Number(m);
                                }
                                else{
                                    var mT = m;    
                                }

                                //日 小于 10
                                if(Number(d) < 10){
                                    var dT = "0" + Number(d);
                                }
                                else{
                                    var dT = d;    
                                }

                                //日是否选中状态
                                if((y in dvmap_uncheck) && (m in dvmap_uncheck) && (d in dvmap_uncheck)){
                                    dayHtml +=  '<div class="day jfgrid-mousedown-cancel cf" data-check="false" title="'+ y +'-'+ mT +'-'+ dT +'">' +
                                                    '<input class="jfgrid-mousedown-cancel" type="checkbox"/>' +
                                                    '<label class="jfgrid-mousedown-cancel">' + d + '</label>' +
                                                    '<span class="count jfgrid-mousedown-cancel">( ' + dayL + ' )</span>' +
                                                '</div>';
                                }
                                else{
                                    dayHtml +=  '<div class="day jfgrid-mousedown-cancel cf" data-check="true" title="'+ y +'-'+ mT +'-'+ dT +'">' +
                                                    '<input class="jfgrid-mousedown-cancel" type="checkbox" checked="checked"/>' +
                                                    '<label class="jfgrid-mousedown-cancel">' + d + '</label>' +
                                                    '<span class="count jfgrid-mousedown-cancel">( ' + dayL + ' )</span>' +
                                                '</div>';
                                }
                            }

                            ysum += msum;
                            
                            //月 小于 10
                            if(Number(m) < 10){
                                var mT2 = "0" + Number(m);
                            }
                            else{
                                var mT2 = m;    
                            }

                            //月是否选中状态
                            if((y in dvmap_uncheck) && (m in dvmap_uncheck)){
                                monthHtml += '<div class="monthBox jfgrid-mousedown-cancel">' +
                                                '<div class="month jfgrid-mousedown-cancel cf" data-check="false" title="'+ y +'-'+ mT2 +'">' +
                                                    '<i class="fa fa-caret-right jfgrid-mousedown-cancel" aria-hidden="true"></i>' +
                                                    '<input class="jfgrid-mousedown-cancel" type="checkbox"/>' +
                                                    '<label class="jfgrid-mousedown-cancel">' + m + '月</label>' +
                                                    '<span class="count jfgrid-mousedown-cancel">( ' + msum + ' )</span>' +
                                                '</div>' +
                                                '<div class="dayList jfgrid-mousedown-cancel">' + dayHtml + '</div>' +
                                             '</div>';
                            }
                            else{
                                monthHtml += '<div class="monthBox jfgrid-mousedown-cancel">' +
                                                '<div class="month jfgrid-mousedown-cancel cf" data-check="true" title="'+ y +'-'+ mT2 +'">' +
                                                    '<i class="fa fa-caret-right jfgrid-mousedown-cancel" aria-hidden="true"></i>' +
                                                    '<input class="jfgrid-mousedown-cancel" type="checkbox" checked="checked"/>' +
                                                    '<label class="jfgrid-mousedown-cancel">' + m + '月</label>' +
                                                    '<span class="count jfgrid-mousedown-cancel">( ' + msum + ' )</span>' +
                                                '</div>' +
                                                '<div class="dayList jfgrid-mousedown-cancel">' + dayHtml + '</div>' +
                                             '</div>';
                            }
                        }

                        //年是否选中状态
                        if(y in dvmap_uncheck){
                            var yearHtml =  '<div class="yearBox jfgrid-mousedown-cancel">' +
                                                '<div class="year jfgrid-mousedown-cancel cf" data-check="false" title="'+ y +'">' +
                                                    '<i class="fa fa-caret-right jfgrid-mousedown-cancel" aria-hidden="true"></i>' +
                                                    '<input class="jfgrid-mousedown-cancel" type="checkbox"/>' +
                                                    '<label class="jfgrid-mousedown-cancel">' + y + '年</label>' +
                                                    '<span class="count jfgrid-mousedown-cancel">( ' + ysum + ' )</span>' +
                                                '</div>' +
                                                '<div class="monthList jfgrid-mousedown-cancel">' + monthHtml + '</div>' +
                                            '</div>';
                        }
                        else{
                            var yearHtml =  '<div class="yearBox jfgrid-mousedown-cancel">' +
                                                '<div class="year jfgrid-mousedown-cancel cf" data-check="true" title="'+ y +'">' +
                                                    '<i class="fa fa-caret-right jfgrid-mousedown-cancel" aria-hidden="true"></i>' +
                                                    '<input class="jfgrid-mousedown-cancel" type="checkbox" checked="checked"/>' +
                                                    '<label class="jfgrid-mousedown-cancel">' + y + '年</label>' +
                                                    '<span class="count jfgrid-mousedown-cancel">( ' + ysum + ' )</span>' +
                                                '</div>' +
                                                '<div class="monthList jfgrid-mousedown-cancel">' + monthHtml + '</div>' +
                                            '</div>';
                        }

                        item.unshift(yearHtml);
                    }
                }

                if(JSON.stringify(vmap).length > 2){
                    var vmapKeys = Object.keys(vmap);
                    vmapKeys = jfgrid.orderbydata1D(vmapKeys, true);

                    for(var i = 0; i < vmapKeys.length; i++){
                        var v = vmapKeys[i];

                        for(x in vmap[v]){
                            if((v + "#$$$#" + x) == "null#$$$#null"){
                                var text = "(空白)";
                            }
                            else{
                                var text = x;
                            }

                            //是否选中状态
                            if((v + "#$$$#" + x) in vmap_uncheck){
                                var dataHtml =  '<div class="textBox jfgrid-mousedown-cancel cf" data-check="false" data-filter="'+ (v + "#$$$#" + x) +'" title="'+ x +'">' +
                                                    '<input class="jfgrid-mousedown-cancel" type="checkbox"/>' +
                                                    '<label class="jfgrid-mousedown-cancel">' + text + '</label>' +
                                                    '<span class="jfgrid-mousedown-cancel count">( ' + vmap[v][x] + ' )</span>' +
                                                '</div>';
                            }
                            else{
                                var dataHtml =  '<div class="textBox jfgrid-mousedown-cancel cf" data-check="true" data-filter="'+ (v + "#$$$#" + x) +'" title="'+ x +'">' +
                                                    '<input class="jfgrid-mousedown-cancel" type="checkbox" checked="checked"/>' +
                                                    '<label class="jfgrid-mousedown-cancel">' + text + '</label>' +
                                                    '<span class="jfgrid-mousedown-cancel count">( ' + vmap[v][x] + ' )</span>' +
                                                '</div>';
                            }

                            item.push(dataHtml);
                        }
                    }
                }

                $("#jfgrid-pivotTableFilter-byvalue-select").html("<div class='ListBox jfgrid-mousedown-cancel' style='max-height:" + (winH - toffset.top - 350) + "px;overflow-y:auto;overflow-x:hidden;'>" + item.join("") + "</div>");
            }, 1);

            showrightclickmenu($menu, toffset.left - 250, toffset.top);
        },
        getSumTypeName: function (type) {
            var name = "";
            if (type == "SUM") {
                name = "求和";
            }
            else if (type == "COUNT") {
                name = "数值计数";
            }
            else if (type == "COUNTA") {
                name = "计数";
            }
            else if (type == "COUNTUNIQUE") {
                name = "去重计数";
            }
            else if (type == "AVERAGE") {
                name = "平均值";
            }
            else if (type == "MAX") {
                name = "最大值";
            }
            else if (type == "MIN") {
                name = "最小值";
            }
            else if (type == "MEDIAN") {
                name = "中位数";
            }
            else if (type == "PRODUCT") {
                name = "乘积";
            }
            else if (type == "STDEV") {
                name = "标准差";
            }
            else if (type == "STDEVP") {
                name = "整体标准差";
            }
            else if (type == "VAR") {
                name = "方差";
            }
            else if (type == "VARP") {
                name = "整体方差";
            }
            return name;
        },
        setDatatojsfile: function (attr, value, cindex) {
            var index = jfgrid.sheetmanage.getSheetIndex(this.pivotSheetIndex);
            if (jfgridfile[index]["pivotTable"] == null) {
                jfgridfile[index]["pivotTable"] = {};
            }

            if (cindex == null) {
                jfgridfile[index]["pivotTable"][attr] = value;
                this[attr] = value;
            }
            else {
                if (jfgridfile[index]["pivotTable"]["filterparm"] == null) {
                    jfgridfile[index]["pivotTable"]["filterparm"] = {};
                }

                if (jfgridfile[index]["pivotTable"]["filterparm"][cindex.toString()] == null) {
                    jfgridfile[index]["pivotTable"]["filterparm"][cindex.toString()] = {};
                }
                jfgridfile[index]["pivotTable"]["filterparm"][cindex.toString()][attr] = value;

                if (this["filterparm"] == null) {
                    this["filterparm"] = {};
                }

                if (this["filterparm"][cindex.toString()] == null) {
                    this["filterparm"][cindex.toString()] = {};
                }

                this["filterparm"][cindex.toString()][attr] = value;
            }
        },
        createPivotTable: function (e) {
            var datasheetindex = jfgrid.currentSheetIndex;

            if(jfgrid.isEditMode()){
                alert("非编辑模式下禁止该操作！");
                return;
            }

            if(jfgird_select_save.length > 1){
                jfgrid.tooltip.info("提示", "不能对多重选择区域执行此操作，请选择单个区域，然后再试");
                return
            }

            if (jfgird_select_save.length == 0 || jfgird_select_save[0].row[0] == jfgird_select_save[0].row[1] || jfgird_select_save[0].column[0] == jfgird_select_save[0].column[1]) {
                jfgrid.tooltip.info("提示", "请选择新建透视表的区域");
                return;
            }
            var select_save = $.extend(true, {}, jfgird_select_save[0]);
            jfgrid.sheetmanage.addNewSheet(e, true);

            this.getCellData(jfgrid.currentSheetIndex, datasheetindex, select_save);

            this.setDatatojsfile("pivot_select_save", select_save);
            this.setDatatojsfile("pivotDataSheetIndex", datasheetindex);

            this.initialPivotManage();
            //this.drawPivotTable();
        },
        changePivotTable: function (index) {
            var pivotDataSheetIndex = jfgridfile[jfgrid.sheetmanage.getSheetIndex(index)].pivotTable.pivotDataSheetIndex;
            var real_pivotDataSheetIndex = jfgrid.sheetmanage.getSheetIndex(pivotDataSheetIndex);

            if(real_pivotDataSheetIndex == null){
                jfgrid.tooltip.info("此数据透视表的源数据已损坏！", "");
                return;
            }

            this.getCellData(index);
            this.initialPivotManage(true);
        },
        refreshPivotTable: function () {
            var redo = {};
            var pivotTable = this.getPivotTableData();
            redo["pivotTable"] = pivotTable; 
            redo["data"] = jfgrid.editor.deepCopyFlowData(jfgrid.flowdata);//取数据

            this.storePivotTableParam();
            var ret = this.dataHandler(this.column, this.row, this.values, this.showType, this.celldata);
            this.setDatatojsfile("pivotDatas", ret);

            var d = $.extend(true, [], jfgrid.sheetmanage.nulldata);
            var data = d;
            if (ret.length == 0) {
                //this.drawPivotTable =true;
                //this.pivotTableBoundary = [12, 6];
                this.setDatatojsfile("drawPivotTable", true);
                this.setDatatojsfile("pivotTableBoundary", [12, 6]);
            }
            else {
                //this.drawPivotTable = false;
                //this.pivotTableBoundary = [ret.length, ret[0].length];
                this.setDatatojsfile("drawPivotTable", false);
                this.setDatatojsfile("pivotTableBoundary", [ret.length, ret[0].length]);

                var rlen = ret.length, clen = ret[0].length;

                var addr = rlen - d.length, addc = clen - d[0].length;

                data = jfgrid.datagridgrowth(d, addr + 20, addc + 10, true);

                for (var r = 0; r < rlen; r++) {
                    var x = [].concat(data[r]);
                    for (var c = 0; c < clen; c++) {
                        var value = "";
                        if (ret[r] != null && ret[r][c] != null) {
                            value = jfgrid.getcellvalue(r, c, ret);
                        }
                        x[c] = value;
                    }
                    data[r] = x;
                }
            }

            redo["type"] = "pivotTable_change";
            redo["curdata"] = $.extend(true, [], data);
            redo["sheetIndex"] = jfgrid.currentSheetIndex;

            var pivotTable = this.getPivotTableData();
            redo["pivotTablecur"] = pivotTable; 

            if(clearjfundo){
                jfgrid.jfundo = [];
                jfgrid.jfredo.push(redo);
            }
            
            //jfgrid.flowdata = flowdata_new = data;
            jfgrid.cleargridelement();
            clearjfundo = false;
            
            if (addr > 0 || addc > 0) {
                jfgrid.jfrefreshgridall(data[0].length, data.length, data, null, jfgird_select_save, "datachangeAll");
            }
            else {
                jfgrid.jfrefreshgrid(data, jfgird_select_save);
                jfgrid.selectHightlightShow();
            }

            clearjfundo = true;
        },
        drawPivotTable: true,
        pivotTableBoundary: [12, 6],
        pivotclick: function (row_index, col_index, index) {
            if(index == null){
                index = jfgrid.currentSheetIndex;
            }

            var file = jfgridfile[jfgrid.sheetmanage.getSheetIndex(index)];

            if(!file.isPivotTable){
                return;
            }

            var pivotDataSheetIndex = file.pivotTable.pivotDataSheetIndex;
            var real_pivotDataSheetIndex = jfgrid.sheetmanage.getSheetIndex(pivotDataSheetIndex);

            if(real_pivotDataSheetIndex == null){
                return;
            }

            if (this.isPivotRange(row_index, col_index)) {
                $("#jfgrid-modal-dialog-slider-pivot").show();
                jfgrid.jfgridsizeauto();
                $("#jfgrid-sta-content").css("padding-right", 260);
            }
            else {
                $("#jfgrid-modal-dialog-slider-pivot").hide();
                jfgrid.jfgridsizeauto();
                $("#jfgrid-sta-content").css("padding-right", 10);
            }
        },
        isPivotRange: function (row_index, col_index) {
            if (!!jfgridcurrentisPivotTable) {
                if (row_index < this.pivotTableBoundary[0] && col_index < this.pivotTableBoundary[1]) {
                    return true;
                }
                else {
                    return false;
                }
            }
        },
        storePivotTableParam: function () {
            var columnarr = [], rowarr = [], filterarr = [], valuesarr = [];
            $("#jfgrid-modal-dialog-config-filter .jfgrid-modal-dialog-slider-config-item").each(function () {
                var item = {};
                item["index"] = $(this).data("index");
                item["name"] = $(this).data("name");
                item["fullname"] = $(this).find(".jfgrid-modal-dialog-slider-config-item-txt").text();
                // item["order"] = $(this).data("order");
                // item["orderby"] = $(this).data("orderby");
                // item["stastic"] = $(this).data("stastic");
                filterarr.push(item);
            });

            $("#jfgrid-modal-dialog-config-row .jfgrid-modal-dialog-slider-config-item").each(function () {
                var item = {};
                item["index"] = $(this).data("index");
                item["name"] = $(this).data("name");
                item["fullname"] = $(this).find(".jfgrid-modal-dialog-slider-config-item-txt").text();
                item["order"] = $(this).data("order");
                item["orderby"] = $(this).data("orderby");
                item["stastic"] = $(this).data("stastic");
                rowarr.push(item);
            });

            $("#jfgrid-modal-dialog-config-column .jfgrid-modal-dialog-slider-config-item").each(function () {
                var item = {};
                item["index"] = $(this).data("index");
                item["name"] = $(this).data("name");
                item["fullname"] = $(this).find(".jfgrid-modal-dialog-slider-config-item-txt").text();
                item["order"] = $(this).data("order");
                item["orderby"] = $(this).data("orderby");
                item["stastic"] = $(this).data("stastic");
                columnarr.push(item);
            });

            $("#jfgrid-modal-dialog-config-value .jfgrid-modal-dialog-slider-config-item").each(function () {
                var item = {};
                item["index"] = $(this).data("index");
                item["name"] = $(this).data("name");
                item["fullname"] = $(this).find(".jfgrid-modal-dialog-slider-config-item-txt").text();
                item["sumtype"] = $(this).data("sumtype");
                item["nameindex"] = $(this).data("nameindex");
                valuesarr.push(item);
            });

            this.setDatatojsfile("column", columnarr);
            this.setDatatojsfile("row", rowarr);
            this.setDatatojsfile("filter", filterarr);
            this.setDatatojsfile("values", valuesarr);
            var showtype = $("#jfgridpivottablevaluecolrow:checked, #jfgridpivottablevaluecolrow1:checked").val();
            this.setDatatojsfile("showType", showtype == "0" ? "row" : "column");

            var pivotTable = this.getPivotTableData();
            delete pivotTable.pivotDatas;
            jfgrid.server.saveParam("all", this.pivotSheetIndex, pivotTable, { "k": "pivotTable" });
        },
        getPivotTableData:function(dataindex){
            if(dataindex == null){
                dataindex = this.pivotSheetIndex;
            }

            var index = jfgrid.sheetmanage.getSheetIndex(dataindex);
            var pivotTable = jfgridfile[index]["pivotTable"];

            if(jfgrid.getObjType(pivotTable) == "object"){
                pivotTable = $.extend(true, {}, jfgridfile[index]["pivotTable"]);
            }
            else{
                pivotTable = eval('('+ pivotTable +')');
            }
            //var pivotTable = $.extend(true, {}, jfgridfile[index]["pivotTable"]);
            return pivotTable
        },
        addValuesToTitle: function (titles, values) {
            var rowLen = titles.length * values.length, colLen = titles[0].length + 1;
            var retdata = [];
            if (titles.length == 0 && values.length > 0) {
                for (var v = 0; v < values.length; v++) {
                    retdata.push(values[v].fullname);
                }
                return retdata;
            }

            if (values.length == 0 && titles.length > 0) {
                return titles;
            }

            for (var r = 0; r < rowLen; r++) {
                retdata[r] = new Array(colLen);
                for (var c = 0; c < colLen - 1; c++) {
                    retdata[r][c] = titles[Math.floor(r / values.length)][c];
                }

                retdata[r][colLen - 1] = values[r % values.length].fullname;
            }

            return retdata;
        },
        initialPivotManage: function (restore) {
            //this.getCellData();
            if (this.initial) {
                this.initial = false;
                $("body").append(jfgridPivotTableHTML);
                $("#jfgrid-modal-dialog-slider-close").click(function () {
                    $("#jfgrid-modal-dialog-slider-pivot").hide();
                    jfgrid.jfgridsizeauto();
                });

                $("body").append(jfgrid.replaceHtml(modelHTML, { "id": "jfgrid-data-pivotTable-selection", "addclass": "jfgrid-data-pivotTable-selection", "title": "选取数据范围", "content": '<input id="jfgrid-pivotTable-range-selection-input" class="jfgrid-datavisual-range-container" style="font-size: 14px;padding:5px;max-width:none;" spellcheck="false" aria-label="数据范围" placeholder="数据范围">', "botton": '<button id="jfgrid-pivotTable-selection-confirm" class="btn btn-primary">确认选取</button><button class="btn btn-default jfgrid-model-close-btn">取消</button>' }));

                $("body").append(jfgrid.replaceHtml(filtermenuHTML, { "menuid": "pivotTableFilter" }));
                $("body").append(jfgrid.replaceHtml(filtersubmenuHTML, { "menuid": "pivotTableFilter" }));
                $("body").append(pivottableconfigHTML);
                $("body").append(pivottablesumHTML);

                $("#jfgrid-pivotTableFilter-orderby-asc").remove();
                $("#jfgrid-pivotTableFilter-orderby-desc").next().remove();
                $("#jfgrid-pivotTableFilter-orderby-desc").remove();
                $("#jfgrid-pivotTableFilter-orderby-color").next().remove();
                $("#jfgrid-pivotTableFilter-orderby-color").remove();

                $("#jfgridpivottablevaluecolrow, #jfgridpivottablevaluecolrow1").checkboxradio({
                    icon: false
                }).change(function () {
                    jfgrid.pivotTable.refreshPivotTable();
                });

                var hidefilersubmenu = null;
                $("#jfgrid-pivotTableFilter-menu").mouseover(function () {
                    clearTimeout(hidefilersubmenu);
                    hidefilersubmenu = setTimeout(function () {
                        $("#jfgrid-pivotTableFilter-submenu").hide();
                    }, 500);
                });

                //点击复选框
                $(document).off("click.ptFilterCheckbox1").on("click.ptFilterCheckbox1", "#jfgrid-pivotTableFilter-byvalue-select .textBox",function(){
                    if($(this).attr("data-check") == "true"){
                        $(this).attr("data-check", "false");
                        $(this).find("input[type='checkbox']").removeAttr("checked");
                    }
                    else{
                        $(this).attr("data-check", "true");
                        $(this).find("input[type='checkbox']").prop("checked", true);
                    }
                })
                $(document).off("click.ptFilterCheckbox2").on("click.ptFilterCheckbox2", "#jfgrid-pivotTableFilter-byvalue-select .year",function(){
                    if($(this).attr("data-check") == "true"){
                        $(this).attr("data-check", "false");
                        $(this).parents(".yearBox").find(".month").attr("data-check", "false");
                        $(this).parents(".yearBox").find(".day").attr("data-check", "false");
                        $(this).parents(".yearBox").find("input[type='checkbox']").removeAttr("checked");
                    }
                    else{
                        $(this).attr("data-check", "true");
                        $(this).parents(".yearBox").find(".month").attr("data-check", "true");
                        $(this).parents(".yearBox").find(".day").attr("data-check", "true");
                        $(this).parents(".yearBox").find("input[type='checkbox']").prop("checked", true);
                    }
                })
                $(document).off("click.ptFilterCheckbox3").on("click.ptFilterCheckbox3", "#jfgrid-pivotTableFilter-byvalue-select .month",function(){
                    //月份 对应的 天
                    if($(this).attr("data-check") == "true"){
                        $(this).attr("data-check", "false");
                        $(this).parents(".monthBox").find(".day").attr("data-check", "false");
                        $(this).parents(".monthBox").find("input[type='checkbox']").removeAttr("checked");
                    }
                    else{
                        $(this).attr("data-check", "true");
                        $(this).parents(".monthBox").find(".day").attr("data-check", "true");
                        $(this).parents(".monthBox").find("input[type='checkbox']").prop("checked", true);
                    }
                    //月份 对应的 年份
                    var yearDayAllCheck = true;
                    var $yearDay = $(this).parents(".yearBox").find(".day");
                    $yearDay.each(function(i,e){
                        if($(e).attr("data-check") == "true"){
                            
                        }
                        else{
                            yearDayAllCheck = false;
                        }
                    });
                    if(yearDayAllCheck){
                        $(this).parents(".yearBox").find(".year").attr("data-check", "true");
                        $(this).parents(".yearBox").find(".year input[type='checkbox']").prop("checked", true);
                    }
                    else{
                        $(this).parents(".yearBox").find(".year").attr("data-check", "false");
                        $(this).parents(".yearBox").find(".year input[type='checkbox']").removeAttr("checked");
                    }
                })
                $(document).off("click.ptFilterCheckbox4").on("click.ptFilterCheckbox4", "#jfgrid-pivotTableFilter-byvalue-select .day",function(){
                    if($(this).attr("data-check") == "true"){
                        $(this).attr("data-check", "false");
                        $(this).find("input[type='checkbox']").removeAttr("checked");
                    }
                    else{
                        $(this).attr("data-check", "true");
                        $(this).find("input[type='checkbox']").prop("checked", true);
                    }
                    //天 对应的 月份
                    var monthDayAllCheck = true;
                    var $monthDay = $(this).parents(".monthBox").find(".day");
                    $monthDay.each(function(i,e){
                        if($(e).attr("data-check") == "true"){
                            
                        }
                        else{
                            monthDayAllCheck = false;
                        }
                    });
                    if(monthDayAllCheck){
                        $(this).parents(".monthBox").find(".month").attr("data-check", "true");
                        $(this).parents(".monthBox").find(".month input[type='checkbox']").prop("checked", true);
                    }
                    else{
                        $(this).parents(".monthBox").find(".month").attr("data-check", "false");
                        $(this).parents(".monthBox").find(".month input[type='checkbox']").removeAttr("checked");
                    }
                    //天 对应的 年份
                    var yearDayAllCheck = true;
                    var $yearDay = $(this).parents(".yearBox").find(".day");
                    $yearDay.each(function(i,e){
                        if($(e).attr("data-check") == "true"){
                            
                        }
                        else{
                            yearDayAllCheck = false;
                        }
                    });
                    if(yearDayAllCheck){
                        $(this).parents(".yearBox").find(".year").attr("data-check", "true");
                        $(this).parents(".yearBox").find(".year input[type='checkbox']").prop("checked", true);
                    }
                    else{
                        $(this).parents(".yearBox").find(".year").attr("data-check", "false");
                        $(this).parents(".yearBox").find(".year input[type='checkbox']").removeAttr("checked");
                    }
                })

                //日期 三级下拉显示
                $(document).off("click.ptFilterYearDropdown").on("click.ptFilterYearDropdown", "#jfgrid-pivotTableFilter-byvalue-select .yearBox .fa-caret-right",function(){
                    var $p = $(this).parents(".jfgrid-mousedown-cancel");
                    if($p.hasClass("year")){
                        $(this).parents(".yearBox").find(".monthList").slideToggle();
                    }
                    if($p.hasClass("month")){
                        $(this).parents(".monthBox").find(".dayList").slideToggle();
                    }
                });

                //全选
                $("#jfgrid-pivotTableFilter-byvalue-btn-all").click(function () {
                    $("#jfgrid-pivotTableFilter-byvalue-select .ListBox input[type='checkbox']").prop("checked", true);
                    $("#jfgrid-pivotTableFilter-byvalue-select .ListBox input[type='checkbox']").parents(".jfgrid-mousedown-cancel").attr("data-check", "true");
                });

                //反选
                $("#jfgrid-pivotTableFilter-byvalue-btn-contra").click(function () {
                    var $input = $("#jfgrid-pivotTableFilter-byvalue-select .ListBox input[type='checkbox']");
                    $input.each(function(i, e){
                        if($(e).is(":checked")){
                            $(e).removeAttr("checked");
                            $(e).parents(".jfgrid-mousedown-cancel").attr("data-check", "false");
                        }
                        else{
                            $(e).prop("checked", true);
                            $(e).parents(".jfgrid-mousedown-cancel").attr("data-check", "true");
                        }
                    });
                    //天 对应的 月份
                    var $month = $("#jfgrid-pivotTableFilter-byvalue-select .ListBox .monthBox");
                    $month.each(function(index, event){
                        var monthDayAllCheck = true;
                        var $monthDay = $(event).find(".day input[type='checkbox']");
                        $monthDay.each(function(i,e){
                            if($(e).is(":checked")){
                                
                            }
                            else{
                                monthDayAllCheck = false;
                            }
                        });
                        if(monthDayAllCheck){
                            $(event).find(".month input[type='checkbox']").prop("checked", true);
                            $(event).attr("data-check", "true");
                        }
                        else{
                            $(event).find(".month input[type='checkbox']").removeAttr("checked");
                            $(event).attr("data-check", "false");
                        }
                    });
                    //天 对应的 年份
                    var $year = $("#jfgrid-pivotTableFilter-byvalue-select .ListBox .yearBox");
                    $year.each(function(index, event){
                        var yearDayAllCheck = true;
                        var $yearDay = $(event).find(".day input[type='checkbox']");
                        $yearDay.each(function(i,e){
                            if($(e).is(":checked")){
                                
                            }
                            else{
                                yearDayAllCheck = false;
                            }
                        });
                        if(yearDayAllCheck){
                            $(event).find(".year input[type='checkbox']").prop("checked", true);
                            $(event).attr("data-check", "true");
                        }
                        else{
                            $(event).find(".year input[type='checkbox']").removeAttr("checked");
                            $(event).attr("data-check", "false");
                        }
                    });
                });

                //清除
                $("#jfgrid-pivotTableFilter-byvalue-btn-clear").click(function () {
                    $("#jfgrid-pivotTableFilter-byvalue-select .ListBox input[type='checkbox']").removeAttr("checked");
                    $("#jfgrid-pivotTableFilter-byvalue-select .ListBox input[type='checkbox']").parents(".jfgrid-mousedown-cancel").attr("data-check", "false");
                });

                //按照值进行筛选
                $("#jfgrid-pivotTableFilter-byvalue-input").on('input propertychange', function () {
                    var v = $(this).val().toString();
                    $("#jfgrid-pivotTableFilter-byvalue-select .ListBox .jfgrid-mousedown-cancel").show();
                    if(v != ""){
                        var $check = $("#jfgrid-pivotTableFilter-byvalue-select .ListBox input[type='checkbox']");
                        $check.each(function(i, e){
                            var $p = $(e).parents(".jfgrid-mousedown-cancel");
                            if($p.hasClass("day")){ //日期
                                var day = $(e).siblings("label").text().toString();
                                var month = $(e).parents(".monthBox").find(".month label").text().toString();
                                var year = $(e).parents(".yearBox").find(".year label").text().toString();
                                var itemV = year + "-" + month + "-" + day;
                                
                                if(itemV.indexOf(v) == -1){
                                    $(e).parents(".day").hide();
                                    //天 对应的 月份
                                    var $monthDay = $(e).parents(".dayList").find(".day:visible");
                                    if($monthDay.length == 0){
                                        $(e).parents(".monthBox").find(".month").hide();
                                    }
                                    //天 对应的 年份
                                    var $yearDay = $(e).parents(".monthList").find(".day:visible");
                                    if($yearDay.length == 0){
                                        $(e).parents(".yearBox").find(".year").hide();
                                    }
                                }
                            }
                            if($p.hasClass("textBox")){ //其它
                                var itemV = $(e).siblings("label").text().toString();
                                
                                if(itemV.indexOf(v) == -1){
                                    $(e).parents(".textBox").hide();
                                }
                            }
                        });
                    }
                });

                $("#jfgrid-pivotTableFilter-bycondition, #jfgrid-pivotTableFilter-byvalue").click(function () {
                    var $t = $(this);
                    $t.next().slideToggle(200);
                    setTimeout(function () {
                        if ($t.attr("id") == "jfgrid-pivotTableFilter-bycondition" && $("#jfgrid-pivotTableFilter-bycondition").next().is(":visible")) {
                            if ($("#jfgrid-pivotTableFilter-selected span").text() != "无") {
                                $("#jfgrid-pivotTableFilter-byvalue").next().slideUp(200);
                            }
                        }

                        if ($t.is($("#jfgrid-pivotTableFilter-bycondition"))) {
                            if ($("#jfgrid-pivotTableFilter-bycondition").next().is(":hidden") && $("#jfgrid-pivotTableFilter-byvalue").next().is(":hidden")) {
                                $("#jfgrid-pivotTableFilter-byvalue").next().slideDown(200);
                            }
                        }
                    }, 300);

                });

                //取消按钮
                $("#jfgrid-pivotTableFilter-cancel").click(function () {
                    $("#jfgrid-pivotTableFilter-menu, #jfgrid-pivotTableFilter-submenu").hide();
                });

                $("#jfgrid-pivotTableFilter-selected").click(function () {
                    var $t = $(this), toffset = $t.offset(), $menu = $("#jfgrid-pivotTableFilter-submenu");
                    $menu.hide();
                    var winH = $(window).height(), winW = $(window).width();
                    var menuW = $menu.width(), menuH = $menu.height();
                    var top = toffset.top, left = toffset.left, mheight = winH - toffset.top - 20;
                    if (toffset.left + menuW > winW) {
                        left = toffset.left - menuW;
                    }

                    if (toffset.top > winH / 2) {
                        top = winH - toffset.top;
                        if (top < 0) {
                            top = 0;
                        }

                        mheight = toffset.top - 20;
                    }

                    $menu.css({ "top": top, "left": left, "height": mheight }).show();
                    clearTimeout(hidefilersubmenu);
                });

                //按条件过滤
                $("#jfgrid-pivotTableFilter-submenu").mouseover(function () {
                    clearTimeout(hidefilersubmenu);
                }).find(".jfgrid-cols-menuitem").click(function (e) {
                    $("#jfgrid-pivotTableFilter-selected span").html($(this).find(".jfgrid-cols-menuitem-content").text()).data("value", $(this).data("value"));
                    $("#jfgrid-pivotTableFilter-menu .jfgrid-pivotTableFilter-selected-input").hide();
                    if ($(this).data("type") == "2") {
                        $("#jfgrid-pivotTableFilter-selected span").data("type", "2");
                        $("#jfgrid-pivotTableFilter-menu .jfgrid-pivotTableFilter-selected-input2").show();
                    }
                    else if ($(this).data("type") == "0") {
                        $("#jfgrid-pivotTableFilter-selected span").data("type", "0");
                    }
                    else {
                        $("#jfgrid-pivotTableFilter-selected span").data("type", "1");
                        $("#jfgrid-pivotTableFilter-menu .jfgrid-pivotTableFilter-selected-input").eq(0).show();
                        //若是日期 改变input type类型为date
                        if($(this).attr("data-value") == "dateequal" || $(this).attr("data-value") == "datelessthan" || $(this).attr("data-value") == "datemorethan"){
                            $("#jfgrid-pivotTableFilter-menu .jfgrid-pivotTableFilter-selected-input input").prop("type", "date");
                        }
                        else{
                            $("#jfgrid-pivotTableFilter-menu .jfgrid-pivotTableFilter-selected-input input").prop("type", "text");
                        }
                    }
                    $("#jfgrid-pivotTableFilter-byvalue").next().slideUp();
                    $("#jfgrid-pivotTableFilter-submenu").hide();
                });

                $("#jfgrid-modal-dialog-pivotTable-list").on("click", " .jfgrid-slider-list-item-filter", function (e) {
                    //var $t = $(this).parent(),$filter = $(this), toffset = $t.offset(), $menu = $("#jfgrid-pivotTableFilter-menu"), winH = $(window).height(), winW = $(window).width();
                    jfgrid.pivotTable.jfgridsliderlistitemfilter($(this));
                    e.stopPropagation();
                    return false;
                });
                //.on("mousedown dblclick mouseup", function (e) { e.stopPropagation(); return false; });

                $("#jfgrid-modal-dialog-pivotTable-list").on("click", " .jfgrid-slider-list-item-filtered", function (e) {
                    jfgrid.pivotTable.jfgridsliderlistclearfilter($(this).next());
                    e.stopPropagation();
                    return false;
                });


                $("#jfgrid-dialog-pivotTable-range-seleted").click(function () {
                    $("#jfgrid-modal-dialog-slider-pivot").hide();
                    jfgrid.jfgridsizeauto();
                    var $t = $("#jfgrid-data-pivotTable-selection"), myh = $t.outerHeight(), myw = $t.outerWidth();
                    var winw = $(window).width(), winh = $(window).height();
                    var scrollLeft = $(document).scrollLeft(), scrollTop = $(document).scrollTop();

                    $("#jfgrid-data-pivotTable-selection").css({ "left": (winw + scrollLeft - myw) / 2, "top": (winh + scrollTop - myh) / 4 }).show();

                    jfgrid.pivotTable.jgridCurrentPivotInput = $("#jfgrid-dialog-pivotTable-range").html();
                    $("#jfgrid-pivotTable-range-selection-input").val(jfgrid.pivotTable.jgridCurrentPivotInput);
                    jfgrid.pivotTable.jfgrid_pivotTable_select_state = true;
                    //jfgrid.pivotTable.pivotSheetIndex = jfgrid.currentSheetIndex;
                });

                //清除筛选按钮
                $("#jfgrid-pivotTableFilter-initial").click(function () {
                    $("#jfgrid-modal-dialog-pivotTable-list .jfgrid-slider-list-item-filtered").hide();
                    $("#jfgrid-modal-dialog-pivotTable-list .jfgrid-modal-dialog-slider-list-item").data("rowhidden", "");
                    $("#jfgrid-pivotTableFilter-menu, #jfgrid-pivotTableFilter-submenu").hide();
                    $("#jfgrid-pivotTableFilter-menu .jfgrid-pivotTableFilter-selected-input").hide().find("input").val();
                    $("#jfgrid-pivotTableFilter-selected span").data("type", "0").data("type", null).text("无");

                    jfgrid.pivotTable.setDatatojsfile("filterparm", null);
                    jfgrid.pivotTable.celldata = jfgrid.pivotTable.origindata;

                    jfgrid.pivotTable.refreshPivotTable();
                });

                $("#jfgrid-modal-dialog-config-row, #jfgrid-modal-dialog-config-column").on("click", ".jfgrid-modal-dialog-slider-config-item-icon", function (e) {
                    var $t = $(e.target), $item = $t.closest(".jfgrid-modal-dialog-slider-config-item"), cindex = $item.data("index"), toffset = $item.offset();
                    var order = $item.data("order"), orderby = $item.data("orderby"), stastic = $item.data("stastic");
                    if (order == null) {
                        order = "default";
                    }

                    var option = '<option value="self">' + $item.find(".jfgrid-modal-dialog-slider-config-item-txt").data("name") + '</option>';

                    $("#jfgrid-modal-dialog-config-value .jfgrid-modal-dialog-slider-config-item").each(function (i) {
                        option += '<option value="' + i + '">' + $(this).find(".jfgrid-modal-dialog-slider-config-item-txt").text() + '</option>';
                    });
                    $("#jfgrid-pivotTable-config-option-orderby").empty().html(option);
                    if (orderby == null) {
                        orderby = "self";
                    }

                    if (stastic == null) {
                        stastic = "1";
                    }

                    $("#jfgrid-pivotTable-config-option-order").val(order).data("index", cindex);
                    $("#jfgrid-pivotTable-config-option-orderby").val(orderby).data("index", cindex);
                    $("#jfgrid-pivotTable-config-option-stastic").val(stastic).data("index", cindex);

                    mouseclickposition($("#jfgrid-pivotTable-config-option"), toffset.left + $item.outerWidth(), toffset.top - 13, "rightbottom");
                    e.stopPropagation();
                    return false;
                });

                $("#jfgrid-pivotTable-config-option-order,#jfgrid-pivotTable-config-option-orderby,#jfgrid-pivotTable-config-option-stastic").change(function () {
                    var $t = $(this), cindex = $t.data("index");
                    $("#jfgrid-modal-dialog-config-row, #jfgrid-modal-dialog-config-column").find(".jfgrid-modal-dialog-slider-config-item").each(function () {
                        if ($(this).data("index") == cindex) {
                            $(this).data($t.attr("id").replace("jfgrid-pivotTable-config-option-", ""), $t.val());
                        }
                    });
                    jfgrid.pivotTable.refreshPivotTable();
                });

                $("#jfgrid-modal-dialog-config-value").on("click", ".jfgrid-modal-dialog-slider-config-item-icon", function (e) {
                    var $t = $(e.target), $item = $t.closest(".jfgrid-modal-dialog-slider-config-item"), cindex = $item.data("index"), toffset = $item.offset(), sumtype = $item.data("sumtype");
                    var type = jfgrid.pivotTable.pivot_data_type[cindex.toString()];
                    if (sumtype == null) {
                        if (type == "num") {
                            sumtype = "SUM";
                        }
                        else {
                            sumtype = "COUNTA";
                        }
                    }

                    var $menu = $("#jfgrid-pivotTable-config-option-sumtype");
                    $menu.find(".jfgrid-submenu-arrow").hide();
                    $menu.find(".jfgrid-cols-menuitem[sumtype='" + sumtype + "'] .jfgrid-submenu-arrow").css("display", "inline");
                    $menu.data("item", $item);

                    mouseclickposition($menu, toffset.left + $item.outerWidth(), toffset.top - 13, "rightbottom");
                    e.stopPropagation();
                    return false;
                });

                $("#jfgrid-pivotTable-config-option-sumtype .jfgrid-cols-menuitem").click(function () {
                    var $item = $("#jfgrid-pivotTable-config-option-sumtype").data("item");
                    var sumtype = $(this).attr("sumtype");
                    $item.data("sumtype", $(this).attr("sumtype"));
                    var name = jfgrid.pivotTable.getSumTypeName(sumtype) + ":" + $item.data("name");
                    $item.attr("title", name).find(".jfgrid-modal-dialog-slider-config-item-txt").html(name);
                    $("#jfgrid-pivotTable-config-option-sumtype").hide();
                    jfgrid.pivotTable.refreshPivotTable();
                });

                $("#jfgrid-modal-dialog-config-filter").on("click", ".jfgrid-modal-dialog-slider-config-item-icon", function (e) {
                    var $t = $(e.target), cindex = $t.closest(".jfgrid-modal-dialog-slider-config-item").data("index");
                    //console.log($("#jfgrid-modal-dialog-pivotTable-list .jfgrid-modal-dialog-slider-list-item").eq(cindex).find(".jfgrid-slider-list-item-filter"));
                    jfgrid.pivotTable.jfgridsliderlistitemfilter($("#jfgrid-modal-dialog-pivotTable-list .jfgrid-modal-dialog-slider-list-item").eq(cindex).find(".jfgrid-slider-list-item-filter"));
                    e.stopPropagation();
                    return false;
                });

                //确认按钮
                $("#jfgrid-pivotTableFilter-confirm").click(function () {
                    var $menu = $("#jfgrid-pivotTableFilter-menu");
                    var cindex = $menu.data("index");

                    var rowhiddenother = {}; //其它筛选列的隐藏行
                    $("#jfgrid-modal-dialog-pivotTable-list .jfgrid-modal-dialog-slider-list-item").each(function () {
                        var $t = $(this), rh = $t.data("rowhidden");

                        if($t.data("index") != cindex){
                            if (rh == null || rh == "") {
                                return true;
                            }

                            if(jfgrid.getObjType(rh) == "string"){
                                rh = JSON.parse(rh);
                            }
                            
                            for (var r in rh) {
                                rowhiddenother[r] = 0;
                            }
                        }
                    });

                    var d = jfgrid.pivotTable.origindata;

                    var filterdata = {};
                    var rowhidden = {};
                    var caljs = {};

                    if ($("#jfgrid-pivotTableFilter-bycondition").next().is(":visible") && $("#jfgrid-pivotTableFilter-byvalue").next().is(":hidden") && $("#jfgrid-pivotTableFilter-selected span").data("value") != "null") {
                        var $t = $("#jfgrid-pivotTableFilter-selected span");
                        var type = $t.data("type"), value = $t.data("value");

                        caljs["value"] = value;
                        caljs["text"] = $t.text();

                        if (type == "0") {
                            caljs["type"] = "0";
                        }
                        else if (type == "2") {
                            var $input = $("#jfgrid-pivotTableFilter-menu .jfgrid-pivotTableFilter-selected-input2 input");
                            caljs["type"] = "2";
                            caljs["value1"] = $input.eq(0).val();
                            caljs["value2"] = $input.eq(1).val();
                        }
                        else {
                            caljs["type"] = "1";
                            caljs["value1"] = $("#jfgrid-pivotTableFilter-menu .jfgrid-pivotTableFilter-selected-input").eq(0).find("input").val();
                        }

                        for (var r = 1; r < d.length; r++) {
                            if(r in rowhiddenother){
                                continue;
                            }

                            if(d[r] == null){
                                continue;
                            }

                            var cell = d[r][cindex];
                            
                            if (value == "cellnull") { //单元格为空
                                if(cell != null && !jfgrid.func_methods.isRealNull(cell.v)){
                                    rowhidden[r] = 0;
                                }
                            }
                            else if (value == "cellnonull") { //单元格有数据
                                if(cell == null || jfgrid.func_methods.isRealNull(cell.v)){
                                    rowhidden[r] = 0;
                                }
                            }
                            else if (value == "textinclude") { //文本包含 
                                var value1 = caljs["value1"];

                                if(cell == null || jfgrid.func_methods.isRealNull(cell.v)){
                                    rowhidden[r] = 0;
                                }
                                else{
                                    if(cell.m.indexOf(value1) == -1){
                                        rowhidden[r] = 0;
                                    }
                                }
                            }
                            else if (value == "textnotinclude") { //文本不包含
                                var value1 = caljs["value1"];

                                if(cell == null || jfgrid.func_methods.isRealNull(cell.v)){

                                }
                                else{
                                    if(cell.m.indexOf(value1) > -1){
                                        rowhidden[r] = 0;
                                    }
                                }
                            }
                            else if (value == "textstart") { //文本开头为
                                var value1 = caljs["value1"], valuelen = value1.length;

                                if(cell == null || jfgrid.func_methods.isRealNull(cell.v)){
                                    rowhidden[r] = 0;
                                }
                                else{
                                    if(cell.m.substr(0, valuelen) != value1){
                                        rowhidden[r] = 0;
                                    }
                                }
                            }
                            else if (value == "textend") { //文本结尾为
                                var value1 = caljs["value1"], valuelen = value1.length;

                                if(cell == null || jfgrid.func_methods.isRealNull(cell.v)){
                                    rowhidden[r] = 0;
                                }
                                else{
                                    if(valuelen > cell.m.length || cell.m.substr(cell.m.length - valuelen, valuelen) != value1){
                                        rowhidden[r] = 0;
                                    }
                                }
                            }
                            else if (value == "textequal") { //文本等于
                                var value1 = caljs["value1"];

                                if(cell == null || jfgrid.func_methods.isRealNull(cell.v)){
                                    rowhidden[r] = 0;
                                }
                                else{
                                    if(cell.m != value1){
                                        rowhidden[r] = 0;
                                    }
                                }
                            }
                            else if (value == "dateequal") { //日期等于
                                var value1 = jfgrid.mask.genarate(caljs["value1"])[2];

                                if(cell == null || jfgrid.func_methods.isRealNull(cell.v)){
                                    rowhidden[r] = 0;
                                }
                                else if(cell.ct != null && cell.ct.t == "d"){
                                    if(parseInt(cell.v) != value1){
                                        rowhidden[r] = 0;
                                    }
                                }
                                else{
                                    rowhidden[r] = 0;
                                }
                            }
                            else if (value == "datelessthan") { //日期早于
                                var value1 = jfgrid.mask.genarate(caljs["value1"])[2];

                                if(cell == null || jfgrid.func_methods.isRealNull(cell.v)){
                                    rowhidden[r] = 0;
                                }
                                else if(cell.ct != null && cell.ct.t == "d"){
                                    if(parseInt(cell.v) >= value1){
                                        rowhidden[r] = 0;
                                    }
                                }
                                else{
                                    rowhidden[r] = 0;
                                }
                            }
                            else if (value == "datemorethan") { //日期晚于
                                var value1 = jfgrid.mask.genarate(caljs["value1"])[2];

                                if(cell == null || jfgrid.func_methods.isRealNull(cell.v)){
                                    rowhidden[r] = 0;
                                }
                                else if(cell.ct != null && cell.ct.t == "d"){
                                    if(parseInt(cell.v) <= value1){
                                        rowhidden[r] = 0;
                                    }
                                }
                                else{
                                    rowhidden[r] = 0;
                                }
                            }
                            else if (value == "morethan") { //大于
                                var value1 = parseFloat(caljs["value1"]);

                                if(cell == null || jfgrid.func_methods.isRealNull(cell.v)){
                                    rowhidden[r] = 0;
                                }
                                else if(cell.ct != null && cell.ct.t == "n"){
                                    if(cell.v <= value1){
                                        rowhidden[r] = 0;
                                    }
                                }
                                else{
                                    rowhidden[r] = 0;
                                }
                            }
                            else if (value == "moreequalthan") { //大于等于
                                var value1 = parseFloat(caljs["value1"]);

                                if(cell == null || jfgrid.func_methods.isRealNull(cell.v)){
                                    rowhidden[r] = 0;
                                }
                                else if(cell.ct != null && cell.ct.t == "n"){
                                    if(cell.v < value1){
                                        rowhidden[r] = 0;
                                    }
                                }
                                else{
                                    rowhidden[r] = 0;
                                }
                            }
                            else if (value == "lessthan") { //小于
                                var value1 = parseFloat(caljs["value1"]);

                                if(cell == null || jfgrid.func_methods.isRealNull(cell.v)){
                                    rowhidden[r] = 0;
                                }
                                else if(cell.ct != null && cell.ct.t == "n"){
                                    if(cell.v >= value1){
                                        rowhidden[r] = 0;
                                    }
                                }
                                else{
                                    rowhidden[r] = 0;
                                }
                            }
                            else if (value == "lessequalthan") { //小于等于
                                var value1 = parseFloat(caljs["value1"]);

                                if(cell == null || jfgrid.func_methods.isRealNull(cell.v)){
                                    rowhidden[r] = 0;
                                }
                                else if(cell.ct != null && cell.ct.t == "n"){
                                    if(cell.v > value1){
                                        rowhidden[r] = 0;
                                    }
                                }
                                else{
                                    rowhidden[r] = 0;
                                }
                            }
                            else if (value == "equal") { //等于
                                var value1 = parseFloat(caljs["value1"]);

                                if(cell == null || jfgrid.func_methods.isRealNull(cell.v)){
                                    rowhidden[r] = 0;
                                }
                                else if(cell.ct != null && cell.ct.t == "n"){
                                    if(cell.v != value1){
                                        rowhidden[r] = 0;
                                    }
                                }
                                else{
                                    rowhidden[r] = 0;
                                }
                            }
                            else if (value == "noequal") { //不等于
                                var value1 = parseFloat(caljs["value1"]);

                                if(cell == null || jfgrid.func_methods.isRealNull(cell.v)){
                                    rowhidden[r] = 0;
                                }
                                else if(cell.ct != null && cell.ct.t == "n"){
                                    if(cell.v == value1){
                                        rowhidden[r] = 0;
                                    }
                                }
                                else{
                                    rowhidden[r] = 0;
                                }
                            }
                            else if (value == "include") { //介于
                                var value1 = parseFloat(caljs["value1"]), value2 = parseFloat(caljs["value2"]);

                                if(value1 < value2){
                                    var min = value1;
                                    var max = value2;
                                }
                                else{
                                    var max = value1;
                                    var min = value2;   
                                }

                                if(cell == null || jfgrid.func_methods.isRealNull(cell.v)){
                                    rowhidden[r] = 0;
                                }
                                else if(cell.ct != null && cell.ct.t == "n"){
                                    if(cell.v < min || cell.v > max){
                                        rowhidden[r] = 0;
                                    }
                                }
                                else{
                                    rowhidden[r] = 0;
                                }
                            }
                            else if (value == "noinclude") { //不在其中
                                var value1 = parseFloat(caljs["value1"]), value2 = parseFloat(caljs["value2"]);

                                if(value1 < value2){
                                    var min = value1;
                                    var max = value2;
                                }
                                else{
                                    var max = value1;
                                    var min = value2;   
                                }

                                if(cell == null || jfgrid.func_methods.isRealNull(cell.v)){
                                    rowhidden[r] = 0;
                                }
                                else if(cell.ct != null && cell.ct.t == "n"){
                                    if(cell.v >= min && cell.v <= max){
                                        rowhidden[r] = 0;
                                    }
                                }
                                else{
                                    rowhidden[r] = 0;
                                }
                            }
                        }
                    }
                    else {
                        $("#jfgrid-pivotTableFilter-byvalue-select .ListBox input[type='checkbox']").each(function(i, e){
                            if($(e).is(":visible") && $(e).is(":checked")){
                                return true;
                            }

                            if($(e).closest(".day").length > 0){
                                var day = $(e).siblings("label").text();
                                if(Number(day) < 10){
                                    day = "0" + day;
                                }

                                var month = $(e).closest(".monthBox").find(".month label").text().replace("月", "");
                                if(Number(month) < 10){
                                    month = "0" + month;
                                }

                                var year = $(e).closest(".yearBox").find(".year label").text().replace("年", "");

                                var itemV = "日期格式#$$$#" + year + "-" + month + "-" + day;

                                filterdata[itemV] = "1";
                            }

                            if($(e).closest(".textBox").length > 0){
                                var itemV = $(e).closest(".textBox").data("filter");

                                filterdata[itemV] = "1";
                            }
                        })

                        for (var r = 1; r < d.length; r++) {
                            if(r in rowhiddenother){
                                continue;
                            }

                            if(d[r] == null){
                                continue;
                            }

                            var cell = d[r][cindex];

                            if(cell == null || jfgrid.func_methods.isRealNull(cell.v)){
                                var value = "null#$$$#null";
                            }
                            else if(cell.ct != null && cell.ct.t == "d"){
                                var fmt = jfgrid.mask.update("YYYY-MM-DD", cell.v);
                                var value = "日期格式#$$$#" + fmt;
                            }
                            else{
                                var value = cell.v + "#$$$#" + cell.m;
                            }

                            if(value in filterdata){
                                rowhidden[r] = 0;
                            }
                        }
                    }

                    var $top = $("#jfgrid-modal-dialog-pivotTable-list .jfgrid-modal-dialog-slider-list-item").eq(cindex);
                    if ($("#jfgrid-pivotTableFilter-byvalue-select .ListBox input[type='checkbox']:visible:checked").length < $("#jfgrid-pivotTableFilter-byvalue-select .ListBox input[type='checkbox']:visible").length || $("#jfgrid-pivotTableFilter-byvalue-input").val().length > 0 || ($("#jfgrid-pivotTableFilter-bycondition").next().is(":visible") && $("#jfgrid-pivotTableFilter-byvalue").next().is(":hidden") && $("#jfgrid-pivotTableFilter-selected span").data("value") != "null")) {
                        $top.data("rowhidden", JSON.stringify(rowhidden)).find(".jfgrid-slider-list-item-filtered").show();
                        jfgrid.pivotTable.setDatatojsfile("rowhidden", rowhidden, cindex);

                        if (caljs != null) {
                            $top.data("byconditionvalue", caljs["value"]).data("byconditiontype", caljs["type"]).data("byconditiontext", caljs["text"]);
                            
                            if (caljs["value1"] != null) {
                                $top.data("byconditionvalue1", caljs["value1"]);
                            }

                            if (caljs["value2"] != null) {
                                $top.data("byconditionvalue2", caljs["value2"]);
                            }

                            jfgrid.pivotTable.setDatatojsfile("caljs", caljs, cindex);
                        }
                    }
                    else {
                        $top.data("rowhidden", "").find(".jfgrid-slider-list-item-filtered").hide();
                        jfgrid.pivotTable.setDatatojsfile("rowhidden", null, cindex);
                    }

                    var newdata = [];
                    for (var i = 0; i < d.length; i++) {
                        if(i in rowhidden || i in rowhiddenother){
                            continue;
                        }

                        newdata.push([].concat(d[i]));
                    }

                    jfgrid.pivotTable.celldata = newdata;
                    jfgrid.pivotTable.refreshPivotTable();
                    $("#jfgrid-pivotTableFilter-menu, #jfgrid-pivotTableFilter-submenu").hide();

                    jfgrid.cleargridelement();
                });

                $("#jfgrid-data-pivotTable-selection .jfgrid-model-close-btn, #jfgrid-data-pivotTable-selection .jfgrid-modal-dialog-title-close").click(function () {
                    $("#jfgrid-modal-dialog-slider-pivot").show();
                    jfgrid.jfgridsizeauto();
                    $("#jfgrid-cell-main .jfgrid-pivotTable-selection-set div").show();

                    $("#jfgrid-data-pivotTable-selection").hide();

                    jfgrid.sheetmanage.changeSheetExec(jfgrid.pivotTable.pivotSheetIndex);

                    jfgrid.pivotTable.jfgrid_pivotTable_select_state = false;

                    jfgrid.cleargridelement();
                });

                $("#jfgrid-pivotTable-selection-confirm").click(function () {
                    var $input = $("#jfgrid-pivotTable-range-selection-input"), val = $input.val();

                    if ($.trim(val).length == 0 || $.trim(val).toUpperCase() == jfgrid.pivotTable.jgridCurrentPivotInput.toUpperCase()) {
                        $input.val(jfgrid.pivotTable.jgridCurrentPivotInput);
                        $("#jfgrid-data-pivotTable-selection .jfgrid-model-close-btn").click();
                        return;
                    }
                    else {
                        var val1 = val.split("!");
                        var sheettxt = "", rangetxt = "", sheetIndex = -1;

                        if (val1.length > 1) {
                            sheettxt = val1[0];
                            rangetxt = val1[1];
                            for (var i in jfgridfile) {
                                if (sheettxt == jfgridfile[i].name) {
                                    sheetIndex = jfgridfile[i].index;
                                    break;
                                }
                            }

                            if (sheetIndex == -1) {
                                sheetIndex = 0;
                            }
                        }
                        else {
                            var index = jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex);
                            sheettxt = jfgridfile[index].name;
                            sheetIndex = jfgridfile[index].index;
                            rangetxt = val1[0];
                        }

                        if(jfgridfile[jfgrid.sheetmanage.getSheetIndex(sheetIndex)].isPivotTable){
                            if(jfgrid.isEditMode()){
                                alert("不可选择数据透视表为源数据！");
                            }
                            else{
                                jfgrid.tooltip.info("选择失败", "不可选择数据透视表为源数据！");    
                            }
                            $input.val(jfgrid.pivotTable.jgridCurrentPivotInput);
                            return;
                        }

                        if (rangetxt.indexOf(":") == -1) {
                            if(jfgrid.isEditMode()){
                                alert("选择失败, 输入范围错误！");
                            }
                            else{
                                jfgrid.tooltip.info("选择失败", "输入范围错误！");    
                            }
                            $input.val(jfgrid.pivotTable.jgridCurrentPivotInput);
                            return;
                        }

                        rangetxt = rangetxt.split(":");
                        var row = [], col = [];
                        
                        row[0] = parseInt(rangetxt[0].replace(/[^0-9]/g, "")) - 1;
                        row[1] = parseInt(rangetxt[1].replace(/[^0-9]/g, "")) - 1;

                        if (row[0] > row[1]) {
                            if(jfgrid.isEditMode()){
                                alert("选择失败, 输入范围错误！");
                            }
                            else{
                                jfgrid.tooltip.info("选择失败", "输入范围错误！");    
                            }
                            $input.val(jfgrid.pivotTable.jgridCurrentPivotInput);
                            return;
                        }

                        col[0] = jfgrid.jfgridABCatNum(rangetxt[0].replace(/[^A-Za-z]/g, ""));
                        col[1] = jfgrid.jfgridABCatNum(rangetxt[1].replace(/[^A-Za-z]/g, ""));

                        if (col[0] > col[1]) {
                            if(jfgrid.isEditMode()){
                                alert("选择失败, 输入范围错误！");
                            }
                            else{
                                jfgrid.tooltip.info("选择失败", "输入范围错误！");    
                            }
                            $input.val(jfgrid.pivotTable.jgridCurrentPivotInput);
                            return;
                        }
                        jfgrid.sheetmanage.changeSheetExec(jfgrid.pivotTable.pivotSheetIndex);

                        jfgrid.pivotTable.setDatatojsfile("pivot_select_save", { "row": row, "column": col });
                        jfgrid.pivotTable.setDatatojsfile("pivotDataSheetIndex", sheetIndex);

                        jfgrid.pivotTable.getCellData(jfgrid.pivotTable.pivotSheetIndex, sheetIndex, { "row": row, "column": col });

                        jfgrid.pivotTable.initialPivotManage();

                        $("#jfgrid-dialog-pivotTable-range").html(val);

                        $("#jfgrid-modal-dialog-slider-pivot").show();

                        $("#jfgrid-data-pivotTable-selection").hide();

                        jfgrid.pivotTable.jfgrid_pivotTable_select_state = false;

                        jfgrid.pivotTable.refreshPivotTable();

                        jfgrid.jfgridsizeauto();

                        jfgrid.cleargridelement();
                    }
                });

                $("#jfgrid-modal-dialog-slider-pivot").on("mousedown", ".jfgrid-slider-list-item-name, .jfgrid-modal-dialog-slider-config-item-txt", function (e) {
                    //console.log("1111111111111111111111111111");
                    var $cur = $(e.target);
                    jfgrid.pivotTable.movestate = true;
                    jfgrid.pivotTable.movesave.obj = $cur.parent();
                    jfgrid.pivotTable.movesave.name = $cur.data("name");
                    jfgrid.pivotTable.movesave.containerid = $cur.parent().parent().attr("id");
                    jfgrid.pivotTable.movesave.index = $cur.data("index");
                    if ($("#jfgrid-modal-dialog-slider-pivot-move").length == 0) {
                        $("body").append('<div id="jfgrid-modal-dialog-slider-pivot-move">' + jfgrid.pivotTable.movesave.name + '</div>');
                    }
                    jfgrid.pivotTable.movesave.width = $("#jfgrid-modal-dialog-slider-pivot-move").outerWidth();
                    jfgrid.pivotTable.movesave.height = $("#jfgrid-modal-dialog-slider-pivot-move").outerHeight();

                    $("#jfgrid-modal-dialog-pivotTable-list, #jfgrid-modal-dialog-config-filter, #jfgrid-modal-dialog-config-row, #jfgrid-modal-dialog-config-column, #jfgrid-modal-dialog-config-value").css("cursor", "default");
                });


                $("#jfgrid-modal-dialog-config-filter, #jfgrid-modal-dialog-config-row, #jfgrid-modal-dialog-config-column, #jfgrid-modal-dialog-config-value").mousemove(function (e) {
                    if (!!jfgrid.pivotTable && jfgrid.pivotTable.movestate) {
                        if (jfgrid.pivotTable.moveitemposition.length == 0) {
                            jfgrid.pivotTable.moveitemposition = [0];
                            $(this).find(".jfgrid-modal-dialog-slider-config-item").each(function (i) {
                                var $t = $(this), h = $t.outerHeight();
                                jfgrid.pivotTable.moveitemposition.push(jfgrid.pivotTable.moveitemposition[i] + h + 2);
                            });
                            //jfgrid.pivotTable.moveitemposition.push($(this).outerHeight());
                            $(this).append('<div id="jfgrid-modal-dialog-config-order-help" style="position:absolute;height:3px;width:100%;background:#007ACC;z-index:1;pointer-events: none;user-select:none;"></div>');
                            //console.log(jfgrid.pivotTable.moveitemposition);
                        }

                        $("#jfgrid-modal-dialog-slider-pivot-move").css({ "background": "#FD8585", "color": "#fff", "border": "1px solid #FD7070" });
                        var x = event.pageX, y = event.pageY, $container = $(this);
                        var curtop = y - $container.offset().top + $container.scrollTop();
                        var position = jfgrid.pivotTable.moveitemposition;
                        var row_index = jfgrid_searcharray(position, curtop);

                        if (row_index == -1) {
                            $("#jfgrid-modal-dialog-config-order-help").css({ "top": position[position.length - 1] });
                        }
                        else if ((curtop - position[row_index - 1]) > (position[row_index] - position[row_index - 1]) / 2) {
                            $("#jfgrid-modal-dialog-config-order-help").css({ "top": position[row_index] });
                        }
                        else {
                            $("#jfgrid-modal-dialog-config-order-help").css({ "top": position[row_index - 1] });
                        }
                    }
                }).mouseleave(function () {
                    if (!!jfgrid.pivotTable && jfgrid.pivotTable.movestate) {
                        $("#jfgrid-modal-dialog-slider-pivot-move").css({ "background": "#fff", "color": "#000", "border": "1px dotted #000" });
                        jfgrid.pivotTable.moveitemposition = [];
                        console.log("leave");
                        $("#jfgrid-modal-dialog-config-order-help").remove();
                    }
                }).mouseup(function (e) {
                    if (!!jfgrid.pivotTable && jfgrid.pivotTable.movestate) {
                        var $t = $(this);
                        var itemHTML;
                        if (jfgrid.pivotTable.movesave.containerid == $t.attr("id")) {
                            itemHTML = jfgrid.pivotTable.movesave.obj.clone();
                        }
                        else {
                            var name = jfgrid.pivotTable.movesave.name, sumtype = "", nameindex = "";
                            if ($t.attr("id") == "jfgrid-modal-dialog-config-value") {
                                var type = jfgrid.pivotTable.pivot_data_type[jfgrid.pivotTable.movesave.index.toString()];
                                if (type == "num") {
                                    name = "求和:" + name;
                                    sumtype = "data-sumtype='SUM'";
                                    nameindex = "data-nameindex='0'";
                                }
                                else {
                                    name = "计数:" + name;
                                    sumtype = "data-sumtype='COUNTA'";
                                    nameindex = "data-nameindex='0'";
                                }

                                $("#jfgrid-modal-dialog-config-value").find(".jfgrid-modal-dialog-slider-config-item").each(function () {
                                    if ($(this).find(".jfgrid-modal-dialog-slider-config-item-txt").text() == name) {
                                        var ni = parseFloat($(this).data("nameindex")) + 1;
                                        console.log($(this).data("nameindex"));
                                        name = name + ni.toString();
                                        $(this).data("nameindex", ni);
                                        return false;
                                    }
                                });
                            }
                            itemHTML = '<div title="' + name + '" class="jfgrid-modal-dialog-slider-config-item" ' + nameindex + ' ' + sumtype + ' data-index="' + jfgrid.pivotTable.movesave.index + '" data-name="' + jfgrid.pivotTable.movesave.name + '"><div class="jfgrid-modal-dialog-slider-config-item-txt" ' + nameindex + ' ' + sumtype + ' data-index="' + jfgrid.pivotTable.movesave.index + '" data-name="' + jfgrid.pivotTable.movesave.name + '">' + name + '</div><div class="jfgrid-modal-dialog-slider-config-item-icon"><i class="fa fa-sort-desc" aria-hidden="true"></i></div></div>';
                        }
                        var x = event.pageX, y = event.pageY, $container = $(this);
                        var curtop = y - $container.offset().top + $container.scrollTop();
                        var position = jfgrid.pivotTable.moveitemposition;
                        var row_index = jfgrid_searcharray(position, curtop);
                        //console.log(position, curtop, row_index);

                        if ((jfgrid.pivotTable.movesave.containerid == "jfgrid-modal-dialog-pivotTable-list") || (jfgrid.pivotTable.movesave.containerid == "jfgrid-modal-dialog-config-value" && jfgrid.pivotTable.movesave.containerid != $t.attr("id"))) {
                            $("#jfgrid-modal-dialog-config-filter, #jfgrid-modal-dialog-config-row, #jfgrid-modal-dialog-config-column").find(".jfgrid-modal-dialog-slider-config-item").each(function () {
                                if ($(this).data("index") == jfgrid.pivotTable.movesave.index) {
                                    $(this).remove();
                                }
                            });
                        }

                        if (row_index == -1) {
                            //$("#jfgrid-modal-dialog-config-order-help").css({ "top": position[position.length - 1] });
                            if ($t.find(".jfgrid-modal-dialog-slider-config-item").length == 0) {
                                $t.append(itemHTML);
                            }
                            else {
                                $t.find(".jfgrid-modal-dialog-slider-config-item").last().after(itemHTML);
                            }

                        }
                        else if ((curtop - position[row_index - 1]) > (position[row_index] - position[row_index - 1]) / 2) {
                            //$("#jfgrid-modal-dialog-config-order-help").css({ "top": position[row_index] });
                            $t.find(".jfgrid-modal-dialog-slider-config-item").eq(row_index - 1).after(itemHTML);
                        }
                        else {
                            //$("#jfgrid-modal-dialog-config-order-help").css({ "top": position[row_index - 1] });
                            $t.find(".jfgrid-modal-dialog-slider-config-item").eq(row_index - 1).before(itemHTML);
                        }


                        if (jfgrid.pivotTable.movesave.containerid == "jfgrid-modal-dialog-pivotTable-list") {

                        }
                        else if (jfgrid.pivotTable.movesave.containerid == "jfgrid-modal-dialog-config-value" && jfgrid.pivotTable.movesave.containerid != $t.attr("id")) {

                        }
                        else {
                            jfgrid.pivotTable.movesave.obj.remove();
                        }


                        $("#jfgrid-modal-dialog-pivotTable-list").find(".jfgrid-modal-dialog-slider-list-item").each(function () {
                            var $seleted = $(this).find(".jfgrid-slider-list-item-selected");
                            if ($(this).data("index") == jfgrid.pivotTable.movesave.index && $seleted.find("i").length == 0) {
                                $seleted.append('<i class="fa fa-check jfgrid-mousedown-cancel"></i>');
                            }
                        });

                        jfgrid.pivotTable.refreshPivotTable();

                        $("#jfgrid-modal-dialog-slider-pivot-move").remove();
                        jfgrid.pivotTable.movestate = false;
                        $("#jfgrid-modal-dialog-pivotTable-list, #jfgrid-modal-dialog-config-filter, #jfgrid-modal-dialog-config-row, #jfgrid-modal-dialog-config-column, #jfgrid-modal-dialog-config-value").css("cursor", "default");
                        jfgrid.pivotTable.moveitemposition = [];
                        $("#jfgrid-modal-dialog-config-order-help").remove();
                        jfgrid.pivotTable.showvaluecolrow();
                        e.stopPropagation();
                    }
                });


                $("#jfgrid-modal-dialog-pivotTable-list").on("click", ".jfgrid-slider-list-item-selected", function () {
                    var $t = $(this), $item = $t.parent(), index = $item.data("index"), name = $item.data("name");
                    if ($t.find("i").length == 0) {
                        $t.append('<i class="fa fa-check jfgrid-mousedown-cancel"></i>');

                        var type = jfgrid.pivotTable.pivot_data_type[index.toString()], itemHTML;
                        if (type == "num") {
                            itemHTML = '<div title="' + name + '" class="jfgrid-modal-dialog-slider-config-item" data-nameindex="0" data-sumtype="SUM" data-index="' + index + '" data-name="' + name + '"><div class="jfgrid-modal-dialog-slider-config-item-txt" data-nameindex="0" data-sumtype="SUM" data-index="' + index + '" data-name="' + name + '">求和:' + name + '</div><div class="jfgrid-modal-dialog-slider-config-item-icon"><i class="fa fa-sort-desc" aria-hidden="true"></i></div></div>';
                            $("#jfgrid-modal-dialog-config-value").append(itemHTML);
                        }
                        else {
                            itemHTML = '<div title="' + name + '" class="jfgrid-modal-dialog-slider-config-item" data-index="' + index + '" data-name="' + name + '"><div class="jfgrid-modal-dialog-slider-config-item-txt" data-index="' + index + '" data-name="' + name + '">' + name + '</div><div class="jfgrid-modal-dialog-slider-config-item-icon"><i class="fa fa-sort-desc" aria-hidden="true"></i></div></div>';
                            var $column = $("#jfgrid-modal-dialog-config-column"), $row = $("#jfgrid-modal-dialog-config-row");
                            var columnitem = $column.find(".jfgrid-modal-dialog-slider-config-item"), rowitem = $row.find(".jfgrid-modal-dialog-slider-config-item");
                            if (columnitem.length < 2) {
                                $column.append(itemHTML);
                            }
                            else if (rowitem.length < 2) {
                                $row.append(itemHTML);
                            }
                            else {
                                $column.append(itemHTML);
                            }
                        }
                    }
                    else {
                        $t.find("i").remove();
                        $("#jfgrid-modal-dialog-config-filter, #jfgrid-modal-dialog-config-row, #jfgrid-modal-dialog-config-column, #jfgrid-modal-dialog-config-value").find(".jfgrid-modal-dialog-slider-config-item").each(function () {
                            if ($(this).data("index") == index) {
                                if ($(this).parent().attr("id") == "jfgrid-modal-dialog-config-value") {
                                    jfgrid.pivotTable.resetOrderby($(this));
                                }
                                $(this).remove();
                            }
                        });
                    }

                    jfgrid.pivotTable.refreshPivotTable();
                    jfgrid.pivotTable.showvaluecolrow();
                });

                $("#jfgrid-dialog-pivotTable-clearitem").click(function () {
                    $("#jfgrid-modal-dialog-config-filter, #jfgrid-modal-dialog-config-row, #jfgrid-modal-dialog-config-column, #jfgrid-modal-dialog-config-value").find(".jfgrid-modal-dialog-slider-config-item").each(function () {
                        $(this).remove();
                    });

                    $("#jfgrid-modal-dialog-pivotTable-list").find(".jfgrid-modal-dialog-slider-list-item").each(function () {
                        $(this).find(".jfgrid-slider-list-item-selected").find("i").remove();
                    });
                    jfgrid.pivotTable.refreshPivotTable();
                    jfgrid.pivotTable.showvaluecolrow();
                });

            }

            if (restore == null) {
                restore = false;
            }

            if (this.celldata.length <= 1 && this.celldata[0].length <= 1) {
                if(jfgrid.isEditMode()){
                    alert("请扩大选择的数据范围!");
                }
                else{
                    jfgrid.tooltip.info("提示", "请扩大选择的数据范围!");
                }
            }

            var selecteditem = "", selecteditemIndex = 1, selecteditemtest = {}, selecteditemNullIndex = 1;
            for (var i = 0; i < this.celldata[0].length; i++) {
                if(!!this.celldata[0][i] && !!this.celldata[0][i]["m"]){
                    // var name = this.celldata[0][i]["m"].toString();
                    var name = this.celldata[0][i]["m"];
                }
                else{
                    // var name = jfgrid.getcellvalue(0, i, this.celldata).toString();    
                    var name = jfgrid.getcellvalue(0, i, this.celldata);    
                }

                if(name != null){
                    name = name.toString();
                }

                if (name == null || $.trim(name.toString()).length == 0) {
                    name = "列 " + selecteditemNullIndex;
                }
                selecteditemNullIndex++

                if (name in selecteditemtest) {
                    name = name + selecteditemIndex++;
                    if (name in selecteditemtest) {
                        name = name + selecteditemIndex++;
                        if (name in selecteditemtest) {
                            name = name + selecteditemIndex++;
                        }
                    }
                }
                selecteditemtest[name] = 1;

                var dataother = "", style = "";
                //console.log(restore);
                if (restore && this.filterparm != null) {
                    if (this.filterparm[i.toString()] != null) {
                        var itemset = this.filterparm[i.toString()];
                        if (itemset.rowhidden != null) {
                            dataother += "data-rowhidden='" + JSON.stringify(itemset.rowhidden) + "'";
                        }

                        if (itemset.selected != null) {
                            dataother += "data-selected='" + JSON.stringify(itemset.selected) + "'";
                        }

                        if (itemset.caljs != null) {
                            var caljsset = itemset.caljs;
                            if (caljsset.value != null) {
                                dataother += "data-byconditionvalue='" + caljsset.value + "'";
                            }

                            if (caljsset.type != null) {
                                dataother += "data-byconditiontype='" + caljsset.type + "'";
                            }

                            if (caljsset.text != null) {
                                dataother += "data-byconditiontext='" + caljsset.text + "'";
                            }

                            if (caljsset.value1 != null) {
                                dataother += "data-byconditionvalue1='" + caljsset.value1 + "'";
                            }

                            if (caljsset.value2 != null) {
                                dataother += "data-byconditionvalue2='" + caljsset.value2 + "'";
                            }

                        }
                    }
                }

                if (dataother.length > 0) {
                    style = "display:block;";
                }

                selecteditem += '<div class="jfgrid-modal-dialog-slider-list-item" ' + dataother + ' data-index="' + i + '" data-name="' + name + '"><div title="添加列到数据透视表" class="jfgrid-slider-list-item-selected"><div></div></div><div title="移动该列到下方白框" class="jfgrid-slider-list-item-name" ' + dataother + ' data-index="' + i + '" data-name="' + name + '">' + name + '</div><div title="清除该列的筛选条件" class="jfgrid-slider-list-item-filtered" style="' + style + '"><i class="fa fa-filter jfgrid-mousedown-cancel" aria-hidden="true"></i><i class="fa fa-times" aria-hidden="true"></i></div><div title="筛选该列" class="jfgrid-slider-list-item-filter"><i class="fa fa-sort-desc" aria-hidden="true"></i></div></div>';
            }
            $("#jfgrid-modal-dialog-pivotTable-list").html(selecteditem);

            $("#jfgridpivottablevaluecolrowshow").hide();
            $("#jfgridpivottablevaluecolrow").prop("checked", true);
            $("#jfgridpivottablevaluecolrow1").prop("checked", false);

            $("#jfgrid-modal-dialog-config-filter, #jfgrid-modal-dialog-config-row, #jfgrid-modal-dialog-config-column, #jfgrid-modal-dialog-config-value").empty();
            if (restore) {
                if (this.filter != null && this.filter.length > 0) {
                    for (var i = 0; i < this.filter.length; i++) {
                        var item = this.filter[i];

                        var itemHTML = '<div title="' + name + '" class="jfgrid-modal-dialog-slider-config-item" data-index="' + item.index + '" data-name="' + item.name + '"><div class="jfgrid-modal-dialog-slider-config-item-txt" data-index="' + item.index + '" data-name="' + item.name + '">' + item.name + '</div><div class="jfgrid-modal-dialog-slider-config-item-icon"><i class="fa fa-sort-desc" aria-hidden="true"></i></div></div>';

                        $("#jfgrid-modal-dialog-config-filter").append(itemHTML);

                        var $seleted = $("#jfgrid-modal-dialog-pivotTable-list .jfgrid-modal-dialog-slider-list-item").eq(item.index).find(".jfgrid-slider-list-item-selected");
                        if ($seleted.find("i").length == 0) {
                            $seleted.append('<i class="fa fa-check jfgrid-mousedown-cancel"></i>');
                        }
                    }
                }

                if (this.row != null && this.row.length > 0) {
                    for (var i = 0; i < this.row.length; i++) {
                        var item = this.row[i];
                        var otherset = "";

                        if (item.order != null) {
                            otherset += "data-order = '" + item.order + "'";
                        }

                        if (item.orderby != null) {
                            otherset += "data-orderby = '" + item.orderby + "'";
                        }

                        if (item.order != null) {
                            otherset += "data-stastic = '" + item.stastic + "'";
                        }

                        var itemHTML = '<div title="' + name + '" class="jfgrid-modal-dialog-slider-config-item" ' + otherset + ' data-index="' + item.index + '" data-name="' + item.name + '"><div class="jfgrid-modal-dialog-slider-config-item-txt" ' + otherset + ' data-index="' + item.index + '" data-name="' + item.name + '">' + item.name + '</div><div class="jfgrid-modal-dialog-slider-config-item-icon"><i class="fa fa-sort-desc" aria-hidden="true"></i></div></div>';

                        $("#jfgrid-modal-dialog-config-row").append(itemHTML);

                        var $seleted = $("#jfgrid-modal-dialog-pivotTable-list .jfgrid-modal-dialog-slider-list-item").eq(item.index).find(".jfgrid-slider-list-item-selected");
                        if ($seleted.find("i").length == 0) {
                            $seleted.append('<i class="fa fa-check jfgrid-mousedown-cancel"></i>');
                        }
                    }
                }

                if (this.column != null && this.column.length > 0) {
                    for (var i = 0; i < this.column.length; i++) {
                        var item = this.column[i];
                        var otherset = "";

                        if (item.order != null) {
                            otherset += "data-order = '" + item.order + "'";
                        }

                        if (item.orderby != null) {
                            otherset += "data-orderby = '" + item.orderby + "'";
                        }

                        if (item.order != null) {
                            otherset += "data-stastic = '" + item.stastic + "'";
                        }

                        var itemHTML = '<div title="' + name + '" class="jfgrid-modal-dialog-slider-config-item" ' + otherset + ' data-index="' + item.index + '" data-name="' + item.name + '"><div class="jfgrid-modal-dialog-slider-config-item-txt" ' + otherset + ' data-index="' + item.index + '" data-name="' + item.name + '">' + item.name + '</div><div class="jfgrid-modal-dialog-slider-config-item-icon"><i class="fa fa-sort-desc" aria-hidden="true"></i></div></div>';

                        $("#jfgrid-modal-dialog-config-column").append(itemHTML);

                        var $seleted = $("#jfgrid-modal-dialog-pivotTable-list .jfgrid-modal-dialog-slider-list-item").eq(item.index).find(".jfgrid-slider-list-item-selected");
                        if ($seleted.find("i").length == 0) {
                            $seleted.append('<i class="fa fa-check jfgrid-mousedown-cancel"></i>');
                        }
                    }
                }

                if (this.values != null && this.values.length > 0) {
                    for (var i = 0; i < this.values.length; i++) {
                        var item = this.values[i];
                        var otherset = "";

                        if (item.sumtype != null) {
                            otherset += "data-sumtype = '" + item.sumtype + "'";
                        }

                        if (item.nameindex != null) {
                            otherset += "data-nameindex = '" + item.nameindex + "'";
                        }

                        var itemHTML = '<div title="' + name + '" class="jfgrid-modal-dialog-slider-config-item" ' + otherset + ' data-index="' + item.index + '" data-name="' + item.name + '"><div class="jfgrid-modal-dialog-slider-config-item-txt" ' + otherset + ' data-index="' + item.index + '" data-name="' + item.name + '">' + jfgrid.pivotTable.getSumTypeName(item.sumtype) + ":" + item.name + '</div><div class="jfgrid-modal-dialog-slider-config-item-icon"><i class="fa fa-sort-desc" aria-hidden="true"></i></div></div>';

                        $("#jfgrid-modal-dialog-config-value").append(itemHTML);

                        var $seleted = $("#jfgrid-modal-dialog-pivotTable-list .jfgrid-modal-dialog-slider-list-item").eq(item.index).find(".jfgrid-slider-list-item-selected");
                        if ($seleted.find("i").length == 0) {
                            $seleted.append('<i class="fa fa-check jfgrid-mousedown-cancel"></i>');
                        }
                    }

                    if (this.values.length >= 2) {
                        $("#jfgridpivottablevaluecolrowshow").show();
                        if (this.showType == "column") {
                            $("#jfgridpivottablevaluecolrow").prop("checked", true);
                            $("#jfgridpivottablevaluecolrowshow label[for='jfgridpivottablevaluecolrow']").addClass("ui-state-active");

                            $("#jfgridpivottablevaluecolrow1").prop("checked", false);
                            $("#jfgridpivottablevaluecolrowshow label[for='jfgridpivottablevaluecolrow1']").removeClass("ui-state-active");
                        }
                        else {
                            $("#jfgridpivottablevaluecolrow1").prop("checked", true);
                            $("#jfgridpivottablevaluecolrowshow label[for='jfgridpivottablevaluecolrow1']").addClass("ui-state-active");

                            $("#jfgridpivottablevaluecolrow").prop("checked", false);
                            $("#jfgridpivottablevaluecolrowshow label[for='jfgridpivottablevaluecolrow']").removeClass("ui-state-active");
                        }
                    }
                }
            }

            $("#jfgrid-dialog-pivotTable-range").html(jfgrid.sheetmanage.getRangetxt(this.pivotDataSheetIndex, this.pivot_select_save));
            $("#jfgrid-modal-dialog-slider-pivot").show();
            jfgrid.jfgridsizeauto();
        },
        //generatePivotTable:function(column1, row1, values1, filter1, showType1){

        //  this.column = column1;
        //    this.row = row1;
        //    this.values = values1;
        //    this.filter = filter1;
        //    this.showType = showType1;
        //  this.dataHandler(column1, row1, values1, filter1, showType1, this.celldata);
        //},
        getComposeArray: function (data) {
            if (data.length == 0) {
                return [];
            }
            
            var ret = [];
            for (var i = 0; i < data.length; i++) {
                //var c_value = data[i];
                var name = "";
                for (var x = 0; x <= i; x++) {
                    if(!!data[x] && !!data[x]["m"]){
                        name += data[x]["m"];
                    }
                    else{
                        name += jfgrid.getcellvalue(x, null, data);
                    }
                }
                
                ret.push(name);
            }
            return ret;
        },
        getnameArray: function (data, field) {
            if (data.length == 0) {
                return [];
            }

            if (field.length == 0) {
                return [];
            }

            var ret = [];
            for (var i = 0; i < field.length; i++) {
                if(!!data[field[i].index] && !!data[field[i].index]["m"]){
                    var c_value = data[field[i].index]["m"];
                }
                else{
                    var c_value = jfgrid.getcellvalue(field[i].index, null, data);
                }
                
                ret.push(c_value);
            }
            return ret;
        },
        getTitleFromGroup: function (group, config, dataposition) {
            var children = group.children;

            var orderbygroup = this.orderbygroup(group, config, dataposition);

            //console.log(orderbygroup);
            return this.generategrouparraymain(orderbygroup, config);
        },
        orderbygroup: function (group, config, dataposition) {
            var stackset = [];
            if (group.length == 0) {
                return [];
            }
            stackset = group;
            var d = null, alllength = stackset.length, alllengthInital = stackset.length, a = 0;
            while (alllength != 0) {
                //console.log(alllength, a);
                d = stackset[a++];

                alllength--;
                if (d.children != null && d.children.length > 0) {
                    //console.log(JSON.stringify(d.children));
                    d.children = this.orderbygroupchildren(d.children, config[d.index].orderby, config[d.index].order, dataposition);
                    //console.log(JSON.stringify(d.children));
                    for (var i = 0; i < d.children.length; i++) {
                        stackset.push(d.children[i]);
                        alllength++;
                    }
                }
                //console.log(stackset, stackset.length, stackset.length == 0);
            }

            return group.splice(0, alllengthInital);
        },
        orderbygroupchildren: function (childrens, orderby, order, dataposition) {
            if (childrens.length == 0) {
                return [];
            }

            var isAsc = false;
            if (order == null || order == "asc") {
                isAsc = true;
            }

            var a = function (x, y) {
                var f = null, s = null;
                if (orderby == "self" || orderby == null) {
                    if(x.name==null){
                        f = "(空白)";
                    }
                    else{
                        f = x.name.toString();
                    }

                    if(y.name==null){
                        s = "(空白)";
                    }
                    else{
                        s = y.name.toString();
                    }
                    
                    if (jfgrid.datecontroll.isdatetime(f) && jfgrid.datecontroll.isdatetime(s)) {
                        return jfgrid.datecontroll.diff(f, s);
                    }
                    //return f.localeCompare(s);
                }
                else {
                    f = parseFloat(dataposition[x.orderby].result);
                    s = parseFloat(dataposition[y.orderby].result);
                }

                if (!isNaN(f) && !isNaN(s)) {
                    return numeral(f).value() - numeral(s).value();
                }
                else if(isNaN(f) && isNaN(s)){
                    return f.localeCompare(s);
                }
                else if (isNaN(f)) {
                    return 1;
                }
                else if (isNaN(s)) {
                    return -1;
                }
            }

            var d = function (x, y) {
                var f = null, s = null;
                if (orderby == "self" || orderby == null) {
                    if(x.name==null){
                        f = "(空白)";
                    }
                    else{
                        f = x.name.toString();
                    }

                    if(y.name==null){
                        s = "(空白)";
                    }
                    else{
                        s = y.name.toString();
                    }

                    if (jfgrid.datecontroll.isdatetime(f) && jfgrid.datecontroll.isdatetime(s)) {
                        return jfgrid.datecontroll.diff(f, s);
                    }
                    //return s.localeCompare(f);
                }
                else {
                    f = parseFloat(dataposition[x.orderby].result);
                    s = parseFloat(dataposition[y.orderby].result);
                }

                if (!isNaN(f) && !isNaN(s)) {
                    return numeral(s).value() - numeral(f).value();
                }
                else if(isNaN(f) && isNaN(s)){
                    return s.localeCompare(f);
                }
                else if (isNaN(f)) {
                    return -1;
                }
                else if (isNaN(s)) {
                    return 1;
                }
            }

            if (isAsc) {
                return childrens.sort(a);
            }
            else {
                return childrens.sort(d);
            }
        },
        generategroupaddstatic: function (arr, name) {
            var stasticarr = [];
            for (var a = 0; a < arr[0].length; a++) {
                if (a == 0) {
                    if (name == "总计") {
                        stasticarr.push(name);
                    }
                    else {
                        stasticarr.push({ "name": name, "issum": true });
                    }

                }
                else {
                    stasticarr.push("");
                }
            }
            return stasticarr;
        },
        generategrouparraymain: function (group, config) {
            //生成数组
            var ret = [];
            for (var i = 0; i < group.length; i++) {
                var name = group[i].name;
                var arr = this.generategrouparray(group[i].children, config, 1);
                if (config[0].stastic == "1" || config[0].stastic == null) {
                    arr.push(this.generategroupaddstatic(arr, name));
                }

                ret = ret.concat(arr);
            }
            return ret;
        },
        generategrouparray: function (group, config, level) {
            var ret = [];
            for (var i = 0; i < group.length; i++) {
                var name = group[i].name;
                var arr;
                if (group[i].children == 0 || group[i].children.length == 0) {
                    arr = [name];

                    ret.push(arr);
                }
                else {
                    arr = this.generategrouparray(group[i].children, config, level + 1);
                    for (var a = 0; a < arr.length; a++) {
                        arr[a].unshift(name);
                    }
                    if (config[level].stastic == "1" || config[level].stastic == null) {
                        arr.push(this.generategroupaddstatic(arr, name));
                    }
                    ret = ret.concat(arr);
                }

            }
            //console.log(JSON.stringify(ret));
            return ret;
        },
        addStatisticsData: function (dataposition, valueobj, indicator, d_value) {
            if (dataposition[indicator] == null) {
                dataposition[indicator] = { "data": [], "count": 0, "max": -Infinity, "min": Infinity, "counta": 0, "countunique": 0, "countuniquedata": {}, "sum": 0, digitaldata: [], "sumtype": valueobj.sumtype, "index": valueobj.index, "name": valueobj.fullname, "acc": 0 };
            }

            if (jfgrid.isdatatypemulti(d_value)["num"] === true) {
                var num = jfgrid.numFormat(d_value);
                dataposition[indicator]["digitaldata"].push(num);
                dataposition[indicator]["count"] += 1;
                dataposition[indicator]["sum"] += num;

                if (num > dataposition[indicator]["max"]) {
                    dataposition[indicator]["max"] = num;
                }

                if (num < dataposition[indicator]["min"]) {
                    dataposition[indicator]["min"] = num;
                }

                var newAcc = jfgrid.numfloatlen(num);

                if(newAcc > dataposition[indicator]["acc"]){
                    dataposition[indicator]["acc"] = newAcc;
                }
            }

            if (d_value != "") {
                dataposition[indicator]["data"].push(d_value);
                dataposition[indicator]["counta"] += 1;
                if (!(d_value in dataposition[indicator]["countuniquedata"])) {
                    dataposition[indicator]["countuniquedata"][d_value] = 1;
                    dataposition[indicator]["countunique"] += 1;
                }
            }
        },
        dataHandler: function (column, row, values, showType, celldata) {
            //column:[{"index":1, name:"列1", "order":"asc", "orderby":"self/0/1/2", "stastic":"0/1"}]
            //row:[{"index":1, name:"列3", "order":"asc", "orderby":"self/0/1/2", "stastic":"0/1"}]
            //values:[{"index":1, "sumtype":"SUM/COUNT/COUNTA/COUNTUNIQUE/AVERAGE/MAX/MIN/MEDIAN/PRODUCT/STDEV/STDEVP/VAR/VARP", "name":"求和:fyc"}]

            if (showType == null) {
                showType = "column";
            }

            if ((column.length == 0 && row.length == 0 && values.length == 0) || celldata.length == 0) {
                this.pivotDatas = [];
                return [];
            }

            //生成透视表值及定位
            var dataposition = {}, 
                data = celldata, 
                datarowtitle = [], 
                datarowtitlegroup = [], 
                datarowposition = {}, 
                datarowposition_i = 0, 
                datacoltitle = [], 
                datacoltitlegroup = [], 
                datacolposition = {}, 
                datacolposition_i = 0;

            for (var i = 1; i < data.length; i++) {
                var d = data[i];
                var groupbyrowtxt = "", 
                    groupbycoltxt = "", 
                    rowtxt = "", 
                    rowtitle = [], 
                    rowtitlename = [], 
                    coltxt = "", 
                    coltitle = [], 
                    coltitlename = [];

                //for (var r = 0; r < row.length; r++) {
                //       var c_value = d[row[r].index];
                //       groupbyrowtxt += "|row" + c_value.toString();
                //       rowtxt += c_value.toString();
                //       rowtitle.push(c_value);
                //   }


                //   if (rowtxt!="" && datarowposition[rowtxt] == null) {
                //       datarowposition[rowtxt] = datarowposition_i++;
                //       datarowtitle.push(rowtitle);
                //   }

                //   for (var c = 0; c < column.length; c++) {
                //       var c_value = d[column[c].index];
                //       groupbycoltxt += "|col" + c_value.toString();
                //       coltxt += c_value.toString();
                //       coltitle.push(c_value);
                //   }

                //   if (coltxt != "" && datacolposition[coltxt] == null) {
                //       datacolposition[coltxt] = datacolposition_i++;
                //       datacoltitle.push(coltitle);
                //   }

                //["四川", "成都", "邛崃"] 转换为 ["四川", "四川成都", "四川成都邛崃"]
                rowtitlename = this.getnameArray(d, row);
                coltitlename = this.getnameArray(d, column);

                rowtitle = this.getComposeArray(rowtitlename);
                coltitle = this.getComposeArray(coltitlename);

                if (rowtitle.length > 0) {
                    rowtitle.unshift("总计");
                }

                if (coltitle.length > 0) {
                    coltitle.unshift("总计");
                }

                var curentLevelobj = datarowposition, curentLevelarr = datarowtitlegroup;
                for (var r = 0; r < rowtitle.length; r++) {
                    var item = rowtitle[r], name = r == 0 ? "总计" : rowtitlename[r - 1];//修改
                    if (curentLevelobj[r.toString()] != null && curentLevelobj[r.toString()][item] != null) {//修改
                        curentLevelarr = curentLevelarr[curentLevelobj[r.toString()][item]].children;
                    }
                    else {
                        var orderby = r == 0 ? "self" : ((row[r - 1].orderby == "self" || row[r - 1].orderby == null) ? item : (showType == "column" ? item + values[parseInt(row[r - 1].orderby)].fullname : item + "合计"));
                        if(name == null){
                            name = "(空白)";
                        }
                        curentLevelarr.push({ "name": name, "fullname": item, "index": r, "orderby": orderby, "children": [] });

                        if (curentLevelobj[r.toString()] == null) {
                            curentLevelobj[r.toString()] = {};
                        }

                        if (curentLevelobj[r.toString()][item] == null) {
                            curentLevelobj[r.toString()][item] = curentLevelarr.length - 1;
                        }
                        curentLevelarr = curentLevelarr[curentLevelarr.length - 1].children;
                    }
                }

                var curentLevelobj = datacolposition, curentLevelarr = datacoltitlegroup;
                for (var r = 0; r < coltitle.length; r++) {
                    var item = coltitle[r], name = r == 0 ? "总计" : coltitlename[r - 1];
                    if (curentLevelobj[r.toString()] != null && curentLevelobj[r.toString()][item] != null) {
                        curentLevelarr = curentLevelarr[curentLevelobj[r.toString()][item]].children;
                    }
                    else {
                        var orderby = r == 0 ? "self" : ((column[r - 1].orderby == "self" || column[r - 1].orderby == null) ? item : (showType == "column" ? "合计" + item : values[parseInt(column[r - 1].orderby)].fullname + item));
                        if(name==null){
                            name = "(空白)";
                        }
                        curentLevelarr.push({ "name": name, "fullname": item, "index": r, "orderby": orderby, "children": [] });

                        if (curentLevelobj[r.toString()] == null) {
                            curentLevelobj[r.toString()] = {};
                        }

                        if (curentLevelobj[r.toString()][item] == null) {
                            curentLevelobj[r.toString()][item] = curentLevelarr.length - 1;
                        }
                        curentLevelarr = curentLevelarr[curentLevelarr.length - 1].children;
                    }
                }

                var v_str = "";
                for (var v = 0; v < values.length; v++) {
                    var d_value = jfgrid.getcellvalue(values[v].index, null, d);
                    //      var indicator = "";
                    //      if (showType=="column"){
                    //          indicator = groupbyrowtxt + groupbycoltxt;
                    //          if (indicator != "") {
                    //              indicator = indicator.substr(1) + "|col" + values[v].fullname;
                    //          }
                    //          else {
                    //              indicator = "col" + values[v].fullname;
                    //          }
                    //}
                    //else{
                    //          if (groupbyrowtxt != "") {
                    //              indicator = groupbyrowtxt.substr(1) + "|row" + values[v].fullname + groupbycoltxt;
                    //          }
                    //          else {
                    //              indicator = "row" + values[v].fullname + groupbycoltxt;
                    //          }
                    //}

                    var coltitle_c = [].concat(coltitle), rowtitle_c = [].concat(rowtitle);
                    if (showType == "column") {
                        if (coltitle_c.length > 0) {
                            coltitle_c.push("")
                            coltitle_c = coltitle_c.join(values[v].fullname + "|||").split("|||").slice(0, coltitle_c.length - 1);
                        }
                        else {
                            coltitle_c.push(values[v].fullname);
                        }

                    }
                    else {
                        if (rowtitle_c.length > 0) {
                            //rowtitle_c.push(rowtitle_c[rowtitle_c.length-1] + values[v].fullname);
                            //rowtitle_c = (values[v].fullname + rowtitle_c.join("|||" + values[v].fullname)).split("|||");
                            rowtitle_c.push("")
                            rowtitle_c = rowtitle_c.join(values[v].fullname + "|||").split("|||").slice(0, rowtitle_c.length - 1);
                        }
                        else {
                            rowtitle_c.push(values[v].fullname);
                        }
                    }

                    if (coltitle_c.length == 0) {
                        coltitle_c.push("");
                    }

                    if (rowtitle_c.length == 0) {
                        rowtitle_c.push("");
                    }

                    for (var r = 0; r < rowtitle_c.length; r++) {
                        for (var c = 0; c < coltitle_c.length; c++) {
                            indicator = rowtitle_c[r] + coltitle_c[c];
                            this.addStatisticsData(dataposition, values[v], indicator, d_value);
                        }
                    }


                    //if (dataposition[indicator] == null) {
                    //    dataposition[indicator] = { "data": [], "count": 0, "max": -Infinity, "min": Infinity, "counta": 0, "countunique": 0, "countuniquedata": {}, "sum": 0, digitaldata:[], "sumtype": values[v].sumtype, "index": values[v].index, "name": values[v].fullname };
                    //}



                    //if (jfgrid.isdatatypemulti(d_value)["num"] === true ) {
                    //    var num = jfgrid.numFormat(d_value);
                    //    dataposition[indicator]["digitaldata"].push(num);
                    //    dataposition[indicator]["count"] += 1;
                    //    dataposition[indicator]["sum"] += num;

                    //    if (num > dataposition[indicator]["max"]) {
                    //        dataposition[indicator]["max"] = num;
                    //    }

                    //    if (num < dataposition[indicator]["min"]) {
                    //        dataposition[indicator]["min"] = num;
                    //    }
                    //}

                    //if (d_value != "") {
                    //    dataposition[indicator]["data"].push(d_value);
                    //    dataposition[indicator]["counta"] += 1;
                    //    if (!(d_value in dataposition[indicator]["countuniquedata"])){
                    //        dataposition[indicator]["countuniquedata"]["d_value"] = 1;
                    //        dataposition[indicator]["countunique"] += 1;
                    //    }
                    //}

                }
            }

            //计算值列
            //SUM/COUNT/COUNTA/COUNTUNIQUE/AVERAGE/MAX/MIN/MEDIAN/PRODUCT/STDEV/STDEVP/VAR/VARP
            for (indicator in dataposition) {
                var json = dataposition[indicator];
                if (json.sumtype == "SUM") {
                    json.result = json.sum;
                }
                else if (json.sumtype == "COUNT") {
                    json.result = json.count;
                }
                else if (json.sumtype == "COUNTA") {
                    json.result = json.counta;
                }
                else if (json.sumtype == "COUNTUNIQUE") {
                    json.result = json.countunique;
                }
                else if (json.sumtype == "AVERAGE") {
                    json.result = jfgrid.numFormat(json.sum / json.count);
                }
                else if (json.sumtype == "MAX") {
                    json.result = json.max;
                }
                else if (json.sumtype == "MIN") {
                    json.result = json.min;
                }
                else if (json.sumtype == "MEDIAN") {
                    var numArr = json.digitaldata.sort(function(a, b){ return a - b });
                    var numLen = numArr.length;
                    var numindex = parseInt(numLen / 2);

                    if(numLen % 2 == 0){
                        json.result = (numArr[numindex - 1] + numArr[numindex]) / 2;
                    }
                    else{
                        json.result = numArr[numindex];
                    }
                }
                else if (json.sumtype == "PRODUCT") {
                    json.result = eval(json.digitaldata.join("*"));
                }
                else if (json.sumtype == "STDEV") {
                    var mean = json.sum / json.count;
                    json.result = jfgrid.analysis.STDEV(mean, json.digitaldata);
                }
                else if (json.sumtype == "STDEVP") {
                    var mean = json.sum / json.count;
                    json.result = jfgrid.analysis.STDEVP(mean, json.digitaldata);
                }
                else if (json.sumtype == "VAR") {
                    var mean = json.sum / json.count;
                    json.result = jfgrid.analysis.VAR(mean, json.digitaldata);
                }
                else if (json.sumtype == "VARP") {
                    var mean = json.sum / json.count;
                    json.result = jfgrid.analysis.VARP(mean, json.digitaldata);
                }

                var newAcc = jfgrid.numfloatlen(json.result);
                if(newAcc > json.acc){
                    json.acc = newAcc;
                }

                json.result = jfgrid.numFormat(json.result, json.acc);
            }

            datarowtitle = this.getTitleFromGroup(datarowtitlegroup, row, dataposition);
            datacoltitle = this.getTitleFromGroup(datacoltitlegroup, column, dataposition);

            //加入值到列/行形成新的表头
            if (showType == "column") {
                if (datacoltitle.length > 0 && datacoltitle[0].length > 0) {
                    datacoltitle = this.addValuesToTitle(datacoltitle, values);
                }
                else {
                    for (var v = 0; v < values.length; v++) {
                        datacoltitle.push([values[v].fullname]);
                    }
                }
            }
            else {
                if (datarowtitle.length > 0 && datarowtitle[0].length > 0) {
                    datarowtitle = this.addValuesToTitle(datarowtitle, values);
                }
                else {
                    for (var v = 0; v < values.length; v++) {
                        datarowtitle.push([values[v].fullname]);
                    }
                }
            }

            var datacoltitle_index = datacoltitle;
            datacoltitle = jfgrid.array.transpose(datacoltitle);

            var valuenslen = values.length == 0 ? 0 : 1;
            var rowLen = (datacoltitle.length == 0 ? valuenslen : datacoltitle.length) + (datarowtitle.length == 0 ? valuenslen : datarowtitle.length), colLen = (datacoltitle.length == 0 ? valuenslen : datacoltitle[0].length) + (datarowtitle.length == 0 ? valuenslen : datarowtitle[0].length);

            var rowOver = datacoltitle.length, colOver = datarowtitle.length == 0 ? 0 : datarowtitle[0].length;

            var retdata = [];
            for (var r = 0; r < rowLen; r++) {
                retdata[r] = new Array(colLen);
                for (var c = 0; c < colLen; c++) {
                    var drt = datarowtitle[r - rowOver];
                    if (r < rowOver && c < colOver) {
                        //空白列头
                        retdata[r][c] = "";
                    }
                    else if (r < rowOver && c >= colOver) {
                        //列标题
                        if (datacoltitle[r] != null) {
                            if (jfgrid.getObjType(datacoltitle[r][c - colOver]) == "object") {
                                retdata[r][c] = datacoltitle[r][c - colOver].name + "总计";
                            }
                            else {
                                retdata[r][c] = datacoltitle[r][c - colOver];
                            }

                        }
                        else {
                            retdata[r][c] = "";
                        }
                    }
                    else if (r >= rowOver && c < colOver) {
                        //行标题
                        if (drt != null) {
                            //retdata[r][c] = datarowtitle[r - rowOver][c];
                            if (jfgrid.getObjType(drt[c]) == "object") {
                                retdata[r][c] = drt[c].name + "总计";
                            }
                            else {
                                retdata[r][c] = drt[c];
                            }
                        }
                        else {
                            retdata[r][c] = "";
                        }
                    }
                    else {
                        //单元格内容
                        var prefix = "";
                        if (drt != null) {
                            if (!(drt instanceof Array) || drt.length == 1) {
                                if (drt instanceof Array) {
                                    prefix = drt[0];
                                }
                                else {
                                    prefix = drt;
                                }
                            }
                            else {
                                for (var x = 0; x < drt.length; x++) {
                                    if (jfgrid.getObjType(drt[x]) == "object") {
                                        prefix += drt[x].name;
                                    }
                                    else {
                                        prefix += drt[x];
                                    }
                                }
                            }
                        }

                        var suffix = "";
                        var dct = datacoltitle_index[c - colOver];
                        if (dct != null) {
                            if (!(dct instanceof Array) || dct.length == 1) {
                                if (dct instanceof Array) {
                                    suffix = dct[0];
                                }
                                else {
                                    suffix = dct;
                                }
                            }
                            else {
                                for (var x = 0; x < dct.length; x++) {
                                    if (jfgrid.getObjType(dct[x]) == "object") {
                                        suffix += dct[x].name;
                                    }
                                    else {
                                        suffix += dct[x];
                                    }
                                }
                                //suffix = dct.join("");
                            }
                        }

                        var indicator = prefix;

                        if (prefix != "" && suffix != "") {
                            indicator = prefix + suffix;
                        }
                        else if (prefix == "") {
                            indicator = suffix;
                        }

                        if (dataposition[indicator] == null) {
                            retdata[r][c] = "";
                        }
                        else {
                            retdata[r][c] = dataposition[indicator].result;
                        }
                    }
                }
            }

            if (values.length == 1 && column.length > 0) {
                retdata[0][0] = values[0].fullname;
                retdata.splice(column.length, 1);
            }
            this.pivotDatas = retdata;
            return retdata;
        },
        drillDown: function(row_index, col_index){
            var cell = this.pivotDatas[row_index][col_index];

            var d = $.extend(true, [], jfgrid.sheetmanage.nulldata);

            var selecteditemNullIndex = 1;
            for(var i = 0; i < this.celldata[0].length; i++){
                if(!!this.celldata[0][i] && !!this.celldata[0][i]["m"]){
                    var name = this.celldata[0][i]["m"];
                }
                else{
                    var name = jfgrid.getcellvalue(0, i, this.celldata);    
                }

                if(name != null){
                    name = name.toString();
                }

                if (name == null || $.trim(name.toString()).length == 0) {
                    name = "列 " + selecteditemNullIndex;
                }
                selecteditemNullIndex++

                d[0][i] = name;
            }

            // if(cell == null || cell == ""){
            //     jfgird_select_save = [{ "row": [0, 1], "column": [0, this.celldata[0].length - 1] }];
            // }
            // else{
                var obj = {};

                //行
                if(this.row != null && this.row.length > 0){
                    for(var a = 0; a < this.row.length; a++){
                        obj[this.row[a]["index"]] = this.pivotDatas[row_index][a];
                    }
                }

                //列
                if(this.column != null && this.column.length > 0){
                    for(var b = 0; b < this.column.length; b++){
                        obj[this.column[b]["index"]] = this.pivotDatas[b][col_index];
                    }
                }

                var rowArr = [];
                for(var j = 1; j < this.celldata.length; j++){
                    var isEqual = true

                    for(x in obj){
                        if(!!this.celldata[j][x] && !!this.celldata[j][x]["m"]){
                            var value = this.celldata[j][x]["m"];
                        }
                        else{
                            var value = jfgrid.getcellvalue(j, x, this.celldata);    
                        }

                        if(value != null){
                            value = value.toString();
                        }
                        else{
                            value = "(空白)";
                        }

                        if(value != obj[x]){
                            isEqual = false;
                            break;
                        }
                    }

                    if(isEqual){
                        rowArr.push(j);
                    }
                }

                for(var r = 0; r < rowArr.length; r++){
                    for(var c = 0; c < this.celldata[0].length; c++){
                        if(!!this.celldata[rowArr[r]][c] && !!this.celldata[rowArr[r]][c]["m"]){
                            var value = this.celldata[rowArr[r]][c]["m"];
                        }
                        else{
                            var value = jfgrid.getcellvalue(rowArr[r], c, this.celldata);    
                        }

                        if(value != null){
                            value = value.toString();
                        }
                        else{
                            value = "";
                        }

                        d[r + 1][c] = value;
                    }
                }

                jfgird_select_save = [{ "row": [0, rowArr.length], "column": [0, this.celldata[0].length - 1] }];
            // }

            clearjfundo = false;
            jfgrid.jfrefreshgrid(d, jfgird_select_save);
            jfgrid.selectHightlightShow();
            clearjfundo = true;
        }
    }

    jfgrid.freezen = {
        freezenHorizontalHTML: '<div id="jfgrid-freezebar-horizontal" class="jfgrid-freezebar" tabindex="0"><div class="jfgrid-freezebar-handle jfgrid-freezebar-horizontal-handle" ><div class="jfgrid-freezebar-handle-bar jfgrid-freezebar-horizontal-handle-title" ></div><div class="jfgrid-freezebar-handle-bar jfgrid-freezebar-horizontal-handle-bar" ></div></div><div class="jfgrid-freezebar-drop jfgrid-freezebar-horizontal-drop" ><div class="jfgrid-freezebar-drop-bar jfgrid-freezebar-horizontal-drop-title" ></div><div class="jfgrid-freezebar-drop-bar jfgrid-freezebar-horizontal-drop-bar" >&nbsp;</div></div></div>',
        freezenVerticalHTML: '<div id="jfgrid-freezebar-vertical" class="jfgrid-freezebar" tabindex="0"><div class="jfgrid-freezebar-handle jfgrid-freezebar-vertical-handle" ><div class="jfgrid-freezebar-handle-bar jfgrid-freezebar-vertical-handle-title" ></div><div class="jfgrid-freezebar-handle-bar jfgrid-freezebar-vertical-handle-bar" ></div></div><div class="jfgrid-freezebar-drop jfgrid-freezebar-vertical-drop" ><div class="jfgrid-freezebar-drop-bar jfgrid-freezebar-vertical-drop-title" ></div><div class="jfgrid-freezebar-drop-bar jfgrid-freezebar-vertical-drop-bar" >&nbsp;</div></div></div>',
        initialHorizontal: true,
        initialVertical: true,
        horizontalmovestate: false,
        horizontalmoveposition: null,
        verticalmovestate: false,
        verticalmoveposition: null,
        windowHeight: null,
        windowWidth: null,
        freezenhorizontaldata: null,
        freezenverticaldata: null,
        cutVolumn: function (arr, cutindex) {
            if(cutindex <= 0){
                return arr;
            }

            var pre = arr.slice(0, cutindex);
            var premax = pre[pre.length - 1];
            var ret = arr.slice(cutindex);
            
            for (var i = 0; i < ret.length; i++) {
                ret[i] -= premax;
            }
            return ret;
        },
        cancelFreezenVertical: function (sheetIndex) {
            $("#jfgrid-freezen-btn-vertical").html('<i class="fa fa-indent"></i> 冻结首列');
            jfgrid.freezen.freezenverticaldata = null;
            var isvertical = $("#jfgrid-freezebar-vertical").is(":visible");
            $("#jfgrid-freezebar-vertical").hide();

            if (sheetIndex == null) {
                sheetIndex = jfgrid.currentSheetIndex;
            }
            var currentSheet = jfgridfile[jfgrid.sheetmanage.getSheetIndex(sheetIndex)];
            if (currentSheet.freezen != null) {
                currentSheet.freezen.vertical = null;
            }

            if(currentSheet.freezen != null && isvertical){
                jfgrid.server.saveParam("all", sheetIndex, currentSheet.freezen, { "k": "freezen" });
            }
        },
        createFreezenVertical: function (freezenverticaldata, left) {
            if (this.initialVertical) {
                this.initialVertical = false;
                $("#jfgrid-grid-window-1").append(this.freezenVerticalHTML);

                $("#jfgrid-freezebar-vertical").find(".jfgrid-freezebar-vertical-drop").hover(function () {
                    $(this).parent().addClass("jfgrid-freezebar-hover");
                }, function () {
                    $(this).parent().removeClass("jfgrid-freezebar-hover");
                });


                $("#jfgrid-freezebar-vertical").find(".jfgrid-freezebar-vertical-drop").mousedown(function () {
                    jfgrid.freezen.verticalmovestate = true;
                    jfgrid.freezen.verticalmoveposition = $(this).position().left;

                    jfgrid.freezen.windowWidth = $("#jfgrid-grid-window-1").width();

                    $(this).parent().addClass("jfgrid-freezebar-active");

                    $("#jfgrid-freezebar-vertical").find(".jfgrid-freezebar-vertical-handle").css("cursor", "-webkit-grabbing");
                });

                var gridheight = $("#jfgrid-grid-window-1").height();
                $("#jfgrid-freezebar-vertical").find(".jfgrid-freezebar-vertical-handle").css({ "height": gridheight - 10, "width": "4px", "cursor": "-webkit-grab", "top": "0px" }).end().find(".jfgrid-freezebar-vertical-drop").css({ "height": gridheight - 10, "width": "4px", "top": "0px", "cursor": "-webkit-grab" });
            }

            if (freezenverticaldata == null) {
                var scrollLeft = $("#jfgrid-cell-main").scrollLeft();
                var dataset_col_st = jfgrid_searcharray(visibledatacolumn, scrollLeft);
                if (dataset_col_st == -1) {
                    dataset_col_st = 0;
                }

                left = visibledatacolumn[dataset_col_st] - 2 - scrollLeft + rowHeaderWidth;
                freezenverticaldata = [visibledatacolumn[dataset_col_st], dataset_col_st + 1, scrollLeft, jfgrid.freezen.cutVolumn(visibledatacolumn, dataset_col_st + 1), left];
                jfgrid.freezen.saveFreezen(null, null, freezenverticaldata, left);
            }

            jfgrid.freezen.freezenverticaldata = freezenverticaldata;

            $("#jfgrid-freezen-btn-horizontal").html('<i class="fa fa-indent"></i> 取消冻结');

            $("#jfgrid-freezebar-vertical").show().find(".jfgrid-freezebar-vertical-handle").css({ "left": left }).end().find(".jfgrid-freezebar-vertical-drop").css({ "left": left });
        },
        saveFreezen: function (freezenhorizontaldata, top, freezenverticaldata, left) {
            var currentSheet = jfgridfile[jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex)];
            if (currentSheet.freezen == null) {
                currentSheet.freezen = {};
            }

            if (freezenhorizontaldata != null) {
                if (currentSheet.freezen.horizontal == null) {
                    currentSheet.freezen.horizontal = {};
                }

                currentSheet.freezen.horizontal.freezenhorizontaldata = freezenhorizontaldata;
                currentSheet.freezen.horizontal.top = top;
            }

            if (freezenverticaldata != null) {
                if (currentSheet.freezen.vertical == null) {
                    currentSheet.freezen.vertical = {};
                }

                currentSheet.freezen.vertical.freezenverticaldata = freezenverticaldata;
                currentSheet.freezen.vertical.left = left;
            }

            if(currentSheet.freezen != null){
                jfgrid.server.saveParam("all", jfgrid.currentSheetIndex, currentSheet.freezen, { "k": "freezen" });
            }
        },
        initialFreezen: function (sheetIndex) {
            var currentSheet = jfgridfile[jfgrid.sheetmanage.getSheetIndex(sheetIndex)];
            if (currentSheet.freezen != null && currentSheet.freezen.horizontal != null && currentSheet.freezen.horizontal.freezenhorizontaldata != null) {
                this.createFreezenHorizontal(currentSheet.freezen.horizontal.freezenhorizontaldata, currentSheet.freezen.horizontal.top);
                
            }
            else {
                this.cancelFreezenHorizontal(sheetIndex);
            }

            if (currentSheet.freezen != null && currentSheet.freezen.vertical != null && currentSheet.freezen.vertical.freezenverticaldata != null) {
                this.createFreezenVertical(currentSheet.freezen.vertical.freezenverticaldata, currentSheet.freezen.vertical.left);
            }
            else {
                this.cancelFreezenVertical(sheetIndex);
            }


            this.createAssistCanvas();
        },
        changeFreezenIndex: function (originindex, type) {
            if (type == "v" && this.freezenverticaldata != null) {
                var freezen_colindex = this.freezenverticaldata[1];
                var offset = jfgrid_searcharray(visibledatacolumn, $("#jfgrid-cell-main").scrollLeft());

                if (originindex - offset < freezen_colindex) {
                    originindex = originindex - offset;
                }

            }
            else if (type == "h" && this.freezenhorizontaldata != null) {
                var freezen_rowindex = this.freezenhorizontaldata[1];
                var offset = jfgrid_searcharray(visibledatarow, $("#jfgrid-cell-main").scrollTop());
                if (originindex - offset < freezen_rowindex) {
                    originindex = originindex - offset;
                }

            }
            return originindex;
        },
        scrollFreezen: function () {
            var row_focus = jfgird_select_save[0]["row_focus"];
            if(row_focus == jfgird_select_save[0]["row"][0]){
                var row = jfgird_select_save[0]["row"][1];
            }
            else if(row_focus == jfgird_select_save[0]["row"][1]){
                var row = jfgird_select_save[0]["row"][0];
            }

            var column_focus = jfgird_select_save[0]["column_focus"];
            if(column_focus == jfgird_select_save[0]["column"][0]){
                var column = jfgird_select_save[0]["column"][1];
            }
            else if(column_focus == jfgird_select_save[0]["column"][1]){
                var column = jfgird_select_save[0]["column"][0];
            }

            if (this.freezenverticaldata != null) {
                var freezen_colindex = this.freezenverticaldata[1];
                var offset = jfgrid_searcharray(this.freezenverticaldata[3], $("#jfgrid-cell-main").scrollLeft());

                freezen_colindex += offset;
                
                if (column <= freezen_colindex) {
                    setTimeout(function () { $("#jfgrid-scrollbar-x").scrollLeft(0); }, 10);
                }
            }

            if (this.freezenhorizontaldata != null) {
                var freezen_rowindex = this.freezenhorizontaldata[1];
                var offset = jfgrid_searcharray(this.freezenhorizontaldata[3], $("#jfgrid-cell-main").scrollTop());

                freezen_rowindex += offset;

                if (row <= freezen_rowindex) {
                    setTimeout(function () { $("#jfgrid-scrollbar-y").scrollTop(0); }, 10);
                }
            }
        },
        cancelFreezenHorizontal: function (sheetIndex) {
            $("#jfgrid-freezen-btn-horizontal").html('<i class="fa fa-list-alt"></i> 冻结首行');
            jfgrid.freezen.freezenhorizontaldata = null;
            var ishorizontal = $("#jfgrid-freezebar-horizontal").is(":visible");
            $("#jfgrid-freezebar-horizontal").hide();

            if (sheetIndex == null) {
                sheetIndex = jfgrid.currentSheetIndex;
            }

            var currentSheet = jfgridfile[jfgrid.sheetmanage.getSheetIndex(sheetIndex)];
            if (currentSheet.freezen != null) {
                currentSheet.freezen.horizontal = null;
            }

            if(currentSheet.freezen != null && ishorizontal){
                jfgrid.server.saveParam("all", sheetIndex, currentSheet.freezen, { "k": "freezen" });
            }
        },
        createFreezenHorizontal: function (freezenhorizontaldata, top) {
            if (this.initialHorizontal) {
                this.initialHorizontal = false;
                $("#jfgrid-grid-window-1").append(this.freezenHorizontalHTML);

                $("#jfgrid-freezebar-horizontal").find(".jfgrid-freezebar-horizontal-drop").hover(function () {
                    $(this).parent().addClass("jfgrid-freezebar-hover");
                }, function () {
                    $(this).parent().removeClass("jfgrid-freezebar-hover");
                });


                $("#jfgrid-freezebar-horizontal").find(".jfgrid-freezebar-horizontal-drop").mousedown(function () {
                    jfgrid.freezen.horizontalmovestate = true;
                    jfgrid.freezen.horizontalmoveposition = $(this).position().top;

                    jfgrid.freezen.windowHeight = $("#jfgrid-grid-window-1").height();

                    $(this).parent().addClass("jfgrid-freezebar-active");

                    $("#jfgrid-freezebar-horizontal").find(".jfgrid-freezebar-horizontal-handle").css("cursor", "-webkit-grabbing");
                });

                var gridwidth = $("#jfgrid-grid-window-1").width();
                $("#jfgrid-freezebar-horizontal").find(".jfgrid-freezebar-horizontal-handle").css({ "width": gridwidth - 10, "height": "4px", "cursor": "-webkit-grab", "left": "0px" }).end().find(".jfgrid-freezebar-horizontal-drop").css({ "width": gridwidth - 10, "height": "4px", "left": "0px", "cursor": "-webkit-grab" });
            }

            if (freezenhorizontaldata == null) {
                var scrollTop = $("#jfgrid-cell-main").scrollTop();
                var dataset_row_st = jfgrid_searcharray(visibledatarow, scrollTop);
                if (dataset_row_st == -1) {
                    dataset_row_st = 0;
                }

                top = visibledatarow[dataset_row_st] - 2 - scrollTop + columeHeaderHeight;
                freezenhorizontaldata = [visibledatarow[dataset_row_st], dataset_row_st + 1, scrollTop, jfgrid.freezen.cutVolumn(visibledatarow, dataset_row_st + 1), top];
                jfgrid.freezen.saveFreezen(freezenhorizontaldata, top, null, null);
            }

            jfgrid.freezen.freezenhorizontaldata = freezenhorizontaldata;

            $("#jfgrid-freezen-btn-horizontal").html('<i class="fa fa-list-alt"></i> 取消冻结');

            $("#jfgrid-freezebar-horizontal").show().find(".jfgrid-freezebar-horizontal-handle").css({ "top": top }).end().find(".jfgrid-freezebar-horizontal-drop").css({ "top": top });
        },
        createAssistCanvas: function(){
            var _this = this;
            _this.removeAssistCanvas();
            if (_this.freezenverticaldata != null || _this.freezenhorizontaldata != null) {

                var freezen_horizon_px, freezen_horizon_ed, freezen_horizon_scrollTop;
                var freezen_vertical_px, freezen_vertical_ed, freezen_vertical_scrollTop;
                var drawWidth = jfgridTableContentHW[0], drawHeight = jfgridTableContentHW[1];
                //双向freezen开始
                if (_this.freezenverticaldata != null && _this.freezenhorizontaldata != null) {
                    freezen_horizon_px = _this.freezenhorizontaldata[0];
                    freezen_horizon_ed = _this.freezenhorizontaldata[1];
                    freezen_horizon_scrollTop = _this.freezenhorizontaldata[2];

                    freezen_vertical_px = _this.freezenverticaldata[0];
                    freezen_vertical_ed = _this.freezenverticaldata[1];
                    freezen_vertical_scrollTop = _this.freezenverticaldata[2];

                    //3
                    // _this.createCanvas("freezen_3",freezen_vertical_px - freezen_vertical_scrollTop, freezen_horizon_px-freezen_horizon_scrollTop+1, rowHeaderWidth, columeHeaderHeight);
                    _this.createCanvas("freezen_3", freezen_vertical_px - freezen_vertical_scrollTop, freezen_horizon_px - freezen_horizon_scrollTop + 1, rowHeaderWidth - 1, columeHeaderHeight - 1);
                    //4
                    // _this.createCanvas("freezen_4",drawWidth - freezen_vertical_px + freezen_vertical_scrollTop, freezen_horizon_px-freezen_horizon_scrollTop+1, freezen_vertical_px - freezen_vertical_scrollTop + rowHeaderWidth,columeHeaderHeight);
                    _this.createCanvas("freezen_4", drawWidth - freezen_vertical_px + freezen_vertical_scrollTop, freezen_horizon_px - freezen_horizon_scrollTop + 1, freezen_vertical_px - freezen_vertical_scrollTop + rowHeaderWidth - 1, columeHeaderHeight - 1);
                    //7
                    // _this.createCanvas("freezen_7",freezen_vertical_px - freezen_vertical_scrollTop, drawHeight - freezen_horizon_px + freezen_horizon_scrollTop-columeHeaderHeight, rowHeaderWidth, freezen_horizon_px - freezen_horizon_scrollTop + columeHeaderHeight);
                    _this.createCanvas("freezen_7", freezen_vertical_px - freezen_vertical_scrollTop, drawHeight - freezen_horizon_px + freezen_horizon_scrollTop - columeHeaderHeight, rowHeaderWidth - 1, freezen_horizon_px - freezen_horizon_scrollTop + columeHeaderHeight - 1);
                }
                //水平freezen开始
                else if (_this.freezenhorizontaldata != null) {
                    freezen_horizon_px = _this.freezenhorizontaldata[0];
                    freezen_horizon_ed = _this.freezenhorizontaldata[1];
                    freezen_horizon_scrollTop = _this.freezenhorizontaldata[2];

                    // _this.createCanvas("freezen_h", drawWidth, freezen_horizon_px - freezen_horizon_scrollTop + 1, rowHeaderWidth, columeHeaderHeight);
                    _this.createCanvas("freezen_h", drawWidth, freezen_horizon_px - freezen_horizon_scrollTop + 1, rowHeaderWidth - 1, columeHeaderHeight - 1);
                    
                }
                //水平freezon结束

                //垂直freezen开始
                else if (_this.freezenverticaldata != null) {
                    freezen_vertical_px = _this.freezenverticaldata[0];
                    freezen_vertical_ed = _this.freezenverticaldata[1];
                    freezen_vertical_scrollTop = _this.freezenverticaldata[2];

                    // _this.createCanvas("freezen_v", freezen_vertical_px - freezen_vertical_scrollTop, drawHeight, rowHeaderWidth, columeHeaderHeight);
                    _this.createCanvas("freezen_v", freezen_vertical_px - freezen_vertical_scrollTop, drawHeight, rowHeaderWidth - 1, columeHeaderHeight - 1);
                }
                //垂直freezen结束

                // $("#jfgrid-cell-selected-boxs").find(".jfgrid-cell-selected").css("z-index", 10001);

                // setTimeout(function(){
                //     jfgrid.jfgridsizeauto();
                // },0);

                jfgrid.freezen.scrollAdapt();
            }
        },
        createCanvas: function(id, width, height, left, top){
            var c = $("<canvas/>").appendTo("#jfgrid-grid-window-1").attr({"id":id, "width":Math.ceil(width*devicePixelRatio), "height":Math.ceil(height*devicePixelRatio)}).css({"user-select":"none","postion":"absolute","left":left, "top":top,"width":width, "height":height, "z-index":10, "pointer-events":"none"});
        },
        removeAssistCanvas: function(){
            $("#jfgrid-grid-window-1 > canvas").not($("#jfgridTableContent")).remove();
            $("#jfgrid-cell-selected").css("z-index", 15);
        },
        scrollAdapt: function(){
            //有冻结时 选区框 滚动适应
            if(jfgird_select_save != null && jfgird_select_save.length > 0){
                jfgrid.freezen.scrollAdaptOfselect();    
            }

            //有冻结时 图表框 滚动适应
            if($("#jfgrid-cell-main .jfgrid-data-visualization-chart").length > 0){
                jfgrid.freezen.scrollAdaptOfchart();
            }

            //有冻结时 批注框 滚动适应
            if($("#jfgrid-postil-showBoxs .jfgrid-postil-show").length > 0){
                jfgrid.freezen.scrollAdaptOfpostil();               
            }

            //有冻结时 下拉选区图标 滚动适应
            if($("#jfgrid-dropCell-icon").length > 0){
                jfgrid.freezen.scrollAdaptOfdpicon();
            }

            //有冻结时 筛选下拉按钮 滚动适应
            if($("#jfgrid-filter-options-sheet"+ jfgrid.currentSheetIndex +" .jfgrid-filter-options").length > 0){
                jfgrid.freezen.scrollAdaptOffilteroptions();
            }
        },
        scrollAdaptOfselect: function(){
            if($("#jfgrid-row-count-show").is(":visible")){
                $("#jfgrid-row-count-show").hide();
            }

            if($("#jfgrid-column-count-show").is(":visible")){
                $("#jfgrid-column-count-show").hide();
            }

            $("#jfgrid-rows-h-selected").empty();
            $("#jfgrid-cols-h-selected").empty();

            var scrollTop = $("#jfgrid-cell-main").scrollTop();
            var scrollLeft = $("#jfgrid-cell-main").scrollLeft();

            if (jfgrid.freezen.freezenhorizontaldata != null && jfgrid.freezen.freezenverticaldata != null) {
                var freezenTop = jfgrid.freezen.freezenhorizontaldata[0];
                var freezen_rowindex = jfgrid.freezen.freezenhorizontaldata[1];
                var offTop = scrollTop - jfgrid.freezen.freezenhorizontaldata[2];

                var freezenLeft = jfgrid.freezen.freezenverticaldata[0];
                var freezen_colindex = jfgrid.freezen.freezenverticaldata[1];
                var offLeft = scrollLeft - jfgrid.freezen.freezenverticaldata[2];

                for(var s = 0; s < jfgird_select_save.length; s++){
                    var obj = $.extend(true, {}, jfgird_select_save[s]);

                    var r1 = obj.row[0], 
                        r2 = obj.row[1];

                    var row = visibledatarow[r2], row_pre = r1 - 1 == -1 ? 0 : visibledatarow[r1 - 1];

                    var top_move = row_pre;
                    var height_move = row - row_pre - 1;

                    var rangeshow = true;

                    if(r1 >= freezen_rowindex){//原选区在冻结区外
                        if(top_move + height_move < freezenTop + offTop){
                            rangeshow = false;
                        }
                        else if(top_move < freezenTop + offTop){
                            $("#jfgrid-cell-selected-boxs").find(".jfgrid-cell-selected").eq(s).show().css({
                                "top": freezenTop + offTop,
                                "height": height_move - (freezenTop + offTop - top_move)
                            });
                        }
                        else{
                            $("#jfgrid-cell-selected-boxs").find(".jfgrid-cell-selected").eq(s).show().css({
                                "top": top_move,
                                "height": height_move
                            });
                        }
                    }
                    else if(r2 >= freezen_rowindex){//原选区有一部分在冻结区内
                        if(top_move + height_move < freezenTop + offTop){
                            $("#jfgrid-cell-selected-boxs").find(".jfgrid-cell-selected").eq(s).show().css({
                                "top": top_move + offTop,
                                "height": freezenTop - top_move
                            });
                        }
                        else{
                            $("#jfgrid-cell-selected-boxs").find(".jfgrid-cell-selected").eq(s).show().css({
                                "top": top_move + offTop,
                                "height": height_move - offTop
                            });
                        }
                    }
                    else{//原选区在冻结区内
                        $("#jfgrid-cell-selected-boxs").find(".jfgrid-cell-selected").eq(s).show().css("top", top_move + offTop);
                    }

                    var c1 = obj.column[0], 
                        c2 = obj.column[1];

                    var col = visibledatacolumn[c2], col_pre = c1 - 1 == -1 ? 0 : visibledatacolumn[c1 - 1];

                    var left_move = col_pre;
                    var width_move = col - col_pre - 1;

                    if(c1 >= freezen_colindex){//原选区在冻结区外
                        if(left_move + width_move < freezenLeft + offLeft){
                            rangeshow = false;
                        }
                        else if(left_move < freezenLeft + offLeft){
                            $("#jfgrid-cell-selected-boxs").find(".jfgrid-cell-selected").eq(s).show().css({
                                "left": freezenLeft + offLeft,
                                "width": width_move - (freezenLeft + offLeft - left_move)
                            });
                        }
                        else{
                            $("#jfgrid-cell-selected-boxs").find(".jfgrid-cell-selected").eq(s).show().css({
                                "left": left_move,
                                "width": width_move
                            });
                        }
                    }
                    else if(c2 >= freezen_colindex){//原选区有一部分在冻结区内
                        if(left_move + width_move < freezenLeft + offLeft){
                            $("#jfgrid-cell-selected-boxs").find(".jfgrid-cell-selected").eq(s).show().css({
                                "left": left_move + offLeft,
                                "width": freezenLeft - left_move
                            });
                        }
                        else{
                            $("#jfgrid-cell-selected-boxs").find(".jfgrid-cell-selected").eq(s).show().css({
                                "left": left_move + offLeft,
                                "width": width_move - offLeft
                            });
                        }
                    }
                    else{//原选区在冻结区内
                        $("#jfgrid-cell-selected-boxs").find(".jfgrid-cell-selected").eq(s).show().css("left", left_move + offLeft);
                    }

                    if(!rangeshow){
                        $("#jfgrid-cell-selected-boxs").find(".jfgrid-cell-selected").eq(s).hide();
                    }

                    if(s == jfgird_select_save.length - 1){
                        var rf = obj.row_focus == null ? r1 : obj.row_focus;
                        var cf = obj.column_focus == null ? c1 : obj.column_focus;
                        
                        var row_f = visibledatarow[rf], row_pre_f = rf - 1 == -1 ? 0 : visibledatarow[rf - 1];
                        var col_f = visibledatacolumn[cf], col_pre_f = cf - 1 == -1 ? 0 : visibledatacolumn[cf - 1];

                        var margeset = jfgrid.menuButton.mergeborer(jfgrid.flowdata, rf, cf);
                        if(!!margeset){
                            row_f = margeset.row[1];
                            row_pre_f = margeset.row[0];

                            col_f = margeset.row[1];
                            col_pre_f = margeset.row[0];
                        }

                        var top = row_pre_f;
                        var height = row_f - row_pre_f - 1;

                        var left = col_pre_f;
                        var width = col_f - col_pre_f - 1;

                        var focuscell = true;

                        if(top >= freezenTop){
                            if(top + height < freezenTop + offTop){
                                focuscell = false;
                            }
                            else if(top < freezenTop + offTop){ 
                                $("#jfgrid-cell-selected-focus").show().css({
                                    "top": freezenTop + offTop,
                                    "height": height - (freezenTop + offTop - top)
                                })
                            }
                            else{
                                $("#jfgrid-cell-selected-focus").show().css({
                                    "top": top,
                                    "height": height
                                });
                            }
                        }
                        else if(top + height >= freezenTop){
                            if(top + height < freezenTop + offTop){
                                $("#jfgrid-cell-selected-focus").show().css({
                                    "top": top + offTop,
                                    "height": freezenTop - top
                                })
                            }
                            else{
                                $("#jfgrid-cell-selected-focus").show().css({
                                    "top": top + offTop,
                                    "height": height - offTop
                                })
                            }
                        }
                        else{
                            $("#jfgrid-cell-selected-focus").show().css("top", top + offTop);
                        }

                        if(left >= freezenLeft){
                            if(left + width < freezenLeft + offLeft){
                                focuscell = false;
                            }
                            else if(left < freezenLeft + offLeft){ 
                                $("#jfgrid-cell-selected-focus").show().css({
                                    "left": freezenLeft + offLeft,
                                    "width": width - (freezenLeft + offLeft - left)
                                })
                            }
                            else{
                                $("#jfgrid-cell-selected-focus").show().css({
                                    "left": left,
                                    "width": width
                                });
                            }
                        }
                        else if(left + width >= freezenLeft){
                            if(left + width < freezenLeft + offLeft){
                                $("#jfgrid-cell-selected-focus").show().css({
                                    "left": left + offLeft,
                                    "width": freezenLeft - left
                                })
                            }
                            else{
                                $("#jfgrid-cell-selected-focus").show().css({
                                    "left": left + offLeft,
                                    "width": width - offLeft
                                })
                            }
                        }
                        else{
                            $("#jfgrid-cell-selected-focus").show().css("left", left + offLeft);
                        }

                        if(!focuscell){
                            $("#jfgrid-cell-selected-focus").hide();
                        }
                    }
                }
            }
            else if (jfgrid.freezen.freezenhorizontaldata != null) {
                var freezenTop = jfgrid.freezen.freezenhorizontaldata[0];
                var freezen_rowindex = jfgrid.freezen.freezenhorizontaldata[1];
                var offTop = scrollTop - jfgrid.freezen.freezenhorizontaldata[2];

                for(var s = 0; s < jfgird_select_save.length; s++){
                    var obj = $.extend(true, {}, jfgird_select_save[s]);

                    var r1 = obj.row[0], 
                        r2 = obj.row[1];

                    var row = visibledatarow[r2], row_pre = r1 - 1 == -1 ? 0 : visibledatarow[r1 - 1];

                    var top_move = row_pre;
                    var height_move = row - row_pre - 1;

                    if(r1 >= freezen_rowindex){//原选区在冻结区外
                        if(top_move + height_move < freezenTop + offTop){
                            $("#jfgrid-cell-selected-boxs").find(".jfgrid-cell-selected").eq(s).hide();
                        }
                        else if(top_move < freezenTop + offTop){
                            $("#jfgrid-cell-selected-boxs").find(".jfgrid-cell-selected").eq(s).show().css({
                                "top": freezenTop + offTop,
                                "height": height_move - (freezenTop + offTop - top_move)
                            });
                        }
                        else{
                            $("#jfgrid-cell-selected-boxs").find(".jfgrid-cell-selected").eq(s).show().css({
                                "top": top_move,
                                "height": height_move
                            });
                        }
                    }
                    else if(r2 >= freezen_rowindex){//原选区有一部分在冻结区内
                        if(top_move + height_move < freezenTop + offTop){
                            $("#jfgrid-cell-selected-boxs").find(".jfgrid-cell-selected").eq(s).show().css({
                                "top": top_move + offTop,
                                "height": freezenTop - top_move
                            });
                        }
                        else{
                            $("#jfgrid-cell-selected-boxs").find(".jfgrid-cell-selected").eq(s).show().css({
                                "top": top_move + offTop,
                                "height": height_move - offTop
                            });
                        }
                    }
                    else{//原选区在冻结区内
                        $("#jfgrid-cell-selected-boxs").find(".jfgrid-cell-selected").eq(s).show().css("top", top_move + offTop);
                    }

                    if(s == jfgird_select_save.length - 1){
                        var rf = obj.row_focus == null ? r1 : obj.row_focus;
                        var cf = obj.column_focus == null ? obj.column[0] : obj.column_focus;
                        
                        var row_f = visibledatarow[rf], row_pre_f = rf - 1 == -1 ? 0 : visibledatarow[rf - 1];

                        var margeset = jfgrid.menuButton.mergeborer(jfgrid.flowdata, rf, cf);
                        if(!!margeset){
                            row_f = margeset.row[1];
                            row_pre_f = margeset.row[0];
                        }

                        var top = row_pre_f;
                        var height = row_f - row_pre_f - 1;

                        if(top >= freezenTop){
                            if(top + height < freezenTop + offTop){
                                $("#jfgrid-cell-selected-focus").hide();
                            }
                            else if(top < freezenTop + offTop){ 
                                $("#jfgrid-cell-selected-focus").show().css({
                                    "top": freezenTop + offTop,
                                    "height": height - (freezenTop + offTop - top)
                                })
                            }
                            else{
                                $("#jfgrid-cell-selected-focus").show().css({
                                    "top": top,
                                    "height": height
                                });
                            }
                        }
                        else if(top + height >= freezenTop){
                            if(top + height < freezenTop + offTop){
                                $("#jfgrid-cell-selected-focus").show().css({
                                    "top": top + offTop,
                                    "height": freezenTop - top
                                })
                            }
                            else{
                                $("#jfgrid-cell-selected-focus").show().css({
                                    "top": top + offTop,
                                    "height": height - offTop
                                })
                            }
                        }
                        else{
                            $("#jfgrid-cell-selected-focus").show().css("top", top + offTop);
                        }
                    }
                }
            }
            else if(jfgrid.freezen.freezenverticaldata != null){
                var freezenLeft = jfgrid.freezen.freezenverticaldata[0];
                var freezen_colindex = jfgrid.freezen.freezenverticaldata[1];
                var offLeft = scrollLeft - jfgrid.freezen.freezenverticaldata[2];

                for(var s = 0; s < jfgird_select_save.length; s++){
                    var obj = $.extend(true, {}, jfgird_select_save[s]);

                    var c1 = obj.column[0], 
                        c2 = obj.column[1];

                    var col = visibledatacolumn[c2], col_pre = c1 - 1 == -1 ? 0 : visibledatacolumn[c1 - 1];

                    var left_move = col_pre;
                    var width_move = col - col_pre - 1;

                    if(c1 >= freezen_colindex){//原选区在冻结区外
                        if(left_move + width_move < freezenLeft + offLeft){
                            $("#jfgrid-cell-selected-boxs").find(".jfgrid-cell-selected").eq(s).hide();
                        }
                        else if(left_move < freezenLeft + offLeft){
                            $("#jfgrid-cell-selected-boxs").find(".jfgrid-cell-selected").eq(s).show().css({
                                "left": freezenLeft + offLeft,
                                "width": width_move - (freezenLeft + offLeft - left_move)
                            });
                        }
                        else{
                            $("#jfgrid-cell-selected-boxs").find(".jfgrid-cell-selected").eq(s).show().css({
                                "left": left_move,
                                "width": width_move
                            });
                        }
                    }
                    else if(c2 >= freezen_colindex){//原选区有一部分在冻结区内
                        if(left_move + width_move < freezenLeft + offLeft){
                            $("#jfgrid-cell-selected-boxs").find(".jfgrid-cell-selected").eq(s).show().css({
                                "left": left_move + offLeft,
                                "width": freezenLeft - left_move
                            });
                        }
                        else{
                            $("#jfgrid-cell-selected-boxs").find(".jfgrid-cell-selected").eq(s).show().css({
                                "left": left_move + offLeft,
                                "width": width_move - offLeft
                            });
                        }
                    }
                    else{//原选区在冻结区内
                        $("#jfgrid-cell-selected-boxs").find(".jfgrid-cell-selected").eq(s).show().css("left", left_move + offLeft);
                    }

                    if(s == jfgird_select_save.length - 1){
                        var rf = obj.row_focus == null ? obj.row[0] : obj.row_focus;
                        var cf = obj.column_focus == null ? c1 : obj.column_focus;
                        
                        var col_f = visibledatacolumn[cf], col_pre_f = cf - 1 == -1 ? 0 : visibledatacolumn[cf - 1];

                        var margeset = jfgrid.menuButton.mergeborer(jfgrid.flowdata, rf, cf);
                        if(!!margeset){
                            col_f = margeset.row[1];
                            col_pre_f = margeset.row[0];
                        }

                        var left = col_pre_f;
                        var width = col_f - col_pre_f - 1;

                        if(left >= freezenLeft){
                            if(left + width < freezenLeft + offLeft){
                                $("#jfgrid-cell-selected-focus").hide();
                            }
                            else if(left < freezenLeft + offLeft){ 
                                $("#jfgrid-cell-selected-focus").show().css({
                                    "left": freezenLeft + offLeft,
                                    "width": width - (freezenLeft + offLeft - left)
                                })
                            }
                            else{
                                $("#jfgrid-cell-selected-focus").show().css({
                                    "left": left,
                                    "width": width
                                });
                            }
                        }
                        else if(left + width >= freezenLeft){
                            if(left + width < freezenLeft + offLeft){
                                $("#jfgrid-cell-selected-focus").show().css({
                                    "left": left + offLeft,
                                    "width": freezenLeft - left
                                })
                            }
                            else{
                                $("#jfgrid-cell-selected-focus").show().css({
                                    "left": left + offLeft,
                                    "width": width - offLeft
                                })
                            }
                        }
                        else{
                            $("#jfgrid-cell-selected-focus").show().css("left", left + offLeft);
                        }
                    }
                }
            }
            else{
                jfgrid.selectHightlightShow();
            }
        },
        scrollAdaptOfchart: function(){
            var scrollTop = $("#jfgrid-cell-main").scrollTop();
            var scrollLeft = $("#jfgrid-cell-main").scrollLeft();

            if(jfgrid.freezen.freezenhorizontaldata != null && jfgrid.freezen.freezenverticaldata != null){
                var freezenTop = jfgrid.freezen.freezenhorizontaldata[0] - jfgrid.freezen.freezenhorizontaldata[2];
                var freezenLeft = jfgrid.freezen.freezenverticaldata[0] - jfgrid.freezen.freezenverticaldata[2];

                $("#jfgrid-cell-main .jfgrid-data-visualization-chart").each(function(i, e){
                    var x = $(e).position();
                    var width = $(e).width();
                    var height = $(e).height();

                    var $canvas_width = $(e).find("canvas").width();
                    var $canvas_height = $(e).find("canvas").height();

                    var height_diff = $canvas_height - height;
                    var width_diff = $canvas_width - width;

                    if((x.top - height_diff) < freezenTop){
                        var size = freezenTop - (x.top - height_diff);

                        if(size > ($canvas_height + 40 + 2)){
                            $(e).css("visibility", "hidden");
                        }
                        else{
                            $(e).css({
                                "top": freezenTop + scrollTop,
                                "height": $canvas_height - size,
                                "visibility": "visible"
                            });   
                            $(e).find("canvas").css("top", - size);
                        }
                    }
                    else{
                        $(e).css({
                            "top": x.top - height_diff + scrollTop,
                            "height": $canvas_height,
                            "visibility": "visible"
                        }); 
                        $(e).find("canvas").css("top", 0);
                    }

                    if((x.left - width_diff) < freezenLeft){
                        var size = freezenLeft - (x.left - width_diff);

                        if(size > ($canvas_width + 20 + 2)){
                            $(e).css("visibility", "hidden");
                        }
                        else{
                            $(e).css({
                                "left": freezenLeft + scrollLeft,
                                "width": $canvas_width - size,
                                "visibility": "visible"
                            });   
                            $(e).find("canvas").css("left", - size);
                        }
                    }
                    else{
                        $(e).css({
                            "left": x.left - width_diff + scrollLeft,
                            "width": $canvas_width,
                            "visibility": "visible"
                        }); 
                        $(e).find("canvas").css("left", 0);
                    }
                })
            }
            else if(jfgrid.freezen.freezenhorizontaldata != null){
                var freezenTop = jfgrid.freezen.freezenhorizontaldata[0] - jfgrid.freezen.freezenhorizontaldata[2];

                $("#jfgrid-cell-main .jfgrid-data-visualization-chart").each(function(i, e){
                    var x = $(e).position();
                    var height = $(e).height();
                    
                    var $canvas_height = $(e).find("canvas").height();

                    var height_diff = $canvas_height - height;

                    if((x.top - height_diff) < freezenTop){
                        var size = freezenTop - (x.top - height_diff);

                        if(size > ($canvas_height + 40 + 2)){
                            $(e).css("visibility", "hidden");
                        }
                        else{
                            $(e).css({
                                "top": freezenTop + scrollTop,
                                "height": $canvas_height - size,
                                "visibility": "visible"
                            });   
                            $(e).find("canvas").css("top", - size);
                        }
                    }
                    else{
                        $(e).css({
                            "top": x.top - height_diff + scrollTop,
                            "height": $canvas_height,
                            "visibility": "visible"
                        }); 
                        $(e).find("canvas").css("top", 0);
                    }
                })
            }
            else if(jfgrid.freezen.freezenverticaldata != null){
                var freezenLeft = jfgrid.freezen.freezenverticaldata[0] - jfgrid.freezen.freezenverticaldata[2];

                $("#jfgrid-cell-main .jfgrid-data-visualization-chart").each(function(i, e){
                    var x = $(e).position();
                    var width = $(e).width();

                    var $canvas_width = $(e).find("canvas").width();

                    var width_diff = $canvas_width - width;

                    if((x.left - width_diff) < freezenLeft){
                        var size = freezenLeft - (x.left - width_diff);

                        if(size > ($canvas_width + 20 + 2)){
                            $(e).css("visibility", "hidden");
                        }
                        else{
                            $(e).css({
                                "left": freezenLeft + scrollLeft,
                                "width": $canvas_width - size,
                                "visibility": "visible"
                            });   
                            $(e).find("canvas").css("left", - size);
                        }
                    }
                    else{
                        $(e).css({
                            "left": x.left - width_diff + scrollLeft,
                            "width": $canvas_width,
                            "visibility": "visible"
                        }); 
                        $(e).find("canvas").css("left", 0);
                    }
                })
            }
            else{
                $("#jfgrid-cell-main .jfgrid-data-visualization-chart").each(function(i, e){
                    var x = $(e).position();
                    var width = $(e).width();
                    var height = $(e).height();

                    var $canvas_width = $(e).find("canvas").width();
                    var $canvas_height = $(e).find("canvas").height();

                    var height_diff = $canvas_height - height;
                    var width_diff = $canvas_width - width;

                    $(e).css({
                        "top": x.top - height_diff + scrollTop,
                        "height": $canvas_height,
                        "left": x.left - width_diff + scrollLeft,
                        "width": $canvas_width,
                        "visibility": "visible"
                    }); 

                    $(e).find("canvas").css({
                        "top": 0,
                        "left": 0
                    });
                })
            }
        },
        scrollAdaptOfpostil: function(){
            var scrollTop = $("#jfgrid-cell-main").scrollTop();
            var scrollLeft = $("#jfgrid-cell-main").scrollLeft();

            if(jfgrid.freezen.freezenhorizontaldata != null && jfgrid.freezen.freezenverticaldata != null){
                var freezenTop = jfgrid.freezen.freezenhorizontaldata[0];
                var freezenLeft = jfgrid.freezen.freezenverticaldata[0];

                var offTop = scrollTop - jfgrid.freezen.freezenhorizontaldata[2];
                var offLeft = scrollLeft - jfgrid.freezen.freezenverticaldata[2];

                $("#jfgrid-postil-showBoxs .jfgrid-postil-show").each(function(i, e){
                    var id = $(e).attr("id");

                    var r = id.split("jfgrid-postil-show_")[1].split("_")[0];
                    var c = id.split("jfgrid-postil-show_")[1].split("_")[1];

                    var postil = jfgrid.flowdata[r][c].ps;

                    var row = visibledatarow[r], row_pre = r - 1 == -1 ? 0 : visibledatarow[r - 1];
                    var col = visibledatacolumn[c], col_pre = c - 1 == -1 ? 0 : visibledatacolumn[c - 1];

                    var margeset = jfgrid.menuButton.mergeborer(jfgrid.flowdata, r, c);
                    if(!!margeset){
                        row = margeset.row[1];
                        row_pre = margeset.row[0];
                        
                        col = margeset.column[1];
                        col_pre = margeset.column[0];
                    }

                    var toX = col;
                    var toY = row_pre;

                    var postil_left = postil["left"] == null ? toX + 18 : postil["left"];
                    var postil_top = postil["top"] == null ? toY - 18 : postil["top"];
                    var postil_width = postil["width"] == null ? jfgrid.postil.defaultWidth : postil["width"];
                    var postil_height = postil["height"] == null ? jfgrid.postil.defaultHeight : postil["height"];

                    if(postil_top < 0){
                        postil_top = 2;
                    }

                    var size = jfgrid.postil.getArrowCanvasSize(postil_left, postil_top, toX, toY);
                    var show = true;
                    var show2 = true;

                    if(postil_top + postil_height < freezenTop){
                        $(e).show().find(".jfgrid-postil-show-main").css("top", postil_top + offTop);
                        $(e).show().find(".arrowCanvas").css("top", size[1] + offTop);
                    }
                    else{
                        if(postil_top < freezenTop + offTop){
                            if(postil_top + postil_height <= freezenTop + offTop){
                                show = false;
                            }
                            else{
                                $(e).show().find(".jfgrid-postil-show-main").css({ "top": freezenTop + offTop, "height": postil_height - (freezenTop + offTop - postil_top) });
                                $(e).show().find(".formulaInputFocus").css("margin-top", -(freezenTop + offTop - postil_top));
                                $(e).show().find(".arrowCanvas").hide(); 

                                show2 = false;
                            }
                        }
                        else{
                            $(e).show().find(".jfgrid-postil-show-main").css({
                                "top": postil_top,
                                "height": postil_height
                            });
                            $(e).show().find(".formulaInputFocus").css("margin-top", 0);
                            $(e).show().find(".arrowCanvas").css("top", size[1]);
                            // jfgrid.postil.buildPs(r, c, postil);
                        }
                    }

                    if(postil_left + postil_width < freezenLeft){
                        $(e).show().find(".jfgrid-postil-show-main").css("left", postil_left + offLeft);
                        $(e).show().find(".arrowCanvas").css("left", size[0] + offLeft);
                    }
                    else{
                        if(postil_left < freezenLeft + offLeft){
                            if(postil_left + postil_width <= freezenLeft + offLeft){
                                show = false;
                            }
                            else{
                                $(e).show().find(".jfgrid-postil-show-main").css({ "left": freezenLeft + offLeft, "width": postil_width - (freezenLeft + offLeft - postil_left) });
                                $(e).show().find(".formulaInputFocus").css("margin-left", -(freezenLeft + offLeft - postil_left));
                                $(e).show().find(".arrowCanvas").hide(); 

                                show2 = false;
                            }
                        }
                        else{
                            $(e).show().find(".jfgrid-postil-show-main").css({
                                "left": postil_left,
                                "width": postil_width   
                            });
                            $(e).show().find(".formulaInputFocus").css("margin-left", 0);
                            $(e).show().find(".arrowCanvas").css("left", size[0]);
                            // jfgrid.postil.buildPs(r, c, postil);
                        }
                    }

                    if(!show){
                        $(e).hide();
                    }

                    if(show && show2){
                        $(e).show().find(".arrowCanvas").show();
                    }
                })
            }
            else if(jfgrid.freezen.freezenhorizontaldata != null){
                var freezenTop = jfgrid.freezen.freezenhorizontaldata[0];
                var offTop = scrollTop - jfgrid.freezen.freezenhorizontaldata[2];

                $("#jfgrid-postil-showBoxs .jfgrid-postil-show").each(function(i, e){
                    var id = $(e).attr("id");

                    var r = id.split("jfgrid-postil-show_")[1].split("_")[0];
                    var c = id.split("jfgrid-postil-show_")[1].split("_")[1];

                    var postil = jfgrid.flowdata[r][c].ps;

                    var row = visibledatarow[r], row_pre = r - 1 == -1 ? 0 : visibledatarow[r - 1];
                    var col = visibledatacolumn[c], col_pre = c - 1 == -1 ? 0 : visibledatacolumn[c - 1];

                    var margeset = jfgrid.menuButton.mergeborer(jfgrid.flowdata, r, c);
                    if(!!margeset){
                        row = margeset.row[1];
                        row_pre = margeset.row[0];
                        
                        col = margeset.column[1];
                        col_pre = margeset.column[0];
                    }

                    var toX = col;
                    var toY = row_pre;

                    var postil_left = postil["left"] == null ? toX + 18 : postil["left"];
                    var postil_top = postil["top"] == null ? toY - 18 : postil["top"];
                    var postil_width = postil["width"] == null ? jfgrid.postil.defaultWidth : postil["width"];
                    var postil_height = postil["height"] == null ? jfgrid.postil.defaultHeight : postil["height"];

                    if(postil_top < 0){
                        postil_top = 2;
                    }

                    var size = jfgrid.postil.getArrowCanvasSize(postil_left, postil_top, toX, toY);

                    if(postil_top + postil_height < freezenTop){
                        $(e).show().find(".jfgrid-postil-show-main").css("top", postil_top + offTop);
                        $(e).show().find(".arrowCanvas").css("top", size[1] + offTop);
                    }
                    else{
                        if(postil_top < freezenTop + offTop){
                            if(postil_top + postil_height <= freezenTop + offTop){
                                $(e).hide();
                            }
                            else{
                                $(e).show().find(".jfgrid-postil-show-main").css({ "top": freezenTop + offTop, "height": postil_height - (freezenTop + offTop - postil_top) });
                                $(e).show().find(".formulaInputFocus").css("margin-top", -(freezenTop + offTop - postil_top));
                                $(e).show().find(".arrowCanvas").hide(); 
                            }
                        }
                        else{
                            jfgrid.postil.buildPs(r, c, postil);
                        }
                    }
                })
            }
            else if(jfgrid.freezen.freezenverticaldata != null){
                var freezenLeft = jfgrid.freezen.freezenverticaldata[0];
                var offLeft = scrollLeft - jfgrid.freezen.freezenverticaldata[2];

                $("#jfgrid-postil-showBoxs .jfgrid-postil-show").each(function(i, e){
                    var id = $(e).attr("id");

                    var r = id.split("jfgrid-postil-show_")[1].split("_")[0];
                    var c = id.split("jfgrid-postil-show_")[1].split("_")[1];

                    var postil = jfgrid.flowdata[r][c].ps;

                    var row = visibledatarow[r], row_pre = r - 1 == -1 ? 0 : visibledatarow[r - 1];
                    var col = visibledatacolumn[c], col_pre = c - 1 == -1 ? 0 : visibledatacolumn[c - 1];

                    var margeset = jfgrid.menuButton.mergeborer(jfgrid.flowdata, r, c);
                    if(!!margeset){
                        row = margeset.row[1];
                        row_pre = margeset.row[0];
                        
                        col = margeset.column[1];
                        col_pre = margeset.column[0];
                    }

                    var toX = col;
                    var toY = row_pre;

                    var postil_left = postil["left"] == null ? toX + 18 : postil["left"];
                    var postil_top = postil["top"] == null ? toY - 18 : postil["top"];
                    var postil_width = postil["width"] == null ? jfgrid.postil.defaultWidth : postil["width"];
                    var postil_height = postil["height"] == null ? jfgrid.postil.defaultHeight : postil["height"];

                    if(postil_top < 0){
                        postil_top = 2;
                    }

                    var size = jfgrid.postil.getArrowCanvasSize(postil_left, postil_top, toX, toY);

                    if(postil_left + postil_width < freezenLeft){
                        $(e).show().find(".jfgrid-postil-show-main").css("left", postil_left + offLeft);
                        $(e).show().find(".arrowCanvas").css("left", size[0] + offLeft);
                    }
                    else{
                        if(postil_left < freezenLeft + offLeft){
                            if(postil_left + postil_width <= freezenLeft + offLeft){
                                $(e).hide();
                            }
                            else{
                                $(e).show().find(".jfgrid-postil-show-main").css({ "left": freezenLeft + offLeft, "width": postil_width - (freezenLeft + offLeft - postil_left) });
                                $(e).show().find(".formulaInputFocus").css("margin-left", -(freezenLeft + offLeft - postil_left));
                                $(e).show().find(".arrowCanvas").hide(); 
                            }
                        }
                        else{
                            jfgrid.postil.buildPs(r, c, postil);
                        }
                    }
                })
            }
            else{
                $("#jfgrid-postil-showBoxs .jfgrid-postil-show").each(function(i, e){
                    var id = $(e).attr("id");

                    var r = id.split("jfgrid-postil-show_")[1].split("_")[0];
                    var c = id.split("jfgrid-postil-show_")[1].split("_")[1];

                    var postil = jfgrid.flowdata[r][c].ps;

                    jfgrid.postil.buildPs(r, c, postil);
                })
            }
        },
        scrollAdaptOfdpicon: function(){
            var copy_r = jfgrid.dropCell.copyRange["row"][1], 
                copy_c = jfgrid.dropCell.copyRange["column"][1];
            
            var apply_r = jfgrid.dropCell.applyRange["row"][1], 
                apply_c = jfgrid.dropCell.applyRange["column"][1];
            
            if(apply_r >= copy_r && apply_c >= copy_c){
                var row_index = apply_r;
                var col_index = apply_c;
            }
            else{
                var row_index = copy_r;
                var col_index = copy_c;   
            }

            if(jfgrid.freezen.freezenhorizontaldata != null && jfgrid.freezen.freezenverticaldata != null){
                var freezen_rowindex = jfgrid.freezen.freezenhorizontaldata[1];
                var offsetRow = jfgrid_searcharray(jfgrid.freezen.freezenhorizontaldata[3], $("#jfgrid-cell-main").scrollTop() - jfgrid.freezen.freezenhorizontaldata[2]);
                var freezen_colindex = jfgrid.freezen.freezenverticaldata[1];
                var offsetColumn = jfgrid_searcharray(jfgrid.freezen.freezenverticaldata[3], $("#jfgrid-cell-main").scrollLeft() - jfgrid.freezen.freezenverticaldata[2]);

                if(row_index >= freezen_rowindex && col_index >= freezen_colindex){
                    if(row_index < (freezen_rowindex + offsetRow - 1) || col_index < (freezen_colindex + offsetColumn - 1)){
                        $("#jfgrid-dropCell-icon").hide();
                    }
                    else{
                        $("#jfgrid-dropCell-icon").show();
                    }
                }
                else if(row_index >= freezen_rowindex){
                    if(row_index < (freezen_rowindex + offsetRow - 1)){
                        $("#jfgrid-dropCell-icon").hide();
                    }
                    else{
                        var col = jfgrid.colLocationByIndex(col_index + offsetColumn)[1];

                        $("#jfgrid-dropCell-icon").show().css("left", col);
                    }
                }
                else if(col_index >= freezen_colindex){
                    if(col_index < (freezen_colindex + offsetColumn - 1)){
                        $("#jfgrid-dropCell-icon").hide();
                    }
                    else{
                        var row = jfgrid.rowLocationByIndex(row_index + offsetRow)[1];

                        $("#jfgrid-dropCell-icon").show().css("top", row);
                    }
                }
                else{
                    var row = jfgrid.rowLocationByIndex(row_index + offsetRow)[1],
                        col = jfgrid.colLocationByIndex(col_index + offsetColumn)[1];

                    $("#jfgrid-dropCell-icon").show().css({ "left": col, "top": row });
                }
            }
            else if(jfgrid.freezen.freezenhorizontaldata != null){
                var freezen_rowindex = jfgrid.freezen.freezenhorizontaldata[1];
                var offsetRow = jfgrid_searcharray(jfgrid.freezen.freezenhorizontaldata[3], $("#jfgrid-cell-main").scrollTop() - jfgrid.freezen.freezenhorizontaldata[2]);

                if(row_index >= freezen_rowindex){
                    if(row_index < (freezen_rowindex + offsetRow - 1)){
                        $("#jfgrid-dropCell-icon").hide();
                    }
                    else{
                        $("#jfgrid-dropCell-icon").show();
                    }
                }
                else{
                    var row = jfgrid.rowLocationByIndex(row_index + offsetRow)[1];

                    $("#jfgrid-dropCell-icon").show().css("top", row);
                }
            }
            else if(jfgrid.freezen.freezenverticaldata != null){
                var freezen_colindex = jfgrid.freezen.freezenverticaldata[1];
                var offsetColumn = jfgrid_searcharray(jfgrid.freezen.freezenverticaldata[3], $("#jfgrid-cell-main").scrollLeft() - jfgrid.freezen.freezenverticaldata[2]);

                if(col_index >= freezen_colindex){
                    if(col_index < (freezen_colindex + offsetColumn - 1)){
                        $("#jfgrid-dropCell-icon").hide();
                    }
                    else{
                        $("#jfgrid-dropCell-icon").show();
                    }
                }
                else{
                    var col = jfgrid.colLocationByIndex(col_index + offsetColumn)[1];

                    $("#jfgrid-dropCell-icon").show().css("left", col);
                }
            }
            else{
                var row = jfgrid.rowLocationByIndex(row_index)[1],
                    col = jfgrid.colLocationByIndex(col_index)[1];

                $("#jfgrid-dropCell-icon").show().css({ "left": col, "top": row });
            }
        },
        scrollAdaptOffilteroptions: function(){
            if(jfgrid.freezen.freezenhorizontaldata != null && jfgrid.freezen.freezenverticaldata != null){
                var freezen_rowindex = jfgrid.freezen.freezenhorizontaldata[1];
                var freezen_top = jfgrid.freezen.freezenhorizontaldata[0] + $("#jfgrid-cell-main").scrollTop();

                var freezen_colindex = jfgrid.freezen.freezenverticaldata[1];
                var offsetColumn = jfgrid_searcharray(jfgrid.freezen.freezenverticaldata[3], $("#jfgrid-cell-main").scrollLeft() - jfgrid.freezen.freezenverticaldata[2]);

                $("#jfgrid-filter-options-sheet"+ jfgrid.currentSheetIndex +" .jfgrid-filter-options").each(function(i, e){
                    var row_index = $(e).data("str");
                    var top = row_index - 1 == -1 ? 0 : visibledatarow[row_index - 1];

                    var col_index = $(e).data("cindex");

                    if(row_index >= freezen_rowindex && col_index >= freezen_colindex){
                        if(top < freezen_top || col_index < (freezen_colindex + offsetColumn)){
                            $(e).hide();
                        }
                        else{
                            $(e).show();
                        }
                    }
                    else if(row_index >= freezen_rowindex){
                        if(top < freezen_top){
                            $(e).hide();
                        }
                        else{
                            var left = visibledatacolumn[col_index + offsetColumn] - 20;

                            $(e).show().css("left", left);
                        }
                    }
                    else if(col_index >= freezen_colindex){
                        if(col_index < (freezen_colindex + offsetColumn)){
                            $(e).hide();
                        }
                        else{
                            $(e).show().css("top", top + $("#jfgrid-cell-main").scrollTop());
                        }
                    }
                    else{
                        var left = visibledatacolumn[col_index + offsetColumn] - 20;

                        $(e).show().css({ "left": left, "top": top + $("#jfgrid-cell-main").scrollTop() });
                    }
                });
            }
            else if(jfgrid.freezen.freezenhorizontaldata != null){
                var freezen_rowindex = jfgrid.freezen.freezenhorizontaldata[1];
                var freezen_top = jfgrid.freezen.freezenhorizontaldata[0] + $("#jfgrid-cell-main").scrollTop();

                $("#jfgrid-filter-options-sheet"+ jfgrid.currentSheetIndex +" .jfgrid-filter-options").each(function(i, e){
                    var row_index = $(e).data("str");
                    var top = row_index - 1 == -1 ? 0 : visibledatarow[row_index - 1];

                    if(row_index >= freezen_rowindex){
                        if(top < freezen_top){
                            $(e).hide();
                        }
                        else{
                            $(e).show();
                        }
                    }
                    else{
                        $(e).show().css("top", top + $("#jfgrid-cell-main").scrollTop());
                    }
                });
            }
            else if(jfgrid.freezen.freezenverticaldata != null){
                var freezen_colindex = jfgrid.freezen.freezenverticaldata[1];
                var offsetColumn = jfgrid_searcharray(jfgrid.freezen.freezenverticaldata[3], $("#jfgrid-cell-main").scrollLeft() - jfgrid.freezen.freezenverticaldata[2]);

                $("#jfgrid-filter-options-sheet"+ jfgrid.currentSheetIndex +" .jfgrid-filter-options").each(function(i, e){
                    var col_index = $(e).data("cindex");

                    if(col_index >= freezen_colindex){
                        if(col_index < (freezen_colindex + offsetColumn)){
                            $(e).hide();
                        }
                        else{
                            $(e).show();
                        }
                    }
                    else{
                        var left = visibledatacolumn[col_index + offsetColumn] - 20;

                        $(e).show().css("left", left);
                    }
                });
            }
            else{
                $("#jfgrid-filter-options-sheet"+ jfgrid.currentSheetIndex).empty();
                jfgrid.createFilterOptions(jfgridfile[jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex)].filter_select);
            }
        }
    }

    //条件格式
    jfgrid.conditionformat = {
        fileClone: [],
        editorRule: null, //{"sheetIndex": sheetIndex,"itemIndex": itemIndex,"data": jfgridfile[sheetIndex].jfgrid_conditionformat_save[itemIndex]}
        ruleTypeHtml: '<div class="ruleTypeBox"><div class="ruleTypeItem"><span class="icon">► </span><span>基于各自值设置所有单元格的格式</span></div><div class="ruleTypeItem"><span class="icon">► </span><span>只为包含以下内容的单元格设置格式</span></div><div class="ruleTypeItem"><span class="icon">► </span><span>仅对排名靠前或靠后的数值设置格式</span></div><div class="ruleTypeItem"><span class="icon">► </span><span>仅对高于或低于平均值的数值设置格式</span></div><div class="ruleTypeItem"><span class="icon">► </span><span>仅对唯一值或重复值设置格式</span></div></div>',
        textCellColorHtml: '<div id="textCellColor"><div class="colorbox"><input id="checkTextColor" type="checkbox" checked="checked"><label for="checkTextColor">文本颜色：</label><input id="textcolorshow" data-tips="文本颜色" data-func="background" class="jfgrid-conditionformat-config-color" type="text" value="#9c0006" style="display: none;"></div><div class="colorbox"><input id="checkCellColor" type="checkbox" checked="checked"><label for="checkCellColor">单元格颜色：</label><input id="cellcolorshow" data-tips="单元格颜色" data-func="background" class="jfgrid-conditionformat-config-color" type="text" value="#ffc7ce" style="display: none;"></div></div>',
        selectRange: [],
        selectStatus: false,
        dataBarList: [
            { "format": ["#638ec6", "#ffffff"] },  //蓝-白渐变 数据条
            { "format": ["#63c384", "#ffffff"] },  //绿-白渐变 数据条
            { "format": ["#ff555a", "#ffffff"] },  //红-白渐变 数据条
            { "format": ["#ffb628", "#ffffff"] },  //橙-白渐变 数据条
            { "format": ["#008aef", "#ffffff"] },  //浅蓝-白渐变 数据条
            { "format": ["#d6007b", "#ffffff"] },  //紫-白渐变 数据条

            { "format": ["#638ec6"] },  //蓝色 数据条
            { "format": ["#63c384"] },  //绿色 数据条
            { "format": ["#ff555a"] },  //红色 数据条
            { "format": ["#ffb628"] },  //橙色 数据条
            { "format": ["#008aef"] },  //浅蓝色 数据条
            { "format": ["#d6007b"] }   //紫色 数据条
        ],
        colorGradationList: [
            { "format": ["rgb(99, 190, 123)", "rgb(255, 235, 132)", "rgb(248, 105, 107)"] },  //绿-黄-红色阶
            { "format": ["rgb(248, 105, 107)", "rgb(255, 235, 132)", "rgb(99, 190, 123)"] },  //红-黄-绿色阶

            { "format": ["rgb(99, 190, 123)", "rgb(252, 252, 255)", "rgb(248, 105, 107)"] },  //绿-白-红色阶
            { "format": ["rgb(248, 105, 107)", "rgb(252, 252, 255)", "rgb(99, 190, 123)"] },  //红-白-绿色阶
            
            { "format": ["rgb(90, 138, 198)", "rgb(252, 252, 255)", "rgb(248, 105, 107)"] },  //蓝-白-红色阶
            { "format": ["rgb(248, 105, 107)", "rgb(252, 252, 255)", "rgb(90, 138, 198)"] },  //红-白-蓝色阶
            
            { "format": ["rgb(252, 252, 255)", "rgb(248, 105, 107)"] },  //白-红色阶
            { "format": ["rgb(248, 105, 107)", "rgb(252, 252, 255)"] },  //红-白色阶

            { "format": ["rgb(99, 190, 123)", "rgb(252, 252, 255)"] },  //绿-白色阶
            { "format": ["rgb(252, 252, 255)", "rgb(99, 190, 123)"] },  //白-绿色阶

            { "format": ["rgb(99, 190, 123)", "rgb(255, 235, 132)"] },  //绿-黄色阶
            { "format": ["rgb(255, 235, 132)", "rgb(99, 190, 123)"] }   //黄-绿色阶
        ],
        init: function(){
            // 管理规则
            $(document).off("change.CFchooseSheet").on("change.CFchooseSheet", "#jfgrid-administerRule-dialog .chooseSheet", function(){
                var index = $("#jfgrid-administerRule-dialog .chooseSheet option:selected").val();
                jfgrid.conditionformat.getConditionRuleList(index);
            });
            $(document).off("click.CFadministerRuleItem").on("click.CFadministerRuleItem", "#jfgrid-administerRule-dialog .ruleList .listBox .item", function(){
                $(this).addClass("on").siblings().removeClass("on");
            });

            $(document).off("click.CFadministerRuleConfirm").on("click.CFadministerRuleConfirm", "#jfgrid-administerRule-dialog-confirm", function(){
                //保存之前的规则
                var fileH = $.extend(true, [], jfgrid.getjfgridfile());
                var historyRules = jfgrid.conditionformat.getHistoryRules(fileH);
                
                //保存当前的规则
                var fileClone = $.extend(true, [], jfgrid.conditionformat.fileClone);
                for(var c = 0; c < fileClone.length; c++){
                    var sheetIndex = fileClone[c]["index"];
                    jfgridfile[jfgrid.sheetmanage.getSheetIndex(sheetIndex)]["jfgrid_conditionformat_save"] = fileClone[jfgrid.sheetmanage.getSheetIndex(sheetIndex)]["jfgrid_conditionformat_save"];
                }

                var fileC = $.extend(true, [], jfgrid.getjfgridfile());
                var currentRules = jfgrid.conditionformat.getCurrentRules(fileC);
                
                //刷新一次表格
                jfgrid.conditionformat.ref(historyRules, currentRules);
                
                //隐藏一些dom
                $("#jfgrid-modal-dialog-mask").hide();
                $("#jfgrid-administerRule-dialog").hide();

                //发送给后台
                if(jfgrid.server.allowUpdate){
                    var files = $.extend(true, [], jfgrid.getjfgridfile());
                    for(var i = 0; i < files.length; i++){
                        jfgrid.server.saveParam("all", files[i]["index"], files[i]["jfgrid_conditionformat_save"], { "k": "jfgrid_conditionformat_save" });
                    }
                }
            });

            $(document).off("click.CFadministerRuleClose").on("click.CFadministerRuleClose", "#jfgrid-administerRule-dialog-close", function(){
                $("#jfgrid-modal-dialog-mask").hide();
                $("#jfgrid-administerRule-dialog").hide();
                jfgrid.conditionformat.fileClone = [];
            });
            $(document).off("click.CFadministerRuleFa").on("click.CFadministerRuleFa", "#jfgrid-administerRule-dialog .item .fa-table", function(){
                $(this).parents("#jfgrid-administerRule-dialog").hide();

                var sheetIndex = $("#jfgrid-administerRule-dialog .chooseSheet select option:selected").val();
                if(sheetIndex != jfgrid.currentSheetIndex){
                    jfgrid.sheetmanage.changeSheetExec(sheetIndex);
                }

                var txt = $(this).siblings("input").val().trim();
                var dataItem = $(this).parents(".item").attr("data-item");

                jfgrid.conditionformat.multiRangeDialog(dataItem, txt);

                jfgrid.conditionformat.selectRange = [];

                var range = jfgrid.conditionformat.getRangeByTxt(txt);
                if(range.length > 0){
                    for(var s = 0; s < range.length; s++){
                        var r1 = range[s].row[0], r2 = range[s].row[1];
                        var c1 = range[s].column[0], c2 = range[s].column[1];

                        var row = visibledatarow[r2], row_pre = r1 - 1 == -1 ? 0 : visibledatarow[r1 - 1];
                        var col = visibledatacolumn[c2], col_pre = c1 - 1 == -1 ? 0 : visibledatacolumn[c1 - 1];

                        jfgrid.conditionformat.selectRange.push({ 
                            "left": col_pre, 
                            "width": col - col_pre - 1, 
                            "top": row_pre, 
                            "height": row - row_pre - 1, 
                            "left_move": col_pre, 
                            "width_move": col - col_pre - 1, 
                            "top_move": row_pre, 
                            "height_move": row - row_pre - 1, 
                            "row": [r1, r2], 
                            "column": [c1, c2], 
                            "row_focus": r1, 
                            "column_focus": c1 
                        });
                    }
                }
                
                jfgrid.selectionCopyShow(jfgrid.conditionformat.selectRange);
            });
            $(document).off("click.CFmultiRangeConfirm").on("click.CFmultiRangeConfirm", "#jfgrid-multiRange-dialog-confirm", function(){
                $(this).parents("#jfgrid-multiRange-dialog").hide();

                var dataItem = $(this).attr("data-item");
                var v = $(this).parents("#jfgrid-multiRange-dialog").find("input").val();
                $("#jfgrid-administerRule-dialog .item[data-item="+dataItem+"] input").val(v);

                var sheetIndex = $("#jfgrid-administerRule-dialog .chooseSheet option:selected").val();
                jfgrid.conditionformat.fileClone[jfgrid.sheetmanage.getSheetIndex(sheetIndex)]["jfgrid_conditionformat_save"][dataItem].cellrange = jfgrid.conditionformat.getRangeByTxt(v);
                
                $("#jfgrid-modal-dialog-mask").show();
                $("#jfgrid-administerRule-dialog").show();

                var range = [];
                jfgrid.selectionCopyShow(range);
            });
            $(document).off("click.CFmultiRangeClose").on("click.CFmultiRangeClose", "#jfgrid-multiRange-dialog-close", function(){
                $(this).parents("#jfgrid-multiRange-dialog").hide();
                $("#jfgrid-modal-dialog-mask").show();
                $("#jfgrid-administerRule-dialog").show();

                $("#jfgrid-formula-functionrange-select").hide();
                $("#jfgrid-row-count-show").hide();
                $("#jfgrid-column-count-show").hide();

                var range = [];
                jfgrid.selectionCopyShow(range);
            });
            
            // 新建规则
            $(document).off("click.CFnewConditionRule").on("click.CFnewConditionRule", "#newConditionRule", function(){
                if(jfgird_select_save.length == 0){
                    if(jfgrid.isEditMode()){
                        alert("请选择应用范围");
                    }
                    else{
                        jfgrid.tooltip.info("请选择应用范围", "");
                    }
                    return;
                }
                
                jfgrid.conditionformat.newConditionRuleDialog(1);
            });
            $(document).off("click.CFnewConditionRuleConfirm").on("click.CFnewConditionRuleConfirm", "#jfgrid-newConditionRule-dialog-confirm", function(){
                var index = $("#jfgrid-newConditionRule-dialog .ruleTypeItem.on").index();
                var type1 = $("#jfgrid-newConditionRule-dialog #type1 option:selected").val();
                var type2 = $("#jfgrid-newConditionRule-dialog ." + type1 + "Box #type2 option:selected").val();
                
                var format;
                if(index == 0){
                    if(type1 == "dataBar"){ //数据条
                        var color = $(this).parents("#jfgrid-newConditionRule-dialog").find(".dataBarBox .jfgrid-conditionformat-config-color").spectrum("get").toHexString();

                        if(type2 == "gradient"){ //渐变填充
                            format = [color, "#ffffff"];
                        }
                        else if(type2 == "solid"){ //实心填充
                            format = [color];
                        }

                        var rule = {
                            "type": "dataBar", 
                            "cellrange": $.extend(true, [], jfgird_select_save), 
                            "format": format
                        };
                    }
                    else if(type1 == "colorGradation"){ //色阶
                        var maxcolor = $(this).parents("#jfgrid-newConditionRule-dialog").find(".colorGradationBox .maxVal .jfgrid-conditionformat-config-color").spectrum("get").toRgbString();
                        var midcolor = $(this).parents("#jfgrid-newConditionRule-dialog").find(".colorGradationBox .midVal .jfgrid-conditionformat-config-color").spectrum("get").toRgbString();
                        var mincolor = $(this).parents("#jfgrid-newConditionRule-dialog").find(".colorGradationBox .minVal .jfgrid-conditionformat-config-color").spectrum("get").toRgbString();

                        if(type2 == "threeColor"){ //三色
                            format = [maxcolor, midcolor, mincolor];
                        }
                        else if(type2 == "twoColor"){ //双色
                            format = [maxcolor, mincolor];
                        }

                        var rule = {
                            "type": "colorGradation", 
                            "cellrange": $.extend(true, [], jfgird_select_save), 
                            "format": format
                        };
                    }
                    else if(type1 == "icons"){ //图标集
                        var len = $(this).parents("#jfgrid-newConditionRule-dialog").find(".iconsBox .model").attr("data-len");
                        var leftMin = $(this).parents("#jfgrid-newConditionRule-dialog").find(".iconsBox .model").attr("data-leftmin");
                        var top = $(this).parents("#jfgrid-newConditionRule-dialog").find(".iconsBox .model").attr("data-top");

                        format = {
                            "len": len, 
                            "leftMin": leftMin,
                            "top": top
                        };

                        var rule = {
                            "type": "icons", 
                            "cellrange": $.extend(true, [], jfgird_select_save), 
                            "format": format
                        };
                    }
                }
                else{
                    var conditionName = "", conditionRange = [], conditionValue = [];

                    if(index == 1){
                        if(type1 == "number"){ //单元格值
                            conditionName = type2;

                            if(type2 == "betweenness"){
                                var v1 = $("#jfgrid-newConditionRule-dialog #conditionVal input").val().trim();
                                var v2 = $("#jfgrid-newConditionRule-dialog #conditionVal2 input").val().trim();

                                //条件值是否是选区
                                var rangeArr1 = jfgrid.conditionformat.getRangeByTxt(v1);
                                if(rangeArr1.length > 1){
                                    jfgrid.conditionformat.infoDialog("只能对单个单元格进行引用", "");
                                    return;
                                }
                                else if(rangeArr1.length == 1){
                                    var r1 = rangeArr1[0].row[0], r2 = rangeArr1[0].row[1];
                                    var c1 = rangeArr1[0].column[0], c2 = rangeArr1[0].column[1];

                                    if(r1 == r2 && c1 == c2){
                                        v1 = jfgrid.getcellvalue(r1, c1, jfgrid.flowdata);
                                        
                                        conditionRange.push({ "row": rangeArr1[0].row, "column": rangeArr1[0].column });
                                        conditionValue.push(v1);
                                    }
                                    else{
                                        jfgrid.conditionformat.infoDialog("只能对单个单元格进行引用", "");
                                        return;
                                    }
                                }
                                else if(rangeArr1.length == 0){
                                    if(isNaN(v1) || v1 == ""){
                                        jfgrid.conditionformat.infoDialog("条件值只能是数字或者单个单元格", "");
                                        return;
                                    }
                                    else{
                                        conditionValue.push(v1);
                                    }
                                }

                                var rangeArr2 = jfgrid.conditionformat.getRangeByTxt(v2);
                                if(rangeArr2.length > 1){
                                    jfgrid.conditionformat.infoDialog("只能对单个单元格进行引用", "");
                                    return;
                                }
                                else if(rangeArr2.length == 1){
                                    var r1 = rangeArr2[0].row[0], r2 = rangeArr2[0].row[1];
                                    var c1 = rangeArr2[0].column[0], c2 = rangeArr2[0].column[1];

                                    if(r1 == r2 && c1 == c2){
                                        v2 = jfgrid.getcellvalue(r1, c1, jfgrid.flowdata);
                                        
                                        conditionRange.push({ "row": rangeArr2[0].row, "column": rangeArr2[0].column });
                                        conditionValue.push(v2);
                                    }
                                    else{
                                        jfgrid.conditionformat.infoDialog("只能对单个单元格进行引用", "");
                                        return;
                                    }
                                }
                                else if(rangeArr2.length == 0){
                                    if(isNaN(v2) || v2 == ""){
                                        jfgrid.conditionformat.infoDialog("条件值只能是数字或者单个单元格", "");
                                        return;
                                    }
                                    else{
                                        conditionValue.push(v2);
                                    }
                                }
                            }
                            else{
                                //条件值
                                var v = $("#jfgrid-newConditionRule-dialog #conditionVal input").val().trim();

                                //条件值是否是选区
                                var rangeArr = jfgrid.conditionformat.getRangeByTxt(v);
                                if(rangeArr.length > 1){
                                    jfgrid.conditionformat.infoDialog("只能对单个单元格进行引用", "");
                                    return;
                                }
                                else if(rangeArr.length == 1){
                                    var r1 = rangeArr[0].row[0], r2 = rangeArr[0].row[1];
                                    var c1 = rangeArr[0].column[0], c2 = rangeArr[0].column[1];

                                    if(r1 == r2 && c1 == c2){
                                        v = jfgrid.getcellvalue(r1, c1, jfgrid.flowdata);
                                        
                                        conditionRange.push({ "row": rangeArr[0].row, "column": rangeArr[0].column });
                                        conditionValue.push(v);
                                    }
                                    else{
                                        jfgrid.conditionformat.infoDialog("只能对单个单元格进行引用", "");
                                        return;
                                    }
                                }
                                else if(rangeArr.length == 0){
                                    if(isNaN(v) || v == ""){
                                        jfgrid.conditionformat.infoDialog("条件值只能是数字或者单个单元格", "");
                                        return;
                                    }
                                    else{
                                        conditionValue.push(v);
                                    }
                                }
                            }
                        }
                        else if(type1 == "text"){ //特定文本
                            conditionName = "textContains";

                            //条件值
                            var v = $("#jfgrid-newConditionRule-dialog #conditionVal input").val().trim();

                            //条件值是否是选区
                            var rangeArr = jfgrid.conditionformat.getRangeByTxt(v);
                            if(rangeArr.length > 1){
                                jfgrid.conditionformat.infoDialog("只能对单个单元格进行引用", "");
                                return;
                            }
                            else if(rangeArr.length == 1){
                                var r1 = rangeArr[0].row[0], r2 = rangeArr[0].row[1];
                                var c1 = rangeArr[0].column[0], c2 = rangeArr[0].column[1];

                                if(r1 == r2 && c1 == c2){
                                    v = jfgrid.getcellvalue(r1, c1, jfgrid.flowdata);
                                    
                                    conditionRange.push({ "row": rangeArr[0].row, "column": rangeArr[0].column });
                                    conditionValue.push(v);
                                }
                                else{
                                    jfgrid.conditionformat.infoDialog("只能对单个单元格进行引用", "");
                                    return;
                                }
                            }
                            else if(rangeArr.length == 0){
                                if(isNaN(v) || v == ""){
                                    jfgrid.conditionformat.infoDialog("条件值只能是数字或者单个单元格", "");
                                    return;
                                }
                                else{
                                    conditionValue.push(v);
                                }
                            }
                        }
                        else if(type1 == "date"){ //发生日期
                            conditionName = "occurrenceDate";

                            //条件值
                            var v = $("#jfgrid-newConditionRule-dialog #daterange-btn").val();

                            if(v == "" || v == null){
                                jfgrid.conditionformat.infoDialog("请选择日期", "");
                                return;
                            }
                            
                            conditionValue.push(v);
                        }
                    }
                    else if(index == 2){ //排名靠前靠后
                        //条件名称
                        if(type1 == "top"){
                            if($("#jfgrid-newConditionRule-dialog #isPercent").is(":selected")){
                                var conditionName = "top10%";
                            }
                            else{
                                var conditionName = "top10";
                            }
                        }
                        else if(type1 == "last"){
                            if($("#jfgrid-newConditionRule-dialog #isPercent").is(":selected")){
                                var conditionName = "last10%";
                            }
                            else{
                                var conditionName = "last10";
                            }
                        }

                        //条件值
                        var v = $("#jfgrid-newConditionRule-dialog #conditionVal input").val().trim();

                        if(parseInt(v) != v || parseInt(v) < 1 || parseInt(v) > 1000){
                            jfgrid.conditionformat.infoDialog("请输入一个介于 1 和 1000 之间的整数", "");
                            return;
                        }
                        
                        conditionValue.push(v);
                    }
                    else if(index == 3){ //平均值
                        if(type1 == "AboveAverage"){
                            conditionName = "AboveAverage";
                            conditionValue.push("AboveAverage");
                        }
                        else if(type1 == "SubAverage"){
                            conditionName = "SubAverage";
                            conditionValue.push("SubAverage");
                        }
                    }
                    else if(index == 4){ //重复值
                        conditionName = "duplicateValue";
                        conditionValue.push(type1);
                    }

                    //格式颜色
                    if($("#jfgrid-newConditionRule-dialog #checkTextColor").is(":checked")){
                        var textcolor = $("#jfgrid-newConditionRule-dialog #textcolorshow").spectrum("get").toHexString();
                    }
                    else{
                        var textcolor = null;    
                    }
                    
                    if($("#jfgrid-newConditionRule-dialog #checkCellColor").is(":checked")){
                        var cellcolor = $("#jfgrid-newConditionRule-dialog #cellcolorshow").spectrum("get").toHexString();
                    }
                    else{
                        var cellcolor = null;    
                    }

                    format = {
                        "textColor": textcolor, 
                        "cellColor": cellcolor
                    };

                    var rule = {
                        "type": "default",
                        "cellrange": $.extend(true, [], jfgird_select_save),
                        "format": format, 
                        "conditionName": conditionName, 
                        "conditionRange": conditionRange, 
                        "conditionValue": conditionValue 
                    };
                }

                $("#jfgrid-newConditionRule-dialog").hide();
                
                //新建规则的入口
                var source = $(this).attr("data-source");
                
                if(source == 0){
                    $("#jfgrid-modal-dialog-mask").hide();
                    
                    //保存之前的规则
                    var fileH = $.extend(true, [], jfgrid.getjfgridfile());
                    var historyRules = jfgrid.conditionformat.getHistoryRules(fileH);
                    
                    //保存当前的规则
                    var ruleArr = jfgridfile[jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex)]["jfgrid_conditionformat_save"] == undefined ? [] : jfgridfile[jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex)]["jfgrid_conditionformat_save"];
                    ruleArr.push(rule);
                    jfgridfile[jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex)]["jfgrid_conditionformat_save"] = ruleArr;

                    var fileC = $.extend(true, [], jfgrid.getjfgridfile());
                    var currentRules = jfgrid.conditionformat.getCurrentRules(fileC);
                    
                    //刷新一次表格
                    jfgrid.conditionformat.ref(historyRules, currentRules);

                    //发送给后台
                    if(jfgrid.server.allowUpdate){
                        jfgrid.server.saveParam("all", jfgrid.currentSheetIndex, ruleArr, { "k": "jfgrid_conditionformat_save" });
                    }
                }
                else if(source == 1){
                    //临时存储新规则
                    var ruleArr = !!jfgrid.conditionformat.fileClone[jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex)]["jfgrid_conditionformat_save"] ? jfgrid.conditionformat.fileClone[jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex)]["jfgrid_conditionformat_save"] : [];
                    ruleArr.push(rule);
                    jfgrid.conditionformat.fileClone[jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex)]["jfgrid_conditionformat_save"] = ruleArr;
                    
                    //新建规则隐藏，管理规则显示
                    jfgrid.conditionformat.administerRuleDialog();
                }
            });
            $(document).off("click.CFnewConditionRuleClose").on("click.CFnewConditionRuleClose", "#jfgrid-newConditionRule-dialog-close", function(){
                //新建规则的入口
                var source = $(this).attr("data-source");
                if(source == 0){
                    $("#jfgrid-modal-dialog-mask").hide();
                }
                if(source == 1){
                    $("#jfgrid-administerRule-dialog").show();
                }
                
                //新建规则隐藏
                $("#jfgrid-newConditionRule-dialog").hide();
                
                //隐藏虚线框
                $("#jfgrid-formula-functionrange-select").hide();
                $("#jfgrid-row-count-show").hide();
                $("#jfgrid-column-count-show").hide(); 
            });
            
            // 编辑规则
            $(document).off("click.CFeditorConditionRule").on("click.CFeditorConditionRule", "#editorConditionRule", function(){
                var sheetIndex = $("#jfgrid-administerRule-dialog .chooseSheet option:selected").val();
                var itemIndex = $("#jfgrid-administerRule-dialog .ruleList .listBox .item.on").attr("data-item");
                var rule = {
                    "sheetIndex": sheetIndex,
                    "itemIndex": itemIndex,
                    "data": jfgrid.conditionformat.fileClone[jfgrid.sheetmanage.getSheetIndex(sheetIndex)]["jfgrid_conditionformat_save"][itemIndex]
                };
                jfgrid.conditionformat.editorRule = rule;
                jfgrid.conditionformat.editorConditionRuleDialog();
            });
            $(document).off("click.CFeditorConditionRuleConfirm").on("click.CFeditorConditionRuleConfirm", "#jfgrid-editorConditionRule-dialog-confirm",function(){
                var index = $("#jfgrid-editorConditionRule-dialog .ruleTypeItem.on").index();
                var type1 = $("#jfgrid-editorConditionRule-dialog #type1 option:selected").val();
                var type2 = $("#jfgrid-editorConditionRule-dialog ." + type1 + "Box #type2 option:selected").val();

                var cellrange = jfgrid.conditionformat.editorRule["data"].cellrange;
                
                var format;
                if(index == 0){
                    if(type1 == "dataBar"){ //数据条
                        var color = $(this).parents("#jfgrid-editorConditionRule-dialog").find(".dataBarBox .jfgrid-conditionformat-config-color").spectrum("get").toHexString();

                        if(type2 == "gradient"){ //渐变填充
                            format = [color, "#ffffff"];
                        }
                        else if(type2 == "solid"){ //实心填充
                            format = [color];
                        }

                        var rule = {
                            "type": "dataBar", 
                            "cellrange": cellrange, 
                            "format": format
                        };
                    }
                    else if(type1 == "colorGradation"){ //色阶
                        var maxcolor = $(this).parents("#jfgrid-editorConditionRule-dialog").find(".colorGradationBox .maxVal .jfgrid-conditionformat-config-color").spectrum("get").toRgbString();
                        var midcolor = $(this).parents("#jfgrid-editorConditionRule-dialog").find(".colorGradationBox .midVal .jfgrid-conditionformat-config-color").spectrum("get").toRgbString();
                        var mincolor = $(this).parents("#jfgrid-editorConditionRule-dialog").find(".colorGradationBox .minVal .jfgrid-conditionformat-config-color").spectrum("get").toRgbString();

                        if(type2 == "threeColor"){ //三色
                            format = [maxcolor, midcolor, mincolor];
                        }
                        else if(type2 == "twoColor"){ //双色
                            format = [maxcolor, mincolor];
                        }

                        var rule = {
                            "type": "colorGradation", 
                            "cellrange": cellrange, 
                            "format": format
                        };
                    }
                    else if(type1 == "icons"){ //图标集
                        var len = $(this).parents("#jfgrid-editorConditionRule-dialog").find(".iconsBox .model").attr("data-len");
                        var leftMin = $(this).parents("#jfgrid-editorConditionRule-dialog").find(".iconsBox .model").attr("data-leftmin");
                        var top = $(this).parents("#jfgrid-editorConditionRule-dialog").find(".iconsBox .model").attr("data-top");

                        format = {
                            "len": len, 
                            "leftMin": leftMin,
                            "top": top
                        };

                        var rule = {
                            "type": "icons", 
                            "cellrange": cellrange, 
                            "format": format
                        };
                    }
                }
                else{
                    var conditionName = "", conditionRange = [], conditionValue = [];

                    if(index == 1){
                        if(type1 == "number"){ //单元格值
                            conditionName = type2;

                            if(type2 == "betweenness"){
                                var v1 = $("#jfgrid-editorConditionRule-dialog #conditionVal input").val().trim();
                                var v2 = $("#jfgrid-editorConditionRule-dialog #conditionVal2 input").val().trim();

                                //条件值是否是选区
                                var rangeArr1 = jfgrid.conditionformat.getRangeByTxt(v1);
                                if(rangeArr1.length > 1){
                                    jfgrid.conditionformat.infoDialog("只能对单个单元格进行引用", "");
                                    return;
                                }
                                else if(rangeArr1.length == 1){
                                    var r1 = rangeArr1[0].row[0], r2 = rangeArr1[0].row[1];
                                    var c1 = rangeArr1[0].column[0], c2 = rangeArr1[0].column[1];

                                    if(r1 == r2 && c1 == c2){
                                        v1 = jfgrid.getcellvalue(r1, c1, jfgrid.flowdata);
                                        
                                        conditionRange.push({ "row": rangeArr1[0].row, "column": rangeArr1[0].column });
                                        conditionValue.push(v1);
                                    }
                                    else{
                                        jfgrid.conditionformat.infoDialog("只能对单个单元格进行引用", "");
                                        return;
                                    }
                                }
                                else if(rangeArr1.length == 0){
                                    if(isNaN(v1) || v1 == ""){
                                        jfgrid.conditionformat.infoDialog("条件值只能是数字或者单个单元格", "");
                                        return;
                                    }
                                    else{
                                        conditionValue.push(v1);
                                    }
                                }

                                var rangeArr2 = jfgrid.conditionformat.getRangeByTxt(v2);
                                if(rangeArr2.length > 1){
                                    jfgrid.conditionformat.infoDialog("只能对单个单元格进行引用", "");
                                    return;
                                }
                                else if(rangeArr2.length == 1){
                                    var r1 = rangeArr2[0].row[0], r2 = rangeArr2[0].row[1];
                                    var c1 = rangeArr2[0].column[0], c2 = rangeArr2[0].column[1];

                                    if(r1 == r2 && c1 == c2){
                                        v2 = jfgrid.getcellvalue(r1, c1, jfgrid.flowdata);
                                        
                                        conditionRange.push({ "row": rangeArr2[0].row, "column": rangeArr2[0].column });
                                        conditionValue.push(v2);
                                    }
                                    else{
                                        jfgrid.conditionformat.infoDialog("只能对单个单元格进行引用", "");
                                        return;
                                    }
                                }
                                else if(rangeArr2.length == 0){
                                    if(isNaN(v2) || v2 == ""){
                                        jfgrid.conditionformat.infoDialog("条件值只能是数字或者单个单元格", "");
                                        return;
                                    }
                                    else{
                                        conditionValue.push(v2);
                                    }
                                }
                            }
                            else{
                                //条件值
                                var v = $("#jfgrid-editorConditionRule-dialog #conditionVal input").val().trim();

                                //条件值是否是选区
                                var rangeArr = jfgrid.conditionformat.getRangeByTxt(v);
                                if(rangeArr.length > 1){
                                    jfgrid.conditionformat.infoDialog("只能对单个单元格进行引用", "");
                                    return;
                                }
                                else if(rangeArr.length == 1){
                                    var r1 = rangeArr[0].row[0], r2 = rangeArr[0].row[1];
                                    var c1 = rangeArr[0].column[0], c2 = rangeArr[0].column[1];

                                    if(r1 == r2 && c1 == c2){
                                        v = jfgrid.getcellvalue(r1, c1, jfgrid.flowdata);
                                        
                                        conditionRange.push({ "row": rangeArr[0].row, "column": rangeArr[0].column });
                                        conditionValue.push(v);
                                    }
                                    else{
                                        jfgrid.conditionformat.infoDialog("只能对单个单元格进行引用", "");
                                        return;
                                    }
                                }
                                else if(rangeArr.length == 0){
                                    if(isNaN(v) || v == ""){
                                        jfgrid.conditionformat.infoDialog("条件值只能是数字或者单个单元格", "");
                                        return;
                                    }
                                    else{
                                        conditionValue.push(v);
                                    }
                                }
                            }
                        }
                        else if(type1 == "text"){ //特定文本
                            conditionName = "textContains";

                            //条件值
                            var v = $("#jfgrid-editorConditionRule-dialog #conditionVal input").val().trim();

                            //条件值是否是选区
                            var rangeArr = jfgrid.conditionformat.getRangeByTxt(v);
                            if(rangeArr.length > 1){
                                jfgrid.conditionformat.infoDialog("只能对单个单元格进行引用", "");
                                return;
                            }
                            else if(rangeArr.length == 1){
                                var r1 = rangeArr[0].row[0], r2 = rangeArr[0].row[1];
                                var c1 = rangeArr[0].column[0], c2 = rangeArr[0].column[1];

                                if(r1 == r2 && c1 == c2){
                                    v = jfgrid.getcellvalue(r1, c1, jfgrid.flowdata);
                                    
                                    conditionRange.push({ "row": rangeArr[0].row, "column": rangeArr[0].column });
                                    conditionValue.push(v);
                                }
                                else{
                                    jfgrid.conditionformat.infoDialog("只能对单个单元格进行引用", "");
                                    return;
                                }
                            }
                            else if(rangeArr.length == 0){
                                if(isNaN(v) || v == ""){
                                    jfgrid.conditionformat.infoDialog("条件值只能是数字或者单个单元格", "");
                                    return;
                                }
                                else{
                                    conditionValue.push(v);
                                }
                            }
                        }
                        else if(type1 == "date"){ //发生日期
                            conditionName = "occurrenceDate";

                            //条件值
                            var v = $("#jfgrid-editorConditionRule-dialog #daterange-btn").val();

                            if(v == "" || v == null){
                                jfgrid.conditionformat.infoDialog("请选择日期", "");
                                return;
                            }
                            
                            conditionValue.push(v);
                        }
                    }
                    else if(index == 2){ //排名靠前靠后
                        //条件名称
                        if(type1 == "top"){
                            if($("#jfgrid-editorConditionRule-dialog #isPercent").is(":selected")){
                                var conditionName = "top10%";
                            }
                            else{
                                var conditionName = "top10";
                            }
                        }
                        else if(type1 == "last"){
                            if($("#jfgrid-editorConditionRule-dialog #isPercent").is(":selected")){
                                var conditionName = "last10%";
                            }
                            else{
                                var conditionName = "last10";
                            }
                        }

                        //条件值
                        var v = $("#jfgrid-editorConditionRule-dialog #conditionVal input").val().trim();

                        if(parseInt(v) != v || parseInt(v) < 1 || parseInt(v) > 1000){
                            jfgrid.conditionformat.infoDialog("请输入一个介于 1 和 1000 之间的整数", "");
                            return;
                        }
                        
                        conditionValue.push(v);
                    }
                    else if(index == 3){ //平均值
                        if(type1 == "AboveAverage"){
                            conditionName = "AboveAverage";
                            conditionValue.push("AboveAverage");
                        }
                        else if(type1 == "SubAverage"){
                            conditionName = "SubAverage";
                            conditionValue.push("SubAverage");
                        }
                    }
                    else if(index == 4){ //重复值
                        conditionName = "duplicateValue";
                        conditionValue.push(type1);
                    }

                    //格式颜色
                    if($("#jfgrid-editorConditionRule-dialog #checkTextColor").is(":checked")){
                        var textcolor = $("#jfgrid-editorConditionRule-dialog #textcolorshow").spectrum("get").toHexString();
                    }
                    else{
                        var textcolor = null;    
                    }
                    
                    if($("#jfgrid-editorConditionRule-dialog #checkCellColor").is(":checked")){
                        var cellcolor = $("#jfgrid-editorConditionRule-dialog #cellcolorshow").spectrum("get").toHexString();
                    }
                    else{
                        var cellcolor = null;    
                    }

                    format = {
                        "textColor": textcolor, 
                        "cellColor": cellcolor
                    };

                    var rule = {
                        "type": "default",
                        "cellrange": cellrange,
                        "format": format, 
                        "conditionName": conditionName, 
                        "conditionRange": conditionRange, 
                        "conditionValue": conditionValue 
                    };
                }

                //修改编辑的规则
                var sheetIndex = jfgrid.conditionformat.editorRule["sheetIndex"];
                var itemIndex = jfgrid.conditionformat.editorRule["itemIndex"];
                jfgrid.conditionformat.fileClone[jfgrid.sheetmanage.getSheetIndex(sheetIndex)]["jfgrid_conditionformat_save"][itemIndex] = rule;
                
                //编辑规则隐藏，管理规则显示
                $("#jfgrid-editorConditionRule-dialog").hide();
                jfgrid.conditionformat.administerRuleDialog();
            });
            $(document).off("click.CFeditorConditionRuleClose").on("click.CFeditorConditionRuleClose", "#jfgrid-editorConditionRule-dialog-close",function(){
                //编辑规则隐藏，管理规则显示
                $("#jfgrid-editorConditionRule-dialog").hide();
                $("#jfgrid-administerRule-dialog").show();
                //隐藏虚线框
                $("#jfgrid-formula-functionrange-select").hide();
                $("#jfgrid-row-count-show").hide();
                $("#jfgrid-column-count-show").hide();
            });

            // 新建规则、编辑规则 类型切换
            $(document).off("click.CFnewEditorRuleItem").on("click.CFnewEditorRuleItem", ".jfgrid-newEditorRule-dialog .ruleTypeItem", function(){
                $(this).addClass("on").siblings().removeClass("on");
                
                var index = $(this).index();
                $(this).parents(".jfgrid-newEditorRule-dialog").find(".ruleExplainBox").html(jfgrid.conditionformat.getRuleExplain(index));

                jfgrid.conditionformat.colorSelectInit();
            });
            $(document).off("change.CFnewEditorRuleType1").on("change.CFnewEditorRuleType1", ".jfgrid-newEditorRule-dialog #type1", function(){
                var optionVal = $(this).find("option:selected").val();

                if(optionVal == "dataBar" || optionVal == "colorGradation" || optionVal == "icons" || optionVal == "number" || optionVal == "text" || optionVal == "date"){
                    $(this).parents(".jfgrid-newEditorRule-dialog").find("." + optionVal + "Box").show().siblings().hide();
                }

                if(optionVal == "date"){
                    jfgrid.conditionformat.daterangeInit($(this).parents(".jfgrid-newEditorRule-dialog").attr("id"));
                }
            });
            $(document).off("change.CFnewEditorRuleType2").on("change.CFnewEditorRuleType2", ".jfgrid-newEditorRule-dialog #type2", function(){
                var type1 = $(this).parents(".jfgrid-newEditorRule-dialog").find("#type1 option:selected").val();

                if(type1 == "colorGradation"){ 
                    var type2 = $(this).find("option:selected").val();

                    if(type2 == "threeColor"){
                        $(this).parents(".jfgrid-newEditorRule-dialog").find(".midVal").show();
                    }
                    else{
                        $(this).parents(".jfgrid-newEditorRule-dialog").find(".midVal").hide();
                    }
                }
                else if(type1 == "number"){
                    var type2 = $(this).find("option:selected").val();

                    if(type2 == "betweenness"){
                        $(this).parents(".jfgrid-newEditorRule-dialog").find(".txt").show();
                        $(this).parents(".jfgrid-newEditorRule-dialog").find("#conditionVal2").show();
                    }
                    else{
                        $(this).parents(".jfgrid-newEditorRule-dialog").find(".txt").hide();
                        $(this).parents(".jfgrid-newEditorRule-dialog").find("#conditionVal2").hide();
                    }
                }
            });
            $(document).off("click.CFiconsShowbox").on("click.CFiconsShowbox", ".jfgrid-newEditorRule-dialog .iconsBox .showbox", function(){
                $(this).parents(".iconsBox").find("ul").toggle();
            });
            $(document).off("click.CFiconsLi").on("click.CFiconsLi", ".jfgrid-newEditorRule-dialog .iconsBox li", function(){
                var len = $(this).find("div").attr("data-len");
                var leftmin = $(this).find("div").attr("data-leftmin");
                var top = $(this).find("div").attr("data-top");
                var title = $(this).find("div").attr("title");
                var position = $(this).find("div").css("background-position");

                $(this).parents(".iconsBox").find(".showbox .model").css("background-position", position);
                $(this).parents(".iconsBox").find(".showbox .model").attr("data-len", len);
                $(this).parents(".iconsBox").find(".showbox .model").attr("data-leftmin", leftmin);
                $(this).parents(".iconsBox").find(".showbox .model").attr("data-top", top);
                $(this).parents(".iconsBox").find(".showbox .model").attr("title", title);

                $(this).parents("ul").hide();
            });

            // 删除规则
            $(document).off("click.CFdeleteConditionRule").on("click.CFdeleteConditionRule", "#deleteConditionRule", function(){
                var sheetIndex = $("#jfgrid-administerRule-dialog .chooseSheet option:selected").val();
                var itemIndex = $("#jfgrid-administerRule-dialog .ruleList .listBox .item.on").attr("data-item");
                jfgrid.conditionformat.fileClone[jfgrid.sheetmanage.getSheetIndex(sheetIndex)]["jfgrid_conditionformat_save"].splice(itemIndex, 1);
                jfgrid.conditionformat.administerRuleDialog();
            });
            
            // 规则子菜单弹出层 点击确定修改样式
            $(document).off("click.CFdefault").on("click.CFdefault", "#jfgrid-conditionformat-dialog-confirm", function(){
                //条件名称
                var conditionName = $("#jfgrid-conditionformat-dialog .box").attr("data-itemvalue");
                
                //条件单元格
                var conditionRange = [];
                
                //条件值
                var conditionValue = [];
                if(conditionName == "greaterThan" || conditionName == "lessThan" || conditionName == "equal" || conditionName == "textContains"){
                    var v = $("#jfgrid-conditionformat-dialog #conditionVal").val().trim();
                    
                    //条件值是否是选区
                    var rangeArr = jfgrid.conditionformat.getRangeByTxt(v);
                    if(rangeArr.length > 1){
                        jfgrid.conditionformat.infoDialog("只能对单个单元格进行引用", "");
                        return;
                    }
                    else if(rangeArr.length == 1){
                        var r1 = rangeArr[0].row[0], r2 = rangeArr[0].row[1];
                        var c1 = rangeArr[0].column[0], c2 = rangeArr[0].column[1];

                        if(r1 == r2 && c1 == c2){
                            v = jfgrid.getcellvalue(r1, c1, jfgrid.flowdata);
                            
                            conditionRange.push({ "row": rangeArr[0].row, "column": rangeArr[0].column });
                            conditionValue.push(v);
                        }
                        else{
                            jfgrid.conditionformat.infoDialog("只能对单个单元格进行引用", "");
                            return;
                        }
                    }
                    else if(rangeArr.length == 0){
                        if(isNaN(v) || v == ""){
                            jfgrid.conditionformat.infoDialog("条件值只能是数字或者单个单元格", "");
                            return;
                        }
                        else{
                            conditionValue.push(v);
                        }
                    }
                }
                else if(conditionName == "betweenness"){//介于
                    var v1 = $("#jfgrid-conditionformat-dialog #conditionVal").val().trim();
                    var v2 = $("#jfgrid-conditionformat-dialog #conditionVal2").val().trim();

                    //条件值是否是选区
                    var rangeArr1 = jfgrid.conditionformat.getRangeByTxt(v1);
                    if(rangeArr1.length > 1){
                        jfgrid.conditionformat.infoDialog("只能对单个单元格进行引用", "");
                        return;
                    }
                    else if(rangeArr1.length == 1){
                        var r1 = rangeArr1[0].row[0], r2 = rangeArr1[0].row[1];
                        var c1 = rangeArr1[0].column[0], c2 = rangeArr1[0].column[1];

                        if(r1 == r2 && c1 == c2){
                            v1 = jfgrid.getcellvalue(r1, c1, jfgrid.flowdata);
                            
                            conditionRange.push({ "row": rangeArr1[0].row, "column": rangeArr1[0].column });
                            conditionValue.push(v1);
                        }
                        else{
                            jfgrid.conditionformat.infoDialog("只能对单个单元格进行引用", "");
                            return;
                        }
                    }
                    else if(rangeArr1.length == 0){
                        if(isNaN(v1) || v1 == ""){
                            jfgrid.conditionformat.infoDialog("条件值只能是数字或者单个单元格", "");
                            return;
                        }
                        else{
                            conditionValue.push(v1);
                        }
                    }

                    var rangeArr2 = jfgrid.conditionformat.getRangeByTxt(v2);
                    if(rangeArr2.length > 1){
                        jfgrid.conditionformat.infoDialog("只能对单个单元格进行引用", "");
                        return;
                    }
                    else if(rangeArr2.length == 1){
                        var r1 = rangeArr2[0].row[0], r2 = rangeArr2[0].row[1];
                        var c1 = rangeArr2[0].column[0], c2 = rangeArr2[0].column[1];

                        if(r1 == r2 && c1 == c2){
                            v2 = jfgrid.getcellvalue(r1, c1, jfgrid.flowdata);
                            
                            conditionRange.push({ "row": rangeArr2[0].row, "column": rangeArr2[0].column });
                            conditionValue.push(v2);
                        }
                        else{
                            jfgrid.conditionformat.infoDialog("只能对单个单元格进行引用", "");
                            return;
                        }
                    }
                    else if(rangeArr2.length == 0){
                        if(isNaN(v2) || v2 == ""){
                            jfgrid.conditionformat.infoDialog("条件值只能是数字或者单个单元格", "");
                            return;
                        }
                        else{
                            conditionValue.push(v2);
                        }
                    }
                }
                else if(conditionName == "occurrenceDate"){//日期
                    var v = $("#jfgrid-conditionformat-dialog #daterange-btn").val();

                    if(v == "" || v == null){
                        jfgrid.conditionformat.infoDialog("请选择日期", "");
                        return;
                    }

                    conditionValue.push(v);
                }
                else if(conditionName == "duplicateValue"){//重复值
                    conditionValue.push($("#jfgrid-conditionformat-dialog #conditionVal option:selected").val());
                }
                else if(conditionName == "top10" || conditionName == "top10%" || conditionName == "last10" || conditionName == "last10%"){
                    var v = $("#jfgrid-conditionformat-dialog #conditionVal").val().trim();

                    if(parseInt(v) != v || parseInt(v) < 1 || parseInt(v) > 1000){
                        jfgrid.conditionformat.infoDialog("请输入一个介于 1 和 1000 之间的整数", "");
                        return;
                    }

                    conditionValue.push(v);
                }
                else if(conditionName == "AboveAverage"){ //高于平均值
                    conditionValue.push("AboveAverage");
                }
                else if(conditionName == "SubAverage"){ //低于平均值
                    conditionValue.push("SubAverage");
                }

                //格式颜色
                if($("#checkTextColor").is(":checked")){
                    var textcolor = $("#textcolorshow").spectrum("get").toHexString();
                }
                else{
                    var textcolor = null;    
                }

                if($("#checkCellColor").is(":checked")){
                    var cellcolor = $("#cellcolorshow").spectrum("get").toHexString();
                }
                else{
                    var cellcolor = null;    
                }

                //保存之前的规则
                var fileH = $.extend(true, [], jfgrid.getjfgridfile());
                var historyRules = jfgrid.conditionformat.getHistoryRules(fileH);
                
                //保存当前的规则
                var rule = {
                    "type": "default",
                    "cellrange": $.extend(true, [], jfgird_select_save),
                    "format": {
                        "textColor": textcolor, 
                        "cellColor": cellcolor
                    }, 
                    "conditionName": conditionName, 
                    "conditionRange": conditionRange, 
                    "conditionValue": conditionValue 
                };
                var ruleArr = jfgridfile[jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex)]["jfgrid_conditionformat_save"] == undefined ? [] : jfgridfile[jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex)]["jfgrid_conditionformat_save"];
                ruleArr.push(rule);
                jfgridfile[jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex)]["jfgrid_conditionformat_save"] = ruleArr;

                var fileC = $.extend(true, [], jfgrid.getjfgridfile());
                var currentRules = jfgrid.conditionformat.getCurrentRules(fileC);
                
                //刷新一次表格
                jfgrid.conditionformat.ref(historyRules, currentRules);
                
                //隐藏一些dom
                $("#jfgrid-modal-dialog-mask").hide();
                $("#jfgrid-conditionformat-dialog").hide();

                //发送给后台
                if(jfgrid.server.allowUpdate){
                    jfgrid.server.saveParam("all", jfgrid.currentSheetIndex, ruleArr, { "k": "jfgrid_conditionformat_save" });
                }
            });
            
            // 图标集弹出层 选择
            $(document).off("click.CFicons").on("click.CFicons", "#jfgrid-CFicons-dialog .item", function(){
                $("#jfgrid-modal-dialog-mask").hide();
                $("#jfgrid-CFicons-dialog").hide();

                if(jfgird_select_save.length > 0){
                    var cellrange = $.extend(true, [], jfgird_select_save);
                    var format = {
                        "len": $(this).attr("data-len"), 
                        "leftMin": $(this).attr("data-leftMin"),
                        "top": $(this).attr("data-top")
                    }

                    jfgrid.conditionformat.updateItem("icons", cellrange, format);
                }
            });
            
            // 选择单元格
            $(document).on("click", ".range .fa-table", function(){
                var id = $(this).parents(".jfgrid-modal-dialog").attr("id");
                $("#" + id).hide();
                //入口
                if(id == "jfgrid-conditionformat-dialog"){
                    if($(this).siblings("input").attr("id") == "conditionVal"){
                        var source = "0_1";
                    }
                    else{
                        var source = "0_2";    
                    }
                }
                else if(id == "jfgrid-newConditionRule-dialog"){
                    if($(this).parents(".range").attr("id") == "conditionVal"){
                        var source = "1_1";    
                    }
                    else{
                        var source = "1_2";
                    }
                }
                else if(id == "jfgrid-editorConditionRule-dialog"){
                    if($(this).parents(".range").attr("id") == "conditionVal"){
                        var source = "2_1";    
                    }
                    else{
                        var source = "2_2";
                    }
                }
                //input值
                var v = $(this).siblings("input").val();

                jfgrid.conditionformat.singleRangeDialog(source, v);
                jfgrid.selectionCopyShow(jfgrid.conditionformat.getRangeByTxt(v));
            });
            $(document).on("click", "#jfgrid-singleRange-dialog-confirm", function(){
                $("#jfgrid-modal-dialog-mask").show();
                $(this).parents("#jfgrid-singleRange-dialog").hide();

                var source = $(this).attr("data-source");
                var v = $(this).parents("#jfgrid-singleRange-dialog").find("input").val();
                
                if(source == "0_1"){
                    $("#jfgrid-conditionformat-dialog").show();
                    $("#jfgrid-conditionformat-dialog #conditionVal").val(v);
                }
                else if(source == "0_2"){
                    $("#jfgrid-conditionformat-dialog").show();
                    $("#jfgrid-conditionformat-dialog #conditionVal2").val(v);
                }
                else if(source == "1_1"){
                    $("#jfgrid-newConditionRule-dialog").show();
                    $("#jfgrid-newConditionRule-dialog #conditionVal input").val(v);
                }
                else if(source == "1_2"){
                    $("#jfgrid-newConditionRule-dialog").show();
                    $("#jfgrid-newConditionRule-dialog #conditionVal2 input").val(v);
                }
                else if(source == "2_1"){
                    $("#jfgrid-editorConditionRule-dialog").show();
                    $("#jfgrid-editorConditionRule-dialog #conditionVal input").val(v);
                }
                else if(source == "2_2"){
                    $("#jfgrid-editorConditionRule-dialog").show();
                    $("#jfgrid-editorConditionRule-dialog #conditionVal2 input").val(v);
                }

                var range = [];
                jfgrid.selectionCopyShow(range);
            });
            $(document).on("click", "#jfgrid-singleRange-dialog-close", function(){
                $("#jfgrid-modal-dialog-mask").show();
                $(this).parents("#jfgrid-singleRange-dialog").hide();

                var source = $(this).attr("data-source");
                if(source == "0_1" || source == "0_2"){
                    $("#jfgrid-conditionformat-dialog").show();
                }
                else if(source == "1_1" || source == "1_2"){
                    $("#jfgrid-newConditionRule-dialog").show();
                }
                else if(source == "2_1" || source == "2_2"){
                    $("#jfgrid-editorConditionRule-dialog").show();
                }

                var range = [];
                jfgrid.selectionCopyShow(range);
            });
            
            // 弹出层右上角关闭按钮
            $(document).on("click", ".jfgrid-modal-dialog-title-close", function(){
                var id = $(this).parents(".jfgrid-modal-dialog").attr("id");
                
                //新建规则弹出层
                if(id == "jfgrid-newConditionRule-dialog"){
                    var source=$("#" + id).find("#jfgrid-newConditionRule-dialog-close").attr("data-source");
                    //新建规则入口
                    if(source == 1){
                        $("#jfgrid-administerRule-dialog").show();
                    }
                }
                
                //编辑规则弹出层
                if(id == "jfgrid-editorConditionRule-dialog"){
                    $("#jfgrid-administerRule-dialog").show();
                }

                //选择单元格弹出层
                if(id == "jfgrid-singleRange-dialog"){
                    $("#jfgrid-modal-dialog-mask").show();

                    var source = $(this).parents("#jfgrid-singleRange-dialog").find("#jfgrid-singleRange-dialog-confirm").attr("data-source");
                    if(source == "0_1" || source == "0_2"){
                        $("#jfgrid-conditionformat-dialog").show();
                    }
                    else if(source == "1_1" || source == "1_2"){
                        $("#jfgrid-newConditionRule-dialog").show();
                    }
                    else if(source == "2_1" || source == "2_2"){
                        $("#jfgrid-editorConditionRule-dialog").show();
                    }

                    var range = [];
                    jfgrid.selectionCopyShow(range);
                }

                //选择应用范围弹出层
                if(id == "jfgrid-multiRange-dialog"){
                    $("#jfgrid-modal-dialog-mask").show();

                    $("#jfgrid-administerRule-dialog").show();

                    var range = [];
                    jfgrid.selectionCopyShow(range);
                }

                //提示框
                if(id == "jfgrid-conditionformat-info-dialog"){
                    $("#jfgrid-modal-dialog-mask").show();
                }
            });

            //提示框
            $(document).on("click", "#jfgrid-conditionformat-info-dialog-close", function(){
                $(this).parents("#jfgrid-conditionformat-info-dialog").hide();
            });
        },
        singleRangeDialog: function(source, value){
            $("#jfgrid-modal-dialog-mask").hide();
            $("#jfgrid-singleRange-dialog").remove();

            $("body").append(jfgrid.replaceHtml(modelHTML, { "id": "jfgrid-singleRange-dialog", "addclass": "jfgrid-singleRange-dialog", "title": "选择单元格", "content": '<input readonly="readonly" placeholder="请选择单元格" value="'+value+'"/>', "botton": '<button id="jfgrid-singleRange-dialog-confirm" class="btn btn-primary" data-source="'+source+'">确定</button><button id="jfgrid-singleRange-dialog-close" class="btn btn-default" data-source="'+source+'">取消</button>', "style": "z-index:100003" }));
            var $t = $("#jfgrid-singleRange-dialog").find(".jfgrid-modal-dialog-content").css("min-width", 300).end(), myh = $t.outerHeight(), myw = $t.outerWidth();
            var winw = $(window).width(), winh = $(window).height();
            var scrollLeft = $(document).scrollLeft(), scrollTop = $(document).scrollTop();
            $("#jfgrid-singleRange-dialog").css({ "left": (winw + scrollLeft - myw) / 2, "top": (winh + scrollTop - myh) / 3 }).show();
        },
        multiRangeDialog: function(dataItem, value){
            $("#jfgrid-modal-dialog-mask").hide();
            $("#jfgrid-multiRange-dialog").remove();

            $("body").append(jfgrid.replaceHtml(modelHTML, { "id": "jfgrid-multiRange-dialog", "addclass": "jfgrid-multiRange-dialog", "title": "选择应用范围", "content": '<input readonly="readonly" placeholder="请选择应用范围" value="'+value+'"/>', "botton": '<button id="jfgrid-multiRange-dialog-confirm" class="btn btn-primary" data-item="'+dataItem+'">确定</button><button id="jfgrid-multiRange-dialog-close" class="btn btn-default">取消</button>', "style": "z-index:100003" }));
            var $t = $("#jfgrid-multiRange-dialog").find(".jfgrid-modal-dialog-content").css("min-width", 300).end(), myh = $t.outerHeight(), myw = $t.outerWidth();
            var winw = $(window).width(), winh = $(window).height();
            var scrollLeft = $(document).scrollLeft(), scrollTop = $(document).scrollTop();
            $("#jfgrid-multiRange-dialog").css({ "left": (winw + scrollLeft - myw) / 2, "top": (winh + scrollTop - myh) / 3 }).show();

            jfgrid.selectionCopyShow(jfgrid.conditionformat.getRangeByTxt(value));
        },
        getTxtByRange: function(range){
            if(range.length > 0){
                var txt = [];

                for(var s = 0; s < range.length; s++){
                    var r1 = range[s].row[0], r2 = range[s].row[1];
                    var c1 = range[s].column[0], c2 = range[s].column[1];
                    
                    txt.push(jfgrid.sheetmanage.getRangetxt(jfgrid.currentSheetIndex, { "row": [r1, r2], "column": [c1, c2] }, jfgrid.currentSheetIndex));
                }

                return txt.join(",");
            }
        },
        getRangeByTxt: function(txt){
            var range = [];

            if(txt.indexOf(",") != -1){
                var arr = txt.split(",");
                for(var i = 0; i < arr.length; i++){
                    if(jfgrid.formula.iscelldata(arr[i])){
                        range.push(jfgrid.formula.getcellrange(arr[i]));
                    }
                    else{
                        range = [];
                        break;    
                    }
                }
            }
            else{
                if(jfgrid.formula.iscelldata(txt)){
                    range.push(jfgrid.formula.getcellrange(txt));
                }
            }

            return range;
        },
        colorSelectInit: function(){
            $(".jfgrid-conditionformat-config-color").spectrum({
                showPalette: true,
                showPaletteOnly:true,
                preferredFormat: "hex",
                clickoutFiresChange: false,
                showInitial: true,
                showInput: true,
                // flat: true,
                hideAfterPaletteSelect: true,
                showSelectionPalette: true,
                // showButtons: false,//隐藏选择取消按钮
                maxPaletteSize: 8,
                maxSelectionSize: 8,
                // color: currenColor,
                cancelText: "取消",
                chooseText: "确定颜色",
                togglePaletteMoreText: "自定义",
                togglePaletteLessText: "收起",
                togglePaletteOnly: true,
                clearText: "清除颜色选择",
                noColorSelectedText: "没有颜色被选择",
                localStorageKey: "spectrum.textcolor" + jfgrid.server.gridKey,
                palette: [["#000","#444","#666","#999","#ccc","#eee","#f3f3f3","#fff"],
                ["#f00","#f90","#ff0","#0f0","#0ff","#00f","#90f","#f0f"],
                ["#f4cccc","#fce5cd","#fff2cc","#d9ead3","#d0e0e3","#cfe2f3","#d9d2e9","#ead1dc"],
                ["#ea9999","#f9cb9c","#ffe599","#b6d7a8","#a2c4c9","#9fc5e8","#b4a7d6","#d5a6bd"],
                ["#e06666","#f6b26b","#ffd966","#93c47d","#76a5af","#6fa8dc","#8e7cc3","#c27ba0"],
                ["#c00","#e69138","#f1c232","#6aa84f","#45818e","#3d85c6","#674ea7","#a64d79"],
                ["#900","#b45f06","#bf9000","#38761d","#134f5c","#0b5394","#351c75","#741b47"],
                ["#600","#783f04","#7f6000","#274e13","#0c343d","#073763","#20124d","#4c1130"]],
                change: function(color){
                    if (color != null) {
                        color = color.toHexString();
                    }
                }
            });
        },
        conditionformatDialog: function(title, content){
            $("#jfgrid-modal-dialog-mask").show();
            $("#jfgrid-conditionformat-dialog").remove();

            $("body").append(jfgrid.replaceHtml(modelHTML, { "id": "jfgrid-conditionformat-dialog", "addclass": "jfgrid-conditionformat-dialog", "title": title, "content": content, "botton": '<button id="jfgrid-conditionformat-dialog-confirm" class="btn btn-primary">确定</button><button class="btn btn-default jfgrid-model-close-btn">取消</button>', "style": "z-index:100003" }));
            var $t = $("#jfgrid-conditionformat-dialog").find(".jfgrid-modal-dialog-content").css("min-width", 300).end(), myh = $t.outerHeight(), myw = $t.outerWidth();
            var winw = $(window).width(), winh = $(window).height();
            var scrollLeft = $(document).scrollLeft(), scrollTop = $(document).scrollTop();
            $("#jfgrid-conditionformat-dialog").css({ "left": (winw + scrollLeft - myw) / 2, "top": (winh + scrollTop - myh) / 3 }).show();
        
            jfgrid.conditionformat.init();
            jfgrid.conditionformat.colorSelectInit();
            if(title == "条件格式——发生日期"){
                jfgrid.conditionformat.daterangeInit("jfgrid-conditionformat-dialog");
            }
        },
        CFiconsDialog: function(){　
            $("#jfgrid-modal-dialog-mask").show();
            $("#jfgrid-CFicons-dialog").remove();

            var content = '<div class="box">'+
                            '<div style="margin-bottom: 10px;">请点击选择一组图标：</div>'+
                            '<div class="title">方向</div>'+
                            '<div class="list">'+
                                '<div class="left">'+
                                    '<div class="item" data-len="3" data-leftMin="0" data-top="0" title="三向箭头(彩色)"><div style="background-position:0 0;"></div></div>'+
                                    '<div class="item" data-len="3" data-leftMin="0" data-top="1" title="3个三角形"><div style="background-position:0 -20px;"></div></div>'+
                                    '<div class="item" data-len="4" data-leftMin="0" data-top="2" title="四向箭头(彩色)"><div style="background-position:0 -40px;"></div></div>'+
                                    '<div class="item" data-len="5" data-leftMin="0" data-top="3" title="五向箭头(彩色)"><div style="background-position:0 -60px;"></div></div>'+
                                '</div>'+
                                '<div class="right">'+
                                    '<div class="item" data-len="3" data-leftMin="5" data-top="0" title="三向箭头(灰色)"><div style="background-position:-131px 0;"></div></div>'+
                                    '<div class="item" data-len="4" data-leftMin="5" data-top="1" title="四向箭头(灰色)"><div style="background-position:-131px -20px;"></div></div>'+
                                    '<div class="item" data-len="5" data-leftMin="5" data-top="2" title="五向箭头(灰色)"><div style="background-position:-131px -40px;"></div></div>'+
                                '</div>'+
                                '<div style="clear:both;"></div>'+
                            '</div>'+
                            '<div class="title">形状</div>'+
                            '<div class="list">'+
                                '<div class="left">'+
                                    '<div class="item" data-len="3" data-leftMin="0" data-top="4" title="三色交通灯(无边框)"><div style="background-position:0 -80px;"></div></div>'+
                                    '<div class="item" data-len="3" data-leftMin="0" data-top="5" title="三标志"><div style="background-position:0 -100px;"></div></div>'+
                                    '<div class="item" data-len="4" data-leftMin="0" data-top="6" title="绿-红-黑渐变"><div style="background-position:0 -120px;"></div></div>'+
                                '</div>'+
                                '<div class="right">'+
                                    '<div class="item" data-len="3" data-leftMin="5" data-top="4" title="三色交通灯(有边框)"><div style="background-position:-131px -80px;"></div></div>'+
                                    '<div class="item" data-len="4" data-leftMin="5" data-top="5" title="四色交通灯"><div style="background-position:-131px -100px;"></div></div>'+
                                '</div>'+
                                '<div style="clear:both;"></div>'+
                            '</div>'+
                            '<div class="title">标记</div>'+
                            '<div class="list">'+
                                '<div class="left">'+
                                    '<div class="item" data-len="3" data-leftMin="0" data-top="7" title="三个符号(有圆圈)"><div style="background-position:0 -140px;"></div></div>'+
                                    '<div class="item" data-len="3" data-leftMin="0" data-top="8" title="三色旗"><div style="background-position:0 -160px;"></div></div>'+
                                '</div>'+
                                '<div class="right">'+
                                    '<div class="item" data-len="3" data-leftMin="5" data-top="7" title="三个符号(无圆圈)"><div style="background-position:-131px -140px;"></div></div>'+
                                '</div>'+
                                '<div style="clear:both;"></div>'+
                            '</div>'+
                            '<div class="title">等级</div>'+
                            '<div class="list">'+
                                '<div class="left">'+
                                    '<div class="item" data-len="3" data-leftMin="0" data-top="9" title="3个星形"><div style="background-position:0 -180px;"></div></div>'+
                                    '<div class="item" data-len="5" data-leftMin="0" data-top="10" title="五象限图"><div style="background-position:0 -200px;"></div></div>'+
                                    '<div class="item" data-len="5" data-leftMin="0" data-top="11" title="5个框"><div style="background-position:0 -220px;"></div></div>'+
                                '</div>'+
                                '<div class="right">'+
                                    '<div class="item" data-len="4" data-leftMin="5" data-top="9" title="四等级"><div style="background-position:-131px -180px;"></div></div>'+
                                    '<div class="item" data-len="5" data-leftMin="5" data-top="10" title="五等级"><div style="background-position:-131px -200px;"></div></div>'+
                                '</div>'+
                                '<div style="clear:both;"></div>'+
                            '</div>'+
                          '</div>';

            $("body").append(jfgrid.replaceHtml(modelHTML, { "id": "jfgrid-CFicons-dialog", "addclass": "jfgrid-CFicons-dialog", "title": "图标集", "content": content, "botton": '<button class="btn btn-default jfgrid-model-close-btn">关闭</button>', "style": "z-index:100003" }));
            var $t = $("#jfgrid-CFicons-dialog").find(".jfgrid-modal-dialog-content").css("min-width", 400).end(), myh = $t.outerHeight(), myw = $t.outerWidth();
            var winw = $(window).width(), winh = $(window).height();
            var scrollLeft = $(document).scrollLeft(), scrollTop = $(document).scrollTop();
            $("#jfgrid-CFicons-dialog").css({ "left": (winw + scrollLeft - myw) / 2, "top": (winh + scrollTop - myh) / 3 }).show();
        },
        administerRuleDialog: function(){
            $("#jfgrid-modal-dialog-mask").show();
            $("#jfgrid-administerRule-dialog").remove();
            
            //工作表
            var opHtml = ''; 
            for(var j = 0; j < jfgridfile.length; j++){
                if(jfgridfile[j].status == "1"){
                    opHtml += '<option value="' + jfgridfile[j]["index"] + '" selected="selected">当前工作表：' + jfgridfile[j]["name"] + '</option>';
                }
                else{
                    opHtml += '<option value="' + jfgridfile[j]["index"] + '">表：' + jfgridfile[j]["name"] + '</option>';
                }
            }

            var content = '<div class="chooseSheet">' +
                            '<label>显示其格式规则：</label>' +
                            '<select>' + opHtml + '</select>' +
                          '</div>' +
                          '<div class="ruleBox">' +
                            '<div class="ruleBtn">' +
                                '<button id="newConditionRule" class="btn btn-default">新建规则</button>' +
                                '<button id="editorConditionRule" class="btn btn-default">编辑规则</button>' +
                                '<button id="deleteConditionRule" class="btn btn-default">删除规则</button>' +
                            '</div>' +
                            '<div class="ruleList">' +
                                '<div class="listTitle">' +
                                    '<span>规则</span>' +
                                    '<span>格式</span>' +
                                    '<span>应用范围</span>' +
                                '</div>' +
                                '<div class="listBox"></div>' +
                            '</div>' +
                          '</div>';

            $("body").append(jfgrid.replaceHtml(modelHTML, { "id": "jfgrid-administerRule-dialog", "addclass": "jfgrid-administerRule-dialog", "title": "条件格式规则管理器", "content": content, "botton": '<button id="jfgrid-administerRule-dialog-confirm" class="btn btn-primary">确定</button><button id="jfgrid-administerRule-dialog-close" class="btn btn-default">关闭</button>', "style": "z-index:100003" }));
            var $t = $("#jfgrid-administerRule-dialog").find(".jfgrid-modal-dialog-content").css("min-width", 400).end(), myh = $t.outerHeight(), myw = $t.outerWidth();
            var winw = $(window).width(), winh = $(window).height();
            var scrollLeft = $(document).scrollLeft(), scrollTop = $(document).scrollTop();
            $("#jfgrid-administerRule-dialog").css({ "left": (winw + scrollLeft - myw) / 2, "top": (winh + scrollTop - myh) / 3 }).show();

            //当前工作表的规则列表
            var index = $("#jfgrid-administerRule-dialog .chooseSheet option:selected").val();
            jfgrid.conditionformat.getConditionRuleList(index);
        },
        getConditionRuleList: function(index){
            $("#jfgrid-administerRule-dialog .ruleList .listBox").empty();

            var ruleArr = jfgrid.conditionformat.fileClone[jfgrid.sheetmanage.getSheetIndex(index)].jfgrid_conditionformat_save; //条件格式规则集合
            if(ruleArr != null && ruleArr.length > 0){
                var textColorHtml = ''; //文本颜色dom
                var cellColorHtml = ''; //单元格颜色dom

                for(var i = 0; i < ruleArr.length; i++){
                    var type = ruleArr[i]["type"];            //规则类型
                    var format = ruleArr[i]["format"];        //规则样式
                    var cellrange = ruleArr[i]["cellrange"];  //规则应用范围

                    var ruleName;         //规则名称
                    var formatHtml = '';  //样式dom
                    if(type == "dataBar"){
                        ruleName = "数据条";

                        formatHtml = '<canvas width="46" height="18" style="width: 46px;height: 18px;margin: 3px 0 0 5px;"></canvas>';
                    }
                    else if(type == "colorGradation"){
                        ruleName = "色阶";

                        formatHtml = '<canvas width="46" height="18" style="width: 46px;height: 18px;margin: 3px 0 0 5px;"></canvas>';
                    }
                    else if(type == "icons"){
                        ruleName = "图标集";

                        formatHtml = '<canvas width="46" height="18" style="width: 46px;height: 18px;margin: 3px 0 0 5px;"></canvas>';
                    }
                    else{
                        ruleName = jfgrid.conditionformat.getConditionRuleName(ruleArr[i].conditionName, ruleArr[i].conditionRange, ruleArr[i].conditionValue);
                    
                        if(format["textColor"] != null){
                            formatHtml += '<span class="colorbox" title="文本颜色" style="background-color:' + format["textColor"] + '"></span>';
                        }

                        if(format["cellColor"] != null){
                            formatHtml += '<span class="colorbox" title="单元格颜色" style="background-color:' + format["cellColor"] + '"></span>';
                        }
                    }
                    
                    //应用范围dom
                    var rangeTxtArr = [];
                    for(var s = 0; s < cellrange.length; s++){
                        var r1 = cellrange[s].row[0], r2 = cellrange[s].row[1];
                        var c1 = cellrange[s].column[0], c2 = cellrange[s].column[1];

                        rangeTxtArr.push(jfgrid.jfgridchatatABC(c1) + (r1 + 1) + ":" + jfgrid.jfgridchatatABC(c2) + (r2 + 1));
                    }
                    
                    //条件格式规则列表dom
                    var itemHtml =  '<div class="item" data-item="' + i + '">' +
                                        '<div class="ruleName" title="' + ruleName + '">' + ruleName + '</div>' +
                                        '<div class="format">' + formatHtml + '</div>' +
                                        '<div class="ruleRange">' +
                                            '<input class="formulaInputFocus" readonly="true" value="' + rangeTxtArr.join(",") + '"/>' +
                                            '<i class="fa fa-table" aria-hidden="true" title="点击选择应用范围"></i>' +
                                        '</div>' +
                                    '</div>';

                    $("#jfgrid-administerRule-dialog .ruleList .listBox").prepend(itemHtml);
                }

                $("#jfgrid-administerRule-dialog .ruleList .listBox .item canvas").each(function(i){
                    var x = $(this).closest(".item").attr("data-item");
                    
                    var type = ruleArr[x]["type"];
                    var format = ruleArr[x]["format"];

                    var can = $(this).get(0).getContext("2d");
                    if(type == "dataBar"){
                        if(format.length == 2){
                            var my_gradient = can.createLinearGradient(0, 0, 46, 0);
                            my_gradient.addColorStop(0, format[0]);
                            my_gradient.addColorStop(1, format[1]);
                            can.fillStyle = my_gradient;
                            can.fillRect(0, 0, 46, 18);

                            can.beginPath();
                            can.moveTo(0, 0);
                            can.lineTo(0, 18);
                            can.lineTo(46, 18);
                            can.lineTo(46, 0);
                            can.lineTo(0, 0);
                            can.lineWidth = devicePixelRatio;
                            can.strokeStyle = format[0];
                            can.stroke();
                            can.closePath();
                        }
                        else if(format.length == 1){
                            can.fillStyle = format[0];
                            can.fillRect(0, 0, 46, 18);

                            can.beginPath();
                            can.moveTo(0, 0);
                            can.lineTo(0, 18);
                            can.lineTo(46, 18);
                            can.lineTo(46, 0);
                            can.lineTo(0, 0);
                            can.lineWidth = devicePixelRatio;
                            can.strokeStyle = format[0];
                            can.stroke();
                            can.closePath();
                        }
                    }
                    else if(type == "colorGradation"){
                        var my_gradient = can.createLinearGradient(0, 0, 46, 0);

                        if(format.length == 3){
                            my_gradient.addColorStop(0, format[0]);
                            my_gradient.addColorStop(0.5, format[1]);
                            my_gradient.addColorStop(1, format[2]);
                        }
                        else if(format.length == 2){
                            my_gradient.addColorStop(0, format[0]);
                            my_gradient.addColorStop(1, format[1]);
                        }

                        can.fillStyle = my_gradient;
                        can.fillRect(0, 0, 46, 18);
                    }
                    else if(type == "icons"){
                        var len = format["len"];
                        var l = format["leftMin"];
                        var t = format["top"];

                        var w1 = 32 * len + 10 * (len - 1);
                        var h1 = 32;
                        var w2 = 46;
                        var h2 = 46 * 32 / w1;

                        if(l == "0"){
                            can.drawImage(jfgrid_CFiconsImg, 0, t * 32, w1, h1, 0, (18 - h2) / 2, w2, h2);
                        }
                        else if(l == "5"){
                            can.drawImage(jfgrid_CFiconsImg, 210, t * 32, w1, h1, 0, (18 - h2) / 2, w2, h2);
                        }
                    }
                })

                $("#jfgrid-administerRule-dialog .ruleList .listBox .item").eq(0).addClass("on");
            }
        },
        getConditionRuleName: function(conditionName,conditionRange,conditionValue){
            //v 有条件单元格取条件单元格，若无取条件值
            if(conditionRange[0]!=null){
                var v=jfgrid.jfgridchatatABC(conditionRange[0]["column"][0])+(conditionRange[0]["row"][0]+1);
            }
            else{
                var v=conditionValue[0];
            }
            //返回条件格式规则名称
            if(conditionName=="greaterThan"){
                return "单元格值 > "+v;
            }
            else if(conditionName=="lessThan"){
                return "单元格值 < "+v;
            }
            else if(conditionName=="betweenness"){
                if(conditionRange[1]!=null){
                    var v2=jfgrid.jfgridchatatABC(conditionRange[1]["column"][0])+(conditionRange[1]["row"][0]+1);
                }
                else{
                    var v2=conditionValue[1];
                }
                return "单元格值介于 "+v+" 和 "+v2+" 之间";
            }
            else if(conditionName=="equal"){
                return "单元格值 = "+v;
            }
            else if(conditionName=="textContains"){
                return "单元格值包含 ="+v;
            }
            else if(conditionName=="occurrenceDate"){
                return conditionValue;
            }
            else if(conditionName=="duplicateValue"){
                if(conditionValue=="0"){
                    return "重复值";
                }
                if(conditionValue=="1"){
                    return "唯一值";
                }
            }
            else if(conditionName=="top10"){
                return "前 "+v+" 个";
            }
            else if(conditionName=="top10%"){
                return "前 "+v+"% 个";
            }
            else if(conditionName=="last10"){
                return "后 "+v+" 个";
            }
            else if(conditionName=="last10%"){
                return "后 "+v+"% 个";
            }
            else if(conditionName=="AboveAverage"){
                return "高于平均值";
            }
            else if(conditionName=="SubAverage"){
                return "低于平均值";
            }
        },
        newConditionRuleDialog: function(source){
            //规则说明
            var ruleExplainHtml = jfgrid.conditionformat.getRuleExplain(0);
            
            //弹出层
            $("#jfgrid-modal-dialog-mask").show();
            $("#jfgrid-administerRule-dialog").hide();
            $("#jfgrid-newConditionRule-dialog").remove();

            var content = '<div>' +
                            '<div class="boxTitle">选择规则类型：</div>' +
                            jfgrid.conditionformat.ruleTypeHtml +
                            '<div class="boxTitle">编辑规则说明：</div>' +
                            '<div class="ruleExplainBox">' +
                                ruleExplainHtml +
                            '</div>' +
                          '</div>';

            $("body").append(jfgrid.replaceHtml(modelHTML, { "id": "jfgrid-newConditionRule-dialog", "addclass": "jfgrid-newEditorRule-dialog", "title": "新建格式规则", "content": content, "botton": '<button id="jfgrid-newConditionRule-dialog-confirm" class="btn btn-primary" data-source="'+source+'">确定</button><button id="jfgrid-newConditionRule-dialog-close" class="btn btn-default" data-source="'+source+'">取消</button>', "style": "z-index:100003" }));
            var $t = $("#jfgrid-newConditionRule-dialog").find(".jfgrid-modal-dialog-content").css("min-width", 400).end(), myh = $t.outerHeight(), myw = $t.outerWidth();
            var winw = $(window).width(), winh = $(window).height();
            var scrollLeft = $(document).scrollLeft(), scrollTop = $(document).scrollTop();
            $("#jfgrid-newConditionRule-dialog").css({ "left": (winw + scrollLeft - myw) / 2, "top": (winh + scrollTop - myh) / 3 }).show();
            
            //index的规则类型focus
            $("#jfgrid-newConditionRule-dialog .ruleTypeBox .ruleTypeItem:eq(0)").addClass("on").siblings().removeClass("on");
        
            jfgrid.conditionformat.colorSelectInit();
        },
        editorConditionRuleDialog: function(){
            var rule = jfgrid.conditionformat.editorRule.data;
            var ruleType = rule["type"], ruleFormat = rule["format"];
            
            var index, type1;
            if(ruleType == "dataBar" || ruleType == "colorGradation" || ruleType == "icons"){
                index = 0;
                type1 = ruleType;
            }
            else{
                var conditionName = rule["conditionName"];

                if(conditionName == "greaterThan" || conditionName == "lessThan" || conditionName == "betweenness" || conditionName == "equal" || conditionName == "textContains" || conditionName == "occurrenceDate"){
                    index = 1;

                    if(conditionName == "greaterThan" || conditionName == "lessThan" || conditionName == "betweenness" || conditionName == "equal"){
                        type1 = "number";
                    }
                    else if(conditionName == "textContains"){
                        type1 = "text";
                    }
                    else if(conditionName == "occurrenceDate"){
                        type1 = "date";
                    }
                }
                else if(conditionName == "top10" || conditionName == "top10%" || conditionName == "last10" || conditionName == "last10%"){
                    index = 2;

                    if(conditionName == "top10" || conditionName == "top10%"){
                        type1 = "top";
                    }
                    else if(conditionName == "last10" || conditionName == "last10%"){
                        type1 = "last";
                    }
                }
                else if(conditionName == "AboveAverage" || conditionName == "SubAverage"){
                    index = 3;
                    type1 = conditionName;
                }
                else if(conditionName == "duplicateValue"){
                    index = 4;
                    type1 = rule["conditionValue"];
                }
            }

            //规则说明
            var ruleExplainHtml = jfgrid.conditionformat.getRuleExplain(index);
            
            //弹出层
            $("#jfgrid-modal-dialog-mask").show();
            $("#jfgrid-administerRule-dialog").hide();
            $("#jfgrid-editorConditionRule-dialog").remove();

            var content = '<div>' +
                            '<div class="boxTitle">选择规则类型：</div>' +
                            jfgrid.conditionformat.ruleTypeHtml +
                            '<div class="boxTitle">编辑规则说明：</div>' +
                            '<div class="ruleExplainBox">' +
                                ruleExplainHtml +
                            '</div>' +
                          '</div>';

            $("body").append(jfgrid.replaceHtml(modelHTML, { "id": "jfgrid-editorConditionRule-dialog", "addclass": "jfgrid-newEditorRule-dialog", "title": "编辑格式规则", "content": content, "botton": '<button id="jfgrid-editorConditionRule-dialog-confirm" class="btn btn-primary">确定</button><button id="jfgrid-editorConditionRule-dialog-close" class="btn btn-default">取消</button>', "style": "z-index:100003" }));
            var $t = $("#jfgrid-editorConditionRule-dialog").find(".jfgrid-modal-dialog-content").css("min-width", 400).end(), myh = $t.outerHeight(), myw = $t.outerWidth();
            var winw = $(window).width(), winh = $(window).height();
            var scrollLeft = $(document).scrollLeft(), scrollTop = $(document).scrollTop();
            $("#jfgrid-editorConditionRule-dialog").css({ "left": (winw + scrollLeft - myw) / 2, "top": (winh + scrollTop - myh) / 3 }).show();
            
            jfgrid.conditionformat.colorSelectInit();

            //规则类型focus
            $("#jfgrid-editorConditionRule-dialog .ruleTypeBox .ruleTypeItem:eq(" + index + ")").addClass("on").siblings().removeClass("on");
            
            //type1
            $("#jfgrid-editorConditionRule-dialog #type1").val(type1);
            if(type1 == "dataBar" || type1 == "colorGradation" || type1 == "icons" || type1 == "number" || type1 == "text" || type1 == "date"){
                $("#jfgrid-editorConditionRule-dialog ." + type1 + "Box").show();
                $("#jfgrid-editorConditionRule-dialog ." + type1 + "Box").siblings().hide();
            }
            if(type1 == "date"){
                jfgrid.conditionformat.daterangeInit("jfgrid-editorConditionRule-dialog");
            }

            //type2  format  value
            if(ruleType == "dataBar" || ruleType == "colorGradation" || ruleType == "icons"){
                if(type1 == "dataBar"){
                    if(ruleFormat.length == 2){
                        $("#jfgrid-editorConditionRule-dialog .dataBarBox #type2").val("gradient");
                    }
                    else if(ruleFormat.length == 1){
                        $("#jfgrid-editorConditionRule-dialog .dataBarBox #type2").val("solid");
                    }

                    $("#jfgrid-editorConditionRule-dialog .dataBarBox .jfgrid-conditionformat-config-color").spectrum("set", ruleFormat[0]);                
                }
                else if(type1 == "colorGradation"){
                    if(ruleFormat.length == 3){
                        $("#jfgrid-editorConditionRule-dialog .colorGradationBox #type2").val("threeColor");

                        $("#jfgrid-editorConditionRule-dialog .colorGradationBox .midVal").show();

                        $("#jfgrid-editorConditionRule-dialog .colorGradationBox .maxVal .jfgrid-conditionformat-config-color").spectrum("set", ruleFormat[0]);
                        $("#jfgrid-editorConditionRule-dialog .colorGradationBox .midVal .jfgrid-conditionformat-config-color").spectrum("set", ruleFormat[1]);
                        $("#jfgrid-editorConditionRule-dialog .colorGradationBox .minVal .jfgrid-conditionformat-config-color").spectrum("set", ruleFormat[2]);                    
                    }
                    else if(ruleFormat.length == 2){
                        $("#jfgrid-editorConditionRule-dialog .colorGradationBox #type2").val("twoColor");

                        $("#jfgrid-editorConditionRule-dialog .colorGradationBox .midVal").hide();

                        $("#jfgrid-editorConditionRule-dialog .colorGradationBox .maxVal .jfgrid-conditionformat-config-color").spectrum("set", ruleFormat[0]);
                        $("#jfgrid-editorConditionRule-dialog .colorGradationBox .minVal .jfgrid-conditionformat-config-color").spectrum("set", ruleFormat[1]);
                    }
                }
                else if(type1 == "icons"){
                    var len = ruleFormat["len"];
                    var l = ruleFormat["leftMin"];
                    var t = ruleFormat["top"];

                    $("#jfgrid-editorConditionRule-dialog .iconsBox li").each(function(i, e){
                        if($(e).find("div").attr("data-len") == len && $(e).find("div").attr("data-leftmin") == l && $(e).find("div").attr("data-top") == t){
                            $("#jfgrid-editorConditionRule-dialog .iconsBox .showbox .model").css("background-position", $(e).find("div").css("background-position"));
                            $("#jfgrid-editorConditionRule-dialog .iconsBox .showbox .model").attr("data-len", $(e).find("div").attr("data-len"));
                            $("#jfgrid-editorConditionRule-dialog .iconsBox .showbox .model").attr("data-leftmin", $(e).find("div").attr("data-leftmin"));
                            $("#jfgrid-editorConditionRule-dialog .iconsBox .showbox .model").attr("data-top", $(e).find("div").attr("data-leftmin"));
                            $("#jfgrid-editorConditionRule-dialog .iconsBox .showbox .model").attr("title", $(e).find("div").attr("title"));

                            return true;
                        }
                    });
                }
            }
            else{
                if(type1 == "number"){
                    $("#jfgrid-editorConditionRule-dialog .numberBox #type2").val(conditionName);

                    if(rule.conditionRange[0] != null){
                        var val1 = jfgrid.sheetmanage.getRangetxt(jfgrid.currentSheetIndex, { "row": rule.conditionRange[0]["row"], "column": rule.conditionRange[0]["column"] }, jfgrid.currentSheetIndex);
                    }
                    else{
                        var val1 = rule.conditionValue[0];
                    }

                    $("#jfgrid-editorConditionRule-dialog .numberBox #conditionVal input").val(val1);

                    if(conditionName == "betweenness"){
                        $("#jfgrid-editorConditionRule-dialog .numberBox .txt").show();
                        $("#jfgrid-editorConditionRule-dialog .numberBox #conditionVal2").show();

                        if(rule.conditionRange[1] != null){
                            var val2 = jfgrid.sheetmanage.getRangetxt(jfgrid.currentSheetIndex, { "row": rule.conditionRange[1]["row"], "column": rule.conditionRange[1]["column"] }, jfgrid.currentSheetIndex);
                        }
                        else{
                            var val2 = rule.conditionValue[1];
                        }

                        $("#jfgrid-editorConditionRule-dialog .numberBox #conditionVal2 input").val(val2);
                    }
                    else{
                        $("#jfgrid-editorConditionRule-dialog .numberBox .txt").hide();
                        $("#jfgrid-editorConditionRule-dialog .numberBox #conditionVal2").hide();
                    }
                }
                else if(type1 == "text"){
                    if(rule.conditionRange[0] != null){
                        var val1 = jfgrid.sheetmanage.getRangetxt(jfgrid.currentSheetIndex, { "row": rule.conditionRange[0]["row"], "column": rule.conditionRange[0]["column"] }, jfgrid.currentSheetIndex);
                    }
                    else{
                        var val1 = rule.conditionValue[0];
                    }

                    $("#jfgrid-editorConditionRule-dialog .textBox #conditionVal input").val(val1);
                }
                else if(type1 == "date"){
                    jfgrid.conditionformat.daterangeInit("jfgrid-editorConditionRule-dialog");

                    var val1 = rule.conditionValue[0];
                    $("#jfgrid-editorConditionRule-dialog .dateBox #daterange-btn").val(val1);
                }
                else if(type1 == "top" || type1 == "last"){
                    var val1 = rule.conditionValue[0];

                    if(conditionName == "top10%" || conditionName == "last10%"){
                        $("#jfgrid-editorConditionRule-dialog #isPercent").attr("checked","checked");
                    }
                }
            }
        },
        infoDialog: function(title, content){
            $("#jfgrid-modal-dialog-mask").show();
            $("#jfgrid-conditionformat-info-dialog").remove();
            $("body").append(jfgrid.replaceHtml(modelHTML, { "id": "jfgrid-conditionformat-info-dialog", "addclass": "", "title": title, "content": content, "botton": '<button id="jfgrid-conditionformat-info-dialog-close" class="btn btn-default">&nbsp;&nbsp;关闭&nbsp;&nbsp;</button>', "style": "z-index:100003" }));
            var $t = $("#jfgrid-conditionformat-info-dialog").find(".jfgrid-modal-dialog-content").css("min-width", 300).end(), myh = $t.outerHeight(), myw = $t.outerWidth();
            var winw = $(window).width(), winh = $(window).height();
            var scrollLeft = $(document).scrollLeft(), scrollTop = $(document).scrollTop();
            $("#jfgrid-conditionformat-info-dialog").css({ "left": (winw + scrollLeft - myw) / 2, "top": (winh + scrollTop - myh) / 3 }).show();
        },
        getRuleExplain: function(index){
            var textCellColorHtml = jfgrid.conditionformat.textCellColorHtml;
            
            switch(index){
                case 0: //基于各自值设置所有单元格的格式
                    var ruleExplainHtml = '<div class="title">基于各自值设置所有单元格的格式：</div>' +
                                          '<div style="height: 30px;margin-bottom: 5px;">' +
                                            '<label style="display: block;width: 80px;height: 30px;line-height: 30px;float: left;">格式样式：</label>' +
                                            '<select id="type1">' +
                                                '<option value="dataBar">数据条</option>' +
                                                '<option value="colorGradation">色阶</option>' +
                                                '<option value="icons">图标集</option>' +
                                            '</select>' +
                                          '</div>' +
                                          '<div>' +
                                            '<div class="type1Box dataBarBox">' +
                                                '<div style="height: 30px;margin-bottom: 5px;">' +
                                                    '<label style="display: block;width: 80px;height: 30px;line-height: 30px;float: left;">填充类型：</label>' +
                                                    '<select id="type2">' +
                                                        '<option value="gradient">渐变</option>' +
                                                        '<option value="solid">实心</option>' +
                                                    '</select>' +
                                                '</div>' +
                                                '<div style="height: 30px;margin-bottom: 5px;">' +
                                                    '<label style="display: block;width: 80px;height: 30px;line-height: 30px;float: left;">颜色：</label>' +
                                                    '<input data-tips="数据条颜色" data-func="background" class="jfgrid-conditionformat-config-color" type="text" value="#638ec6" style="display: none;">' +    
                                                '</div>' +
                                            '</div>' +
                                            '<div class="type1Box colorGradationBox" style="display: none;">' +
                                                '<div style="height: 30px;margin-bottom: 5px;">' +
                                                    '<label style="display: block;width: 80px;height: 30px;line-height: 30px;float: left;">填充类型：</label>' +
                                                    '<select id="type2">' +
                                                        '<option value="threeColor">三色</option>' +
                                                        '<option value="twoColor">双色</option>' +
                                                    '</select>' +
                                                '</div>' +
                                                '<div class="maxVal" style="height: 30px;margin-bottom: 5px;">' +
                                                    '<label style="display: block;width: 80px;height: 30px;line-height: 30px;float: left;">最大值：</label>' +
                                                    '<input data-tips="最大值颜色" data-func="background" class="jfgrid-conditionformat-config-color" type="text" value="rgb(99, 190, 123)" style="display: none;">' +
                                                '</div>' +
                                                '<div class="midVal" style="height: 30px;margin-bottom: 5px;">' +
                                                    '<label style="display: block;width: 80px;height: 30px;line-height: 30px;float: left;">中间值：</label>' +
                                                    '<input data-tips="中间值颜色" data-func="background" class="jfgrid-conditionformat-config-color" type="text" value="rgb(255, 235, 132)" style="display: none;">' +
                                                '</div>' +
                                                '<div class="minVal" style="height: 30px;margin-bottom: 5px;">' +
                                                    '<label style="display: block;width: 80px;height: 30px;line-height: 30px;float: left;">最小值：</label>' +
                                                    '<input data-tips="最小值颜色" data-func="background" class="jfgrid-conditionformat-config-color" type="text" value="rgb(248, 105, 107)" style="display: none;">' +
                                                '</div>' +
                                            '</div>' +
                                            '<div class="type1Box iconsBox" style="display: none;">' +
                                                '<label>填充类型：</label>' +
                                                '<div class="showbox">' +
                                                    '<div class="model" data-len="3" data-leftmin="0" data-top="0" title="三向箭头(彩色)" style="background-position: 0 0;"></div>' +
                                                    '<span class="ui-selectmenu-icon ui-icon ui-icon-triangle-1-s" style="margin-top: 2px;"></span>' +
                                                '</div>' +
                                                '<ul>' +
                                                    '<li><div data-len="3" data-leftmin="0" data-top="0" title="三向箭头(彩色)" style="background-position: 0 0;"></div></li>' +
                                                    '<li><div data-len="3" data-leftmin="5" data-top="0" title="三向箭头(灰色)" style="background-position: -131px 0;"></div></li>' +
                                                    '<li><div data-len="3" data-leftmin="0" data-top="1" title="3个三角形" style="background-position: 0 -20px;"></div></li>' +
                                                    '<li><div data-len="4" data-leftmin="0" data-top="2" title="四向箭头(彩色)" style="background-position: 0 -40px;"></div></li>' +
                                                    '<li><div data-len="4" data-leftmin="5" data-top="1" title="四向箭头(灰色)" style="background-position: -131px -20px;"></div></li>' +
                                                    '<li><div data-len="5" data-leftmin="0" data-top="3" title="五向箭头(彩色)" style="background-position: 0 -60px;"></div></li>' +
                                                    '<li><div data-len="5" data-leftmin="5" data-top="2" title="五向箭头(灰色)" style="background-position: -131px -40px;"></div></li>' +
                                                    '<li><div data-len="3" data-leftmin="0" data-top="4" title="三色交通灯(无边框)" style="background-position: 0 -80px;"></div></li>' +
                                                    '<li><div data-len="3" data-leftmin="5" data-top="4" title="三色交通灯(有边框)" style="background-position: -131px -80px;"></div></li>' +
                                                    '<li><div data-len="3" data-leftmin="0" data-top="5" title="三标志" style="background-position: 0 -100px;"></div></li>' +
                                                    '<li><div data-len="4" data-leftmin="5" data-top="5" title="四色交通灯" style="background-position: -131px -100px;"></div></li>' +
                                                    '<li><div data-len="4" data-leftmin="0" data-top="6" title="绿-红-黑渐变" style="background-position: 0 -120px;"></div></li>' +
                                                    '<li><div data-len="3" data-leftmin="0" data-top="7" title="三个符号(有圆圈)" style="background-position: 0 -140px;"></div></li>' +
                                                    '<li><div data-len="3" data-leftmin="5" data-top="7" title="三个符号(无圆圈)" style="background-position: -131px -140px;"></div></li>' +
                                                    '<li><div data-len="3" data-leftmin="0" data-top="8" title="三色旗" style="background-position: 0 -160px;"></div></li>' +
                                                    '<li><div data-len="3" data-leftmin="0" data-top="9" title="3个星形" style="background-position: 0 -180px;"></div></li>' +
                                                    '<li><div data-len="5" data-leftmin="0" data-top="10" title="五象限图" style="background-position: 0 -200px;"></div></li>' +
                                                    '<li><div data-len="5" data-leftmin="0" data-top="11" title="5个框" style="background-position: 0 -220px;"></div></li>' +
                                                    '<li><div data-len="4" data-leftmin="5" data-top="9" title="四等级" style="background-position: -131px -180px;"></div></li>' +
                                                    '<li><div data-len="5" data-leftmin="5" data-top="10" title="五等级" style="background-position: -131px -200px;"></div></li>' +
                                                '</ul>' +
                                            '</div>' +
                                          '</div>';
                    break;
                case 1: //只为包含以下内容的单元格设置格式
                    var ruleExplainHtml = '<div class="title">只为满足以下条件的单元格：</div>' +
                                          '<div style="height: 30px;margin-bottom: 10px;">' +
                                            '<select id="type1">' +
                                                '<option value="number">单元格值</option>' +
                                                '<option value="text">特定文本</option>' +
                                                '<option value="date">发生日期</option>' +
                                            '</select>'+
                                            '<div>' +
                                                '<div class="type1Box numberBox">' +
                                                    '<select id="type2">' +
                                                        '<option value="greaterThan">大于</option>' +
                                                        '<option value="lessThan">小于</option>' +
                                                        '<option value="betweenness">介于</option>' +
                                                        '<option value="equal">等于</option>' +
                                                    '</select>' +
                                                    '<div class="inpbox range" id="conditionVal">' +
                                                        '<input class="formulaInputFocus"/><i class="fa fa-table" aria-hidden="true" title="点击选择单元格"></i>' +
                                                    '</div>' +
                                                    '<span class="txt" style="display: none;">到</span>' +
                                                    '<div class="inpbox range" id="conditionVal2" style="display: none;">' +
                                                        '<input class="formulaInputFocus"/><i class="fa fa-table" aria-hidden="true" title="点击选择数据范围"></i>' +
                                                    '</div>' +
                                                '</div>' +
                                                '<div class="type1Box textBox" style="display: none;">' +
                                                    '<select id="type2">' +
                                                        '<option value="">包含</option>' +
                                                    '</select>' +
                                                    '<div class="inpbox range" id="conditionVal">' +
                                                        '<input class="formulaInputFocus"/><i class="fa fa-table" aria-hidden="true" title="点击选择单元格"></i>' +
                                                    '</div>' +
                                                '</div>' +
                                                '<div class="type1Box dateBox" style="display: none;">' +
                                                    '<div style="width: 162px;" class="inpbox">' +
                                                        '<input style="width: 150px;" id="daterange-btn" readonly="readonly" placeholder="请选择日期"/>' +
                                                    '</div>' +
                                                '</div>' +
                                            '</div>' +
                                          '</div>' +
                                          '<div class="title">设置格式：</div>' + textCellColorHtml;
                    break;
                case 2: //仅对排名靠前或靠后的数值设置格式
                    var ruleExplainHtml = '<div class="title">为以下排名内的值：</div>'+
                                          '<div style="height: 30px;margin-bottom: 10px;">'+
                                            '<select id="type1">'+
                                                '<option value="top">前</option>'+
                                                '<option value="last">后</option>'+
                                            '</select>'+
                                            '<div class="inpbox" id="conditionVal">'+
                                                '<input class="formulaInputFocus" type="number" value="10"/>'+
                                            '</div>'+
                                            '<input id="isPercent" type="checkbox"/>'+
                                            '<label for="isPercent" class="txt">所选范围的百分比</label>'+
                                          '</div>'+
                                          '<div class="title">设置格式：</div>' + textCellColorHtml;
                    break;
                case 3: //仅对高于或低于平均值的数值设置格式
                    var ruleExplainHtml = '<div class="title">为满足以下条件的值：</div>'+
                                          '<div style="height: 30px;margin-bottom: 10px;">'+
                                            '<select id="type1">'+
                                                '<option value="AboveAverage">高于</option>'+
                                                '<option value="SubAverage">低于</option>'+
                                            '</select>'+
                                            '<span class="txt">选定范围的平均值</span>'+
                                          '</div>'+
                                          '<div class="title">设置格式：</div>' + textCellColorHtml;
                    break;
                case 4: //仅对唯一值或重复值设置格式
                    var ruleExplainHtml = '<div class="title">全部：</div>'+
                                          '<div style="height: 30px;margin-bottom: 10px;">'+
                                            '<select id="type1">'+
                                                '<option value="0">重复</option>'+
                                                '<option value="1">唯一</option>'+
                                            '</select>'+
                                            '<span class="txt">选定范围中的数值</span>'+
                                          '</div>'+
                                          '<div class="title">设置格式：</div>' + textCellColorHtml;
                    break;
            }

            return ruleExplainHtml;
        },
        daterangeInit: function(id){
            //日期选择插件
            $('.ranges_1 ul').remove();
            $('#' + id).find("#daterange-btn").daterangepicker({
                ranges: 
                    {
                        // '全部': [moment(), moment().subtract(-1, 'days')],
                        '昨天': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
                        '今天': [moment(), moment()],
                        // '明天': [moment().subtract(-1, 'days'), moment().subtract(-1, 'days')],
                        '上周': [moment(moment().subtract(1, 'week')).subtract(new Date().getDay() - 1, 'days'), moment().subtract(new Date().getDay(), 'days')],
                        '本周': [moment().subtract(new Date().getDay() - 1, 'days'), moment().add(7 - new Date().getDay(), 'days')],
                        '上月': [moment(moment().format('YYYY-MM')).subtract(1, 'month'), moment(moment().format('YYYY-MM')).subtract(1, 'day')],
                        '本月': [moment().format('YYYY-MM'), moment(moment(moment().format('YYYY-MM')).add(1, 'month')).subtract(1, 'day')],
                        '去年': [moment(moment(moment().format('YYYY'))).subtract(1, 'years').format('YYYY'), moment(moment().format('YYYY')).subtract(1, 'day')],
                        '本年': [moment().format('YYYY'), moment(moment(moment().add(1, 'years')).format('YYYY')).subtract(1, 'day')],
                        '最近7天': [moment().subtract(6, 'days'), moment()],
                        '最近30天': [moment().subtract(29, 'days'), moment()]
                        // '未来七天': [moment(),moment().subtract(-6, 'days')],
                        // '未来30天': [moment(),moment().subtract(-29, 'days')],
                        // '未来60天': [moment(),moment().subtract(-59, 'days'), ]
                    },
                    startDate: moment(),
                    endDate: moment()
                },
                function(start, end,label) {
                    //label:通过它来知道用户选择的是什么，传给后台进行相应的展示
                    if(label == '全部'){
                        $('#daterange-btn').val('');
                    }
                    else if(label == '昨天' || label == '今天'){
                        $('#daterange-btn').val(start.format('YYYY/MM/DD'));
                    }
                    else if(label == '上周' || label == '本周' || label == '上月' || label == '本月' || label == '去年' || label == '本年' || label == '最近7天' || label == '最近30天'){
                        $('#daterange-btn').val(start.format('YYYY/MM/DD')+'-'+end.format('YYYY/MM/DD'));
                    }
                }
            ); 
        },
        CFSplitRange: function(range1, range2, range3, type){
            var range = [];

            var offset_r = range3["row"][0] - range2["row"][0];
            var offset_c = range3["column"][0] - range2["column"][0];
            
            var r1 = range1["row"][0], r2 = range1["row"][1];
            var c1 = range1["column"][0], c2 = range1["column"][1];

            if(r1 >= range2["row"][0] && r2 <= range2["row"][1] && c1 >= range2["column"][0] && c2 <= range2["column"][1]){
                //选区 包含 条件格式应用范围 全部

                if(type == "allPart"){ //所有部分
                    range = [
                        { "row": [r1 + offset_r, r2 + offset_r], "column": [c1 + offset_c, c2 + offset_c] }
                    ];
                }
                else if(type == "restPart"){ //剩余部分
                    range = [];
                }
                else if(type == "operatePart"){ //操作部分
                    range = [
                        { "row": [r1 + offset_r, r2 + offset_r], "column": [c1 + offset_c, c2 + offset_c] }
                    ];
                }
            }
            else if(r1 >= range2["row"][0] && r1 <= range2["row"][1] && c1 >= range2["column"][0] && c2 <= range2["column"][1]){
                //选区 行贯穿 条件格式应用范围 上部分

                if(type == "allPart"){ //所有部分
                    range = [
                        { "row": [range2["row"][1] + 1, r2], "column": [c1, c2] },
                        { "row": [r1 + offset_r, range2["row"][1] + offset_r], "column": [c1 + offset_c, c2 + offset_c] }
                    ]; 
                }
                else if(type == "restPart"){ //剩余部分
                    range = [
                        { "row": [range2["row"][1] + 1, r2], "column": [c1, c2] }
                    ];
                }
                else if(type == "operatePart"){ //操作部分
                    range = [
                        { "row": [r1 + offset_r, range2["row"][1] + offset_r], "column": [c1 + offset_c, c2 + offset_c] }
                    ];
                }
            }
            else if(r2 >= range2["row"][0] && r2 <= range2["row"][1] && c1 >= range2["column"][0] && c2 <= range2["column"][1]){
                //选区 行贯穿 条件格式应用范围 下部分

                if(type == "allPart"){ //所有部分
                    range = [
                        { "row": [r1, range2["row"][0] - 1], "column": [c1, c2] },
                        { "row": [range2["row"][0] + offset_r, r2 + offset_r], "column": [c1 + offset_c, c2 + offset_c] }
                    ]; 
                }
                else if(type == "restPart"){ //剩余部分
                    range = [
                        { "row": [r1, range2["row"][0] - 1], "column": [c1, c2] }
                    ];
                }
                else if(type == "operatePart"){ //操作部分
                    range = [
                        { "row": [range2["row"][0] + offset_r, r2 + offset_r], "column": [c1 + offset_c, c2 + offset_c] }
                    ];
                }
            }
            else if(r1 < range2["row"][0] && r2 > range2["row"][1] && c1 >= range2["column"][0] && c2 <= range2["column"][1]){
                //选区 行贯穿 条件格式应用范围 中间部分

                if(type == "allPart"){ //所有部分
                    range = [
                        { "row": [r1, range2["row"][0] - 1], "column": [c1, c2] },
                        { "row": [range2["row"][1] + 1, r2], "column": [c1, c2] },
                        { "row": [range2["row"][0] + offset_r, range2["row"][1] + offset_r], "column": [c1 + offset_c, c2 + offset_c] }
                    ];
                }
                else if(type == "restPart"){ //剩余部分
                    range = [
                        { "row": [r1, range2["row"][0] - 1], "column": [c1, c2] },
                        { "row": [range2["row"][1] + 1, r2], "column": [c1, c2] }
                    ];
                }
                else if(type == "operatePart"){ //操作部分
                    range = [
                        { "row": [range2["row"][0] + offset_r, range2["row"][1] + offset_r], "column": [c1 + offset_c, c2 + offset_c] }
                    ];
                }
            }
            else if(c1 >= range2["column"][0] && c1 <= range2["column"][1] && r1 >= range2["row"][0] && r2 <= range2["row"][1]){
                //选区 列贯穿 条件格式应用范围 左部分 

                if(type == "allPart"){ //所有部分
                    range = [
                        { "row": [r1, r2], "column": [range2["column"][1] + 1, c2] },
                        { "row": [r1 + offset_r, r2 + offset_r], "column": [c1 + offset_c, range2["column"][1] + offset_c] }
                    ];
                }
                else if(type == "restPart"){ //剩余部分
                    range = [
                        { "row": [r1, r2], "column": [range2["column"][1] + 1, c2] }
                    ];
                }
                else if(type == "operatePart"){ //操作部分
                    range = [
                        { "row": [r1 + offset_r, r2 + offset_r], "column": [c1 + offset_c, range2["column"][1] + offset_c] }
                    ];
                }
            }
            else if(c2 >= range2["column"][0] && c2 <= range2["column"][1] && r1 >= range2["row"][0] && r2 <= range2["row"][1]){
                //选区 列贯穿 条件格式应用范围 右部分

                if(type == "allPart"){ //所有部分
                    range = [
                        { "row": [r1, r2], "column": [c1, range2["column"][0] - 1] },
                        { "row": [r1 + offset_r, r2 + offset_r], "column": [range2["column"][0] + offset_c, c2 + offset_c] }
                    ]; 
                }
                else if(type == "restPart"){ //剩余部分
                    range = [
                        { "row": [r1, r2], "column": [c1, range2["column"][0] - 1] }
                    ];
                }
                else if(type == "operatePart"){ //操作部分
                    range = [
                        { "row": [r1 + offset_r, r2 + offset_r], "column": [range2["column"][0] + offset_c, c2 + offset_c] }
                    ];
                }
            }
            else if(c1 < range2["column"][0] && c2 > range2["column"][1] && r1 >= range2["row"][0] && r2 <= range2["row"][1]){
                //选区 列贯穿 条件格式应用范围 中间部分

                if(type == "allPart"){ //所有部分
                    range = [
                        { "row": [r1, r2], "column": [c1, range2["column"][0] - 1] },
                        { "row": [r1, r2], "column": [range2["column"][1] + 1, c2] },
                        { "row": [r1 + offset_r, r2 + offset_r], "column": [range2["column"][0] + offset_c, range2["column"][1] + offset_c] }
                    ];
                }
                else if(type == "restPart"){ //剩余部分
                    range = [
                        { "row": [r1, r2], "column": [c1, range2["column"][0] - 1] },
                        { "row": [r1, r2], "column": [range2["column"][1] + 1, c2] }
                    ];
                }
                else if(type == "operatePart"){ //操作部分
                    range = [
                        { "row": [r1 + offset_r, r2 + offset_r], "column": [range2["column"][0] + offset_c, range2["column"][1] + offset_c] }
                    ];
                }
            }
            else if(r1 >= range2["row"][0] && r1 <= range2["row"][1] && c1 >= range2["column"][0] && c1 <= range2["column"][1]){
                //选区 包含 条件格式应用范围 左上角部分

                if(type == "allPart"){ //所有部分
                    range = [
                        { "row": [r1, range2["row"][1]], "column": [range2["column"][1] + 1, c2] },
                        { "row": [range2["row"][1] + 1, r2], "column": [c1, c2] },
                        { "row": [r1 + offset_r, range2["row"][1] + offset_r], "column": [c1 + offset_c, range2["column"][1] + offset_c] }
                    ]; 
                }
                else if(type == "restPart"){ //剩余部分
                    range = [
                        { "row": [r1, range2["row"][1]], "column": [range2["column"][1] + 1, c2] },
                        { "row": [range2["row"][1] + 1, r2], "column": [c1, c2] }
                    ];
                }
                else if(type == "operatePart"){ //操作部分
                    range = [
                        { "row": [r1 + offset_r, range2["row"][1] + offset_r], "column": [c1 + offset_c, range2["column"][1] + offset_c] }
                    ];
                }
            }
            else if(r1 >= range2["row"][0] && r1 <= range2["row"][1] && c2 >= range2["column"][0] && c2 <= range2["column"][1]){
                //选区 包含 条件格式应用范围 右上角部分

                if(type == "allPart"){ //所有部分
                    range = [
                        { "row": [r1, range2["row"][1]], "column": [c1, range2["column"][0] - 1] },
                        { "row": [range2["row"][1] + 1, r2], "column": [c1, c2] },
                        { "row": [r1 + offset_r, range2["row"][1] + offset_r], "column": [range2["column"][0] + offset_c, c2 + offset_c] }
                    ]; 
                }
                else if(type == "restPart"){ //剩余部分
                    range = [
                        { "row": [r1, range2["row"][1]], "column": [c1, range2["column"][0] - 1] },
                        { "row": [range2["row"][1] + 1, r2], "column": [c1, c2] }
                    ];
                }
                else if(type == "operatePart"){ //操作部分
                    range = [
                        { "row": [r1 + offset_r, range2["row"][1] + offset_r], "column": [range2["column"][0] + offset_c, c2 + offset_c] }
                    ];
                }
            }
            else if(r2 >= range2["row"][0] && r2 <= range2["row"][1] && c1 >= range2["column"][0] && c1 <= range2["column"][1]){
                //选区 包含 条件格式应用范围 左下角部分

                if(type == "allPart"){ //所有部分
                    range = [
                        { "row": [r1, range2["row"][0] - 1], "column": [c1, c2] },
                        { "row": [range2["row"][0], r2], "column": [range2["column"][1] + 1, c2] },
                        { "row": [range2["row"][0] + offset_r, r2 + offset_r], "column": [c1 + offset_c, range2["column"][1] + offset_c] }
                    ];
                }
                else if(type == "restPart"){ //剩余部分
                    range = [
                        { "row": [r1, range2["row"][0] - 1], "column": [c1, c2] },
                        { "row": [range2["row"][0], r2], "column": [range2["column"][1] + 1, c2] }
                    ];
                }
                else if(type == "operatePart"){ //操作部分
                    range = [
                        { "row": [range2["row"][0] + offset_r, r2 + offset_r], "column": [c1 + offset_c, range2["column"][1] + offset_c] }
                    ];
                }
            }
            else if(r2 >= range2["row"][0] && r2 <= range2["row"][1] && c2 >= range2["column"][0] && c2 <= range2["column"][1]){
                //选区 包含 条件格式应用范围 右下角部分

                if(type == "allPart"){ //所有部分
                    range = [
                        { "row": [r1, range2["row"][0] - 1], "column": [c1, c2] },
                        { "row": [range2["row"][0], r2], "column": [c1, range2["column"][0] - 1] },
                        { "row": [range2["row"][0] + offset_r, r2 + offset_r], "column": [range2["column"][0] + offset_c, c2 + offset_c] }
                    ];
                }
                else if(type == "restPart"){ //剩余部分
                    range = [
                        { "row": [r1, range2["row"][0] - 1], "column": [c1, c2] },
                        { "row": [range2["row"][0], r2], "column": [c1, range2["column"][0] - 1] }
                    ];
                }
                else if(type == "operatePart"){ //操作部分
                    range = [
                        { "row": [range2["row"][0] + offset_r, r2 + offset_r], "column": [range2["column"][0] + offset_c, c2 + offset_c] }
                    ];
                }
            }
            else if(r1 < range2["row"][0] && r2 > range2["row"][1] && c1 >= range2["column"][0] && c1 <= range2["column"][1]){
                //选区 包含 条件格式应用范围 左中间部分

                if(type == "allPart"){ //所有部分
                    range = [
                        { "row": [r1, range2["row"][0] - 1], "column": [c1, c2] },
                        { "row": [range2["row"][0], range2["row"][1]], "column": [range2["column"][1] + 1, c2] },
                        { "row": [range2["row"][1] + 1, r2], "column": [c1, c2] },
                        { "row": [range2["row"][0] + offset_r, range2["row"][1] + offset_r], "column": [c1 + offset_c, range2["column"][1] + offset_c] }
                    ]; 
                }
                else if(type == "restPart"){ //剩余部分
                    range = [
                        { "row": [r1, range2["row"][0] - 1], "column": [c1, c2] },
                        { "row": [range2["row"][0], range2["row"][1]], "column": [range2["column"][1] + 1, c2] },
                        { "row": [range2["row"][1] + 1, r2], "column": [c1, c2] }
                    ];
                }
                else if(type == "operatePart"){ //操作部分
                    range = [
                        { "row": [range2["row"][0] + offset_r, range2["row"][1] + offset_r], "column": [c1 + offset_c, range2["column"][1] + offset_c] }
                    ];
                }
            }
            else if(r1 < range2["row"][0] && r2 > range2["row"][1] && c2 >= range2["column"][0] && c2 <= range2["column"][1]){
                //选区 包含 条件格式应用范围 右中间部分

                if(type == "allPart"){ //所有部分
                    range = [
                        { "row": [r1, range2["row"][0] - 1], "column": [c1, c2] },
                        { "row": [range2["row"][0], range2["row"][1]], "column": [c1, range2["column"][0] - 1] },
                        { "row": [range2["row"][1] + 1, r2], "column": [c1, c2] },
                        { "row": [range2["row"][0] + offset_r, range2["row"][1] + offset_r], "column": [range2["column"][0] + offset_c, c2 + offset_c] }
                    ];
                }
                else if(type == "restPart"){ //剩余部分
                    range = [
                        { "row": [r1, range2["row"][0] - 1], "column": [c1, c2] },
                        { "row": [range2["row"][0], range2["row"][1]], "column": [c1, range2["column"][0] - 1] },
                        { "row": [range2["row"][1] + 1, r2], "column": [c1, c2] }
                    ];
                }
                else if(type == "operatePart"){ //操作部分
                    range = [
                        { "row": [range2["row"][0] + offset_r, range2["row"][1] + offset_r], "column": [range2["column"][0] + offset_c, c2 + offset_c] }
                    ];
                }
            }
            else if(c1 < range2["column"][0] && c2 > range2["column"][1] && r1 >= range2["row"][0] && r1 <= range2["row"][1]){
                //选区 包含 条件格式应用范围 上中间部分

                if(type == "allPart"){ //所有部分
                    range = [
                        { "row": [r1, range2["row"][1]], "column": [c1, range2["column"][0] - 1] },
                        { "row": [r1, range2["row"][1]], "column": [range2["column"][1] + 1, c2] },
                        { "row": [range2["row"][1] + 1, r2], "column": [c1, c2] },
                        { "row": [r1 + offset_r, range2["row"][1] + offset_r], "column": [range2["column"][0] + offset_c, range2["column"][1] + offset_c] }
                    ]; 
                }
                else if(type == "restPart"){ //剩余部分
                    range = [
                        { "row": [r1, range2["row"][1]], "column": [c1, range2["column"][0] - 1] },
                        { "row": [r1, range2["row"][1]], "column": [range2["column"][1] + 1, c2] },
                        { "row": [range2["row"][1] + 1, r2], "column": [c1, c2] }
                    ];
                }
                else if(type == "operatePart"){ //操作部分
                    range = [
                        { "row": [r1 + offset_r, range2["row"][1] + offset_r], "column": [range2["column"][0] + offset_c, range2["column"][1] + offset_c] }
                    ];
                }
            }
            else if(c1 < range2["column"][0] && c2 > range2["column"][1] && r2 >= range2["row"][0] && r2 <= range2["row"][1]){
                //选区 包含 条件格式应用范围 下中间部分

                if(type == "allPart"){ //所有部分
                    range = [
                        { "row": [r1, range2["row"][0] - 1], "column": [c1, c2] },
                        { "row": [range2["row"][0], r2], "column": [c1, range2["column"][0] - 1] },
                        { "row": [range2["row"][0], r2], "column": [range2["column"][1] + 1, c2] },
                        { "row": [range2["row"][0] + offset_r, r2 + offset_r], "column": [range2["column"][0] + offset_c, range2["column"][1] + offset_c] }
                    ];
                }
                else if(type == "restPart"){ //剩余部分
                    range = [
                        { "row": [r1, range2["row"][0] - 1], "column": [c1, c2] },
                        { "row": [range2["row"][0], r2], "column": [c1, range2["column"][0] - 1] },
                        { "row": [range2["row"][0], r2], "column": [range2["column"][1] + 1, c2] }
                    ];
                }
                else if(type == "operatePart"){ //操作部分
                    range = [
                        { "row": [range2["row"][0] + offset_r, r2 + offset_r], "column": [range2["column"][0] + offset_c, range2["column"][1] + offset_c] }
                    ];
                }
            }
            else if(r1 < range2["row"][0] && r2 > range2["row"][1] && c1 < range2["column"][0] && c2 > range2["column"][1]){
                //选区 包含 条件格式应用范围 正中间部分

                if(type == "allPart"){ //所有部分
                    range = [
                        { "row": [r1, range2["row"][0] - 1], "column": [c1, c2] },
                        { "row": [range2["row"][0], range2["row"][1]], "column": [c1, range2["column"][0] - 1] },
                        { "row": [range2["row"][0], range2["row"][1]], "column": [range2["column"][1] + 1, c2] },
                        { "row": [range2["row"][1] + 1, r2], "column": [c1, c2] },
                        { "row": [range2["row"][0] + offset_r, range2["row"][1] + offset_r], "column": [range2["column"][0] + offset_c, range2["column"][1] + offset_c] }
                    ];
                }
                else if(type == "restPart"){ //剩余部分
                    range = [
                        { "row": [r1, range2["row"][0] - 1], "column": [c1, c2] },
                        { "row": [range2["row"][0], range2["row"][1]], "column": [c1, range2["column"][0] - 1] },
                        { "row": [range2["row"][0], range2["row"][1]], "column": [range2["column"][1] + 1, c2] },
                        { "row": [range2["row"][1] + 1, r2], "column": [c1, c2] }
                    ];
                }
                else if(type == "operatePart"){ //操作部分
                    range = [
                        { "row": [range2["row"][0] + offset_r, range2["row"][1] + offset_r], "column": [range2["column"][0] + offset_c, range2["column"][1] + offset_c] }
                    ];
                }
            }
            else{
                //选区 在 条件格式应用范围 之外

                if(type == "allPart"){ //所有部分
                    range = [
                        { "row": [r1, r2], "column": [c1, c2] }
                    ];
                }
                else if(type == "restPart"){ //剩余部分
                    range = [
                        { "row": [r1, r2], "column": [c1, c2] }
                    ];
                }
                else if(type == "operatePart"){ //操作部分
                    range = [];
                }
            }

            return range;
        },
        getcolorGradation: function(color1, color2, value1, value2, value){
            var rgb1 = color1.split(',');
            var r1 = parseInt(rgb1[0].split('(')[1]);
            var g1 = parseInt(rgb1[1]);
            var b1 = parseInt(rgb1[2].split(')')[0]);

            var rgb2 = color2.split(',');
            var r2 = parseInt(rgb2[0].split('(')[1]);
            var g2 = parseInt(rgb2[1]);
            var b2 = parseInt(rgb2[2].split(')')[0]);

            var r = Math.round(r1 - (r1 - r2) / (value1 - value2) * (value1 - value));
            var g = Math.round(g1 - (g1 - g2) / (value1 - value2) * (value1 - value));
            var b = Math.round(b1 - (b1 - b2) / (value1 - value2) * (value1 - value));

            return "rgb("+ r +", "+ g +", "+ b +")";
        },
        getCFPartRange: function(sheetIndex, range1, range2){
            var ruleArr = [];

            var cf = jfgridfile[jfgrid.sheetmanage.getSheetIndex(sheetIndex)].jfgrid_conditionformat_save;
            if(cf != null && cf.length > 0){
                label:  for(var i = 0; i < cf.length; i++){
                            var cellrange = cf[i].cellrange;

                            for(var j = 0; j < cellrange.length; j++){
                                var r1 = cellrange[j].row[0], r2 = cellrange[j].row[1];
                                var c1 = cellrange[j].column[0], c2 = cellrange[j].column[1];

                                for(var s = 0; s < range.length; s++){
                                    if((range[s].row[0] >= r1 && range[s].row[0] <= r2) || (range[s].row[1] >= r1 && range[s].row[1] <= r2) || (range[s].column[0] >= c1 && range[s].column[0] <= c2) || (range[s].column[1] >= c1 && range[s].column[1] <= c2)){
                                        ruleArr.push(cf[i]);

                                        continue label;
                                    }
                                }
                            }
                        }
            }

            return ruleArr;
        },
        checksCF: function(r, c, computeMap){
            if(computeMap != null &&　(r + "_" + c) in computeMap){
                return computeMap[r + "_" + c];
            }
            else{
                return null;
            }
        },
        getComputeMap: function(){
            var index = jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex);

            var ruleArr = jfgridfile[index]["jfgrid_conditionformat_save"];
            var data = jfgridfile[index]["data"];

            if(data == null){
                return null;
            }

            var computeMap = jfgrid.conditionformat.compute(ruleArr, data);

            return computeMap;
        },
        compute: function(ruleArr, d){
            if(ruleArr == null){
                ruleArr = [];
            }

            //条件计算存储
            var computeMap = {};

            if(ruleArr.length > 0){
                for(var i = 0; i < ruleArr.length; i++){
                    var type = ruleArr[i]["type"];
                    var cellrange = ruleArr[i]["cellrange"];
                    var format = ruleArr[i]["format"];

                    if(type == "dataBar"){ //数据条
                        var max = null, min = null;

                        for(var s = 0; s < cellrange.length; s++){
                            for(var r = cellrange[s].row[0]; r <= cellrange[s].row[1]; r++){
                                for(var c = cellrange[s].column[0]; c <= cellrange[s].column[1]; c++){
                                    if(d[r] == null || d[r][c] == null){
                                        continue;
                                    }

                                    var cell = d[r][c];

                                    if(jfgrid.getObjType(cell) == "object" && cell["ct"] != null && cell["ct"].t == "n" && cell.v != null){
                                        if(max == null || parseInt(cell.v) > max){
                                            max = parseInt(cell.v);
                                        }

                                        if(min == null || parseInt(cell.v) < min){
                                            min = parseInt(cell.v);
                                        }
                                    }
                                }
                            }
                        }

                        if(max != null && min != null){
                            if(min < 0){ //选区范围内有负数
                                var plusLen = Math.round(max / (max - min) * 10) / 10;                //正数所占比
                                var minusLen = Math.round(Math.abs(min) / (max - min) * 10) / 10;     //负数所占比

                                for(var s = 0; s < cellrange.length; s++){
                                    for(var r = cellrange[s].row[0]; r <= cellrange[s].row[1]; r++){
                                        for(var c = cellrange[s].column[0]; c <= cellrange[s].column[1]; c++){
                                            if(d[r] == null || d[r][c] == null){
                                                continue;
                                            }

                                            var cell = d[r][c];

                                            if(jfgrid.getObjType(cell) == "object" && cell["ct"] != null && cell["ct"].t == "n" && cell.v != null){
                                                if(parseInt(cell.v) < 0){ //负数
                                                    var valueLen = Math.round(Math.abs(parseInt(cell.v)) / Math.abs(min) * 100) / 100;

                                                    if((r + "_" + c) in computeMap){
                                                        computeMap[r + "_" + c]["dataBar"] = { "valueType": "minus", "minusLen": minusLen, "valueLen": valueLen, "format": format };
                                                    }
                                                    else{
                                                        computeMap[r + "_" + c] = { "dataBar": { "valueType": "minus", "minusLen": minusLen, "valueLen": valueLen, "format": format } };    
                                                    }
                                                }

                                                if(parseInt(cell.v) > 0){ //正数
                                                    var valueLen = Math.round(parseInt(cell.v) / max * 100) / 100;

                                                    if((r + "_" + c) in computeMap){
                                                        computeMap[r + "_" + c]["dataBar"] = { "valueType": "plus", "plusLen": plusLen, "minusLen": minusLen, "valueLen": valueLen, "format": format };
                                                    }
                                                    else{
                                                        computeMap[r + "_" + c] = { "dataBar": { "valueType": "plus", "plusLen": plusLen, "minusLen": minusLen, "valueLen": valueLen, "format": format } };    
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                            else{
                                var plusLen = 1;

                                for(var s = 0; s < cellrange.length; s++){
                                    for(var r = cellrange[s].row[0]; r <= cellrange[s].row[1]; r++){
                                        for(var c = cellrange[s].column[0]; c <= cellrange[s].column[1]; c++){
                                            if(d[r] == null || d[r][c] == null){
                                                continue;
                                            }

                                            var cell = d[r][c];

                                            if(jfgrid.getObjType(cell) == "object" && cell["ct"] != null && cell["ct"].t == "n" && cell.v != null){
                                                if(max == 0){
                                                    var valueLen = 1;
                                                }
                                                else{
                                                    var valueLen = Math.round(parseInt(cell.v) / max * 100) / 100;
                                                }

                                                if((r + "_" + c) in computeMap){
                                                    computeMap[r + "_" + c]["dataBar"] = { "valueType": "plus", "plusLen": plusLen, "valueLen": valueLen, "format": format };
                                                }
                                                else{
                                                    computeMap[r + "_" + c] = { "dataBar": { "valueType": "plus", "plusLen": plusLen, "valueLen": valueLen, "format": format } };    
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                    else if(type == "colorGradation"){ //色阶
                        var max = null, min = null, sum = 0, count = 0;

                        for(var s = 0; s < cellrange.length; s++){
                            for(var r = cellrange[s].row[0]; r <= cellrange[s].row[1]; r++){
                                for(var c = cellrange[s].column[0]; c <= cellrange[s].column[1]; c++){
                                    if(d[r] == null || d[r][c] == null){
                                        continue;
                                    }

                                    var cell = d[r][c];

                                    if(jfgrid.getObjType(cell) == "object" && cell["ct"] != null && cell["ct"].t == "n" && cell.v != null){
                                        count++;
                                        sum += parseInt(cell.v);

                                        if(max == null || parseInt(cell.v) > max){
                                            max = parseInt(cell.v);
                                        }

                                        if(min == null || parseInt(cell.v) < min){
                                            min = parseInt(cell.v);
                                        }
                                    }
                                }
                            }
                        }

                        if(max != null && min != null){
                            if(format.length == 3){ //三色色阶
                                var avg = Math.floor(sum / count);

                                for(var s = 0; s < cellrange.length; s++){
                                    for(var r = cellrange[s].row[0]; r <= cellrange[s].row[1]; r++){
                                        for(var c = cellrange[s].column[0]; c <= cellrange[s].column[1]; c++){
                                            if(d[r] == null || d[r][c] == null){
                                                continue;
                                            }

                                            var cell = d[r][c];

                                            if(jfgrid.getObjType(cell) == "object" && cell["ct"] != null && cell["ct"].t == "n" && cell.v != null){
                                                if(parseInt(cell.v) == min){
                                                    if((r + "_" + c) in computeMap){
                                                        computeMap[r + "_" + c]["cellColor"] = format[2];
                                                    }
                                                    else{
                                                        computeMap[r + "_" + c] = { "cellColor": format[2] };    
                                                    }
                                                }
                                                else if(parseInt(cell.v) > min && parseInt(cell.v) < avg){
                                                    if((r + "_" + c) in computeMap){
                                                        computeMap[r + "_" + c]["cellColor"] = jfgrid.conditionformat.getcolorGradation(format[2], format[1], min, avg, parseInt(cell.v));
                                                    }
                                                    else{
                                                        computeMap[r + "_" + c] = { "cellColor": jfgrid.conditionformat.getcolorGradation(format[2], format[1], min, avg, parseInt(cell.v)) };    
                                                    }
                                                }
                                                else if(parseInt(cell.v) == avg){
                                                    if((r + "_" + c) in computeMap){
                                                        computeMap[r + "_" + c]["cellColor"] = format[1];
                                                    }
                                                    else{
                                                        computeMap[r + "_" + c] = { "cellColor": format[1] };    
                                                    }
                                                }
                                                else if(parseInt(cell.v) > avg && parseInt(cell.v) < max){
                                                    if((r + "_" + c) in computeMap){
                                                        computeMap[r + "_" + c]["cellColor"] = jfgrid.conditionformat.getcolorGradation(format[1], format[0], avg, max, parseInt(cell.v));
                                                    }
                                                    else{
                                                        computeMap[r + "_" + c] = { "cellColor": jfgrid.conditionformat.getcolorGradation(format[1], format[0], avg, max, parseInt(cell.v)) };    
                                                    }
                                                }
                                                else if(parseInt(cell.v) == max){
                                                    if((r + "_" + c) in computeMap){
                                                        computeMap[r + "_" + c]["cellColor"] = format[0];
                                                    }
                                                    else{
                                                        computeMap[r + "_" + c] = { "cellColor": format[0] };    
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }   
                            else if(format.length == 2){ //两色色阶
                                for(var s = 0; s < cellrange.length; s++){
                                    for(var r = cellrange[s].row[0]; r <= cellrange[s].row[1]; r++){
                                        for(var c = cellrange[s].column[0]; c <= cellrange[s].column[1]; c++){
                                            if(d[r] == null || d[r][c] == null){
                                                continue;
                                            }

                                            var cell = d[r][c];

                                            if(jfgrid.getObjType(cell) == "object" && cell["ct"] != null && cell["ct"].t == "n" && cell.v != null){
                                                if(parseInt(cell.v) == min){
                                                    if((r + "_" + c) in computeMap){
                                                        computeMap[r + "_" + c]["cellColor"] = format[1];
                                                    }
                                                    else{
                                                        computeMap[r + "_" + c] = { "cellColor": format[1] };    
                                                    }
                                                }
                                                else if(parseInt(cell.v) > min && parseInt(cell.v) < max){
                                                    if((r + "_" + c) in computeMap){
                                                        computeMap[r + "_" + c]["cellColor"] = jfgrid.conditionformat.getcolorGradation(format[1], format[0], min, max, parseInt(cell.v));
                                                    }
                                                    else{
                                                        computeMap[r + "_" + c] = { "cellColor": jfgrid.conditionformat.getcolorGradation(format[1], format[0], min, max, parseInt(cell.v)) };    
                                                    }
                                                }
                                                else if(parseInt(cell.v) == max){
                                                    if((r + "_" + c) in computeMap){
                                                        computeMap[r + "_" + c]["cellColor"] = format[0];
                                                    }
                                                    else{
                                                        computeMap[r + "_" + c] = { "cellColor": format[0] };    
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                    else if(type == "icons"){ //图标集
                        var len = parseInt(format["len"]);
                        var leftMin = parseInt(format["leftMin"]);
                        var top = parseInt(format["top"]);

                        var max = null, min = null;

                        for(var s = 0; s < cellrange.length; s++){
                            for(var r = cellrange[s].row[0]; r <= cellrange[s].row[1]; r++){
                                for(var c = cellrange[s].column[0]; c <= cellrange[s].column[1]; c++){
                                    if(d[r] == null || d[r][c] == null){
                                        continue;
                                    }

                                    var cell = d[r][c];

                                    if(jfgrid.getObjType(cell) == "object" && cell["ct"] != null && cell["ct"].t == "n" && cell.v != null){
                                        if(max == null || parseInt(cell.v) > max){
                                            max = parseInt(cell.v);
                                        }

                                        if(min == null || parseInt(cell.v) < min){
                                            min = parseInt(cell.v);
                                        }
                                    }
                                }
                            }
                        }

                        if(max != null && min != null){
                            var a = Math.floor((max - min + 1) / len);
                            var b = (max - min + 1) % len;

                            if(len == 3){ //一组图标有三个
                                if(b == 2){
                                    var v1 = [min, min + a];
                                    var v2 = [min + a + 1, min + a * 2];
                                    var v3 = [min + a * 2 + 1, max];
                                }
                                else{
                                    var v1 = [min, min + a - 1];
                                    var v2 = [min + a, min + a * 2 - 1];
                                    var v3 = [min + a * 2, max];   
                                }

                                for(var s = 0; s < cellrange.length; s++){
                                    for(var r = cellrange[s].row[0]; r <= cellrange[s].row[1]; r++){
                                        for(var c = cellrange[s].column[0]; c <= cellrange[s].column[1]; c++){
                                            if(d[r] == null || d[r][c] == null){
                                                continue;
                                            }

                                            var cell = d[r][c];

                                            if(jfgrid.getObjType(cell) == "object" && cell["ct"] != null && cell["ct"].t == "n" && cell.v != null){
                                                if(parseInt(cell.v) >= v1[0] && parseInt(cell.v) <= v1[1]){
                                                    if((r + "_" + c) in computeMap){
                                                        computeMap[r + "_" + c]["icons"] = {"left": leftMin + 2, "top": top};
                                                    }
                                                    else{
                                                        computeMap[r + "_" + c] = { "icons": {"left": leftMin + 2, "top": top} };    
                                                    }
                                                }
                                                else if(parseInt(cell.v) >= v2[0] && parseInt(cell.v) <= v2[1]){
                                                    if((r + "_" + c) in computeMap){
                                                        computeMap[r + "_" + c]["icons"] = {"left": leftMin + 1, "top": top};
                                                    }
                                                    else{
                                                        computeMap[r + "_" + c] = { "icons": {"left": leftMin + 1, "top": top} };    
                                                    }
                                                }
                                                else if(parseInt(cell.v) >= v3[0] && parseInt(cell.v) <= v3[1]){
                                                    if((r + "_" + c) in computeMap){
                                                        computeMap[r + "_" + c]["icons"] = {"left": leftMin, "top": top};
                                                    }
                                                    else{
                                                        computeMap[r + "_" + c] = { "icons": {"left": leftMin, "top": top} };    
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                            else if(len == 4){ //一组图标有四个
                                if(b == 2){
                                    var v1 = [min, min + a];
                                    var v2 = [min + a + 1, min + a * 2];
                                    var v3 = [min + a * 2 + 1, min + a * 3];
                                    var v4 = [min + a * 3 + 1, max];
                                }
                                else if(b == 3){
                                    var v1 = [min, min + a];
                                    var v2 = [min + a + 1, min + a * 2];
                                    var v3 = [min + a * 2 + 1, min + a * 3 + 1];
                                    var v4 = [min + a * 3 + 2, max];
                                }
                                else{
                                    var v1 = [min, min + a - 1];
                                    var v2 = [min + a, min + a * 2 - 1];
                                    var v3 = [min + a * 2, min + a * 3 - 1];
                                    var v4 = [min + a * 3, max];
                                }

                                for(var s = 0; s < cellrange.length; s++){
                                    for(var r = cellrange[s].row[0]; r <= cellrange[s].row[1]; r++){
                                        for(var c = cellrange[s].column[0]; c <= cellrange[s].column[1]; c++){
                                            if(d[r] == null || d[r][c] == null){
                                                continue;
                                            }

                                            var cell = d[r][c];

                                            if(jfgrid.getObjType(cell) == "object" && cell["ct"] != null && cell["ct"].t == "n" && cell.v != null){
                                                if(parseInt(cell.v) >= v1[0] && parseInt(cell.v) <= v1[1]){
                                                    if((r + "_" + c) in computeMap){
                                                        computeMap[r + "_" + c]["icons"] = {"left": leftMin + 3, "top": top};
                                                    }
                                                    else{
                                                        computeMap[r + "_" + c] = { "icons": {"left": leftMin + 3, "top": top} };    
                                                    }
                                                }
                                                else if(parseInt(cell.v) >= v2[0] && parseInt(cell.v) <= v2[1]){
                                                    if((r + "_" + c) in computeMap){
                                                        computeMap[r + "_" + c]["icons"] = {"left": leftMin + 2, "top": top};
                                                    }
                                                    else{
                                                        computeMap[r + "_" + c] = { "icons": {"left": leftMin + 2, "top": top} };    
                                                    }
                                                }
                                                else if(parseInt(cell.v) >= v3[0] && parseInt(cell.v) <= v3[1]){
                                                    if((r + "_" + c) in computeMap){
                                                        computeMap[r + "_" + c]["icons"] = {"left": leftMin + 1, "top": top};
                                                    }
                                                    else{
                                                        computeMap[r + "_" + c] = { "icons": {"left": leftMin + 1, "top": top} };    
                                                    }
                                                }
                                                else if(parseInt(cell.v) >= v4[0] && parseInt(cell.v) <= v4[1]){
                                                    if((r + "_" + c) in computeMap){
                                                        computeMap[r + "_" + c]["icons"] = {"left": leftMin, "top": top};
                                                    }
                                                    else{
                                                        computeMap[r + "_" + c] = { "icons": {"left": leftMin, "top": top} };    
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                            else if(len == 5){ //一组图标有五个
                                if(b == 2){
                                    var v1 = [min, min + a];
                                    var v2 = [min + a + 1, min + a * 2];
                                    var v3 = [min + a * 2 + 1, min + a * 3];
                                    var v4 = [min + a * 3 + 1, min + a * 4];
                                    var v5 = [min + a * 4 + 1, max];
                                }
                                else if(b == 3){
                                    var v1 = [min, min + a];
                                    var v2 = [min + a + 1, min + a * 2];
                                    var v3 = [min + a * 2 + 1, min + a * 3 + 1];
                                    var v4 = [min + a * 3 + 2, min + a * 4 + 1];
                                    var v5 = [min + a * 4 + 2, max];
                                }
                                else if(b == 4){
                                    var v1 = [min, min + a];
                                    var v2 = [min + a + 1, min + a * 2 + 1];
                                    var v3 = [min + a * 2 + 2, min + a * 3 + 1];
                                    var v4 = [min + a * 3 + 2, min + a * 4 + 2];
                                    var v5 = [min + a * 4 + 3, max];
                                }
                                else{
                                    var v1 = [min, min + a - 1];
                                    var v2 = [min + a, min + a * 2 - 1];
                                    var v3 = [min + a * 2, min + a * 3 - 1];
                                    var v4 = [min + a * 3, min + a * 4 - 1];
                                    var v5 = [min + a * 4, max];
                                }

                                for(var s = 0; s < cellrange.length; s++){
                                    for(var r = cellrange[s].row[0]; r <= cellrange[s].row[1]; r++){
                                        for(var c = cellrange[s].column[0]; c <= cellrange[s].column[1]; c++){
                                            if(d[r] == null || d[r][c] == null){
                                                continue;
                                            }

                                            var cell = d[r][c];

                                            if(jfgrid.getObjType(cell) == "object" && cell["ct"] != null && cell["ct"].t == "n" && cell.v != null){
                                                if(parseInt(cell.v) >= v1[0] && parseInt(cell.v) <= v1[1]){
                                                    if((r + "_" + c) in computeMap){
                                                        computeMap[r + "_" + c]["icons"] = {"left": leftMin + 4, "top": top};
                                                    }
                                                    else{
                                                        computeMap[r + "_" + c] = { "icons": {"left": leftMin + 4, "top": top} };    
                                                    }
                                                }
                                                else if(parseInt(cell.v) >= v2[0] && parseInt(cell.v) <= v2[1]){
                                                    if((r + "_" + c) in computeMap){
                                                        computeMap[r + "_" + c]["icons"] = {"left": leftMin + 3, "top": top};
                                                    }
                                                    else{
                                                        computeMap[r + "_" + c] = { "icons": {"left": leftMin + 3, "top": top} };    
                                                    }
                                                }
                                                else if(parseInt(cell.v) >= v3[0] && parseInt(cell.v) <= v3[1]){
                                                    if((r + "_" + c) in computeMap){
                                                        computeMap[r + "_" + c]["icons"] = {"left": leftMin + 2, "top": top};
                                                    }
                                                    else{
                                                        computeMap[r + "_" + c] = { "icons": {"left": leftMin + 2, "top": top} };    
                                                    }
                                                }
                                                else if(parseInt(cell.v) >= v4[0] && parseInt(cell.v) <= v4[1]){
                                                    if((r + "_" + c) in computeMap){
                                                        computeMap[r + "_" + c]["icons"] = {"left": leftMin + 1, "top": top};
                                                    }
                                                    else{
                                                        computeMap[r + "_" + c] = { "icons": {"left": leftMin + 1, "top": top} };    
                                                    }
                                                }
                                                else if(parseInt(cell.v) >= v5[0] && parseInt(cell.v) <= v5[1]){
                                                    if((r + "_" + c) in computeMap){
                                                        computeMap[r + "_" + c]["icons"] = {"left": leftMin, "top": top};
                                                    }
                                                    else{
                                                        computeMap[r + "_" + c] = { "icons": {"left": leftMin, "top": top} };    
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                    else{
                        //获取变量值
                        var conditionName = ruleArr[i].conditionName,         //条件名称
                            conditionValue0 = ruleArr[i].conditionValue[0],   //条件值1
                            conditionValue1 = ruleArr[i].conditionValue[1],   //条件值2
                            textColor = format.textColor,          //条件格式文本颜色 fc
                            cellColor = format.cellColor;          //条件格式单元格颜色 bg
                        
                        for(var s = 0; s < cellrange.length; s++){
                            //条件类型判断    
                            if(conditionName == "greaterThan" || conditionName == "lessThan" || conditionName == "equal" || conditionName == "textContains"){
                                //循环应用范围计算
                                for(var r = cellrange[s].row[0]; r <= cellrange[s].row[1]; r++){
                                    for(var c = cellrange[s].column[0]; c <= cellrange[s].column[1]; c++){
                                        if(d[r] == null || d[r][c] == null){
                                            continue;
                                        }

                                        //单元格值
                                        var cell = d[r][c];

                                        if(jfgrid.getObjType(cell) != "object" || jfgrid.func_methods.isRealNull(cell.v)){
                                            continue;
                                        }

                                        //符合条件
                                        if(conditionName == "greaterThan" && cell.v > conditionValue0){
                                            if((r + "_" + c) in computeMap){
                                                computeMap[r + "_" + c]["textColor"] = textColor;
                                                computeMap[r + "_" + c]["cellColor"] = cellColor;    
                                            }
                                            else{
                                                computeMap[r + "_" + c] = { "textColor": textColor, "cellColor": cellColor };
                                            }
                                        }
                                        else if(conditionName == "lessThan" && cell.v < conditionValue0){
                                            if((r + "_" + c) in computeMap){
                                                computeMap[r + "_" + c]["textColor"] = textColor;
                                                computeMap[r + "_" + c]["cellColor"] = cellColor;    
                                            }
                                            else{
                                                computeMap[r + "_" + c] = { "textColor": textColor, "cellColor": cellColor };
                                            }
                                        }
                                        else if(conditionName == "equal" && cell.v == conditionValue0){
                                            if((r + "_" + c) in computeMap){
                                                computeMap[r + "_" + c]["textColor"] = textColor;
                                                computeMap[r + "_" + c]["cellColor"] = cellColor;    
                                            }
                                            else{
                                                computeMap[r + "_" + c] = { "textColor": textColor, "cellColor": cellColor };
                                            }
                                        }
                                        else if(conditionName == "textContains" && cell.v.toString().indexOf(conditionValue0) != -1){
                                            if((r + "_" + c) in computeMap){
                                                computeMap[r + "_" + c]["textColor"] = textColor;
                                                computeMap[r + "_" + c]["cellColor"] = cellColor;    
                                            }
                                            else{
                                                computeMap[r + "_" + c] = { "textColor": textColor, "cellColor": cellColor };
                                            }
                                        }
                                    }
                                }
                            }
                            else if(conditionName == "betweenness"){
                                //比较条件值1和条件值2的大小
                                if(conditionValue0 > conditionValue1){
                                    var vBig = conditionValue0,
                                        vSmall = conditionValue1;
                                }
                                else{
                                    var vBig = conditionValue1,
                                        vSmall = conditionValue0;
                                }
                                //循环应用范围计算
                                for(var r = cellrange[s].row[0]; r <= cellrange[s].row[1]; r++){
                                    for(var c = cellrange[s].column[0]; c <= cellrange[s].column[1]; c++){
                                        if(d[r] == null || d[r][c] == null){
                                            continue;
                                        }

                                        //单元格值
                                        var cell = d[r][c];

                                        if(jfgrid.getObjType(cell) != "object" || jfgrid.func_methods.isRealNull(cell.v)){
                                            continue;
                                        }

                                        //符合条件
                                        if(cell.v >= vSmall && cell.v <= vBig){
                                            if((r + "_" + c) in computeMap){
                                                computeMap[r + "_" + c]["textColor"] = textColor;
                                                computeMap[r + "_" + c]["cellColor"] = cellColor;    
                                            }
                                            else{
                                                computeMap[r + "_" + c] = { "textColor": textColor, "cellColor": cellColor };
                                            }
                                        }
                                    }
                                }
                            }
                            else if(conditionName == "occurrenceDate"){
                                //获取日期所对应的数值
                                if(conditionValue0.toString().indexOf("-") == -1){
                                    var dBig = jfgrid.mask.genarate(conditionValue0)[2],
                                        dSmall = jfgrid.mask.genarate(conditionValue0)[2];
                                }
                                else{
                                    var dBig = jfgrid.mask.genarate(conditionValue0.toString().split("-")[1])[2],   
                                        dSmall = jfgrid.mask.genarate(conditionValue0.toString().split("-")[0])[2];
                                }
                                //循环应用范围计算
                                for(var r = cellrange[s].row[0]; r <= cellrange[s].row[1]; r++){
                                    for(var c = cellrange[s].column[0]; c <= cellrange[s].column[1]; c++){
                                        if(d[r] == null || d[r][c] == null){
                                            continue;
                                        }

                                        //单元格值类型为日期类型
                                        if(d[r][c].ct != null && d[r][c].ct.t == "d"){
                                            //单元格值
                                            var cellVal = jfgrid.getcellvalue(r, c, d); 
                                            //符合条件
                                            if(cellVal >= dSmall && cellVal <= dBig){
                                                if((r + "_" + c) in computeMap){
                                                    computeMap[r + "_" + c]["textColor"] = textColor;
                                                    computeMap[r + "_" + c]["cellColor"] = cellColor;    
                                                }
                                                else{
                                                    computeMap[r + "_" + c] = { "textColor": textColor, "cellColor": cellColor };
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                            else if(conditionName == "duplicateValue"){
                                //应用范围单元格值处理
                                var dmap = {};
                                for(var r = cellrange[s].row[0]; r <= cellrange[s].row[1]; r++){
                                    for(var c = cellrange[s].column[0]; c <= cellrange[s].column[1]; c++){
                                        var item = jfgrid.getcellvalue(r, c, d);
                                        if(!(item in dmap)){
                                            dmap[item] = [];
                                        }
                                        dmap[item].push({"r": r, "c": c});
                                    }
                                }
                                //循环应用范围计算
                                if(conditionValue0 == "0"){//重复值
                                    for(x in dmap){
                                        if(x != "null" && x != "undefined" && dmap[x].length > 1){
                                            for(var j = 0; j < dmap[x].length; j++){
                                                if((dmap[x][j].r + "_" + dmap[x][j].c) in computeMap){
                                                    computeMap[dmap[x][j].r + "_" + dmap[x][j].c]["textColor"] = textColor;
                                                    computeMap[dmap[x][j].r + "_" + dmap[x][j].c]["cellColor"] = cellColor;    
                                                }
                                                else{
                                                    computeMap[dmap[x][j].r + "_" + dmap[x][j].c] = { "textColor": textColor, "cellColor": cellColor };
                                                }
                                            }
                                        }
                                    }    
                                }
                                if(conditionValue0 == "1"){//唯一值
                                    for(x in dmap){
                                        if(x != "null" && x != "undefined" && dmap[x].length == 1){
                                            if((dmap[x][0].r + "_" + dmap[x][0].c) in computeMap){
                                                computeMap[dmap[x][0].r + "_" + dmap[x][0].c]["textColor"] = textColor;
                                                computeMap[dmap[x][0].r + "_" + dmap[x][0].c]["cellColor"] = cellColor;    
                                            }
                                            else{
                                                computeMap[dmap[x][0].r + "_" + dmap[x][0].c] = { "textColor": textColor, "cellColor": cellColor };
                                            }
                                        }
                                    }    
                                }
                            }
                            else if(conditionName == "top10" || conditionName == "top10%" || conditionName == "last10" || conditionName == "last10%" || conditionName == "AboveAverage" || conditionName == "SubAverage"){
                                //应用范围单元格值(数值型)
                                var dArr=[]; 
                                for(var r = cellrange[s].row[0]; r <= cellrange[s].row[1]; r++){
                                    for(var c = cellrange[s].column[0]; c <= cellrange[s].column[1]; c++){
                                        if(d[r] == null || d[r][c] == null){
                                            continue;
                                        }

                                        //单元格值类型为数字类型
                                        if(d[r][c].ct != null && d[r][c].ct.t == "n"){
                                            dArr.push(jfgrid.getcellvalue(r, c, d));
                                        }
                                    }
                                }
                                //数组处理
                                if(conditionName == "top10" || conditionName == "top10%" || conditionName == "last10" || conditionName == "last10%"){
                                    //从大到小排序
                                    for(var j = 0; j < dArr.length; j++){
                                        for(var k = 0; k < dArr.length - 1 - j; k++){
                                            if(dArr[k]<dArr[k+1]){
                                                var temp=dArr[k];
                                                dArr[k]=dArr[k+1];
                                                dArr[k+1]=temp;
                                            }
                                        }
                                    }
                                    //取条件值数组
                                    if(conditionName == "top10"){
                                        var cArr = dArr.slice(0, conditionValue0); //前10项数组
                                    }
                                    else if(conditionName == "top10%"){
                                        var cArr = dArr.slice(0, Math.floor(conditionValue0*dArr.length/100)); //前10%数组
                                    }
                                    else if(conditionName == "last10"){
                                        var cArr = dArr.slice((dArr.length-conditionValue0), dArr.length); //最后10项数组
                                    }
                                    else if(conditionName == "last10%"){
                                        var cArr = dArr.slice((dArr.length-Math.floor(conditionValue0*dArr.length/100)), dArr.length); //最后10%数组
                                    }
                                    //循环应用范围计算
                                    for(var r = cellrange[s].row[0]; r <= cellrange[s].row[1]; r++){
                                        for(var c = cellrange[s].column[0]; c <= cellrange[s].column[1]; c++){
                                            if(d[r] == null || d[r][c] == null){
                                                continue;
                                            }

                                            //单元格值
                                            var cellVal = jfgrid.getcellvalue(r, c, d);
                                            //符合条件
                                            if(cArr.indexOf(cellVal) != -1){
                                                if((r + "_" + c) in computeMap){
                                                    computeMap[r + "_" + c]["textColor"] = textColor;
                                                    computeMap[r + "_" + c]["cellColor"] = cellColor;
                                                }
                                                else{
                                                    computeMap[r + "_" + c] = { "textColor": textColor, "cellColor": cellColor };
                                                }
                                            }
                                        }
                                    }
                                }
                                else if(conditionName == "AboveAverage" || conditionName == "SubAverage"){
                                    //计算数组平均值
                                    var sum = 0;
                                    for(var j = 0; j < dArr.length; j++){  
                                        sum += dArr[j];
                                    }
                                    var averageNum = sum / dArr.length;
                                    //循环应用范围计算
                                    if(conditionName == "AboveAverage"){ //高于平均值
                                        for(var r = cellrange[s].row[0]; r <= cellrange[s].row[1]; r++){
                                            for(var c = cellrange[s].column[0]; c <= cellrange[s].column[1]; c++){
                                                if(d[r] == null || d[r][c] == null){
                                                    continue;
                                                }

                                                //单元格值
                                                var cellVal = jfgrid.getcellvalue(r, c, d);
                                                //符合条件
                                                if(cellVal > averageNum){
                                                    if((r + "_" + c) in computeMap){
                                                        computeMap[r + "_" + c]["textColor"] = textColor;
                                                        computeMap[r + "_" + c]["cellColor"] = cellColor;
                                                    }
                                                    else{
                                                        computeMap[r + "_" + c] = { "textColor": textColor, "cellColor": cellColor };
                                                    }
                                                }
                                            }
                                        }
                                    }
                                    else if(conditionName == "SubAverage"){ //低于平均值
                                        for(var r = cellrange[s].row[0]; r <= cellrange[s].row[1]; r++){
                                            for(var c = cellrange[s].column[0]; c <= cellrange[s].column[1]; c++){
                                                if(d[r] == null || d[r][c] == null){
                                                    continue;
                                                }

                                                //单元格值
                                                var cellVal = jfgrid.getcellvalue(r, c, d);
                                                //符合条件
                                                if(cellVal < averageNum){
                                                    if((r + "_" + c) in computeMap){
                                                        computeMap[r + "_" + c]["textColor"] = textColor;
                                                        computeMap[r + "_" + c]["cellColor"] = cellColor;
                                                    }
                                                    else{
                                                        computeMap[r + "_" + c] = { "textColor": textColor, "cellColor": cellColor };
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
            
            return computeMap;
        },
        updateItem: function(type, cellrange, format){
            var index = jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex);
            var files = jfgrid.getjfgridfile();

            //保存之前的规则
            var fileH = $.extend(true, [], files);
            var historyRules = jfgrid.conditionformat.getHistoryRules(fileH);
            
            //保存当前的规则
            if(type == "delSheet"){
                var ruleArr = [];
            }
            else{
                var rule = {
                    "type": type, 
                    "cellrange": cellrange, 
                    "format": format
                };
                var ruleArr = files[index]["jfgrid_conditionformat_save"] == null ? [] : files[index]["jfgrid_conditionformat_save"];
                ruleArr.push(rule);
            }

            files[index]["jfgrid_conditionformat_save"] = ruleArr;

            var fileC = $.extend(true, [], files);
            var currentRules = jfgrid.conditionformat.getCurrentRules(fileC);

            //刷新一次表格
            jfgrid.conditionformat.ref(historyRules, currentRules);

            //发送给后台
            if(jfgrid.server.allowUpdate){
                jfgrid.server.saveParam("all", jfgrid.currentSheetIndex, ruleArr, { "k": "jfgrid_conditionformat_save" });
            }
        },
        getHistoryRules: function(fileH){
            var historyRules = [];

            for(var h = 0; h < fileH.length; h++){
                historyRules.push({"sheetIndex": fileH[h]["index"], "jfgrid_conditionformat_save": fileH[h]["jfgrid_conditionformat_save"]});
            }

            return historyRules;
        },
        getCurrentRules: function(fileC){
            var currentRules = [];

            for(var c = 0; c < fileC.length; c++){
                currentRules.push({"sheetIndex": fileC[c]["index"], "jfgrid_conditionformat_save": fileC[c]["jfgrid_conditionformat_save"]});
            }

            return currentRules;
        },
        ref: function(historyRules, currentRules){
            if (clearjfundo) {
                jfgrid.jfundo = [];

                var redo = {};
                redo["type"] = "updateCF";
                redo["data"] = {"historyRules": historyRules, "currentRules": currentRules};
                jfgrid.jfredo.push(redo); 
            }

            setTimeout(function () {
                jfgrid.jfgridrefreshgrid();
            }, 1);

            //编辑器qksheet表格编辑时
            if(jfgridConfigsetting.pointEdit){
                jfgrid.pointEdit_updateData();
            }
        }
    }

    //交替颜色
    jfgrid.alternateformat = {
        rangefocus: false,
        modelfocusIndex: null,
        FixedModelColor: [
            {
                "head": { "fc": "#000", "bc": "#bfbdbe" },
                "one":  { "fc": "#000", "bc": "#ffffff" },
                "two":  { "fc": "#000", "bc": "#f8f3f7" },
                "foot": { "fc": "#000", "bc": "#dde2de" }
            },
            {
                "head": { "fc": "#000", "bc": "#4bd4e7" },
                "one":  { "fc": "#000", "bc": "#ffffff" },
                "two":  { "fc": "#000", "bc": "#eaf7ff" },
                "foot": { "fc": "#000", "bc": "#aae9f8" }
            },
            {
                "head": { "fc": "#000", "bc": "#5ed593" },
                "one":  { "fc": "#000", "bc": "#ffffff" },
                "two":  { "fc": "#000", "bc": "#e5fbee" },
                "foot": { "fc": "#000", "bc": "#a5efcc" }
            },
            {
                "head": { "fc": "#000", "bc": "#f6cb4b" },
                "one":  { "fc": "#000", "bc": "#ffffff" },
                "two":  { "fc": "#000", "bc": "#fff9e7" },
                "foot": { "fc": "#000", "bc": "#ffebac" }
            },
            {
                "head": { "fc": "#000", "bc": "#f96420" },
                "one":  { "fc": "#000", "bc": "#ffffff" },
                "two":  { "fc": "#000", "bc": "#ffe5d9" },
                "foot": { "fc": "#000", "bc": "#ffcfba" }
            },
            {
                "head": { "fc": "#000", "bc": "#5599fc" },
                "one":  { "fc": "#000", "bc": "#ffffff" },
                "two":  { "fc": "#000", "bc": "#ecf2fe" },
                "foot": { "fc": "#000", "bc": "#afcbfa" }
            },
            {
                "head": { "fc": "#000", "bc": "#22a69b" },
                "one":  { "fc": "#000", "bc": "#ffffff" },
                "two":  { "fc": "#000", "bc": "#dff2f8" },
                "foot": { "fc": "#000", "bc": "#8dd4d0" }
            },
            {
                "head": { "fc": "#000", "bc": "#7a939a" },
                "one":  { "fc": "#000", "bc": "#ffffff" },
                "two":  { "fc": "#000", "bc": "#f0eff7" },
                "foot": { "fc": "#000", "bc": "#bdcad0" }
            },
            {
                "head": { "fc": "#000", "bc": "#d7a270" },
                "one":  { "fc": "#000", "bc": "#ffffff" },
                "two":  { "fc": "#000", "bc": "#fdf3f1" },
                "foot": { "fc": "#000", "bc": "#ead2b6" }
            },
            {
                "head": { "fc": "#000", "bc": "#89c54b" },
                "one":  { "fc": "#000", "bc": "#ffffff" },
                "two":  { "fc": "#000", "bc": "#f1f7e9" },
                "foot": { "fc": "#000", "bc": "#c5e3a7" }
            },
            {
                "head": { "fc": "#000", "bc": "#8f88f0" },
                "one":  { "fc": "#000", "bc": "#ffffff" },
                "two":  { "fc": "#000", "bc": "#f0e5ff" },
                "foot": { "fc": "#000", "bc": "#c6c4f6" }
            },
            {
                "head": { "fc": "#000", "bc": "#fd1664" },
                "one":  { "fc": "#000", "bc": "#ffffff" },
                "two":  { "fc": "#000", "bc": "#feddee" },
                "foot": { "fc": "#000", "bc": "#f98ab5" }
            },
            {
                "head": { "fc": "#000", "bc": "#da96d3" },
                "one":  { "fc": "#000", "bc": "#ffffff" },
                "two":  { "fc": "#000", "bc": "#fce8fb" },
                "foot": { "fc": "#000", "bc": "#f2caee" }
            },
            {
                "head": { "fc": "#000", "bc": "#b49191" },
                "one":  { "fc": "#000", "bc": "#ffffff" },
                "two":  { "fc": "#000", "bc": "#f5ebe8" },
                "foot": { "fc": "#000", "bc": "#d8c3c3" }
            },
            {
                "head": { "fc": "#000", "bc": "#91b493" },
                "one":  { "fc": "#000", "bc": "#ffffff" },
                "two":  { "fc": "#000", "bc": "#f0fbf0" },
                "foot": { "fc": "#000", "bc": "#b4cfb6" }
            },
            {
                "head": { "fc": "#000", "bc": "#b4a891" },
                "one":  { "fc": "#000", "bc": "#ffffff" },
                "two":  { "fc": "#000", "bc": "#f8f6f1" },
                "foot": { "fc": "#000", "bc": "#d3cab8" }
            },
            {
                "head": { "fc": "#000", "bc": "#91abb4" },
                "one":  { "fc": "#000", "bc": "#ffffff" },
                "two":  { "fc": "#000", "bc": "#eff7fa" },
                "foot": { "fc": "#000", "bc": "#b7cbd3" }
            },
            {
                "head": { "fc": "#000", "bc": "#b7ba82" },
                "one":  { "fc": "#000", "bc": "#ffffff" },
                "two":  { "fc": "#000", "bc": "#fafbeb" },
                "foot": { "fc": "#000", "bc": "#dadcb4" }
            },
            {
                "head": { "fc": "#000", "bc": "#df3e3e" },
                "one":  { "fc": "#000", "bc": "#ffffff" },
                "two":  { "fc": "#000", "bc": "#fde9e9" },
                "foot": { "fc": "#000", "bc": "#f89292" }
            },
            {
                "head": { "fc": "#000", "bc": "#f2711c" },
                "one":  { "fc": "#000", "bc": "#ffffff" },
                "two":  { "fc": "#000", "bc": "#fef0d7" },
                "foot": { "fc": "#000", "bc": "#fbb335" }
            },
            {
                "head": { "fc": "#000", "bc": "#b5cc18" },
                "one":  { "fc": "#000", "bc": "#ffffff" },
                "two":  { "fc": "#000", "bc": "#f9fbd4" },
                "foot": { "fc": "#000", "bc": "#e2ed2a" }
            },
            {
                "head": { "fc": "#000", "bc": "#00b5ad" },
                "one":  { "fc": "#000", "bc": "#ffffff" },
                "two":  { "fc": "#000", "bc": "#ccfaf9" },
                "foot": { "fc": "#000", "bc": "#00e4df" }
            },
            {
                "head": { "fc": "#000", "bc": "#2185d0" },
                "one":  { "fc": "#000", "bc": "#ffffff" },
                "two":  { "fc": "#000", "bc": "#d8f3fc" },
                "foot": { "fc": "#000", "bc": "#3cc4f0" }
            },
            {
                "head": { "fc": "#000", "bc": "#a5673f" },
                "one":  { "fc": "#000", "bc": "#ffffff" },
                "two":  { "fc": "#000", "bc": "#f6ede5" },
                "foot": { "fc": "#000", "bc": "#d3a47c" }
            }            
        ],
        getModelBox: function(hasRowHeader, hasRowFooter){
            $("#jfgrid-modal-dialog-slider-alternateformat #jfgrid-alternateformat-modelList").empty();
            $("#jfgrid-modal-dialog-slider-alternateformat #jfgrid-alternateformat-modelCustom").empty();

            //格式样式 模板
            var modelListHtml = '';

            for(var i = 0; i < jfgrid.alternateformat.FixedModelColor.length; i++){
                var obj = jfgrid.alternateformat.FixedModelColor[i];

                var color1, color2, color3, color4;

                if(hasRowHeader && hasRowFooter){
                    color1 = obj["head"];
                    color2 = obj["one"];
                    color3 = obj["two"];
                    color4 = obj["foot"];
                }
                else if(hasRowHeader){
                    color1 = obj["head"];
                    color2 = obj["one"];
                    color3 = obj["two"];
                    color4 = obj["one"];
                }
                else if(hasRowFooter){
                    color1 = obj["one"];
                    color2 = obj["two"];
                    color3 = obj["one"];
                    color4 = obj["foot"];
                }
                else{
                    color1 = obj["one"];
                    color2 = obj["two"];
                    color3 = obj["one"];
                    color4 = obj["two"];
                }

                modelListHtml += '<div class="modelbox">'+
                                    '<div class="box">'+
                                        '<span style="color:'+ color1["fc"] +';background-color:'+ color1["bc"] +'"> — </span>'+
                                        '<span style="color:'+ color2["fc"] +';background-color:'+ color2["bc"] +'"> — </span>'+
                                        '<span style="color:'+ color3["fc"] +';background-color:'+ color3["bc"] +'"> — </span>'+
                                        '<span style="color:'+ color4["fc"] +';background-color:'+ color4["bc"] +'"> — </span>'+
                                    '</div>'+
                                 '</div>';
            }

            $("#jfgrid-modal-dialog-slider-alternateformat #jfgrid-alternateformat-modelList").append(modelListHtml);

            //自定义 模板
            var modelCustom = jfgridfile[jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex)]["jfgrid_alternateformat_save_modelCustom"];
            if(modelCustom != null && modelCustom.length > 0){
                var modelCustomHtml = '';

                for(var i = 0; i < modelCustom.length; i++){
                    var obj = modelCustom[i];

                    var color1, color2, color3, color4;

                    if(hasRowHeader && hasRowFooter){
                        color1 = obj["head"];
                        color2 = obj["one"];
                        color3 = obj["two"];
                        color4 = obj["foot"];
                    }
                    else if(hasRowHeader){
                        color1 = obj["head"];
                        color2 = obj["one"];
                        color3 = obj["two"];
                        color4 = obj["one"];
                    }
                    else if(hasRowFooter){
                        color1 = obj["one"];
                        color2 = obj["two"];
                        color3 = obj["one"];
                        color4 = obj["foot"];
                    }
                    else{
                        color1 = obj["one"];
                        color2 = obj["two"];
                        color3 = obj["one"];
                        color4 = obj["two"];
                    }

                    modelCustomHtml +=  '<div class="modelbox">'+
                                            '<div class="box">'+
                                                '<span style="color:'+ color1["fc"] +';background-color:'+ color1["bc"] +'"> — </span>'+
                                                '<span style="color:'+ color2["fc"] +';background-color:'+ color2["bc"] +'"> — </span>'+
                                                '<span style="color:'+ color3["fc"] +';background-color:'+ color3["bc"] +'"> — </span>'+
                                                '<span style="color:'+ color4["fc"] +';background-color:'+ color4["bc"] +'"> — </span>'+
                                            '</div>'+
                                        '</div>';
                }

                $("#jfgrid-modal-dialog-slider-alternateformat #jfgrid-alternateformat-modelCustom").append(modelCustomHtml);
            }
        },
        init: function(){
            $("#jfgrid-modal-dialog-slider-alternateformat").remove();
            $("body").append(jfgridAlternateformatHtml);
            jfgrid.jfgridsizeauto();

            //关闭
            $("#jfgrid-modal-dialog-slider-alternateformat .jfgrid-model-close-btn").click(function () {
                $("#jfgrid-modal-dialog-slider-alternateformat").hide();
                jfgrid.jfgridsizeauto();
            });

            //应用范围
            $(document).off("focus.AFrangeInput").on("focus.AFrangeInput", "#jfgrid-alternateformat-range input", function(){
                jfgrid.alternateformat.rangefocus = true;
            });
            $(document).off("blur.AFrangeInput").on("blur.AFrangeInput", "#jfgrid-alternateformat-range input", function(){
                jfgrid.alternateformat.rangefocus = false;
            });

            $(document).off("keydown.AFrangeInput").on("keydown.AFrangeInput", "#jfgrid-alternateformat-range input", function(e){
                var rangeValue = $(this).val().trim();
                if(e.keyCode == 13){
                    jfgrid.alternateformat.update();
                }
            });
            $(document).off("click.AFrangeIcon").on("click.AFrangeIcon", "#jfgrid-alternateformat-range .fa-table", function(){
                $("#jfgrid-modal-dialog-slider-alternateformat").hide();
                jfgrid.jfgridsizeauto();

                var rangeValue = $(this).parents("#jfgrid-alternateformat-range").find("input").val().trim();
                jfgrid.alternateformat.rangeDialog(rangeValue);
            });
            $(document).off("click.AFrDCf").on("click.AFrDCf", "#jfgrid-alternateformat-rangeDialog-confirm", function(){
                var rangeValue = $(this).parents("#jfgrid-alternateformat-rangeDialog").find("input").val().trim();
                $("#jfgrid-modal-dialog-slider-alternateformat #jfgrid-alternateformat-range input").val(rangeValue);

                $(this).parents("#jfgrid-alternateformat-rangeDialog").hide();
                $("#jfgrid-modal-dialog-slider-alternateformat").show();
                jfgrid.jfgridsizeauto();

                jfgrid.alternateformat.update();
            });
            $(document).off("click.AFrDCl").on("click.AFrDCl", "#jfgrid-alternateformat-rangeDialog-close", function(){
                $(this).parents("#jfgrid-alternateformat-rangeDialog").hide();
                $("#jfgrid-modal-dialog-slider-alternateformat").show();
                jfgrid.jfgridsizeauto();
            });
            $(document).off("click.AFrDTitle").on("click.AFrDTitle", "#jfgrid-alternateformat-rangeDialog .jfgrid-modal-dialog-title-close", function(){
                $(this).parents("#jfgrid-alternateformat-rangeDialog").hide();
                $("#jfgrid-modal-dialog-slider-alternateformat").show();
                jfgrid.jfgridsizeauto();
            });

            //页眉、页脚选中
            $(document).off("change.AFrowHeader").on("change.AFrowHeader", "#jfgrid-alternateformat-rowHeader", function(){
                if($(this).is(":checked")){
                    var hasRowHeader = true;
                }
                else{
                    var hasRowHeader = false;   
                }

                if($("#jfgrid-alternateformat-rowFooter").is(":checked")){
                    var hasRowFooter = true;
                }
                else{
                    var hasRowFooter = false;   
                }

                jfgrid.alternateformat.checkboxChange(hasRowHeader, hasRowFooter);
                jfgrid.alternateformat.modelboxOn();
                jfgrid.alternateformat.update();
            });
            $(document).off("change.AFrowFooter").on("change.AFrowFooter", "#jfgrid-alternateformat-rowFooter", function(){
                if($("#jfgrid-alternateformat-rowHeader").is(":checked")){
                    var hasRowHeader = true;
                }
                else{
                    var hasRowHeader = false;   
                }

                if($(this).is(":checked")){
                    var hasRowFooter = true;
                }
                else{
                    var hasRowFooter = false;   
                }

                jfgrid.alternateformat.checkboxChange(hasRowHeader, hasRowFooter);
                jfgrid.alternateformat.modelboxOn();
                jfgrid.alternateformat.update();
            });

            //点击样式模板
            $(document).off("click.AFmodelbox").on("click.AFmodelbox", "#jfgrid-modal-dialog-slider-alternateformat .modelbox", function(){
                var index = $(this).index();
                var $id = $(this).parents(".cf").attr("id");

                if($id == "jfgrid-alternateformat-modelList"){
                    jfgrid.alternateformat.modelfocusIndex = index;
                }
                else if($id == "jfgrid-alternateformat-modelCustom"){
                    var len = jfgrid.alternateformat.FixedModelColor.length;
                    jfgrid.alternateformat.modelfocusIndex = index + len;
                }

                jfgrid.alternateformat.modelboxOn();
                jfgrid.alternateformat.update();
            });

            //点击选择文本/单元格颜色
            $(document).off("click.AFselectColor").on("click.AFselectColor", "#jfgrid-modal-dialog-slider-alternateformat .jfgrid-color-menu-button-indicator", function(){
                var $parent = $(this).closest(".toningbox");

                if($(this).find(".jfgrid-icon-img").hasClass("jfgrid-icon-text-color")){
                    var colorType = "fc";
                    var currenColor = $parent.find(".toningShow").data("fc");
                }
                else if($(this).find(".jfgrid-icon-img").hasClass("jfgrid-icon-cell-color")){
                    var colorType = "bc";
                    var currenColor = $parent.find(".toningShow").data("bc");
                }

                //source
                if($parent.hasClass("header")){
                    var source = "0";
                }
                else if($parent.hasClass("ctOne")){
                    var source = "1";
                }
                else if($parent.hasClass("ctTwo")){
                    var source = "2";
                }
                else if($parent.hasClass("footer")){
                    var source = "3";
                }

                jfgrid.alternateformat.colorSelectDialog(currenColor, colorType, source);
            });

            //选择颜色 确定 添加自定义模板
            $(document).off("click.AFselectColorConfirm").on("click.AFselectColorConfirm", "#jfgrid-alternateformat-colorSelect-dialog-confirm", function(){
                var $parent = $(this).parents("#jfgrid-alternateformat-colorSelect-dialog");

                $("#jfgrid-modal-dialog-mask").hide();
                $parent.hide();

                //获取currenColor colorType source
                var currenColor = $parent.find(".currenColor span").attr("title");

                if($parent.find(".jfgrid-modal-dialog-title-text").text() == "选择文本颜色"){
                    var colorType = "fc";
                }
                else if($parent.find(".jfgrid-modal-dialog-title-text").text() == "选择单元格颜色"){
                    var colorType = "bc";
                }

                var source = $parent.find(".currenColor").attr("data-source");
                
                //赋给颜色
                if(source == "0"){
                    if(colorType == "fc"){
                        $("#jfgrid-alternateformat-modelToning .header .toningShow").css("color", currenColor);
                        $("#jfgrid-alternateformat-modelToning .header .toningShow").data("fc", currenColor);
                        $("#jfgrid-alternateformat-modelToning .header .jfgrid-icon-text-color").parents(".jfgrid-color-menu-button-indicator").css("border-bottom-color", currenColor);
                    }
                    if(colorType == "bc"){
                        $("#jfgrid-alternateformat-modelToning .header .toningShow").css("background-color", currenColor);
                        $("#jfgrid-alternateformat-modelToning .header .toningShow").data("bc", currenColor);
                        $("#jfgrid-alternateformat-modelToning .header .jfgrid-icon-cell-color").parents(".jfgrid-color-menu-button-indicator").css("border-bottom-color", currenColor);
                    }
                }
                else if(source == "1"){
                    if(colorType == "fc"){
                        $("#jfgrid-alternateformat-modelToning .ctOne .toningShow").css("color", currenColor);
                        $("#jfgrid-alternateformat-modelToning .ctOne .toningShow").data("fc", currenColor);
                        $("#jfgrid-alternateformat-modelToning .ctOne .jfgrid-icon-text-color").parents(".jfgrid-color-menu-button-indicator").css("border-bottom-color", currenColor);
                    }
                    if(colorType == "bc"){
                        $("#jfgrid-alternateformat-modelToning .ctOne .toningShow").css("background-color", currenColor);
                        $("#jfgrid-alternateformat-modelToning .ctOne .toningShow").data("bc", currenColor);
                        $("#jfgrid-alternateformat-modelToning .ctOne .jfgrid-icon-cell-color").parents(".jfgrid-color-menu-button-indicator").css("border-bottom-color", currenColor);
                    }
                }
                else if(source == "2"){
                    if(colorType == "fc"){
                        $("#jfgrid-alternateformat-modelToning .ctTwo .toningShow").css("color", currenColor);
                        $("#jfgrid-alternateformat-modelToning .ctTwo .toningShow").data("fc", currenColor);
                        $("#jfgrid-alternateformat-modelToning .ctTwo .jfgrid-icon-text-color").parents(".jfgrid-color-menu-button-indicator").css("border-bottom-color", currenColor);
                    }
                    if(colorType == "bc"){
                        $("#jfgrid-alternateformat-modelToning .ctTwo .toningShow").css("background-color", currenColor);
                        $("#jfgrid-alternateformat-modelToning .ctTwo .toningShow").data("bc", currenColor);
                        $("#jfgrid-alternateformat-modelToning .ctTwo .jfgrid-icon-cell-color").parents(".jfgrid-color-menu-button-indicator").css("border-bottom-color", currenColor);
                    }
                }
                else if(source == "3"){
                    if(colorType == "fc"){
                        $("#jfgrid-alternateformat-modelToning .footer .toningShow").css("color", currenColor);
                        $("#jfgrid-alternateformat-modelToning .footer .toningShow").data("fc", currenColor);
                        $("#jfgrid-alternateformat-modelToning .footer .jfgrid-icon-text-color").parents(".jfgrid-color-menu-button-indicator").css("border-bottom-color", currenColor);
                    }
                    if(colorType == "bc"){
                        $("#jfgrid-alternateformat-modelToning .footer .toningShow").css("background-color", currenColor);
                        $("#jfgrid-alternateformat-modelToning .footer .toningShow").data("bc", currenColor);
                        $("#jfgrid-alternateformat-modelToning .footer .jfgrid-icon-cell-color").parents(".jfgrid-color-menu-button-indicator").css("border-bottom-color", currenColor);
                    }
                }
                
                //若模板聚焦在固有模板，则新加模板；若模板聚焦在自定义模板，则修改该模板
                if($("#jfgrid-alternateformat-rowHeader").is(":checked")){
                    var hasRowHeader = true;
                }
                else{
                    var hasRowHeader = false;   
                }

                if($("#jfgrid-alternateformat-rowFooter").is(":checked")){
                    var hasRowFooter = true;
                }
                else{
                    var hasRowFooter = false;   
                }

                var index = jfgrid.alternateformat.modelfocusIndex;
                var len = jfgrid.alternateformat.FixedModelColor.length;

                if(index < len){
                    var format = $.extend(true, {}, jfgrid.alternateformat.getFormatByIndex());
                }
                else{
                    var file = jfgridfile[jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex)];
                    var modelCustom = file["jfgrid_alternateformat_save_modelCustom"];

                    var format = $.extend(true, {}, modelCustom[index - len]);
                }

                if(source == "0"){
                    if(colorType == "fc"){
                        format["head"]["fc"] = currenColor;
                    }
                    else if(colorType == "bc"){
                        format["head"]["bc"] = currenColor;
                    }
                }
                else if(source == "1"){
                    if(colorType == "fc"){
                        format["one"]["fc"] = currenColor;
                    }
                    else if(colorType == "bc"){
                        format["one"]["bc"] = currenColor;
                    }
                }
                else if(source == "2"){
                    if(colorType == "fc"){
                        format["two"]["fc"] = currenColor;
                    }
                    else if(colorType == "bc"){
                        format["two"]["bc"] = currenColor;
                    }
                }
                else if(source == "3"){
                    if(colorType == "fc"){
                        format["foot"]["fc"] = currenColor;
                    }
                    if(colorType == "bc"){
                        format["foot"]["bc"] = currenColor;
                    }
                }

                if(jfgrid.alternateformat.modelfocusIndex < len){
                    jfgrid.alternateformat.addCustomModel(format);
                    jfgrid.alternateformat.modelfocusIndex = jfgrid.alternateformat.getIndexByFormat(format);
                }
                else{
                    file["jfgrid_alternateformat_save_modelCustom"][index - len] = format;

                    if(jfgrid.server.allowUpdate){
                        jfgrid.server.saveParam("all", jfgrid.currentSheetIndex, file["jfgrid_alternateformat_save_modelCustom"], { "k": "jfgrid_alternateformat_save_modelCustom" });
                    }
                }

                jfgrid.alternateformat.getModelBox(hasRowHeader, hasRowFooter);
                jfgrid.alternateformat.modelboxOn();
                jfgrid.alternateformat.update();
            });
            
            //点击 移除交替颜色 按钮
            $(document).off("click.AFremove").on("click.AFremove", "#jfgrid-alternateformat-remove", function(){
                var dataIndex = $(this).data("index");

                var file = jfgridfile[jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex)];

                var ruleArr = file["jfgrid_alternateformat_save"];

                //保存之前的规则
                var historyRules = $.extend(true, [], ruleArr);

                //保存当前的规则
                if(ruleArr.length > 1){
                    ruleArr.splice(dataIndex, 1);
                }
                else{
                    ruleArr = [];
                }

                var currentRules = $.extend(true, [], ruleArr);
                
                //刷新一次表格
                jfgrid.alternateformat.ref(historyRules, currentRules);

                if(jfgrid.server.allowUpdate){
                    jfgrid.server.saveParam("all", jfgrid.currentSheetIndex, ruleArr, { "k": "jfgrid_alternateformat_save" });
                }

                //隐藏一些dom
                $("#jfgrid-modal-dialog-mask").hide();
                $("#jfgrid-modal-dialog-slider-alternateformat").hide();

                jfgrid.jfgridsizeauto();
            });
        },
        perfect: function(){
            var range = $.extend(true, {}, jfgird_select_save[0]);
            var existsIndex = jfgrid.alternateformat.rangeIsExists(range)[1];
            
            var obj = $.extend(true, {}, jfgridfile[jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex)]["jfgrid_alternateformat_save"][existsIndex]);
            
            //应用范围
            var cellrange = obj["cellrange"];
            $("#jfgrid-alternateformat-range input").val(jfgrid.sheetmanage.getRangetxt(jfgrid.currentSheetIndex, { "row": cellrange["row"], "column": cellrange["column"] }, jfgrid.currentSheetIndex));
            
            jfgird_select_save = [{ "row": cellrange["row"], "column": cellrange["column"] }];
            jfgrid.selectHightlightShow();

            //页眉、页脚
            var hasRowHeader = obj["hasRowHeader"];
            var hasRowFooter = obj["hasRowFooter"];
            
            //模板聚焦
            var format = obj["format"];
            jfgrid.alternateformat.modelfocusIndex = jfgrid.alternateformat.getIndexByFormat(format);

            if(jfgrid.alternateformat.modelfocusIndex == null){
                jfgrid.alternateformat.addCustomModel(format);
                jfgrid.alternateformat.modelfocusIndex = jfgrid.alternateformat.getIndexByFormat(format);
            }

            jfgrid.alternateformat.checkboxChange(hasRowHeader, hasRowFooter);
            jfgrid.alternateformat.modelboxOn();

            //标识 交替颜色的index
            $("#jfgrid-alternateformat-remove").data("index", existsIndex);
        },
        checkboxChange: function(hasRowHeader, hasRowFooter){
            if(hasRowHeader){
                $("#jfgrid-alternateformat-rowHeader").prop("checked", true);
                $("#jfgrid-alternateformat-modelToning .header").show();
            }
            else{
                $("#jfgrid-alternateformat-rowHeader").removeAttr("checked");  
                $("#jfgrid-alternateformat-modelToning .header").hide(); 
            }

            if(hasRowFooter){
                $("#jfgrid-alternateformat-rowFooter").prop("checked", true);
                $("#jfgrid-alternateformat-modelToning .footer").show();
            }
            else{
                $("#jfgrid-alternateformat-rowFooter").removeAttr("checked"); 
                $("#jfgrid-alternateformat-modelToning .footer").hide();  
            }

            jfgrid.alternateformat.getModelBox(hasRowHeader, hasRowFooter);
        },
        modelboxOn: function(){
            //模板 foucs
            $("#jfgrid-modal-dialog-slider-alternateformat .modelbox").removeClass("on");

            var index = jfgrid.alternateformat.modelfocusIndex;
            var len = jfgrid.alternateformat.FixedModelColor.length;
            
            if(index < len){
                $("#jfgrid-alternateformat-modelList .modelbox").eq(index).addClass("on");
            }
            else{
                $("#jfgrid-alternateformat-modelCustom .modelbox").eq(index - len).addClass("on");
            }

            //编辑 对应颜色改变
            jfgrid.alternateformat.modelToningColor();
        },
        modelToningColor: function(){
            var format = jfgrid.alternateformat.getFormatByIndex();

            //页眉
            $("#jfgrid-alternateformat-modelToning .header .toningShow").css({"color": format["head"].fc, "background-color": format["head"].bc});
            $("#jfgrid-alternateformat-modelToning .header .toningShow").data("fc", format["head"].fc).data("bc", format["head"].bc);
            $("#jfgrid-alternateformat-modelToning .header .jfgrid-icon-text-color").parents(".jfgrid-color-menu-button-indicator").css("border-bottom-color", format["head"].fc);
            $("#jfgrid-alternateformat-modelToning .header .jfgrid-icon-cell-color").parents(".jfgrid-color-menu-button-indicator").css("border-bottom-color", format["head"].bc);

            //颜色1
            $("#jfgrid-alternateformat-modelToning .ctOne .toningShow").css({"color": format["one"].fc, "background-color": format["one"].bc});
            $("#jfgrid-alternateformat-modelToning .ctOne .toningShow").data("fc", format["one"].fc).data("bc", format["one"].bc);
            $("#jfgrid-alternateformat-modelToning .ctOne .jfgrid-icon-text-color").parents(".jfgrid-color-menu-button-indicator").css("border-bottom-color", format["one"].fc);
            $("#jfgrid-alternateformat-modelToning .ctOne .jfgrid-icon-cell-color").parents(".jfgrid-color-menu-button-indicator").css("border-bottom-color", format["one"].bc);

            //颜色2
            $("#jfgrid-alternateformat-modelToning .ctTwo .toningShow").css({"color": format["two"].fc, "background-color": format["two"].bc});
            $("#jfgrid-alternateformat-modelToning .ctTwo .toningShow").data("fc", format["two"].fc).data("bc", format["two"].bc);
            $("#jfgrid-alternateformat-modelToning .ctTwo .jfgrid-icon-text-color").parents(".jfgrid-color-menu-button-indicator").css("border-bottom-color", format["two"].fc);
            $("#jfgrid-alternateformat-modelToning .ctTwo .jfgrid-icon-cell-color").parents(".jfgrid-color-menu-button-indicator").css("border-bottom-color", format["two"].bc);

            //页脚
            $("#jfgrid-alternateformat-modelToning .footer .toningShow").css({"color": format["foot"].fc, "background-color": format["foot"].bc});
            $("#jfgrid-alternateformat-modelToning .footer .toningShow").data("fc", format["foot"].fc).data("bc", format["foot"].bc);
            $("#jfgrid-alternateformat-modelToning .footer .jfgrid-icon-text-color").parents(".jfgrid-color-menu-button-indicator").css("border-bottom-color", format["foot"].fc);
            $("#jfgrid-alternateformat-modelToning .footer .jfgrid-icon-cell-color").parents(".jfgrid-color-menu-button-indicator").css("border-bottom-color", format["foot"].bc);
        },
        addCustomModel: function(format){
            var file = jfgridfile[jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex)];

            if(file["jfgrid_alternateformat_save_modelCustom"] == null){
                file["jfgrid_alternateformat_save_modelCustom"] = [];
            }

            file["jfgrid_alternateformat_save_modelCustom"].push(format);

            if(jfgrid.server.allowUpdate){
                jfgrid.server.saveParam("all", jfgrid.currentSheetIndex, file["jfgrid_alternateformat_save_modelCustom"], { "k": "jfgrid_alternateformat_save_modelCustom" });
            }
        },
        colorSelectDialog: function(currenColor, colorType, source){
            $("#jfgrid-modal-dialog-mask").show();
            $("#jfgrid-alternateformat-colorSelect-dialog").remove();

            if(colorType == "fc"){
                var title = "选择文本颜色";
            }
            else if(colorType == "bc"){
                var title = "选择单元格颜色";
            }

            $("body").append(jfgrid.replaceHtml(modelHTML, { "id": "jfgrid-alternateformat-colorSelect-dialog", "addclass": "jfgrid-alternateformat-colorSelect-dialog", "title": title, "content": "<div class='currenColor' data-source='"+ source +"'>当前颜色：<span title='"+ currenColor +"' style='background-color:"+ currenColor +"'></span></div><div class='colorshowbox'></div>", "botton": '<button id="jfgrid-alternateformat-colorSelect-dialog-confirm" class="btn btn-primary">确定</button><button class="btn btn-default jfgrid-model-close-btn">取消</button>', "style": "z-index:100003" }));
            var $t = $("#jfgrid-alternateformat-colorSelect-dialog").find(".jfgrid-modal-dialog-content").css("min-width", 300).end(), myh = $t.outerHeight(), myw = $t.outerWidth();
            var winw = $(window).width(), winh = $(window).height();
            var scrollLeft = $(document).scrollLeft(), scrollTop = $(document).scrollTop();
            $("#jfgrid-alternateformat-colorSelect-dialog").css({ "left": (winw + scrollLeft - myw) / 2, "top": (winh + scrollTop - myh) / 3 }).show();
            
            //初始化选择颜色插件
            $("#jfgrid-alternateformat-colorSelect-dialog").find(".colorshowbox").spectrum({
                showPalette: true,
                showPaletteOnly: true,
                preferredFormat: "hex",
                clickoutFiresChange: false,
                showInitial: true,
                showInput: true,
                flat: true,
                hideAfterPaletteSelect: true,
                showSelectionPalette: true,
                showButtons: false,//隐藏选择取消按钮
                maxPaletteSize: 8,
                maxSelectionSize: 8,
                color: currenColor,
                cancelText: "取消",
                chooseText: "确定颜色",
                togglePaletteMoreText: "自定义",
                togglePaletteLessText: "收起",
                togglePaletteOnly: true,
                clearText: "清除颜色选择",
                noColorSelectedText: "没有颜色被选择",
                localStorageKey: "spectrum.textcolor" + jfgrid.server.gridKey,
                palette: [
                    ["#000", "#444", "#666", "#999", "#ccc", "#eee", "#f3f3f3", "#fff"],
                    ["#f00", "#f90", "#ff0", "#0f0", "#0ff", "#00f", "#90f", "#f0f"],
                    ["#f4cccc", "#fce5cd", "#fff2cc", "#d9ead3", "#d0e0e3", "#cfe2f3", "#d9d2e9", "#ead1dc"],
                    ["#ea9999", "#f9cb9c", "#ffe599", "#b6d7a8", "#a2c4c9", "#9fc5e8", "#b4a7d6", "#d5a6bd"],
                    ["#e06666", "#f6b26b", "#ffd966", "#93c47d", "#76a5af", "#6fa8dc", "#8e7cc3", "#c27ba0"],
                    ["#c00", "#e69138", "#f1c232", "#6aa84f", "#45818e", "#3d85c6", "#674ea7", "#a64d79"],
                    ["#900", "#b45f06", "#bf9000", "#38761d", "#134f5c", "#0b5394", "#351c75", "#741b47"],
                    ["#600", "#783f04", "#7f6000", "#274e13", "#0c343d", "#073763", "#20124d", "#4c1130"]
                ],
                move: function(color){
                    if (color != null) {
                        color = color.toHexString();
                    }
                    else {
                        color = "#000";
                    }

                    $("#jfgrid-alternateformat-colorSelect-dialog .currenColor span").css("background-color", color).attr("title", color);
                }
            });
        },
        rangeDialog: function(value){
            $("#jfgrid-modal-dialog-mask").hide();
            $("#jfgrid-alternateformat-rangeDialog").remove();

            $("body").append(jfgrid.replaceHtml(modelHTML, { "id": "jfgrid-alternateformat-rangeDialog", "addclass": "jfgrid-alternateformat-rangeDialog", "title": "选择应用范围", "content": '<input readonly="readonly" placeholder="请选择交替颜色应用范围" value="'+value+'"/>', "botton": '<button id="jfgrid-alternateformat-rangeDialog-confirm" class="btn btn-primary">确定</button><button id="jfgrid-alternateformat-rangeDialog-close" class="btn btn-default">取消</button>', "style": "z-index:100003" }));
            var $t = $("#jfgrid-alternateformat-rangeDialog").find(".jfgrid-modal-dialog-content").css("min-width", 300).end(), myh = $t.outerHeight(), myw = $t.outerWidth();
            var winw = $(window).width(), winh = $(window).height();
            var scrollLeft = $(document).scrollLeft(), scrollTop = $(document).scrollTop();
            $("#jfgrid-alternateformat-rangeDialog").css({ "left": (winw + scrollLeft - myw) / 2, "top": (winh + scrollTop - myh) / 3 }).show();
        },
        rangeIsExists: function(range, index){
            var isExists = false;
            var existsIndex = null;

            //获取已有交替颜色所有应用范围
            var AFarr = $.extend(true, [], jfgridfile[jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex)]["jfgrid_alternateformat_save"]);

            if(index != undefined && index != null){
                if(AFarr.length > 1){
                    AFarr.splice(index, 1);
                }
                else{
                    AFarr = [];
                }
            }

            if(AFarr.length > 0){
                var arr = [];
                for(var i = 0; i < AFarr.length; i++){
                    var obj = {
                        "index": i,
                        "map": jfgrid.alternateformat.getRangeMap(AFarr[i]["cellrange"]["row"], AFarr[i]["cellrange"]["column"])
                    }

                    arr.push(obj);
                }
                
                //获取当前选区
                var rangeMap = jfgrid.alternateformat.getRangeMap(range["row"], range["column"]);
                
                //遍历
                for(x in rangeMap){
                    if(isExists){
                        break;
                    } 

                    for(var j = 0; j < arr.length; j++){
                        if(x in arr[j]["map"]){
                            isExists = true;
                            existsIndex = arr[j]["index"];
                            break;
                        }
                    }
                }
            }

            return [isExists, existsIndex];
        },
        getRangeMap: function(row, column){
            var map = {};
            var st_r = row[0], ed_r = row[1], st_c = column[0], ed_c = column[1];
            
            for(var r = st_r; r <= ed_r; r++){
                for(var c = st_c; c <= ed_c; c++){
                    map[r + "_" + c] = 0;
                }
            }
            
            return map;
        },
        getIndexByFormat: function(format){
            var index = null;

            //格式样式 模板
            var modelList = jfgrid.alternateformat.FixedModelColor;
            for(var i = 0; i < modelList.length; i++){
                var obj = modelList[i];

                if(format["head"].fc == obj["head"].fc && format["head"].bc == obj["head"].bc){
                    if(format["one"].fc == obj["one"].fc && format["one"].bc == obj["one"].bc){
                        if(format["two"].fc == obj["two"].fc && format["two"].bc == obj["two"].bc){
                            if(format["foot"].fc == obj["foot"].fc && format["foot"].bc == obj["foot"].bc){
                                index = i;
                                break;
                            }
                        }
                    }
                }
            }
            
            //自定义 模板
            var modelCustom = jfgridfile[jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex)]["jfgrid_alternateformat_save_modelCustom"];
            if(modelCustom != null && modelCustom.length > 0){
                for(var j = 0; j < modelCustom.length; j++){
                    var obj = modelCustom[j];

                    if(format["head"].fc == obj["head"].fc && format["head"].bc == obj["head"].bc){
                        if(format["one"].fc == obj["one"].fc && format["one"].bc == obj["one"].bc){
                            if(format["two"].fc == obj["two"].fc && format["two"].bc == obj["two"].bc){
                                if(format["foot"].fc == obj["foot"].fc && format["foot"].bc == obj["foot"].bc){
                                    index = modelList.length + j;
                                    break;
                                }
                            }
                        }
                    }
                }
            }
           
            return index;
        },
        getFormatByIndex: function(){
            var index = jfgrid.alternateformat.modelfocusIndex;
            var len = jfgrid.alternateformat.FixedModelColor.length;

            var format = {};

            if(index < len){
                format = jfgrid.alternateformat.FixedModelColor[index];
            }
            else{
                format = jfgridfile[jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex)]["jfgrid_alternateformat_save_modelCustom"][index - len];
            }

            return format;
        },
        new: function(cellrange){
            var format = jfgrid.alternateformat.getFormatByIndex();

            var file = jfgridfile[jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex)];
            var ruleArr = file["jfgrid_alternateformat_save"];
            
            if(ruleArr == null){
                ruleArr = [];
            }

            //保存之前的规则
            var historyRules = $.extend(true, [], ruleArr);
            
            //保存当前的规则
            var obj = {
                "cellrange": {
                    "row": cellrange["row"],
                    "column": cellrange["column"]
                },
                "format": format,
                "hasRowHeader": true,
                "hasRowFooter": false
            }

            ruleArr.push(obj);

            var currentRules = $.extend(true, [], ruleArr);
            
            //刷新一次表格
            jfgrid.alternateformat.ref(historyRules, currentRules);

            if(jfgrid.server.allowUpdate){
                jfgrid.server.saveParam("all", jfgrid.currentSheetIndex, ruleArr, { "k": "jfgrid_alternateformat_save" });
            }
        },
        update: function(){
            //获取标识
            var dataIndex = $("#jfgrid-alternateformat-remove").data("index");
            
            //应用范围
            var rangeValue = $("#jfgrid-modal-dialog-slider-alternateformat #jfgrid-alternateformat-range input").val().trim();
            if(jfgrid.formula.iscelldata(rangeValue)){
                var cellrange = jfgrid.formula.getcellrange(rangeValue);
                var isExists = jfgrid.alternateformat.rangeIsExists(cellrange, dataIndex)[0];

                if(isExists){
                    if(jfgrid.isEditMode()){
                        alert("您选择的应用范围已存在交替颜色且不属于你要编辑的应用范围！");
                    }
                    else{
                        jfgrid.tooltip.info("您选择的应用范围已存在交替颜色且不属于你要编辑的应用范围！", ""); 
                    }

                    return;
                }
            }
            else{
                if(jfgrid.isEditMode()){
                    alert("您选择的应用范围不是选区！");
                }
                else{
                    jfgrid.tooltip.info("您选择的应用范围不是选区！", "");
                }

                return;
            }

            //页眉、页脚
            if($("#jfgrid-modal-dialog-slider-alternateformat #jfgrid-alternateformat-rowHeader").is(":checked")){
                var hasRowHeader = true;
            }
            else{
                var hasRowHeader = false;    
            }

            if($("#jfgrid-modal-dialog-slider-alternateformat #jfgrid-alternateformat-rowFooter").is(":checked")){
                var hasRowFooter = true;
            }
            else{
                var hasRowFooter = false;    
            }

            //获取选中样式模板的颜色
            var format = jfgrid.alternateformat.getFormatByIndex();
            var file = jfgridfile[jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex)];
            
            var ruleArr = file["jfgrid_alternateformat_save"];
            if(ruleArr == null){
                ruleArr = [];
            }
            
            //保存之前的规则
            var historyRules = $.extend(true, [], ruleArr);
            
            //保存当前的规则
            var obj = {
                "cellrange": {
                    "row": cellrange["row"],
                    "column": cellrange["column"]
                },
                "format": format,
                "hasRowHeader": hasRowHeader,
                "hasRowFooter": hasRowFooter
            }
            
            ruleArr[dataIndex] = obj;

            var currentRules = $.extend(true, [], ruleArr);
            
            //刷新一次表格
            jfgrid.alternateformat.ref(historyRules, currentRules);

            if(jfgrid.server.allowUpdate){
                jfgrid.server.saveParam("all", jfgrid.currentSheetIndex, ruleArr, { "k": "jfgrid_alternateformat_save" });
            }
        },
        checksAF: function(r, c, computeMap){
            if((r + "_" + c) in computeMap){
                //返回值（fc  bc）
                return computeMap[r + "_" + c];
            }
            else{
                return null;
            }
        },
        getComputeMap: function(){
            var file = jfgridfile[jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex)];
            var ruleArr = file["jfgrid_alternateformat_save"];

            var computeMap = jfgrid.alternateformat.compute(ruleArr);

            return computeMap;
        },
        compute: function(obj){
            //计算存储
            var computeMap = {};

            if(obj != null && obj.length > 0){
                for(var i = 0; i < obj.length; i++){
                    var cellrange = obj[i]["cellrange"];
                    var format = obj[i]["format"];
                    var hasRowHeader = obj[i]["hasRowHeader"];
                    var hasRowFooter = obj[i]["hasRowFooter"];
                    var st_r = cellrange["row"][0], 
                        ed_r = cellrange["row"][1], 
                        st_c = cellrange["column"][0], 
                        ed_c = cellrange["column"][1];
                    
                    if(hasRowHeader && hasRowFooter){
                        //页眉所在行
                        for(var c = st_c; c <= ed_c; c++){
                            computeMap[st_r + "_" + c] = [format["head"].fc, format["head"].bc];
                        }

                        //中间行
                        if(ed_r - st_r > 1){
                            for(var r = st_r + 1; r < ed_r; r++){
                                if((r - st_r) % 2 != 0){
                                    var fc = format["one"].fc;
                                    var bc = format["one"].bc;
                                }
                                else{
                                    var fc = format["two"].fc;
                                    var bc = format["two"].bc;
                                }

                                for(var c = st_c; c <= ed_c; c++){
                                    computeMap[r + "_" + c] = [fc, bc];
                                } 
                            }
                        }

                        //页脚所在行
                        if(ed_r > st_r){
                            for(var c = st_c; c <= ed_c; c++){
                                computeMap[ed_r + "_" + c] = [format["foot"].fc, format["foot"].bc];
                            }
                        }
                    }
                    else if(hasRowHeader){
                        //页眉所在行
                        for(var c = st_c; c <= ed_c; c++){
                            computeMap[st_r + "_" + c] = [format["head"].fc, format["head"].bc];
                        }

                        //中间行
                        if(ed_r > st_r){
                            for(var r = st_r + 1; r <= ed_r; r++){
                                if((r - st_r) % 2 != 0){
                                    var fc = format["one"].fc;
                                    var bc = format["one"].bc;
                                }
                                else{
                                    var fc = format["two"].fc;
                                    var bc = format["two"].bc;
                                }

                                for(var c = st_c; c <= ed_c; c++){
                                    computeMap[r + "_" + c] = [fc, bc];
                                } 
                            }
                        }
                    }
                    else if(hasRowFooter){
                        //中间行
                        if(ed_r > st_r){
                            for(var r = st_r; r < ed_r; r++){
                                if((r - st_r) % 2 == 0){
                                    var fc = format["one"].fc;
                                    var bc = format["one"].bc;
                                }
                                else{
                                    var fc = format["two"].fc;
                                    var bc = format["two"].bc;
                                }

                                for(var c = st_c; c <= ed_c; c++){
                                    computeMap[r + "_" + c] = [fc, bc];
                                }
                            }
                        }

                        //页脚所在行
                        for(var c = st_c; c <= ed_c; c++){
                            computeMap[ed_r + "_" + c] = [format["foot"].fc, format["foot"].bc];
                        }
                    }
                    else{
                        //中间行
                        for(var r = st_r; r <= ed_r; r++){
                            if((r - st_r) % 2 == 0){
                                var fc = format["one"].fc;
                                var bc = format["one"].bc;
                            }
                            else{
                                var fc = format["two"].fc;
                                var bc = format["two"].bc;
                            }

                            for(var c = st_c; c <= ed_c; c++){
                                computeMap[r + "_" + c] = [fc, bc];
                            } 
                        }
                    }
                }
            }

            return computeMap;
        },
        ref: function(historyRules, currentRules){
            if (clearjfundo) {
                jfgrid.jfundo = [];

                var redo = {};
                redo["type"] = "updateAF";
                redo["sheetIndex"] = jfgrid.currentSheetIndex;
                redo["data"] = {"historyRules": historyRules, "currentRules": currentRules};
                jfgrid.jfredo.push(redo); 
            }

            var index = jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex);
            jfgridfile[index]["jfgrid_alternateformat_save"] = currentRules;

            setTimeout(function () {
                jfgrid.jfgridrefreshgrid();
            }, 1);
        }
    }

    //if公式生成器
    jfgrid.ifFormulaGenerator = {
        singleRangeFocus: false,
        init: function(){
            //点击选择单元格
            $(document).off("focus.IFcompareValue").on("focus.IFcompareValue","#jfgrid-ifFormulaGenerator-dialog #compareValue",function(){
                $("#jfgrid-modal-dialog-mask").hide();
                jfgrid.ifFormulaGenerator.singleRangeFocus = true;
            });
            $(document).off("click.IFsingRange").on("click.IFsingRange","#jfgrid-ifFormulaGenerator-dialog .singRange",function(){
                var value = $("#jfgrid-ifFormulaGenerator-dialog #compareValue").val().trim();
                if(jfgrid.formula.iscelldata(value)){
                    jfgrid.ifFormulaGenerator.singleRangeDialog(value);
                }
                else{
                    jfgrid.ifFormulaGenerator.singleRangeDialog();
                }
            });
            $(document).off("click.IFsingRangeConfirm").on("click.IFsingRangeConfirm","#jfgrid-ifFormulaGenerator-singleRange-confirm",function(){
                $("#jfgrid-formula-functionrange-select").hide();

                $("#jfgrid-ifFormulaGenerator-singleRange-dialog").hide();
                $("#jfgrid-modal-dialog-mask").show();
                $("#jfgrid-ifFormulaGenerator-dialog").show();

                var value = $(this).parents("#jfgrid-ifFormulaGenerator-singleRange-dialog").find("input").val().trim();
                $("#jfgrid-ifFormulaGenerator-dialog #compareValue").val(value);

                jfgrid.ifFormulaGenerator.singleRangeFocus = false;                 
            });
            $(document).off("click.IFsingRangeCancel").on("click.IFsingRangeCancel","#jfgrid-ifFormulaGenerator-singleRange-cancel",function(){
                $("#jfgrid-formula-functionrange-select").hide();

                $("#jfgrid-ifFormulaGenerator-singleRange-dialog").hide();
                $("#jfgrid-modal-dialog-mask").show();
                $("#jfgrid-ifFormulaGenerator-dialog").show();

                jfgrid.ifFormulaGenerator.singleRangeFocus = false;                 
            });
            $(document).off("click.IFsingRangeClose").on("click.IFsingRangeClose","#jfgrid-ifFormulaGenerator-singleRange-dialog .jfgrid-modal-dialog-title-close",function(){
                $("#jfgrid-formula-functionrange-select").hide();

                $("#jfgrid-modal-dialog-mask").show();
                $("#jfgrid-ifFormulaGenerator-dialog").show();

                jfgrid.ifFormulaGenerator.singleRangeFocus = false;
            });
            //点击选择范围
            $(document).off("click.IFmultiRange").on("click.IFmultiRange","#jfgrid-ifFormulaGenerator-dialog .multiRange",function(){
                jfgrid.ifFormulaGenerator.multiRangeDialog();

                jfgrid.ifFormulaGenerator.singleRangeFocus = false;
            });
            $(document).off("click.IFmultiRangeConfirm").on("click.IFmultiRangeConfirm","#jfgrid-ifFormulaGenerator-multiRange-confirm",function(){
                $("#jfgrid-formula-functionrange-select").hide();
                $("#jfgrid-row-count-show").hide();
                $("#jfgrid-column-count-show").hide();

                $("#jfgrid-ifFormulaGenerator-multiRange-dialog").hide();
                $("#jfgrid-modal-dialog-mask").show();
                $("#jfgrid-ifFormulaGenerator-dialog").show();

                var value = $(this).parents("#jfgrid-ifFormulaGenerator-multiRange-dialog").find("input").val().trim();
                var cellrange = jfgrid.formula.getcellrange(value);
                var str_r = cellrange["row"][0], end_r = cellrange["row"][1], str_c = cellrange["column"][0], end_c = cellrange["column"][1];
                var d = jfgrid.editor.deepCopyFlowData(jfgrid.flowdata);//取数据
                var arr = [];
                //获取范围内所有数值
                for(var r = str_r; r <= end_r; r++){
                    for(var c = str_c; c <= end_c; c++){
                        if(d[r] != null && d[r][c] != null && d[r][c]["ct"] != null && d[r][c]["ct"]["t"] == "n"){
                            arr.push(d[r][c]["v"]);
                        }
                    }
                }
                //从大到小排序
                for(var j = 0; j < arr.length; j++){
                    for(var k = 0; k < arr.length - 1 - j; k++){
                        if(arr[k]<arr[k+1]){
                            var temp=arr[k];
                            arr[k]=arr[k+1];
                            arr[k+1]=temp;
                        }
                    }
                }
                var largeNum = arr[0];
                var smallNum = arr[arr.length - 1];
                //赋值
                $("#jfgrid-ifFormulaGenerator-dialog #smallRange").val(smallNum);
                $("#jfgrid-ifFormulaGenerator-dialog #largeRange").val(largeNum);
            });
            $(document).off("click.IFmultiRangeCancel").on("click.IFmultiRangeCancel","#jfgrid-ifFormulaGenerator-multiRange-cancel",function(){
                $("#jfgrid-formula-functionrange-select").hide();
                $("#jfgrid-row-count-show").hide();
                $("#jfgrid-column-count-show").hide();

                $("#jfgrid-ifFormulaGenerator-multiRange-dialog").hide();
                $("#jfgrid-modal-dialog-mask").show();
                $("#jfgrid-ifFormulaGenerator-dialog").show();
            });
            $(document).off("click.IFmultiRangeClose").on("click.IFmultiRangeClose","#jfgrid-ifFormulaGenerator-multiRange-dialog .jfgrid-modal-dialog-title-close",function(){
                $("#jfgrid-formula-functionrange-select").hide();
                $("#jfgrid-row-count-show").hide();
                $("#jfgrid-column-count-show").hide();

                $("#jfgrid-modal-dialog-mask").show();
                $("#jfgrid-ifFormulaGenerator-dialog").show();
            });
            //选择 划分方式
            $(document).on("change","#DivisionMethod",function(){
                var value = $(this).find("option:selected").val();
                if(value == "2"){
                    $("#DivisionMethodVal").hide();
                }
                else{
                    $("#DivisionMethodVal").show();   
                }
                $("#jfgrid-ifFormulaGenerator-dialog .ifList").empty();
            });
            //点击 生成 按钮
            $(document).off("click.IFcreateBtn").on("click.IFcreateBtn","#jfgrid-ifFormulaGenerator-dialog #createBtn",function(){
                var compareValue = $(this).parents("#jfgrid-ifFormulaGenerator-dialog").find("#compareValue").val().trim();
                if(compareValue == ""){
                    jfgrid.ifFormulaGenerator.info("比较值不能为空！");
                    return;
                }
                var method = $(this).parents("#jfgrid-ifFormulaGenerator-dialog").find("#DivisionMethod option:selected").val();
                if(method == "2"){
                    var itemHtml =  '<div class="item">'+
                                        '<input type="number" class="smallNum formulaInputFocus"/>'+
                                        '<select class="operator">'+
                                            '<option value="0"> <= </option>'+
                                            '<option value="1"> < </option>'+
                                        '</select>'+
                                        '<span class="compareValue">'+compareValue+'</span>'+
                                        '<select class="operator2">'+
                                            '<option value="0"> <= </option>'+
                                            '<option value="1" selected="selected"> < </option>'+
                                        '</select>'+
                                        '<input type="number" class="largeNum formulaInputFocus"/>'+
                                        '<span>标签：</span>'+
                                        '<input type="text" class="markText formulaInputFocus" value="">'+
                                        '<i class="fa fa-remove" aria-hidden="true"></i>'+
                                    '</div>';
                    $("#jfgrid-ifFormulaGenerator-dialog .ifList").append(itemHtml);                
                }
                else{
                    var smallRange = $(this).parents("#jfgrid-ifFormulaGenerator-dialog").find("#smallRange").val().trim();
                    var largeRange = $(this).parents("#jfgrid-ifFormulaGenerator-dialog").find("#largeRange").val().trim();
                    var DivisionMethodVal = $(this).parents("#jfgrid-ifFormulaGenerator-dialog").find("#DivisionMethodVal").val().trim();
                    if(smallRange == "" || largeRange == ""){
                        jfgrid.ifFormulaGenerator.info("范围不能为空！");
                        return;
                    }
                    else if(DivisionMethodVal == ""){
                        jfgrid.ifFormulaGenerator.info("划分值不能为空！");
                        return;
                    }
                    jfgrid.ifFormulaGenerator.getIfList(compareValue, smallRange, largeRange, method, DivisionMethodVal);
                }
            });
            //点击 删除条件
            $(document).on("click","#jfgrid-ifFormulaGenerator-dialog .item .fa-remove",function(){
                $(this).parents(".item").remove();
            });
            //点击 确认 按钮
            $(document).off("click.IFconfirmBtn").on("click.IFconfirmBtn","#jfgrid-ifFormulaGenerator-dialog-confirm",function(){
                var $item = $(this).parents("#jfgrid-ifFormulaGenerator-dialog").find(".ifList .item");
                var str = '';
                $($item.toArray().reverse()).each(function(i,e){
                    var smallNum = $(e).find(".smallNum").val().trim();
                    var largeNum = $(e).find(".largeNum").val().trim();
                    var operator = $(e).find(".operator option:selected").val();
                    var operator2 = $(e).find(".operator2 option:selected").val();
                    var compareValue = $(e).find(".compareValue").text();
                    var markText = $(e).find(".markText").val().trim();
                    if(markText == ""){
                        markText = "标签" + (i + 1);
                    }
                    if(smallNum == "" && largeNum == ""){
                        return true;
                    }

                    if(operator == "0"){
                        var s = compareValue + ">=" + smallNum;
                    }
                    else{
                        var s = compareValue + ">" + smallNum;
                    }

                    if(operator2 == "0"){
                        var l = compareValue + "<=" + largeNum;
                    }
                    else{
                        var l = compareValue + "<" + largeNum;
                    }

                    if(i == 0 && largeNum == ""){
                        var a = s;
                    }
                    else if(i == ($item.length - 1) && smallNum == ""){
                        var a = l;
                    }
                    else{
                        var a = "and("+s+","+l+")";
                    }

                    if(i == 0){
                        str = 'if('+a+',"'+markText+'")';
                    }
                    else{
                        str = 'if('+a+',"'+markText+'",'+str+')';
                    }
                })
                //
                if(str.length == 0){
                    jfgrid.ifFormulaGenerator.info("没有生成可用的条件！");
                    return;
                }
                $("#jfgrid-modal-dialog-mask").hide();
                $("#jfgrid-ifFormulaGenerator-dialog").hide();

                var last = jfgird_select_save[jfgird_select_save.length - 1];

                var row_index = last["row_focus"], col_index = last["column_focus"];
                var row = visibledatarow[row_index], row_pre = row_index - 1 == -1 ? 0 : visibledatarow[row_index - 1];
                var col = visibledatacolumn[col_index], col_pre = col_index - 1 == -1 ? 0 : visibledatacolumn[col_index - 1];
                
                jfgrid.jfgridupdateCell(row, row_pre, row_index, col, col_pre, col_index, jfgrid.flowdata);

                $("#jfgrid-rich-text-editor").html("=" + str);
                $("#jfgrid-functionbox-cell").html($("#jfgrid-rich-text-editor").html());

                $("#jfgrid-wa-functionbox-confirm").click();
                // var fp = $.trim(jfgrid.formula.functionParser(str));
                // var result = eval(fp);
            });
            //info
            $(document).on("click","#jfgrid-ifFormulaGenerator-info .jfgrid-model-close-btn",function(){
                $("#jfgrid-modal-dialog-mask").show();
            });
            $(document).on("click","#jfgrid-ifFormulaGenerator-info .jfgrid-modal-dialog-title-close",function(){
                $("#jfgrid-modal-dialog-mask").show();
            });
        },
        ifFormulaDialog: function(fp){
            $("#jfgrid-modal-dialog-mask").show();
            $("#jfgrid-ifFormulaGenerator-dialog").remove();

            var compareValue = "";
            var ifListHtml = '';
            if(!!fp){
                var arr = fp.split("if(");
                for(var i = 1; i < arr.length; i++){
                    var txt = arr[i].replace("and(","").replace(/\)/g,"").replace(/\"/g,"");
                    var arr2 = txt.split(",");
                    arr2 = jfgrid.ifFormulaGenerator.clearArr(arr2);
                    
                    compareValue = jfgrid.ifFormulaGenerator.splitTxt(arr2[0])[0];
                    if(arr2.length == 3){
                        var smallNum = jfgrid.ifFormulaGenerator.splitTxt(arr2[0])[1];
                        var largeNum = jfgrid.ifFormulaGenerator.splitTxt(arr2[1])[2];
                        var markText = arr2[2];
                    }
                    else{
                        var smallNum = jfgrid.ifFormulaGenerator.splitTxt(arr2[0])[1];
                        var largeNum = jfgrid.ifFormulaGenerator.splitTxt(arr2[0])[2];
                        var markText = arr2[1];
                    }

                    var itemHtml =  '<div class="item">'+
                                        '<input type="number" class="smallNum formulaInputFocus" value="'+smallNum+'"/>'+
                                        '<select class="operator">'+
                                            '<option value="0"> <= </option>'+
                                            '<option value="1"> < </option>'+
                                        '</select>'+
                                        '<span class="compareValue">'+compareValue+'</span>'+
                                        '<select class="operator2">'+
                                            '<option value="0"> <= </option>'+
                                            '<option value="1" selected="selected"> < </option>'+
                                        '</select>'+
                                        '<input type="number" class="largeNum formulaInputFocus" value="'+largeNum+'"/>'+
                                        '<span>标签：</span>'+
                                        '<input type="text" class="markText formulaInputFocus" value="'+markText+'">'+
                                        '<i class="fa fa-remove" aria-hidden="true"></i>'+
                                    '</div>'; 
                    ifListHtml += itemHtml;                             
                }
            }
            var content = '<div class="ifAttr">'+
                            '<div class="attrBox">'+
                                '<label for="compareValue"> 比较值 </label>'+
                                '<div class="inpBox">'+
                                    '<input id="compareValue" class="formulaInputFocus" value="'+compareValue+'"/>'+
                                    '<i class="singRange fa fa-table" aria-hidden="true" title="点击选择单元格"></i>'+
                                '</div>'+
                            '</div>'+
                            '<div class="attrBox">'+
                                '<label for="smallRange"> 范围 </label>'+
                                '<input type="number" id="smallRange" class="formulaInputFocus"/>'+
                                '<span class="text"> 至 </span>'+
                                '<input type="number" id="largeRange" class="formulaInputFocus"/>'+
                                '<div id="rangeAssess">'+
                                    '<span> 范围评估 </span>'+
                                    '<i class="multiRange fa fa-table" aria-hidden="true" title="点击选择范围"></i>'+
                                '</div>'+
                            '</div>'+
                            '<div class="attrBox">'+
                                '<label for="DivisionMethod"> 划分方式 </label>'+
                                '<select id="DivisionMethod">'+
                                    '<option value="0"> 划分值相同 </option>'+
                                    '<option value="1"> 划分为N份 </option>'+
                                    '<option value="2"> 自定义输入 </option>'+
                                '</select>'+
                                '<input id="DivisionMethodVal" class="formulaInputFocus"/>'+
                                '<div id="createBtn"> 生成 </div>'+
                            '</div>'+
                          '</div>'+
                          '<div class="ifList">'+ifListHtml+'</div>';

            $("body").append(jfgrid.replaceHtml(modelHTML, { "id": "jfgrid-ifFormulaGenerator-dialog", "addclass": "jfgrid-ifFormulaGenerator-dialog", "title": "if公式生成器", "content": content, "botton": '<button id="jfgrid-ifFormulaGenerator-dialog-confirm" class="btn btn-primary">确认</button><button class="btn btn-default jfgrid-model-close-btn">取消</button>', "style": "z-index:100003" }));
            var $t = $("#jfgrid-ifFormulaGenerator-dialog").find(".jfgrid-modal-dialog-content").css("min-width", 590).end(), myh = $t.outerHeight(), myw = $t.outerWidth();
            var winw = $(window).width(), winh = $(window).height();
            var scrollLeft = $(document).scrollLeft(), scrollTop = $(document).scrollTop();
            $("#jfgrid-ifFormulaGenerator-dialog").css({ "left": (winw + scrollLeft - myw) / 2, "top": (winh + scrollTop - myh) / 3 }).show();
        },
        clearArr: function(arr){
            for(var i = 0; i < arr.length; i++){
                if(arr[i] == "" || arr[i] == null || arr[i] == undefined){
                    arr.splice(i, 1);
                }
            }

            return arr;
        },
        splitTxt: function(txt){
            var compareValue, smallNum, largeNum;
            
            if(txt.indexOf(">=") != -1){
                compareValue = txt.split(">=")[0];
                smallNum = txt.split(">=")[1];

                return [compareValue, smallNum, largeNum];
            }
            else if(txt.indexOf(">") != -1){
                compareValue = txt.split(">")[0];
                smallNum = txt.split(">")[1];

                return [compareValue, smallNum, largeNum];
            }
            else if(txt.indexOf("<=") != -1){
                compareValue = txt.split("<=")[0];
                largeNum = txt.split("<=")[1];

                return [compareValue, smallNum, largeNum];
            }
            else if(txt.indexOf("<") != -1){
                compareValue = txt.split("<")[0];
                largeNum = txt.split("<")[1];

                return [compareValue, smallNum, largeNum];
            }
        },
        singleRangeDialog: function(value){
            $("#jfgrid-modal-dialog-mask").hide();
            $("#jfgrid-ifFormulaGenerator-dialog").hide();
            $("#jfgrid-ifFormulaGenerator-singleRange-dialog").remove();
            if(value != undefined && value != null){
                var val = value;
            }
            else{
                var val = "";
            }

            $("body").append(jfgrid.replaceHtml(modelHTML, { "id": "jfgrid-ifFormulaGenerator-singleRange-dialog", "addclass": "jfgrid-ifFormulaGenerator-singleRange-dialog", "title": "选择单元格", "content": '<input readonly="readonly" placeholder="请选择单元格" value="'+val+'">', "botton": '<button id="jfgrid-ifFormulaGenerator-singleRange-confirm" class="btn btn-primary">确认</button><button id="jfgrid-ifFormulaGenerator-singleRange-cancel" class="btn btn-default">取消</button>', "style": "z-index:100003" }));
            var $t = $("#jfgrid-ifFormulaGenerator-singleRange-dialog").find(".jfgrid-modal-dialog-content").css("min-width", 400).end(), myh = $t.outerHeight(), myw = $t.outerWidth();
            var winw = $(window).width(), winh = $(window).height();
            var scrollLeft = $(document).scrollLeft(), scrollTop = $(document).scrollTop();
            $("#jfgrid-ifFormulaGenerator-singleRange-dialog").css({ "left": (winw + scrollLeft - myw) / 2, "top": (winh + scrollTop - myh) / 3 }).show();
        },
        multiRangeDialog: function(){
            $("#jfgrid-modal-dialog-mask").hide();
            $("#jfgrid-ifFormulaGenerator-dialog").hide();
            $("#jfgrid-ifFormulaGenerator-multiRange-dialog").remove();

            $("body").append(jfgrid.replaceHtml(modelHTML, { "id": "jfgrid-ifFormulaGenerator-multiRange-dialog", "addclass": "jfgrid-ifFormulaGenerator-multiRange-dialog", "title": "选择范围", "content": '<input readonly="readonly" placeholder="请选择范围" value="">', "botton": '<button id="jfgrid-ifFormulaGenerator-multiRange-confirm" class="btn btn-primary">确认</button><button id="jfgrid-ifFormulaGenerator-multiRange-cancel" class="btn btn-default">取消</button>', "style": "z-index:100003" }));
            var $t = $("#jfgrid-ifFormulaGenerator-multiRange-dialog").find(".jfgrid-modal-dialog-content").css("min-width", 400).end(), myh = $t.outerHeight(), myw = $t.outerWidth();
            var winw = $(window).width(), winh = $(window).height();
            var scrollLeft = $(document).scrollLeft(), scrollTop = $(document).scrollTop();
            $("#jfgrid-ifFormulaGenerator-multiRange-dialog").css({ "left": (winw + scrollLeft - myw) / 2, "top": (winh + scrollTop - myh) / 3 }).show();
        },
        getIfList: function(compareValue, smallRange, largeRange, method, methodVal){
            $("#jfgrid-ifFormulaGenerator-dialog .ifList").empty();

            var smallRange = parseInt(smallRange);
            var largeRange = parseInt(largeRange);
            var methodVal = parseInt(methodVal);

            var arr = [];
            if(method == "0"){
                var len = Math.ceil((largeRange - smallRange) / methodVal); 
                for(var i = 0; i <= len; i++){
                    var num = smallRange + methodVal * i;
                    if(i == 0 || num >= largeRange){
                        arr.push("");
                    }
                    else{
                        arr.push(num);
                    }
                }
                
            }
            else if(method == "1"){
                var addnum = Math.ceil((largeRange - smallRange) / methodVal);
                for(var i = 0; i <= methodVal; i++){
                    var num = smallRange + addnum * i;
                    if(i == 0 || num >= largeRange){
                        arr.push("");
                    }
                    else{
                        arr.push(num);
                    }
                }
            }
            for(var j = 0; j < arr.length - 1; j++){
                if(j == 0){
                    var markText = "小于" + arr[j + 1];
                }
                else if(j == arr.length - 2){
                    var markText = "大于等于" + arr[j];
                }
                else{
                    var markText = arr[j] + "到" + arr[j + 1];
                }
                var itemHtml =  '<div class="item">'+
                                    '<input type="number" class="smallNum formulaInputFocus" value="'+arr[j]+'"/>'+
                                    '<select class="operator">'+
                                        '<option value="0"> <= </option>'+
                                        '<option value="1"> < </option>'+
                                    '</select>'+
                                    '<span class="compareValue">'+compareValue+'</span>'+
                                    '<select class="operator2">'+
                                        '<option value="0"> <= </option>'+
                                        '<option value="1" selected="selected"> < </option>'+
                                    '</select>'+
                                    '<input type="number" class="largeNum formulaInputFocus" value="'+arr[j + 1]+'"/>'+
                                    '<span>标签：</span>'+
                                    '<input type="text" class="markText formulaInputFocus" value="'+markText+'">'+
                                    '<i class="fa fa-remove" aria-hidden="true"></i>'+
                                '</div>';
                $("#jfgrid-ifFormulaGenerator-dialog .ifList").append(itemHtml);
            }
        },
        info: function(title){
            $("#jfgrid-modal-dialog-mask").show();
            $("#jfgrid-ifFormulaGenerator-info").remove();
            $("body").append(jfgrid.replaceHtml(modelHTML, { "id": "jfgrid-ifFormulaGenerator-info", "addclass": "", "title": title, "content": "", "botton": '<button class="btn btn-default jfgrid-model-close-btn">&nbsp;&nbsp;关闭&nbsp;&nbsp;</button>', "style": "z-index:100003" }));
            var $t = $("#jfgrid-ifFormulaGenerator-info").find(".jfgrid-modal-dialog-content").css("min-width", 300).end(), myh = $t.outerHeight(), myw = $t.outerWidth();
            var winw = $(window).width(), winh = $(window).height();
            var scrollLeft = $(document).scrollLeft(), scrollTop = $(document).scrollTop();
            $("#jfgrid-ifFormulaGenerator-info").css({ "left": (winw + scrollLeft - myw) / 2, "top": (winh + scrollTop - myh) / 3 }).show();
        }
    }

    //插入函数
    jfgrid.insertFormula = {
        init: function(){
            $(document).off("keyup.fxSFLI").on("keyup.fxSFLI", "#searchFormulaListInput", function(){
                $("#formulaTypeList").empty();
                var txt = $(this).val().toUpperCase();

                if(txt == ""){
                    //若没有查找内容则根据类别筛选
                    jfgrid.insertFormula.formulaListByType($("#formulaTypeSelect option:selected").val());
                }
                else{
                    for(var i = 0; i < jfgrid.functionlist.length; i++){
                        if(/^[a-zA-Z]+$/.test(txt)){
                            if(jfgrid.functionlist[i].n.indexOf(txt) != "-1"){
                                $('<div class="listBox" name="'+ jfgrid.functionlist[i].n +'"><span>'+ jfgrid.functionlist[i].n +'</span><span>'+ jfgrid.functionlist[i].a +'</span></div>').appendTo($("#formulaTypeList"));
                            }
                        }
                        else if(jfgrid.functionlist[i].a.indexOf(txt) != "-1"){
                            $('<div class="listBox" name="'+ jfgrid.functionlist[i].n +'"><span>'+ jfgrid.functionlist[i].n +'</span><span>'+ jfgrid.functionlist[i].a +'</span></div>').appendTo($("#formulaTypeList"));
                        }
                    }
                }
                
                $("#formulaTypeList .listBox:first-child").addClass("on"); //默认公式列表第一个为选中状态
            });

            $(document).off("change.fxFormulaTS").on("change.fxFormulaTS", "#formulaTypeSelect", function(){
                var type = $("#formulaTypeSelect option:selected").val();
                jfgrid.insertFormula.formulaListByType(type);
            });

            $(document).off("click.fxListbox").on("click.fxListbox", "#formulaTypeList .listBox", function(){
                $(this).addClass("on").siblings().removeClass("on");
            });

            //选择公式后弹出参数栏弹框
            $(document).off("click.fxFormulaCf").on("click.fxFormulaCf", "#jfgrid-search-formula-confirm", function(){
                var formula = $("#jfgrid-search-formula .listBox.on").attr("name");
                var formulaTxt = '<span dir="auto" class="jfgrid-formula-text-color">=</span><span dir="auto" class="jfgrid-formula-text-color">'+ formula.toUpperCase() +'</span><span dir="auto" class="jfgrid-formula-text-color">(</span><span dir="auto" class="jfgrid-formula-text-color">)</span>';
                $("#jfgrid-rich-text-editor").html(formulaTxt);
                $("#jfgrid-functionbox-cell").html($("#jfgrid-rich-text-editor").html());

                jfgrid.insertFormula.formulaParmDialog(formula);
            });

            //公式参数框
            $(document).off("focus.fxParamInput").on("focus.fxParamInput", "#jfgrid-search-formula-parm .parmBox input", function(){
                var parmIndex = $(this).parents(".parmBox").index();
                jfgrid.formula.data_parm_index = parmIndex;

                var formulatxt = $(this).parents("#jfgrid-search-formula-parm").find(".jfgrid-modal-dialog-title-text").text();
                
                var parmLen = window.jfgrid_function[formulatxt].p.length;
                if(parmIndex >= parmLen){
                    var parmDetail = window.jfgrid_function[formulatxt].p[parmLen - 1].detail;
                    var parmRepeat = window.jfgrid_function[formulatxt].p[parmLen - 1].repeat;
                }
                else{
                    var parmDetail = window.jfgrid_function[formulatxt].p[parmIndex].detail;
                    var parmRepeat = window.jfgrid_function[formulatxt].p[parmIndex].repeat;
                }

                //参数选区显示，参数值显示
                jfgrid.insertFormula.parmTxtShow($(this).val());
                
                //计算结果
                jfgrid.insertFormula.functionStrCompute();
                
                //参数名称和释义切换
                $("#jfgrid-search-formula-parm .parmDetailsBox").empty();

                var parmName = $(this).parents(".parmBox").find(".name").text();
                $('<span>'+ parmName +':</span><span>'+ parmDetail +'</span>').appendTo($("#jfgrid-search-formula-parm .parmDetailsBox"));
                
                //公式参数可自增（参数自增最多5个）
                if(parmRepeat == "y"){
                    var parmCount = $("#jfgrid-search-formula-parm .parmBox").length;

                    if(parmCount < 5 && parmIndex == (parmCount - 1)){
                        $('<div class="parmBox"><div class="name">值'+ (parmCount + 1) +'</div><div class="txt"><input class="formulaInputFocus" /><i class="fa fa-table" aria-hidden="true" title="点击选择数据范围"></i></div><div class="val">=</div></div>').appendTo($("#jfgrid-search-formula-parm .parmListBox"));
                    }
                }
            });

            $(document).off("blur.fxParamInput").on("blur.fxParamInput", "#jfgrid-search-formula-parm .parmBox input", function(){
                var txt = $(this).val();

                if(jfgrid.formula.getfunctionParam(txt).fn == null && !jfgrid.formula.iscelldata(txt)){
                    if(!jfgrid.func_methods.isRealNum(txt) && txt != "" && txt.length <= 2 && txt.indexOf('"') != 0 && txt.lastIndexOf('"') != 0){
                        txt = '"' + txt + '"';
                        $(this).val(txt);

                        jfgrid.insertFormula.parmTxtShow(txt);
                        jfgrid.insertFormula.functionStrCompute();
                    }
                }
            });
            
            $(document).off("keyup.fxParamInput").on("keyup.fxParamInput", "#jfgrid-search-formula-parm .parmBox input", function(){
                //参数选区显示，参数值显示
                jfgrid.insertFormula.parmTxtShow($(this).val());

                //计算结果
                jfgrid.insertFormula.functionStrCompute();
            });

            //点击图标选取数据范围
            $(document).off("click.fxParamI").on("click.fxParamI", "#jfgrid-search-formula-parm .parmBox i", function(){
                jfgrid.formula.data_parm_index = $(this).parents(".parmBox").index();
                
                //选取范围弹出框
                $("#jfgrid-search-formula-parm").hide();
                $("#jfgrid-modal-dialog-mask").hide();

                $("#jfgrid-search-formula-parm-select").remove();
                
                if($(this).parents(".parmBox").find(".txt input").val() == ""){
                    $("body").append(jfgrid.replaceHtml(modelHTML, { "id": "jfgrid-search-formula-parm-select", "addclass": "jfgrid-search-formula-parm-select", "title": "选取数据范围", "content": "<input id='jfgrid-search-formula-parm-select-input' class='jfgrid-datavisual-range-container' style='font-size: 14px;padding:5px;max-width:none;' spellcheck='false' aria-label='数据范围' readonly='true' placeholder='数据范围'>", "botton": '<button id="jfgrid-search-formula-parm-select-confirm" class="btn btn-primary">确认</button>', "style": "z-index:100003" }));
                }
                else{
                    $("body").append(jfgrid.replaceHtml(modelHTML, { "id": "jfgrid-search-formula-parm-select", "addclass": "jfgrid-search-formula-parm-select", "title": "选取数据范围", "content": "<input id='jfgrid-search-formula-parm-select-input' class='jfgrid-datavisual-range-container' style='font-size: 14px;padding:5px;max-width:none;' spellcheck='false' aria-label='数据范围' readonly='true' value='"+ $(this).parents(".parmBox").find(".txt input").val() +"'>", "botton": '<button id="jfgrid-search-formula-parm-select-confirm" class="btn btn-primary">确认</button>', "style": "z-index:100003" }));
                }

                var $t = $("#jfgrid-search-formula-parm-select").find(".jfgrid-modal-dialog-content").css("min-width", 300).end(), myh = $t.outerHeight(), myw = $t.outerWidth();
                var winw = $(window).width(), winh = $(window).height();
                var scrollLeft = $(document).scrollLeft(), scrollTop = $(document).scrollTop();
                $("#jfgrid-search-formula-parm-select").css({ "left": (winw + scrollLeft - myw) / 2, "top": (winh + scrollTop - myh) / 3 }).show();
                
                //参数选区虚线框
                jfgrid.insertFormula.parmTxtShow($(this).parents(".parmBox").find(".txt input").val());
            });

            //点击确定
            $(document).off("click.fxParamCf").on("click.fxParamCf", "#jfgrid-search-formula-parm-confirm", function(){
                $("#jfgrid-wa-functionbox-confirm").click();
            });

            //选取范围后传回参数栏弹框
            $(document).off("click.fxParamSelectCf").on("click.fxParamSelectCf", "#jfgrid-search-formula-parm-select-confirm", function(){
                var parmIndex = $("#jfgrid-search-formula-parm-select-input").attr("data_parm_index");

                $("#jfgrid-search-formula-parm-select").hide();
                $("#jfgrid-search-formula-parm").show();
                $("#jfgrid-search-formula-parm .parmBox").eq(parmIndex).find(".txt input").focus();
            });
        },
        formulaListDialog: function(){
            $("#jfgrid-modal-dialog-mask").show();
            $("#jfgrid-search-formula").remove();

            $("body").append(jfgrid.replaceHtml(modelHTML, { "id": "jfgrid-search-formula", "addclass": "jfgrid-search-formula", "title": "", "content": "<div class='inpbox'><label for='searchFormulaListInput'>查找函数：</label><input class='formulaInputFocus' id='searchFormulaListInput' placeholder='请输入您要查找的函数名称或函数功能的简要描述' spellcheck='false'/></div><div class='selbox'><label>或选择类别：</label><select id='formulaTypeSelect'><option value='0'>数学</option><option value='1'>统计</option><option value='2'>查找</option><option value='3'>兔表哥</option><option value='4'>数据挖掘</option><option value='5'>数据源</option><option value='6'>日期</option><option value='7'>过滤器</option><option value='8'>财务</option><option value='9'>工程计算</option><option value='10'>逻辑</option><option value='11'>运算符</option><option value='12'>文本</option><option value='13'>转换工具</option><option value='14'>数组</option><option value='-1'>其它</option></select></div><div class='listbox'><label>选择函数：</label><div id='formulaTypeList'></div></div>", "botton": '<button id="jfgrid-search-formula-confirm" class="btn btn-primary">确认</button><button class="btn btn-default jfgrid-model-close-btn">取消</button>', "style": "z-index:100003" }));
            var $t = $("#jfgrid-search-formula").find(".jfgrid-modal-dialog-content").css("min-width", 300).end(), myh = $t.outerHeight(), myw = $t.outerWidth();
            var winw = $(window).width(), winh = $(window).height();
            var scrollLeft = $(document).scrollLeft(), scrollTop = $(document).scrollTop();
            $("#jfgrid-search-formula").css({ "left": (winw + scrollLeft - myw) / 2, "top": (winh + scrollTop - myh) / 3, "user-select": "none" }).show();
            
            jfgrid.insertFormula.formulaListByType("0"); //默认公式列表为类型0
            $("#searchFormulaListInput").focus();
        },
        formulaListByType: function(type){
            $("#formulaTypeList").empty();
                        
            for(var i = 0; i < jfgrid.functionlist.length; i++){
                if((type == "-1" && jfgrid.functionlist[i].t > 14) || jfgrid.functionlist[i].t == type){
                    $('<div class="listBox" name="'+ jfgrid.functionlist[i].n +'"><span>'+ jfgrid.functionlist[i].n +'</span><span>'+ jfgrid.functionlist[i].a +'</span></div>').appendTo($("#formulaTypeList"));
                }
            }

            $("#formulaTypeList .listBox:first-child").addClass("on"); //默认公式列表第一个为选中状态
        },
        formulaParmDialog: function(formula, parm){ //参数弹出框
            var parm_title = '',
                parm_content = '',
                parm_list_content = '';

            for(var i = 0; i < jfgrid.functionlist.length; i++){
                if(jfgrid.functionlist[i].n == formula.toUpperCase()){
                    parm_title = jfgrid.functionlist[i].n;

                    for(var j = 0; j < jfgrid.functionlist[i].p.length; j++){
                        if(parm == null){
                            //无参数
                            parm_list_content += '<div class="parmBox">'+
                                                    '<div class="name">'+ jfgrid.functionlist[i].p[j].name +'</div>'+
                                                    '<div class="txt">'+
                                                        '<input class="formulaInputFocus" spellcheck="false"/>' +
                                                        '<i class="fa fa-table" aria-hidden="true" title="点击选择数据范围"></i>'+
                                                    '</div>'+
                                                    '<div class="val">=</div>'+
                                                 '</div>';
                        }
                        else{
                            //有参数
                            if(parm[j] == null){
                                parm[j] = "";
                            }

                            parm_list_content += '<div class="parmBox">'+
                                                    '<div class="name">'+ jfgrid.functionlist[i].p[j].name +'</div>'+
                                                    '<div class="txt">'+
                                                        '<input class="formulaInputFocus" value="'+ parm[j] +'" spellcheck="false"/>'+
                                                        '<i class="fa fa-table" aria-hidden="true" title="点击选择数据范围"></i>'+
                                                    '</div>'+
                                                    '<div class="val">=</div>'+
                                                 '</div>';
                        }
                    }

                    parm_content =  '<div>'+
                                        '<div class="parmListBox">'+ parm_list_content +'</div>'+
                                        '<div class="formulaDetails">'+ jfgrid.functionlist[i].d +'</div>'+
                                        '<div class="parmDetailsBox"></div>'+
                                        '<div class="result">计算结果 = <span></span></div>'+
                                    '</div>';
                }
            }

            $("#jfgrid-search-formula").hide();
            $("#jfgrid-modal-dialog-mask").hide();
            
            $("#jfgrid-search-formula-parm").remove();
            $("body").append(jfgrid.replaceHtml(modelHTML, { "id": "jfgrid-search-formula-parm", "addclass": "jfgrid-search-formula-parm", "title": parm_title, "content": parm_content, "botton": '<button id="jfgrid-search-formula-parm-confirm" class="btn btn-primary">确认</button><button class="btn btn-default jfgrid-model-close-btn">取消</button>', "style": "z-index:100003" }));
            var $t = $("#jfgrid-search-formula-parm").find(".jfgrid-modal-dialog-content").css("min-width", 300).end(), myh = $t.outerHeight(), myw = $t.outerWidth();
            var winw = $(window).width(), winh = $(window).height();
            var scrollLeft = $(document).scrollLeft(), scrollTop = $(document).scrollTop();
            $("#jfgrid-search-formula-parm").css({ "left": (winw + scrollLeft - myw) / 2, "top": (winh + scrollTop - myh) / 3 }).show();
            
            //参数栏第一个参数聚焦，显示选取虚线框
            $("#jfgrid-search-formula-parm .parmBox:eq(0) input").focus();

            //遍历参数，有参数显示值，无显示空
            $("#jfgrid-search-formula-parm .parmBox").each(function(index,e){
                var parmtxt = $(e).find(".txt input").val();
                
                if(jfgrid.formula.getfunctionParam(parmtxt).fn == null){ //参数不是公式
                    if(jfgrid.formula.iscelldata(parmtxt)){ //参数是选区
                        var txtdata = window.jfgrid_getcelldata(parmtxt).data;

                        if(jfgrid.getObjType(txtdata) == "array"){ //参数为多个单元格选区
                            var txtArr = [];
                            
                            for(var i = 0; i < txtdata.length; i++){
                                for(var j = 0; j < txtdata[i].length; j++){
                                    var cell = txtdata[i][j];

                                    if(cell == null || jfgrid.func_methods.isRealNull(cell.v)){
                                        txtArr.push(null);
                                    }
                                    else{
                                        txtArr.push(cell.v);
                                    }
                                }
                            }

                            $("#jfgrid-search-formula-parm .parmBox").eq(index).find(".val").text(" = {"+ txtArr.join(",") +"}");
                        }
                        else{ //参数为单个单元格选区
                            $("#jfgrid-search-formula-parm .parmBox").eq(index).find(".val").text(" = {"+ txtdata.v +"}");
                        }
                    }
                    else{ //参数不是选区
                        $("#jfgrid-search-formula-parm .parmBox").eq(index).find(".val").text(" = {"+ parmtxt +"}");
                    }
                }
                else{ //参数是公式
                    $("#jfgrid-search-formula-parm .parmBox").eq(index).find(".val").text(" = {"+ eval($.trim(jfgrid.formula.functionParser("=" + parmtxt))) +"}");
                }
            })

            $("#jfgrid-formula-functionrange .jfgrid-formula-functionrange-highlight").remove();                        
            jfgrid.formula.data_parm_index = 0;
            jfgrid.formula.rangestart = true;
        },
        parmTxtShow: function(parmtxt){
            if(jfgrid.formula.getfunctionParam(parmtxt).fn == null){ //参数不是公式
                if(jfgrid.formula.iscelldata(parmtxt)){ //参数是选区
                    var cellrange = jfgrid.formula.getcellrange(parmtxt);
                    var r1 = cellrange.row[0], r2 = cellrange.row[1], c1 = cellrange.column[0], c2 = cellrange.column[1];
                    var row = visibledatarow[r2], row_pre = r1 - 1 == -1 ? 0 : visibledatarow[r1 - 1];
                    var col = visibledatacolumn[c2], col_pre = c1 - 1 == -1 ? 0 : visibledatacolumn[c1 - 1];

                    $("#jfgrid-formula-functionrange-select").css({ "left": col_pre, "width": col - col_pre - 1, "top": row_pre, "height": row - row_pre - 1 }).show();
                    $("#jfgrid-formula-help-c").hide();
                    jfgrid.jfgrid_count_show(col_pre, row_pre, col - col_pre - 1, row - row_pre - 1, cellrange.row, cellrange.column);

                    var txtdata = window.jfgrid_getcelldata(parmtxt).data;
                    if(jfgrid.getObjType(txtdata) == "array"){ //参数为多个单元格选区
                        var txtArr = [];
                        
                        for(var i = 0; i < txtdata.length; i++){
                            for(var j = 0; j < txtdata[i].length; j++){
                                var cell = txtdata[i][j];

                                if(cell == null || jfgrid.func_methods.isRealNull(cell.v)){
                                    txtArr.push(null);
                                }
                                else{
                                    txtArr.push(cell.v);
                                }
                            }
                        }

                        $("#jfgrid-search-formula-parm .parmBox").eq(jfgrid.formula.data_parm_index).find(".val").text(" = {"+ txtArr.join(",") +"}");
                    }
                    else{ //参数为单个单元格选区
                        $("#jfgrid-search-formula-parm .parmBox").eq(jfgrid.formula.data_parm_index).find(".val").text(" = {"+ txtdata.v +"}");
                    }
                }
                else{ //参数不是选区
                    $("#jfgrid-search-formula-parm .parmBox").eq(jfgrid.formula.data_parm_index).find(".val").text(" = {"+ parmtxt +"}");

                    $("#jfgrid-formula-functionrange-select").hide();
                }
            }
            else{   
                //参数是公式
                var txt;
                for(var k = 0; k < jfgrid.formula.getfunctionParam(parmtxt).param.length; k++){
                    if(jfgrid.formula.iscelldata(jfgrid.formula.getfunctionParam(parmtxt).param[k])){
                        txt = jfgrid.formula.getfunctionParam(parmtxt).param[k];
                        break;
                    }
                }

                var cellrange = jfgrid.formula.getcellrange(txt);
                var r1 = cellrange.row[0], r2 = cellrange.row[1], c1 = cellrange.column[0], c2 = cellrange.column[1];
                var row = visibledatarow[r2], row_pre = r1 - 1 == -1 ? 0 : visibledatarow[r1 - 1];
                var col = visibledatacolumn[c2], col_pre = c1 - 1 == -1 ? 0 : visibledatacolumn[c1 - 1];

                $("#jfgrid-formula-functionrange-select").css({ "left": col_pre, "width": col - col_pre - 1, "top": row_pre, "height": row - row_pre - 1 }).show();
                // $("#jfgrid-cols-h-selected").css({ "left": col_pre, "width": col - col_pre - 1, "display": "block", "background-color": "rgba(76, 76, 76, 0.1)" });
                // $("#jfgrid-rows-h-selected").css({ "top": row_pre, "height": row - row_pre - 1, "display": "block", "background-color": "rgba(76, 76, 76, 0.1)" });
                $("#jfgrid-formula-help-c").hide();
                jfgrid.jfgrid_count_show(col_pre, row_pre, col - col_pre - 1, row - row_pre - 1, cellrange.row, cellrange.column);

                $("#jfgrid-search-formula-parm .parmBox").eq(jfgrid.formula.data_parm_index).find(".val").text(" = {"+ eval($.trim(jfgrid.formula.functionParser("=" + parmtxt))) +"}");
            }
        },
        functionStrCompute: function(){
            var isVal = true; //参数不为空
            var parmValArr = []; //参数值集合
            var lvi = -1; //最后一个有值的参数索引

            var formulatxt = $("#jfgrid-search-formula-parm").find(".jfgrid-modal-dialog-title-text").text();
            
            $("#jfgrid-search-formula-parm .parmBox").each(function(i, e){
                var parmtxt = $(e).find(".txt input").val();
                var parmRequire = window.jfgrid_function[formulatxt].p[i].require;

                if(parmtxt == "" && parmRequire == "m"){
                    isVal = false;
                }

                if(parmtxt != ""){
                    lvi = i;
                }
            });

            //单元格显示
            if(lvi == -1){
                var functionHtmlTxt = "=" + $("#jfgrid-search-formula-parm .jfgrid-modal-dialog-title-text").text() + "()"; 
            }
            else if(lvi == 0){
                var functionHtmlTxt = "=" + $("#jfgrid-search-formula-parm .jfgrid-modal-dialog-title-text").text() + "(" + $("#jfgrid-search-formula-parm .parmBox").eq(0).find(".txt input").val() + ")"; 
            }
            else{
                for(var j = 0; j <= lvi; j++){
                    parmValArr.push($("#jfgrid-search-formula-parm .parmBox").eq(j).find(".txt input").val());
                }

                var functionHtmlTxt = "=" + $("#jfgrid-search-formula-parm .jfgrid-modal-dialog-title-text").text() + "(" + parmValArr.join(",") + ")";    
            }

            var function_str = jfgrid.formula.functionHTMLGenerate(functionHtmlTxt);
            $("#jfgrid-rich-text-editor").html(function_str);
            $("#jfgrid-functionbox-cell").html($("#jfgrid-rich-text-editor").html());
            
            if(isVal){ //公式计算
                var fp = $.trim(jfgrid.formula.functionParser($("#jfgrid-rich-text-editor").text()));
                
                var result = null;

                try {
                    result = eval(fp);
                } 
                catch (e) {
                    result = jfgrid.formula.error.n;
                }

                $("#jfgrid-search-formula-parm .result span").text(result);
            }
        }
    }

    //选区下拉
    jfgrid.dropCell = {
        iconHtml: '<div id="jfgrid-dropCell-icon" style="position: absolute;padding: 2px;background-color: #f1f1f1;z-index: 990;cursor: pointer;">'+
                    '<div id="icon_dropCell"></div>'+
                  '</div>',
        typeListHtml: '<div id="jfgrid-dropCell-typeList" class="jfgrid-cols-menu jfgrid-rightgclick-menu jfgrid-mousedown-cancel">'+
                        '<div class="jfgrid-cols-menuitem jfgrid-mousedown-cancel" data-type="0">'+
                            '<div class="jfgrid-cols-menuitem-content jfgrid-mousedown-cancel" style="padding: 3px 2px;">'+
                                '<span style="margin-right:5px;width:13px;display:inline-block;" class="icon jfgrid-mousedown-cancel"></span>复制单元格'+
                            '</div>'+
                        '</div>'+
                        '<div class="jfgrid-cols-menuitem jfgrid-mousedown-cancel" data-type="1">'+
                            '<div class="jfgrid-cols-menuitem-content jfgrid-mousedown-cancel" style="padding: 3px 2px;">'+
                                '<span style="margin-right:5px;width:13px;display:inline-block;" class="icon jfgrid-mousedown-cancel"></span>填充序列'+
                            '</div>'+
                        '</div>'+
                        '<div class="jfgrid-cols-menuitem jfgrid-mousedown-cancel" data-type="2">'+
                            '<div class="jfgrid-cols-menuitem-content jfgrid-mousedown-cancel" style="padding: 3px 2px;">'+
                                '<span style="margin-right:5px;width:13px;display:inline-block;" class="icon jfgrid-mousedown-cancel"></span>仅填充格式'+
                            '</div>'+
                        '</div>'+
                        '<div class="jfgrid-cols-menuitem jfgrid-mousedown-cancel" data-type="3">'+
                            '<div class="jfgrid-cols-menuitem-content jfgrid-mousedown-cancel" style="padding: 3px 2px;">'+
                                '<span style="margin-right:5px;width:13px;display:inline-block;" class="icon jfgrid-mousedown-cancel"></span>不带格式填充'+
                            '</div>'+
                        '</div>'+
                        '<div class="jfgrid-cols-menuitem jfgrid-mousedown-cancel" data-type="4">'+
                            '<div class="jfgrid-cols-menuitem-content jfgrid-mousedown-cancel" style="padding: 3px 2px;">'+
                                '<span style="margin-right:5px;width:13px;display:inline-block;" class="icon jfgrid-mousedown-cancel"></span>以天数填充'+
                            '</div>'+
                        '</div>'+
                        '<div class="jfgrid-cols-menuitem jfgrid-mousedown-cancel" data-type="5">'+
                            '<div class="jfgrid-cols-menuitem-content jfgrid-mousedown-cancel" style="padding: 3px 2px;">'+
                                '<span style="margin-right:5px;width:13px;display:inline-block;" class="icon jfgrid-mousedown-cancel"></span>以工作日填充'+
                            '</div>'+
                        '</div>'+
                        '<div class="jfgrid-cols-menuitem jfgrid-mousedown-cancel" data-type="6">'+
                            '<div class="jfgrid-cols-menuitem-content jfgrid-mousedown-cancel" style="padding: 3px 2px;">'+
                                '<span style="margin-right:5px;width:13px;display:inline-block;" class="icon jfgrid-mousedown-cancel"></span>以月填充'+
                            '</div>'+
                        '</div>'+
                        '<div class="jfgrid-cols-menuitem jfgrid-mousedown-cancel" data-type="7">'+
                            '<div class="jfgrid-cols-menuitem-content jfgrid-mousedown-cancel" style="padding: 3px 2px;">'+
                                '<span style="margin-right:5px;width:13px;display:inline-block;" class="icon jfgrid-mousedown-cancel"></span>以年填充'+
                            '</div>'+
                        '</div>'+
                        '<div class="jfgrid-cols-menuitem jfgrid-mousedown-cancel" data-type="8">'+
                            '<div class="jfgrid-cols-menuitem-content jfgrid-mousedown-cancel" style="padding: 3px 2px;">'+
                                '<span style="margin-right:5px;width:13px;display:inline-block;" class="icon jfgrid-mousedown-cancel"></span>以中文小写数字填充'+
                            '</div>'+
                        '</div>'+
                      '</div>',
        copyRange: {}, //复制范围
        applyRange: {}, //应用范围
        applyType: null, //0复制单元格，1填充序列，2仅填充格式，3不带格式填充，4以天数填充，5以工作日填充，6以月填充，7以年填充，8以中文小写数字序列填充
        direction: null, //down-往下拖拽，right-往右拖拽，up-往上拖拽，left-往左拖拽
        chnNumChar: {"零": 0, "一": 1, "二": 2, "三": 3, "四": 4, "五": 5, "六": 6, "七": 7, "八": 8, "九": 9},
        chnNameValue: {"十": {value: 10, secUnit: false}, "百": {value: 100, secUnit: false}, "千": {value: 1000, secUnit: false}, "万": {value: 10000, secUnit: true}, "亿": {value: 100000000, secUnit: true}},
        ChineseToNumber: function(chnStr){
            var rtn = 0;
            var section = 0;
            var number = 0;
            var secUnit = false;
            var str = chnStr.split("");

            for(var i = 0; i < str.length; i++){
                var num = jfgrid.dropCell.chnNumChar[str[i]];
                if(typeof num != "undefined"){
                    number = num;
                    if(i == str.length - 1){
                        section += number;
                    }
                }
                else{
                    var unit = jfgrid.dropCell.chnNameValue[str[i]].value;
                    secUnit = jfgrid.dropCell.chnNameValue[str[i]].secUnit;
                    if(secUnit){
                        section = (section + number) * unit;
                        rtn += section;
                        section = 0;
                    }
                    else{
                        section += (number * unit);
                    }
                    number = 0;
                }
            }

            return rtn + section;
        },
        chnNumChar2: ["零", "一", "二", "三", "四", "五", "六", "七", "八", "九"],
        chnUnitSection: ["", "万", "亿", "万亿", "亿亿"],
        chnUnitChar: ["", "十", "百", "千"],
        SectionToChinese: function(section){
            var strIns = '', chnStr = '';
            var unitPos = 0;
            var zero = true;

            while(section > 0){
                var v = section % 10;
                if(v == 0){
                    if(!zero){
                        zero = true;
                        chnStr = jfgrid.dropCell.chnNumChar2[v] + chnStr;
                    }
                }
                else{
                    zero = false;
                    strIns = jfgrid.dropCell.chnNumChar2[v];
                    strIns += jfgrid.dropCell.chnUnitChar[unitPos];
                    chnStr = strIns + chnStr;
                }
                unitPos++;
                section = Math.floor(section / 10);
            }

            return chnStr;
        },
        NumberToChinese: function(num){
            var unitPos = 0;
            var strIns = '', chnStr = '';
            var needZero = false;

            if(num == 0){
                return jfgrid.dropCell.chnNumChar2[0];
            }
            while(num > 0){
                var section = num % 10000;
                if(needZero){
                    chnStr = jfgrid.dropCell.chnNumChar2[0] + chnStr;
                }
                strIns = jfgrid.dropCell.SectionToChinese(section);
                strIns += (section != 0) ? jfgrid.dropCell.chnUnitSection[unitPos] : jfgrid.dropCell.chnUnitSection[0];
                chnStr = strIns + chnStr;
                needZero = (section < 1000) && (section > 0);
                num = Math.floor(num / 10000);
                unitPos++;
            }

            return chnStr;
        },
        isChnNumber: function(txt){
            var isChnNumber = true;

            if(txt.length == 1){
                if(txt == "日" || (txt in jfgrid.dropCell.chnNumChar)){
                    isChnNumber = true;
                }
                else{
                    isChnNumber = false;
                }
            }
            else{
                var str = txt.split("");
                for(var i = 0; i < str.length; i++){
                    if(!((str[i] in jfgrid.dropCell.chnNumChar) || (str[i] in jfgrid.dropCell.chnNameValue))){
                        isChnNumber = false;
                        break;
                    }
                }
            }

            return isChnNumber;
        },
        isExtendNumber: function(txt){
            var reg = /[0-9]/;
            if(reg.test(txt.substr(txt.length - 1, 1))){
                var isExtendNumber = true;
            }
            else{
                var isExtendNumber = false;
            }

            if(isExtendNumber){
                var str = txt.split("");
                str.reverse();
                
                var len = 0;
                for(var i = 0; i < str.length; i++){
                    if(!reg.test(str[i])){
                        len = i;
                        break;
                    }
                }

                return [isExtendNumber, txt.substr(0, txt.length - len), txt.substr(txt.length - len, len)];    
            }
            else{
                return [isExtendNumber];
            }
        },
        isChnWeek1: function(txt){
            if(txt.length == 1){
                if(txt == "日" || jfgrid.dropCell.ChineseToNumber(txt) < 7){
                    var isChnWeek1 = true;
                }
                else{
                    var isChnWeek1 = false;    
                }
            }
            else{
                var isChnWeek1 = false;
            }

            return isChnWeek1;
        },
        isChnWeek2: function(txt){
            if(txt.length == 2){
                if(txt == "周一" || txt == "周二" || txt == "周三" || txt == "周四" || txt == "周五" || txt == "周六" || txt == "周日"){
                    var isChnWeek2 = true;
                }
                else{
                    var isChnWeek2 = false;
                }
            }
            else{
                var isChnWeek2 = false;
            }

            return isChnWeek2;
        },
        isChnWeek3: function(txt){
            if(txt.length == 3){
                if(txt == "星期一" || txt == "星期二" || txt == "星期三" || txt == "星期四" || txt == "星期五" || txt == "星期六" || txt == "星期日"){
                    var isChnWeek3 = true;
                }
                else{
                    var isChnWeek3 = false;
                }
            }
            else{
                var isChnWeek3 = false;
            }

            return isChnWeek3;
        },
        createIcon: function(){
            var copy_r = jfgrid.dropCell.copyRange["row"][1], copy_c = jfgrid.dropCell.copyRange["column"][1];
            var apply_r = jfgrid.dropCell.applyRange["row"][1], apply_c = jfgrid.dropCell.applyRange["column"][1];
            if(apply_r >= copy_r && apply_c >= copy_c){
                var row_index = apply_r;
                var col_index = apply_c;
            }
            else{
                var row_index = copy_r;
                var col_index = copy_c;   
            }
            var row = jfgrid.rowLocationByIndex(row_index)[1], row_pre = jfgrid.rowLocationByIndex(row_index)[0];
            var col = jfgrid.colLocationByIndex(col_index)[1], col_pre = jfgrid.colLocationByIndex(col_index)[0];

            $("#jfgrid-dropCell-icon").remove();
            $("#jfgrid-cell-main").append(jfgrid.dropCell.iconHtml);
            // $("body").append(jfgrid.dropCell.iconHtml);

            $("#jfgrid-dropCell-icon").css({"left": col, "top": row});

            //点击icon
            $("#jfgrid-dropCell-icon").mouseover(function(){
                $(this).css("background-color", "#ffe8e8");
            }).mouseleave(function(){
                $(this).css("background-color", "#f1f1f1");
            }).mousedown(function(event){
                $("#jfgrid-dropCell-typeList").remove();
                $("body").append(jfgrid.dropCell.typeListHtml);

                var typeItemHide = jfgrid.dropCell.typeItemHide();
                if(!typeItemHide[0] && !typeItemHide[1] && !typeItemHide[2] && !typeItemHide[3] && !typeItemHide[4] && !typeItemHide[5] && !typeItemHide[6]){
                    $("#jfgrid-dropCell-typeList .jfgrid-cols-menuitem[data-type=1]").hide();
                    $("#jfgrid-dropCell-typeList .jfgrid-cols-menuitem[data-type=4]").hide();
                    $("#jfgrid-dropCell-typeList .jfgrid-cols-menuitem[data-type=5]").hide();
                    $("#jfgrid-dropCell-typeList .jfgrid-cols-menuitem[data-type=6]").hide();
                    $("#jfgrid-dropCell-typeList .jfgrid-cols-menuitem[data-type=7]").hide();
                    $("#jfgrid-dropCell-typeList .jfgrid-cols-menuitem[data-type=8]").hide();
                }

                if(!typeItemHide[2]){
                    $("#jfgrid-dropCell-typeList .jfgrid-cols-menuitem[data-type=4]").hide();
                    $("#jfgrid-dropCell-typeList .jfgrid-cols-menuitem[data-type=5]").hide();
                    $("#jfgrid-dropCell-typeList .jfgrid-cols-menuitem[data-type=6]").hide();
                    $("#jfgrid-dropCell-typeList .jfgrid-cols-menuitem[data-type=7]").hide();
                }

                if(!typeItemHide[3]){
                    $("#jfgrid-dropCell-typeList .jfgrid-cols-menuitem[data-type=8]").hide();
                }
                
                
                var left = $(this).offset().left;
                var top = $(this).offset().top + 25;
                var winH = $(window).height(), winW = $(window).width();
                var menuW = $("#jfgrid-dropCell-typeList").width(), menuH = $("#jfgrid-dropCell-typeList").height();
                if (left + menuW > winW) {
                    left = left - menuW;
                }

                if (top + menuH > winH) {
                    top = top - menuH - 38;
                }

                if (top < 0) {
                    top = 0;
                }

                $("#jfgrid-dropCell-typeList").css({"left": left, "top": top}).show();
                $("#jfgrid-dropCell-icon").mouseleave(function(){ $(this).css("backgroundColor", "#ffe8e8") });


                var type = jfgrid.dropCell.applyType;
                $("#jfgrid-dropCell-typeList .jfgrid-cols-menuitem[data-type="+type+"]").find("span").append('<i class="fa fa-check jfgrid-mousedown-cancel"></i>');                
                event.stopPropagation();
            });
            //点击数据填充类型
            $(document).off("click.dCtypeList").on("click.dCtypeList","#jfgrid-dropCell-typeList .jfgrid-cols-menuitem",function(){
                $("#jfgrid-dropCell-typeList .fa-check").remove();
                $(this).find("span").append('<i class="fa fa-check jfgrid-mousedown-cancel"></i>');

                var type = $(this).attr("data-type");
                jfgrid.dropCell.applyType = type;

                jfgrid.dropCell.update();
                $("#jfgrid-dropCell-typeList").hide();
                $("#jfgrid-dropCell-icon").css("backgroundColor", "#f1f1f1");
                $("#jfgrid-dropCell-icon").mouseleave(function(){ $(this).css("backgroundColor", "#f1f1f1") }); 

                jfgrid.jfcountfunc();
            });
        },
        typeItemHide: function(){
            var copyRange = jfgrid.dropCell.copyRange;
            var str_r = copyRange["row"][0], end_r = copyRange["row"][1];
            var str_c = copyRange["column"][0], end_c = copyRange["column"][1];

            var hasNumber = false, hasExtendNumber = false, hasDate = false, hasChn = false, hasChnWeek1 = false, hasChnWeek2 = false, hasChnWeek3 = false;
            for(var r = str_r; r <= end_r; r++){
                for(var c = str_c; c <= end_c; c++){
                    if(!!jfgrid.flowdata[r][c]){
                        var cell = jfgrid.flowdata[r][c];

                        if(jfgrid.getObjType(cell) == "object" && cell["v"] != null && cell["f"] == null){
                            if(cell["ct"] != null && cell["ct"].t == "n"){
                                hasNumber = true;
                            }
                            else if(cell["ct"] != null && cell["ct"].t == "d"){
                                hasDate = true;
                            }
                            else if(jfgrid.dropCell.isExtendNumber(cell["m"])[0]){
                                hasExtendNumber = true;
                            }
                            else if(jfgrid.dropCell.isChnNumber(cell["m"]) && cell["m"] != "日"){
                                hasChn = true;
                            }
                            else if(cell["m"] == "日"){
                                hasChnWeek1 = true;
                            }
                            else if(jfgrid.dropCell.isChnWeek2(cell["m"])){
                                hasChnWeek2 = true;
                            }
                            else if(jfgrid.dropCell.isChnWeek3(cell["m"])){
                                hasChnWeek3 = true;
                            }
                        }
                    }
                }
            }

            return [hasNumber, hasExtendNumber, hasDate, hasChn, hasChnWeek1, hasChnWeek2, hasChnWeek3];
        }, 
        update: function(){
            var d = jfgrid.editor.deepCopyFlowData(jfgrid.flowdata);
            var file = jfgridfile[jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex)];
            
            var cfg = $.extend(true, {}, config);
            var borderInfoCompute = jfgrid.getBorderInfoCompute();

            var direction = jfgrid.dropCell.direction;
            var type = jfgrid.dropCell.applyType;

            //复制范围
            var copyRange = jfgrid.dropCell.copyRange;
            var copy_str_r = copyRange["row"][0], copy_end_r = copyRange["row"][1];
            var copy_str_c = copyRange["column"][0], copy_end_c = copyRange["column"][1];
            var copyData = jfgrid.dropCell.getCopyData(d, copy_str_r, copy_end_r, copy_str_c, copy_end_c, direction);
            if(direction == "down" || direction == "up"){
                var csLen = copy_end_r - copy_str_r + 1;
            }
            else if(direction == "right" || direction == "left"){
                var csLen = copy_end_c - copy_str_c + 1;
            }

            //应用范围
            var applyRange = jfgrid.dropCell.applyRange;
            var apply_str_r = applyRange["row"][0], apply_end_r = applyRange["row"][1];
            var apply_str_c = applyRange["column"][0], apply_end_c = applyRange["column"][1];

            if(direction == "down" || direction == "up"){
                var asLen = apply_end_r - apply_str_r + 1;

                for(var i = apply_str_c; i <= apply_end_c; i++){
                    var copyD = copyData[i - apply_str_c];
                    
                    var applyData = jfgrid.dropCell.getApplyData(copyD, csLen, asLen);
                    
                    if(direction == "down"){
                        for(var j = apply_str_r; j <= apply_end_r; j++){
                            var cell = applyData[j - apply_str_r];

                            if(cell.f != null){
                                var f = "=" + jfgrid.formula.functionCopy(cell.f, "down", j - apply_str_r + 1);
                                var v = jfgrid.formula.execfunction(f, j, i, true);

                                cell.f = v[2];
                                cell.v = v[1];

                                if(cell.spl != null){
                                    cell.spl = v[3].data;
                                }
                                else{
                                    if(jfgrid.func_methods.isRealNum(cell.v) && !/^\d{6}(18|19|20)?\d{2}(0[1-9]|1[12])(0[1-9]|[12]\d|3[01])\d{3}(\d|X)$/i.test(cell.v)){
                                        if(cell.v == Infinity || cell.v == -Infinity){
                                            cell.m = cell.v.toString();
                                        }
                                        else{
                                            if(cell.v.toString().indexOf("e") > -1){
                                                var len = cell.v.toString().split(".")[1].split("e")[0].length;
                                                if(len > 5){
                                                    len = 5;
                                                }

                                                cell.m = cell.v.toExponential(len).toString();
                                            }
                                            else{
                                                var mask = jfgrid.mask.genarate(Math.round(cell.v * 1000000000) / 1000000000);
                                                cell.m = mask[0].toString();
                                            }
                                        }

                                        cell.ct = { "fa": "General", "t": "n" };
                                    }
                                    else{
                                        var mask = jfgrid.mask.genarate(cell.v);
                                        cell.m = mask[0].toString();
                                        cell.ct = mask[1];
                                    }
                                }
                            }

                            d[j][i] = cell;

                            //边框
                            var bd_r = copy_str_r + (j - apply_str_r) % csLen;
                            var bd_c = i;

                            if(borderInfoCompute[bd_r + "_" + bd_c]){
                                var bd_obj = {
                                    "rangeType": "cell",
                                    "value": {
                                        "row_index": j,
                                        "col_index": i,
                                        "l": borderInfoCompute[bd_r + "_" + bd_c].l,
                                        "r": borderInfoCompute[bd_r + "_" + bd_c].r,
                                        "t": borderInfoCompute[bd_r + "_" + bd_c].t,
                                        "b": borderInfoCompute[bd_r + "_" + bd_c].b
                                    }
                                }

                                cfg["borderInfo"].push(bd_obj);
                            }
                            else if(borderInfoCompute[j + "_" + i]){
                                var bd_obj = {
                                    "rangeType": "cell",
                                    "value": {
                                        "row_index": j,
                                        "col_index": i,
                                        "l": null,
                                        "r": null,
                                        "t": null,
                                        "b": null
                                    }
                                }

                                cfg["borderInfo"].push(bd_obj);
                            }
                        }
                    }
                    if(direction == "up"){
                        for(var j = apply_end_r; j >= apply_str_r; j--){
                            var cell = applyData[apply_end_r - j];

                            if(cell.f != null){
                                var f = "=" + jfgrid.formula.functionCopy(cell.f, "up", apply_end_r - j + 1);
                                var v = jfgrid.formula.execfunction(f, j, i, true);

                                cell.f = v[2];
                                cell.v = v[1];

                                if(cell.spl != null){
                                    cell.spl = v[3].data;
                                }
                                else{
                                    if(jfgrid.func_methods.isRealNum(cell.v) && !/^\d{6}(18|19|20)?\d{2}(0[1-9]|1[12])(0[1-9]|[12]\d|3[01])\d{3}(\d|X)$/i.test(cell.v)){
                                        if(cell.v == Infinity || cell.v == -Infinity){
                                            cell.m = cell.v.toString();
                                        }
                                        else{
                                            if(cell.v.toString().indexOf("e") > -1){
                                                var len = cell.v.toString().split(".")[1].split("e")[0].length;
                                                if(len > 5){
                                                    len = 5;
                                                }

                                                cell.m = cell.v.toExponential(len).toString();
                                            }
                                            else{
                                                var mask = jfgrid.mask.genarate(Math.round(cell.v * 1000000000) / 1000000000);
                                                cell.m = mask[0].toString();
                                            }
                                        }

                                        cell.ct = { "fa": "General", "t": "n" };
                                    }
                                    else{
                                        var mask = jfgrid.mask.genarate(cell.v);
                                        cell.m = mask[0].toString();
                                        cell.ct = mask[1];
                                    }
                                }
                            }

                            d[j][i] = cell;

                            //边框
                            var bd_r = copy_end_r - (apply_end_r - j) % csLen;
                            var bd_c = i;

                            if(borderInfoCompute[bd_r + "_" + bd_c]){
                                var bd_obj = {
                                    "rangeType": "cell",
                                    "value": {
                                        "row_index": j,
                                        "col_index": i,
                                        "l": borderInfoCompute[bd_r + "_" + bd_c].l,
                                        "r": borderInfoCompute[bd_r + "_" + bd_c].r,
                                        "t": borderInfoCompute[bd_r + "_" + bd_c].t,
                                        "b": borderInfoCompute[bd_r + "_" + bd_c].b
                                    }
                                }

                                cfg["borderInfo"].push(bd_obj);
                            }
                            else if(borderInfoCompute[j + "_" + i]){
                                var bd_obj = {
                                    "rangeType": "cell",
                                    "value": {
                                        "row_index": j,
                                        "col_index": i,
                                        "l": null,
                                        "r": null,
                                        "t": null,
                                        "b": null
                                    }
                                }

                                cfg["borderInfo"].push(bd_obj);
                            }
                        }
                    }
                }
            }
            else if(direction == "right" || direction == "left"){
                var asLen = apply_end_c - apply_str_c + 1;

                for(var i = apply_str_r; i <= apply_end_r; i++){
                    var copyD = copyData[i - apply_str_r];
                        
                    var applyData = jfgrid.dropCell.getApplyData(copyD, csLen, asLen);

                    if(direction == "right"){
                        for(var j = apply_str_c; j <= apply_end_c; j++){
                            var cell = applyData[j - apply_str_c];

                            if(cell.f != null){
                                var f = "=" + jfgrid.formula.functionCopy(cell.f, "right", j - apply_str_c + 1);
                                var v = jfgrid.formula.execfunction(f, i, j, true);

                                cell.f = v[2];
                                cell.v = v[1];

                                if(cell.spl != null){
                                    cell.spl = v[3].data;
                                }
                                else{
                                    if(jfgrid.func_methods.isRealNum(cell.v) && !/^\d{6}(18|19|20)?\d{2}(0[1-9]|1[12])(0[1-9]|[12]\d|3[01])\d{3}(\d|X)$/i.test(cell.v)){
                                        if(cell.v == Infinity || cell.v == -Infinity){
                                            cell.m = cell.v.toString();
                                        }
                                        else{
                                            if(cell.v.toString().indexOf("e") > -1){
                                                var len = cell.v.toString().split(".")[1].split("e")[0].length;
                                                if(len > 5){
                                                    len = 5;
                                                }

                                                cell.m = cell.v.toExponential(len).toString();
                                            }
                                            else{
                                                var mask = jfgrid.mask.genarate(Math.round(cell.v * 1000000000) / 1000000000);
                                                cell.m = mask[0].toString();
                                            }
                                        }

                                        cell.ct = { "fa": "General", "t": "n" };
                                    }
                                    else{
                                        var mask = jfgrid.mask.genarate(cell.v);
                                        cell.m = mask[0].toString();
                                        cell.ct = mask[1];
                                    }
                                }
                            }

                            d[i][j] = cell;

                            //边框
                            var bd_r = i;
                            var bd_c = copy_str_c + (j - apply_str_c) % csLen;

                            if(borderInfoCompute[bd_r + "_" + bd_c]){
                                var bd_obj = {
                                    "rangeType": "cell",
                                    "value": {
                                        "row_index": i,
                                        "col_index": j,
                                        "l": borderInfoCompute[bd_r + "_" + bd_c].l,
                                        "r": borderInfoCompute[bd_r + "_" + bd_c].r,
                                        "t": borderInfoCompute[bd_r + "_" + bd_c].t,
                                        "b": borderInfoCompute[bd_r + "_" + bd_c].b
                                    }
                                }

                                cfg["borderInfo"].push(bd_obj);
                            }
                            else if(borderInfoCompute[i + "_" + j]){
                                var bd_obj = {
                                    "rangeType": "cell",
                                    "value": {
                                        "row_index": i,
                                        "col_index": j,
                                        "l": null,
                                        "r": null,
                                        "t": null,
                                        "b": null
                                    }
                                }

                                cfg["borderInfo"].push(bd_obj);
                            }
                        }
                    }
                    if(direction == "left"){
                        for(var j = apply_end_c; j >= apply_str_c; j--){
                            var cell = applyData[apply_end_c - j];

                            if(cell.f != null){
                                var f = "=" + jfgrid.formula.functionCopy(cell.f, "left", apply_end_c - j + 1);
                                var v = jfgrid.formula.execfunction(f, i, j, true);

                                cell.f = v[2];
                                cell.v = v[1];

                                if(cell.spl != null){
                                    cell.spl = v[3].data;
                                }
                                else{
                                    if(jfgrid.func_methods.isRealNum(cell.v) && !/^\d{6}(18|19|20)?\d{2}(0[1-9]|1[12])(0[1-9]|[12]\d|3[01])\d{3}(\d|X)$/i.test(cell.v)){
                                        if(cell.v == Infinity || cell.v == -Infinity){
                                            cell.m = cell.v.toString();
                                        }
                                        else{
                                            if(cell.v.toString().indexOf("e") > -1){
                                                var len = cell.v.toString().split(".")[1].split("e")[0].length;
                                                if(len > 5){
                                                    len = 5;
                                                }

                                                cell.m = cell.v.toExponential(len).toString();
                                            }
                                            else{
                                                var mask = jfgrid.mask.genarate(Math.round(cell.v * 1000000000) / 1000000000);
                                                cell.m = mask[0].toString();
                                            }
                                        }

                                        cell.ct = { "fa": "General", "t": "n" };
                                    }
                                    else{
                                        var mask = jfgrid.mask.genarate(cell.v);
                                        cell.m = mask[0].toString();
                                        cell.ct = mask[1];
                                    }
                                }
                            }

                            d[i][j] = cell;

                            //边框
                            var bd_r = i;
                            var bd_c = copy_end_c - (apply_end_c - j) % csLen;

                            if(borderInfoCompute[bd_r + "_" + bd_c]){
                                var bd_obj = {
                                    "rangeType": "cell",
                                    "value": {
                                        "row_index": i,
                                        "col_index": j,
                                        "l": borderInfoCompute[bd_r + "_" + bd_c].l,
                                        "r": borderInfoCompute[bd_r + "_" + bd_c].r,
                                        "t": borderInfoCompute[bd_r + "_" + bd_c].t,
                                        "b": borderInfoCompute[bd_r + "_" + bd_c].b
                                    }
                                }

                                cfg["borderInfo"].push(bd_obj);
                            }
                            else if(borderInfoCompute[i + "_" + j]){
                                var bd_obj = {
                                    "rangeType": "cell",
                                    "value": {
                                        "row_index": i,
                                        "col_index": j,
                                        "l": null,
                                        "r": null,
                                        "t": null,
                                        "b": null
                                    }
                                }

                                cfg["borderInfo"].push(bd_obj);
                            }
                        }
                    }
                }
            }

            //条件格式
            var cdformat = $.extend(true, [], file["jfgrid_conditionformat_save"]);
            if(cdformat != null && cdformat.length > 0){
                for(var i = 0; i < cdformat.length; i++){
                    var cdformat_cellrange = cdformat[i].cellrange;

                    var emptyRange = [];

                    for(var j = 0; j < cdformat_cellrange.length; j++){
                        var range = jfgrid.conditionformat.CFSplitRange(cdformat_cellrange[j], {"row": copyRange["row"], "column": copyRange["column"]}, {"row": applyRange["row"], "column": applyRange["column"]}, "operatePart");
                        if(range.length > 0){
                            emptyRange = emptyRange.concat(range);
                        }
                    }

                    if(emptyRange.length > 0){
                        cdformat[i].cellrange.push(applyRange);
                    }
                }
            }

            //刷新一次表格
            jfgrid.jfrefreshgrid(d, jfgird_select_save, cfg, cdformat);

            jfgrid.selectHightlightShow();
        },
        getCopyData: function(d, r1, r2, c1, c2, direction){
            var copyData = [];

            if(direction == "down" || direction == "up"){
                var a1 = c1, a2 = c2, b1 = r1, b2 = r2;
            }
            else if(direction == "right" || direction == "left"){
                var a1 = r1, a2 = r2, b1 = c1, b2 = c2;
            }

            for(var a = a1; a <= a2; a++){
                var obj = {};

                var arrData = [];
                var arrIndex = [];
                var text = "";
                var extendNumberStr = null;
                var isSameStr = true;

                for(var b = b1; b <= b2; b++){
                    //单元格
                    if(direction == "down" || direction == "up"){
                        var data = d[b][a];
                    }
                    else if(direction == "right" || direction == "left"){
                        var data = d[a][b];
                    }
                    //单元格值类型
                    if(!!data && !!data["v"] && data["f"] == null){
                        if(!!data["ct"] && data["ct"]["t"] == "n"){
                            var str = "number";
                            extendNumberStr = null;
                        }
                        else if(!!data["ct"] && data["ct"]["t"] == "d"){
                            var str = "date";
                            extendNumberStr = null;
                        }
                        else if(jfgrid.dropCell.isExtendNumber(data["m"])[0]){
                            var str = "extendNumber";
                            
                            if(extendNumberStr == null){
                                isSameStr = true;
                                extendNumberStr = jfgrid.dropCell.isExtendNumber(data["m"])[1];
                            }
                            else{
                                if(jfgrid.dropCell.isExtendNumber(data["m"])[1] != extendNumberStr){
                                    isSameStr = false;
                                    extendNumberStr = jfgrid.dropCell.isExtendNumber(data["m"])[1];
                                }
                                else{
                                    isSameStr = true;
                                }
                            }
                        }
                        else if(jfgrid.dropCell.isChnNumber(data["m"])){
                            var str = "chnNumber";
                            extendNumberStr = null;
                        }
                        else if(jfgrid.dropCell.isChnWeek2(data["m"])){
                            var str = "chnWeek2";
                            extendNumberStr = null;
                        }
                        else if(jfgrid.dropCell.isChnWeek3(data["m"])){
                            var str = "chnWeek3";
                            extendNumberStr = null;
                        }
                        else{
                            var str = "other";
                            extendNumberStr = null;
                        }
                    }
                    else{
                        var str = "other";
                        extendNumberStr = null;
                    }
                    //
                    if(str == "extendNumber"){
                        if(b == b1){
                            if(b1 == b2){
                                text = str;
                                arrData.push(data);
                                arrIndex.push(b - b1 + 1);

                                obj[text] = [];
                                obj[text].push({"data": arrData, "index": arrIndex});
                            }
                            else{
                                text = str;
                                arrData.push(data);
                                arrIndex.push(b - b1 + 1);
                            }
                        }
                        else if(b == b2){
                            if(text == str && isSameStr){
                                arrData.push(data);
                                arrIndex.push(b - b1 + 1);
                                if(text in obj){
                                    obj[text].push({"data": arrData, "index": arrIndex});
                                }
                                else{
                                    obj[text] = [];
                                    obj[text].push({"data": arrData, "index": arrIndex});
                                }
                            }
                            else{
                                if(text in obj){
                                    obj[text].push({"data": arrData, "index": arrIndex});
                                }
                                else{
                                    obj[text] = [];
                                    obj[text].push({"data": arrData, "index": arrIndex});
                                }

                                text = str;
                                arrData = [];
                                arrData.push(data);
                                arrIndex = [];
                                arrIndex.push(b - b1 + 1);

                                if(text in obj){
                                    obj[text].push({"data": arrData, "index": arrIndex});
                                }
                                else{
                                    obj[text] = [];
                                    obj[text].push({"data": arrData, "index": arrIndex});
                                }
                            }
                        }
                        else{
                            if(text == str && isSameStr){
                                arrData.push(data);
                                arrIndex.push(b - b1 + 1);
                            }
                            else{
                                if(text in obj){
                                    obj[text].push({"data": arrData, "index": arrIndex});
                                }
                                else{
                                    obj[text] = [];
                                    obj[text].push({"data": arrData, "index": arrIndex});
                                }
                                text = str;
                                arrData = [];
                                arrData.push(data);
                                arrIndex = [];
                                arrIndex.push(b - b1 + 1); 
                            }
                        }
                    }
                    else{
                        if(b == b1){
                            if(b1 == b2){
                                text = str;
                                arrData.push(data);
                                arrIndex.push(b - b1 + 1);

                                obj[text] = [];
                                obj[text].push({"data": arrData, "index": arrIndex});
                            }
                            else{
                                text = str;
                                arrData.push(data);
                                arrIndex.push(b - b1 + 1);
                            }
                        }
                        else if(b == b2){
                            if(text == str){
                                arrData.push(data);
                                arrIndex.push(b - b1 + 1);
                                if(text in obj){
                                    obj[text].push({"data": arrData, "index": arrIndex});
                                }
                                else{
                                    obj[text] = [];
                                    obj[text].push({"data": arrData, "index": arrIndex});
                                }
                            }
                            else{
                                if(text in obj){
                                    obj[text].push({"data": arrData, "index": arrIndex});
                                }
                                else{
                                    obj[text] = [];
                                    obj[text].push({"data": arrData, "index": arrIndex});
                                }

                                text = str;
                                arrData = [];
                                arrData.push(data);
                                arrIndex = [];
                                arrIndex.push(b - b1 + 1);

                                if(text in obj){
                                    obj[text].push({"data": arrData, "index": arrIndex});
                                }
                                else{
                                    obj[text] = [];
                                    obj[text].push({"data": arrData, "index": arrIndex});
                                }
                            }
                        }
                        else{
                            if(text == str){
                                arrData.push(data);
                                arrIndex.push(b - b1 + 1);
                            }
                            else{
                                if(text in obj){
                                    obj[text].push({"data": arrData, "index": arrIndex});
                                }
                                else{
                                    obj[text] = [];
                                    obj[text].push({"data": arrData, "index": arrIndex});
                                }
                                text = str;
                                arrData = [];
                                arrData.push(data);
                                arrIndex = [];
                                arrIndex.push(b - b1 + 1); 
                            }
                        }
                    }
                }

                copyData.push(obj);
            }

            return copyData;
        },
        getApplyData: function(copyD, csLen, asLen){
            var applyData = [];

            var direction = jfgrid.dropCell.direction;
            var type = jfgrid.dropCell.applyType;

            var num = Math.floor(asLen / csLen);
            var rsd = asLen % csLen;

            //纯数字类型
            var copyD_number = copyD["number"];
            var applyD_number = [];
            if(!!copyD_number){
                for(var i = 0; i < copyD_number.length; i++){
                    var s = jfgrid.dropCell.getLenS(copyD_number[i]["index"], rsd);
                    var len = copyD_number[i]["index"].length * num + s;
                    if(type == "1" || type == "3"){
                        var arrData = jfgrid.dropCell.getDataByType(copyD_number[i]["data"], len, direction, type, "number");
                    }
                    else if(type == "2"){
                        var arrData = jfgrid.dropCell.getDataByType(copyD_number[i]["data"], len, direction, type);
                    }
                    else{
                        var arrData = jfgrid.dropCell.getDataByType(copyD_number[i]["data"], len, direction, "0");
                    }
                    var arrIndex = jfgrid.dropCell.getDataIndex(csLen, asLen, copyD_number[i]["index"]);
                    applyD_number.push({"data": arrData, "index": arrIndex}); 
                }    
            }
            //扩展数字型（即一串字符最后面的是数字）
            var copyD_extendNumber = copyD["extendNumber"];
            var applyD_extendNumber = [];
            if(!!copyD_extendNumber){
                for(var i = 0; i < copyD_extendNumber.length; i++){
                    var s = jfgrid.dropCell.getLenS(copyD_extendNumber[i]["index"], rsd);
                    var len = copyD_extendNumber[i]["index"].length * num + s;
                    if(type == "1" || type == "3"){
                        var arrData = jfgrid.dropCell.getDataByType(copyD_extendNumber[i]["data"], len, direction, type, "extendNumber");
                    }
                    else if(type == "2"){
                        var arrData = jfgrid.dropCell.getDataByType(copyD_extendNumber[i]["data"], len, direction, type);
                    }
                    else{
                        var arrData = jfgrid.dropCell.getDataByType(copyD_extendNumber[i]["data"], len, direction, "0");
                    }
                    var arrIndex = jfgrid.dropCell.getDataIndex(csLen, asLen, copyD_extendNumber[i]["index"]);
                    applyD_extendNumber.push({"data": arrData, "index": arrIndex}); 
                }    
            }
            //日期类型
            var copyD_date = copyD["date"];
            var applyD_date = [];
            if(!!copyD_date){
                for(var i = 0; i < copyD_date.length; i++){
                    var s = jfgrid.dropCell.getLenS(copyD_date[i]["index"], rsd);
                    var len = copyD_date[i]["index"].length * num + s;
                    if(type == "1" || type == "3"){
                        var arrData = jfgrid.dropCell.getDataByType(copyD_date[i]["data"], len, direction, type, "date");
                    }
                    else if(type == "8"){
                        var arrData = jfgrid.dropCell.getDataByType(copyD_date[i]["data"], len, direction, "0");
                    }
                    else{
                        var arrData = jfgrid.dropCell.getDataByType(copyD_date[i]["data"], len, direction, type);
                    }
                    var arrIndex = jfgrid.dropCell.getDataIndex(csLen, asLen, copyD_date[i]["index"]);
                    applyD_date.push({"data": arrData, "index": arrIndex}); 
                }    
            }
            //中文小写数字 或 一~日
            var copyD_chnNumber = copyD["chnNumber"];
            var applyD_chnNumber = [];
            if(!!copyD_chnNumber){
                for(var i = 0; i < copyD_chnNumber.length; i++){
                    var s = jfgrid.dropCell.getLenS(copyD_chnNumber[i]["index"], rsd);
                    var len = copyD_chnNumber[i]["index"].length * num + s;
                    if(type == "1" || type == "3"){
                        var arrData = jfgrid.dropCell.getDataByType(copyD_chnNumber[i]["data"], len, direction, type, "chnNumber");
                    }
                    else if(type == "2" || type == "8"){
                        var arrData = jfgrid.dropCell.getDataByType(copyD_chnNumber[i]["data"], len, direction, type);
                    }
                    else{
                        var arrData = jfgrid.dropCell.getDataByType(copyD_chnNumber[i]["data"], len, direction, "0");
                    }
                    var arrIndex = jfgrid.dropCell.getDataIndex(csLen, asLen, copyD_chnNumber[i]["index"]);
                    applyD_chnNumber.push({"data": arrData, "index": arrIndex}); 
                }    
            }
            //周一~周日
            var copyD_chnWeek2 = copyD["chnWeek2"];
            var applyD_chnWeek2 = [];
            if(!!copyD_chnWeek2){
                for(var i = 0; i < copyD_chnWeek2.length; i++){
                    var s = jfgrid.dropCell.getLenS(copyD_chnWeek2[i]["index"], rsd);
                    var len = copyD_chnWeek2[i]["index"].length * num + s;
                    if(type == "1" || type == "3"){
                        var arrData = jfgrid.dropCell.getDataByType(copyD_chnWeek2[i]["data"], len, direction, type, "chnWeek2");
                    }
                    else if(type == "2"){
                        var arrData = jfgrid.dropCell.getDataByType(copyD_chnWeek2[i]["data"], len, direction, type);
                    }
                    else{
                        var arrData = jfgrid.dropCell.getDataByType(copyD_chnWeek2[i]["data"], len, direction, "0");
                    }
                    var arrIndex = jfgrid.dropCell.getDataIndex(csLen, asLen, copyD_chnWeek2[i]["index"]);
                    applyD_chnWeek2.push({"data": arrData, "index": arrIndex}); 
                }    
            }
            //星期一~星期日
            var copyD_chnWeek3 = copyD["chnWeek3"];
            var applyD_chnWeek3 = [];
            if(!!copyD_chnWeek3){
                for(var i = 0; i < copyD_chnWeek3.length; i++){
                    var s = jfgrid.dropCell.getLenS(copyD_chnWeek3[i]["index"], rsd);
                    var len = copyD_chnWeek3[i]["index"].length * num + s;
                    if(type == "1" || type == "3"){
                        var arrData = jfgrid.dropCell.getDataByType(copyD_chnWeek3[i]["data"], len, direction, type, "chnWeek3");
                    }
                    else if(type == "2"){
                        var arrData = jfgrid.dropCell.getDataByType(copyD_chnWeek3[i]["data"], len, direction, type);
                    }
                    else{
                        var arrData = jfgrid.dropCell.getDataByType(copyD_chnWeek3[i]["data"], len, direction, "0");
                    }
                    var arrIndex = jfgrid.dropCell.getDataIndex(csLen, asLen, copyD_chnWeek3[i]["index"]);
                    applyD_chnWeek3.push({"data": arrData, "index": arrIndex}); 
                }    
            }
            //其它
            var copyD_other = copyD["other"];
            var applyD_other = [];
            if(!!copyD_other){
                for(var i = 0; i < copyD_other.length; i++){
                    var s = jfgrid.dropCell.getLenS(copyD_other[i]["index"], rsd);
                    var len = copyD_other[i]["index"].length * num + s;
                    if(type == "2" || type == "3"){
                        var arrData = jfgrid.dropCell.getDataByType(copyD_other[i]["data"], len, direction, type);
                    }
                    else{
                        var arrData = jfgrid.dropCell.getDataByType(copyD_other[i]["data"], len, direction, "0");
                    }
                    var arrIndex = jfgrid.dropCell.getDataIndex(csLen, asLen, copyD_other[i]["index"]);
                    applyD_other.push({"data": arrData, "index": arrIndex}); 
                }    
            }
            //
            for(var x = 1; x <= asLen; x++){
                if(applyD_number.length > 0){
                    for(var y = 0; y < applyD_number.length; y++){
                        if(x in applyD_number[y]["index"]){
                            applyData.push(applyD_number[y]["data"][applyD_number[y]["index"][x]]);
                        }
                    }
                }
                if(applyD_extendNumber.length > 0){
                    for(var y = 0; y < applyD_extendNumber.length; y++){
                        if(x in applyD_extendNumber[y]["index"]){
                            applyData.push(applyD_extendNumber[y]["data"][applyD_extendNumber[y]["index"][x]]);
                        }
                    }
                }
                if(applyD_date.length > 0){
                    for(var y = 0; y < applyD_date.length; y++){
                        if(x in applyD_date[y]["index"]){
                            applyData.push(applyD_date[y]["data"][applyD_date[y]["index"][x]]);
                        }
                    }
                }
                if(applyD_chnNumber.length > 0){
                    for(var y = 0; y < applyD_chnNumber.length; y++){
                        if(x in applyD_chnNumber[y]["index"]){
                            applyData.push(applyD_chnNumber[y]["data"][applyD_chnNumber[y]["index"][x]]);
                        }
                    }
                }
                if(applyD_chnWeek2.length > 0){
                    for(var y = 0; y < applyD_chnWeek2.length; y++){
                        if(x in applyD_chnWeek2[y]["index"]){
                            applyData.push(applyD_chnWeek2[y]["data"][applyD_chnWeek2[y]["index"][x]]);
                        }
                    }
                }
                if(applyD_chnWeek3.length > 0){
                    for(var y = 0; y < applyD_chnWeek3.length; y++){
                        if(x in applyD_chnWeek3[y]["index"]){
                            applyData.push(applyD_chnWeek3[y]["data"][applyD_chnWeek3[y]["index"][x]]);
                        }
                    }
                }
                if(applyD_other.length > 0){
                    for(var y = 0; y < applyD_other.length; y++){
                        if(x in applyD_other[y]["index"]){
                            applyData.push(applyD_other[y]["data"][applyD_other[y]["index"][x]]);
                        }
                    }
                }
            }

            return applyData;
        },
        getLenS: function(indexArr, rsd){
            var s = 0;
            for(var j = 0; j < indexArr.length; j++){
                if(indexArr[j] <= rsd){
                    s++; 
                }
                else{
                    break;
                }
            }
            return s;
        },
        getDataIndex: function(csLen, asLen, indexArr){
            var obj = {};

            var num = Math.floor(asLen / csLen);
            var rsd = asLen % csLen;

            var sum = 0;
            if(num > 0){
                for(var i = 1; i <= num; i++){
                    for(var j = 0; j < indexArr.length; j++){
                        obj[indexArr[j] + (i - 1) * csLen] = sum;
                        sum++;
                    }
                }
                for(var a = 0; a < indexArr.length; a++){
                    if(indexArr[a] <= rsd){
                        obj[indexArr[a] + csLen * num] = sum;
                        sum++;
                    }
                    else{
                        break;
                    }
                }
            }
            else{
                for(var a = 0; a < indexArr.length; a++){
                    if(indexArr[a] <= rsd){
                        obj[indexArr[a]] = sum;
                        sum++;
                    }
                    else{
                        break;
                    }
                }
            }

            return obj;
        },
        getDataByType: function(data, len, direction, type ,dataType){
            var applyData = [];

            if(type == "0"){ //复制单元格
                if(direction == "up" || direction == "left"){
                    data.reverse();
                }
                applyData = jfgrid.dropCell.FillCopy(data, len); 
            }
            else if(type == "1"){ //填充序列
                if(dataType == "number"){
                    //数据类型是 数字 
                    applyData = jfgrid.dropCell.FillSeries(data, len, direction);
                }
                else if(dataType == "extendNumber"){
                    //扩展数字（一串字符最后面的是数字）
                    if(data.length == 1){
                        if(direction == "down" || direction == "right"){
                            var step = 1;
                        }
                        else if(direction == "up" || direction == "left"){
                            var step = -1;
                        }
                        applyData = jfgrid.dropCell.FillExtendNumber(data, len, step);
                    }
                    else{
                        var dataNumArr = [];
                        for(var i = 0; i < data.length; i++){
                            var txt = data[i]["m"];
                            dataNumArr.push(Number(jfgrid.dropCell.isExtendNumber(txt)[2]));
                        }

                        if(direction == "up" || direction == "left"){
                            data.reverse();
                            dataNumArr.reverse();
                        }

                        if(jfgrid.dropCell.isEqualDiff(dataNumArr)){
                            //等差数列，以等差为step
                            var step = dataNumArr[1] - dataNumArr[0];
                            applyData = jfgrid.dropCell.FillExtendNumber(data, len, step);
                        }
                        else{
                            //不是等差数列，复制数据
                            applyData = jfgrid.dropCell.FillCopy(data, len);
                        }
                    }
                }
                else if(dataType == "date"){ 
                    //数据类型是 日期
                    if(data.length == 1){
                        //以一天为step
                        if(direction == "down" || direction == "right"){
                            var step = 1;
                        }
                        else if(direction == "up" || direction == "left"){
                            var step = -1;
                        }
                        applyData = jfgrid.dropCell.FillDays(data, len, step);
                    }
                    else{
                        if(direction == "up" || direction == "left"){
                            data.reverse();
                        }

                        var judgeDate = jfgrid.dropCell.judgeDate(data);
                        if(judgeDate[0] && judgeDate[3]){
                            //日一样，月差为等差数列，以月差为step
                            var step = moment(data[1]["m"]).diff(moment(data[0]["m"]), "months");
                            applyData = jfgrid.dropCell.FillMonths(data, len, step);
                        }
                        else if(!judgeDate[0] && judgeDate[2]){
                            //日不一样，日差为等差数列，以日差为step
                            var step = moment(data[1]["m"]).diff(moment(data[0]["m"]), "days");
                            applyData = jfgrid.dropCell.FillDays(data, len, step);
                        }
                        else{
                            //其它，复制数据
                            applyData = jfgrid.dropCell.FillCopy(data, len);
                        }   
                    }
                }
                else if(dataType == "chnNumber"){
                    //数据类型是 中文小写数字
                    if(data.length == 1){
                        if(data[0]["m"] == "日" || jfgrid.dropCell.ChineseToNumber(data[0]["m"]) < 7){
                            //数字小于7，以周一~周日序列填充
                            if(direction == "down" || direction == "right"){
                                var step = 1;
                            }
                            else if(direction == "up" || direction == "left"){
                                var step = -1;
                            }
                            applyData = jfgrid.dropCell.FillChnWeek(data, len, step);
                        }
                        else{
                            //数字大于7，以中文小写数字序列填充
                            if(direction == "down" || direction == "right"){
                                var step = 1;
                            }
                            else if(direction == "up" || direction == "left"){
                                var step = -1;
                            }
                            applyData = jfgrid.dropCell.FillChnNumber(data, len, step);
                        }
                    }
                    else{
                        var hasweek = false;
                        for(var i = 0; i < data.length; i++){
                            if(data[i]["m"] == "日"){
                                hasweek = true;
                                break;
                            }
                        }

                        var dataNumArr = [];
                        var weekIndex = 0;
                        for(var i = 0; i < data.length; i++){
                            if(data[i]["m"] == "日"){
                                if(i == 0){
                                    dataNumArr.push(0);
                                }
                                else{
                                    weekIndex++;
                                    dataNumArr.push(weekIndex * 7);
                                }
                            }
                            else if(hasweek && jfgrid.dropCell.ChineseToNumber(data[i]["m"]) > 0 && jfgrid.dropCell.ChineseToNumber(data[i]["m"]) < 7){
                                dataNumArr.push(jfgrid.dropCell.ChineseToNumber(data[i]["m"]) + weekIndex * 7);
                            }
                            else{
                                dataNumArr.push(jfgrid.dropCell.ChineseToNumber(data[i]["m"]));
                            }
                        }

                        if(direction == "up" || direction == "left"){
                            data.reverse();
                            dataNumArr.reverse();
                        }

                        if(jfgrid.dropCell.isEqualDiff(dataNumArr)){
                            if(hasweek || (dataNumArr[dataNumArr.length - 1] < 6 && dataNumArr[0] > 0) || (dataNumArr[0] < 6 && dataNumArr[dataNumArr.length - 1] > 0)){
                                //以周一~周日序列填充
                                var step = dataNumArr[1] - dataNumArr[0];
                                applyData = jfgrid.dropCell.FillChnWeek(data, len, step);
                            }
                            else{
                                //以中文小写数字序列填充
                                var step = dataNumArr[1] - dataNumArr[0];
                                applyData = jfgrid.dropCell.FillChnNumber(data, len, step);
                            }
                        }
                        else{
                            //不是等差数列，复制数据
                            applyData = jfgrid.dropCell.FillCopy(data, len);
                        }
                    }
                }
                else if(dataType == "chnWeek2"){
                    //周一~周日
                    if(data.length == 1){
                        if(direction == "down" || direction == "right"){
                            var step = 1;
                        }
                        else if(direction == "up" || direction == "left"){
                            var step = -1;
                        }
                        applyData = jfgrid.dropCell.FillChnWeek2(data, len, step);
                    }
                    else{
                        var dataNumArr = [];
                        var weekIndex = 0;

                        for(var i = 0; i < data.length; i++){
                            var lastTxt = data[i]["m"].substr(data[i]["m"].length - 1, 1);
                            if(data[i]["m"] == "周日"){
                                if(i == 0){
                                    dataNumArr.push(0);
                                }
                                else{
                                    weekIndex++;
                                    dataNumArr.push(weekIndex * 7);
                                }
                            }
                            else{
                                dataNumArr.push(jfgrid.dropCell.ChineseToNumber(lastTxt) + weekIndex * 7);
                            }
                        }

                        if(direction == "up" || direction == "left"){
                            data.reverse();
                            dataNumArr.reverse();
                        }

                        if(jfgrid.dropCell.isEqualDiff(dataNumArr)){
                            //等差数列，以等差为step
                            var step = dataNumArr[1] - dataNumArr[0];
                            applyData = jfgrid.dropCell.FillChnWeek2(data, len, step);
                        }
                        else{
                            //不是等差数列，复制数据
                            applyData = jfgrid.dropCell.FillCopy(data, len);
                        }
                    }
                }
                else if(dataType == "chnWeek3"){
                    //星期一~星期日
                    if(data.length == 1){
                        if(direction == "down" || direction == "right"){
                            var step = 1;
                        }
                        else if(direction == "up" || direction == "left"){
                            var step = -1;
                        }
                        applyData = jfgrid.dropCell.FillChnWeek3(data, len, step);
                    }
                    else{
                        var dataNumArr = [];
                        var weekIndex = 0;

                        for(var i = 0; i < data.length; i++){
                            var lastTxt = data[i]["m"].substr(data[i]["m"].length - 1, 1);
                            if(data[i]["m"] == "星期日"){
                                if(i == 0){
                                    dataNumArr.push(0);
                                }
                                else{
                                    weekIndex++;
                                    dataNumArr.push(weekIndex * 7);
                                }
                            }
                            else{
                                dataNumArr.push(jfgrid.dropCell.ChineseToNumber(lastTxt) + weekIndex * 7);
                            }
                        }

                        if(direction == "up" || direction == "left"){
                            data.reverse();
                            dataNumArr.reverse();
                        }

                        if(jfgrid.dropCell.isEqualDiff(dataNumArr)){
                            //等差数列，以等差为step
                            var step = dataNumArr[1] - dataNumArr[0];
                            applyData = jfgrid.dropCell.FillChnWeek3(data, len, step);
                        }
                        else{
                            //不是等差数列，复制数据
                            applyData = jfgrid.dropCell.FillCopy(data, len);
                        }
                    }
                }
                else{
                    //数据类型是 其它
                    if(direction == "up" || direction == "left"){
                        data.reverse();
                    }
                    applyData = jfgrid.dropCell.FillCopy(data, len);
                }
            }
            else if(type == "2"){ //仅填充格式
                if(direction == "up" || direction == "left"){
                    data.reverse();
                }
                applyData = jfgrid.dropCell.FillOnlyFormat(data, len);
            }
            else if(type == "3"){ //不带格式填充
                var dataArr = jfgrid.dropCell.getDataByType(data, len, direction, "1" ,dataType);
                applyData = jfgrid.dropCell.FillWithoutFormat(dataArr);
            }
            else if(type == "4"){ //以天数填充
                if(data.length == 1){
                    //以一天为step
                    if(direction == "down" || direction == "right"){
                        var step = 1;
                    }
                    else if(direction == "up" || direction == "left"){
                        var step = -1;
                    }
                    applyData = jfgrid.dropCell.FillDays(data, len, step);
                }
                else if(data.length == 2){
                    //以日差为step
                    if(direction == "up" || direction == "left"){
                        data.reverse();
                    }
                    var step = moment(data[1]["m"]).diff(moment(data[0]["m"]), "days");
                    applyData = jfgrid.dropCell.FillDays(data, len, step);
                }
                else{
                    if(direction == "up" || direction == "left"){
                        data.reverse();
                    }

                    var judgeDate = jfgrid.dropCell.judgeDate(data);
                    if(judgeDate[0] && judgeDate[3]){
                        //日一样，且月差为等差数列，以月差为step
                        var step = moment(data[1]["m"]).diff(moment(data[0]["m"]), "months");
                        applyData = jfgrid.dropCell.FillMonths(data, len, step);
                    }
                    else if(!judgeDate[0] && judgeDate[2]){
                        //日不一样，且日差为等差数列，以日差为step
                        var step = moment(data[1]["m"]).diff(moment(data[0]["m"]), "days");
                        applyData = jfgrid.dropCell.FillDays(data, len, step);
                    }
                    else{
                        //日差不是等差数列，复制数据
                        applyData = jfgrid.dropCell.FillCopy(data, len);
                    }
                }
            }
            else if(type == "5"){ //以工作日填充
                if(data.length == 1){
                    //以一天为step（若那天为休息日，则跳过）
                    if(direction == "down" || direction == "right"){
                        var step = 1;
                    }
                    else if(direction == "up" || direction == "left"){
                        var step = -1;
                    }

                    var newLen = Math.round(len * 1.5);
                    for(var i = 1; i <= newLen; i++){
                        var d = $.extend(true, {}, data[0]);

                        var day = moment(d["m"]).add(i, "days").day();
                        if(day == 0 || day == 6){
                            continue;
                        }

                        var date = moment(d["m"]).add(step * i, "days").format("YYYY-MM-DD");
                        d["m"] = date;
                        d["v"] = jfgrid.mask.genarate(date)[2];
                        applyData.push(d);

                        if(applyData.length == len){
                            break;
                        }
                    }
                }
                else if(data.length == 2){
                    if(moment(data[1]["m"]).date() == moment(data[0]["m"]).date() && moment(data[1]["m"]).diff(moment(data[0]["m"]), "months") != 0){
                        //日一样，且月差大于一月，以月差为step（若那天为休息日，则向前取最近的工作日）
                        if(direction == "up" || direction == "left"){
                            data.reverse();
                        }
                        var step = moment(data[1]["m"]).diff(moment(data[0]["m"]), "months");

                        for(var i = 1; i <= len; i++){
                            var index = (i - 1) % data.length;
                            var d = $.extend(true, {}, data[index]);

                            var day = moment(data[data.length - 1]).add(step * i, "months").day();
                            if(day == 0){
                                var date = moment(data[data.length - 1]).add(step * i, "months").subtract(2, "days").format("YYYY-MM-DD");
                            }
                            else if(day == 6){
                                var date = moment(data[data.length - 1]).add(step * i, "months").subtract(1, "days").format("YYYY-MM-DD");
                            }
                            else{
                                var date = moment(data[data.length - 1]).add(step * i, "months").format("YYYY-MM-DD");
                            }
                            
                            d["m"] = date;
                            d["v"] = jfgrid.mask.genarate(date)[2];
                            applyData.push(d);
                        }
                    }
                    else{
                        //日不一样
                        if(Math.abs(moment(data[1]["m"]).diff(moment(data[0]["m"]))) > 7){
                            //若日差大于7天，以一月为step（若那天是休息日，则向前取最近的工作日）
                            if(direction == "down" || direction == "right"){
                                var step_month = 1;
                            }
                            else if(direction == "up" || direction == "left"){
                                var step_month = -1;
                                data.reverse();
                            }

                            var step; //以数组第一个为对比
                            for(var i = 1; i <= len; i++){
                                var index = (i - 1) % data.length;
                                var d = $.extend(true, {}, data[index]);

                                var num = Math.ceil(i / data.length);
                                if(index == 0){
                                    step = moment(d["m"]).add(step_month * num, "months").diff(moment(d["m"]), "days");
                                }

                                var day = moment(d["m"]).add(step, "days").day();
                                if(day == 0){
                                    var date = moment(d["m"]).add(step, "days").subtract(2, "days").format("YYYY-MM-DD");
                                }
                                else if(day == 6){
                                    var date = moment(d["m"]).add(step, "days").subtract(1, "days").format("YYYY-MM-DD");
                                }
                                else{
                                    var date = moment(d["m"]).add(step, "days").format("YYYY-MM-DD");
                                }

                                d["m"] = date;
                                d["v"] = jfgrid.mask.genarate(date)[2];
                                applyData.push(d);
                            }
                        }
                        else{
                            //若日差小于等于7天，以7天为step（若那天是休息日，则向前取最近的工作日）
                            if(direction == "down" || direction == "right"){
                                var step_day = 7;
                            }
                            else if(direction == "up" || direction == "left"){
                                var step_day = -7;
                                data.reverse();
                            }

                            var step; //以数组第一个为对比
                            for(var i = 1; i <= len; i++){
                                var index = (i - 1) % data.length;
                                var d = $.extend(true, {}, data[index]);

                                var num = Math.ceil(i / data.length);
                                if(index == 0){
                                    step = moment(d["m"]).add(step_day * num, "days").diff(moment(d["m"]), "days");
                                }

                                var day = moment(d["m"]).add(step, "days").day();
                                if(day == 0){
                                    var date = moment(d["m"]).add(step, "days").subtract(2, "days").format("YYYY-MM-DD");
                                }
                                else if(day == 6){
                                    var date = moment(d["m"]).add(step, "days").subtract(1, "days").format("YYYY-MM-DD");
                                }
                                else{
                                    var date = moment(d["m"]).add(step, "days").format("YYYY-MM-DD");
                                }

                                d["m"] = date;
                                d["v"] = jfgrid.mask.genarate(date)[2];
                                applyData.push(d);
                            }
                        }
                    }
                }
                else{
                    var judgeDate = jfgrid.dropCell.judgeDate(data);
                    if(judgeDate[0] && judgeDate[3]){
                        //日一样，且月差为等差数列，以月差为step（若那天为休息日，则向前取最近的工作日）
                        if(direction == "up" || direction == "left"){
                            data.reverse();
                        }
                        var step = moment(data[1]["m"]).diff(moment(data[0]["m"]), "months");

                        for(var i = 1; i <= len; i++){
                            var index = (i - 1) % data.length;
                            var d = $.extend(true, {}, data[index]);

                            var day = moment(data[data.length - 1]["m"]).add(step * i, "months").day();
                            if(day == 0){
                                var date = moment(data[data.length - 1]["m"]).add(step * i, "months").subtract(2, "days").format("YYYY-MM-DD");
                            }
                            else if(day == 6){
                                var date = moment(data[data.length - 1]["m"]).add(step * i, "months").subtract(1, "days").format("YYYY-MM-DD");
                            }
                            else{
                                var date = moment(data[data.length - 1]["m"]).add(step * i, "months").format("YYYY-MM-DD");
                            }

                            d["m"] = date;
                            d["v"] = jfgrid.mask.genarate(date)[2];
                            applyData.push(d);
                        }
                    }
                    else if(!judgeDate[0] && judgeDate[2]){
                        //日不一样，且日差为等差数列
                        if(Math.abs(moment(data[1]["m"]).diff(moment(data[0]["m"]))) > 7){
                            //若日差大于7天，以一月为step（若那天是休息日，则向前取最近的工作日）
                            if(direction == "down" || direction == "right"){
                                var step_month = 1;
                            }
                            else if(direction == "up" || direction == "left"){
                                var step_month = -1;
                                data.reverse();
                            }

                            var step; //以数组第一个为对比
                            for(var i = 1; i <= len; i++){
                                var index = (i - 1) % data.length;
                                var d = $.extend(true, {}, data[index]);

                                var num = Math.ceil(i / data.length);
                                if(index == 0){
                                    step = moment(d["m"]).add(step_month * num, "months").diff(moment(d["m"]), "days");
                                }

                                var day = moment(d["m"]).add(step, "days").day();
                                if(day == 0){
                                    var date = moment(d["m"]).add(step, "days").subtract(2, "days").format("YYYY-MM-DD");
                                }
                                else if(day == 6){
                                    var date = moment(d["m"]).add(step, "days").subtract(1, "days").format("YYYY-MM-DD");
                                }
                                else{
                                    var date = moment(d["m"]).add(step, "days").format("YYYY-MM-DD");
                                }

                                d["m"] = date;
                                d["v"] = jfgrid.mask.genarate(date)[2];
                                applyData.push(d);
                            }
                        }
                        else{
                            //若日差小于等于7天，以7天为step（若那天是休息日，则向前取最近的工作日）
                            if(direction == "down" || direction == "right"){
                                var step_day = 7;
                            }
                            else if(direction == "up" || direction == "left"){
                                var step_day = -7;
                                data.reverse();
                            }

                            var step; //以数组第一个为对比
                            for(var i = 1; i <= len; i++){
                                var index = (i - 1) % data.length;
                                var d = $.extend(true, {}, data[index]);

                                var num = Math.ceil(i / data.length);
                                if(index == 0){
                                    step = moment(d["m"]).add(step_day * num, "days").diff(moment(d["m"]), "days");
                                }

                                var day = moment(d["m"]).add(step, "days").day();
                                if(day == 0){
                                    var date = moment(d["m"]).add(step, "days").subtract(2, "days").format("YYYY-MM-DD");
                                }
                                else if(day == 6){
                                    var date = moment(d["m"]).add(step, "days").subtract(1, "days").format("YYYY-MM-DD");
                                }
                                else{
                                    var date = moment(d["m"]).add(step, "days").format("YYYY-MM-DD");
                                }

                                d["m"] = date;
                                d["v"] = jfgrid.mask.genarate(date)[2];
                                applyData.push(d);
                            }
                        }
                    }
                    else{
                        //日差不是等差数列，复制数据
                        if(direction == "up" || direction == "left"){
                            data.reverse();
                        }
                        applyData = jfgrid.dropCell.FillCopy(data, len);
                    }
                }
            }
            else if(type == "6"){ //以月填充
                if(data.length == 1){
                    //以一月为step
                    if(direction == "down" || direction == "right"){
                        var step = 1;
                    }
                    else if(direction == "up" || direction == "left"){
                        var step = -1;
                    }
                    applyData = jfgrid.dropCell.FillMonths(data, len, step);
                }
                else if(data.length == 2){
                    if(moment(data[1]["m"]).date() == moment(data[0]["m"]).date() && moment(data[1]["m"]).diff(moment(data[0]["m"]), "months") != 0){
                        //日一样，且月差大于一月，以月差为step
                        if(direction == "up" || direction == "left"){
                            data.reverse();
                        }
                        var step = moment(data[1]["m"]).diff(moment(data[0]["m"]), "months");
                        applyData = jfgrid.dropCell.FillMonths(data, len, step);
                    }
                    else{
                        //以一月为step
                        if(direction == "down" || direction == "right"){
                            var step_month = 1;
                        }
                        else if(direction == "up" || direction == "left"){
                            var step_month = -1;
                            data.reverse();
                        }

                        var step; //以数组第一个为对比
                        for(var i = 1; i <= len; i++){
                            var index = (i - 1) % data.length;
                            var d = $.extend(true, {}, data[index]);

                            var num = Math.ceil(i / data.length);
                            if(index == 0){
                                step = moment(d["m"]).add(step_month * num, "months").diff(moment(d["m"]), "days");
                            }
                            
                            var date = moment(d["m"]).add(step, "days").format("YYYY-MM-DD");
                            d["m"] = date;
                            d["v"] = jfgrid.mask.genarate(date)[2];
                            applyData.push(d);
                        }
                    }
                }
                else{
                    var judgeDate = jfgrid.dropCell.judgeDate(data);
                    if(judgeDate[0] && judgeDate[3]){
                        //日一样，且月差为等差数列，以月差为step
                        if(direction == "up" || direction == "left"){
                            data.reverse();
                        }
                        var step = moment(data[1]["m"]).diff(moment(data[0]["m"]), "months");
                        applyData = jfgrid.dropCell.FillMonths(data, len, step);
                    }
                    else if(!judgeDate[0] && judgeDate[2]){
                        //日不一样，且日差为等差数列，以一月为step
                        if(direction == "down" || direction == "right"){
                            var step_month = 1;
                        }
                        else if(direction == "up" || direction == "left"){
                            var step_month = -1;
                            data.reverse();
                        }

                        var step; //以数组第一个为对比
                        for(var i = 1; i <= len; i++){
                            var index = (i - 1) % data.length;
                            var d = $.extend(true, {}, data[index]);

                            var num = Math.ceil(i / data.length);
                            if(index == 0){
                                step = moment(d["m"]).add(step_month * num, "months").diff(moment(d["m"]), "days");
                            }
                            
                            var date = moment(d["m"]).add(step, "days").format("YYYY-MM-DD");
                            d["m"] = date;
                            d["v"] = jfgrid.mask.genarate(date)[2];
                            applyData.push(d);
                        }
                    }
                    else{
                        //日差不是等差数列，复制数据
                        if(direction == "up" || direction == "left"){
                            data.reverse();
                        }
                        applyData = jfgrid.dropCell.FillCopy(data, len);
                    }
                }
            }
            else if(type == "7"){ //以年填充
                if(data.length == 1){
                    //以一年为step
                    if(direction == "down" || direction == "right"){
                        var step = 1;
                    }
                    else if(direction == "up" || direction == "left"){
                        var step = -1;
                    }
                    applyData = jfgrid.dropCell.FillYears(data, len, step);
                }
                else if(data.length == 2){
                    if(moment(data[1]["m"]).date() == moment(data[0]["m"]).date() && moment(data[1]["m"]).month() == moment(data[0]["m"]).month() && moment(data[1]["m"]).diff(moment(data[0]["m"]), "years") != 0){
                        //日月一样，且年差大于一年，以年差为step
                        if(direction == "up" || direction == "left"){
                            data.reverse();
                        }
                        var step = moment(data[1]["m"]).diff(moment(data[0]["m"]), "years");
                        applyData = jfgrid.dropCell.FillYears(data, len, step);
                    }
                    else{
                        //以一年为step
                        if(direction == "down" || direction == "right"){
                            var step_year = 1;
                        }
                        else if(direction == "up" || direction == "left"){
                            var step_year = -1;
                            data.reverse();
                        }

                        var step; //以数组第一个为对比
                        for(var i = 1; i <= len; i++){
                            var index = (i - 1) % data.length;
                            var d = $.extend(true, {}, data[index]);

                            var num = Math.ceil(i / data.length);
                            if(index == 0){
                                step = moment(d["m"]).add(step_year * num, "years").diff(moment(d["m"]), "days");
                            }
                            
                            var date = moment(d["m"]).add(step, "days").format("YYYY-MM-DD");
                            d["m"] = date;
                            d["v"] = jfgrid.mask.genarate(date)[2];
                            applyData.push(d);
                        }
                    }
                }
                else{
                    var judgeDate = jfgrid.dropCell.judgeDate(data);
                    if(judgeDate[0] && judgeDate[1] && judgeDate[4]){
                        //日月一样，且年差为等差数列，以年差为step
                        if(direction == "up" || direction == "left"){
                            data.reverse();
                        }
                        var step = moment(data[1]["m"]).diff(moment(data[0]["m"]), "years");
                        applyData = jfgrid.dropCell.FillYears(data, len, step);
                    }
                    else if((judgeDate[0] && judgeDate[3]) || judgeDate[2]){
                        //日一样且月差为等差数列，或天差为等差数列，以一年为step
                        if(direction == "down" || direction == "right"){
                            var step_year = 1;
                        }
                        else if(direction == "up" || direction == "left"){
                            var step_year = -1;
                            data.reverse();
                        }

                        var step; //以数组第一个为对比
                        for(var i = 1; i <= len; i++){
                            var index = (i - 1) % data.length;
                            var d = $.extend(true, {}, data[index]);

                            var num = Math.ceil(i / data.length);
                            if(index == 0){
                                step = moment(d["m"]).add(step_year * num, "years").diff(moment(d["m"]), "days");
                            }
                            
                            var date = moment(d["m"]).add(step, "days").format("YYYY-MM-DD");
                            d["m"] = date;
                            d["v"] = jfgrid.mask.genarate(date)[2];
                            applyData.push(d);
                        }
                    }
                    else{
                        //日差不是等差数列，复制数据
                        if(direction == "up" || direction == "left"){
                            data.reverse();
                        }
                        applyData = jfgrid.dropCell.FillCopy(data, len);
                    }
                }
            }
            else if(type == "8"){ //以中文小写数字序列填充
                if(data.length == 1){
                    if(direction == "down" || direction == "right"){
                        var step = 1;
                    }
                    else if(direction == "up" || direction == "left"){
                        var step = -1;
                    }
                    applyData = jfgrid.dropCell.FillChnNumber(data, len, step);
                }
                else{
                    var dataNumArr = [];
                    for(var i = 0; i < data.length; i++){
                        dataNumArr.push(jfgrid.dropCell.ChineseToNumber(data[i]["m"]));
                    }

                    if(direction == "up" || direction == "left"){
                        data.reverse();
                        dataNumArr.reverse();
                    }

                    if(jfgrid.dropCell.isEqualDiff(dataNumArr)){
                        var step = dataNumArr[1] - dataNumArr[0];
                        applyData = jfgrid.dropCell.FillChnNumber(data, len, step);
                    }
                    else{
                        //不是等差数列，复制数据
                        applyData = jfgrid.dropCell.FillCopy(data, len);
                    }
                }
            }
            
            return applyData;
        },
        FillCopy: function(data, len){
            var applyData = [];

            for(var i = 1; i <= len; i++){
                var index = (i - 1) % data.length;
                var d = $.extend(true, {}, data[index]);

                applyData.push(d);
            } 

            return applyData;
        },
        FillSeries: function(data, len, direction){
            var applyData = [];

            var dataNumArr = [];
            for(var j = 0; j < data.length; j++){
                dataNumArr.push(Number(data[j]["v"]));
            }

            if(data.length > 2 && jfgrid.dropCell.isEqualRatio(dataNumArr)){
                //等比数列
                for(var i = 1; i <= len; i++){
                    var index = (i - 1) % data.length;
                    var d = $.extend(true, {}, data[index]);

                    if(direction == "down" || direction == "right"){
                        var num = Number(data[data.length -1]["v"]) * Math.pow(Number(data[1]["v"]) / Number(data[0]["v"]), i);
                    }
                    else if(direction == "up" || direction == "left"){
                        var num = Number(data[0]["v"]) / Math.pow(Number(data[1]["v"]) / Number(data[0]["v"]), i);
                    }
                    
                    d["v"] = num;
                    d["m"] = jfgrid.mask.update(d["ct"]["fa"], num);
                    applyData.push(d);
                }
            }
            else{
                //线性数列
                var xArr = jfgrid.dropCell.getXArr(data.length);
                for(var i = 1; i <= len; i++){
                    var index = (i - 1) % data.length;
                    var d = $.extend(true, {}, data[index]);

                    if(direction == "down" || direction == "right"){
                        var y = jfgrid.dropCell.forecast(data.length + i, dataNumArr, xArr);
                    }
                    else if(direction == "up" || direction == "left"){
                        var y = jfgrid.dropCell.forecast(1 - i, dataNumArr, xArr);
                    }

                    d["v"] = y;
                    d["m"] = jfgrid.mask.update(d["ct"]["fa"], y);
                    applyData.push(d);
                }
            }

            return applyData;
        },
        FillExtendNumber: function(data, len, step){
            var applyData = [];

            for(var i = 1; i <= len; i++){
                var index = (i - 1) % data.length;
                var d = $.extend(true, {}, data[index]);

                var last = data[data.length - 1]["m"];
                var lastTxt = jfgrid.dropCell.isExtendNumber(last)[1];
                var lastNum = jfgrid.dropCell.isExtendNumber(last)[2];

                var num = Math.abs(Number(lastNum) + step * i);
                d["v"] = lastTxt + num.toString();
                d["m"] = lastTxt + num.toString();

                applyData.push(d);
            }

            return applyData;
        },
        FillOnlyFormat: function(data, len){
            var applyData = [];

            for(var i = 1; i <= len; i++){
                var index = (i - 1) % data.length;
                var d = $.extend(true, {}, data[index]);

                delete d["f"];
                delete d["m"];
                delete d["v"];

                applyData.push(d);
            } 

            return applyData; 
        },
        FillWithoutFormat: function(dataArr){
            var applyData = [];

            for(var i = 0; i < dataArr.length; i++){
                var d = $.extend(true, {}, dataArr[i]);

                if(d["f"] == null){
                    var obj = {"m": d["v"].toString(), "v": d["v"]};
                }
                else{
                    var obj = {"f": d["f"], "m": d["v"].toString(), "v": d["v"]};
                }

                applyData.push(obj);
            }

            return applyData;
        },
        FillDays: function(data, len, step){
            var applyData = [];

            for(var i = 1; i <= len; i++){
                var index = (i - 1) % data.length;
                var d = $.extend(true, {}, data[index]);

                var date = jfgrid.mask.update("yyyy-MM-dd", d["v"]);
                date = moment(date).add(step * i, "days").format("YYYY-MM-DD");

                d["v"] = jfgrid.mask.genarate(date)[2];
                d["m"] = jfgrid.mask.update(d["ct"]["fa"], d["v"]);

                applyData.push(d);
            }

            return applyData;
        },
        FillMonths: function(data, len, step){
            var applyData = [];

            for(var i = 1; i <= len; i++){
                var index = (i - 1) % data.length;
                var d = $.extend(true, {}, data[index]);

                var date = jfgrid.mask.update("yyyy-MM-dd", d["v"]);
                date = moment(date).add(step * i, "months").format("YYYY-MM-DD");
                
                d["v"] = jfgrid.mask.genarate(date)[2];
                d["m"] = jfgrid.mask.update(d["ct"]["fa"], d["v"]);
                
                applyData.push(d);
            }

            return applyData;
        },
        FillYears: function(data, len, step){
            var applyData = [];

            for(var i = 1; i <= len; i++){
                var index = (i - 1) % data.length;
                var d = $.extend(true, {}, data[index]);

                var date = jfgrid.mask.update("yyyy-MM-dd", d["v"]);
                date = moment(date).add(step * i, "years").format("YYYY-MM-DD");
                
                d["v"] = jfgrid.mask.genarate(date)[2];
                d["m"] = jfgrid.mask.update(d["ct"]["fa"], d["v"]);
                
                applyData.push(d);
            }

            return applyData;
        },
        FillChnWeek: function(data, len, step){
            var applyData = [];

            for(var i = 1; i <= len; i++){
                var index = (i - 1) % data.length;
                var d = $.extend(true, {}, data[index]);

                if(data[data.length - 1]["m"] == "日"){
                    var num = 7 + step * i;
                }
                else{
                    var num = jfgrid.dropCell.ChineseToNumber(data[data.length - 1]["m"]) + step * i;
                }
                
                if(num < 0){
                    num = Math.ceil(Math.abs(num) / 7) * 7 + num;
                }

                var rsd = num % 7;
                if(rsd == 0){
                    d["m"] = "日";
                    d["v"] = "日";
                }
                else if(rsd == 1){
                    d["m"] = "一";
                    d["v"] = "一";
                }
                else if(rsd == 2){
                    d["m"] = "二";
                    d["v"] = "二";
                }
                else if(rsd == 3){
                    d["m"] = "三";
                    d["v"] = "三";
                }
                else if(rsd == 4){
                    d["m"] = "四";
                    d["v"] = "四";
                }
                else if(rsd == 5){
                    d["m"] = "五";
                    d["v"] = "五";
                }
                else if(rsd == 6){
                    d["m"] = "六";
                    d["v"] = "六";
                }

                applyData.push(d);
            }

            return applyData;
        },
        FillChnWeek2: function(data, len, step){
            var applyData = [];

            for(var i = 1; i <= len; i++){
                var index = (i - 1) % data.length;
                var d = $.extend(true, {}, data[index]);

                if(data[data.length - 1]["m"] == "周日"){
                    var num = 7 + step * i;
                }
                else{
                    var last = data[data.length - 1]["m"];
                    var txt = last.substr(last.length - 1, 1);
                    var num = jfgrid.dropCell.ChineseToNumber(txt) + step * i;
                }
                
                if(num < 0){
                    num = Math.ceil(Math.abs(num) / 7) * 7 + num;
                }

                var rsd = num % 7;
                if(rsd == 0){
                    d["m"] = "周日";
                    d["v"] = "周日";
                }
                else if(rsd == 1){
                    d["m"] = "周一";
                    d["v"] = "周一";
                }
                else if(rsd == 2){
                    d["m"] = "周二";
                    d["v"] = "周二";
                }
                else if(rsd == 3){
                    d["m"] = "周三";
                    d["v"] = "周三";
                }
                else if(rsd == 4){
                    d["m"] = "周四";
                    d["v"] = "周四";
                }
                else if(rsd == 5){
                    d["m"] = "周五";
                    d["v"] = "周五";
                }
                else if(rsd == 6){
                    d["m"] = "周六";
                    d["v"] = "周六";
                }

                applyData.push(d);
            }

            return applyData;
        },
        FillChnWeek3: function(data, len, step){
            var applyData = [];

            for(var i = 1; i <= len; i++){
                var index = (i - 1) % data.length;
                var d = $.extend(true, {}, data[index]);

                if(data[data.length - 1]["m"] == "星期日"){
                    var num = 7 + step * i;
                }
                else{
                    var last = data[data.length - 1]["m"];
                    var txt = last.substr(last.length - 1, 1);
                    var num = jfgrid.dropCell.ChineseToNumber(txt) + step * i;
                }
                
                if(num < 0){
                    num = Math.ceil(Math.abs(num) / 7) * 7 + num;
                }

                var rsd = num % 7;
                if(rsd == 0){
                    d["m"] = "星期日";
                    d["v"] = "星期日";
                }
                else if(rsd == 1){
                    d["m"] = "星期一";
                    d["v"] = "星期一";
                }
                else if(rsd == 2){
                    d["m"] = "星期二";
                    d["v"] = "星期二";
                }
                else if(rsd == 3){
                    d["m"] = "星期三";
                    d["v"] = "星期三";
                }
                else if(rsd == 4){
                    d["m"] = "星期四";
                    d["v"] = "星期四";
                }
                else if(rsd == 5){
                    d["m"] = "星期五";
                    d["v"] = "星期五";
                }
                else if(rsd == 6){
                    d["m"] = "星期六";
                    d["v"] = "星期六";
                }

                applyData.push(d);
            }

            return applyData;
        },
        FillChnNumber: function(data, len, step){
            var applyData = [];

            for(var i = 1; i <= len; i++){
                var index = (i - 1) % data.length;
                var d = $.extend(true, {}, data[index]);

                var num = jfgrid.dropCell.ChineseToNumber(data[data.length - 1]["m"]) + step * i;
                if(num <= 0){
                    var txt = "零";
                }
                else{
                    var txt = jfgrid.dropCell.NumberToChinese(num);
                }

                d["v"] = txt;
                d["m"] = txt.toString();
                applyData.push(d);
            }

            return applyData;
        },
        isEqualDiff: function(arr){
            var diff = true;
            var step = arr[1] - arr[0];
            for(var i = 1; i < arr.length; i++){
                if(arr[i] - arr[i - 1] != step){
                    diff = false;
                    break;
                }
            }
            return diff;
        },
        isEqualRatio: function(arr){
            var ratio = true;
            var step = arr[1] / arr[0];
            for(var i = 1; i < arr.length; i++){
                if(arr[i] / arr[i - 1] != step){
                    ratio = false;
                    break;
                }
            }
            return ratio;
        },
        getXArr: function(len){
            var xArr = [];
            for(var i = 1; i <= len; i++){
                xArr.push(i);
            }
            return xArr;
        },
        forecast: function(x, yArr, xArr){
            function getAverage(arr){
                var sum = 0;
                for(var i = 0; i < arr.length; i++){
                    sum += arr[i];
                }
                return sum / arr.length;
            }
            var ax = getAverage(xArr); //x数组 平均值
            var ay = getAverage(yArr); //y数组 平均值
            
            var sum_d = 0, sum_n = 0;
            for(var j = 0; j < xArr.length; j++){
                //分母和
                sum_d += (xArr[j] - ax)*(yArr[j] - ay);
                //分子和
                sum_n += (xArr[j] - ax)*(xArr[j] - ax);
            }

            if(sum_n == 0){
                var b = 1;
            }
            else{
                var b = sum_d / sum_n;
            }
            var a = ay - b * ax;

            return Math.round((a + b * x) * 100000) / 100000;
        },
        judgeDate: function(data){
            var isSameDay = true, isSameMonth = true, isEqualDiffDays = true, isEqualDiffMonths = true, isEqualDiffYears = true;
            var sameDay = moment(data[0]["m"]).date(), sameMonth = moment(data[0]["m"]).month(); 
            var equalDiffDays = moment(data[1]["m"]).diff(moment(data[0]["m"]), "days");
            var equalDiffMonths = moment(data[1]["m"]).diff(moment(data[0]["m"]), "months");
            var equalDiffYears = moment(data[1]["m"]).diff(moment(data[0]["m"]), "years");

            for(var i = 1; i < data.length; i++){
                //日是否一样
                if(moment(data[i]["m"]).date() != sameDay){
                    isSameDay = false;
                }
                //月是否一样
                if(moment(data[i]["m"]).month() != sameMonth){
                    isSameMonth = false;
                }
                //日差是否是 等差数列
                if(moment(data[i]["m"]).diff(moment(data[i - 1]["m"]), "days") != equalDiffDays){
                    isEqualDiffDays = false;
                }
                //月差是否是 等差数列
                if(moment(data[i]["m"]).diff(moment(data[i - 1]["m"]), "months") != equalDiffMonths){
                    isEqualDiffMonths = false;
                }
                //年差是否是 等差数列
                if(moment(data[i]["m"]).diff(moment(data[i - 1]["m"]), "years") != equalDiffYears){
                    isEqualDiffYears = false;
                }
            }
            if(equalDiffDays == 0){
                isEqualDiffDays = false;
            }
            if(equalDiffMonths == 0){
                isEqualDiffMonths = false;
            }
            if(equalDiffYears == 0){
                isEqualDiffYears = false;
            }

            return [isSameDay, isSameMonth, isEqualDiffDays, isEqualDiffMonths, isEqualDiffYears];
        }
    }

    //定位
    jfgrid.locationCell = {
        createDialog: function(){
            $("#jfgrid-modal-dialog-mask").show();
            $("#jfgrid-locationCell-dialog").remove();

            var content = '<div class="listbox">'+
                            '<div class="listItem">'+
                                '<input type="radio" name="locationType" checked="checked" id="locationConstant">'+
                                '<label for="locationConstant">常量</label>'+
                                '<div class="subbox">'+
                                    '<div class="subItem">'+
                                        '<input type="checkbox" checked="checked" class="date" id="locationConstantDate">'+
                                        '<label for="locationConstantDate">日期</label>'+
                                    '</div>'+
                                    '<div class="subItem">'+
                                        '<input type="checkbox" checked="checked" class="number" id="locationConstantNumber">'+
                                        '<label for="locationConstantNumber">数字</label>'+
                                    '</div>'+
                                    '<div class="subItem">'+
                                        '<input type="checkbox" checked="checked" class="string" id="locationConstantString">'+
                                        '<label for="locationConstantString">字符</label>'+
                                    '</div>'+
                                    '<div class="subItem">'+
                                        '<input type="checkbox" checked="checked" class="boolean" id="locationConstantBoolean">'+
                                        '<label for="locationConstantBoolean">逻辑值</label>'+
                                    '</div>'+
                                    '<div class="subItem">'+
                                        '<input type="checkbox" checked="checked" class="error" id="locationConstantError">'+
                                        '<label for="locationConstantError">错误</label>'+
                                    '</div>'+
                                '</div>'+
                            '</div>'+
                            '<div class="listItem">'+
                                '<input type="radio" name="locationType" id="locationFormula">'+
                                '<label for="locationFormula">公式</label>'+
                                '<div class="subbox">'+
                                    '<div class="subItem">'+
                                        '<input type="checkbox" checked="checked" class="date" id="locationFormulaDate" disabled="true">'+
                                        '<label for="locationFormulaDate" style="color: #666">日期</label>'+
                                    '</div>'+
                                    '<div class="subItem">'+
                                        '<input type="checkbox" checked="checked" class="number" id="locationFormulaNumber" disabled="true">'+
                                        '<label for="locationFormulaNumber" style="color: #666">数字</label>'+
                                    '</div>'+
                                    '<div class="subItem">'+
                                        '<input type="checkbox" checked="checked" class="string" id="locationFormulaString" disabled="true">'+
                                        '<label for="locationFormulaString" style="color: #666">字符</label>'+
                                    '</div>'+
                                    '<div class="subItem">'+
                                        '<input type="checkbox" checked="checked" class="boolean" id="locationFormulaBoolean" disabled="true">'+
                                        '<label for="locationFormulaBoolean" style="color: #666">逻辑值</label>'+
                                    '</div>'+
                                    '<div class="subItem">'+
                                        '<input type="checkbox" checked="checked" class="error" id="locationFormulaError" disabled="true">'+
                                        '<label for="locationFormulaError" style="color: #666">错误</label>'+
                                    '</div>'+
                                '</div>'+
                            '</div>'+
                            '<div class="listItem">'+
                                '<input type="radio" name="locationType" id="locationNull">'+
                                '<label for="locationNull">空值</label>'+
                            '</div>'+
                            '<div class="listItem">'+
                                '<input type="radio" name="locationType" id="locationCF">'+
                                '<label for="locationCF">条件格式</label>'+
                            '</div>'+
                            '<div class="listItem">'+
                                '<input type="radio" name="locationType" id="locationStepRow">'+
                                '<label for="locationStepRow">间隔行</label>'+
                            '</div>'+
                            '<div class="listItem">'+
                                '<input type="radio" name="locationType" id="locationStepColumn">'+
                                '<label for="locationStepColumn">间隔列</label>'+
                            '</div>'+
                          '</div>';

            $("body").append(jfgrid.replaceHtml(modelHTML, { "id": "jfgrid-locationCell-dialog", "addclass": "jfgrid-locationCell-dialog", "title": "定位条件", "content": content, "botton": '<button id="jfgrid-locationCell-dialog-confirm" class="btn btn-primary">确定</button><button class="btn btn-default jfgrid-model-close-btn">取消</button>', "style": "z-index:100003" }));
            var $t = $("#jfgrid-locationCell-dialog").find(".jfgrid-modal-dialog-content").css("min-width", 400).end(), myh = $t.outerHeight(), myw = $t.outerWidth();
            var winw = $(window).width(), winh = $(window).height();
            var scrollLeft = $(document).scrollLeft(), scrollTop = $(document).scrollTop();
            $("#jfgrid-locationCell-dialog").css({ "left": (winw + scrollLeft - myw) / 2, "top": (winh + scrollTop - myh) / 3 }).show();
        },
        init: function(){
            $(document).on("click", "#jfgrid-locationCell-dialog .listItem input:radio", function(e){
                $("#jfgrid-locationCell-dialog .listItem input:checkbox").prop("disabled", true);
                $("#jfgrid-locationCell-dialog .listItem .subbox label").css("color", "#666");

                $(this).siblings(".subbox").find("input:checkbox").removeAttr("disabled");
                $(this).siblings(".subbox").find("label").css("color", "#000");
            });

            $(document).off("click.locationCellConfirm").on("click.locationCellConfirm", "#jfgrid-locationCell-dialog #jfgrid-locationCell-dialog-confirm", function(){
                $("#jfgrid-modal-dialog-mask").hide();
                $("#jfgrid-locationCell-dialog").hide();

                var $radio = $("#jfgrid-locationCell-dialog .listItem input:radio:checked");
                var id = $radio.attr("id");
                if(id == "locationConstant" || id == "locationFormula"){
                    var $checkbox = $radio.siblings(".subbox").find("input:checkbox:checked");
                    if($checkbox.length == 0){
                        return;
                    }
                    else if($checkbox.length == 5){
                        var value = "all";
                    }
                    else{
                        var arr = [];
                        for(var i = 0; i < $checkbox.length; i++){
                            if($($checkbox[i]).hasClass("date")){
                                arr.push("d");
                            }
                            else if($($checkbox[i]).hasClass("number")){
                                arr.push("n");
                            }
                            else if($($checkbox[i]).hasClass("string")){
                                arr.push("s,g");
                            }
                            else if($($checkbox[i]).hasClass("boolean")){
                                arr.push("b");
                            }
                            else if($($checkbox[i]).hasClass("error")){
                                arr.push("e");
                            }
                        }
                        var value = arr.join(",");
                    }

                    if(jfgird_select_save.length == 0 || (jfgird_select_save.length == 1 && jfgird_select_save[0].row[0] == jfgird_select_save[0].row[1] && jfgird_select_save[0].column[0] == jfgird_select_save[0].column[1])){
                        //单个单元格
                        var range = [{"row": [0, jfgrid.flowdata.length - 1], "column": [0, jfgrid.flowdata[0].length - 1]}];
                    }
                    else{
                        var range = $.extend(true, [], jfgird_select_save);
                    }

                    jfgrid.locationCell.apply(range, id, value);
                }
                else if(id == "locationStepRow"){
                    if(jfgird_select_save.length == 0 || (jfgird_select_save.length == 1 && jfgird_select_save[0].row[0] == jfgird_select_save[0].row[1])){
                        if(jfgrid.isEditMode()){
                            alert("请选择最少两行");
                        }
                        else{
                            jfgrid.tooltip.info("提示", "请选择最少两行"); 
                        }
                        return;                            
                    }

                    var range = $.extend(true, [], jfgird_select_save);

                    jfgrid.locationCell.apply(range, "locationStepRow");
                }
                else if(id == "locationStepColumn"){
                    if(jfgird_select_save.length == 0 || (jfgird_select_save.length == 1 && jfgird_select_save[0].column[0] == jfgird_select_save[0].column[1])){
                        if(jfgrid.isEditMode()){
                            alert("请选择最少两列");
                        }
                        else{
                            jfgrid.tooltip.info("提示", "请选择最少两列");    
                        }
                        return;                            
                    }

                    var range = $.extend(true, [], jfgird_select_save);

                    jfgrid.locationCell.apply(range, "locationStepColumn");
                }
                else{
                    if(jfgird_select_save.length == 0 || (jfgird_select_save.length == 1 && jfgird_select_save[0].row[0] == jfgird_select_save[0].row[1] && jfgird_select_save[0].column[0] == jfgird_select_save[0].column[1])){
                        //单个单元格
                        var range = [{"row": [0, jfgrid.flowdata.length - 1], "column": [0, jfgrid.flowdata[0].length - 1]}];
                    }
                    else{
                        var range = $.extend(true, [], jfgird_select_save);
                    }

                    jfgrid.locationCell.apply(range, id);
                }
            });
        },
        apply: function(range, type, value){
            var rangeArr = [];

            if(type == "locationFormula" || type == "locationConstant" || type == "locationNull" || type == "locationCF"){
                if(type == "locationFormula"){ //公式
                    if(value == "all"){
                        var str = "jfgrid.flowdata[r] != null && jfgrid.flowdata[r][c] != null && jfgrid.flowdata[r][c].v != null && jfgrid.flowdata[r][c].f != null";
                    }
                    else{
                        var str = "jfgrid.flowdata[r] != null && jfgrid.flowdata[r][c] != null && jfgrid.flowdata[r][c].v != null && jfgrid.flowdata[r][c].f != null && jfgrid.flowdata[r][c].ct != null && value.indexOf(jfgrid.flowdata[r][c].ct.t) != -1";
                    }
                }
                else if(type == "locationConstant"){ //常量
                    if(value == "all"){
                        var str = "jfgrid.flowdata[r] != null && jfgrid.flowdata[r][c] != null && jfgrid.flowdata[r][c].v != null && jfgrid.flowdata[r][c].f == null && jfgrid.flowdata[r][c].ct != null";
                    }
                    else{
                        var str = "jfgrid.flowdata[r] != null && jfgrid.flowdata[r][c] != null && jfgrid.flowdata[r][c].v != null && jfgrid.flowdata[r][c].f == null && jfgrid.flowdata[r][c].ct != null && value.indexOf(jfgrid.flowdata[r][c].ct.t) != -1";
                    }
                }
                else if(type == "locationNull"){ //空值
                    var str = "jfgrid.flowdata[r] != null && (jfgrid.flowdata[r][c] == null || jfgrid.flowdata[r][c].v == null || jfgrid.flowdata[r][c].v == '') ";
                }
                else if(type == "locationCF"){ //条件格式
                    var index = jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex);
                    var ruleArr = jfgridfile[index]["jfgrid_conditionformat_save"];
                    var data = jfgridfile[index]["data"];

                    var computeMap = jfgrid.conditionformat.compute(ruleArr, data);

                    if(JSON.stringify(computeMap) == "{}"){
                        if(jfgrid.isEditMode()){
                            alert("未找到单元格");
                        }
                        else{
                            jfgrid.tooltip.info("提示", "未找到单元格");
                        }

                        return;
                    }

                    var str = "(r + '_' + c) in computeMap";
                }

                for(var s = 0; s < range.length; s++){
                    var st_r = range[s].row[0], ed_r = range[s].row[1];
                    var st_c = range[s].column[0], ed_c = range[s].column[1];
                    
                    if(st_r == ed_r){
                        var stack_stc = null, stack_edc = null;

                        var r = st_r;
                        for(var c = st_c; c <= ed_c; c++){
                            if(c == st_c){
                                if(eval(str)){
                                    stack_stc = c;
                                }
                                else{
                                    stack_stc = null;
                                }
                            }
                            else if(c == ed_c){
                                if(eval(str)){
                                    if(stack_stc == null){
                                        rangeArr.push({"row": [st_r, ed_r], "column": [ed_c, ed_c]});
                                    }
                                    else{
                                        rangeArr.push({"row": [st_r, ed_r], "column": [stack_stc, ed_c]});
                                    }
                                }
                                else{
                                    if(stack_edc == null && stack_stc != null){
                                        rangeArr.push({"row": [st_r, ed_r], "column": [stack_stc, stack_stc]});
                                    }
                                    else if(stack_edc != null){
                                        rangeArr.push({"row": [st_r, ed_r], "column": [stack_stc, stack_edc]});
                                    }
                                }
                            }
                            else{
                                if(eval(str)){
                                    if(stack_stc == null){
                                        stack_stc = c;
                                    }
                                    else{
                                        stack_edc = c;
                                    }
                                }
                                else{
                                    if(stack_edc == null && stack_stc != null){
                                        rangeArr.push({"row": [st_r, ed_r], "column": [stack_stc, stack_stc]});
                                        stack_stc = null;
                                    }
                                    else if(stack_edc != null){
                                        rangeArr.push({"row": [st_r, ed_r], "column": [stack_stc, stack_edc]});
                                        stack_stc = null;
                                        stack_edc = null;
                                    }
                                }
                            }
                        }
                    }
                    else{
                        var stack = {}; 

                        for(var r = st_r; r <= ed_r; r++){
                            stack[r] = [];
                            var stack_stc = null, stack_edc = null;

                            for(var c = st_c; c <= ed_c; c++){
                                if(c == ed_c){
                                    if(eval(str)){
                                        if(stack_stc == null){
                                            stack[r].push({"status": false, "range": [ed_c, ed_c]});
                                        }
                                        else{
                                            stack[r].push({"status": false, "range": [stack_stc, ed_c]});   
                                        }
                                    }
                                    else{
                                        if(stack_edc == null && stack_stc != null){
                                            stack[r].push({"status": false, "range": [stack_stc, stack_stc]});
                                        }
                                        else if(stack_edc != null){
                                            stack[r].push({"status": false, "range": [stack_stc, stack_edc]});
                                        }
                                    }
                                }
                                else if(c == st_c){
                                    if(eval(str)){
                                        stack_stc = c;
                                    }
                                    else{
                                        stack_stc = null;
                                    }
                                }
                                else{
                                    if(eval(str)){
                                        if(stack_stc == null){
                                            stack_stc = c;
                                        }
                                        else{
                                            stack_edc = c;
                                        }
                                    }
                                    else{
                                        if(stack_edc == null && stack_stc != null){
                                            stack[r].push({"status": false, "range": [stack_stc, stack_stc]});
                                            stack_stc = null;
                                        }
                                        else if(stack_edc != null){
                                            stack[r].push({"status": false, "range": [stack_stc, stack_edc]});
                                            stack_stc = null;
                                            stack_edc = null;
                                        }
                                    }
                                }
                            }
                        }

                        for(var i = st_r; i <= ed_r; i++){
                            if(i == ed_r){
                                if(stack[i].length > 0){
                                    for(var j = 0; j < stack[i].length; j++){
                                        if(!stack[i][j].status){
                                            rangeArr.push({"row": [ed_r, ed_r], "column": stack[i][j].range});
                                        }
                                    }
                                }
                            }
                            else{
                                if(stack[i].length > 0){
                                    for(var j = 0; j < stack[i].length; j++){
                                        if(!stack[i][j].status){
                                            var b = 0;
                                            
                                            for(var a = 1; a < (ed_r - i); a++){
                                                if(stack[i + a][j] != null && stack[i + a][j].range[0] == stack[i][j].range[0] && stack[i + a][j].range[1] == stack[i][j].range[1]){
                                                    b = a;
                                                    stack[i + a][j].status = true;
                                                }
                                                else{
                                                    break;
                                                }     
                                            }

                                            rangeArr.push({"row": [i, i + b], "column": stack[i][j].range});
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
            else if(type == "locationStepRow"){ //间隔行
                for(var s = 0; s < range.length; s++){
                    if(range[s].row[0] == range[s].row[1]){
                        continue;
                    }

                    var st_r = range[s].row[0], ed_r = range[s].row[1];
                    var st_c = range[s].column[0], ed_c = range[s].column[1];

                    for(var r = st_r; r <= ed_r; r++){
                        if((r - st_r) % 2 == 0){
                            rangeArr.push({"row": [r, r], "column": [st_c, ed_c]});
                        }
                    }
                }
            }
            else if(type == "locationStepColumn"){ //间隔列
                for(var s = 0; s < range.length; s++){
                    if(range[s].column[0] == range[s].column[1]){
                        continue;
                    }

                    var st_r = range[s].row[0], ed_r = range[s].row[1];
                    var st_c = range[s].column[0], ed_c = range[s].column[1];

                    for(var c = st_c; c <= ed_c; c++){
                        if((c - st_c) % 2 == 0){
                            rangeArr.push({"row": [st_r, ed_r], "column": [c, c]});
                        }
                    }
                }
            }

            if(rangeArr.length == 0){
                if(jfgrid.isEditMode()){
                    alert("未找到单元格");
                }
                else{
                    jfgrid.tooltip.info("提示", "未找到单元格");  
                }
            }
            else{
                jfgird_select_save = rangeArr;
                jfgrid.selectHightlightShow(); 

                var scrollLeft = $("#jfgrid-cell-main").scrollLeft(), scrollTop = $("#jfgrid-cell-main").scrollTop();
                var winH = $("#jfgrid-cell-main").height(), winW = $("#jfgrid-cell-main").width();

                var row = visibledatarow[jfgird_select_save[0]["row"][1]], row_pre = jfgird_select_save[0]["row"][0] - 1 == -1 ? 0 : visibledatarow[jfgird_select_save[0]["row"][0] - 1];
                var col = visibledatacolumn[jfgird_select_save[0]["column"][1]], col_pre = jfgird_select_save[0]["column"][0] - 1 == -1 ? 0 : visibledatacolumn[jfgird_select_save[0]["column"][0] - 1];

                if (col - scrollLeft - winW + 20 > 0) {
                    $("#jfgrid-scrollbar-x").scrollLeft(col - winW + 20);
                }
                else if (col_pre - scrollLeft - 20 < 0) {
                    $("#jfgrid-scrollbar-x").scrollLeft(col_pre - 20);
                }

                if (row - scrollTop - winH + 20 > 0) {
                    $("#jfgrid-scrollbar-y").scrollTop(row - winH + 20);
                }
                else if (row_pre - scrollTop - 20 < 0) {
                    $("#jfgrid-scrollbar-y").scrollTop(row_pre - 20);
                }
            }
        }
    }

    //更多格式
    jfgrid.moreFormat = {
        moneyFmtList: [
            {
                "name": "人民币",
                "pos": "before",
                "value": "¥"
            }, {
                "name": "美元",
                "pos": "before",
                "value": "$"
            }, {
                "name": "欧元",
                "pos": "before",
                "value": "€"
            }, {
                "name": "英镑",
                "pos": "before",
                "value": "￡"
            }, {
                "name": "港元",
                "pos": "before",
                "value": "$"
            }, {
                "name": "日元",
                "pos": "before",
                "value": "￥"
            }, {
                "name": "阿尔巴尼亚列克",
                "pos": "before",
                "value": "Lek"
            }, {
                "name": "阿尔及利亚第纳尔",
                "pos": "before",
                "value": "din"
            }, {
                "name": "阿富汗尼",
                "pos": "after",
                "value": "Af"
            }, {
                "name": "阿根廷比索",
                "pos": "before",
                "value": "$"
            }, {
                "name": "阿拉伯联合酋长国迪拉姆",
                "pos": "before",
                "value": "dh"
            }, {
                "name": "阿鲁巴弗罗林",
                "pos": "before",
                "value": "Afl"
            }, {
                "name": "阿曼里亚尔",
                "pos": "before",
                "value": "Rial"
            }, {
                "name": "阿塞拜疆马纳特",
                "pos": "before",
                "value": "?"
            }, {
                "name": "埃及镑",
                "pos": "before",
                "value": "￡"
            }, {
                "name": "埃塞俄比亚比尔",
                "pos": "before",
                "value": "Birr"
            }, {
                "name": "安哥拉宽扎",
                "pos": "before",
                "value": "Kz"
            }, {
                "name": "澳大利亚元",
                "pos": "before",
                "value": "$"
            }, {
                "name": "澳门元",
                "pos": "before",
                "value": "MOP"
            }, {
                "name": "巴巴多斯元",
                "pos": "before",
                "value": "$"
            }, {
                "name": "巴布亚新几内亚基那",
                "pos": "before",
                "value": "PGK"
            }, {
                "name": "巴哈马元",
                "pos": "before",
                "value": "$"
            }, {
                "name": "巴基斯坦卢比",
                "pos": "before",
                "value": "Rs"
            }, {
                "name": "巴拉圭瓜拉尼",
                "pos": "after",
                "value": "Gs"
            }, {
                "name": "巴林第纳尔",
                "pos": "before",
                "value": "din"
            }, {
                "name": "巴拿马巴波亚",
                "pos": "before",
                "value": "B/"
            }, {
                "name": "巴西里亚伊",
                "pos": "before",
                "value": "R$"
            }, {
                "name": "白俄罗斯卢布",
                "pos": "after",
                "value": "р"
            }, {
                "name": "百慕大元",
                "pos": "before",
                "value": "$"
            }, {
                "name": "保加利亚列弗",
                "pos": "before",
                "value": "lev"
            }, {
                "name": "冰岛克朗",
                "pos": "before",
                "value": "kr"
            }, {
                "name": "波黑可兑换马克",
                "pos": "before",
                "value": "KM"
            }, {
                "name": "波兰兹罗提",
                "pos": "after",
                "value": "z?"
            }, {
                "name": "玻利维亚诺",
                "pos": "before",
                "value": "Bs"
            }, {
                "name": "伯利兹元",
                "pos": "before",
                "value": "$"
            }, {
                "name": "博茨瓦纳普拉",
                "pos": "before",
                "value": "P"
            }, {
                "name": "不丹努扎姆",
                "pos": "before",
                "value": "Nu"
            }, {
                "name": "布隆迪法郎",
                "pos": "before",
                "value": "FBu"
            }, {
                "name": "朝鲜圆",
                "pos": "before",
                "value": "?KP"
            }, {
                "name": "丹麦克朗",
                "pos": "after",
                "value": "kr"
            }, {
                "name": "东加勒比元",
                "pos": "before",
                "value": "$"
            }, {
                "name": "多米尼加比索",
                "pos": "before",
                "value": "RD$"
            }, {
                "name": "俄国卢布",
                "pos": "after",
                "value": "?"
            }, {
                "name": "厄立特里亚纳克法",
                "pos": "before",
                "value": "Nfk"
            }, {
                "name": "非洲金融共同体法郎",
                "pos": "before",
                "value": "CFA"
            }, {
                "name": "菲律宾比索",
                "pos": "before",
                "value": "?"
            }, {
                "name": "斐济元",
                "pos": "before",
                "value": "$"
            }, {
                "name": "佛得角埃斯库多",
                "pos": "before",
                "value": "CVE"
            }, {
                "name": "福克兰群岛镑",
                "pos": "before",
                "value": "￡"
            }, {
                "name": "冈比亚达拉西",
                "pos": "before",
                "value": "GMD"
            }, {
                "name": "刚果法郎",
                "pos": "before",
                "value": "FrCD"
            }, {
                "name": "哥伦比亚比索",
                "pos": "before",
                "value": "$"
            }, {
                "name": "哥斯达黎加科朗",
                "pos": "before",
                "value": "?"
            }, {
                "name": "古巴比索",
                "pos": "before",
                "value": "$"
            }, {
                "name": "古巴可兑换比索",
                "pos": "before",
                "value": "$"
            }, {
                "name": "圭亚那元",
                "pos": "before",
                "value": "$"
            }, {
                "name": "哈萨克斯坦坚戈",
                "pos": "before",
                "value": "?"
            }, {
                "name": "海地古德",
                "pos": "before",
                "value": "HTG"
            }, {
                "name": "韩元",
                "pos": "before",
                "value": "?"
            }, {
                "name": "荷属安的列斯盾",
                "pos": "before",
                "value": "NAf."
            }, {
                "name": "洪都拉斯拉伦皮拉",
                "pos": "before",
                "value": "L"
            }, {
                "name": "吉布提法郎",
                "pos": "before",
                "value": "Fdj"
            }, {
                "name": "吉尔吉斯斯坦索姆",
                "pos": "before",
                "value": "KGS"
            }, {
                "name": "几内亚法郎",
                "pos": "before",
                "value": "FG"
            }, {
                "name": "加拿大元",
                "pos": "before",
                "value": "$"
            }, {
                "name": "加纳塞地",
                "pos": "before",
                "value": "GHS"
            }, {
                "name": "柬埔寨瑞尔",
                "pos": "before",
                "value": "Riel"
            }, {
                "name": "捷克克朗",
                "pos": "after",
                "value": "K?"
            }, {
                "name": "津巴布韦元",
                "pos": "before",
                "value": "$"
            }, {
                "name": "卡塔尔里亚尔",
                "pos": "before",
                "value": "Rial"
            }, {
                "name": "开曼群岛元",
                "pos": "before",
                "value": "$"
            }, {
                "name": "科摩罗法郎",
                "pos": "before",
                "value": "CF"
            }, {
                "name": "科威特第纳尔",
                "pos": "before",
                "value": "din"
            }, {
                "name": "克罗地亚库纳",
                "pos": "before",
                "value": "kn"
            }, {
                "name": "肯尼亚先令",
                "pos": "before",
                "value": "Ksh"
            }, {
                "name": "莱索托洛蒂",
                "pos": "before",
                "value": "LSL"
            }, {
                "name": "老挝基普",
                "pos": "before",
                "value": "?"
            }, {
                "name": "黎巴嫩镑",
                "pos": "before",
                "value": "L￡"
            }, {
                "name": "立陶宛立特",
                "pos": "before",
                "value": "Lt"
            }, {
                "name": "利比亚第纳尔",
                "pos": "before",
                "value": "din"
            }, {
                "name": "利比亚元",
                "pos": "before",
                "value": "$"
            }, {
                "name": "卢旺达法郎",
                "pos": "before",
                "value": "RF"
            }, {
                "name": "罗马尼亚列伊",
                "pos": "before",
                "value": "RON"
            }, {
                "name": "马达加斯加阿里亚里",
                "pos": "before",
                "value": "Ar"
            }, {
                "name": "马尔代夫拉菲亚",
                "pos": "before",
                "value": "Rf"
            }, {
                "name": "马拉维克瓦查",
                "pos": "before",
                "value": "MWK"
            }, {
                "name": "马来西亚林吉特",
                "pos": "before",
                "value": "RM"
            }, {
                "name": "马其顿戴第纳尔",
                "pos": "before",
                "value": "din"
            }, {
                "name": "毛里求斯卢比",
                "pos": "before",
                "value": "MURs"
            }, {
                "name": "毛里塔尼亚乌吉亚",
                "pos": "before",
                "value": "MRO"
            }, {
                "name": "蒙古图格里克",
                "pos": "before",
                "value": "?"
            }, {
                "name": "孟加拉塔卡",
                "pos": "before",
                "value": "?"
            }, {
                "name": "秘鲁新索尔",
                "pos": "before",
                "value": "S/"
            }, {
                "name": "缅甸开亚特",
                "pos": "before",
                "value": "K"
            }, {
                "name": "摩尔多瓦列伊",
                "pos": "before",
                "value": "MDL"
            }, {
                "name": "摩洛哥迪拉姆",
                "pos": "before",
                "value": "dh"
            }, {
                "name": "莫桑比克梅蒂卡尔",
                "pos": "before",
                "value": "MTn"
            }, {
                "name": "墨西哥比索",
                "pos": "before",
                "value": "$"
            }, {
                "name": "纳米比亚元",
                "pos": "before",
                "value": "$"
            }, {
                "name": "南非兰特",
                "pos": "before",
                "value": "R"
            }, {
                "name": "南苏丹镑",
                "pos": "before",
                "value": "￡"
            }, {
                "name": "尼加拉瓜科多巴",
                "pos": "before",
                "value": "C$"
            }, {
                "name": "尼泊尔卢比",
                "pos": "before",
                "value": "Rs"
            }, {
                "name": "尼日利亚奈拉",
                "pos": "before",
                "value": "?"
            }, {
                "name": "挪威克朗",
                "pos": "after",
                "value": "kr"
            }, {
                "name": "乔治亚拉瑞",
                "pos": "before",
                "value": "GEL"
            }, {
                "name": "人民币（离岸）",
                "pos": "before",
                "value": "￥"
            }, {
                "name": "瑞典克朗",
                "pos": "after",
                "value": "kr"
            }, {
                "name": "瑞士法郎",
                "pos": "before",
                "value": "CHF"
            }, {
                "name": "塞尔维亚第纳尔",
                "pos": "before",
                "value": "din"
            }, {
                "name": "塞拉利昂利昂",
                "pos": "before",
                "value": "SLL"
            }, {
                "name": "塞舌尔卢比",
                "pos": "before",
                "value": "SCR"
            }, {
                "name": "沙特里亚尔",
                "pos": "before",
                "value": "Rial"
            }, {
                "name": "圣多美多布拉",
                "pos": "before",
                "value": "Db"
            }, {
                "name": "圣赫勒拿群岛磅",
                "pos": "before",
                "value": "￡"
            }, {
                "name": "斯里兰卡卢比",
                "pos": "before",
                "value": "Rs"
            }, {
                "name": "斯威士兰里兰吉尼",
                "pos": "before",
                "value": "SZL"
            }, {
                "name": "苏丹镑",
                "pos": "before",
                "value": "SDG"
            }, {
                "name": "苏里南元",
                "pos": "before",
                "value": "$"
            }, {
                "name": "所罗门群岛元",
                "pos": "before",
                "value": "$"
            }, {
                "name": "索马里先令",
                "pos": "before",
                "value": "SOS"
            }, {
                "name": "塔吉克斯坦索莫尼",
                "pos": "before",
                "value": "Som"
            }, {
                "name": "太平洋法郎",
                "pos": "after",
                "value": "FCFP"
            }, {
                "name": "泰国铢",
                "pos": "before",
                "value": "?"
            }, {
                "name": "坦桑尼亚先令",
                "pos": "before",
                "value": "TSh"
            }, {
                "name": "汤加潘加",
                "pos": "before",
                "value": "T$"
            }, {
                "name": "特立尼达和多巴哥元",
                "pos": "before",
                "value": "$"
            }, {
                "name": "突尼斯第纳尔",
                "pos": "before",
                "value": "din"
            }, {
                "name": "土耳其里拉",
                "pos": "before",
                "value": "?"
            }, {
                "name": "瓦努阿图瓦图",
                "pos": "before",
                "value": "VUV"
            }, {
                "name": "危地马拉格查尔",
                "pos": "before",
                "value": "Q"
            }, {
                "name": "委内瑞拉博利瓦",
                "pos": "before",
                "value": "Bs"
            }, {
                "name": "文莱元",
                "pos": "before",
                "value": "$"
            }, {
                "name": "乌干达先令",
                "pos": "before",
                "value": "UGX"
            }, {
                "name": "乌克兰格里夫尼亚",
                "pos": "before",
                "value": "грн."
            }, {
                "name": "乌拉圭比索",
                "pos": "before",
                "value": "$"
            }, {
                "name": "乌兹别克斯坦苏姆",
                "pos": "before",
                "value": "so?m"
            }, {
                "name": "西萨摩亚塔拉",
                "pos": "before",
                "value": "WST"
            }, {
                "name": "新加坡元",
                "pos": "before",
                "value": "$"
            }, {
                "name": "新台币",
                "pos": "before",
                "value": "NT$"
            }, {
                "name": "新西兰元",
                "pos": "before",
                "value": "$"
            }, {
                "name": "匈牙利福林",
                "pos": "before",
                "value": "Ft"
            }, {
                "name": "叙利亚镑",
                "pos": "before",
                "value": "￡"
            }, {
                "name": "牙买加元",
                "pos": "before",
                "value": "$"
            }, {
                "name": "亚美尼亚德拉姆",
                "pos": "before",
                "value": "Dram"
            }, {
                "name": "也门里亚尔",
                "pos": "before",
                "value": "Rial"
            }, {
                "name": "伊拉克第纳尔",
                "pos": "before",
                "value": "din"
            }, {
                "name": "伊朗里亚尔",
                "pos": "before",
                "value": "Rial"
            }, {
                "name": "以色列新谢克尔",
                "pos": "before",
                "value": "?"
            }, {
                "name": "印度卢比",
                "pos": "before",
                "value": "?"
            }, {
                "name": "印度尼西亚卢比",
                "pos": "before",
                "value": "Rp"
            }, {
                "name": "约旦第纳尔",
                "pos": "before",
                "value": "din"
            }, {
                "name": "越南盾",
                "pos": "after",
                "value": "?"
            }, {
                "name": "赞比亚克瓦查",
                "pos": "before",
                "value": "ZMW"
            }, {
                "name": "直布罗陀镑",
                "pos": "before",
                "value": "￡"
            }, {
                "name": "智利比索",
                "pos": "before",
                "value": "$"
            }, {
                "name": "中非金融合作法郎",
                "pos": "before",
                "value": "FCFA"
            }
        ],
        dateFmtList: [
            {
                "name": "1930-08-05",
                "value": "yyyy-MM-dd"
            },
            {
                "name": "1930/8/5",
                "value": "yyyy/MM/dd"
            },
            {
                "name": "1930年8月5日",
                "value": 'yyyy"年"M"月"d"日"'
            },
            {
                "name": "08-05",
                "value": "MM-dd"
            },
            {
                "name": "8-5",
                "value": "M-d"
            },
            {
                "name": "8月5日",
                "value": 'M"月"d"日"'
            },
            {
                "name": "13:30:30",
                "value": "h:mm:ss"
            },
            {
                "name": "13:30",
                "value": "h:mm"
            },
            {
                "name": "下午01:30",
                "value": 'AM/PM hh:mm'
            },
            {
                "name": "下午1:30",
                "value": 'AM/PM h:mm'
            },
            {
                "name": "下午1:30:30",
                "value": 'AM/PM h:mm:ss'
            },
            {
                "name": "08-05 下午01:30",
                "value": "MM-dd AM/PM hh:mm"
            },
            // {
            //     "name": "1930年8月5日星期二",
            //     "value": ''
            // },
            // {
            //     "name": "1930年8月5日星期二 下午1:30:30",
            //     "value": ''
            // },
        ],
        numFmtList: [
            {
                "name": "1235",
                "value": "0"
            },
            {
                "name": "1234.56",
                "value": "0.00"
            },
            {
                "name": "1,235",
                "value": "#,##0"
            },
            {
                "name": "1,234.56",
                "value": "#,##0.00"
            },
            {
                "name": "1,235",
                "value": "#,##0_);(#,##0)"
            },
            {
                "name": "1,235",
                "value": "#,##0_);[Red](#,##0)"
            },
            {
                "name": "1,234.56",
                "value": "#,##0.00_);(#,##0.00)"
            },
            {
                "name": "1,234.56",
                "value": "#,##0.00_);[Red](#,##0.00)"
            },
            {
                "name": "$1,235",
                "value": "$#,##0_);($#,##0)"
            },
            {
                "name": "$1,235",
                "value": "$#,##0_);[Red]($#,##0)"
            },
            {
                "name": "$1,234.56",
                "value": "$#,##0.00_);($#,##0.00)"
            },
            {
                "name": "$1,234.56",
                "value": "$#,##0.00_);[Red]($#,##0.00)"
            },
            {
                "name": "1234.56",
                "value": "@"
            },
            {
                "name": "123456%",
                "value": "0%"
            },
            {
                "name": "123456.00%",
                "value": "0.00%"
            },
            {
                "name": "1.23E+03",
                "value": "0.00E+00"
            },
            {
                "name": "1.2E+3",
                "value": "##0.0E+0"
            },
            {
                "name": "1234 5/9",
                "value": "# ?/?"
            },
            {
                "name": "1234 14/25",
                "value": "# ??/??"
            },
            {
                "name": "$ 1,235",
                "value": '_($* #,##0_);_(...($* "-"_);_(@_)'
            },
            {
                "name": "1,235",
                "value": '_(* #,##0_);_(*..._(* "-"_);_(@_)'
            },
            {
                "name": "$ 1,234.56",
                // "value": '_($* #,##0.00_)...* "-"??_);_(@_)'
                "value": '_($* #,##0.00_);_(...($* "-"_);_(@_)'
            },
            {
                "name": "1,234.56",
                "value": '_(* #,##0.00_);...* "-"??_);_(@_)'
            },
        ],
        createDialog: function(type){
            $("#jfgrid-modal-dialog-mask").show();
            $("#jfgrid-moreFormat-dialog").remove();

            var title = "", content = '';
            if(type == "morecurrency"){ //货币
                title = "货币格式";

                var listHtml = '';
                for(var i = 0; i < jfgrid.moreFormat.moneyFmtList.length; i++){
                    var name = jfgrid.moreFormat.moneyFmtList[i]["name"];
                    var pos = jfgrid.moreFormat.moneyFmtList[i]["pos"];
                    var value = jfgrid.moreFormat.moneyFmtList[i]["value"];

                    listHtml += '<div class="listItem">'+
                                    '<div class="name">'+ name +'</div>'+
                                    '<div class="value">'+ value +'</div>'+
                                    '<input type="hidden" value="'+ pos +'"/>'+
                                '</div>';
                }

                content = '<div class="box" id="morecurrency">'+
                            '<div class="decimal">'+
                                '<label>小数位数：</label>'+
                                '<input type="number" class="formulaInputFocus" value="2" min="0" max="9"/>'+
                            '</div>'+
                            '<div class="listbox">'+ listHtml +'</div>'+
                          '</div>';
            }
            else if(type == "moredatetime"){ //日期时间
                title = "日期与时间格式";

                var listHtml = '';
                for(var i = 0; i < jfgrid.moreFormat.dateFmtList.length; i++){
                    var name = jfgrid.moreFormat.dateFmtList[i]["name"];
                    var value = jfgrid.moreFormat.dateFmtList[i]["value"];

                    listHtml += '<div class="listItem">'+
                                    '<div class="name">'+ name +'</div>'+
                                    '<div class="value">'+ value +'</div>'+
                                '</div>';
                }

                content = '<div class="box" id="moredatetime">'+
                            '<div class="listbox">'+ listHtml +'</div>'+
                          '</div>';
            }
            else if(type == "moredigit"){ //数字
                title = "数字格式";

                var listHtml = '';
                for(var i = 0; i < jfgrid.moreFormat.numFmtList.length; i++){
                    var name = jfgrid.moreFormat.numFmtList[i]["name"];
                    var value = jfgrid.moreFormat.numFmtList[i]["value"];

                    listHtml += '<div class="listItem">'+
                                    '<div class="name">'+ name +'</div>'+
                                    '<div class="value">'+ value +'</div>'+
                                '</div>';
                }

                content = '<div class="box" id="moredigit">'+
                            '<div class="listbox">'+ listHtml +'</div>'+
                          '</div>';
            }

            $("body").append(jfgrid.replaceHtml(modelHTML, { "id": "jfgrid-moreFormat-dialog", "addclass": "jfgrid-moreFormat-dialog", "title": title, "content": content, "botton": '<button id="jfgrid-moreFormat-dialog-confirm" class="btn btn-primary">确定</button><button class="btn btn-default jfgrid-model-close-btn">取消</button>', "style": "z-index:100003" }));
            var $t = $("#jfgrid-moreFormat-dialog").find(".jfgrid-modal-dialog-content").css("min-width", 400).end(), myh = $t.outerHeight(), myw = $t.outerWidth();
            var winw = $(window).width(), winh = $(window).height();
            var scrollLeft = $(document).scrollLeft(), scrollTop = $(document).scrollTop();
            $("#jfgrid-moreFormat-dialog").css({ "left": (winw + scrollLeft - myw) / 2, "top": (winh + scrollTop - myh) / 3 }).show();
            
            $("#jfgrid-moreFormat-dialog .listbox .listItem").eq(0).addClass("on");
        },
        init: function(){
            //选择格式
            $(document).on("click", "#jfgrid-moreFormat-dialog .listbox .listItem", function(){
                $(this).addClass("on").siblings().removeClass("on");
            });

            //确定
            $(document).off("click.moreFormatConfirm").on("click.moreFormatConfirm", "#jfgrid-moreFormat-dialog #jfgrid-moreFormat-dialog-confirm", function(){
                $("#jfgrid-moreFormat-dialog").hide();
                $("#jfgrid-modal-dialog-mask").hide();

                var d = jfgrid.editor.deepCopyFlowData(jfgrid.flowdata);

                var value = $("#jfgrid-moreFormat-dialog .listbox .listItem.on .value").text();
                var id = $(this).parents("#jfgrid-moreFormat-dialog").find(".box").attr("id");

                if(id == "morecurrency"){ //货币
                    if(value.indexOf("?") != -1){
                        return;
                    }

                    var decimal = parseInt($("#jfgrid-moreFormat-dialog .decimal input").val().trim());

                    if(decimal.toString() == "NaN" || decimal < 0 || decimal > 9){
                        if(jfgrid.isEditMode()){
                            alert("小数位数必须在0-9之间！");
                        }   
                        else{
                            jfgrid.tooltip.info("小数位数必须在0-9之间！", "");
                        }

                        return;
                    }

                    var str = "";
                    if(decimal > 0){
                        for(var i = 1; i <= decimal; i++){
                            str += "0";
                        }
                        str = "0." + str;
                    }
                    else{
                        str = "#";
                    }

                    var pos = $("#jfgrid-moreFormat-dialog .listbox .listItem.on input:hidden").val();

                    if(pos == "before"){
                        str = '"'+value+'" ' + str;
                    }
                    else if(pos == "after"){
                        str = str + ' "'+value+'"';
                    }

                    jfgrid.menuButton.updateFormat(d, "ct", str);
                }
                else if(id == "moredatetime"){ //日期时间
                    jfgrid.menuButton.updateFormat(d, "ct", value);
                }
                else if(id == "moredigit"){ //数字
                    jfgrid.menuButton.updateFormat(d, "ct", value);
                }
            })
        }
    }

    //查找替换
    jfgrid.searchReplace = {
        createDialog: function(source){
            $("#jfgrid-modal-dialog-mask").hide();
            $("#jfgrid-search-replace").remove();

            var content = '<div class="tabBox">' +
                            '<span id="searchTab">查找</span>' +
                            '<span id="replaceTab">替换</span>' +
                          '</div>' +
                          '<div class="ctBox">' +
                            '<div class="inputBox">' +
                                '<div class="textboxs" id="searchInput">查找内容：<input class="formulaInputFocus" spellcheck="false" value=""/></div>' +
                                '<div class="textboxs" id="replaceInput">替换内容：<input class="formulaInputFocus" spellcheck="false" value=""/></div>' +
                                '<div class="checkboxs">' +
                                    '<div id="regCheck">' +
                                        '<input type="checkbox"/>' +
                                        '<span>正则表达式匹配</span>' +
                                    '</div>' +    
                                    '<div id="wordCheck">' +
                                        '<input type="checkbox"/>' +
                                        '<span>整词匹配</span>' +
                                    '</div>' +    
                                    '<div id="caseCheck">' +
                                        '<input type="checkbox"/>' +
                                        '<span>区分大小写匹配</span>' +
                                    '</div>' +    
                                '</div>' +
                            '</div>' +
                            '<div class="btnBox">' +
                                '<button id="replaceAllBtn" class="btn btn-default">全部替换</button>' +
                                '<button id="replaceBtn" class="btn btn-default">替换</button>' +
                                '<button id="searchAllBtn" class="btn btn-default">查找全部</button>' +
                                '<button id="searchNextBtn" class="btn btn-default">查找下一个</button>' +
                            '</div>' +
                          '</div>';

            $("body").append(jfgrid.replaceHtml(modelHTML, { "id": "jfgrid-search-replace", "addclass": "jfgrid-search-replace", "title": "", "content": content, "botton": '<button class="btn btn-default jfgrid-model-close-btn">关闭</button>', "style": "z-index:100003" }));
            var $t = $("#jfgrid-search-replace").find(".jfgrid-modal-dialog-content").css("min-width", 400).end(), myh = $t.outerHeight(), myw = $t.outerWidth();
            var winw = $(window).width(), winh = $(window).height();
            var scrollLeft = $(document).scrollLeft(), scrollTop = $(document).scrollTop();
            $("#jfgrid-search-replace").css({ "left": (winw + scrollLeft - myw) / 2, "top": (winh + scrollTop - myh) / 3 }).show();
        
            if(source == "0"){
                $("#jfgrid-search-replace #searchTab").addClass("on").siblings().removeClass("on");
                $("#jfgrid-search-replace #replaceInput").hide();
                $("#jfgrid-search-replace #replaceAllBtn").hide();
                $("#jfgrid-search-replace #replaceBtn").hide();
            }
            else if(source == "1"){
                $("#jfgrid-search-replace #replaceTab").addClass("on").siblings().removeClass("on");
                $("#jfgrid-search-replace #replaceInput").show();
                $("#jfgrid-search-replace #replaceAllBtn").show();
                $("#jfgrid-search-replace #replaceBtn").show();
            }
        },
        init: function(){
            //查找替换 切换
            $(document).off("click.SRtabBoxspan").on("click.SRtabBoxspan", "#jfgrid-search-replace .tabBox span", function(){
                $(this).addClass("on").siblings().removeClass("on");

                var $id = $(this).attr("id");
                if($id == "searchTab"){
                    $("#jfgrid-search-replace #replaceInput").hide();
                    $("#jfgrid-search-replace #replaceAllBtn").hide();
                    $("#jfgrid-search-replace #replaceBtn").hide();

                    $("#jfgrid-search-replace #searchInput input").focus();
                }
                else if($id == "replaceTab"){
                    $("#jfgrid-search-replace #replaceInput").show();
                    $("#jfgrid-search-replace #replaceAllBtn").show();
                    $("#jfgrid-search-replace #replaceBtn").show();

                    $("#jfgrid-search-replace #replaceInput input").focus();
                }
            });

            //查找下一个
            $(document).off("keyup.SRsearchInput").on("keyup.SRsearchInput", "#jfgrid-search-replace #searchInput input", function(event){
                var kcode = event.keyCode;
                if(kcode == keycode.ENTER){
                    jfgrid.searchReplace.searchNext();
                }
            });
            $(document).off("click.SRsearchNextBtn").on("click.SRsearchNextBtn", "#jfgrid-search-replace #searchNextBtn", function(){
                jfgrid.searchReplace.searchNext();
            });

            //查找全部
            $(document).off("click.SRsearchAllBtn").on("click.SRsearchAllBtn", "#jfgrid-search-replace #searchAllBtn", function(){
                jfgrid.searchReplace.searchAll();
            });
            $(document).off("click.SRsearchAllboxItem").on("click.SRsearchAllboxItem", "#jfgrid-search-replace #searchAllbox .boxItem", function(){
                $(this).addClass("on").siblings().removeClass("on");

                var r = $(this).attr("data-row");
                var c = $(this).attr("data-col");
                var sheetIndex = $(this).attr("data-sheetIndex");

                if(sheetIndex != jfgrid.currentSheetIndex){
                    jfgrid.sheetmanage.changeSheetExec(sheetIndex);
                }

                jfgird_select_save = [
                    { "row": [r, r], "column": [c, c] }
                ];

                jfgrid.selectHightlightShow();

                var scrollLeft = $("#jfgrid-cell-main").scrollLeft(), scrollTop = $("#jfgrid-cell-main").scrollTop();
                var winH = $("#jfgrid-cell-main").height(), winW = $("#jfgrid-cell-main").width();

                var row = visibledatarow[r], row_pre = r - 1 == -1 ? 0 : visibledatarow[r - 1];
                var col = visibledatacolumn[c], col_pre = c - 1 == -1 ? 0 : visibledatacolumn[c - 1];

                if (col - scrollLeft - winW + 20 > 0) {
                    $("#jfgrid-scrollbar-x").scrollLeft(col - winW + 20);
                }
                else if (col_pre - scrollLeft - 20 < 0) {
                    $("#jfgrid-scrollbar-x").scrollLeft(col_pre - 20);
                }

                if (row - scrollTop - winH + 20 > 0) {
                    $("#jfgrid-scrollbar-y").scrollTop(row - winH + 20);
                }
                else if (row_pre - scrollTop - 20 < 0) {
                    $("#jfgrid-scrollbar-y").scrollTop(row_pre - 20);
                }
            });

            //替换
            $(document).off("click.SRreplaceBtn").on("click.SRreplaceBtn", "#jfgrid-search-replace #replaceBtn", function(){
                jfgrid.searchReplace.replace();
            });

            //全部替换
            $(document).off("click.SRreplaceAllBtn").on("click.SRreplaceAllBtn", "#jfgrid-search-replace #replaceAllBtn", function(){
                jfgrid.searchReplace.replaceAll();
            });
        },
        searchNext: function(){
            var searchText = $("#jfgrid-search-replace #searchInput input").val();

            if(searchText == "" || searchText == null){
                return;
            }

            if(jfgird_select_save.length == 0 || (jfgird_select_save.length == 1 && jfgird_select_save[0].row[0] == jfgird_select_save[0].row[1] && jfgird_select_save[0].column[0] == jfgird_select_save[0].column[1])){
                var range = [{ "row": [0, jfgrid.flowdata.length - 1], "column": [0, jfgrid.flowdata[0].length - 1] }];
            }
            else{
                var range = $.extend(true, [], jfgird_select_save);                
            }

            var searchIndexArr = jfgrid.searchReplace.getSearchIndexArr(searchText, range);

            if(searchIndexArr.length == 0){
                if(jfgrid.isEditMode()){
                    alert("没有查找到该内容");
                }
                else{
                    jfgrid.tooltip.info("没有查找到该内容", "");
                }

                return;
            }

            var count = 0;

            if(jfgird_select_save.length == 0 || (jfgird_select_save.length == 1 && jfgird_select_save[0].row[0] == jfgird_select_save[0].row[1] && jfgird_select_save[0].column[0] == jfgird_select_save[0].column[1])){
                if(jfgird_select_save.length == 0){
                    count = 0;
                }
                else{
                    for(var i = 0; i < searchIndexArr.length; i++){
                        if(searchIndexArr[i].r == jfgird_select_save[0].row[0] && searchIndexArr[i].c == jfgird_select_save[0].column[0]){
                            if(i == searchIndexArr.length - 1){
                                count = 0;
                            }
                            else{
                                count = i + 1;
                            }

                            break;
                        }
                    }
                }

                jfgird_select_save = [
                    { "row": [searchIndexArr[count].r, searchIndexArr[count].r], "column": [searchIndexArr[count].c, searchIndexArr[count].c] }
                ];

                
            }
            else{
                var rf = range[range.length - 1].row_focus;
                var cf = range[range.length - 1].column_focus;

                for(var i = 0; i < searchIndexArr.length; i++){
                    if(searchIndexArr[i].r == rf && searchIndexArr[i].c == cf){
                        if(i == searchIndexArr.length - 1){
                            count = 0;
                        }
                        else{
                            count = i + 1;
                        }

                        break;
                    }
                }

                for(var s = 0; s < range.length; s++){
                    var r1 = range[s].row[0], r2 = range[s].row[1];
                    var c1 = range[s].column[0], c2 = range[s].column[1];

                    if(searchIndexArr[count].r >= r1 && searchIndexArr[count].r <= r2 && searchIndexArr[count].c >= c1 && searchIndexArr[count].c <= c2){
                        var obj = range[s];
                        obj["row_focus"] = searchIndexArr[count].r;
                        obj["column_focus"] = searchIndexArr[count].c;
                        range.splice(s, 1);
                        range.push(obj);

                        break;
                    }
                }

                jfgird_select_save = range;
            }

            jfgrid.selectHightlightShow();

            var scrollLeft = $("#jfgrid-cell-main").scrollLeft(), scrollTop = $("#jfgrid-cell-main").scrollTop();
            var winH = $("#jfgrid-cell-main").height(), winW = $("#jfgrid-cell-main").width();

            var row = visibledatarow[searchIndexArr[count].r], row_pre = searchIndexArr[count].r - 1 == -1 ? 0 : visibledatarow[searchIndexArr[count].r - 1];
            var col = visibledatacolumn[searchIndexArr[count].c], col_pre = searchIndexArr[count].c - 1 == -1 ? 0 : visibledatacolumn[searchIndexArr[count].c - 1];

            if (col - scrollLeft - winW + 20 > 0) {
                $("#jfgrid-scrollbar-x").scrollLeft(col - winW + 20);
            }
            else if (col_pre - scrollLeft - 20 < 0) {
                $("#jfgrid-scrollbar-x").scrollLeft(col_pre - 20);
            }

            if (row - scrollTop - winH + 20 > 0) {
                $("#jfgrid-scrollbar-y").scrollTop(row - winH + 20);
            }
            else if (row_pre - scrollTop - 20 < 0) {
                $("#jfgrid-scrollbar-y").scrollTop(row_pre - 20);
            }
            
            if($("#searchAllbox").is(":visible")){
                $("#jfgrid-search-replace #searchAllbox .boxItem").removeClass("on");
            }
        },
        searchAll: function(){
            $("#jfgrid-search-replace #searchAllbox").remove();
            
            var searchText = $("#jfgrid-search-replace #searchInput input").val();

            if(searchText == "" || searchText == null){
                return;
            }

            if(jfgird_select_save.length == 0 || (jfgird_select_save.length == 1 && jfgird_select_save[0].row[0] == jfgird_select_save[0].row[1] && jfgird_select_save[0].column[0] == jfgird_select_save[0].column[1])){
                var range = [{ "row": [0, jfgrid.flowdata.length - 1], "column": [0, jfgrid.flowdata[0].length - 1] }];
            }
            else{
                var range = $.extend(true, [], jfgird_select_save);                
            }

            var searchIndexArr = jfgrid.searchReplace.getSearchIndexArr(searchText, range);

            if(searchIndexArr.length == 0){
                if(jfgrid.isEditMode()){
                    alert("没有查找到该内容");
                }
                else{
                    jfgrid.tooltip.info("没有查找到该内容", "");
                }

                return;
            }

            var searchAllHtml = '';

            for(var i = 0; i < searchIndexArr.length; i++){
                var valueShowEs = jfgrid.mask.valueShowEs(searchIndexArr[i].r, searchIndexArr[i].c, jfgrid.flowdata).toString();

                if(valueShowEs.indexOf("</") > -1 && valueShowEs.indexOf(">") > -1){
                    searchAllHtml += '<div class="boxItem" data-row="' + searchIndexArr[i].r + '" data-col="' + searchIndexArr[i].c + '" data-sheetIndex="' + jfgrid.currentSheetIndex + '">' +
                                        '<span>' + jfgridfile[jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex)].name + '</span>' +
                                        '<span>' + jfgrid.jfgridchatatABC(searchIndexArr[i].c) + (searchIndexArr[i].r + 1) + '</span>' +
                                        '<span>' + valueShowEs + '</span>' +
                                     '</div>';
                }
                else{
                    searchAllHtml += '<div class="boxItem" data-row="' + searchIndexArr[i].r + '" data-col="' + searchIndexArr[i].c + '" data-sheetIndex="' + jfgrid.currentSheetIndex + '">' +
                                        '<span>' + jfgridfile[jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex)].name + '</span>' +
                                        '<span>' + jfgrid.jfgridchatatABC(searchIndexArr[i].c) + (searchIndexArr[i].r + 1) + '</span>' +
                                        '<span title="' + valueShowEs + '">' + valueShowEs + '</span>' +
                                     '</div>';
                }
            }
            
            $('<div id="searchAllbox"><div class="boxTitle"><span>工作表</span><span>单元格</span><span>值</span></div><div class="boxMain">' + searchAllHtml + '</div></div>').appendTo($("#jfgrid-search-replace"));
            
            $("#jfgrid-search-replace #searchAllbox .boxItem").eq(0).addClass("on").siblings().removeClass("on");

            jfgird_select_save = [
                { "row": [searchIndexArr[0].r, searchIndexArr[0].r], "column": [searchIndexArr[0].c, searchIndexArr[0].c] }
            ];

            jfgrid.selectHightlightShow();
        },
        getSearchIndexArr: function(searchText, range){
            var arr = [];
            var obj = {};

            //正则表达式匹配
            var regCheck = false;
            if($("#jfgrid-search-replace #regCheck input[type='checkbox']").is(":checked")){
                regCheck = true;
            }

            //整词匹配
            var wordCheck = false;
            if($("#jfgrid-search-replace #wordCheck input[type='checkbox']").is(":checked")){
                wordCheck = true;
            }

            //区分大小写匹配
            var caseCheck = false;
            if($("#jfgrid-search-replace #caseCheck input[type='checkbox']").is(":checked")){
                caseCheck = true;
            }

            for(var s = 0; s < range.length; s++){
                var r1 = range[s].row[0], r2 = range[s].row[1];
                var c1 = range[s].column[0], c2 = range[s].column[1];

                for(var r = r1; r <= r2; r++){
                    for(var c = c1; c <= c2; c++){
                        var cell = jfgrid.flowdata[r][c];

                        if(cell != null){
                            var value = jfgrid.mask.valueShowEs(r, c, jfgrid.flowdata);

                            if(value == 0){
                                value = value.toString();
                            }

                            if(value != null && value != ""){
                                value = value.toString();

                                if(wordCheck){ //整词
                                    if(caseCheck){
                                        if(searchText == value){
                                            if(!((r + "_" + c) in obj)){
                                                obj[r + "_" + c] = 0;
                                                arr.push({"r": r, "c": c});
                                            }
                                        }
                                    }
                                    else{
                                        var txt = searchText.toLowerCase();
                                        if(txt == value.toLowerCase()){
                                            if(!((r + "_" + c) in obj)){
                                                obj[r + "_" + c] = 0;
                                                arr.push({"r": r, "c": c});
                                            }
                                        }
                                    }
                                }
                                else if(regCheck){ //正则表达式
                                    if(caseCheck){
                                        var reg = new RegExp(jfgrid.func_methods.getRegExpStr(searchText), "g");
                                    }
                                    else{
                                        var reg = new RegExp(jfgrid.func_methods.getRegExpStr(searchText), "ig");
                                    }

                                    if(reg.test(value)){
                                        if(!((r + "_" + c) in obj)){
                                            obj[r + "_" + c] = 0;
                                            arr.push({"r": r, "c": c});
                                        }
                                    }
                                }
                                else if(caseCheck){ //区分大小写
                                    var reg = new RegExp(jfgrid.func_methods.getRegExpStr(searchText), "g");

                                    if(reg.test(value)){
                                        if(!((r + "_" + c) in obj)){
                                            obj[r + "_" + c] = 0;
                                            arr.push({"r": r, "c": c});
                                        }
                                    }
                                }
                                else{
                                    var reg = new RegExp(jfgrid.func_methods.getRegExpStr(searchText), "ig");

                                    if(reg.test(value)){
                                        if(!((r + "_" + c) in obj)){
                                            obj[r + "_" + c] = 0;
                                            arr.push({"r": r, "c": c});
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }

            return arr;
        },
        replace: function(){
            var searchText = $("#jfgrid-search-replace #searchInput input").val();

            if(searchText == "" || searchText == null){
                if(jfgrid.isEditMode()){
                    alert("请输入查找内容");
                }
                else{
                    jfgrid.tooltip.info("请输入查找内容", "");
                }

                return;
            }

            if(jfgird_select_save.length == 0 || (jfgird_select_save.length == 1 && jfgird_select_save[0].row[0] == jfgird_select_save[0].row[1] && jfgird_select_save[0].column[0] == jfgird_select_save[0].column[1])){
                var range = [{ "row": [0, jfgrid.flowdata.length - 1], "column": [0, jfgrid.flowdata[0].length - 1] }];
            }
            else{
                var range = $.extend(true, [], jfgird_select_save);                
            }

            var searchIndexArr = jfgrid.searchReplace.getSearchIndexArr(searchText, range);

            if(searchIndexArr.length == 0){
                if(jfgrid.isEditMode()){
                    alert("没有可替换的内容");
                }
                else{
                    jfgrid.tooltip.info("没有可替换的内容", "");
                }

                return;
            }

            var count = null;

            var rf = jfgird_select_save[jfgird_select_save.length - 1].row_focus;
            var cf = jfgird_select_save[jfgird_select_save.length - 1].column_focus;

            for(var i = 0; i < searchIndexArr.length; i++){
                if(searchIndexArr[i].r == rf && searchIndexArr[i].c == cf){
                    count = i;
                    break;
                }
            }

            if(count == null){
                if(searchIndexArr.length == 0){
                    if(jfgrid.isEditMode()){
                        alert("找不到匹配项");
                    }
                    else{
                        jfgrid.tooltip.info("找不到匹配项", "");
                    }

                    return;
                }
                else{
                    count = 0;
                }
            }

            //正则表达式匹配
            var regCheck = false;
            if($("#jfgrid-search-replace #regCheck input[type='checkbox']").is(":checked")){
                regCheck = true;
            }

            //整词匹配
            var wordCheck = false;
            if($("#jfgrid-search-replace #wordCheck input[type='checkbox']").is(":checked")){
                wordCheck = true;
            }

            //区分大小写匹配
            var caseCheck = false;
            if($("#jfgrid-search-replace #caseCheck input[type='checkbox']").is(":checked")){
                caseCheck = true;
            }

            var replaceText = $("#jfgrid-search-replace #replaceInput input").val();

            var d = jfgrid.editor.deepCopyFlowData(jfgrid.flowdata);

            if(wordCheck){
                var r = searchIndexArr[count].r;
                var c = searchIndexArr[count].c;

                var v = replaceText;

                jfgrid.setcellvalue(r, c, d, v);
            }
            else{
                if(caseCheck){
                    var reg = new RegExp(jfgrid.func_methods.getRegExpStr(searchText), "g");
                }
                else{
                    var reg = new RegExp(jfgrid.func_methods.getRegExpStr(searchText), "ig");
                }

                var r = searchIndexArr[count].r;
                var c = searchIndexArr[count].c;

                var v = jfgrid.mask.valueShowEs(r, c, d).toString().replace(reg, replaceText);

                jfgrid.setcellvalue(r, c, d, v);
            }

            jfgird_select_save = [{ "row": [r, r], "column": [c, c] }];

            if($("#jfgrid-search-replace #searchAllbox").is(":visible")){
                $("#jfgrid-search-replace #searchAllbox").hide();
            }

            jfgrid.jfrefreshgrid(d, jfgird_select_save);
            jfgrid.selectHightlightShow();

            var scrollLeft = $("#jfgrid-cell-main").scrollLeft(), scrollTop = $("#jfgrid-cell-main").scrollTop();
            var winH = $("#jfgrid-cell-main").height(), winW = $("#jfgrid-cell-main").width();

            var row = visibledatarow[r], row_pre = r - 1 == -1 ? 0 : visibledatarow[r - 1];
            var col = visibledatacolumn[c], col_pre = c - 1 == -1 ? 0 : visibledatacolumn[c - 1];

            if (col - scrollLeft - winW + 20 > 0) {
                $("#jfgrid-scrollbar-x").scrollLeft(col - winW + 20);
            }
            else if (col_pre - scrollLeft - 20 < 0) {
                $("#jfgrid-scrollbar-x").scrollLeft(col_pre - 20);
            }

            if (row - scrollTop - winH + 20 > 0) {
                $("#jfgrid-scrollbar-y").scrollTop(row - winH + 20);
            }
            else if (row_pre - scrollTop - 20 < 0) {
                $("#jfgrid-scrollbar-y").scrollTop(row_pre - 20);
            }
        },
        replaceAll: function(){
            var searchText = $("#jfgrid-search-replace #searchInput input").val();

            if(searchText == "" || searchText == null){
                if(jfgrid.isEditMode()){
                    alert("请输入查找内容");
                }
                else{
                    jfgrid.tooltip.info("请输入查找内容", "");
                }

                return;
            }

            if(jfgird_select_save.length == 0 || (jfgird_select_save.length == 1 && jfgird_select_save[0].row[0] == jfgird_select_save[0].row[1] && jfgird_select_save[0].column[0] == jfgird_select_save[0].column[1])){
                var range = [{ "row": [0, jfgrid.flowdata.length - 1], "column": [0, jfgrid.flowdata[0].length - 1] }];
            }
            else{
                var range = $.extend(true, [], jfgird_select_save);                
            }

            var searchIndexArr = jfgrid.searchReplace.getSearchIndexArr(searchText, range);

            if(searchIndexArr.length == 0){
                if(jfgrid.isEditMode()){
                    alert("没有可替换的内容");
                }
                else{
                    jfgrid.tooltip.info("没有可替换的内容", "");
                }

                return;
            }

            //正则表达式匹配
            var regCheck = false;
            if($("#jfgrid-search-replace #regCheck input[type='checkbox']").is(":checked")){
                regCheck = true;
            }

            //整词匹配
            var wordCheck = false;
            if($("#jfgrid-search-replace #wordCheck input[type='checkbox']").is(":checked")){
                wordCheck = true;
            }

            //区分大小写匹配
            var caseCheck = false;
            if($("#jfgrid-search-replace #caseCheck input[type='checkbox']").is(":checked")){
                caseCheck = true;
            }

            var replaceText = $("#jfgrid-search-replace #replaceInput input").val();

            var d = jfgrid.editor.deepCopyFlowData(jfgrid.flowdata);
            var range = [];

            if(wordCheck){
                for(var i = 0; i < searchIndexArr.length; i++){
                    var r = searchIndexArr[i].r;
                    var c = searchIndexArr[i].c;

                    var v = replaceText;

                    jfgrid.setcellvalue(r, c, d, v);

                    range.push({ "row": [r, r], "column": [c, c] });
                }
            }
            else{
                if(caseCheck){
                    var reg = new RegExp(jfgrid.func_methods.getRegExpStr(searchText), "g");
                }
                else{
                    var reg = new RegExp(jfgrid.func_methods.getRegExpStr(searchText), "ig");
                }

                for(var i = 0; i < searchIndexArr.length; i++){
                    var r = searchIndexArr[i].r;
                    var c = searchIndexArr[i].c;

                    var v = jfgrid.mask.valueShowEs(r, c, d).toString().replace(reg, replaceText);

                    jfgrid.setcellvalue(r, c, d, v);

                    range.push({ "row": [r, r], "column": [c, c] });
                }
            }

            if($("#jfgrid-search-replace #searchAllbox").is(":visible")){
                $("#jfgrid-search-replace #searchAllbox").hide();
            }

            jfgrid.jfrefreshgrid(d, range);

            jfgird_select_save = $.extend(true, [], range);
            jfgrid.selectHightlightShow();

            if(jfgrid.isEditMode()){
                alert("已经帮您搜索并进行了" + searchIndexArr.length + "处替换");
            }
            else{
                jfgrid.tooltip.info("已经帮您搜索并进行了" + searchIndexArr.length + "处替换", "");
            }
        }
    }

    //分列
    jfgrid.splitColumn = {
        createDialog: function(){
            $("#jfgrid-modal-dialog-mask").show();
            $("#jfgrid-splitColumn-dialog").remove();

            var content = '<div class="box">' +
                            '<div class="boxTitle">分割符号</div>' +
                            '<div class="boxMain">' +
                                '<div style="height: 22px;line-height: 22px;">' +
                                    '<input id="splitColumn_type_01" type="checkbox"/>' +
                                    '<label for="splitColumn_type_01">Tab 键</label>' +
                                '</div>' +
                                '<div style="height: 22px;line-height: 22px;">' +
                                    '<input id="splitColumn_type_02" type="checkbox"/>' +
                                    '<label for="splitColumn_type_02">分号</label>' +
                                '</div>' +
                                '<div style="height: 22px;line-height: 22px;">' +
                                    '<input id="splitColumn_type_03" type="checkbox"/>' +
                                    '<label for="splitColumn_type_03">逗号</label>' +
                                '</div>' +
                                '<div style="height: 22px;line-height: 22px;">' +
                                    '<input id="splitColumn_type_04" type="checkbox"/>' +
                                    '<label for="splitColumn_type_04">空格</label>' +
                                '</div>' +
                                '<div style="height: 22px;line-height: 22px;">' +
                                    '<input id="splitColumn_type_05" type="checkbox"/>' +
                                    '<label for="splitColumn_type_05">其它</label>' +
                                    '<input type="text" class="formulaInputFocus" maxlength="1"/>' +
                                '</div>' +
                            '</div>' +
                            '<div style="height: 22px;line-height: 22px;">' +
                                '<input id="splitColumn_type_06" type="checkbox"/>' +
                                '<label for="splitColumn_type_06">连续分隔符号视为单个处理</label>' +
                            '</div>' +
                            '<div class="boxTitle" style="margin-top: 10px;">数据预览</div>' +
                            '<div class="boxMain" id="splitColumnData">' +

                            '</div>' +
                          '</div>';

            $("body").append(jfgrid.replaceHtml(modelHTML, { "id": "jfgrid-splitColumn-dialog", "addclass": "jfgrid-splitColumn-dialog", "title": "文本分列", "content": content, "botton": '<button id="jfgrid-splitColumn-dialog-confirm" class="btn btn-primary">确定</button><button class="btn btn-default jfgrid-model-close-btn">关闭</button>', "style": "z-index:100003" }));
            var $t = $("#jfgrid-splitColumn-dialog").find(".jfgrid-modal-dialog-content").css("min-width", 400).end(), myh = $t.outerHeight(), myw = $t.outerWidth();
            var winw = $(window).width(), winh = $(window).height();
            var scrollLeft = $(document).scrollLeft(), scrollTop = $(document).scrollTop();
            $("#jfgrid-splitColumn-dialog").css({ "left": (winw + scrollLeft - myw) / 2, "top": (winh + scrollTop - myh) / 3 }).show();

            var dataArr = jfgrid.splitColumn.getDataArr();
            jfgrid.splitColumn.dataPreview(dataArr);
        },
        init: function(){
            //数据预览
            $(document).off("change.SPCinpcheckbox").on("change.SPCcheckbox", "#jfgrid-splitColumn-dialog .box input[type='checkbox']", function(){
                var regStr = jfgrid.splitColumn.getRegStr();
                var dataArr = jfgrid.splitColumn.getDataArr(regStr);
                jfgrid.splitColumn.dataPreview(dataArr);
            });
            $(document).off("keyup.SPCinptext").on("keyup.SPCinptext", "#jfgrid-splitColumn-dialog .box input[type='text']", function(){
                if($(this).siblings("input[type='checkbox']").is(":checked")){
                    var regStr = jfgrid.splitColumn.getRegStr();
                    var dataArr = jfgrid.splitColumn.getDataArr(regStr);
                    jfgrid.splitColumn.dataPreview(dataArr);
                }
            })

            //确定按钮
            $(document).off("click.SPCconfirm").on("click.SPCconfirm", "#jfgrid-splitColumn-dialog #jfgrid-splitColumn-dialog-confirm", function(){
                $("#jfgrid-modal-dialog-mask").hide();
                $("#jfgrid-splitColumn-dialog").hide();

                var regStr = jfgrid.splitColumn.getRegStr();
                var dataArr = jfgrid.splitColumn.getDataArr(regStr);

                var r = jfgird_select_save[0].row[0];
                var c = jfgird_select_save[0].column[0];

                if(dataArr[0].length == 1){
                    return;
                }

                var dataCover = false;
                for(var i = 0; i < dataArr.length; i++){
                    for(var j = 1; j < dataArr[0].length; j++){
                        var cell = jfgrid.flowdata[r + i][c + j];

                        if(cell != null && cell.v != null){
                            dataCover = true;
                            break;
                        }
                    }
                }

                if(dataCover){
                    var func1 = function(){
                        jfgrid.splitColumn.update(r, c, dataArr);
                    } 
                    jfgrid.tooltip.confirm("提示", "此处已有数据，是否替换它？", func1);
                }
                else{
                    jfgrid.splitColumn.update(r, c, dataArr);
                }
            });
        },
        update: function(r, c, dataArr){
            var d = jfgrid.editor.deepCopyFlowData(jfgrid.flowdata);

            for(var i = 0; i < dataArr.length; i++){
                for(var j = 0; j < dataArr[0].length; j++){
                    var v = dataArr[i][j];
                    jfgrid.setcellvalue(r + i, c + j, d, v);
                }
            }

            var st_r = jfgird_select_save[0].row[0], 
                st_c = jfgird_select_save[0].column[0];

            var range = [{ "row": [st_r, st_r + dataArr.length - 1], "column": [st_c, st_c + dataArr[0].length - 1] }]

            jfgrid.jfrefreshgrid(d, range);
            jfgrid.selectHightlightShow();
        },
        dataPreview: function(dataArr){
            $("#jfgrid-splitColumn-dialog #splitColumnData").empty();

            var trHtml = '';
            for(var i = 0; i < dataArr.length; i++){
                var tdHtml = '';
                for(var j = 0; j < dataArr[0].length; j++){
                    tdHtml += '<td>' + dataArr[i][j] + '</td>';
                }

                trHtml += '<tr>' + tdHtml + '</tr>';
            }

            var tableHtml = '<table>' + trHtml + '</table>';

            $("#jfgrid-splitColumn-dialog #splitColumnData").append(tableHtml);
        },
        getRegStr: function(){
            var regStr = '', mark = 0;

            $("#jfgrid-splitColumn-dialog .box input[type='checkbox']:checked").each(function(i, e){
                var $id = $(e).attr("id");

                if($id == "splitColumn_type_01"){ //Tab键
                    regStr += "\\t";
                    mark++;
                }
                else if($id == "splitColumn_type_02"){ //分号
                    if(mark > 0){
                        regStr += "|";
                    }

                    regStr += ";";
                    mark++;
                }
                else if($id == "splitColumn_type_03"){ //逗号
                    if(mark > 0){
                        regStr += "|";
                    }

                    regStr += ",";
                    mark++;
                }
                else if($id == "splitColumn_type_04"){ //空格
                    if(mark > 0){
                        regStr += "|";
                    }

                    regStr += "\\s";
                    mark++;
                }
                else if($id == "splitColumn_type_05"){ //其它
                    var txt = $(e).siblings("input[type='text']").val().trim();

                    if(txt != ""){
                        if(mark > 0){
                            regStr += "|";
                        }

                        regStr += txt;
                    }
                }
                else if($id == "splitColumn_type_06"){ //连续分隔符号视为单个处理
                    regStr = "[" + regStr + "]+";
                }
            })

            return regStr;
        },
        getDataArr: function(regStr){
            var arr = [];

            var r1 = jfgird_select_save[0].row[0];
            var r2 = jfgird_select_save[0].row[1];
            var c = jfgird_select_save[0].column[0];

            if(regStr != null && regStr != ""){
                var reg = new RegExp(regStr, "g");

                var dataArr = [];
                for(var r = r1; r <= r2; r++){
                    var rowArr = [];

                    var cell = jfgrid.flowdata[r][c];

                    if(cell != null && cell["m"] != null){
                        var value = cell["m"];
                    }
                    else{
                        var value = jfgrid.getcellvalue(r, c, jfgrid.flowdata);
                    }

                    rowArr = value.toString().split(reg);

                    dataArr.push(rowArr);
                }

                var rlen = dataArr.length;
                var clen = 0;

                for(var i = 0; i < rlen; i++){
                    if(dataArr[i].length > clen){
                        clen = dataArr[i].length;
                    }
                }

                arr = jfgrid.splitColumn.getNullData(rlen, clen);

                for(var i = 0; i < arr.length; i++){
                    for(var j = 0; j < arr[0].length; j++){
                        if(dataArr[i][j] != null){
                            arr[i][j] = dataArr[i][j];
                        }
                    }
                }
            }
            else{
                for(var r = r1; r <= r2; r++){
                    var rowArr = [];

                    var cell = jfgrid.flowdata[r][c];

                    if(cell != null && cell["m"] != null){
                        var value = cell["m"];
                    }
                    else{
                        var value = jfgrid.getcellvalue(r, c, jfgrid.flowdata);
                    }

                    rowArr.push(value);

                    arr.push(rowArr);
                }
            }

            return arr;
        },
        getNullData: function(rlen, clen){
            var arr = [];

            for(var r = 0; r < rlen; r++){
                var rowArr = [];

                for(var c = 0; c < clen; c++){
                    rowArr.push("");
                }

                arr.push(rowArr);
            }

            return arr;
        }
    }

    //批注
    jfgrid.postil = {
        defaultWidth: 144,
        defaultHeight: 84,
        currentObj: null,
        currentWinW: null,
        currentWinH: null,
        resize: null,
        resizeXY: null,
        move: false,
        moveXY: null,
        init: function(){
            //点击批注框 聚焦
            $("#jfgrid-postil-showBoxs").off("mousedown.showPs").on("mousedown.showPs", ".jfgrid-postil-show", function(event){
                jfgrid.postil.currentObj = $(this).find(".jfgrid-postil-show-main");

                if($(this).hasClass("jfgrid-postil-show-active")){
                    event.stopPropagation();
                    return;
                }

                jfgrid.postil.removeActivePs();

                $(this).addClass("jfgrid-postil-show-active");
                $(this).find(".jfgrid-postil-dialog-resize").show();
                $(this).find(".arrowCanvas").css("z-index", 200);
                $(this).find(".jfgrid-postil-show-main").css("z-index", 200);

                event.stopPropagation();
            });
            $("#jfgrid-postil-showBoxs").off("mouseup.showPs").on("mouseup.showPs", ".jfgrid-postil-show", function(event){
                if(event.which == "3"){
                    event.stopPropagation();
                }
            });

            //批注框 改变大小
            $("#jfgrid-postil-showBoxs").off("mousedown.resize").on("mousedown.resize", ".jfgrid-postil-show .jfgrid-postil-dialog-resize .jfgrid-postil-dialog-resize-item", function(event){
                jfgrid.postil.currentObj = $(this).closest(".jfgrid-postil-show-main");
                jfgrid.postil.currentWinW = $("#jfgrid-cell-main")[0].scrollWidth;
                jfgrid.postil.currentWinH = $("#jfgrid-cell-main")[0].scrollHeight;

                jfgrid.postil.resize = $(this).data("type");

                var scrollTop = $("#jfgrid-cell-main").scrollTop(), scrollLeft = $("#jfgrid-cell-main").scrollLeft();
                var mouse = jfgrid.mouseposition(event.pageX, event.pageY);
                var x = mouse[0] + scrollLeft;
                var y = mouse[1] + scrollTop;

                var position = jfgrid.postil.currentObj.position();
                var width = jfgrid.postil.currentObj.width();
                var height = jfgrid.postil.currentObj.height();

                jfgrid.postil.resizeXY = [x, y, width, height, position.left + scrollLeft, position.top + scrollTop, scrollLeft, scrollTop];

                jfgrid.setjfgird_scroll_status(true);

                if($(this).closest(".jfgrid-postil-show").hasClass("jfgrid-postil-show-active")){
                    event.stopPropagation();
                    return;
                }

                jfgrid.postil.removeActivePs();

                $(this).closest(".jfgrid-postil-show").addClass("jfgrid-postil-show-active");
                $(this).closest(".jfgrid-postil-show").find(".jfgrid-postil-dialog-resize").show();
                $(this).closest(".jfgrid-postil-show").find(".arrowCanvas").css("z-index", 200);
                $(this).closest(".jfgrid-postil-show").find(".jfgrid-postil-show-main").css("z-index", 200);

                event.stopPropagation();
            });

            //批注框 移动
            $("#jfgrid-postil-showBoxs").off("mousedown.move").on("mousedown.move", ".jfgrid-postil-show .jfgrid-postil-dialog-move .jfgrid-postil-dialog-move-item", function(event){
                jfgrid.postil.currentObj = $(this).closest(".jfgrid-postil-show-main");
                jfgrid.postil.currentWinW = $("#jfgrid-cell-main")[0].scrollWidth;
                jfgrid.postil.currentWinH = $("#jfgrid-cell-main")[0].scrollHeight;

                jfgrid.postil.move = true;

                var scrollTop = $("#jfgrid-cell-main").scrollTop(), scrollLeft = $("#jfgrid-cell-main").scrollLeft();

                var offset = jfgrid.postil.currentObj.offset();
                var position = jfgrid.postil.currentObj.position();

                jfgrid.postil.moveXY = [event.pageX - offset.left, event.pageY - offset.top, position.left, position.top, scrollLeft, scrollTop];

                jfgrid.setjfgird_scroll_status(true);

                if($(this).closest(".jfgrid-postil-show").hasClass("jfgrid-postil-show-active")){
                    event.stopPropagation();
                    return;
                }

                jfgrid.postil.removeActivePs();

                $(this).closest(".jfgrid-postil-show").addClass("jfgrid-postil-show-active");
                $(this).closest(".jfgrid-postil-show").find(".jfgrid-postil-dialog-resize").show();
                $(this).closest(".jfgrid-postil-show").find(".arrowCanvas").css("z-index", 200);
                $(this).closest(".jfgrid-postil-show").find(".jfgrid-postil-show-main").css("z-index", 200);

                event.stopPropagation();
            });
        },
        overshow: function(event){
            $("#jfgrid-postil-overshow").remove();

            if($(event.target).closest("#jfgrid-cell-main").length == 0){
                return;
            }

            var mouse = jfgrid.mouseposition(event.pageX, event.pageY);
            var scrollLeft = $("#jfgrid-cell-main").scrollLeft();
            var scrollTop = $("#jfgrid-cell-main").scrollTop();
            var x = mouse[0] + scrollLeft;
            var y = mouse[1] + scrollTop;

            if(jfgrid.freezen.freezenverticaldata != null && mouse[0] < (jfgrid.freezen.freezenverticaldata[0] - jfgrid.freezen.freezenverticaldata[2])){
                return;
            }

            if(jfgrid.freezen.freezenhorizontaldata != null && mouse[1] < (jfgrid.freezen.freezenhorizontaldata[0] - jfgrid.freezen.freezenhorizontaldata[2])){
                return;
            }

            var rowLocation = jfgrid.rowLocation(y), row_index = rowLocation[2];
            var colLocation = jfgrid.colLocation(x), col_index = colLocation[2];

            if(jfgrid.flowdata[row_index] == null || jfgrid.flowdata[row_index][col_index] == null || jfgrid.flowdata[row_index][col_index].ps == null){
                return;
            }

            var postil = jfgrid.flowdata[row_index][col_index].ps;

            if(postil["isshow"] || $("#jfgrid-postil-show_"+ row_index +"_"+ col_index).length > 0){
                return;
            }

            var value = postil["value"] == null ? "" : postil["value"];

            var toX = visibledatacolumn[col_index];
            var toY = row_index == 0 ? 0 : visibledatarow[row_index - 1];

            var fromX = toX + 18;
            var fromY = toY - 18;

            if(fromY < 0){
                fromY = 2;
            }

            var size = jfgrid.postil.getArrowCanvasSize(fromX, fromY, toX, toY);

            var html =  '<div id="jfgrid-postil-overshow">' +
                            '<canvas class="arrowCanvas" width="'+ size[2] +'" height="'+ size[3] +'" style="position:absolute;left:'+ size[0] +'px;top:'+ size[1] +'px;z-index:100;"></canvas>' +
                            '<div style="width:132px;min-height:72px;color:#000;padding:5px;border:1px solid #000;background-color:rgb(255,255,225);position:absolute;left:'+ fromX +'px;top:'+ fromY +'px;z-index:100;">'+ value +'</div>' +
                        '</div>';

            $(html).appendTo($("#jfgrid-cell-main"));

            var ctx = $("#jfgrid-postil-overshow .arrowCanvas").get(0).getContext("2d");

            jfgrid.postil.drawArrow(ctx, size[4], size[5], size[6], size[7]);
        },
        getArrowCanvasSize: function(fromX, fromY, toX, toY){
            var left = toX - 5;
            
            if(fromX < toX){
                left = fromX - 5;
            }

            var top = toY - 5;
            
            if(fromY < toY){
                top = fromY - 5;
            }

            var width = Math.abs(fromX - toX) + 10;
            var height = Math.abs(fromY - toY) + 10;

            var x1 = width - 5;
            var x2 = 5;
            
            if(fromX < toX){
                x1 = 5;
                x2 = width - 5;
            }

            var y1 = height - 5;
            var y2 = 5;

            if(fromY < toY){
                y1 = 5;
                y2 = height - 5;
            }

            return [left, top, width, height, x1, y1, x2, y2];
        },
        drawArrow: function(ctx, fromX, fromY, toX, toY, theta, headlen, width, color){
            theta = jfgrid.getObjType(theta) == "undefined" ? 30 : theta;
            headlen = jfgrid.getObjType(headlen) == "undefined" ? 6 : headlen;
            width = jfgrid.getObjType(width) == "undefined" ? 1 : width;
            color = jfgrid.getObjType(color) == "undefined" ? "#000" : color;

            // 计算各角度和对应的P2,P3坐标
            var angle = Math.atan2(fromY - toY, fromX - toX) * 180 / Math.PI, 
                angle1 = (angle + theta) * Math.PI / 180, 
                angle2 = (angle - theta) * Math.PI / 180, 
                topX = headlen * Math.cos(angle1), 
                topY = headlen * Math.sin(angle1), 
                botX = headlen * Math.cos(angle2), 
                botY = headlen * Math.sin(angle2);

            ctx.save();
            ctx.beginPath();

            var arrowX = fromX - topX,
                arrowY = fromY - topY;

            ctx.moveTo(arrowX, arrowY); 
            ctx.moveTo(fromX, fromY); 
            ctx.lineTo(toX, toY); 
            
            ctx.lineWidth = width;
            ctx.strokeStyle = color; 
            ctx.stroke();

            arrowX = toX + topX; 
            arrowY = toY + topY; 
            ctx.moveTo(arrowX, arrowY); 
            ctx.lineTo(toX, toY); 
            arrowX = toX + botX; 
            arrowY = toY + botY; 
            ctx.lineTo(arrowX, arrowY); 
            
            ctx.fillStyle = color;
            ctx.fill(); 
            ctx.restore();
        },
        buildAllPs: function(data){
            $("#jfgrid-cell-main #jfgrid-postil-showBoxs").empty();

            for(var r = 0; r < data.length; r++){
                for(var c = 0; c < data[0].length; c++){
                    if(data[r][c] != null && data[r][c].ps != null){
                        var postil = data[r][c].ps;
                        
                        jfgrid.postil.buildPs(r, c, postil);
                    }
                }
            }

            jfgrid.postil.init();
        },
        buildPs: function(r, c, postil){
            if($("#jfgrid-postil-show_"+ r +"_"+ c).length > 0){
                $("#jfgrid-postil-show_"+ r +"_"+ c).remove();
            }

            if(postil == null){
                return;
            }

            var isshow = postil["isshow"] == null ? false : postil["isshow"];

            if(isshow){
                var row = visibledatarow[r], row_pre = r - 1 == -1 ? 0 : visibledatarow[r - 1];
                var col = visibledatacolumn[c], col_pre = c - 1 == -1 ? 0 : visibledatacolumn[c - 1];

                var margeset = jfgrid.menuButton.mergeborer(jfgrid.flowdata, r, c);
                if(!!margeset){
                    row = margeset.row[1];
                    row_pre = margeset.row[0];
                    
                    col = margeset.column[1];
                    col_pre = margeset.column[0];
                }

                var toX = col;
                var toY = row_pre;

                var left = postil["left"] == null ? toX + 18 : postil["left"];
                var top = postil["top"] == null ? toY - 18 : postil["top"];
                var width = postil["width"] == null ? jfgrid.postil.defaultWidth : postil["width"];
                var height = postil["height"] == null ? jfgrid.postil.defaultHeight : postil["height"];
                var value = postil["value"] == null ? "" : postil["value"];

                if(top < 0){
                    top = 2;
                }

                var size = jfgrid.postil.getArrowCanvasSize(left, top, toX, toY);

                var html =  '<div id="jfgrid-postil-show_'+ r +'_'+ c +'" class="jfgrid-postil-show">' +
                                '<canvas class="arrowCanvas" width="'+ size[2] +'" height="'+ size[3] +'" style="position:absolute;left:'+ size[0] +'px;top:'+ size[1] +'px;z-index:100;"></canvas>' +
                                '<div class="jfgrid-postil-show-main" style="width:'+ width +'px;height:'+ height +'px;color:#000;padding:5px;border:1px solid #000;background-color:rgb(255,255,225);position:absolute;left:'+ left +'px;top:'+ top +'px;box-sizing:border-box;z-index:100;">' +
                                    '<div class="jfgrid-postil-dialog-move">' +
                                        '<div class="jfgrid-postil-dialog-move-item jfgrid-postil-dialog-move-item-t" data-type="t"></div>' +
                                        '<div class="jfgrid-postil-dialog-move-item jfgrid-postil-dialog-move-item-r" data-type="r"></div>' +
                                        '<div class="jfgrid-postil-dialog-move-item jfgrid-postil-dialog-move-item-b" data-type="b"></div>' +
                                        '<div class="jfgrid-postil-dialog-move-item jfgrid-postil-dialog-move-item-l" data-type="l"></div>' +
                                    '</div>' +
                                    '<div class="jfgrid-postil-dialog-resize" style="display:none;">' +
                                        '<div class="jfgrid-postil-dialog-resize-item jfgrid-postil-dialog-resize-item-lt" data-type="lt"></div>' +
                                        '<div class="jfgrid-postil-dialog-resize-item jfgrid-postil-dialog-resize-item-mt" data-type="mt"></div>' +
                                        '<div class="jfgrid-postil-dialog-resize-item jfgrid-postil-dialog-resize-item-lm" data-type="lm"></div>' +
                                        '<div class="jfgrid-postil-dialog-resize-item jfgrid-postil-dialog-resize-item-rm" data-type="rm"></div>' +
                                        '<div class="jfgrid-postil-dialog-resize-item jfgrid-postil-dialog-resize-item-rt" data-type="rt"></div>' +
                                        '<div class="jfgrid-postil-dialog-resize-item jfgrid-postil-dialog-resize-item-lb" data-type="lb"></div>' +
                                        '<div class="jfgrid-postil-dialog-resize-item jfgrid-postil-dialog-resize-item-mb" data-type="mb"></div>' +
                                        '<div class="jfgrid-postil-dialog-resize-item jfgrid-postil-dialog-resize-item-rb" data-type="rb"></div>' +
                                    '</div>' +
                                    '<div style="width:100%;height:100%;overflow:hidden;">' + 
                                        '<div class="formulaInputFocus" style="width:'+ (width - 12) +'px;height:'+ (height - 12) +'px;line-height:18px;word-break:break-all;" spellcheck="false" contenteditable="true">' +
                                            value +
                                        '</div>' +
                                    '</div>' +
                                '</div>' +
                            '</div>';

                $(html).appendTo($("#jfgrid-cell-main #jfgrid-postil-showBoxs"));

                var ctx = $("#jfgrid-postil-show_"+ r +"_"+ c +" .arrowCanvas").get(0).getContext("2d");

                jfgrid.postil.drawArrow(ctx, size[4], size[5], size[6], size[7]);
            }
        },
        newPs: function(r, c){
            var toX = visibledatacolumn[c];
            var toY = r == 0 ? 0 : visibledatarow[r - 1];

            var fromX = toX + 18;
            var fromY = toY - 18;

            if(fromY < 0){
                fromY = 2;
            }

            var size = jfgrid.postil.getArrowCanvasSize(fromX, fromY, toX, toY);

            var html =  '<div id="jfgrid-postil-show_'+ r +'_'+ c +'" class="jfgrid-postil-show jfgrid-postil-show-active">' +
                            '<canvas class="arrowCanvas" width="'+ size[2] +'" height="'+ size[3] +'" style="position:absolute;left:'+ size[0] +'px;top:'+ size[1] +'px;z-index:100;"></canvas>' +
                            '<div class="jfgrid-postil-show-main" style="width:144px;height:84px;color:#000;padding:5px;border:1px solid #000;background-color:rgb(255,255,225);position:absolute;left:'+ fromX +'px;top:'+ fromY +'px;box-sizing:border-box;z-index:100;">' +
                                '<div class="jfgrid-postil-dialog-move">' +
                                    '<div class="jfgrid-postil-dialog-move-item jfgrid-postil-dialog-move-item-t" data-type="t"></div>' +
                                    '<div class="jfgrid-postil-dialog-move-item jfgrid-postil-dialog-move-item-r" data-type="r"></div>' +
                                    '<div class="jfgrid-postil-dialog-move-item jfgrid-postil-dialog-move-item-b" data-type="b"></div>' +
                                    '<div class="jfgrid-postil-dialog-move-item jfgrid-postil-dialog-move-item-l" data-type="l"></div>' +
                                '</div>' +
                                '<div class="jfgrid-postil-dialog-resize">' +
                                    '<div class="jfgrid-postil-dialog-resize-item jfgrid-postil-dialog-resize-item-lt" data-type="lt"></div>' +
                                    '<div class="jfgrid-postil-dialog-resize-item jfgrid-postil-dialog-resize-item-mt" data-type="mt"></div>' +
                                    '<div class="jfgrid-postil-dialog-resize-item jfgrid-postil-dialog-resize-item-lm" data-type="lm"></div>' +
                                    '<div class="jfgrid-postil-dialog-resize-item jfgrid-postil-dialog-resize-item-rm" data-type="rm"></div>' +
                                    '<div class="jfgrid-postil-dialog-resize-item jfgrid-postil-dialog-resize-item-rt" data-type="rt"></div>' +
                                    '<div class="jfgrid-postil-dialog-resize-item jfgrid-postil-dialog-resize-item-lb" data-type="lb"></div>' +
                                    '<div class="jfgrid-postil-dialog-resize-item jfgrid-postil-dialog-resize-item-mb" data-type="mb"></div>' +
                                    '<div class="jfgrid-postil-dialog-resize-item jfgrid-postil-dialog-resize-item-rb" data-type="rb"></div>' +
                                '</div>' +
                                '<div style="width:100%;height:100%;overflow:hidden;">' + 
                                    '<div class="formulaInputFocus" style="width:132px;height:72px;line-height:18px;word-break:break-all;" spellcheck="false" contenteditable="true">' +
                                    '</div>' +
                                '</div>' +
                            '</div>' +
                        '</div>';

            $(html).appendTo($("#jfgrid-cell-main #jfgrid-postil-showBoxs"));

            var ctx = $("#jfgrid-postil-show_"+ r +"_"+ c +" .arrowCanvas").get(0).getContext("2d");

            jfgrid.postil.drawArrow(ctx, size[4], size[5], size[6], size[7]);

            $("#jfgrid-postil-show_"+ r +"_"+ c +" .formulaInputFocus").focus();

            jfgrid.postil.init();

            var d = jfgrid.editor.deepCopyFlowData(jfgrid.flowdata);
            var rc = [];

            if(d[r][c] == null){
                d[r][c] = {};
            }

            d[r][c].ps = { "left": null, "top": null, "width": null, "height": null, "value": "", "isshow": false };
            rc.push(r + "_" + c);

            jfgrid.postil.ref(d, rc);
        },
        editPs: function(r, c){
            if($("#jfgrid-postil-show_"+ r +"_"+ c).length > 0){
                $("#jfgrid-postil-show_"+ r +"_"+ c).show();
                $("#jfgrid-postil-show_"+ r +"_"+ c).addClass("jfgrid-postil-show-active");
                $("#jfgrid-postil-show_"+ r +"_"+ c).find(".jfgrid-postil-dialog-resize").show();
            }
            else{
                var postil = jfgrid.flowdata[r][c].ps;

                var row = visibledatarow[r], row_pre = r - 1 == -1 ? 0 : visibledatarow[r - 1];
                var col = visibledatacolumn[c], col_pre = c - 1 == -1 ? 0 : visibledatacolumn[c - 1];

                var margeset = jfgrid.menuButton.mergeborer(jfgrid.flowdata, r, c);
                if(!!margeset){
                    row = margeset.row[1];
                    row_pre = margeset.row[0];
                    
                    col = margeset.column[1];
                    col_pre = margeset.column[0];
                }

                var toX = col;
                var toY = row_pre;

                var left = postil["left"] == null ? toX + 18 : postil["left"];
                var top = postil["top"] == null ? toY - 18 : postil["top"];
                var width = postil["width"] == null ? jfgrid.postil.defaultWidth : postil["width"];
                var height = postil["height"] == null ? jfgrid.postil.defaultHeight : postil["height"];
                var value = postil["value"] == null ? "" : postil["value"];

                if(top < 0){
                    top = 2;
                }

                var size = jfgrid.postil.getArrowCanvasSize(left, top, toX, toY);

                var html =  '<div id="jfgrid-postil-show_'+ r +'_'+ c +'" class="jfgrid-postil-show jfgrid-postil-show-active">' +
                                '<canvas class="arrowCanvas" width="'+ size[2] +'" height="'+ size[3] +'" style="position:absolute;left:'+ size[0] +'px;top:'+ size[1] +'px;z-index:100;"></canvas>' +
                                '<div class="jfgrid-postil-show-main" style="width:'+ width +'px;height:'+ height +'px;color:#000;padding:5px;border:1px solid #000;background-color:rgb(255,255,225);position:absolute;left:'+ left +'px;top:'+ top +'px;box-sizing:border-box;z-index:100;">' +
                                    '<div class="jfgrid-postil-dialog-move">' +
                                        '<div class="jfgrid-postil-dialog-move-item jfgrid-postil-dialog-move-item-t" data-type="t"></div>' +
                                        '<div class="jfgrid-postil-dialog-move-item jfgrid-postil-dialog-move-item-r" data-type="r"></div>' +
                                        '<div class="jfgrid-postil-dialog-move-item jfgrid-postil-dialog-move-item-b" data-type="b"></div>' +
                                        '<div class="jfgrid-postil-dialog-move-item jfgrid-postil-dialog-move-item-l" data-type="l"></div>' +
                                    '</div>' +
                                    '<div class="jfgrid-postil-dialog-resize">' +
                                        '<div class="jfgrid-postil-dialog-resize-item jfgrid-postil-dialog-resize-item-lt" data-type="lt"></div>' +
                                        '<div class="jfgrid-postil-dialog-resize-item jfgrid-postil-dialog-resize-item-mt" data-type="mt"></div>' +
                                        '<div class="jfgrid-postil-dialog-resize-item jfgrid-postil-dialog-resize-item-lm" data-type="lm"></div>' +
                                        '<div class="jfgrid-postil-dialog-resize-item jfgrid-postil-dialog-resize-item-rm" data-type="rm"></div>' +
                                        '<div class="jfgrid-postil-dialog-resize-item jfgrid-postil-dialog-resize-item-rt" data-type="rt"></div>' +
                                        '<div class="jfgrid-postil-dialog-resize-item jfgrid-postil-dialog-resize-item-lb" data-type="lb"></div>' +
                                        '<div class="jfgrid-postil-dialog-resize-item jfgrid-postil-dialog-resize-item-mb" data-type="mb"></div>' +
                                        '<div class="jfgrid-postil-dialog-resize-item jfgrid-postil-dialog-resize-item-rb" data-type="rb"></div>' +
                                    '</div>' +
                                    '<div style="width:100%;height:100%;overflow:hidden;">' + 
                                        '<div class="formulaInputFocus" style="width:'+ (width - 12) +'px;height:'+ (height - 12) +'px;line-height:18px;word-break:break-all;" spellcheck="false" contenteditable="true">' +
                                            value +
                                        '</div>' +
                                    '</div>' +
                                '</div>' +
                            '</div>';

                $(html).appendTo($("#jfgrid-cell-main #jfgrid-postil-showBoxs"));

                var ctx = $("#jfgrid-postil-show_"+ r +"_"+ c +" .arrowCanvas").get(0).getContext("2d");

                jfgrid.postil.drawArrow(ctx, size[4], size[5], size[6], size[7]);
            }

            $("#jfgrid-postil-show_"+ r +"_"+ c +" .formulaInputFocus").focus();
            jfgrid.jfgridRangeLast($("#jfgrid-postil-show_"+ r +"_"+ c +" .formulaInputFocus").get(0));

            jfgrid.postil.init();
        },
        delPs: function(r, c){
            if($("#jfgrid-postil-show_"+ r +"_"+ c).length > 0){
                $("#jfgrid-postil-show_"+ r +"_"+ c).remove();
            }

            var d = jfgrid.editor.deepCopyFlowData(jfgrid.flowdata);
            var rc = [];

            delete d[r][c].ps;
            rc.push(r + "_" + c);

            jfgrid.postil.ref(d, rc);
        },
        showHidePs: function(r, c){
            var postil = jfgrid.flowdata[r][c].ps;
            var isshow = postil["isshow"];

            var d = jfgrid.editor.deepCopyFlowData(jfgrid.flowdata);
            var rc = [];

            if(isshow){
                d[r][c].ps.isshow = false;

                $("#jfgrid-postil-show_"+ r +"_"+ c).remove();
            }
            else{
                d[r][c].ps.isshow = true;

                var row = visibledatarow[r], row_pre = r - 1 == -1 ? 0 : visibledatarow[r - 1];
                var col = visibledatacolumn[c], col_pre = c - 1 == -1 ? 0 : visibledatacolumn[c - 1];

                var margeset = jfgrid.menuButton.mergeborer(jfgrid.flowdata, r, c);
                if(!!margeset){
                    row = margeset.row[1];
                    row_pre = margeset.row[0];
                    
                    col = margeset.column[1];
                    col_pre = margeset.column[0];
                }

                var toX = col;
                var toY = row_pre;

                var left = postil["left"] == null ? toX + 18 : postil["left"];
                var top = postil["top"] == null ? toY - 18 : postil["top"];
                var width = postil["width"] == null ? jfgrid.postil.defaultWidth : postil["width"];
                var height = postil["height"] == null ? jfgrid.postil.defaultHeight : postil["height"];
                var value = postil["value"] == null ? "" : postil["value"];

                if(top < 0){
                    top = 2;
                }

                var size = jfgrid.postil.getArrowCanvasSize(left, top, toX, toY);

                var html =  '<div id="jfgrid-postil-show_'+ r +'_'+ c +'" class="jfgrid-postil-show">' +
                                '<canvas class="arrowCanvas" width="'+ size[2] +'" height="'+ size[3] +'" style="position:absolute;left:'+ size[0] +'px;top:'+ size[1] +'px;z-index:100;"></canvas>' +
                                '<div class="jfgrid-postil-show-main" style="width:'+ width +'px;height:'+ height +'px;color:#000;padding:5px;border:1px solid #000;background-color:rgb(255,255,225);position:absolute;left:'+ left +'px;top:'+ top +'px;box-sizing:border-box;z-index:100;">' +
                                    '<div class="jfgrid-postil-dialog-move">' +
                                        '<div class="jfgrid-postil-dialog-move-item jfgrid-postil-dialog-move-item-t" data-type="t"></div>' +
                                        '<div class="jfgrid-postil-dialog-move-item jfgrid-postil-dialog-move-item-r" data-type="r"></div>' +
                                        '<div class="jfgrid-postil-dialog-move-item jfgrid-postil-dialog-move-item-b" data-type="b"></div>' +
                                        '<div class="jfgrid-postil-dialog-move-item jfgrid-postil-dialog-move-item-l" data-type="l"></div>' +
                                    '</div>' +
                                    '<div class="jfgrid-postil-dialog-resize" style="display:none;">' +
                                        '<div class="jfgrid-postil-dialog-resize-item jfgrid-postil-dialog-resize-item-lt" data-type="lt"></div>' +
                                        '<div class="jfgrid-postil-dialog-resize-item jfgrid-postil-dialog-resize-item-mt" data-type="mt"></div>' +
                                        '<div class="jfgrid-postil-dialog-resize-item jfgrid-postil-dialog-resize-item-lm" data-type="lm"></div>' +
                                        '<div class="jfgrid-postil-dialog-resize-item jfgrid-postil-dialog-resize-item-rm" data-type="rm"></div>' +
                                        '<div class="jfgrid-postil-dialog-resize-item jfgrid-postil-dialog-resize-item-rt" data-type="rt"></div>' +
                                        '<div class="jfgrid-postil-dialog-resize-item jfgrid-postil-dialog-resize-item-lb" data-type="lb"></div>' +
                                        '<div class="jfgrid-postil-dialog-resize-item jfgrid-postil-dialog-resize-item-mb" data-type="mb"></div>' +
                                        '<div class="jfgrid-postil-dialog-resize-item jfgrid-postil-dialog-resize-item-rb" data-type="rb"></div>' +
                                    '</div>' +
                                    '<div style="width:100%;height:100%;overflow:hidden;">' + 
                                        '<div class="formulaInputFocus" style="width:'+ (width - 12) +'px;height:'+ (height - 12) +'px;line-height:18px;word-break:break-all;" spellcheck="false" contenteditable="true">' +
                                            value +
                                        '</div>' +
                                    '</div>' +
                                '</div>' +
                            '</div>';

                $(html).appendTo($("#jfgrid-cell-main #jfgrid-postil-showBoxs"));

                var ctx = $("#jfgrid-postil-show_"+ r +"_"+ c +" .arrowCanvas").get(0).getContext("2d");

                jfgrid.postil.drawArrow(ctx, size[4], size[5], size[6], size[7]);

                jfgrid.postil.init();
            }

            rc.push(r + "_" + c);

            jfgrid.postil.ref(d, rc);
        },
        showHideAllPs: function(){
            var d = jfgrid.editor.deepCopyFlowData(jfgrid.flowdata);

            var isAllShow = true;
            var allPs = [];

            for(var r = 0; r < d.length; r++){
                for(var c = 0; c < d[0].length; c++){
                    if(d[r] != null && d[r][c] != null && d[r][c].ps != null){
                        allPs.push(r + "_" + c);

                        if(!d[r][c].ps.isshow){
                            isAllShow = false;
                        }
                    }
                }
            }

            if(allPs.length > 0){
                var rc = [];

                if(isAllShow){ //全部显示，操作为隐藏所有批注
                    $("#jfgrid-cell-main #jfgrid-postil-showBoxs").empty();

                    for(var i = 0; i < allPs.length; i++){
                        var rowIndex = allPs[i].split("_")[0];
                        var colIndex = allPs[i].split("_")[1];

                        var postil = d[rowIndex][colIndex].ps;

                        if(postil["isshow"]){
                            d[rowIndex][colIndex].ps.isshow = false;
                            rc.push(allPs[i]);
                        }
                    }
                }
                else{ //部分显示或全部隐藏，操作位显示所有批注
                    for(var i = 0; i < allPs.length; i++){
                        var rowIndex = allPs[i].split("_")[0];
                        var colIndex = allPs[i].split("_")[1];

                        var postil = d[rowIndex][colIndex].ps;

                        if(!postil["isshow"]){
                            var row = visibledatarow[rowIndex], row_pre = rowIndex - 1 == -1 ? 0 : visibledatarow[rowIndex - 1];
                            var col = visibledatacolumn[colIndex], col_pre = colIndex - 1 == -1 ? 0 : visibledatacolumn[colIndex - 1];

                            var margeset = jfgrid.menuButton.mergeborer(jfgrid.flowdata, rowIndex, colIndex);
                            if(!!margeset){
                                row = margeset.row[1];
                                row_pre = margeset.row[0];
                                
                                col = margeset.column[1];
                                col_pre = margeset.column[0];
                            }

                            var toX = col;
                            var toY = row_pre;

                            var left = postil["left"] == null ? toX + 18 : postil["left"];
                            var top = postil["top"] == null ? toY - 18 : postil["top"];
                            var width = postil["width"] == null ? jfgrid.postil.defaultWidth : postil["width"];
                            var height = postil["height"] == null ? jfgrid.postil.defaultHeight : postil["height"];
                            var value = postil["value"] == null ? "" : postil["value"];

                            if(top < 0){
                                top = 2;
                            }

                            var size = jfgrid.postil.getArrowCanvasSize(left, top, toX, toY);

                            var html =  '<div id="jfgrid-postil-show_'+ rowIndex +'_'+ colIndex +'" class="jfgrid-postil-show">' +
                                            '<canvas class="arrowCanvas" width="'+ size[2] +'" height="'+ size[3] +'" style="position:absolute;left:'+ size[0] +'px;top:'+ size[1] +'px;z-index:100;"></canvas>' +
                                            '<div class="jfgrid-postil-show-main" style="width:'+ width +'px;height:'+ height +'px;color:#000;padding:5px;border:1px solid #000;background-color:rgb(255,255,225);position:absolute;left:'+ left +'px;top:'+ top +'px;box-sizing:border-box;z-index:100;">' +
                                                '<div class="jfgrid-postil-dialog-move">' +
                                                    '<div class="jfgrid-postil-dialog-move-item jfgrid-postil-dialog-move-item-t" data-type="t"></div>' +
                                                    '<div class="jfgrid-postil-dialog-move-item jfgrid-postil-dialog-move-item-r" data-type="r"></div>' +
                                                    '<div class="jfgrid-postil-dialog-move-item jfgrid-postil-dialog-move-item-b" data-type="b"></div>' +
                                                    '<div class="jfgrid-postil-dialog-move-item jfgrid-postil-dialog-move-item-l" data-type="l"></div>' +
                                                '</div>' +
                                                '<div class="jfgrid-postil-dialog-resize" style="display:none;">' +
                                                    '<div class="jfgrid-postil-dialog-resize-item jfgrid-postil-dialog-resize-item-lt" data-type="lt"></div>' +
                                                    '<div class="jfgrid-postil-dialog-resize-item jfgrid-postil-dialog-resize-item-mt" data-type="mt"></div>' +
                                                    '<div class="jfgrid-postil-dialog-resize-item jfgrid-postil-dialog-resize-item-lm" data-type="lm"></div>' +
                                                    '<div class="jfgrid-postil-dialog-resize-item jfgrid-postil-dialog-resize-item-rm" data-type="rm"></div>' +
                                                    '<div class="jfgrid-postil-dialog-resize-item jfgrid-postil-dialog-resize-item-rt" data-type="rt"></div>' +
                                                    '<div class="jfgrid-postil-dialog-resize-item jfgrid-postil-dialog-resize-item-lb" data-type="lb"></div>' +
                                                    '<div class="jfgrid-postil-dialog-resize-item jfgrid-postil-dialog-resize-item-mb" data-type="mb"></div>' +
                                                    '<div class="jfgrid-postil-dialog-resize-item jfgrid-postil-dialog-resize-item-rb" data-type="rb"></div>' +
                                                '</div>' +
                                                '<div style="width:100%;height:100%;overflow:hidden;">' + 
                                                    '<div class="formulaInputFocus" style="width:'+ (width - 12) +'px;height:'+ (height - 12) +'px;line-height:18px;word-break:break-all;" spellcheck="false" contenteditable="true">' +
                                                        value +
                                                    '</div>' +
                                                '</div>' +
                                            '</div>' +
                                        '</div>';

                            $(html).appendTo($("#jfgrid-cell-main #jfgrid-postil-showBoxs"));

                            var ctx = $("#jfgrid-postil-show_"+ rowIndex +"_"+ colIndex +" .arrowCanvas").get(0).getContext("2d");

                            jfgrid.postil.drawArrow(ctx, size[4], size[5], size[6], size[7]);

                            d[rowIndex][colIndex].ps.isshow = true;
                            rc.push(allPs[i]);
                        }
                    }
                }
            }

            jfgrid.postil.ref(d, rc);

            jfgrid.postil.init();
        },
        removeActivePs: function(){
            if($("#jfgrid-postil-showBoxs .jfgrid-postil-show-active").length > 0){
                var id = $("#jfgrid-postil-showBoxs .jfgrid-postil-show-active").attr("id");

                $("#" + id).removeClass("jfgrid-postil-show-active");
                $("#" + id).find(".jfgrid-postil-dialog-resize").hide();
                $("#" + id).find(".arrowCanvas").css("z-index", 100);
                $("#" + id).find(".jfgrid-postil-show-main").css("z-index", 100);

                var r = id.split("jfgrid-postil-show_")[1].split("_")[0];
                var c = id.split("jfgrid-postil-show_")[1].split("_")[1];

                var value = $("#" + id).find(".formulaInputFocus").text();

                var d = jfgrid.editor.deepCopyFlowData(jfgrid.flowdata);
                var rc = [];

                d[r][c].ps.value = value;
                rc.push(r + "_" + c);

                jfgrid.postil.ref(d, rc);

                if(!d[r][c].ps.isshow){
                    $("#" + id).remove();
                }
            }
        },
        ref: function(data, rc){
            if (clearjfundo) {
                jfgrid.jfundo = [];
                
                jfgrid.jfredo.push({ 
                    "type": "postil", 
                    "data": jfgrid.flowdata, 
                    "curdata": data, 
                    "sheetIndex": jfgrid.currentSheetIndex,
                    "rc": rc 
                });
            }

            //jfgrid.flowdata
            jfgrid.flowdata = data;
            jfgrid.editor.webWorkerFlowDataCache(jfgrid.flowdata);//worker存数据

            jfgridfile[jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex)].data = jfgrid.flowdata;
            jfgrid.formula.execFunctionGroupData = jfgrid.flowdata;

            //共享编辑模式
            if(jfgrid.server.allowUpdate){
                for(var i = 0; i < rc.length; i++){
                    var r = rc[i].split("_")[0];
                    var c = rc[i].split("_")[1];

                    jfgrid.server.saveParam("v", jfgrid.currentSheetIndex, jfgrid.flowdata[r][c], { "r": r, "c": c });
                }
            }
            
            //刷新表格
            setTimeout(function () {
                jfgrid.jfgridrefreshgrid();
            }, 1);
        },
        positionSync: function(){
            $("#jfgrid-postil-showBoxs .jfgrid-postil-show").each(function(i, e){
                var id = $(e).attr("id");

                var r = id.split("jfgrid-postil-show_")[1].split("_")[0];
                var c = id.split("jfgrid-postil-show_")[1].split("_")[1];

                jfgrid.postil.buildPs(r, c, jfgrid.flowdata[r][c].ps);
            });
        }
    }

    jfgrid.hasChinaword = function (s) {
        var patrn = /[\u4E00-\u9FA5]|[\uFE30-\uFFA0]/gi;
        if (!patrn.exec(s)) {
            return false;
        }
        else {
            return true;
        }
    }

    jfgrid.getdatabyselectionD = function (d, range) {
        if (range == null || range["row"] == null || range["row"].length == 0) {
            return [];
        }
        
        var dynamicArray_compute = jfgrid.dynamicArray_compute(jfgridfile[jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex)]["dynamicArray"]);
        var data = [];

        for (var r = range["row"][0]; r <= range["row"][1]; r++) {
            if(d[r] == null){
                continue;
            }

            if (config["rowhidden"] != null && config["rowhidden"][r] != null) {
                continue;
            }

            var row = [];

            for (var c = range["column"][0]; c <= range["column"][1]; c++) {
                var value;
                
                if((r + "_" + c) in dynamicArray_compute){
                    value = dynamicArray_compute[r + "_" + c];
                }
                else{
                    value = d[r][c];
                }

                row.push(value);
            }

            data.push(row);
        }

        return data;
    }

    jfgrid.getdatabyselection = function (range, sheetIndex) {
        if (range == null || range["row"] == null || range["row"].length == 0) {
            return [];
        }

        //取数据
        if(sheetIndex != null && sheetIndex != jfgrid.currentSheetIndex){
            var d = jfgridfile[jfgrid.sheetmanage.getSheetIndex(sheetIndex)]["data"];
            var cfg = jfgridfile[jfgrid.sheetmanage.getSheetIndex(sheetIndex)]["config"];
        }
        else{
            var d = jfgrid.editor.deepCopyFlowData(jfgrid.flowdata);
            var cfg = config;    
        }

        var data = [];

        for (var r = range["row"][0]; r <= range["row"][1]; r++) {
            if(d[r] == null){
                continue;
            }

            if (cfg["rowhidden"] != null && cfg["rowhidden"][r] != null) {
                continue;
            }

            var row = [];

            for (var c = range["column"][0]; c <= range["column"][1]; c++) {
                row.push(d[r][c]);
            }

            data.push(row);
        }

        return data;
    }

    //计算范围行高
    jfgrid.rowlenByRange = function(d, r1, r2, cfg){
        var cfg_clone = $.extend(true, {}, cfg);
        if(cfg_clone["rowlen"] == null){
            cfg_clone["rowlen"] = {};
        }

        var ctcanvas = $("#jfgridTableContent").get(0).getContext("2d");
        for(var r = r1; r <= r2; r++){
            if (cfg_clone["rowhidden"] != null && cfg_clone["rowhidden"][r] != null) {
                continue;
            }

            var currentRowLen = defaultrowlen;
            if(cfg_clone["rowlen"][r] != null){
                currentRowLen = cfg_clone["rowlen"][r];
            }

            for(var c = 0; c < d[r].length; c++){
                if(d[r][c] != null && d[r][c]["v"] != null && d[r][c]["tb"] != null && d[r][c]["tb"] == "2"){
                    //自动换行
                    var fontset = jfgridfontformat(d[r][c]);
                    ctcanvas.font = fontset;
                    var oneLineTextHeight = jfgrid.menuButton.getTextSize("田", fontset)[1];

                    var cellText = jfgrid.getcellvalue(r,c,d).toString(); //单元格文本
                    var textWidth = ctcanvas.measureText(cellText).width; //文本宽度
                    var cellWidth = jfgrid.colLocationByIndex(c)[1] - jfgrid.colLocationByIndex(c)[0] - 8; //单元格宽度

                    var computeRowlen; //计算行高
                    if(textWidth > cellWidth){
                        var strArr = []; //文本截断数组
                        for(var strI = 1; strI <= cellText.length; strI++){
                            var strV = cellText.substring(strArr.join("").length, strI);
                            var strtextMetrics = ctcanvas.measureText(strV).width;
                            if(strtextMetrics > cellWidth){
                                strArr.push(cellText.substring(strArr.join("").length, strI-1));
                                strI = strI-2;
                            }
                            else if(strtextMetrics <= cellWidth && strI == cellText.length){
                                strArr.push(strV);
                            }
                        }
                        computeRowlen = oneLineTextHeight * strArr.length;
                    }
                    else{
                        computeRowlen = oneLineTextHeight;
                    }
                    //比较计算行高和当前行高取最大高度
                    if(computeRowlen > currentRowLen){
                        currentRowLen = computeRowlen;
                    }
                }
                else if(d[r][c] != null && d[r][c]["v"] != null && d[r][c]["tr"] != null){
                    //文本旋转
                    var fontset = jfgridfontformat(d[r][c]);
                    ctcanvas.font = fontset;
                    var oneLineTextHeight = jfgrid.menuButton.getTextSize("田", fontset)[1];

                    var cellText = jfgrid.getcellvalue(r,c,d).toString(); //单元格文本
                    var textWidth = ctcanvas.measureText(cellText).width; //文本宽度

                    var computeRowlen; //计算行高
                    if(d[r][c]["tr"] == "0"){
                        //无旋转
                        computeRowlen = oneLineTextHeight;
                    }
                    else if(d[r][c]["tr"] == "1" || d[r][c]["tr"] == "2"){
                        //向下倾斜（45 旋转）----向上倾斜（-45 旋转）
                        computeRowlen = 0.707 * (textWidth + oneLineTextHeight) + 4;
                    }
                    else if(d[r][c]["tr"] == "3"){
                        //竖排文字
                        computeRowlen = cellText.length * oneLineTextHeight + 4;
                    }
                    else if(d[r][c]["tr"] == "4" || d[r][c]["tr"] == "5"){
                        //向下90（90 旋转）----向上90（-90 旋转）
                        computeRowlen = textWidth + 4;
                    }
                    computeRowlen = Math.round(computeRowlen);
                    //比较计算高度和当前高度取最大高度
                    if(computeRowlen > currentRowLen){
                        currentRowLen = computeRowlen;
                    }
                } 
                else{
                    var fontset = jfgridfontformat(d[r][c]);
                    var oneLineTextHeight = jfgrid.menuButton.getTextSize("田", fontset)[1];
                    //比较计算高度和当前高度取最大高度
                    if(oneLineTextHeight > currentRowLen){
                        currentRowLen = oneLineTextHeight;
                    }
                }
            }

            if(currentRowLen != defaultrowlen){
                cfg_clone["rowlen"][r] = currentRowLen;
            }
        }

        return cfg_clone;
    }

    //计算表格行高数组
    jfgrid.computeRowlenArr = function(rowHeight, cfg){
        var rowlenArr = [];
        var rh_height = 0;

        for (var i = 0; i < rowHeight; i++) {
            var rowlen = defaultrowlen;
            if (cfg["rowlen"] != null && cfg["rowlen"][i] != null) {
                rowlen = cfg["rowlen"][i];
            }
            if (cfg["rowhidden"] != null && cfg["rowhidden"][i] != null) {
                rowlen = cfg["rowhidden"][i];
                rowlenArr.push(rh_height);
                continue;
            }
            else {
                rh_height += rowlen + 1;
            }
            rowlenArr.push(rh_height);//行的临时长度分布
        }

        return rowlenArr;
    }

    jfgrid.getdatabyselectionNoCopy = function (range) {
        if (range == null || range["row"] == null || range["row"].length == 0) {
            return [];
        }

        var data = [];

        for (var r = range["row"][0]; r <= range["row"][1]; r++) {
            var row = [];
            
            if (config["rowhidden"] != null && config["rowhidden"][r] != null) {
                continue;
            }

            for (var c = range["column"][0]; c <= range["column"][1]; c++) {
                var value = "";

                if (jfgrid.flowdata[r] != null && jfgrid.flowdata[r][c] != null) {
                    value = jfgrid.flowdata[r][c];
                }

                row.push(value);
            }
            
            data.push(row);
        }

        return data;
    }

    jfgrid.datagridgrowth = function (data, addr, addc, iscallback) {
        if (addr <= 0 && addc <= 0) {
            return data;
        }

        if (addr <= 0) {
            addr = 0;
        }

        if (addc <= 0) {
            addc = 0;
        }

        var dataClen = 0;
        if (data.length == 0) {
            data = [];
            dataClen = 0;
        }
        else {
            dataClen = data[0].length;
        }

        var coladd = [];//需要额外增加的空列
        for (var c = 0; c < addc; c++) {
            coladd.push(null);
        }

        var rowadd = [];//完整的一个空行
        for (var r = 0; r < dataClen + addc; r++) {
            rowadd.push(null);
        }

        for (var r = 0; r < data.length; r++) {
            data[r] = [].concat(data[r].concat(coladd));
        }

        for (var r = 0; r < addr; r++) {
            data.push([].concat(rowadd));
        }

        if(!!iscallback){
            jfgrid.server.saveParam("all", jfgrid.currentSheetIndex, data.length, { "k": "row" });
            jfgrid.server.saveParam("all", jfgrid.currentSheetIndex, data[0].length, { "k": "column" });
        }

        return data;
    }

    jfgrid.cleargridelement = function (event) {
        $("#jfgrid-cols-h-hover").hide();
        $("#jfgrid-rightclick-menu").hide();

        $("#jfgrid-cell-selected-boxs .jfgrid-cell-selected").hide();
        $("#jfgrid-cols-h-selected .jfgrid-cols-h-selected").hide();
        $("#jfgrid-rows-h-selected .jfgrid-rows-h-selected").hide();

        $("#jfgrid-cell-selected-focus").hide();
        $("#jfgrid-rows-h-hover").hide();
        $("#jfgrid-selection-copy .jfgrid-selection-copy").hide();
        $("#jfgrid-cols-menu-btn").hide();
        $("#jfgrid-row-count-show, #jfgrid-column-count-show").hide();
        if (!event) {
            jfgrid.selection.clearcopy(event);
        }
        //else{
        //	jfgrid.selection.clearcopy();
        //}

        //选区下拉icon隐藏
        if($("#jfgrid-dropCell-icon").is(":visible")){
            if(event){
                $("#jfgrid-dropCell-icon").remove();
            }
        }
        //格式刷
        if(jfgrid.menuButton.jfgridPaintModelOn && !event){
            jfgrid.menuButton.cancelPaintModel();
        }
    }

    jfgrid.orderbydata = function (data, index, isAsc) {
        if (isAsc == null) {
            isAsc = true;
        }

        var a = function (x, y) {
            var x1 = x[index] , y1 = y[index];

            if(jfgrid.getObjType(x[index]) == "object"){
                x1 = x[index].v;
            }

            if(jfgrid.getObjType(y[index]) == "object"){
                y1 = y[index].v;
            }

            if(jfgrid.func_methods.isRealNull(x1)){
                return 1;
            }

            if(jfgrid.func_methods.isRealNull(y1)){
                return -1;
            }

            // if(x1 == null){
            //     x1 = "";
            // }

            // if(y1 == null){
            //     y1 = "";
            // }

            if (jfgrid.datecontroll.isdatetime(x1) && jfgrid.datecontroll.isdatetime(y1)) {
                return jfgrid.datecontroll.diff(x1, y1);
            }
            else if (jfgrid.func_methods.isRealNum(x1) && jfgrid.func_methods.isRealNum(y1)) {
                return numeral(x1).value() - numeral(y1).value();
            }
            else if (!jfgrid.func_methods.isRealNum(x1) && !jfgrid.func_methods.isRealNum(y1)) {
                return x1.localeCompare(y1, "zh");
            }
            else if (!jfgrid.func_methods.isRealNum(x1)) {
                return 1;
            }
            else if (!jfgrid.func_methods.isRealNum(y1)) {
                return -1;
            }
        }

        var d = function (x, y) {
            var x1 = x[index] , y1 = y[index];

            if(jfgrid.getObjType(x[index]) == "object"){
                x1 = x[index].v;
            }

            if(jfgrid.getObjType(y[index]) == "object"){
                y1 = y[index].v;
            }

            if(jfgrid.func_methods.isRealNull(x1)){
                return 1;
            }

            if(jfgrid.func_methods.isRealNull(y1)){
                return -1;
            }

            // if(x1 == null){
            //     x1 = "";
            // }

            // if(y1 == null){
            //     y1 = "";
            // }

            if (jfgrid.datecontroll.isdatetime(x1) && jfgrid.datecontroll.isdatetime(y1)) {
                return jfgrid.datecontroll.diff(y1, x1);
            }
            else if (jfgrid.func_methods.isRealNum(x1) && jfgrid.func_methods.isRealNum(y1)) {
                return numeral(y1).value() - numeral(x1).value();
            }
            else if (!jfgrid.func_methods.isRealNum(x1) && !jfgrid.func_methods.isRealNum(y1)) {
                return y1.localeCompare(x1, "zh");
            }
            else if (!jfgrid.func_methods.isRealNum(x1)) {
                return -1;
            }
            else if (!jfgrid.func_methods.isRealNum(y1)) {
                return 1;
            }
        }

        if (isAsc) {
            return data.sort(a);
        }
        else {
            return data.sort(d);
        }
    }

    jfgrid.orderbydata1D = function (data, isAsc) {
        if (isAsc == null) {
            isAsc = true;
        }

        var a = function (x, y) {
            var x1 = x, y1 = y;

            if(jfgrid.getObjType(x) == "object"){
                x1 = x.v;
            }

            if(jfgrid.getObjType(y) == "object"){
                y1 = y.v;
            }

            if(x1 == null){
                x1 = "";
            }

            if(y1 == null){
                y1 = "";
            }

            if (jfgrid.datecontroll.isdatetime(x1) && jfgrid.datecontroll.isdatetime(y1)) {
                return jfgrid.datecontroll.diff(x1, y1);
            }
            else if (jfgrid.func_methods.isRealNum(x1) && jfgrid.func_methods.isRealNum(y1)) {
                return numeral(x1).value() - numeral(y1).value();
            }
            else if (!jfgrid.func_methods.isRealNum(x1) && !jfgrid.func_methods.isRealNum(y1)) {
                return x1.localeCompare(y1, "zh");
            }
            else if (!jfgrid.func_methods.isRealNum(x1)) {
                return 1;
            }
            else if (!jfgrid.func_methods.isRealNum(y1)) {
                return -1;
            }
        }

        var d = function (x, y) {
            var x1 = x, y1 = y;

            if(jfgrid.getObjType(x) == "object"){
                x1 = x.v;
            }

            if(jfgrid.getObjType(y) == "object"){
                y1 = y.v;
            }

            if(x1 == null){
                x1 = "";
            }

            if(y1 == null){
                y1 = "";
            }

            if (jfgrid.datecontroll.isdatetime(x1) && jfgrid.datecontroll.isdatetime(y1)) {
                return jfgrid.datecontroll.diff(y1, x1);
            }
            else if (jfgrid.func_methods.isRealNum(x1) && jfgrid.func_methods.isRealNum(y1)) {
                return numeral(y1).value() - numeral(x1).value();
            }
            else if (!jfgrid.func_methods.isRealNum(x1) && !jfgrid.func_methods.isRealNum(y1)) {
                return y1.localeCompare(x1, "zh");
            }
            else if (!jfgrid.func_methods.isRealNum(x1)) {
                return -1;
            }
            else if (!jfgrid.func_methods.isRealNum(y1)) {
                return 1;
            }
        }

        if (isAsc) {
            return data.sort(a);
        }
        else {
            return data.sort(d);
        }
    }

    //排序选区数据
    jfgrid.sortSelection = function(isAsc){
        if(jfgird_select_save.length > 1){
            if(jfgrid.isEditMode()){
                alert("不能对多重选择区域执行此操作，请选择单个区域，然后再试");
            }
            else{
                jfgrid.tooltip.info("不能对多重选择区域执行此操作，请选择单个区域，然后再试", "");
            }

            return;
        }

        if(isAsc == null){
            isAsc = true;
        }

        var d = jfgrid.editor.deepCopyFlowData(jfgrid.flowdata);

        var r1 = jfgird_select_save[0].row[0], r2 = jfgird_select_save[0].row[1];
        var c1 = jfgird_select_save[0].column[0], c2 = jfgird_select_save[0].column[1];

        var str, edr;

        for(var r = r1; r <= r2; r++){
            if(d[r] != null && d[r][c1] != null){
                var cell = d[r][c1];

                if(cell.mc != null || jfgrid.func_methods.isRealNull(cell.v)){
                    continue;
                }

                if(str == null && /[\u4e00-\u9fa5]+/g.test(cell.v)){
                    str = r + 1;
                    edr = r + 1;
                    continue;
                }
                
                if(str == null){
                    str = r;    
                }

                edr = r;
            }
        }

        if(str == null || str > r2){
            return;
        }

        var hasMc = false; //排序选区是否有合并单元格
        var data = [];

        for(var r = str; r <= edr; r++){
            var data_row = [];

            for(var c = c1; c <= c2; c++){
                if(d[r][c] != null && d[r][c].mc != null){
                    hasMc = true;
                    break;
                }

                data_row.push(d[r][c]);
            }

            data.push(data_row);
        }

        if(hasMc){
            if(jfgrid.isEditMode()){
                alert("选区有合并单元格，无法执行此操作！");
            }
            else{
                jfgrid.tooltip.info("选区有合并单元格，无法执行此操作！", "");
            }

            return;
        }

        data = jfgrid.orderbydata(data, 0, isAsc);

        for(var r = str; r <= edr; r++){
            for(var c = c1; c <= c2; c++){
                d[r][c] = data[r - str][c - c1];
            }
        }

        if(config["rowlen"] != null){
            var cfg = $.extend(true, {}, config);
            cfg = jfgrid.rowlenByRange(d, str, edr, cfg);

            jfgrid.jfrefreshgrid(d, [{ "row": [str, edr], "column": [c1, c2] }], cfg, null, true);
        }
        else{
            jfgrid.jfrefreshgrid(d, [{ "row": [str, edr], "column": [c1, c2] }]);
        }
    }

    //排序一列数据
    jfgrid.sortColumnSeletion = function(colIndex, isAsc){
        if(isAsc == null){
            isAsc = true;
        }

        var d = jfgrid.editor.deepCopyFlowData(jfgrid.flowdata);

        var r1 = 0, r2 = d.length - 1;
        var c1 = 0, c2 = d[0].length - 1;

        var str, edr;

        for(var r = r1; r <= r2; r++){
            if(d[r][colIndex] != null && d[r][colIndex].mc != null){
                continue;
            }

            if(d[r][colIndex] != null && !jfgrid.func_methods.isRealNull(d[r][colIndex].v) && /[\u4e00-\u9fa5]+/g.test(d[r][colIndex].v) && str == null){
                str = r + 1;
                edr = r + 1;
                continue;
            }

            if(str == null){
                str = r;    
            }

            if(d[r][colIndex] != null && !jfgrid.func_methods.isRealNull(d[r][colIndex].v)){
                edr = r;
            }
        }

        if(str == null || str > r2){
            return;
        }

        var hasMc = false; //排序选区是否有合并单元格
        var data = [];

        for(var r = str; r <= edr; r++){
            var data_row = [];

            for(var c = c1; c <= c2; c++){
                if(d[r][c] != null && d[r][c].mc != null){
                    hasMc = true;
                    break;
                }

                data_row.push(d[r][c]);
            }

            data.push(data_row);
        }

        if(hasMc){
            if(jfgrid.isEditMode()){
                alert("列排序会扩展至整个表格选区，选区有合并单元格，无法执行此操作，请选择功能栏排序功能！");
            }
            else{
                jfgrid.tooltip.info("列排序会扩展至整个表格选区，选区有合并单元格，无法执行此操作，请选择功能栏排序功能！", "");
            }

            return;
        }

        data = jfgrid.orderbydata(data, colIndex, isAsc);

        for(var r = str; r <= edr; r++){
            for(var c = c1; c <= c2; c++){
                d[r][c] = data[r - str][c - c1];
            }
        }

        if(config["rowlen"] != null){
            var cfg = $.extend(true, {}, config);
            cfg = jfgrid.rowlenByRange(d, str, edr, cfg);

            jfgrid.jfrefreshgrid(d, [{ "row": [str, edr], "column": [c1, c2] }], cfg, null, true);
        }
        else{
            jfgrid.jfrefreshgrid(d, [{ "row": [str, edr], "column": [c1, c2] }]);
        }
    }

    /*
    data: [{"name":"Sheet1",color:"","status":"1","order":"0","data":[], "theme":{}},{"name":"Sheet2",color:"","status":"0","order":"1","data":[]},{"name":"Sheet3",color:"","status":"0","order":"2","data":[]}],
    */
    var jfgridfile = null, container = null, defaultcolumnNum = 60, defaultrowNum = 84, fullscreenmode = true;

    jfgrid.getjfgridfile = function(){
        return jfgridfile;
    }

    jfgrid.setjfgridfile = function (d) {
        jfgridfile = d;
    }

    jfgrid.getconfig = function () {
        return config;
    };

    jfgrid.setconfig = function (v) {
        config = v;

        if(jfgridfile != null){
            jfgridfile[jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex)].config = v;
        }
    };

    jfgrid.getvisibledatarow = function(){
        return visibledatarow;
    };

    jfgrid.setvisibledatarow = function (v) {
        visibledatarow = v;

        if(jfgridfile != null){
            jfgridfile[jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex)].visibledatarow = v;
        }
    };

    jfgrid.getvisibledatacolumn = function () {
        return visibledatacolumn;
    };

    jfgrid.setvisibledatacolumn = function (v) {
        visibledatacolumn = v;

        if(jfgridfile != null){
            jfgridfile[jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex)].visibledatacolumn = v;
        }
    };

    jfgrid.sheetmanage = {
        generateRandomSheetIndex: function(prefix){
            if(prefix == null){
                prefix = "Sheet";
            }

            var userAgent = window.navigator.userAgent.replace(/[^a-zA-Z0-9]/g, "").split("");

            var mid = "";

            for(var i = 0; i < 12; i++){
                mid += userAgent[Math.round(Math.random() * (userAgent.length - 1))];
            }

            var time = new Date().getTime();

            return prefix + "_" + mid + "_" + time;
        },
        generateRandomSheetName: function(file, isPivotTable){
            var sheetname = "";

            var index = file.length;

            for(var i = 0; i < file.length; i++){
                if(file[i].name.indexOf("Sheet") > -1 || file[i].name.indexOf("数据透视表") > -1){
                    var suffix = parseFloat(file[i].name.replace("Sheet", "").replace("数据透视表", ""));

                    if(suffix != "NaN" && Math.ceil(suffix) > index){
                        index = Math.ceil(suffix);
                    }
                }
            }

            if(isPivotTable){
                return "数据透视表" + (index + 1);
            }
            else{
                return "Sheet" + (index + 1);
            }
        },
        generateCopySheetName: function(file, name){
            var copySheetName = "";

            if(name.toString().indexOf("(副本") > -1){
                var copy_i = name.toString().indexOf("(副本");

                var name2 = name.toString().substring(0, copy_i) + "(副本";

                var index = null;

                for(var i = 0; i < file.length; i++){
                    var fileName = file[i].name.toString();

                    var st_i = fileName.indexOf(name2);

                    if(st_i > -1){
                        var ed_i = fileName.indexOf(")", st_i + name2.length);

                        var num = fileName.substring(st_i + name2.length, ed_i);

                        if(jfgrid.func_methods.isRealNum(num)){
                            if(index == null || parseInt(num) > index){
                                index = parseInt(num);
                            }
                        }
                    }
                }

                if(index == null){
                    copySheetName = name2 + "2)";
                }
                else{
                    index++;

                    copySheetName = name2 + index + ")";
                }
            }
            else{
                var index = null;
                var hascopy = false;

                var name2 = name + "(副本";

                for(var i = 0; i < file.length; i++){
                    var fileName = file[i].name.toString();

                    var st_i = fileName.indexOf(name2);

                    if(st_i > -1){
                        hascopy = true;

                        var ed_i = fileName.indexOf(")", st_i + name2.length);

                        var num = fileName.substring(st_i + name2.length, ed_i);

                        if(jfgrid.func_methods.isRealNum(num)){
                            if(index == null || parseInt(num) > index){
                                index = parseInt(num);
                            }
                        }
                    }
                }

                if(hascopy){
                    if(index == null){
                        copySheetName = name + "(副本2)";
                    }
                    else{
                        index++;

                        copySheetName = name + "(副本" + index + ")";
                    }
                }
                else{
                    copySheetName = name + "(副本)";
                }
            }

            return copySheetName;
        },
        getSheetByIndex:function(index){
            if(index == null){
                index = jfgrid.currentSheetIndex;
            }
            var i = this.getSheetIndex(index);
            return jfgridfile[i];
        },
        getCurSheetnoset: function () {
            var curindex = 0;
            for (var i = 0; i < jfgridfile.length; i++) {
                if (jfgridfile[i].status == 1) {
                    curindex = jfgridfile[i].index;
                    break;
                }
            }
            return curindex;
        },
        getCurSheet: function () {
            jfgrid.currentSheetIndex = jfgridfile[0].index;

            for (var i = 0; i < jfgridfile.length; i++) {
                if (jfgridfile[i].status == 1) {
                    jfgrid.currentSheetIndex = jfgridfile[i].index;
                    break;
                }
            }
            
            return jfgrid.currentSheetIndex;
        },
        addNewSheet: function (e, isPivotTable) {
            if(jfgrid.isEditMode()){
                // alert("非编辑模式下不允许该操作！");
                return;
            }

            var order = jfgridfile.length;
            var index = jfgrid.sheetmanage.generateRandomSheetIndex();

            var sheetname = jfgrid.sheetmanage.generateRandomSheetName(jfgrid.getjfgridfile(), isPivotTable);
            
            $("#jfgrid-sheet-container-c").append(jfgrid.replaceHtml(sheetHTML, { "index": index, "active": "", "name": sheetname, "style": "","colorset":"" }));

            var sheetconfig = { 
                "name": sheetname, 
                "color": "", 
                "status": "0", 
                "order": order, 
                "index": index, 
                "celldata": [], 
                "row": defaultrowNum, 
                "column": defaultcolumnNum, 
                "config": {}, 
                "pivotTable": null, 
                "isPivotTable": !!isPivotTable 
            };
            jfgridfile.push(sheetconfig);

            $("#jfgrid-sheet-area div.jfgrid-sheets-item").removeClass("jfgrid-sheets-item-active");
            $("#jfgrid-sheets-item" + index).addClass("jfgrid-sheets-item-active");
            $("#jfgrid-cell-main").append('<div id="jfgrid-datavisual-selection-set-' + index + '" class="jfgrid-datavisual-selection-set"></div>');
            jfgrid.cleargridelement(e);

            jfgrid.server.saveParam("sha", null, $.extend(true,{},sheetconfig));

            if (clearjfundo) {
                var redo = {};
                redo["type"] = "addSheet";
                jfgrid.jfundo = [];
                redo["sheetconfig"] = $.extend(true, {}, sheetconfig);
                redo["index"] = index;
                redo["currentSheetIndex"] = jfgrid.currentSheetIndex;
                jfgrid.jfredo.push(redo);
            }

            this.changeSheetExec(index, isPivotTable, true);
        },
        setSheetHide: function (index) {
            jfgridfile[this.getSheetIndex(index)].hide = 1;
            var jfgridcurrentSheetitem = $("#jfgrid-sheets-item" + index);
            jfgridcurrentSheetitem.hide();
            $("#jfgrid-sheet-area div.jfgrid-sheets-item").removeClass("jfgrid-sheets-item-active");
            var indicator = jfgridcurrentSheetitem.nextAll(":visible");
            if (jfgridcurrentSheetitem.nextAll(":visible").length > 0) {
                indicator = indicator.eq(0).data("index");
            }
            else {
                indicator = jfgridcurrentSheetitem.prevAll(":visible").eq(0).data("index");
            }
            $("#jfgrid-sheets-item" + indicator).addClass("jfgrid-sheets-item-active");
            this.changeSheetExec(indicator);

            //jfgrid.server.saveParam("sh", index, {"cur": indicator, "hide": 1});
            jfgrid.server.saveParam("sh", jfgridcurrentSheetitem.data("index"), 1, { "op": "hide", "cur": indicator });
        },
        setSheetShow: function (index) {
            jfgridfile[this.getSheetIndex(index)].hide = 0;
            this.changeSheetExec(index);

            jfgrid.server.saveParam("sh", index, 0, {"op": "show", "cur": null});
        },
        sheetMaxIndex: 0,
        ordersheet: function (property) {
            return function (a, b) {
                var value1 = a[property];
                var value2 = b[property];
                return value1 - value2;
            }
        },
        getCurrentOrder:function(){
            var orders = {};
            $("#jfgrid-sheet-area div.jfgrid-sheets-item").each(function (a) {
                var index = $(this).data("index");
                for (var i = 0; i < jfgridfile.length; i++) {
                    if (jfgridfile[i].index == index) {
                        orders[index.toString()] = a;
                        break;
                    }
                }
            });
            return orders;
        },
        reOrderAllSheet: function () {
            var orders = {};
            $("#jfgrid-sheet-area div.jfgrid-sheets-item").each(function (a) {
                var index = $(this).data("index");
                for (var i = 0; i < jfgridfile.length; i++) {
                    if (jfgridfile[i].index == index) {
                        jfgridfile[i].order = a;
                        orders[index.toString()] = a;
                        break;
                    }
                }
            });

            jfgrid.server.saveParam("shr", null, orders);
        },
        createSheet: function () { //修复拖动sheet更新后台后，重新打开显示错误
            var btn = [];
            jfgridfile.sort(this.ordersheet('order'));
            for (var i = 0; i < jfgridfile.length; i++) {
                var display = "";
                var sheetIndex = jfgridfile[i].index;

                var colorset = '';
                if(jfgridfile[i].color != null){
                    colorset = '<div class="jfgrid-sheets-item-color" style=" position: absolute; width: 100%; height: 3px; bottom: 0px; left: 0px; background-color: ' + jfgridfile[i].color + ';"></div>';
                }

                if (jfgrid.currentSheetIndex == sheetIndex) { //使用jfgridfile中的index比较，而不是order
                    btn.push(jfgrid.replaceHtml(sheetHTML, { "index": sheetIndex, "active": "jfgrid-sheets-item-active", "name": jfgridfile[i].name, "style": "","colorset":colorset }));
                }
                else {
                    if (jfgridfile[i].hide == 1) {
                        btn.push(jfgrid.replaceHtml(sheetHTML, { "index": sheetIndex, "active": "", "name": jfgridfile[i].name, "style": "display:none;","colorset":colorset }));
                    }
                    else {
                        btn.push(jfgrid.replaceHtml(sheetHTML, { "index": sheetIndex, "active": "", "name": jfgridfile[i].name, "style": "","colorset":colorset }));
                    }
                    display = "style='display:none;'";
                }
                //jfgridfile[i].index = i; //index即为默认
                // if(sheetIndex > this.sheetMaxIndex){
                //     this.sheetMaxIndex = sheetIndex;
                // }

                $("#jfgrid-cell-main").append('<div ' + display + ' id="jfgrid-datavisual-selection-set-' + sheetIndex + '" class="jfgrid-datavisual-selection-set"></div>');
            }

            $("#jfgrid-sheet-container-c").append(btn.join(""));

            this.locationSheet();
        },
        locationSheet:function(){
            var $c = $("#jfgrid-sheet-container-c"), winW = $("#"+container).width();
            var $cursheet = $("#jfgrid-sheet-container-c > div.jfgrid-sheets-item-active").eq(0);

            var scrollLeftpx = 0;
            var c_width = 0;
            $("#jfgrid-sheet-container-c > div.jfgrid-sheets-item:visible").each(function(){
                if($(this).hasClass("jfgrid-sheets-item-active")){
                    scrollLeftpx = c_width;
                }
                c_width += $(this).outerWidth();
            });
            
            setTimeout(function(){
                $c.scrollLeft(scrollLeftpx - 10);

                if (c_width >= winW * 0.7) {
                    $("#jfgrid-sheet-area .jfgrid-sheets-scroll").css("display", "inline-block");
                    $("#jfgrid-sheet-container .docs-sheet-fade-left").show();
                }
            }, 1)
        },
        copySheet: function (copyindex, e) {
            if(jfgrid.isEditMode()){
                // alert("非编辑模式下不允许该操作！");
                return;
            }

            var order = jfgridfile.length;
            var index = jfgrid.sheetmanage.generateRandomSheetIndex();
            
            var copyarrindex = this.getSheetIndex(copyindex);
            var copyjson = $.extend(true, {}, jfgridfile[copyarrindex]);
            copyjson.order = order;
            copyjson.index = index;
            copyjson.name = this.generateCopySheetName(jfgridfile, copyjson.name);
            
            var colorset = '';
            if(copyjson.color != null){
                colorset = '<div class="jfgrid-sheets-item-color" style=" position: absolute; width: 100%; height: 3px; bottom: 0px; left: 0px; background-color: ' + copyjson.color + ';"></div>';
            }

            var copyobject = $("#jfgrid-sheets-item" + copyindex);
            $("#jfgrid-sheet-container-c").append(jfgrid.replaceHtml(sheetHTML, { "index": copyjson.index, "active": "", "name": copyjson.name, "order": copyjson.order, "style": "", "colorset": colorset }));
            $("#jfgrid-sheets-item" + copyjson.index).insertAfter(copyobject);
            // jfgridfile.push(copyjson);
            jfgridfile.splice(copyindex + 1, 0, copyjson);

            $("#jfgrid-sheet-area div.jfgrid-sheets-item").removeClass("jfgrid-sheets-item-active");
            $("#jfgrid-sheets-item" + index).addClass("jfgrid-sheets-item-active");
            $("#jfgrid-cell-main").append('<div id="jfgrid-datavisual-selection-set-' + index + '" class="jfgrid-datavisual-selection-set"></div>');
            jfgrid.cleargridelement(e);

            // jfgrid.server.saveParam("shc", index, {"copyindex":copyindex});
            jfgrid.server.saveParam("shc", index, { "copyindex": copyindex, "name": copyjson.name });

            this.changeSheetExec(index);
            this.reOrderAllSheet();

            
            if (clearjfundo) {
                jfgrid.jfredo.push({ "type": "copySheet", "copyindex": copyindex, "index": copyjson.index, "sheetIndex": copyjson.index });
            }
            else if (jfgrid.jfredo.length > 0) {
                var jfredostr = jfgrid.jfredo[jfgrid.jfredo.length - 1];
                if (jfredostr.type == "copySheet") {
                    jfredostr.index = copyjson.index;
                    jfredostr.sheetIndex = copyjson.index;
                }
            }
        },
        hasSheet: function (index) {
            if (index == null) {
                return false;
            }

            index = this.getSheetIndex(index);
            if (index == null) {
                return false;
            }
            else {
                return true;
            }
        },
        createSheetbydata: function (data, isrenew) {
            var colorset = '';
            if(data.color != null){
                colorset = '<div class="jfgrid-sheets-item-color" style=" position: absolute; width: 100%; height: 3px; bottom: 0px; left: 0px; background-color: ' + data.color + ';"></div>';
            }

            $("#jfgrid-sheet-container-c").append(jfgrid.replaceHtml(sheetHTML, { "index": data.index, "active": "", "name": data.name, "order": data.order, "style": "", "colorset": colorset }));

            var previndex = data.order;
            if(previndex >= jfgridfile.length){
                previndex = jfgridfile.length - 1;
                $("#jfgrid-sheets-item" + data.index).insertAfter($("#jfgrid-sheets-item" + jfgridfile[previndex].index));
            }
            else{
                $("#jfgrid-sheets-item" + data.index).insertBefore($("#jfgrid-sheets-item" + jfgridfile[previndex].index));
            }
            
            jfgridfile.push(data);

            $("#jfgrid-sheet-area div.jfgrid-sheets-item").removeClass("jfgrid-sheets-item-active");
            $("#jfgrid-sheets-item" + data.index).addClass("jfgrid-sheets-item-active");
            $("#jfgrid-cell-main").append('<div id="jfgrid-datavisual-selection-set-' + data.index + '" class="jfgrid-datavisual-selection-set"></div>');
            jfgrid.cleargridelement();

            if(isrenew != null){
                jfgrid.server.saveParam("shre", null, { "reIndex": data.index });
                data.hide = 0;

                jfgrid.server.saveParam("sh", data.index, 0, {"op": "show", "cur": null});
            }
            else{
                jfgrid.server.saveParam("sha", null, data);
            }

            this.changeSheetExec(data.index, data.isPivotTable, true);
            this.reOrderAllSheet();
        },
        deleteSheet: function (index) {
            var arrIndex = this.getSheetIndex(index);
            this.setSheetHide(index);
            $("#jfgrid-sheets-item" + index).remove();
            $("#jfgrid-datavisual-selection-set-" + index).remove();
            var removedsheet = jfgridfile.splice(arrIndex, 1);
            this.reOrderAllSheet();

            jfgrid.server.saveParam("shd", null, {"deleIndex": index });

            if (clearjfundo) {
                removedsheet[0].type = "deleteSheet";
                jfgrid.jfredo.push(removedsheet[0]);
            }
        },
        nulldata: null,
        getGridData:function(d){
            var ret = [];
            for(var r = 0; r < d.length; r++){
                for(var c = 0; c < d[0].length; c++){
                    if(d[r][c] == null){
                        continue;
                    }
                    ret.push({r:r, c:c, v:d[r][c]});
                }
            }
            return ret;
        },
        buildGridData:function(file){
            var row = file.row == null ? defaultrowNum : file.row, 
                column = file.column == null ? defaultcolumnNum : file.column;
            var data = jfgrid.datagridgrowth([], row, column);

            var celldata = file.celldata;
            if(celldata != null){
                for(var i = 0; i < celldata.length; i++){
                    var item = celldata[i];
                    var r = item.r;
                    var c = item.c;
                    var v = item.v;

                    if(r >= data.length){
                        data = jfgrid.datagridgrowth(data, r - data.length + 1, 0);
                    }
                    if(c >= data[0].length){
                        data = jfgrid.datagridgrowth(data, 0, c - data[0].length + 1);
                    }
                    
                    jfgrid.setcellvalue(r, c, data, v);
                }
            }

            //亿万格式+精确度 恢复全局初始化
            jfgridConfigsetting.autoFormatw = false;  
            jfgridConfigsetting.accuracy = undefined;
            return data;
        },
        cutGridData:function(d){
            var rowindex = 0;
            for(var r = d.length - 1; r >= 0; r--){
                var isnull = true;
                for(var c = 0; c < d[0].length; c++){
                    var value = jfgrid.getcellvalue(r, c);
                    if(value != null && $.trim(value).length > 0){
                        isnull = false;
                        break;
                    }
                }

                if(!isnull){
                    break;
                }
                else{
                    rowindex = r;
                }
            }

            return d.slice(0, rowindex);
        },
        addGridData:function(celldata, row, column){
            var data = jfgrid.datagridgrowth([], row, column);
            if(celldata != null){
                for(var i = 0; i < celldata.length; i++){
                    var item = celldata[i];
                    var r = item.r;
                    var c = item.c;
                    var v = item.v;

                    if(r >= data.length){
                        data = jfgrid.datagridgrowth(data, r - data.length + 1, 0);
                    }

                    if(c >= data[0].length){
                        data = jfgrid.datagridgrowth(data, 0, c - data[0].length + 1);
                    }
                    jfgrid.setcellvalue(r, c, data, v)
                }
            }
            
            return data;
        },
        initialjfFile: function (menu, title) {
            var _this = this;
            this.getCurSheet();
            var file = jfgridfile[_this.getSheetIndex(jfgrid.currentSheetIndex)];

            this.nulldata = jfgrid.datagridgrowth([], defaultrowNum, defaultcolumnNum);
            var data = _this.buildGridData(file);

            jfgird_select_save = file["jfgird_select_save"];
            if(jfgird_select_save == null || jfgird_select_save.length == 0){
                if(data[0] != null && data[0][0] != null && data[0][0].mc != null){
                    jfgird_select_save = [{ "row": [0, data[0][0].mc.rs - 1], "column": [0, data[0][0].mc.cs - 1] }];
                }
                else{
                    jfgird_select_save = [{ "row": [0, 0], "column": [0, 0] }];
                }
            }

            jfgrid_selection_range = file["jfgrid_selection_range"] == null ? [] : file["jfgrid_selection_range"];
            config = file["config"] == null ? {} : file["config"];

            var r2 = jfgird_select_save[0].row[1], c2 = jfgird_select_save[0].column[1];
            if(jfgird_select_save.length > 1){
                for(var i = 0; i < jfgird_select_save.length; i++){
                    if(jfgird_select_save[i].row[1] > r2){
                        r2 = jfgird_select_save[i].row[1];
                    }

                    if(jfgird_select_save[i].column[1] > c2){
                        c2 = jfgird_select_save[i].column[1];
                    }
                }
            }

            file.data = data;

            var rowheight = data.length;
            if(r2 > rowheight - 1){
                rowheight = r2 + 1;
            }

            var colwidth = data[0].length;
            if(c2 > colwidth - 1){
                colwidth = c2 + 1;
            }

            jfgrid.jfgridcreatedom(colwidth, rowheight, data, menu, title);

            setTimeout(function () {
                jfgrid.tooltip.createHoverTip("#jfgrid_info_detail" ,".jfgrid_info_detail_title, .jfgrid_info_detail_input, .jfgrid_info_detail_update");

                jfgrid.tooltip.createHoverTip("#jfgrid-wa-editor" ,".jfgrid-toolbar-menu-button, .jfgrid-toolbar-button, .jfgrid-toolbar-combo-button");

                jfgridTableContentHW = [$("#jfgrid-cell-main").width() + rowHeaderWidth - cellMainSrollBarSize, $("#jfgrid-cell-main").height() + columeHeaderHeight - cellMainSrollBarSize];
                $("#jfgridTableContent, #jfgridTableContentF").attr({ width: Math.ceil(jfgridTableContentHW[0]*devicePixelRatio), height: Math.ceil(jfgridTableContentHW[1]*devicePixelRatio) }).css({ width: jfgridTableContentHW[0], height: jfgridTableContentHW[1] }).get(0).getContext("2d");

                var key = jfgrid.server.gridKey;
                var cahce_key = key + "__qkcache";

                var ini = function(){
                    file["load"] = "1";

                    _this.createSheet();

                    var sheetindexset = _this.checkLoadSheetIndex(file);
                    var sheetindex = [];
                    for(var i=0;i<sheetindexset.length;i++){
                        var item = sheetindexset[i];
                        if(item==file["index"]){
                            continue;
                        }
                        sheetindex.push(item);
                    }

                    var execF = function(){
                        _this.storeSheetParam();
                        _this.restoreselect();
                        jfgrid.sheetmanage.CacheNotLoadControll = [];
                        jfgrid.sheetmanage.restoreCache();
                        jfgrid.formula.execFunctionGroup();
                        jfgrid.sheetmanage.restoreSheetAll(jfgrid.currentSheetIndex);
                        // $("#jfgridTableContent").get(0).getContext("2d") ;
                        // $("#jfgridTableContentF").get(0).getContext("2d") ;
                        jfgrid.jfgridrefreshgrid(0, 0);
                        $("#jfgrid_info_detail_save").html("已恢复本地缓存");

                        if (!!file.isPivotTable) {
                            jfgridcurrentisPivotTable = true;
                            jfgrid.pivotTable.changePivotTable(jfgrid.currentSheetIndex);
                        }
                        else {
                            jfgridcurrentisPivotTable = false;
                            $("#jfgrid-modal-dialog-slider-pivot").hide();
                            jfgrid.jfgridsizeauto();
                        }

                        if(typeof jfgrid.jfgridConfigsetting.beforeCreateDom == "function" ){
                            jfgrid.jfgridConfigsetting.beforeCreateDom(jfgrid);
                        }

                        if(jfgridConfigsetting.pointEdit){
                            setTimeout(function(){
                                $("#jfgridloadingdata").remove();
                            }, 0);
                        }
                        else{
                            setTimeout(function(){
                                $("#jfgridloadingdata").fadeOut().remove();
                            }, 500);
                        }
                    }

                    var loadSheetUrl = jfgrid.server.loadSheetUrl;
                    if(sheetindex.length==0 || loadSheetUrl==""){
                        execF();
                    }
                    else{
                        $.post(loadSheetUrl, {"gridKey" : jfgrid.server.gridKey, "index": sheetindex.join(",")}, function (d) {
                            var dataset = eval("(" + d + ")");
                            
                            for(var item in dataset){
                                if(item == file["index"]){
                                    continue;
                                }

                                var otherfile = jfgridfile[_this.getSheetIndex(item)];
                                
                                if(otherfile["load"] == null || otherfile["load"] == "0"){
                                    otherfile.celldata = dataset[item.toString()];
                                    otherfile["data"] = _this.buildGridData(otherfile);
                                    otherfile["load"] = "1";
                                }
                            }

                            execF();
                        });
                    }
                }

                //ini();
                try {
                    localforage.getItem(cahce_key).then(function(readValue) {
                        if(readValue!=null){
                             jfgrid.sheetmanage.CacheNotLoadControll = readValue;
                        }
                        // console.log("2");
                        jfgrid.server.clearcachelocaldata(function(){
                            ini();
                        });
                    });
                } catch(e) {
                    // statements
                    ini();
                    console.log("缓存操作失败");
                }

                // setTimeout(function(){
                //     jfgrid.server.imageRequest();
                // }, 1000);
            }, 1);
        },
        storeSheetParam: function () {
            var index = this.getSheetIndex(jfgrid.currentSheetIndex);
            var file = jfgridfile[index];
            file["visibledatarow"] = visibledatarow;
            file["visibledatacolumn"] = visibledatacolumn;
            file["rowsplit"] = rowsplit;
            file["ch_width"] = ch_width;
            file["rh_height"] = rh_height;
            file["jfgird_select_save"] = $.extend(true, [], jfgird_select_save);
            file["jfgrid_selection_range"] = $.extend(true, [], jfgrid_selection_range);

            file["scrollLeft"] = $("#jfgrid-cell-main").scrollLeft();//列标题
            file["scrollTop"] = $("#jfgrid-cell-main").scrollTop();//行标题
        },
        setSheetParam: function (isload) {
            var index = this.getSheetIndex(jfgrid.currentSheetIndex);
            var file = jfgridfile[index];

            jfgrid.flowdata = file["data"];
            jfgrid.editor.webWorkerFlowDataCache(jfgrid.flowdata);//worker存数据

            jfgrid.postil.buildAllPs(jfgrid.flowdata);

            config = file["config"];

            jfgird_select_save = file["jfgird_select_save"] == null ? [] : file["jfgird_select_save"];
            jfgrid_selection_range = file["jfgrid_selection_range"] == null ? [] : file["jfgrid_selection_range"];

            if(file["freezen"] == null){
                jfgrid.freezen.freezenhorizontaldata = null;
                jfgrid.freezen.freezenverticaldata = null;
            }
            else{
                jfgrid.freezen.freezenhorizontaldata = file["freezen"].horizontal == null ? null : file["freezen"].horizontal.freezenhorizontaldata;
                jfgrid.freezen.freezenverticaldata = file["freezen"].vertical == null ? null : file["freezen"].vertical.freezenverticaldata;
            }

            jfgrid.createFilterOptions(file["filter_select"], file["filter"]);

            jfgrid.jfrefreshgrid_rhcw(jfgrid.flowdata.length, jfgrid.flowdata[0].length);

            // if( !!isload && (file["visibledatarow"] == null || file["visibledatarow"].length == 0 || file["visibledatacolumn"] == null || file["visibledatacolumn"].length == 0 || file["rowsplit"] == null || file["ch_width"] == null || file["rh_height"] == null)){
            //     jfgrid.jfgridcreatesheet(file["data"][0].length, file["data"].length, file["data"], file["config"], false);
            // }
            // else{
            //     visibledatarow = file["visibledatarow"];
            //     visibledatacolumn = file["visibledatacolumn"];
            //     rowsplit = file["rowsplit"];
            //     ch_width = file["ch_width"];
            //     rh_height = file["rh_height"];
            //     jfgrid.flowdata = file["data"];
            //     setTimeout(function(){
            //         jfgrid.editor.webWorkerFlowDataCache(file["data"]);//worker存数据
            //     },0);
            //     config = file["config"];
            // }

            // jfgird_select_save = file["jfgird_select_save"];
            // jfgrid_selection_range = file["jfgrid_selection_range"];
        },
        restoreselect: function () {
            var index = this.getSheetIndex(jfgrid.currentSheetIndex);
            var file = jfgridfile[index];

            //选区
            jfgrid.selectHightlightShow();

            //复制选区虚线框
            jfgrid.selectionCopyShow();

            if (file["scrollLeft"] != null && file["scrollLeft"] > 0) {
                $("#jfgrid-scrollbar-x").scrollLeft(file["scrollLeft"]); //列标题
            }
            else {
                $("#jfgrid-scrollbar-x").scrollLeft(0);
            }

            if (file["scrollTop"] != null && file["scrollTop"] > 0) {
                $("#jfgrid-scrollbar-y").scrollTop(file["scrollTop"]); //列标题
            }
            else {
                $("#jfgrid-scrollbar-y").scrollTop(0);
            }
        },
        storeSheetParamALL: function () {
            this.storeSheetParam();
            var index = this.getSheetIndex(jfgrid.currentSheetIndex);
            jfgridfile[index]["data"] = jfgrid.flowdata;
            jfgridfile[index]["config"] = $.extend(true, {}, config);
        },
        changeSheet: function (index, isPivotInitial, isNewSheet) {
            if(jfgrid.isEditMode()){
                // alert("非编辑模式下不允许该操作！");
                return;
            }

            if(jfgrid.server.allowUpdate){
                $("#jfgrid-cell-main #jfgrid-multipleRange-show").empty();
                jfgrid.server.multipleIndex = 0;
            }
            
            $('#jfgrid-filter-selected-sheet' + jfgrid.currentSheetIndex + ', #jfgrid-filter-options-sheet' + jfgrid.currentSheetIndex).hide();
            $('#jfgrid-filter-selected-sheet' + index + ', #jfgrid-filter-options-sheet' + index).show();

            this.storeSheetParamALL();
            this.setCurSheet(index);
            var file = jfgridfile[this.getSheetIndex(index)], data = file.data, cfg = file.config;

            if (!!file.isPivotTable) {
                jfgridcurrentisPivotTable = true;
                if (!isPivotInitial) {
                    jfgrid.pivotTable.changePivotTable(index);
                }
            }
            else {
                jfgridcurrentisPivotTable = false;
                $("#jfgrid-modal-dialog-slider-pivot").hide();
                jfgrid.jfgridsizeauto();
            }

            var _this = this;
            var load = file["load"];
            if (load != null) {
                _this.setSheetParam(true);
                _this.showSheet();

                setTimeout(function () {
                    //jfgrid.flowdata = data;
                    jfgrid.formula.execFunctionGroup();
                    jfgrid.jfgridrefreshgrid();
                    jfgrid.server.saveParam("shs", null, jfgrid.currentSheetIndex);
                }, 1);
            }
            else {
                //$("#" + container + " div.jfgridsheetchange").hide();
                var loadSheetUrl = jfgrid.server.loadSheetUrl;
                if(loadSheetUrl == "" || jfgridcurrentisPivotTable || !!isNewSheet){
                    //var row = file.row==null?defaultrowNum:file.row, column = file.cloumn==null?defaultcolumnNum:file.cloumn;
                    var data = _this.buildGridData(file);

                    file["data"] = data;
                    file["load"] = "1";

                    _this.setSheetParam();
                    _this.showSheet();

                    setTimeout(function () {
                        jfgrid.sheetmanage.restoreCache();
                        jfgrid.formula.execFunctionGroup();
                        jfgrid.sheetmanage.restoreSheetAll(jfgrid.currentSheetIndex);
                        jfgrid.jfgridrefreshgrid();
                    }, 1);

                    jfgrid.server.saveParam("shs", null, jfgrid.currentSheetIndex);
                }
                else{
                    $("#jfgrid-grid-window-1").append('<div id="jfgridloadingdata" style="width:100%;text-align:center;position:absolute;top:0px;height:100%;font-size: 16px;z-index:1000000000;background:#fff;"><div style="position:relative;top:45%;width:100%;"> <div class="jfgridLoaderGif"></div> <span>正在准备！请稍后</span></div></div>');

                    var sheetindex = this.checkLoadSheetIndex(file);
                    
                    $.post(loadSheetUrl, {"gridKey" : jfgrid.server.gridKey, "index": sheetindex.join(",")}, function (d) {
                        var dataset = eval("(" + d + ")");
                        file.celldata = dataset[index.toString()];
                        var data = _this.buildGridData(file);

                        setTimeout(function(){
                            $("#jfgridloadingdata").fadeOut().remove();
                        }, 500);

                        for(var item in dataset){
                            if(item == index){
                                continue;
                            }

                            var otherfile = jfgridfile[_this.getSheetIndex(item)];
                            
                            if(otherfile["load"] == null || otherfile["load"] == "0"){
                                otherfile.celldata = dataset[item.toString()];
                                otherfile["data"] = _this.buildGridData(otherfile);
                                otherfile["load"] = "1";
                            }
                        }

                        file["data"] = data;
                        file["load"] = "1";

                        _this.setSheetParam();
                        _this.showSheet();

                        setTimeout(function () {
                            jfgrid.sheetmanage.restoreCache();
                            jfgrid.formula.execFunctionGroup();
                            jfgrid.sheetmanage.restoreSheetAll(jfgrid.currentSheetIndex);
                            jfgrid.jfgridrefreshgrid();
                        }, 1);

                        jfgrid.server.saveParam("shs", null, jfgrid.currentSheetIndex);
                    });
                }
            }

            $("#jfgrid-cell-main .jfgrid-datavisual-selection-set").hide();
            $("#jfgrid-datavisual-selection-set-" + index).show();
            //隐藏其他sheet的图表，显示当前sheet的图表 chartMix
            !!window.generator && generator.renderChartShow(index);
            // $("#jfgrid-cell-main .jfgrid-data-visualization-chart[sheetIndex!='" + index + "']").hide();
            // $("#jfgrid-cell-main .jfgrid-data-visualization-chart[sheetIndex='" + index + "']").show();
            jfgrid.freezen.initialFreezen(index);

            this.restoreselect();
        },
        checkLoadSheetIndex:function(file){
        	var calchain = file.calcChain; //index
        	var chart = file.chart; //dataSheetIndex
        	var pivotTable = file.pivotTable; //pivotDataSheetIndex

        	var ret= [], cache={};
        	ret.push(file.index);
        	cache[file.index.toString()] = 1;

            if(calchain != null){
            	for(var i = 0; i < calchain.length; i++){
            		var func = calchain[i];
            		var dataindex = func.index;
                    if(dataindex == null){
                        continue;
                    }
            		if(cache[dataindex.toString()] == null){
            			ret.push(dataindex);
            			cache[dataindex.toString()] = 1;
            		}
            	}
            }

            if(chart != null){
                for(var i = 0; i < chart.length; i++){
                    var cc = chart[i];
                    var dataindex = cc.dataSheetIndex;
                    if(dataindex == null){
                        continue;
                    }
                    if(cache[dataindex.toString()] == null){
                        ret.push(dataindex);
                        cache[dataindex.toString()] = 1;
                    }
                } 
            }

            if(pivotTable != null){
            	var dataindex = pivotTable.pivotDataSheetIndex;
        		if(dataindex != null && cache[dataindex.toString()] == null){
        			ret.push(dataindex);
        			cache[dataindex.toString()] = 1;
        		}
            }

        	return ret;
        },
        showSheet: function () {
            //$("#" + container + " div.jfgridsheetchange").hide();
            // $("#jfgridrowHeader_" + jfgrid.currentSheetIndex).show();
            // $("#jfgrid-cell-flow_" + jfgrid.currentSheetIndex).show();
            // $("#jfgrid-cols-h-cells_" + jfgrid.currentSheetIndex).show();
            $("#jfgrid-cell-flow_0").css({ "width": ch_width, "top": "-1px" }); //width更新
            $("#jfgrid-sheettable_0").css({ "width": ch_width - 1, "height": rh_height });
            $("#jfgridrowHeader_0").css("height", rh_height);
            $("#jfgrid-cols-h-cells_0").css("width", ch_width); //width更新

            $("#jfgrid-scrollbar-x div").width(ch_width);
            $("#jfgrid-scrollbar-y div").height(rh_height - 30);
        },
        setCurSheet: function (index) {
            for (var i = 0; i < jfgridfile.length; i++) {
                if (jfgridfile[i]["index"] == index) {
                    jfgridfile[i].status = 1;
                }
                else {
                    jfgridfile[i].status = 0;
                }
            }
            jfgrid.currentSheetIndex = index;
        },
        getSheetIndex: function (index) {
            for (var i = 0; i < jfgridfile.length; i++) {
                if (jfgridfile[i]["index"] == index) {
                    return i;
                }
            }
            return null;
        },
        changeSheetExec: function (index, isPivotInitial, isNewSheet) {
            var $sheet = $("#jfgrid-sheets-item" + index);
            //sheet-filter切换
            //$('#jfgrid-filter-selected-sheet'+ jfgrid.currentSheetIndex +', #jfgrid-filter-options-sheet'+ jfgrid.currentSheetIndex).hide();
            //$('#jfgrid-filter-selected-sheet'+ index +', #jfgrid-filter-options-sheet'+ index).show();
            //$("#jfgrid-cell-main").append('<div id="jfgrid-datavisual-selection-set-' + i + '" class="jfgrid-datavisual-selection-set"></div>');
            window.jfgrid_getcelldata_cache = null;
            $("#jfgrid-sheet-area div.jfgrid-sheets-item").removeClass("jfgrid-sheets-item-active");
            $sheet.addClass("jfgrid-sheets-item-active").show();
            jfgrid.cleargridelement();
            this.changeSheet(index, isPivotInitial, isNewSheet);
            $("#jfgrid-sheet-list, #jfgrid-rightclick-sheet-menu").hide();

            if (jfgrid.formula.rangestart) {
                jfgrid.formula.createRangeHightlight();
            }

            var $c = $("#jfgrid-sheet-container-c");
            $c.scrollLeft($sheet.offset().left);

            var c_width = $c.width(), c_srollwidth = $c[0].scrollWidth, scrollLeft = $c.scrollLeft();

            if (scrollLeft <= 0) {
                $("#jfgrid-sheet-container .docs-sheet-fade-left").hide();
            }
            else {
                $("#jfgrid-sheet-container .docs-sheet-fade-left").show();
            }

            if (c_width + scrollLeft >= c_srollwidth) {
                $("#jfgrid-sheet-container .docs-sheet-fade-right").hide();
            }
            else {
                $("#jfgrid-sheet-container .docs-sheet-fade-right").show();
            }
        },
        delChart: function (chart_id, sheetIndex) {
            var index = this.getSheetIndex(sheetIndex);
            var file = jfgridfile[index];
            if (file.chart == null) {
                file.chart = [];
            }
            else {
                for (var i = 0; i < file.chart.length; i++) {
                    if (file.chart[i].chart_id == chart_id) {
                        jfgridfile[index].chart.splice(i, 1);
                        break;
                    }
                }
            }
        },
        saveChart: function (json) {//采用chartMix store存储，弃用jfgridfile存储，防止重复存储
            var index = this.getSheetIndex(json.sheetIndex);
            var file = jfgridfile[index];
            if (file.chart == null) {
                file.chart = [];
                file.chart.push(json);
            }
            else {
                for (var i = 0; i < file.chart.length; i++) {
                    if (file.chart[i].chart_id == json.chart_id) {
                        var old = $.extend(true, {}, file.chart[i]);
                        file.chart[i] = $.extend(true, {}, old, json);
                        return;
                    }
                }
                file.chart.push(json);
            }
        },
        getChart: function (sheetIndex, chart_id) {
            var index = getSheetIndex(sheetIndex);
            var file = jfgridfile[index];
            if (file.chart == null) {
                return null;
            }
            else {
                for (var i = 0; i < file.chart.length; i++) {
                    if (file.chart[i].chart_id == chart_id) {
                        return file.chart[i];
                    }
                }
                return null;
            }
        },
        restoreChart: function (sheetIndex) {
            if (jfgrid.chartparam.jfgrid_chartIns_index == -1) {
                jfgrid.chartparam.jfgrid_chartIns_index = 0;
                for (var i = 0; i < jfgridfile.length; i++) {
                    var chart = jfgridfile[i].chart;
                    if (chart != null) {
                        jfgrid.chartparam.jfgrid_chartIns_index += chart.length;
                    }
                }
            }

            var index = this.getSheetIndex(sheetIndex);
            var file = jfgridfile[index];
            if (file.chart != null) {
                for (var i = 0; i < file.chart.length; i++) {
                    var c = file.chart[i];
                    if(c.sheetIndex == null || c.dataSheetIndex == null || c.row == null || c.column == null){
                        continue;
                    }
                    
                    if ($("#" + c.chart_id).length == 0) {
                        var chart_selection_color = null;
                        var chart_id = null;
                        var chart_selection_id = null;

                        if(c.chart_id != null){
                            chart_id = c.chart_id;
                            var chart_id_index = parseInt(chart_id);
                            if(isNaN(chart_id_index)){
                                chart_id_index = jfgrid.chartparam.jfgrid_chartIns_index++;
                            }
                            else{
                                if(chart_id_index>jfgrid.chartparam.jfgrid_chartIns_index ){
                                    jfgrid.chartparam.jfgrid_chartIns_index = chart_id_index;
                                }
                            }
                            chart_selection_color = jfgrid.jfcolor[chart_id_index];
                            chart_selection_id = chart_id + "_selection";
                        }
                        else{
                            chart_selection_color = jfgrid.jfcolor[jfgrid.chartparam.jfgrid_chartIns_index];
                            chart_id = "jfgrid-datav-chart-" + jfgrid.chartparam.jfgrid_chartIns_index++;
                            chart_selection_id = chart_id + "_selection";
                            c.chart_id = chart_id;
                        }

                        var chartTheme = c.chartTheme;
                        chartTheme = chartTheme == null ? "default0000" : chartTheme;

                        jfgrid.insertChartTosheet(c.sheetIndex, c.dataSheetIndex, c.option, c.chartType, c.selfOption, c.defaultOption, c.row, c.column, chart_selection_color, chart_id, chart_selection_id, c.chartStyle, c.rangeConfigCheck, c.rangeRowCheck, c.rangeColCheck, c.chartMarkConfig, c.chartTitleConfig, c.winWidth, c.winHeight, c.scrollLeft, c.scrollTop, chartTheme, c.myWidth, c.myHeight, c.myLeft!=null?parseFloat(c.myLeft):null, c.myTop!=null?parseFloat(c.myTop):null, c.myindexrank, true);
                    }
                }
            }
        },
        getRangetxt: function (sheetIndex, range, currentIndex) {
            var sheettxt = "";

            if (currentIndex == null) {
                currentIndex = jfgrid.currentSheetIndex;
            }

            if (sheetIndex != currentIndex) {
                sheettxt = jfgridfile[this.getSheetIndex(sheetIndex)].name + "!";
            }

            var row0 = range["row"][0], row1 = range["row"][1];
            var column0 = range["column"][0], column1 = range["column"][1];

            if (row0 == null && row1 == null) {
                return sheettxt + jfgrid.jfgridchatatABC(column0) + ":" + jfgrid.jfgridchatatABC(column1);
            }
            else if (column0 == null && column1 == null) {
                return sheettxt + (row0 + 1) + ":" + (row1 + 1);
            }
            else {
                if (column0 == column1 && row0 == row1) {
                    return sheettxt + jfgrid.jfgridchatatABC(column0) + (row0 + 1);
                }
                else {
                    return sheettxt + jfgrid.jfgridchatatABC(column0) + (row0 + 1) + ":" + jfgrid.jfgridchatatABC(column1) + (row1 + 1);
                }
            }
        },
        getSheetName: function (sheetIndex) {
            if (sheetIndex == null) {
                sheetIndex = jfgrid.currentSheetIndex;
            }

            return jfgridfile[this.getSheetIndex(sheetIndex)].name;
        },
        getSheetMerge: function () {
            if(config.merge == null){
            	return null;
            }
            return config.merge;
        },
        getSheetData: function (sheetIndex) {
            if (sheetIndex == null) {
                sheetIndex = jfgrid.currentSheetIndex;
            }

            return jfgridfile[this.getSheetIndex(sheetIndex)].data;
        },
        getSheetConfig: function (sheetIndex) {
            if (sheetIndex == null) {
                sheetIndex = jfgrid.currentSheetIndex;
            }

            var config = jfgridfile[this.getSheetIndex(sheetIndex)].config;
            if(config == null){
            	jfgridfile[this.getSheetIndex(sheetIndex)].config = {};
            }
            return jfgridfile[this.getSheetIndex(sheetIndex)].config;
        },
        restoreFilter: function(sheetIndex){
            var index = this.getSheetIndex(sheetIndex);
            var file = jfgridfile[index];

            if($('#jfgrid-filter-selected-sheet' + sheetIndex).length > 0 || file.filter_select == null || JSON.stringify(file.filter_select) == "{}"){
                if(file.config != null && file.config.rowhidden != null){
                    file.config.rowhidden =  {};
                    config = file.config;

                    jfgrid.jfrefreshgrid_rhcw(jfgrid.flowdata.length, jfgrid.flowdata[0].length);
                }

                return;
            }

            if(jfgrid.getObjType(file.filter_select) != "object"){
                file.filter_select = JSON.parse(file.filter_select);
            }

            if(file.filter_select == null || file.filter_select.row == null || file.filter_select.column == null){
                return;
            }

            jfgrid.createFilterOptions(file.filter_select);

            if(jfgrid.getObjType(file.filter) != "object"){
                if(file.filter != null && jfgrid.getObjType(file.filter) == "string"){ 
                    file.filter = JSON.parse(file.filter);
                }
            }

            var rowhidden = {};
            if(file.config != null && file.config.rowhidden != null){
                rowhidden =  file.config.rowhidden;
            }

            $("#jfgrid-filter-options-sheet" + sheetIndex + " .jfgrid-filter-options").each(function(i){
                if(file.filter == null){
                    return false;
                }

                var $top = $(this);
                var item = file.filter[i];

                if(item == null){
                    return true;
                }

                if(jfgrid.getObjType(item) != "object"){
                    item = JSON.parse(item);
                }

                jfgrid.labelFilterOptionState($top, item.optionstate, item.rowhidden, item.caljs, false, item.st_r, item.ed_r, item.cindex, item.st_c, item.ed_c);

                rowhidden = $.extend(true, rowhidden, item.rowhidden);
            });

            if(file.config == null){
                file.config = {};
            }

            file.config["rowhidden"] = rowhidden;
            config = file.config;

            jfgrid.jfrefreshgrid_rhcw(jfgrid.flowdata.length, jfgrid.flowdata[0].length);
            
            // var $t = $("#jfgrid-filter-options-sheet" + sheetIndex + " .jfgrid-filter-options").eq(0);
            // jfgrid.filterseletedbyindex($t.data("str"), $t.data("edr"), $t.data("stc"), $t.data("edc"));
        },
        restorePivot:function(sheetIndex){
            var index = this.getSheetIndex(sheetIndex);
            var file = jfgridfile[index];
            if (!file.isPivotTable) {
                return;
            }
            jfgrid.pivotTable.getCellData(sheetIndex);
            jfgrid.pivotTable.initialPivotManage(true);
            jfgrid.pivotTable.refreshPivotTable();
        },
        restoreSheetAll:function(sheetIndex){
            var _this= this;
            _this.restorePivot(sheetIndex);
            _this.restoreFilter(sheetIndex);
            // _this.restoreChart(sheetIndex);//TODO:chartMix重写restoreChart方法
            _this.restoreFreezen(sheetIndex);
        },
        restoreFreezen:function(sheetIndex){
            jfgrid.freezen.initialFreezen(sheetIndex);
        },
        restoreCache:function(){
            var key = jfgrid.server.gridKey;
            var cahce_key = key + "__qkcache";
            var _this = this;

            var data = _this.CacheNotLoadControll;
            //.concat(ret);
            _this.CacheNotLoadControll = [];
            if(data.length == 0){
                return;
            }
            console.log(data);
            for(var i = 0; i < data.length; i++){
                var item = data[i];
                _this.execCache(item);
            }

            // localforage.getItem(cahce_key).then(function(readValue) {
            //     if(readValue!=null){
            //         _this.CacheNotLoadControll = readValue;
            //     }
                
            //     jfgrid.server.getlocaldata(function(ret){
            //         if(ret==null){
            //             ret = [];
            //         }
            //         var data = _this.CacheNotLoadControll;
            //         //.concat(ret);
            //         _this.CacheNotLoadControll = [];
            //         if(data.length==0){
            //             return;
            //         }

            //         for(var i=0;i<data.length;i++){
            //             var item = data[i];
            //             _this.execCache(item);
            //         }
                    

            //         jfgrid.server.clearcachelocaldata(function(){
            //             $("#jfgrid_info_detail_save").html("已恢复本地缓存");
            //         });
            //     });
            // });
        },
        CacheNotLoadControll:[],
        execCache:function(item){
            var type = item.t;
            var index = item.i;
            var value = item.v;
            var _this = this;
            var file = jfgridfile[_this.getSheetIndex(index)];

            if(type == "sha"){
                jfgridfile.push(value);
            }
            else if(type == "shc"){
                var copyjson = $.extend(true, {}, jfgridfile[_this.getSheetIndex(value.copyindex)]);
                copyjson.index = index;
                jfgridfile.push(copyjson);
            }
            else if(type == "shd"){
                jfgridfile.splice(value.deleIndex, 1);
            }
            else if(type == "shr"){
                for(var pos in value){
                    jfgridfile[_this.getSheetIndex(pos)].order = value[pos];
                }
            }

            if((file == null || file.load != "1") && !(type in {"sha":0, "shc":0, "shd":0, "shr":0}) ){
                _this.CacheNotLoadControll.push(item);
                return;
            }

            if(type == "v"){
                var r = item.r, c = item.c, v = item.v;
                var data = _this.getSheetData(index);
                file.data[r][c] = v;
            }
            else if(type == "fc"){
                var op = item.op, pos = item.pos;

                if(jfgrid.getObjType(value) != "object"){
                    value = eval('('+ value +')');
                }

                var r = value.r, c = value.c;
                var func = value.func;

                if(op == "del" ){
                    jfgrid.formula.delFunctionGroup(r, c, index);
                }
                else {
                    jfgrid.formula.insertUpdateFunctionGroup(r, c, func, index);
                }
            }
            else if(type == "cg"){
                var v = value, k = item.k;
                var config1 = _this.getSheetConfig(index);;
                
                if(!(k in config1)){
                    config1[k] = {};
                }

                for(var key in v){
                    config1[k][key] = v[key];
                }

                config = config1;

                // else if(rc=="c"){
                //     for(var key in v){
                //         if(config.columlen==null){
                //             config.columlen = {};
                //         }
                //         config.columlen[key] = v[key];
                //     }
                // }
            }
            else if(type == "f"){
                var v = value, op = item.op, pos = item.pos;
                var filter = file.filter;
                if(filter == null){
                    filter = {};
                }

                if(op == "upOrAdd"){
                    filter[pos] =  v;
                }
                else if(op == "del"){
                    delete filter[pos];
                }
            }
            else if(type == "fsc"){
                file.filter = null;
                file.filter_select = null;
            }
            else if(type == "fsr"){
                var v = value;
                file.filter = v.filter;
                file.filter_select = v.filter_select;
            }
            else if(type == "sh"){
                var op = item.op, cur = item.cur, v = value;       
                if(op == "hide"){
                    file.status = 0;
                    jfgridfile[_this.getSheetIndex(cur)].status = 1;
                }
                else if(op == "show"){
                    for(var i = 0; i < jfgridfile.length; i++){
                        jfgridfile[i].status = 0;
                    }
                    file.status = 1;
                }
            }
            else if(type == "all"){
                var k = item.k, s = item.s;
                if(s && jfgrid.getObjType(value) != "object"){
                    file[k] = JSON.stringify(value);
                }
                else{
                    file[k] = value;
                }

                
            }
            // else if(type=="fs"){
            //     var v = value;
            //     file.filter_select = v;
            // }
            // else if(op=="color"){
            //     file.color = v;
            // }
            // if(op=="name"){
            //     file.name = v;
            // }
            // else if(type=="p"){
            //     file.pivotTable = value;
            // }
            else if(type == "c"){
                var op = item.op, cid = item.cid;
                if(op == "add"){
                    file.chart.push(value);
                }
                else if(op == "xy" || op == "wh" || op == "update"){
                    for(var i = 0; i < file.chart.length; i++){
                        if(file.chart[i].chart_id == cid){
                            for(var item in file.chart[i]){
                                for(var vitem in value){
                                    if(item == vitem){
                                        file.chart[i][item] = value[vitem];
                                    }
                                }
                            }
                            return;
                        }
                    }
                }
                else if(op == "del"){
                    for(var i = 0; i < file.chart.length; i++){
                        if(file.chart[i].chart_id == cid){
                            file.chart.splice(i, 1); 
                            return;
                        }
                    }
                }
            }
            else if(type == "drc"){
                var rc = item.rc, index = value.index, len = value.len;
                var celldata = file.celldata;
                if(rc == "r"){
                    // for(var i = 0; celldata.length < 0; i++){
                    //     var cell = celldata[i];
                    //     if(cell.r >= index && cell.r < index + len){
                    //         delete cell;
                    //     }
                    //     else if(cell.r >= index + len){
                    //         cell.r -= len;
                    //     }
                    // }
                    for(var i = 0; celldata.length == 0; i++){
                        var cell = celldata[i];
                        if(cell.r >= index && cell.r < index + len){
                            delete cell;
                        }
                        else if(cell.r >= index + len){
                            cell.r -= len;
                        }
                    }
                    file.row -= len;
                }
                else{
                    // for(var i = 0; celldata.length < 0; i++){
                    //     var cell = celldata[i];
                    //     if(cell.c >= index && cell.c < index + len){
                    //         delete cell;
                    //     }
                    //     else if(cell.c >= index + len){
                    //         cell.c -= len;
                    //     }
                    // }
                    for(var i = 0; celldata.length == 0; i++){
                        var cell = celldata[i];
                        if(cell.c >= index && cell.c < index + len){
                            delete cell;
                        }
                        else if(cell.c >= index + len){
                            cell.c -= len;
                        }
                    }
                    file.column -= len;
                }

                var ret = [];
                for(var i = 0; i < celldata.length; i++){
                    if(celldata[i] != null){
                        ret.push(celldata[i]);
                    }
                }
                file.celldata = ret;
                
                var mtype, mst, med;
                if(rc == "r"){
                    mtype = "row";
                }
                else{
                    mtype = "column";
                }
                mst = index;
                med = index + len - 1;

                jfgrid.jfgriddeletetable(mtype, mst, med, true);
                // setTimeout(function(){
                //     jfgrid.jfrefreshgridall(jfgrid.flowdata[0].length, jfgrid.flowdata.length, jfgrid.flowdata);
                // }, 10);
            }
            else if(type=="arc"){
                var rc = item.rc, index = value.index, len = value.len;
                var celldata = file.celldata;
                if(rc == "r"){
                    // for(var i = 0; celldata.length < 0; i++){
                    //     var cell = celldata[i];
                    //     if(cell.r > index){
                    //         cell.r += len;
                    //     }
                    // }
                    for(var i = 0; i < celldata.length; i++){
                        var cell = celldata[i];
                        if(cell.r > index){
                            cell.r += len;
                        }
                    }
                    file.row += len;
                }
                else{
                    // for(var i = 0; celldata.length < 0; i++){
                    //     var cell = celldata[i];
                    //     if(cell.c > index){
                    //         cell.c += len;
                    //     }
                    // }
                    for(var i = 0; i < celldata.length; i++){
                        var cell = celldata[i];
                        if(cell.c > index){
                            cell.c += len;
                        }
                    }
                    file.column += len;
                }

                var mtype;
                if(rc == "r"){
                    mtype = "row";
                }
                else{
                    mtype = "column";
                }
                // mst = index;
                // med = index + len - 1;
                //console.log(rc,mtype, mst, med);
                jfgrid.jfgridextendtable(mtype, index, len, true);

                // var ret = [];
                // for(var i=0;i<celldata.length;i++){
                //     if(celldata[i]!=null){
                //         ret.push(celldata[i]);
                //     }
                // }
                // file.celldata = ret;
            }
            else if(type == "na"){
                jfgrid.server.saveParam("na", null, value);
            }
            else if(type == "thumb"){
                setTimeout(function(){
                    _this.imageRequest();
                }, 2000);
            }
        }
    }

    var common_extend = function (jsonbject1, jsonbject2) {
        var resultJsonObject = {};

        for (var attr in jsonbject1) {
            resultJsonObject[attr] = jsonbject1[attr];
        }

        for (var attr in jsonbject2) {
            resultJsonObject[attr] = jsonbject2[attr];
        }

        return resultJsonObject;
    };

    jfgrid.create = function (setting) {
        var extendsetting = common_extend(defaultSetting, setting);
         // rptapp 报表存储用户创建表格时的配置，翻页的时候使用
        jfgrid.rptSetting = setting;
        var //defaultflow = extendsetting.defaultflow,
            loadurl = extendsetting.loadUrl,
            //data1 = extendsetting.data,
            menu = extendsetting.menu,
            title = extendsetting.title;

        container = extendsetting.container;
        //config = extendsetting.config;
        jfgridfile = extendsetting.data;
        defaultcolumnNum = extendsetting.column;
        defaultrowNum = extendsetting.row;
        fullscreenmode = extendsetting.fullscreenmode;

        jfgrid.server.gridKey = extendsetting.gridKey;
        jfgrid.server.loadUrl = extendsetting.loadUrl;
        jfgrid.server.updateUrl = extendsetting.updateUrl;
        jfgrid.server.updateImageUrl = extendsetting.updateImageUrl;
        jfgrid.server.title = extendsetting.title;
        jfgrid.server.loadSheetUrl = extendsetting.loadSheetUrl;
        jfgrid.server.allowUpdate = extendsetting.allowUpdate;

        jfgridConfigsetting.autoFormatw = extendsetting.autoFormatw;
        jfgridConfigsetting.accuracy = extendsetting.accuracy;
        jfgridConfigsetting.total = jfgridfile[0].total;

        jfgridConfigsetting.allowCopy = extendsetting.allowCopy;
        jfgridConfigsetting.showtoolbar = extendsetting.showtoolbar;
        jfgridConfigsetting.showinfobar = extendsetting.showinfobar;
        jfgridConfigsetting.showsheetbar = extendsetting.showsheetbar;
        jfgridConfigsetting.showstatisticBar = extendsetting.showstatisticBar;
        jfgridConfigsetting.pointEdit = extendsetting.pointEdit;
        jfgridConfigsetting.pointEditUpdate = extendsetting.pointEditUpdate;
        jfgridConfigsetting.pointEditZoom = extendsetting.pointEditZoom;

        jfgridConfigsetting.userInfo = extendsetting.userInfo;
        jfgridConfigsetting.userMenuItem = extendsetting.userMenuItem;
        jfgridConfigsetting.myFolderUrl = extendsetting.myFolderUrl;

        jfgridConfigsetting.functionButton = extendsetting.functionButton;

        jfgridConfigsetting.showConfigWindowResize = extendsetting.showConfigWindowResize;

        jfgridConfigsetting.enableAddRow = extendsetting.enableAddRow;
        jfgridConfigsetting.enableAddCol = extendsetting.enableAddCol;
        jfgridConfigsetting.enablePage = extendsetting.enablePage;
        jfgridConfigsetting.pageInfo = extendsetting.pageInfo;

        jfgridConfigsetting.editMode = extendsetting.editMode;
        jfgridConfigsetting.chartConfigChange = extendsetting.chartConfigChange;
        jfgridConfigsetting.beforeCreateDom = extendsetting.beforeCreateDom;

        jfgridConfigsetting.fireMousedown = extendsetting.fireMousedown;

        devicePixelRatio = extendsetting.devicePixelRatio;
        if(devicePixelRatio==null){
            devicePixelRatio = 1;
        }
        devicePixelRatio = Math.ceil(devicePixelRatio);

        //jfgrid.tooltip.chartPointConfig("jfgrid-chart-point-config");

        //loading
        $("#" + container).append('<div id="jfgridloadingdata" style="width:100%;text-align:center;position:absolute;top:0px;height:100%;font-size: 16px;z-index:1000000000;background:#fff;"><div style="position:relative;top:45%;width:100%;"> <div class="jfgridLoaderGif"> </div> <span>正在准备！请稍后</span></div></div>');

        if(jfgridConfigsetting.pointEdit){
            //编辑器qksheet表格编辑状态
            $("#" + container).attr("tabindex", 0).focus();
            $("#jfgridloadingdata .jfgridLoaderGif").css({ "width": "4em", "height": "4em" });
        }

        var data = [];
        if (loadurl == "") {
            jfgrid.sheetmanage.initialjfFile(menu, title);
            jfgrid.jfgridsizeauto();
            jfgrid.jfgridHandler();
            jfgrid.chartInitial();
            //jfgrid.jfgridactiveCell();
        }
        else {
            $.post(loadurl, {"gridKey" : jfgrid.server.gridKey}, function (d) {
                var data = eval("(" + d + ")");
                jfgridfile = data;
                
                jfgrid.sheetmanage.initialjfFile(menu, title);
                jfgrid.jfgridsizeauto();
                jfgrid.jfgridHandler();
                jfgrid.chartInitial();

                //需要更新数据给后台时，建立WebSocket连接
                if(jfgrid.server.allowUpdate){
                    jfgrid.server.openWebSocket();    
                }

                // setTimeout(function(){
                //     $("#jfgridloadingdata").fadeOut().remove();
                // }, 500);
                //jfgrid.jfgridactiveCell();
            });
        }

        return jfgrid;
    }

    var gridW = 0, gridH = 0, cellmainHeight = 0, cellmainWidth = 0;
    jfgrid.jfgridsizeauto = function () {
        // var winW = $(window).outerWidth(), winH = $(window).outerHeight();
        // $("#"+ container).height(winH-2).width(winW-2);
        if (!jfgridConfigsetting.showinfobar) {
            infobarHeight = 0;
            $("#jfgrid_info_detail").hide();
        }
        else {
            infobarHeight = 30;
            $("#jfgrid_info_detail").show();
        }

        if (!jfgridConfigsetting.showtoolbar) {
            $("#" + container).find(".jfgrid-wa-editor, .jfgrid-share-logo").hide();
            toolbarHeight = 0;
        }
        else {
            $("#" + container).find(".jfgrid-wa-editor, .jfgrid-share-logo").show();
            toolbarHeight = 35;
        }

        if (!jfgridConfigsetting.showsheetbar) {
            $("#" + container).find("#jfgrid-sheet-area").hide();
            sheetBarHeight = 0;
        }
        else {
            $("#" + container).find("#jfgrid-sheet-area").show();
            sheetBarHeight = 27;
        }

        if (!jfgridConfigsetting.showstatisticBar) {
            $("#" + container).find(".jfgrid-stat-area").hide();
            statisticBarHeight = 0;
        }
        else {
            $("#" + container).find(".jfgrid-stat-area").show();
            statisticBarHeight = 23;
        }

        if(jfgridConfigsetting.pointEdit){
            //编辑器qksheet表格编辑时，不要滚动条
            cellMainSrollBarSize = 0;
        }

        $("#" + container).find(".jfgrid-grid-container").css("top", toolbarHeight + infobarHeight + calculatebarHeight);

        gridW = $("#" + container).width(), gridH = $("#" + container).height();

        if(jfgridConfigsetting.showConfigWindowResize){//数据透视表  图表  交替颜色
            if($("#jfgrid-modal-dialog-slider-pivot").is(":visible")){
                gridW -= $("#jfgrid-modal-dialog-slider-pivot").outerWidth();
            } 
            else if($("#jfgrid-data-visualization").is(":visible")){
                gridW -= $("#jfgrid-data-visualization").outerWidth();
            }
            else if($("#jfgrid-modal-dialog-slider-alternateformat").is(":visible")){
                gridW -= $("#jfgrid-modal-dialog-slider-alternateformat").outerWidth();
            }
        }

        $("#" + container).find(".jfgrid").height(gridH - 2).width(gridW - 2);
        cellmainHeight = gridH - (infobarHeight + toolbarHeight + calculatebarHeight + columeHeaderHeight + sheetBarHeight + statisticBarHeight);
        cellmainWidth = gridW - rowHeaderWidth;
        $("#jfgrid-cols-h-c, #jfgrid-cell-main, #jfgrid-scrollbar-x").width(cellmainWidth);
        $("#jfgrid-cell-main").height(cellmainHeight);
        $("#jfgrid-rows-h").height(cellmainHeight - cellMainSrollBarSize);

        $("#jfgrid-scrollbar-y").height(cellmainHeight+6);
        $("#jfgrid-scrollbar-x").height(cellMainSrollBarSize);
        $("#jfgrid-scrollbar-y").width(cellMainSrollBarSize);

        jfgridTableContentHW = [cellmainWidth + rowHeaderWidth - cellMainSrollBarSize, cellmainHeight + columeHeaderHeight - cellMainSrollBarSize];
        $("#jfgridTableContent, #jfgridTableContentF").attr({ width: Math.ceil(jfgridTableContentHW[0]*devicePixelRatio), height: Math.ceil(jfgridTableContentHW[1]*devicePixelRatio) }).css({ width: jfgridTableContentHW[0], height: jfgridTableContentHW[1] });

        $("#" + container).find("#jfgrid-grid-window-1").css("bottom", sheetBarHeight);
        $("#" + container).find(".jfgrid-grid-window").css("bottom", statisticBarHeight);

        var gridwidth = $("#jfgrid-grid-window-1").width();
        $("#jfgrid-freezebar-horizontal").find(".jfgrid-freezebar-horizontal-handle").css({ "width": gridwidth - 10 }).end().find(".jfgrid-freezebar-horizontal-drop").css({ "width": gridwidth - 10 });

        var gridheight = $("#jfgrid-grid-window-1").height();
        $("#jfgrid-freezebar-vertical").find(".jfgrid-freezebar-vertical-handle").css({ "height": gridheight - 10 }).end().find(".jfgrid-freezebar-vertical-drop").css({ "height": gridheight - 10 });
        jfgrid.freezen.createAssistCanvas();
        
        jfgrid.jfgridrefreshgrid($("#jfgrid-cell-main").scrollLeft(), $("#jfgrid-cell-main").scrollTop());
        
        var ismore = false, toolbarW = 0, morebtn='<div class="jfgrid-toolbar-separator jfgrid-inline-block" style="user-select: none;"> </div><div class="jfgrid-toolbar-button jfgrid-inline-block" data-tips="更多按钮" id="jfgrid-icon-morebtn" role="button" style="user-select: none;"> <div class="jfgrid-toolbar-button-outer-box jfgrid-inline-block" style="user-select: none;"> <div class="jfgrid-toolbar-button-inner-box jfgrid-inline-block" style="user-select: none;"> <div class="jfgrid-toolbar-menu-button-caption jfgrid-inline-block" style="user-select: none;color:#ff6868;"><i class="fa fa-list-ul"></i> 更多... </div> </div> </div> </div>';
        var morediv = '<div id="jfgrid-icon-morebtn-div" class="jfgrid-wa-editor" style="position:absolute;top:'+ (infobarHeight + toolbarHeight+2 + $("#" + container).offset().top + $("body").scrollTop() ) +'px; right:0px;z-index:1003;padding-left:0px;display:none;height:auto;white-space:initial;"></div>';
        if($("#jfgrid-icon-morebtn-div").length==0){
            $("body").append(morediv);
        }
        $("#jfgrid-icon-morebtn-div").hide();
        $("#jfgrid-icon-morebtn-div > div").appendTo($("#jfgrid-wa-editor"));
        // $("#jfgrid-wa-editor > div").trigger("create");
        // $("#jfgrid-icon-morebtn-div > div").trigger("create");
        $("#jfgrid-icon-morebtn").prev().remove().end().remove();

        $("#jfgrid-wa-editor > div").each(function(){
            var $t = $(this);
            toolbarW += $t.outerWidth();

            if(!ismore && toolbarW>gridW-120){
                ismore = true;
            }

            if(ismore){
                $("#jfgrid-icon-morebtn-div").append($(this));
            }
        });

        if(ismore){
            $("#jfgrid-wa-editor").append(morebtn);
            $("#jfgrid-icon-morebtn").click(function(){
                var right = $(window).width() - $("#jfgrid-icon-morebtn").offset().left - $("#jfgrid-icon-morebtn").width()+ $("body").scrollLeft();
                $("#jfgrid-icon-morebtn-div").toggle().css("right", right<0?0:right);
                var $txt = $(this).find(".jfgrid-toolbar-menu-button-caption");
                if($txt.text().indexOf("更多")>-1){
                    $(this).find(".jfgrid-toolbar-menu-button-caption").html('<i class="fa fa-list-ul"></i> 收起... ');
                }
                else{
                    $(this).find(".jfgrid-toolbar-menu-button-caption").html('<i class="fa fa-list-ul"></i> 更多... ');
                }
                
            });
            //$("#jfgrid-wa-editor div").trigger("create");
            
            $("#jfgrid-icon-morebtn-div .jfgrid-toolbar-menu-button").css("margin-right", -1);
            $("#jfgrid-icon-morebtn-div .jfgrid-toolbar-button-split-left").css("margin-right", -3);
        }

        $("#"+ container + " .jfgrid-wa-editor .jfgrid-toolbar-button-split-left").off("hover").hover(function(){
            $(this).next(".jfgrid-toolbar-button-split-right").addClass("jfgrid-toolbar-button-split-right-hover");
        }, function(){
            $(this).next(".jfgrid-toolbar-button-split-right").removeClass("jfgrid-toolbar-button-split-right-hover");
        });

        $("#"+ container + " .jfgrid-wa-editor .jfgrid-toolbar-button-split-right").off("hover").hover(function(){
            $(this).prev(".jfgrid-toolbar-button-split-left").addClass("jfgrid-toolbar-button-hover");
        }, function(){
            $(this).prev(".jfgrid-toolbar-button-split-left").removeClass("jfgrid-toolbar-button-hover");
        });
    }

    jfgrid.filterseletedbyindex = function (r1, r2, c1, c2) {
        var row = visibledatarow[r2], row_pre = r1 - 1 == -1 ? 0 : visibledatarow[r1 - 1];
        var col = visibledatacolumn[c2], col_pre = c1 - 1 == -1 ? 0 : visibledatacolumn[c1 - 1];

        $('#jfgrid-filter-selected-sheet' + jfgrid.currentSheetIndex).css({ "left": col_pre, "width": col - col_pre - 1, "top": row_pre, "height": row - row_pre - 1 });
        $option = $('#jfgrid-filter-options-sheet' + jfgrid.currentSheetIndex).find(".jfgrid-filter-options");
        for (var c = c1; c <= c2; c++) {
            $option.eq(c - c1).css({ "left": (visibledatacolumn[c] - 20), "top": visibledatarow[r1 - 1] });
        }
    }

    //公式函数 选区实体框
    jfgrid.seletedHighlistByindex = function (id, r1, r2, c1, c2) {
        var row = visibledatarow[r2], row_pre = r1 - 1 == -1 ? 0 : visibledatarow[r1 - 1];
        var col = visibledatacolumn[c2], col_pre = c1 - 1 == -1 ? 0 : visibledatacolumn[c1 - 1];

        $('#' + id).css({ "left": col_pre, "width": col - col_pre - 1, "top": row_pre, "height": row - row_pre - 1 });
    }

    //选区
    jfgrid.selectHightlightShow = function(){
        $("#jfgrid-cell-selected-boxs").show();
        $("#jfgrid-cell-selected-boxs #jfgrid-cell-selected").siblings(".jfgrid-cell-selected").remove();

        if(jfgird_select_save.length > 0){
            for(var i = 0; i < jfgird_select_save.length; i++){
                var r1 = jfgird_select_save[i].row[0], r2 = jfgird_select_save[i].row[1]; 
                var c1 = jfgird_select_save[i].column[0], c2 = jfgird_select_save[i].column[1];

                if(jfgird_select_save[i].row_focus == null){
                    var rf = r1;
                }
                else{
                    var rf = jfgird_select_save[i].row_focus;    
                }

                if(jfgird_select_save[i].column_focus == null){
                    var cf = c1;
                }
                else{
                    var cf = jfgird_select_save[i].column_focus;
                }

                var row = visibledatarow[r2], row_pre = r1 - 1 == -1 ? 0 : visibledatarow[r1 - 1];
                var col = visibledatacolumn[c2], col_pre = c1 - 1 == -1 ? 0 : visibledatacolumn[c1 - 1];

                var row_f = visibledatarow[rf], row_pre_f = rf - 1 == -1 ? 0 : visibledatarow[rf - 1];
                var col_f = visibledatacolumn[cf], col_pre_f = cf - 1 == -1 ? 0 : visibledatacolumn[cf - 1];

                var margeset = jfgrid.menuButton.mergeborer(jfgrid.flowdata, rf, cf);
                if(!!margeset){
                    row_f = margeset.row[1];
                    row_pre_f = margeset.row[0];
                    
                    col_f = margeset.column[1];
                    col_pre_f = margeset.column[0];
                }

                jfgird_select_save[i]["row"] = [r1, r2];
                jfgird_select_save[i]["column"] = [c1, c2];

                jfgird_select_save[i]["row_focus"] = rf;
                jfgird_select_save[i]["column_focus"] = cf;

                jfgird_select_save[i]["left"] = col_pre_f;
                jfgird_select_save[i]["width"] = col_f - col_pre_f - 1;
                jfgird_select_save[i]["top"] = row_pre_f;
                jfgird_select_save[i]["height"] = row_f - row_pre_f - 1;

                jfgird_select_save[i]["left_move"] = col_pre;
                jfgird_select_save[i]["width_move"] = col - col_pre - 1;
                jfgird_select_save[i]["top_move"] = row_pre;
                jfgird_select_save[i]["height_move"] = row - row_pre - 1;

                if(i == 0){
                    if(jfgird_select_save.length == 1){
                        $("#jfgrid-cell-selected-boxs #jfgrid-cell-selected").css({ "left": jfgird_select_save[i]["left_move"], "width": jfgird_select_save[i]["width_move"], "top": jfgird_select_save[i]["top_move"], "height": jfgird_select_save[i]["height_move"], "display": "block", "border": "1px solid #FC6666" }).find(".jfgrid-cs-draghandle").css("display", "block").end().find(".jfgrid-cs-fillhandle").css("display", "block");
                    }
                    else{
                        $("#jfgrid-cell-selected-boxs #jfgrid-cell-selected").css({ "left": jfgird_select_save[i]["left_move"], "width": jfgird_select_save[i]["width_move"], "top": jfgird_select_save[i]["top_move"], "height": jfgird_select_save[i]["height_move"], "display": "block", "border": "1px solid rgba(252,102,102,0.15)" }).find(".jfgrid-cs-draghandle").css("display", "none").end().find(".jfgrid-cs-fillhandle").css("display", "none");
                    }
                }
                else{
                    $("#jfgrid-cell-selected-boxs").append('<div class="jfgrid-cell-selected" style="left: '+ jfgird_select_save[i]["left_move"] +'px; width: '+ jfgird_select_save[i]["width_move"] +'px; top: '+ jfgird_select_save[i]["top_move"] +'px; height: '+ jfgird_select_save[i]["height_move"] +'px; border: 1px solid rgba(252,102,102,0.15); display: block;"></div>');
                }

                if(i == jfgird_select_save.length - 1){
                    //focus 取选区数组最后一个
                    $("#jfgrid-cell-selected-focus").css({ "left": jfgird_select_save[i]["left"], "width": jfgird_select_save[i]["width"], "top": jfgird_select_save[i]["top"], "height": jfgird_select_save[i]["height"], "display": "block" });
                    //行列数
                    jfgrid.jfgrid_count_show(jfgird_select_save[i]["left_move"], jfgird_select_save[i]["top_move"], jfgird_select_save[i]["width_move"], jfgird_select_save[i]["height_move"], [r1, r2], [c1, c2]);
                    //
                    jfgrid.formula.fucntionboxshow(rf, cf);
                }
            }

            //行列标题栏
            jfgrid.selectTitlesShow(jfgird_select_save);

            //左上角范围显示
            $("#jfgrid-helpbox-cell").text(jfgrid.sheetmanage.getRangetxt(jfgrid.currentSheetIndex, jfgird_select_save[jfgird_select_save.length - 1]));
            
            //动态数组显示
            if(jfgird_select_save.length == 1 && jfgird_select_save[0].row[0] == jfgird_select_save[0].row[1] && jfgird_select_save[0].column[0] == jfgird_select_save[0].column[1]){
                jfgrid.dynamicArray_hightShow(jfgird_select_save[0].row[0], jfgird_select_save[0].column[0]);
            }
        }

        jfgridfile[jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex)].jfgird_select_save = jfgird_select_save;
    }

    //选区标题栏
    jfgrid.selectTitlesShow = function(rangeArr){
        var s = $.extend(true, [], rangeArr);

        var rowTitleMap = {}, columnTitleMap = {};
        for(var i = 0; i < s.length; i++){
            var r1 = s[i]["row"][0], r2 = s[i]["row"][1], c1 = s[i]["column"][0], c2 = s[i]["column"][1];
            //行、列标题栏
            rowTitleMap = jfgrid.selectTitlesMap(rowTitleMap, r1, r2);
            columnTitleMap = jfgrid.selectTitlesMap(columnTitleMap, c1, c2);
        }

        //行标题
        $("#jfgrid-rows-h-selected").empty();

        var rowTitleRange = jfgrid.selectTitlesRange(rowTitleMap);
        for(var i = 0; i < rowTitleRange.length; i++){
            var r1 = rowTitleRange[i][0], r2 = rowTitleRange[i][rowTitleRange[i].length - 1];
            var row = jfgrid.rowLocationByIndex(r2)[1], row_pre = jfgrid.rowLocationByIndex(r1)[0];
            
            $("#jfgrid-rows-h-selected").append('<div class="jfgrid-rows-h-selected" style="top: '+ row_pre +'px; height: '+ (row - row_pre - 1) +'px; display: block; background-color: rgba(76, 76, 76, 0.1);"></div>');
        }

        //列标题
        $("#jfgrid-cols-h-selected").empty();

        var columnTitleRange = jfgrid.selectTitlesRange(columnTitleMap);
        for(var j = 0; j < columnTitleRange.length; j++){
            var c1 = columnTitleRange[j][0], c2 = columnTitleRange[j][columnTitleRange[j].length - 1];
            var col = jfgrid.colLocationByIndex(c2)[1], col_pre = jfgrid.colLocationByIndex(c1)[0];
            
            $("#jfgrid-cols-h-selected").append('<div class="jfgrid-cols-h-selected" style="left: '+ col_pre +'px; width: '+ (col - col_pre - 1) +'px; display: block; background-color: rgba(76, 76, 76, 0.1);"></div>');
        }
    }
    jfgrid.selectTitlesMap = function(rangeMap, range1, range2){
        var map = $.extend(true, {}, rangeMap);
        for(var i = range1; i <= range2; i++){
            if(i in map){
                continue;
            }
            map[i] = 0;
        }
        return map;
    }
    jfgrid.selectTitlesRange = function(map){
        var mapArr = [];
        for(var i in map){
            mapArr.push(i);
        }
        mapArr.sort(function(a, b){ return a - b; });

        var rangeArr = [];
        var item = [];
        if(mapArr.length > 1){
            for(var j = 1; j < mapArr.length; j++){
                if(mapArr[j] - mapArr[j - 1] == 1){
                    item.push(mapArr[j - 1]);
                    if(j == mapArr.length - 1){
                        item.push(mapArr[j]);
                        rangeArr.push(item);
                    }
                }
                else{
                    if(j == 1){
                        if(j == mapArr.length - 1){
                            item.push(mapArr[j - 1]);
                            rangeArr.push(item);
                            rangeArr.push([mapArr[j]]);
                        }
                        else{
                            rangeArr.push(mapArr[0]);    
                        }
                    }
                    else if(j == mapArr.length - 1){
                        item.push(mapArr[j - 1]);
                        rangeArr.push(item);
                        rangeArr.push([mapArr[j]]);
                    }
                    else{
                        item.push(mapArr[j - 1]);
                        rangeArr.push(item);
                        item = [];       
                    }
                }
            }
        }
        else{
            rangeArr.push([mapArr[0]]);
        }

        return rangeArr;
    }

    //选区是否重叠
    jfgrid.selectIsOverlap = function(){
        var overlap = false;
        var map = {};

        for(var s = 0; s < jfgird_select_save.length; s++){
            var str_r = jfgird_select_save[s].row[0], end_r = jfgird_select_save[s].row[1];
            var str_c = jfgird_select_save[s].column[0], end_c = jfgird_select_save[s].column[1];

            for(var r = str_r; r <= end_r; r++){
                for(var c = str_c; c <= end_c; c++){
                    if((r + "_" + c) in map){
                        overlap = true;
                        break;
                    }
                    else{
                        map[r + "_" + c] = 0;
                    }
                }
            }
        }

        return overlap;
    }

    //复制选区虚线框
    jfgrid.selectionCopyShow = function(range){
        $("#jfgrid-selection-copy").empty();

        if(range == null){
            range = jfgrid_selection_range;
        }

        if(range.length > 0){
            for(var s = 0; s < range.length; s++){
                var r1 = range[s].row[0], r2 = range[s].row[1];
                var c1 = range[s].column[0], c2 = range[s].column[1];

                var row = visibledatarow[r2], row_pre = r1 - 1 == -1 ? 0 : visibledatarow[r1 - 1];
                var col = visibledatacolumn[c2], col_pre = c1 - 1 == -1 ? 0 : visibledatacolumn[c1 - 1];

                var copyDomHtml = '<div class="jfgrid-selection-copy" style="display: block; left: '+ col_pre +'px; width: '+ (col - col_pre - 1) +'px; top: '+ row_pre +'px; height: '+ (row - row_pre - 1) +'px;">'+
                                    '<div class="jfgrid-selection-copy-top jfgrid-copy"></div>'+
                                    '<div class="jfgrid-selection-copy-right jfgrid-copy"></div>'+
                                    '<div class="jfgrid-selection-copy-bottom jfgrid-copy"></div>'+
                                    '<div class="jfgrid-selection-copy-left jfgrid-copy"></div>'+
                                    '<div class="jfgrid-selection-copy-hc"></div>'+
                                  '</div>';
                $("#jfgrid-selection-copy").append(copyDomHtml);
            }
        }
    }

    //范围是否只包含部分合并单元格
    jfgrid.hasPartMC = function(cfg, r1, r2, c1, c2){
        var hasPartMC = false;

        for(x in config["merge"]){
            var mc = cfg["merge"][x];

            if(r1 < mc.r){
                if(r2 >= mc.r && r2 < (mc.r + mc.rs - 1)){
                    if(c1 >= mc.c && c1 <= (mc.c + mc.cs - 1)){
                        hasPartMC = true;
                        break;
                    }
                    else if(c2 >= mc.c && c2 <= (mc.c + mc.cs - 1)){
                        hasPartMC = true;
                        break;
                    }
                    else if(c1 < mc.c && c2 > (mc.c + mc.cs - 1)){
                        hasPartMC = true;
                        break;
                    }
                }
                else if(r2 >= mc.r && r2 == (mc.r + mc.rs - 1)){
                    if(c1 > mc.c && c1 < (mc.c + mc.cs - 1)){
                        hasPartMC = true;
                        break;
                    }
                    else if(c2 > mc.c && c2 < (mc.c + mc.cs - 1)){
                        hasPartMC = true;
                        break;
                    }
                    else if(c1 == mc.c && c2 < (mc.c + mc.cs - 1)){
                        hasPartMC = true;
                        break;
                    }
                    else if(c1 > mc.c && c2 == (mc.c + mc.cs - 1)){
                        hasPartMC = true;
                        break;
                    }
                }
                else if(r2 > (mc.r + mc.rs - 1)){
                    if(c1 > mc.c && c1 <= (mc.c + mc.cs - 1)){
                        hasPartMC = true;
                        break;
                    }
                    else if(c2 >= mc.c && c2 < (mc.c + mc.cs - 1)){
                        hasPartMC = true;
                        break;
                    }
                    else if(c1 == mc.c && c2 < (mc.c + mc.cs - 1)){
                        hasPartMC = true;
                        break;
                    }
                    else if(c1 > mc.c && c2 == (mc.c + mc.cs - 1)){
                        hasPartMC = true;
                        break;
                    }
                }
            }
            else if(r1 == mc.r){
                if(r2 < (mc.r + mc.rs - 1)){
                    if(c1 >= mc.c && c1 <= (mc.c + mc.cs - 1)){
                        hasPartMC = true;
                        break;
                    }
                    else if(c2 >= mc.c && c2 <= (mc.c + mc.cs - 1)){
                        hasPartMC = true;
                        break;
                    }
                    else if(c1 < mc.c && c2 > (mc.c + mc.cs - 1)){
                        hasPartMC = true;
                        break;
                    }
                }
                else if(r2 >= (mc.r + mc.rs - 1)){
                    if(c1 > mc.c && c1 <= (mc.c + mc.cs - 1)){
                        hasPartMC = true;
                        break;
                    }
                    else if(c2 >= mc.c && c2 < (mc.c + mc.cs - 1)){
                        hasPartMC = true;
                        break;
                    }
                    else if(c1 == mc.c && c2 < (mc.c + mc.cs - 1)){
                        hasPartMC = true;
                        break;
                    }
                    else if(c1 > mc.c && c2 == (mc.c + mc.cs - 1)){
                        hasPartMC = true;
                        break;
                    }
                }
            }
            else if(r1 <= (mc.r + mc.rs - 1)){
                if(c1 >= mc.c && c1 <= (mc.c + mc.cs - 1)){
                    hasPartMC = true;
                    break;
                }
                else if(c2 >= mc.c && c2 <= (mc.c + mc.cs - 1)){
                    hasPartMC = true;
                    break;
                }
                else if(c1 < mc.c && c2 > (mc.c + mc.cs - 1)){
                    hasPartMC = true;
                    break;
                }
            }
        }

        return hasPartMC;
    }

    //范围是否都是空单元格(除第一个单元格)
    jfgrid.dynamicArray_rangeIsAllNull = function(range, data){
        var r1 = range["row"][0], r2 = range["row"][1];
        var c1 = range["column"][0], c2 = range["column"][1];

        var isAllNull = true;
        for(var r = r1; r <= r2; r++){
            for(var c = c1; c <= c2; c++){
                if(!(r == r1 && c == c1) && data[r][c] != null && data[r][c].v != null && data[r][c].v.toString() != ""){
                    isAllNull = false;
                    break;
                }
            }
        }

        return isAllNull;
    }
    jfgrid.dynamicArray_spillEditCompute = function(computeObj, r, c){
        var rowIndex = computeObj[r + "_" + c].r;
        var colIndex = computeObj[r + "_" + c].c;

        for(x in computeObj){
            if(x == (rowIndex + "_" + colIndex)){
                computeObj[x].v = "#SPILL!";
            }
            else if(computeObj[x].r == rowIndex && computeObj[x].c == colIndex){
                delete computeObj[x];
            }
        }

        return computeObj;
    }

    //点击表格区域是否属于动态数组区域
    jfgrid.dynamicArray_hightShow = function(r, c){
        var dynamicArray = jfgridfile[jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex)]["dynamicArray"] == null ? [] : jfgridfile[jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex)]["dynamicArray"];
        var dynamicArray_compute = jfgrid.dynamicArray_compute(dynamicArray);
    
        if((r + "_" + c) in dynamicArray_compute && dynamicArray_compute[r + "_" + c].v != "#SPILL!"){
            var d_row = dynamicArray_compute[r + "_" + c].r;
            var d_col = dynamicArray_compute[r + "_" + c].c;

            var d_f = jfgrid.flowdata[d_row][d_col].f;

            var rlen, clen;
            for(var i = 0; i < dynamicArray.length; i++){
                if(dynamicArray[i].f == d_f){
                    rlen = dynamicArray[i].data.length;

                    if(jfgrid.getObjType(dynamicArray[i].data[0]) == "array"){
                        clen = dynamicArray[i].data[0].length;
                    }
                    else{
                        clen = 1;
                    }
                }
            }

            var d_row_end = d_row + rlen - 1;
            var d_col_end = d_col + clen - 1;

            var row = visibledatarow[d_row_end], row_pre = d_row - 1 == -1 ? 0 : visibledatarow[d_row - 1];
            var col = visibledatacolumn[d_col_end], col_pre = d_col - 1 == -1 ? 0 : visibledatacolumn[d_col - 1];

            $("#jfgrid-dynamicArray-hightShow").css({ "left": col_pre, "width": col - col_pre - 1, "top": row_pre, "height": row - row_pre - 1, "display": "block" });
        }
        else{
            $("#jfgrid-dynamicArray-hightShow").hide();
        }
    }

    //动态数组计算
    jfgrid.dynamicArray_compute = function(dynamicArray){
        var dynamicArray_compute = {};

        if(jfgrid.getObjType(dynamicArray) == "array"){
            for(var i = 0; i < dynamicArray.length; i++){
                var d_row = dynamicArray[i].r;
                var d_col = dynamicArray[i].c;
                var d_f = dynamicArray[i].f;
                
                if(jfgrid.flowdata[d_row][d_col] != null && jfgrid.flowdata[d_row][d_col].f != null && jfgrid.flowdata[d_row][d_col].f == d_f){
                    if((d_row + "_" + d_col) in dynamicArray_compute){
                        dynamicArray_compute = jfgrid.dynamicArray_spillEditCompute(dynamicArray_compute, d_row , d_col);
                    }

                    var d_data = dynamicArray[i].data;
                    var d_rowlen = d_data.length;
                    var d_collen = 1;

                    if(jfgrid.getObjType(d_data[0]) == "array"){
                        d_collen = d_data[0].length;
                    }

                    if(jfgrid.dynamicArray_rangeIsAllNull({ "row": [d_row, d_row + d_rowlen - 1], "column": [d_col, d_col + d_collen - 1] }, jfgrid.flowdata)){
                        for(var x = 0; x < d_rowlen; x++){
                            for(var y = 0; y < d_collen; y++){
                                var rowIndex = d_row + x;
                                var colIndex = d_col + y;

                                if(jfgrid.getObjType(d_data[0]) == "array"){
                                    dynamicArray_compute[rowIndex + "_" + colIndex] = {"v": d_data[x][y], "r": d_row, "c": d_col};
                                }
                                else{
                                    dynamicArray_compute[rowIndex + "_" + colIndex] = {"v": d_data[x], "r": d_row, "c": d_col};
                                }
                            }
                        }
                    }
                    else{
                        dynamicArray_compute[d_row + "_" + d_col] = {"v": "#SPILL!", "r": d_row, "c": d_col};
                    }
                }
            }
        }

        return dynamicArray_compute;       
    }

    //shift + 方向键 / ctrl + shift + 方向键 功能
    jfgrid.rowHasMerge = function(r, c1, c2){
        var rowHasMerge = false;

        for(var c = c1; c <= c2; c++){
            var cell = jfgrid.flowdata[r][c];

            if(jfgrid.getObjType(cell) == "object" && ("mc" in cell)){
                rowHasMerge = true;
                break;
            }
        }

        return rowHasMerge;
    }
    jfgrid.colHasMerge = function(c, r1, r2){
        var colHasMerge = false;

        for(var r = r1; r <= r2; r++){
            var cell = jfgrid.flowdata[r][c];

            if(jfgrid.getObjType(cell) == "object" && ("mc" in cell)){
                colHasMerge = true;
                break;
            }
        }

        return colHasMerge;
    }
    jfgrid.getRowMerge = function(rIndex, c1, c2){
        var r1 = 0, r2 = jfgrid.flowdata.length - 1;

        var str = null;
        if(rIndex > r1){
            for(var r = rIndex; r >= r1; r--){
                for(var c = c1; c <= c2; c++){
                    var cell = jfgrid.flowdata[r][c];
                    
                    if(jfgrid.getObjType(cell) == "object" && ("mc" in cell)){
                        var mc = config["merge"][cell["mc"].r + "_" + cell["mc"].c];

                        if(str == null || mc.r < str){
                            str = mc.r;
                        }
                    }    
                }

                if(jfgrid.rowHasMerge(str - 1, c1, c2) && str > r1){
                    r = str - 1;
                }
                else{
                    break;
                }
            }
        }
        else{
            str = r1;
        }

        var end = null;
        if(rIndex < r2){
            for(var r = rIndex; r <= r2; r++){
                for(var c = c1; c <= c2; c++){
                    var cell = jfgrid.flowdata[r][c];
                    
                    if(jfgrid.getObjType(cell) == "object" && ("mc" in cell)){
                        var mc = config["merge"][cell["mc"].r + "_" + cell["mc"].c];

                        if(end == null || (mc.r + mc.rs - 1) > end){
                            end = mc.r + mc.rs - 1;
                        }
                    }
                }

                if(jfgrid.rowHasMerge(end + 1, c1, c2) && end < r2){
                    r = end + 1;
                }
                else{
                    break;
                }
            }
        }
        else{
            end = r2;
        }

        return [str, end];
    }
    jfgrid.getColMerge = function(cIndex, r1, r2){
        var c1 = 0, c2 = jfgrid.flowdata[0].length - 1;

        var str = null;
        if(cIndex > c1){
            for(var c = cIndex; c >= c1; c--){
                for(var r = r1; r <= r2; r++){
                    var cell = jfgrid.flowdata[r][c];
                    
                    if(jfgrid.getObjType(cell) == "object" && ("mc" in cell)){
                        var mc = config["merge"][cell["mc"].r + "_" + cell["mc"].c];

                        if(str == null || mc.c < str){
                            str = mc.c;
                        }
                    }    
                }

                if(jfgrid.colHasMerge(str - 1, r1, r2) && str > c1){
                    c = str - 1;
                }
                else{
                    break;
                }
            }
        }
        else{
            str = c1;
        }

        var end = null;
        if(cIndex < c2){
            for(var c = cIndex; c <= c2; c++){
                for(var r = r1; r <= r2; r++){
                    var cell = jfgrid.flowdata[r][c];
                    
                    if(jfgrid.getObjType(cell) == "object" && ("mc" in cell)){
                        var mc = config["merge"][cell["mc"].r + "_" + cell["mc"].c];

                        if(end == null || (mc.c + mc.cs - 1) > end){
                            end = mc.c + mc.cs - 1;
                        }
                    }
                }

                if(jfgrid.colHasMerge(end + 1, r1, r2) && end < c2){
                    c = end + 1;
                }
                else{
                    break;
                }
            }
        }
        else{
            end = c2;
        }

        return [str, end];
    }
    jfgrid.getNextIndex = function(direction, focusIndex, strIndex, endIndex){
        var index = null;

        var stNull;
        if(direction == "down"){
            var stValue = jfgrid.flowdata[strIndex][focusIndex];

            if(jfgrid.getObjType(stValue) == "object" && jfgrid.func_methods.isRealNull(stValue.v)){
                stNull = false;
            }
            else if(jfgrid.func_methods.isRealNull(stValue)){
                stNull = false;
            }
            else{
                stNull = true;
            }

            var cellNull = [], i = 0;
            for(var r = strIndex + 1; r <= endIndex; r++){
                var cell = jfgrid.flowdata[r][focusIndex];

                if(jfgrid.getObjType(cell) == "object" && jfgrid.func_methods.isRealNull(cell.v)){
                    cellNull.push(false);
                }
                else if(jfgrid.func_methods.isRealNull(cell)){
                    cellNull.push(false);
                }
                else{
                    cellNull.push(true);
                }

                if(cellNull.length == 1 && stNull && cellNull[i] == false){
                    index = strIndex + i + 1;
                    break;
                }
                else if(cellNull.length > 1){
                    if(stNull && cellNull[i] == false){ //起始是空，找第一个有值的位置
                        index = strIndex + i + 1;
                        break;
                    }
                    else if(!stNull){ //起始有值，找一个有值的位置
                        if(cellNull[i] == false && cellNull[i - 1] == true){ //前面为空
                            index = strIndex + i + 1;
                            break;
                        }
                        else if(cellNull[i] == true && cellNull[i - 1] == false){ //后面为空
                            index = strIndex + i;
                            break;
                        }
                    }
                }

                if(r == endIndex){
                    index = endIndex;
                }

                i++;
            }
        }
        else if(direction == "up"){
            var stValue = jfgrid.flowdata[endIndex][focusIndex];

            if(jfgrid.getObjType(stValue) == "object" && jfgrid.func_methods.isRealNull(stValue.v)){
                stNull = false;
            }
            else if(jfgrid.func_methods.isRealNull(stValue)){
                stNull = false;
            }
            else{
                stNull = true;
            }

            var cellNull = [], i = 0;
            for(var r = endIndex - 1; r >= strIndex; r--){
                var cell = jfgrid.flowdata[r][focusIndex];

                if(jfgrid.getObjType(cell) == "object" && jfgrid.func_methods.isRealNull(cell.v)){
                    cellNull.push(false);
                }
                else if(jfgrid.func_methods.isRealNull(cell)){
                    cellNull.push(false);
                }
                else{
                    cellNull.push(true);
                }

                if(cellNull.length == 1 && stNull && cellNull[i] == false){
                    index = endIndex - (i + 1);
                    break;
                }
                else if(cellNull.length > 1){
                    if(stNull && cellNull[i] == false){ //起始是空，找第一个有值的位置
                        index = endIndex - (i + 1);
                        break;
                    }
                    else if(!stNull){ //起始有值，找一个有值的位置
                        if(cellNull[i] == false && cellNull[i - 1] == true){ //前面为空
                            index = endIndex - (i + 1);
                            break;
                        }
                        else if(cellNull[i] == true && cellNull[i - 1] == false){ //后面为空
                            index = endIndex - i;
                            break;
                        }
                    }
                }

                if(r == strIndex){
                    index = strIndex;
                }

                i++;
            }
        }
        else if(direction == "right"){
            var stValue = jfgrid.flowdata[focusIndex][strIndex];

            if(jfgrid.getObjType(stValue) == "object" && jfgrid.func_methods.isRealNull(stValue.v)){
                stNull = false;
            }
            else if(jfgrid.func_methods.isRealNull(stValue)){
                stNull = false;
            }
            else{
                stNull = true;
            }

            var cellNull = [], i = 0;
            for(var c = strIndex + 1; c <= endIndex; c++){
                var cell = jfgrid.flowdata[focusIndex][c];

                if(jfgrid.getObjType(cell) == "object" && jfgrid.func_methods.isRealNull(cell.v)){
                    cellNull.push(false);
                }
                else if(jfgrid.func_methods.isRealNull(cell)){
                    cellNull.push(false);
                }
                else{
                    cellNull.push(true);
                }

                if(cellNull.length == 1 && stNull && cellNull[i] == false){
                    index = strIndex + i + 1;
                    break;
                }
                else if(cellNull.length > 1){
                    if(stNull && cellNull[i] == false){ //起始是空，找第一个有值的位置
                        index = strIndex + i + 1;
                        break;
                    }
                    else if(!stNull){ //起始有值，找一个有值的位置
                        if(cellNull[i] == false && cellNull[i - 1] == true){ //前面为空
                            index = strIndex + i + 1;
                            break;
                        }
                        else if(cellNull[i] == true && cellNull[i - 1] == false){ //后面为空
                            index = strIndex + i;
                            break;
                        }
                    }
                }

                if(c == endIndex){
                    index = endIndex;
                }

                i++;
            }
        }
        else if(direction == "left"){
            var stValue = jfgrid.flowdata[focusIndex][endIndex];

            if(jfgrid.getObjType(stValue) == "object" && jfgrid.func_methods.isRealNull(stValue.v)){
                stNull = false;
            }
            else if(jfgrid.func_methods.isRealNull(stValue)){
                stNull = false;
            }
            else{
                stNull = true;
            }

            var cellNull = [], i = 0;
            for(var c = endIndex - 1; c >= strIndex; c--){
                var cell = jfgrid.flowdata[focusIndex][c];

                if(jfgrid.getObjType(cell) == "object" && jfgrid.func_methods.isRealNull(cell.v)){
                    cellNull.push(false);
                }
                else if(jfgrid.func_methods.isRealNull(cell)){
                    cellNull.push(false);
                }
                else{
                    cellNull.push(true);
                }

                if(cellNull.length == 1 && stNull && cellNull[i] == false){
                    index = endIndex - (i + 1);
                    break;
                }
                else if(cellNull.length > 1){
                    if(stNull && cellNull[i] == false){ //起始是空，找第一个有值的位置
                        index = endIndex - (i + 1);
                        break;
                    }
                    else if(!stNull){ //起始有值，找一个有值的位置
                        if(cellNull[i] == false && cellNull[i - 1] == true){ //前面为空
                            index = endIndex - (i + 1);
                            break;
                        }
                        else if(cellNull[i] == true && cellNull[i - 1] == false){ //后面为空
                            index = endIndex - i;
                            break;
                        }
                    }
                }

                if(c == strIndex){
                    index = strIndex;
                }

                i++;
            }
        }

        return index;
    }

    //获取表格边框数据计算值
    jfgrid.getBorderInfoCompute = function(sheetIndex){
        var borderInfoCompute = {};

        if(sheetIndex == null){
            var cfg = config;
            var data = jfgrid.flowdata;
        }
        else{
            var cfg = jfgridfile[jfgrid.sheetmanage.getSheetIndex(sheetIndex)].config;
            var data = jfgridfile[jfgrid.sheetmanage.getSheetIndex(sheetIndex)].data;
        }

        var borderInfo = cfg["borderInfo"];

        if(borderInfo != null && borderInfo.length > 0){
            for(var i = 0; i < borderInfo.length; i++){
                var rangeType = borderInfo[i].rangeType;

                if(rangeType == "range"){
                    var borderType = borderInfo[i].borderType;
                    var borderColor = borderInfo[i].color;
                    var borderStyle = borderInfo[i].style;

                    var borderRange = borderInfo[i].range;

                    for(var j = 0; j < borderRange.length; j++){
                        var bd_r1 = borderRange[j].row[0], bd_r2 = borderRange[j].row[1];
                        var bd_c1 = borderRange[j].column[0], bd_c2 = borderRange[j].column[1];

                        if(borderType == "border-left"){
                            for(var bd_r = bd_r1; bd_r <= bd_r2; bd_r++){
                                if (cfg["rowhidden"] != null && cfg["rowhidden"][bd_r] != null) {
                                    continue;
                                }
                                
                                if(borderInfoCompute[bd_r + "_" + bd_c1] == null){
                                    borderInfoCompute[bd_r + "_" + bd_c1] = {};
                                }

                                borderInfoCompute[bd_r + "_" + bd_c1].l = { "color": borderColor, "style": borderStyle };

                                var bd_c_left = bd_c1 - 1;

                                if(bd_c_left >= 0 && borderInfoCompute[bd_r + "_" + bd_c_left]){
                                    if(data[bd_r] != null && jfgrid.getObjType(data[bd_r][bd_c_left]) == "object" && data[bd_r][bd_c_left].mc != null){
                                        var cell_left = data[bd_r][bd_c_left];

                                        var mc = cfg["merge"][cell_left.mc.r + "_" + cell_left.mc.c];

                                        if(mc.c + mc.cs - 1 == bd_c_left){
                                            borderInfoCompute[bd_r + "_" + bd_c_left].r = { "color": borderColor, "style": borderStyle }; 
                                        }
                                    }
                                    else{
                                        borderInfoCompute[bd_r + "_" + bd_c_left].r = { "color": borderColor, "style": borderStyle }; 
                                    }
                                }
                            }
                        }
                        else if(borderType == "border-right"){
                            for(var bd_r = bd_r1; bd_r <= bd_r2; bd_r++){
                                if (cfg["rowhidden"] != null && cfg["rowhidden"][bd_r] != null) {
                                    continue;
                                }
                                
                                if(borderInfoCompute[bd_r + "_" + bd_c2] == null){
                                    borderInfoCompute[bd_r + "_" + bd_c2] = {};
                                }

                                borderInfoCompute[bd_r + "_" + bd_c2].r = { "color": borderColor, "style": borderStyle };

                                var bd_c_right = bd_c2 + 1;

                                if(bd_c_right < data[0].length && borderInfoCompute[bd_r + "_" + bd_c_right]){
                                    if(data[bd_r] != null && jfgrid.getObjType(data[bd_r][bd_c_right]) == "object" && data[bd_r][bd_c_right].mc != null){
                                        var cell_right = data[bd_r][bd_c_right];

                                        var mc = cfg["merge"][cell_right.mc.r + "_" + cell_right.mc.c];

                                        if(mc.c == bd_c_right){
                                            borderInfoCompute[bd_r + "_" + bd_c_right].l = { "color": borderColor, "style": borderStyle }; 
                                        }
                                    }
                                    else{
                                        borderInfoCompute[bd_r + "_" + bd_c_right].l = { "color": borderColor, "style": borderStyle }; 
                                    }
                                }
                            }
                        }
                        else if(borderType == "border-top"){
                            if (cfg["rowhidden"] != null && cfg["rowhidden"][bd_r1] != null) {
                                continue;
                            }

                            for(var bd_c = bd_c1; bd_c <= bd_c2; bd_c++){
                                if(borderInfoCompute[bd_r1 + "_" + bd_c] == null){
                                    borderInfoCompute[bd_r1 + "_" + bd_c] = {};
                                }

                                borderInfoCompute[bd_r1 + "_" + bd_c].t = { "color": borderColor, "style": borderStyle };

                                var bd_r_top = bd_r1 - 1;

                                if(bd_r_top >= 0 && borderInfoCompute[bd_r_top + "_" + bd_c]){
                                    if(data[bd_r_top] != null && jfgrid.getObjType(data[bd_r_top][bd_c]) == "object" && data[bd_r_top][bd_c].mc != null){
                                        var cell_top = data[bd_r_top][bd_c];

                                        var mc = cfg["merge"][cell_top.mc.r + "_" + cell_top.mc.c];

                                        if(mc.r + mc.rs - 1 == bd_r_top){
                                            borderInfoCompute[bd_r_top + "_" + bd_c].b = { "color": borderColor, "style": borderStyle };
                                        }
                                    }
                                    else{
                                        borderInfoCompute[bd_r_top + "_" + bd_c].b = { "color": borderColor, "style": borderStyle };
                                    }
                                }
                            }
                        }
                        else if(borderType == "border-bottom"){
                            if (cfg["rowhidden"] != null && cfg["rowhidden"][bd_r2] != null) {
                                continue;
                            }

                            for(var bd_c = bd_c1; bd_c <= bd_c2; bd_c++){
                                if(borderInfoCompute[bd_r2 + "_" + bd_c] == null){
                                    borderInfoCompute[bd_r2 + "_" + bd_c] = {};
                                }

                                borderInfoCompute[bd_r2 + "_" + bd_c].b = { "color": borderColor, "style": borderStyle };

                                var bd_r_bottom = bd_r2 + 1;

                                if(bd_r_bottom < data.length && borderInfoCompute[bd_r_bottom + "_" + bd_c]){
                                    if(data[bd_r_bottom] != null && jfgrid.getObjType(data[bd_r_bottom][bd_c]) == "object" && data[bd_r_bottom][bd_c].mc != null){
                                        var cell_bottom = data[bd_r_bottom][bd_c];

                                        var mc = cfg["merge"][cell_bottom.mc.r + "_" + cell_bottom.mc.c];

                                        if(mc.r == bd_r_bottom){
                                            borderInfoCompute[bd_r_bottom + "_" + bd_c].t = { "color": borderColor, "style": borderStyle }; 
                                        }
                                    }
                                    else{
                                        borderInfoCompute[bd_r_bottom + "_" + bd_c].t = { "color": borderColor, "style": borderStyle }; 
                                    }
                                }
                            }
                        }
                        else if(borderType == "border-all"){
                            for(var bd_r = bd_r1; bd_r <= bd_r2; bd_r++){
                                if (cfg["rowhidden"] != null && cfg["rowhidden"][bd_r] != null) {
                                    continue;
                                }

                                for(var bd_c = bd_c1; bd_c <= bd_c2; bd_c++){
                                    if(data[bd_r] != null && jfgrid.getObjType(data[bd_r][bd_c]) == "object" && data[bd_r][bd_c].mc != null){
                                        var cell = data[bd_r][bd_c];

                                        var mc = cfg["merge"][cell.mc.r + "_" + cell.mc.c];

                                        if(mc.r == bd_r){
                                            if(borderInfoCompute[bd_r + "_" + bd_c] == null){
                                                borderInfoCompute[bd_r + "_" + bd_c] = {};
                                            }

                                            borderInfoCompute[bd_r + "_" + bd_c].t = { "color": borderColor, "style": borderStyle };
                                        }
                                        
                                        if(mc.r + mc.rs - 1 == bd_r){
                                            if(borderInfoCompute[bd_r + "_" + bd_c] == null){
                                                borderInfoCompute[bd_r + "_" + bd_c] = {};
                                            }

                                            borderInfoCompute[bd_r + "_" + bd_c].b = { "color": borderColor, "style": borderStyle };
                                        }

                                        if(mc.c == bd_c){
                                            if(borderInfoCompute[bd_r + "_" + bd_c] == null){
                                                borderInfoCompute[bd_r + "_" + bd_c] = {};
                                            }

                                            borderInfoCompute[bd_r + "_" + bd_c].l = { "color": borderColor, "style": borderStyle };
                                        }
                                        
                                        if(mc.c + mc.cs - 1 == bd_c){
                                            if(borderInfoCompute[bd_r + "_" + bd_c] == null){
                                                borderInfoCompute[bd_r + "_" + bd_c] = {};
                                            }

                                            borderInfoCompute[bd_r + "_" + bd_c].r = { "color": borderColor, "style": borderStyle };
                                        }
                                    }
                                    else{
                                        if(borderInfoCompute[bd_r + "_" + bd_c] == null){
                                            borderInfoCompute[bd_r + "_" + bd_c] = {};
                                        }

                                        borderInfoCompute[bd_r + "_" + bd_c].l = { "color": borderColor, "style": borderStyle };
                                        borderInfoCompute[bd_r + "_" + bd_c].r = { "color": borderColor, "style": borderStyle };
                                        borderInfoCompute[bd_r + "_" + bd_c].t = { "color": borderColor, "style": borderStyle };
                                        borderInfoCompute[bd_r + "_" + bd_c].b = { "color": borderColor, "style": borderStyle };
                                    }

                                    if(bd_r == bd_r1){
                                        var bd_r_top = bd_r1 - 1;

                                        if(bd_r_top >= 0 && borderInfoCompute[bd_r_top + "_" + bd_c]){
                                            if(data[bd_r_top] != null && jfgrid.getObjType(data[bd_r_top][bd_c]) == "object" && data[bd_r_top][bd_c].mc != null){
                                                var cell_top = data[bd_r_top][bd_c];

                                                var mc = cfg["merge"][cell_top.mc.r + "_" + cell_top.mc.c];

                                                if(mc.r + mc.rs - 1 == bd_r_top){
                                                    borderInfoCompute[bd_r_top + "_" + bd_c].b = { "color": borderColor, "style": borderStyle };
                                                }
                                            }
                                            else{
                                                borderInfoCompute[bd_r_top + "_" + bd_c].b = { "color": borderColor, "style": borderStyle };
                                            }
                                        }
                                    }
                                    
                                    if(bd_r == bd_r2){
                                        var bd_r_bottom = bd_r2 + 1;

                                        if(bd_r_bottom < data.length && borderInfoCompute[bd_r_bottom + "_" + bd_c]){
                                            if(data[bd_r_bottom] != null && jfgrid.getObjType(data[bd_r_bottom][bd_c]) == "object" && data[bd_r_bottom][bd_c].mc != null){
                                                var cell_bottom = data[bd_r_bottom][bd_c];

                                                var mc = cfg["merge"][cell_bottom.mc.r + "_" + cell_bottom.mc.c];

                                                if(mc.r == bd_r_bottom){
                                                    borderInfoCompute[bd_r_bottom + "_" + bd_c].t = { "color": borderColor, "style": borderStyle }; 
                                                }
                                            }
                                            else{
                                                borderInfoCompute[bd_r_bottom + "_" + bd_c].t = { "color": borderColor, "style": borderStyle }; 
                                            }
                                        }
                                    }
                                    
                                    if(bd_c == bd_c1){
                                        var bd_c_left = bd_c1 - 1;

                                        if(bd_c_left >= 0 && borderInfoCompute[bd_r + "_" + bd_c_left]){
                                            if(data[bd_r] != null && jfgrid.getObjType(data[bd_r][bd_c_left]) == "object" && data[bd_r][bd_c_left].mc != null){
                                                var cell_left = data[bd_r][bd_c_left];

                                                var mc = cfg["merge"][cell_left.mc.r + "_" + cell_left.mc.c];

                                                if(mc.c + mc.cs - 1 == bd_c_left){
                                                    borderInfoCompute[bd_r + "_" + bd_c_left].r = { "color": borderColor, "style": borderStyle }; 
                                                }
                                            }
                                            else{
                                                borderInfoCompute[bd_r + "_" + bd_c_left].r = { "color": borderColor, "style": borderStyle }; 
                                            }
                                        }
                                    }
                                    
                                    if(bd_c == bd_c2){
                                        var bd_c_right = bd_c2 + 1;

                                        if(bd_c_right < data[0].length && borderInfoCompute[bd_r + "_" + bd_c_right]){
                                            if(data[bd_r] != null && jfgrid.getObjType(data[bd_r][bd_c_right]) == "object" && data[bd_r][bd_c_right].mc != null){
                                                var cell_right = data[bd_r][bd_c_right];

                                                var mc = cfg["merge"][cell_right.mc.r + "_" + cell_right.mc.c];

                                                if(mc.c == bd_c_right){
                                                    borderInfoCompute[bd_r + "_" + bd_c_right].l = { "color": borderColor, "style": borderStyle }; 
                                                }
                                            }
                                            else{
                                                borderInfoCompute[bd_r + "_" + bd_c_right].l = { "color": borderColor, "style": borderStyle }; 
                                            }
                                        }
                                    }
                                }
                            }
                        }
                        else if(borderType == "border-outside"){
                            for(var bd_r = bd_r1; bd_r <= bd_r2; bd_r++){
                                if (cfg["rowhidden"] != null && cfg["rowhidden"][bd_r] != null) {
                                    continue;
                                }

                                for(var bd_c = bd_c1; bd_c <= bd_c2; bd_c++){
                                    if(!(bd_r == bd_r1 || bd_r == bd_r2 || bd_c == bd_c1 || bd_c == bd_c2)){
                                        continue;
                                    }

                                    if(bd_r == bd_r1){
                                        if(borderInfoCompute[bd_r + "_" + bd_c] == null){
                                            borderInfoCompute[bd_r + "_" + bd_c] = {};
                                        }

                                        borderInfoCompute[bd_r + "_" + bd_c].t = { "color": borderColor, "style": borderStyle };

                                        var bd_r_top = bd_r1 - 1;

                                        if(bd_r_top >= 0 && borderInfoCompute[bd_r_top + "_" + bd_c]){
                                            if(data[bd_r_top] != null && jfgrid.getObjType(data[bd_r_top][bd_c]) == "object" && data[bd_r_top][bd_c].mc != null){
                                                var cell_top = data[bd_r_top][bd_c];

                                                var mc = cfg["merge"][cell_top.mc.r + "_" + cell_top.mc.c];

                                                if(mc.r + mc.rs - 1 == bd_r_top){
                                                    borderInfoCompute[bd_r_top + "_" + bd_c].b = { "color": borderColor, "style": borderStyle };
                                                }
                                            }
                                            else{
                                                borderInfoCompute[bd_r_top + "_" + bd_c].b = { "color": borderColor, "style": borderStyle };
                                            }
                                        }
                                    }

                                    if(bd_r == bd_r2){
                                        if(borderInfoCompute[bd_r + "_" + bd_c] == null){
                                            borderInfoCompute[bd_r + "_" + bd_c] = {};
                                        }

                                        borderInfoCompute[bd_r + "_" + bd_c].b = { "color": borderColor, "style": borderStyle };

                                        var bd_r_bottom = bd_r2 + 1;

                                        if(bd_r_bottom < data.length && borderInfoCompute[bd_r_bottom + "_" + bd_c]){
                                            if(data[bd_r_bottom] != null && jfgrid.getObjType(data[bd_r_bottom][bd_c]) == "object" && data[bd_r_bottom][bd_c].mc != null){
                                                var cell_bottom = data[bd_r_bottom][bd_c];

                                                var mc = cfg["merge"][cell_bottom.mc.r + "_" + cell_bottom.mc.c];

                                                if(mc.r == bd_r_bottom){
                                                    borderInfoCompute[bd_r_bottom + "_" + bd_c].t = { "color": borderColor, "style": borderStyle }; 
                                                }
                                            }
                                            else{
                                                borderInfoCompute[bd_r_bottom + "_" + bd_c].t = { "color": borderColor, "style": borderStyle }; 
                                            }
                                        }
                                    }

                                    if(bd_c == bd_c1){
                                        if(borderInfoCompute[bd_r + "_" + bd_c] == null){
                                            borderInfoCompute[bd_r + "_" + bd_c] = {};
                                        }

                                        borderInfoCompute[bd_r + "_" + bd_c].l = { "color": borderColor, "style": borderStyle };

                                        var bd_c_left = bd_c1 - 1;

                                        if(bd_c_left >= 0 && borderInfoCompute[bd_r + "_" + bd_c_left]){
                                            if(data[bd_r] != null && jfgrid.getObjType(data[bd_r][bd_c_left]) == "object" && data[bd_r][bd_c_left].mc != null){
                                                var cell_left = data[bd_r][bd_c_left];

                                                var mc = cfg["merge"][cell_left.mc.r + "_" + cell_left.mc.c];

                                                if(mc.c + mc.cs - 1 == bd_c_left){
                                                    borderInfoCompute[bd_r + "_" + bd_c_left].r = { "color": borderColor, "style": borderStyle }; 
                                                }
                                            }
                                            else{
                                                borderInfoCompute[bd_r + "_" + bd_c_left].r = { "color": borderColor, "style": borderStyle }; 
                                            }
                                        }
                                    }

                                    if(bd_c == bd_c2){
                                        if(borderInfoCompute[bd_r + "_" + bd_c] == null){
                                            borderInfoCompute[bd_r + "_" + bd_c] = {};
                                        }

                                        borderInfoCompute[bd_r + "_" + bd_c].r = { "color": borderColor, "style": borderStyle };

                                        var bd_c_right = bd_c2 + 1;

                                        if(bd_c_right < data[0].length && borderInfoCompute[bd_r + "_" + bd_c_right]){
                                            if(data[bd_r] != null && jfgrid.getObjType(data[bd_r][bd_c_right]) == "object" && data[bd_r][bd_c_right].mc != null){
                                                var cell_right = data[bd_r][bd_c_right];

                                                var mc = cfg["merge"][cell_right.mc.r + "_" + cell_right.mc.c];

                                                if(mc.c == bd_c_right){
                                                    borderInfoCompute[bd_r + "_" + bd_c_right].l = { "color": borderColor, "style": borderStyle }; 
                                                }
                                            }
                                            else{
                                                borderInfoCompute[bd_r + "_" + bd_c_right].l = { "color": borderColor, "style": borderStyle }; 
                                            }
                                        }
                                    }
                                }
                            }
                        }
                        else if(borderType == "border-inside"){
                            for(var bd_r = bd_r1; bd_r <= bd_r2; bd_r++){
                                if (cfg["rowhidden"] != null && cfg["rowhidden"][bd_r] != null) {
                                    continue;
                                }

                                for(var bd_c = bd_c1; bd_c <= bd_c2; bd_c++){
                                    if(bd_r == bd_r1 && bd_c == bd_c1){
                                        if(data[bd_r] != null && jfgrid.getObjType(data[bd_r][bd_c]) == "object" && data[bd_r][bd_c].mc != null){

                                        }
                                        else{
                                            if(borderInfoCompute[bd_r + "_" + bd_c] == null){
                                                borderInfoCompute[bd_r + "_" + bd_c] = {};
                                            }

                                            borderInfoCompute[bd_r + "_" + bd_c].r = { "color": borderColor, "style": borderStyle };
                                            borderInfoCompute[bd_r + "_" + bd_c].b = { "color": borderColor, "style": borderStyle };
                                        }
                                    }
                                    else if(bd_r == bd_r2 && bd_c == bd_c1){
                                        if(data[bd_r] != null && jfgrid.getObjType(data[bd_r][bd_c]) == "object" && data[bd_r][bd_c].mc != null){

                                        }
                                        else{
                                            if(borderInfoCompute[bd_r + "_" + bd_c] == null){
                                                borderInfoCompute[bd_r + "_" + bd_c] = {};
                                            }

                                            borderInfoCompute[bd_r + "_" + bd_c].r = { "color": borderColor, "style": borderStyle };
                                            borderInfoCompute[bd_r + "_" + bd_c].t = { "color": borderColor, "style": borderStyle };
                                        }
                                    }
                                    else if(bd_r == bd_r1 && bd_c == bd_c2){
                                        if(data[bd_r] != null && jfgrid.getObjType(data[bd_r][bd_c]) == "object" && data[bd_r][bd_c].mc != null){

                                        }
                                        else{
                                            if(borderInfoCompute[bd_r + "_" + bd_c] == null){
                                                borderInfoCompute[bd_r + "_" + bd_c] = {};
                                            }

                                            borderInfoCompute[bd_r + "_" + bd_c].l = { "color": borderColor, "style": borderStyle };
                                            borderInfoCompute[bd_r + "_" + bd_c].b = { "color": borderColor, "style": borderStyle };
                                        }
                                    }
                                    else if(bd_r == bd_r2 && bd_c == bd_c2){
                                        if(data[bd_r] != null && jfgrid.getObjType(data[bd_r][bd_c]) == "object" && data[bd_r][bd_c].mc != null){

                                        }
                                        else{
                                            if(borderInfoCompute[bd_r + "_" + bd_c] == null){
                                                borderInfoCompute[bd_r + "_" + bd_c] = {};
                                            }

                                            borderInfoCompute[bd_r + "_" + bd_c].l = { "color": borderColor, "style": borderStyle };
                                            borderInfoCompute[bd_r + "_" + bd_c].t = { "color": borderColor, "style": borderStyle };
                                        }
                                    }
                                    else if(bd_r == bd_r1){
                                        if(data[bd_r] != null && jfgrid.getObjType(data[bd_r][bd_c]) == "object" && data[bd_r][bd_c].mc != null){
                                            var cell = data[bd_r][bd_c];

                                            var mc = cfg["merge"][cell.mc.r + "_" + cell.mc.c];

                                            if(mc.c == bd_c){
                                                if(borderInfoCompute[bd_r + "_" + bd_c] == null){
                                                    borderInfoCompute[bd_r + "_" + bd_c] = {};
                                                }

                                                borderInfoCompute[bd_r + "_" + bd_c].l = { "color": borderColor, "style": borderStyle };
                                            }
                                            else if(mc.c + mc.cs - 1 == bd_c){
                                                if(borderInfoCompute[bd_r + "_" + bd_c] == null){
                                                    borderInfoCompute[bd_r + "_" + bd_c] = {};
                                                }

                                                borderInfoCompute[bd_r + "_" + bd_c].r = { "color": borderColor, "style": borderStyle };
                                            }
                                        }
                                        else{
                                            if(borderInfoCompute[bd_r + "_" + bd_c] == null){
                                                borderInfoCompute[bd_r + "_" + bd_c] = {};
                                            }

                                            borderInfoCompute[bd_r + "_" + bd_c].l = { "color": borderColor, "style": borderStyle };
                                            borderInfoCompute[bd_r + "_" + bd_c].r = { "color": borderColor, "style": borderStyle };
                                            borderInfoCompute[bd_r + "_" + bd_c].b = { "color": borderColor, "style": borderStyle };
                                        }
                                    }
                                    else if(bd_r == bd_r2){
                                        if(data[bd_r] != null && jfgrid.getObjType(data[bd_r][bd_c]) == "object" && data[bd_r][bd_c].mc != null){
                                            var cell = data[bd_r][bd_c];

                                            var mc = cfg["merge"][cell.mc.r + "_" + cell.mc.c];

                                            if(mc.c == bd_c){
                                                if(borderInfoCompute[bd_r + "_" + bd_c] == null){
                                                    borderInfoCompute[bd_r + "_" + bd_c] = {};
                                                }

                                                borderInfoCompute[bd_r + "_" + bd_c].l = { "color": borderColor, "style": borderStyle };
                                            }
                                            else if(mc.c + mc.cs - 1 == bd_c){
                                                if(borderInfoCompute[bd_r + "_" + bd_c] == null){
                                                    borderInfoCompute[bd_r + "_" + bd_c] = {};
                                                }

                                                borderInfoCompute[bd_r + "_" + bd_c].r = { "color": borderColor, "style": borderStyle };
                                            }
                                        }
                                        else{
                                            if(borderInfoCompute[bd_r + "_" + bd_c] == null){
                                                borderInfoCompute[bd_r + "_" + bd_c] = {};
                                            }

                                            borderInfoCompute[bd_r + "_" + bd_c].l = { "color": borderColor, "style": borderStyle };
                                            borderInfoCompute[bd_r + "_" + bd_c].r = { "color": borderColor, "style": borderStyle };
                                            borderInfoCompute[bd_r + "_" + bd_c].t = { "color": borderColor, "style": borderStyle };
                                        }
                                    }
                                    else if(bd_c == bd_c1){
                                        if(data[bd_r] != null && jfgrid.getObjType(data[bd_r][bd_c]) == "object" && data[bd_r][bd_c].mc != null){
                                            var cell = data[bd_r][bd_c];

                                            var mc = cfg["merge"][cell.mc.r + "_" + cell.mc.c];

                                            if(mc.r == bd_r){
                                                if(borderInfoCompute[bd_r + "_" + bd_c] == null){
                                                    borderInfoCompute[bd_r + "_" + bd_c] = {};
                                                }

                                                borderInfoCompute[bd_r + "_" + bd_c].t = { "color": borderColor, "style": borderStyle };
                                            }
                                            else if(mc.r + mc.rs - 1 == bd_r){
                                                if(borderInfoCompute[bd_r + "_" + bd_c] == null){
                                                    borderInfoCompute[bd_r + "_" + bd_c] = {};
                                                }

                                                borderInfoCompute[bd_r + "_" + bd_c].b = { "color": borderColor, "style": borderStyle };
                                            }
                                        }
                                        else{
                                            if(borderInfoCompute[bd_r + "_" + bd_c] == null){
                                                borderInfoCompute[bd_r + "_" + bd_c] = {};
                                            }

                                            borderInfoCompute[bd_r + "_" + bd_c].r = { "color": borderColor, "style": borderStyle };
                                            borderInfoCompute[bd_r + "_" + bd_c].t = { "color": borderColor, "style": borderStyle };
                                            borderInfoCompute[bd_r + "_" + bd_c].b = { "color": borderColor, "style": borderStyle };
                                        }
                                    }
                                    else if(bd_c == bd_c2){
                                        if(data[bd_r] != null && jfgrid.getObjType(data[bd_r][bd_c]) == "object" && data[bd_r][bd_c].mc != null){
                                            var cell = data[bd_r][bd_c];

                                            var mc = cfg["merge"][cell.mc.r + "_" + cell.mc.c];

                                            if(mc.r == bd_r){
                                                if(borderInfoCompute[bd_r + "_" + bd_c] == null){
                                                    borderInfoCompute[bd_r + "_" + bd_c] = {};
                                                }

                                                borderInfoCompute[bd_r + "_" + bd_c].t = { "color": borderColor, "style": borderStyle };
                                            }
                                            else if(mc.r + mc.rs - 1 == bd_r){
                                                if(borderInfoCompute[bd_r + "_" + bd_c] == null){
                                                    borderInfoCompute[bd_r + "_" + bd_c] = {};
                                                }

                                                borderInfoCompute[bd_r + "_" + bd_c].b = { "color": borderColor, "style": borderStyle };
                                            }
                                        }
                                        else{
                                            if(borderInfoCompute[bd_r + "_" + bd_c] == null){
                                                borderInfoCompute[bd_r + "_" + bd_c] = {};
                                            }

                                            borderInfoCompute[bd_r + "_" + bd_c].l = { "color": borderColor, "style": borderStyle };
                                            borderInfoCompute[bd_r + "_" + bd_c].t = { "color": borderColor, "style": borderStyle };
                                            borderInfoCompute[bd_r + "_" + bd_c].b = { "color": borderColor, "style": borderStyle };
                                        }
                                    }
                                    else{
                                        if(data[bd_r] != null && jfgrid.getObjType(data[bd_r][bd_c]) == "object" && data[bd_r][bd_c].mc != null){
                                            var cell = data[bd_r][bd_c];

                                            var mc = cfg["merge"][cell.mc.r + "_" + cell.mc.c];

                                            if(mc.r == bd_r){
                                                if(borderInfoCompute[bd_r + "_" + bd_c] == null){
                                                    borderInfoCompute[bd_r + "_" + bd_c] = {};
                                                }

                                                borderInfoCompute[bd_r + "_" + bd_c].t = { "color": borderColor, "style": borderStyle };
                                            }
                                            else if(mc.r + mc.rs - 1 == bd_r){
                                                if(borderInfoCompute[bd_r + "_" + bd_c] == null){
                                                    borderInfoCompute[bd_r + "_" + bd_c] = {};
                                                }

                                                borderInfoCompute[bd_r + "_" + bd_c].b = { "color": borderColor, "style": borderStyle };
                                            }

                                            if(mc.c == bd_c){
                                                if(borderInfoCompute[bd_r + "_" + bd_c] == null){
                                                    borderInfoCompute[bd_r + "_" + bd_c] = {};
                                                }

                                                borderInfoCompute[bd_r + "_" + bd_c].l = { "color": borderColor, "style": borderStyle };
                                            }
                                            else if(mc.c + mc.cs - 1 == bd_c){
                                                if(borderInfoCompute[bd_r + "_" + bd_c] == null){
                                                    borderInfoCompute[bd_r + "_" + bd_c] = {};
                                                }

                                                borderInfoCompute[bd_r + "_" + bd_c].r = { "color": borderColor, "style": borderStyle };
                                            }
                                        }
                                        else{
                                            if(borderInfoCompute[bd_r + "_" + bd_c] == null){
                                                borderInfoCompute[bd_r + "_" + bd_c] = {};
                                            }

                                            borderInfoCompute[bd_r + "_" + bd_c].l = { "color": borderColor, "style": borderStyle };
                                            borderInfoCompute[bd_r + "_" + bd_c].r = { "color": borderColor, "style": borderStyle };
                                            borderInfoCompute[bd_r + "_" + bd_c].t = { "color": borderColor, "style": borderStyle };
                                            borderInfoCompute[bd_r + "_" + bd_c].b = { "color": borderColor, "style": borderStyle };
                                        }
                                    }    
                                }
                            }
                        }
                        else if(borderType == "border-horizontal"){
                            for(var bd_r = bd_r1; bd_r <= bd_r2; bd_r++){
                                if (cfg["rowhidden"] != null && cfg["rowhidden"][bd_r] != null) {
                                    continue;
                                }

                                for(var bd_c = bd_c1; bd_c <= bd_c2; bd_c++){
                                    if(bd_r == bd_r1){
                                        if(data[bd_r] != null && jfgrid.getObjType(data[bd_r][bd_c]) == "object" && data[bd_r][bd_c].mc != null){

                                        }
                                        else{
                                            if(borderInfoCompute[bd_r + "_" + bd_c] == null){
                                                borderInfoCompute[bd_r + "_" + bd_c] = {};
                                            }

                                            borderInfoCompute[bd_r + "_" + bd_c].b = { "color": borderColor, "style": borderStyle };
                                        }
                                    }
                                    else if(bd_r == bd_r2){
                                        if(data[bd_r] != null && jfgrid.getObjType(data[bd_r][bd_c]) == "object" && data[bd_r][bd_c].mc != null){

                                        }
                                        else{
                                            if(borderInfoCompute[bd_r + "_" + bd_c] == null){
                                                borderInfoCompute[bd_r + "_" + bd_c] = {};
                                            }

                                            borderInfoCompute[bd_r + "_" + bd_c].t = { "color": borderColor, "style": borderStyle };
                                        }
                                    }
                                    else{
                                        if(data[bd_r] != null && jfgrid.getObjType(data[bd_r][bd_c]) == "object" && data[bd_r][bd_c].mc != null){
                                            var cell = data[bd_r][bd_c];

                                            var mc = cfg["merge"][cell.mc.r + "_" + cell.mc.c];

                                            if(mc.r == bd_r){
                                                if(borderInfoCompute[bd_r + "_" + bd_c] == null){
                                                    borderInfoCompute[bd_r + "_" + bd_c] = {};
                                                }

                                                borderInfoCompute[bd_r + "_" + bd_c].t = { "color": borderColor, "style": borderStyle };
                                            }
                                            else if(mc.r + mc.rs - 1 == bd_r){
                                                if(borderInfoCompute[bd_r + "_" + bd_c] == null){
                                                    borderInfoCompute[bd_r + "_" + bd_c] = {};
                                                }

                                                borderInfoCompute[bd_r + "_" + bd_c].b = { "color": borderColor, "style": borderStyle };
                                            }
                                        }
                                        else{
                                            if(borderInfoCompute[bd_r + "_" + bd_c] == null){
                                                borderInfoCompute[bd_r + "_" + bd_c] = {};
                                            }

                                            borderInfoCompute[bd_r + "_" + bd_c].t = { "color": borderColor, "style": borderStyle };
                                            borderInfoCompute[bd_r + "_" + bd_c].b = { "color": borderColor, "style": borderStyle };
                                        }
                                    }
                                }
                            }
                        }
                        else if(borderType == "border-vertical"){
                            for(var bd_r = bd_r1; bd_r <= bd_r2; bd_r++){
                                if (cfg["rowhidden"] != null && cfg["rowhidden"][bd_r] != null) {
                                    continue;
                                }

                                for(var bd_c = bd_c1; bd_c <= bd_c2; bd_c++){
                                    if(bd_c == bd_c1){
                                        if(data[bd_r] != null && jfgrid.getObjType(data[bd_r][bd_c]) == "object" && data[bd_r][bd_c].mc != null){

                                        }
                                        else{
                                            if(borderInfoCompute[bd_r + "_" + bd_c] == null){
                                                borderInfoCompute[bd_r + "_" + bd_c] = {};
                                            }

                                            borderInfoCompute[bd_r + "_" + bd_c].r = { "color": borderColor, "style": borderStyle };
                                        }
                                    }
                                    else if(bd_c == bd_c2){
                                        if(data[bd_r] != null && jfgrid.getObjType(data[bd_r][bd_c]) == "object" && data[bd_r][bd_c].mc != null){

                                        }
                                        else{
                                            if(borderInfoCompute[bd_r + "_" + bd_c] == null){
                                                borderInfoCompute[bd_r + "_" + bd_c] = {};
                                            }

                                            borderInfoCompute[bd_r + "_" + bd_c].l = { "color": borderColor, "style": borderStyle };
                                        }
                                    }
                                    else{
                                        if(data[bd_r] != null && jfgrid.getObjType(data[bd_r][bd_c]) == "object" && data[bd_r][bd_c].mc != null){
                                            var cell = data[bd_r][bd_c];

                                            var mc = cfg["merge"][cell.mc.r + "_" + cell.mc.c];

                                            if(mc.c == bd_c){
                                                if(borderInfoCompute[bd_r + "_" + bd_c] == null){
                                                    borderInfoCompute[bd_r + "_" + bd_c] = {};
                                                }

                                                borderInfoCompute[bd_r + "_" + bd_c].l = { "color": borderColor, "style": borderStyle };
                                            }
                                            else if(mc.c + mc.cs - 1 == bd_c){
                                                if(borderInfoCompute[bd_r + "_" + bd_c] == null){
                                                    borderInfoCompute[bd_r + "_" + bd_c] = {};
                                                }

                                                borderInfoCompute[bd_r + "_" + bd_c].r = { "color": borderColor, "style": borderStyle };
                                            }
                                        }
                                        else{
                                            if(borderInfoCompute[bd_r + "_" + bd_c] == null){
                                                borderInfoCompute[bd_r + "_" + bd_c] = {};
                                            }

                                            borderInfoCompute[bd_r + "_" + bd_c].l = { "color": borderColor, "style": borderStyle };
                                            borderInfoCompute[bd_r + "_" + bd_c].r = { "color": borderColor, "style": borderStyle };
                                        }
                                    }
                                }
                            }
                        }
                        else if(borderType == "border-none"){
                            for(var bd_r = bd_r1; bd_r <= bd_r2; bd_r++){
                                if (cfg["rowhidden"] != null && cfg["rowhidden"][bd_r] != null) {
                                    continue;
                                }

                                for(var bd_c = bd_c1; bd_c <= bd_c2; bd_c++){
                                    if(borderInfoCompute[bd_r + "_" + bd_c] != null){
                                        delete borderInfoCompute[bd_r + "_" + bd_c];
                                    }

                                    if(bd_r == bd_r1){
                                        var bd_r_top = bd_r1 - 1;

                                        if(bd_r_top >= 0 && borderInfoCompute[bd_r_top + "_" + bd_c]){
                                            delete borderInfoCompute[bd_r_top + "_" + bd_c].b;
                                        }
                                    }
                                    
                                    if(bd_r == bd_r2){
                                        var bd_r_bottom = bd_r2 + 1;

                                        if(bd_r_bottom < data.length && borderInfoCompute[bd_r_bottom + "_" + bd_c]){
                                            delete borderInfoCompute[bd_r_bottom + "_" + bd_c].t;
                                        }
                                    }
                                    
                                    if(bd_c == bd_c1){
                                        var bd_c_left = bd_c1 - 1;

                                        if(bd_c_left >= 0 && borderInfoCompute[bd_r + "_" + bd_c_left]){
                                            delete borderInfoCompute[bd_r + "_" + bd_c_left].r;
                                        }
                                    }
                                    
                                    if(bd_c == bd_c2){
                                        var bd_c_right = bd_c2 + 1;

                                        if(bd_c_right < data[0].length && borderInfoCompute[bd_r + "_" + bd_c_right]){
                                            delete borderInfoCompute[bd_r + "_" + bd_c_right].l;
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
                else if(rangeType == "cell"){
                    var value = borderInfo[i].value;

                    var bd_r = value.row_index, bd_c = value.col_index;

                    if (cfg["rowhidden"] != null && cfg["rowhidden"][bd_r] != null) {
                        continue;
                    }

                    if(value.l != null || value.r != null || value.t != null || value.b != null){
                        if(borderInfoCompute[bd_r + "_" + bd_c] == null){
                            borderInfoCompute[bd_r + "_" + bd_c] = {};
                        }

                        if(data[bd_r] != null && jfgrid.getObjType(data[bd_r][bd_c]) == "object" && data[bd_r][bd_c].mc != null){
                            var cell = data[bd_r][bd_c];
                            var mc = cfg["merge"][cell.mc.r + "_" + cell.mc.c];

                            if(value.l != null && bd_c == mc.c){ //左边框
                                borderInfoCompute[bd_r + "_" + bd_c].l = { "color": value.l.color, "style": value.l.style };

                                var bd_c_left = bd_c - 1;

                                if(bd_c_left >= 0 && borderInfoCompute[bd_r + "_" + bd_c_left]){
                                    if(data[bd_r] != null && jfgrid.getObjType(data[bd_r][bd_c_left]) == "object" && data[bd_r][bd_c_left].mc != null){
                                        var cell_left = data[bd_r][bd_c_left];

                                        var mc_l = cfg["merge"][cell_left.mc.r + "_" + cell_left.mc.c];

                                        if(mc_l.c + mc_l.cs - 1 == bd_c_left){
                                            borderInfoCompute[bd_r + "_" + bd_c_left].r = { "color": value.l.color, "style": value.l.style }; 
                                        }
                                    }
                                    else{
                                        borderInfoCompute[bd_r + "_" + bd_c_left].r = { "color": value.l.color, "style": value.l.style }; 
                                    }
                                }
                            }
                            else{
                                borderInfoCompute[bd_r + "_" + bd_c].l = null;
                            }

                            if(value.r != null && bd_c == mc.c + mc.cs - 1){ //右边框
                                borderInfoCompute[bd_r + "_" + bd_c].r = { "color": value.r.color, "style": value.r.style };

                                var bd_c_right = bd_c + 1;

                                if(bd_c_right < data[0].length && borderInfoCompute[bd_r + "_" + bd_c_right]){
                                    if(data[bd_r] != null && jfgrid.getObjType(data[bd_r][bd_c_right]) == "object" && data[bd_r][bd_c_right].mc != null){
                                        var cell_right = data[bd_r][bd_c_right];

                                        var mc_r = cfg["merge"][cell_right.mc.r + "_" + cell_right.mc.c];

                                        if(mc_r.c == bd_c_right){
                                            borderInfoCompute[bd_r + "_" + bd_c_right].l = { "color": value.r.color, "style": value.r.style }; 
                                        }
                                    }
                                    else{
                                        borderInfoCompute[bd_r + "_" + bd_c_right].l = { "color": value.r.color, "style": value.r.style }; 
                                    }
                                }
                            }
                            else{
                                borderInfoCompute[bd_r + "_" + bd_c].r = null;
                            }

                            if(value.t != null && bd_r == mc.r){ //上边框
                                borderInfoCompute[bd_r + "_" + bd_c].t = { "color": value.t.color, "style": value.t.style };

                                var bd_r_top = bd_r - 1;

                                if(bd_r_top >= 0 && borderInfoCompute[bd_r_top + "_" + bd_c]){
                                    if(data[bd_r_top] != null && jfgrid.getObjType(data[bd_r_top][bd_c]) == "object" && data[bd_r_top][bd_c].mc != null){
                                        var cell_top = data[bd_r_top][bd_c];

                                        var mc_t = cfg["merge"][cell_top.mc.r + "_" + cell_top.mc.c];

                                        if(mc_t.r + mc_t.rs - 1 == bd_r_top){
                                            borderInfoCompute[bd_r_top + "_" + bd_c].b = { "color": value.t.color, "style": value.t.style };
                                        }
                                    }
                                    else{
                                        borderInfoCompute[bd_r_top + "_" + bd_c].b = { "color": value.t.color, "style": value.t.style };
                                    }
                                }
                            }
                            else{
                                borderInfoCompute[bd_r + "_" + bd_c].t = null;
                            }

                            if(value.b != null && bd_r == mc.r + mc.rs - 1){ //下边框
                                borderInfoCompute[bd_r + "_" + bd_c].b = { "color": value.b.color, "style": value.b.style };

                                var bd_r_bottom = bd_r + 1;

                                if(bd_r_bottom < data.length && borderInfoCompute[bd_r_bottom + "_" + bd_c]){
                                    if(data[bd_r_bottom] != null && jfgrid.getObjType(data[bd_r_bottom][bd_c]) == "object" && data[bd_r_bottom][bd_c].mc != null){
                                        var cell_bottom = data[bd_r_bottom][bd_c];
                                        
                                        var mc_b = cfg["merge"][cell_bottom.mc.r + "_" + cell_bottom.mc.c];

                                        if(mc_b.r == bd_r_bottom){
                                            borderInfoCompute[bd_r_bottom + "_" + bd_c].t = { "color": value.b.color, "style": value.b.style }; 
                                        }
                                    }
                                    else{
                                        borderInfoCompute[bd_r_bottom + "_" + bd_c].t = { "color": value.b.color, "style": value.b.style }; 
                                    }
                                }
                            }
                            else{
                                borderInfoCompute[bd_r + "_" + bd_c].b = null;
                            }
                        }
                        else{
                            if(value.l != null){ //左边框
                                borderInfoCompute[bd_r + "_" + bd_c].l = { "color": value.l.color, "style": value.l.style };

                                var bd_c_left = bd_c - 1;

                                if(bd_c_left >= 0 && borderInfoCompute[bd_r + "_" + bd_c_left]){
                                    if(data[bd_r] != null && jfgrid.getObjType(data[bd_r][bd_c_left]) == "object" && data[bd_r][bd_c_left].mc != null){
                                        var cell_left = data[bd_r][bd_c_left];

                                        var mc_l = cfg["merge"][cell_left.mc.r + "_" + cell_left.mc.c];

                                        if(mc_l.c + mc_l.cs - 1 == bd_c_left){
                                            borderInfoCompute[bd_r + "_" + bd_c_left].r = { "color": value.l.color, "style": value.l.style }; 
                                        }
                                    }
                                    else{
                                        borderInfoCompute[bd_r + "_" + bd_c_left].r = { "color": value.l.color, "style": value.l.style }; 
                                    }
                                }
                            }
                            else{
                                borderInfoCompute[bd_r + "_" + bd_c].l = null;
                            }

                            if(value.r != null){ //右边框
                                borderInfoCompute[bd_r + "_" + bd_c].r = { "color": value.r.color, "style": value.r.style };

                                var bd_c_right = bd_c + 1;

                                if(bd_c_right < data[0].length && borderInfoCompute[bd_r + "_" + bd_c_right]){
                                    if(data[bd_r] != null && jfgrid.getObjType(data[bd_r][bd_c_right]) == "object" && data[bd_r][bd_c_right].mc != null){
                                        var cell_right = data[bd_r][bd_c_right];

                                        var mc_r = cfg["merge"][cell_right.mc.r + "_" + cell_right.mc.c];

                                        if(mc_r.c == bd_c_right){
                                            borderInfoCompute[bd_r + "_" + bd_c_right].l = { "color": value.r.color, "style": value.r.style }; 
                                        }
                                    }
                                    else{
                                        borderInfoCompute[bd_r + "_" + bd_c_right].l = { "color": value.r.color, "style": value.r.style }; 
                                    }
                                }
                            }
                            else{
                                borderInfoCompute[bd_r + "_" + bd_c].r = null;
                            }

                            if(value.t != null){ //上边框
                                borderInfoCompute[bd_r + "_" + bd_c].t = { "color": value.t.color, "style": value.t.style };

                                var bd_r_top = bd_r - 1;

                                if(bd_r_top >= 0 && borderInfoCompute[bd_r_top + "_" + bd_c]){
                                    if(data[bd_r_top] != null && jfgrid.getObjType(data[bd_r_top][bd_c]) == "object" && data[bd_r_top][bd_c].mc != null){
                                        var cell_top = data[bd_r_top][bd_c];

                                        var mc_t = cfg["merge"][cell_top.mc.r + "_" + cell_top.mc.c];

                                        if(mc_t.r + mc_t.rs - 1 == bd_r_top){
                                            borderInfoCompute[bd_r_top + "_" + bd_c].b = { "color": value.t.color, "style": value.t.style };
                                        }
                                    }
                                    else{
                                        borderInfoCompute[bd_r_top + "_" + bd_c].b = { "color": value.t.color, "style": value.t.style };
                                    }
                                }
                            }
                            else{
                                borderInfoCompute[bd_r + "_" + bd_c].t = null;
                            }

                            if(value.b != null){ //下边框
                                borderInfoCompute[bd_r + "_" + bd_c].b = { "color": value.b.color, "style": value.b.style };

                                var bd_r_bottom = bd_r + 1;

                                if(bd_r_bottom < data.length && borderInfoCompute[bd_r_bottom + "_" + bd_c]){
                                    if(data[bd_r_bottom] != null && jfgrid.getObjType(data[bd_r_bottom][bd_c]) == "object" && data[bd_r_bottom][bd_c].mc != null){
                                        var cell_bottom = data[bd_r_bottom][bd_c];
                                        
                                        var mc_b = cfg["merge"][cell_bottom.mc.r + "_" + cell_bottom.mc.c];

                                        if(mc_b.r == bd_r_bottom){
                                            borderInfoCompute[bd_r_bottom + "_" + bd_c].t = { "color": value.b.color, "style": value.b.style }; 
                                        }
                                    }
                                    else{
                                        borderInfoCompute[bd_r_bottom + "_" + bd_c].t = { "color": value.b.color, "style": value.b.style }; 
                                    }
                                }
                            }
                            else{
                                borderInfoCompute[bd_r + "_" + bd_c].b = null;
                            }
                        }
                    }
                    else{
                        delete borderInfoCompute[bd_r + "_" + bd_c];
                    }
                }
            }
        }

        return borderInfoCompute;
    }

    var jfgridbinary_search = function (arr, key) {
        var low = 0, high = arr.length - 1;
        while (low <= high) {
            var mid = parseInt((high + low) / 2);
            if (key < arr[mid] && (mid == 0 || key >= arr[mid - 1])) {
                return mid;
            } 
            else if (key >= arr[mid]) {
                low = mid + 1;
            } 
            else if (key < arr[mid]) {
                high = mid - 1;
            }
            else {
                return -1;
            }
        }
    }

    var jfgridorder_search = function (arr, y) {
        var i = 0, row = 0, row_pre = 0, row_index = -1, i_ed = arr.length - 1;
        while (i < arr.length && i_ed >= 0 && i_ed >= i) {
            row = arr[i_ed];
            if (i_ed == 0) {
                row_pre = 0;
            }
            else {
                row_pre = arr[i_ed - 1];
            }

            if (y >= row_pre && y < row) {
                row_index = i_ed;
                break;
            }

            row = arr[i];
            if (i == 0) {
                row_pre = 0;
            }
            else {
                row_pre = arr[i - 1];
            }

            if (y >= row_pre && y < row) {
                row_index = i;
                break;
            }

            i++;
            i_ed--;
        }

        return row_index;
    }

    var jfgrid_searcharray = function (arr, y) {
        if(jfgridConfigsetting.pointEdit){
            arr = $.extend(true, [], arr); 

            for(var i = 0; i < arr.length; i++){
                arr[i] = arr[i] * jfgridConfigsetting.pointEditZoom;
            }
        }

        var index = arr.length - 1;
        if (arr.length < 40 || y <= arr[20] || y >= arr[index - 20]) {
            index = jfgridorder_search(arr, y);
        }
        else {
            index = jfgridbinary_search(arr, y);
        }
        return index;
    }

    //, columeflowset, rowflowset
    jfgrid.jfgridHandler = function () {
        //var rowshowstate = [];
        //for(var i=0; i<flowheight_end;i++){
        //    if(i<3){
        //        rowshowstate.append(true);
        //    }
        //    else{
        //        rowshowstate.append(false);
        //    }
        //}

        //var colshowstate = [];
        //for(var i=0; i<flowwidth_end;i++){
        //    if(i<2){
        //        colshowstate.append(true);
        //    }
        //    else{
        //        colshowstate.append(false);
        //    }
        //}

        //全局滚动事件
        jfgrid.jfgridscrollevent = function (isadjust) {
            var $t = $("#jfgrid-cell-main");
            var scrollLeft = $("#jfgrid-scrollbar-x").scrollLeft(), scrollTop = $("#jfgrid-scrollbar-y").scrollTop();

            if (!!isadjust && jfgridautoadjustmousedown != 0) {
                var scrollHeight = $t.get(0).scrollHeight;
                var windowHeight = $t.height();
                var scrollWidth = $t.get(0).scrollWidth;
                var windowWidth = $t.width();

                var maxScrollLeft = scrollWidth - windowWidth;
                var maxScrollTop = scrollHeight - windowHeight;

                var visibledatacolumn_c = visibledatacolumn, visibledatarow_c = visibledatarow;
                // if (jfgrid.freezen.freezenhorizontaldata != null || jfgrid.freezen.freezenverticaldata != null) {
                //     // jfgrid.cleargridelement();
                // }

                if (jfgrid.freezen.freezenhorizontaldata != null) {
                    visibledatarow_c = jfgrid.freezen.freezenhorizontaldata[3];
                }

                if (jfgrid.freezen.freezenverticaldata != null) {
                    visibledatacolumn_c = jfgrid.freezen.freezenverticaldata[3];
                }

                var col_ed = jfgrid_searcharray(visibledatacolumn_c, scrollLeft);
                var row_ed = jfgrid_searcharray(visibledatarow_c, scrollTop);

                //var col_ed_e = jfgrid_searcharray(visibledatacolumn_c, scrollLeft + jfgridTableContentHW[0]);
                //var row_ed_e = jfgrid_searcharray(visibledatarow_c, scrollTop + jfgridTableContentHW[1]);

                var refreshLeft = scrollLeft , refreshTop = scrollTop;

                if (col_ed <= 0) {
                    scrollLeft = 0;
                }
                else {
                    // scrollLeft = visibledatacolumn_c[col_ed - 1];
                    scrollLeft = visibledatacolumn_c[col_ed];
                }

                if (row_ed <= 0) {
                    scrollTop = 0;
                }
                else {
                    // scrollTop = visibledatarow_c[row_ed - 1];
                    scrollTop = visibledatarow_c[row_ed];
                }

                // if (jfgridautoscrollp[0] < scrollLeft) {
                //     //col_ed += 1;
                //     if (col_ed <= 0) {
                //         scrollLeft = visibledatacolumn_c[0];
                //     }
                //     else {
                //         scrollLeft = visibledatacolumn_c[col_ed-1];
                //     }
                // }
                // else if (jfgridautoscrollp[0] >= scrollLeft) {
                //     //col_ed -= 1;
                //     if (col_ed <= 0) {
                //         scrollLeft = 0;
                //     }
                //     else {
                //         scrollLeft = visibledatacolumn_c[col_ed];
                //     }
                // }

                // if (jfgridautoscrollp[1] < scrollTop) {
                //     //row_ed += jfgridautoadjustmousedown;
                //     if (row_ed == 0) {
                //         scrollTop = visibledatarow_c[0];
                //     }
                //     else {
                //         scrollTop = visibledatarow_c[row_ed-1];
                //     }
                //     //console.log(scrollTop, visibledatarow_c, row_ed);
                // }
                // else if (jfgridautoscrollp[1] >= scrollTop) {
                //     //row_ed -= jfgridautoadjustmousedown;
                //     if (row_ed <= 0) {
                //         scrollTop = 0;
                //     }
                //     else {
                //         scrollTop = visibledatarow_c[row_ed];
                //     }
                // }
            }

            if (jfgrid.freezen.freezenhorizontaldata != null) {
                if (scrollTop < jfgrid.freezen.freezenhorizontaldata[2]) {
                    scrollTop = jfgrid.freezen.freezenhorizontaldata[2];
                    $("#jfgrid-scrollbar-y").scrollTop(scrollTop);
                    return;
                    //$(this).scrollTop(scrollTop);
                }
            }

            if (jfgrid.freezen.freezenverticaldata != null) {
                if (scrollLeft < jfgrid.freezen.freezenverticaldata[2]) {
                    scrollLeft = jfgrid.freezen.freezenverticaldata[2];
                    $("#jfgrid-scrollbar-x").scrollLeft(scrollLeft);
                    return;
                    //$(this).scrollTop(scrollLeft);
                }
            }

            $("#jfgrid-cols-h-c").scrollLeft(scrollLeft);//列标题
            $("#jfgrid-rows-h").scrollTop(scrollTop);//行标题
            
            jfgridautoscrollp = [scrollLeft, scrollTop];
            $t.scrollLeft(scrollLeft).scrollTop(scrollTop);

            $("#jfgrid-input-box-index").css({"left": $("#jfgrid-input-box").css("left"), "top": (parseInt($("#jfgrid-input-box").css("top")) - 20) + "px", "z-index": $("#jfgrid-input-box").css("z-index")}).show();
            
            jfgrid.jfgridrefreshgrid(scrollLeft, scrollTop);

            $("#jfgrid-bottom-controll-row").css("left", scrollLeft + 10);

            //有选区且有冻结时，滚动适应
            if(jfgrid.freezen.freezenhorizontaldata != null || jfgrid.freezen.freezenverticaldata != null){
                jfgrid.freezen.scrollAdapt();
            }
        }

        $("#jfgrid-cell-main").scroll(function () {

            //jfgrid.jfgridscrollevent(true);

            // else{
            // 	jfgridautoadjust = setTimeout(function(){
            //         jfgrid.jfgridscrollevent(true);
            //     }, 100);
            // }
            // jfgridautoadjust = setTimeout(function(){
            //     jfgrid.jfgridscrollevent(true);
            // }, 100);
        }).mousewheel(function (event, delta) {
            //jfgridautoadjustmousedown = 2;
            //$("#jfgrid-scrollbar-x").scrollLeft($("#jfgrid-scrollbar-x").scrollLeft() - event.deltaX*19*2);
            //$("#jfgrid-scrollbar-y").scrollTop($("#jfgrid-scrollbar-y").scrollTop() - event.deltaY*19*2);
            event.preventDefault();
        });

        $("#jfgrid-grid-window-1").mousewheel(function (event, delta) {
            var scrollLeft = $("#jfgrid-scrollbar-x").scrollLeft(), scrollTop = $("#jfgrid-scrollbar-y").scrollTop();
            var visibledatacolumn_c = visibledatacolumn, visibledatarow_c = visibledatarow;

            if (jfgrid.freezen.freezenhorizontaldata != null) {
                visibledatarow_c = jfgrid.freezen.freezenhorizontaldata[3];
            }

            if (jfgrid.freezen.freezenverticaldata != null) {
                visibledatacolumn_c = jfgrid.freezen.freezenverticaldata[3];
            }

            visibledatacolumn_c = jfgrid.ArrayUnique(visibledatacolumn_c);
            visibledatarow_c = jfgrid.ArrayUnique(visibledatarow_c);

            var col_st = jfgrid_searcharray(visibledatacolumn_c, scrollLeft);
            var row_st = jfgrid_searcharray(visibledatarow_c, scrollTop);

            var colscroll = 0;
            var rowscroll = 0;

            if(event.deltaX != 0){
                if(event.deltaX < 0){
                    var col_ed = col_st + 3;
                    if(col_ed >= visibledatacolumn_c.length){
                        col_ed = visibledatacolumn_c.length - 1;
                    }
                }
                else{
                    var col_ed = col_st - 3;
                    if(col_ed < 0){
                        col_ed = 0;
                    }
                }

                colscroll = col_ed == 0 ? 0 : visibledatacolumn_c[col_ed - 1];

                $("#jfgrid-scrollbar-x").scrollLeft(colscroll);
            }

            if(event.deltaY != 0){
                if(event.deltaY < 0){
                    var row_ed = row_st + 3;
                    if(row_ed >= visibledatarow_c.length){
                        row_ed = visibledatarow_c.length - 1;
                    }
                }
                else{
                    var row_ed = row_st - 3;
                    if(row_ed < 0){
                        row_ed = 0;
                    }
                }

                rowscroll = row_ed == 0 ? 0 : visibledatarow_c[row_ed - 1];

                $("#jfgrid-scrollbar-y").scrollTop(rowscroll);
            }
        });
        $("#jfgrid-scrollbar-x").scroll(function(){
            //jfgrid.jfgridscrollevent(true);
            setTimeout(function(){
                jfgrid.jfgridscrollevent(true);
            },10); 
        }).mousewheel(function (event, delta) {
            event.preventDefault();
        });

        $("#jfgrid-scrollbar-y").scroll(function(){
            //jfgrid.jfgridscrollevent(true);
			setTimeout(function(){
                jfgrid.jfgridscrollevent(true);
            },10);
        }).mousewheel(function (event, delta) {
            event.preventDefault();
        });

        $(window).resize(function () {
            iscopyself = false;
            //jfgridautoadjustmousedown = 1;
            jfgrid.jfgridsizeauto();
            //jfgridautoadjustmousedown = 2;
        });

        //数组去重
        jfgrid.ArrayUnique = function(dataArr){
            var arr = [];

            if(dataArr.length > 0){
                for(var i = 0; i < dataArr.length; i++){
                    if(arr.indexOf(dataArr[i]) == -1){
                        arr.push(dataArr[i]);
                    }
                }
            }

            return arr;
        }

        jfgrid.rowLocationByIndex = function(row_index){
            var row = 0, row_pre = 0;
            row = visibledatarow[row_index];

            if (row_index == 0) {
                row_pre = 0;
            }
            else {
                row_pre = visibledatarow[row_index - 1];
            }

            return [row_pre, row, row_index];
        }

        jfgrid.rowLocation = function (y) {
            //var row = 0, row_pre = 0;
            var row_index = jfgrid_searcharray(visibledatarow, y);

            if (row_index == -1 && y > 0) {
                row_index = visibledatarow.length - 1;
            }
            else if (row_index == -1 && y <= 0) {
                row_index = 0;
            }

            // row = visibledatarow[row_index];

            // if (row_index == 0) {
            //     row_pre = 0;
            // }
            // else {
            //     row_pre = visibledatarow[row_index - 1];
            // }
            return jfgrid.rowLocationByIndex(row_index);
        }

        jfgrid.colLocationByIndex = function(col_index){
            var col = 0, col_pre = 0;            
            col = visibledatacolumn[col_index];

            if (col_index == 0) {
                col_pre = 0;
            }
            else {
                col_pre = visibledatacolumn[col_index - 1];
            }

            return [col_pre, col, col_index];
        }

        jfgrid.colLocation = function (x) {
            //var col = 0, col_pre = 0;
            var col_index = jfgrid_searcharray(visibledatacolumn, x);

            if (col_index == -1 && x > 0) {
                col_index = visibledatacolumn.length - 1;
            }
            else if (col_index == -1 && x <= 0) {
                col_index = 0;
            }

            return jfgrid.colLocationByIndex(col_index);

            // col = visibledatacolumn[col_index];
            // if (col_index == 0) {
            //     col_pre = 0;
            // }
            // else {
            //     col_pre = visibledatacolumn[col_index - 1];
            // }
            // return [col_pre, col, col_index];
        }

        var mouseposition = function (x, y) {
            var container_offset = $("#" + container).offset();

            if(jfgridConfigsetting.pointEdit){
                var newX = x - container_offset.left - rowHeaderWidth * jfgridConfigsetting.pointEditZoom,
                    newY = y - container_offset.top - (infobarHeight + toolbarHeight + calculatebarHeight + columeHeaderHeight) * jfgridConfigsetting.pointEditZoom;
            }
            else{
                var newX = x - container_offset.left - rowHeaderWidth,
                    newY = y - container_offset.top - infobarHeight - toolbarHeight - calculatebarHeight - columeHeaderHeight;
            }

            return [newX, newY];
        }

        jfgrid.mouseposition = mouseposition;

        //选区拖动替换
        var jfgrid_cell_selected_move = false, jfgrid_cell_selected_move_index = [];
        $("#jfgrid-cell-main div.jfgrid-cs-draghandle").mousedown(function (event) {
            if(jfgrid.isEditMode()){//此模式下禁用选区拖动
                return;
            }

            $("#jfgrid-cell-selected").find(".jfgrid-cs-fillhandle").css("cursor","move").end().find(".jfgrid-cs-draghandle").css("cursor","move");
            $("#jfgrid-cell-main, #jfgridTableContent, #jfgrid-sheettable_0").css("cursor","move");

            jfgrid_cell_selected_move = true;
            jfgird_scroll_status = true;

            var mouse = mouseposition(event.pageX, event.pageY);
            var x = mouse[0] + $("#jfgrid-cell-main").scrollLeft();
            var y = mouse[1] + $("#jfgrid-cell-main").scrollTop();

            var rowLocation = jfgrid.rowLocation(y), row_pre = rowLocation[0], row = rowLocation[1], row_index = rowLocation[2];
            var colLocation = jfgrid.colLocation(x), col_pre = colLocation[0], col = colLocation[1], col_index = colLocation[2];

            jfgrid_cell_selected_move_index = [row_index, col_index];

            $("#jfgrid-cell-selected-move").css({ "left": col_pre, "width": col - col_pre - 1, "top": row_pre, "height": row - row_pre - 1, "display": "block" });

            event.stopPropagation();
        });

        //选区下拉
        var jfgrid_cell_selected_extend = false, jfgrid_cell_selected_extend_index = [], jfgrid_cell_selected_extend_time = null;
        $("#jfgrid-cell-main div.jfgrid-cs-fillhandle").mousedown(function (event) {
            if(jfgrid.isEditMode()){//此模式下禁用选区下拉
                return;
            }

            $("#jfgrid-cell-selected").find(".jfgrid-cs-fillhandle").css("cursor","crosshair").end().find(".jfgrid-cs-draghandle").css("cursor","crosshair");
            $("#jfgrid-cell-main, #jfgridTableContent, #jfgrid-sheettable_0").css("cursor","crosshair");

            jfgrid_cell_selected_extend_time = setTimeout(function () {
                jfgrid_cell_selected_extend = true;
                jfgird_scroll_status = true;

                var mouse = mouseposition(event.pageX, event.pageY);
                var x = mouse[0] + $("#jfgrid-cell-main").scrollLeft() - 5;
                var y = mouse[1] + $("#jfgrid-cell-main").scrollTop() - 5;

                var rowLocation = jfgrid.rowLocation(y), row_pre = rowLocation[0], row = rowLocation[1], row_index = rowLocation[2];
                var colLocation = jfgrid.colLocation(x), col_pre = colLocation[0], col = colLocation[1], col_index = colLocation[2];

                jfgrid_cell_selected_extend_index = [row_index, col_index];

                $("#jfgrid-cell-selected-extend").css({ "left": col_pre, "width": col - col_pre - 1, "top": row_pre, "height": row - row_pre - 1, "display": "block" });
            }, 100);

            event.stopPropagation();
        }).click(function () {
            clearTimeout(jfgrid_cell_selected_extend_time);
            event.stopPropagation();
        }).dblclick(function () {
            var last = jfgird_select_save[0];

            var r0 = last.row[0], 
                r1 = last.row[1], 
                c0 = last.column[0], 
                c1 = last.column[1];

            if(jfgrid.pivotTable.isPivotRange(r0, c0)){
                return;
            }

            var dropCellState = false;
            var step = 0;

            for(var r = r1 + 1; r < jfgrid.flowdata.length; r++){
                if(c0 - 1 >= 0 && c1 + 1 < jfgrid.flowdata[0].length){
                    var cell1 = jfgrid.flowdata[r][c0 - 1];
                    var cell2 = jfgrid.flowdata[r][c1 + 1];

                    if(r == r1 + 1){
                        if((cell1 == null || jfgrid.func_methods.isRealNull(cell1.v)) && (cell2 == null || jfgrid.func_methods.isRealNull(cell2.v))){
                            dropCellState = false;
                            break;
                        }
                        else{
                            dropCellState = true;
                            step++;
                        }
                    }
                    else{
                        if((cell1 == null || jfgrid.func_methods.isRealNull(cell1.v)) && (cell2 == null || jfgrid.func_methods.isRealNull(cell2.v))){
                            break;
                        }

                        step++;
                    }
                }
                else if(c0 - 1 >= 0){
                    var cell = jfgrid.flowdata[r][c0 - 1];

                    if(r == r1 + 1){
                        if(cell == null || jfgrid.func_methods.isRealNull(cell.v)){
                            dropCellState = false;
                            break;
                        }
                        else{
                            dropCellState = true;
                            step++;
                        }
                    }
                    else{
                        if(cell == null || jfgrid.func_methods.isRealNull(cell.v)){
                            break;
                        }

                        step++;
                    }
                }
                else if(c1 + 1 < jfgrid.flowdata[0].length){
                    var cell = jfgrid.flowdata[r][c1 + 1];

                    if(r == r1 + 1){
                        if(cell == null || jfgrid.func_methods.isRealNull(cell.v)){
                            dropCellState = false;
                            break;
                        }
                        else{
                            dropCellState = true;
                            step++;
                        }
                    }
                    else{
                        if(cell == null || jfgrid.func_methods.isRealNull(cell.v)){
                            break;
                        }

                        step++;
                    }
                }
            }

            if(!dropCellState || step == 0){
                event.stopPropagation();
                return;
            }

            //复制范围
            jfgrid.dropCell.copyRange = { "row": [r0, r1], "column": [c0, c1] };

            //applyType
            var typeItemHide = jfgrid.dropCell.typeItemHide();

            if(!typeItemHide[0] && !typeItemHide[1] && !typeItemHide[2] && !typeItemHide[3] && !typeItemHide[4] && !typeItemHide[5] && !typeItemHide[6]){
                jfgrid.dropCell.applyType = "0";
            }
            else{
                jfgrid.dropCell.applyType = "1";
            }

            jfgrid.dropCell.applyRange = { "row": [r1 + 1, r1 + step], "column": [c0, c1] };
            jfgrid.dropCell.direction = "down";

            jfgird_select_save = [{ "row": [r0, r1 + step], "column": [c0, c1] }];

            jfgrid.dropCell.update();
            jfgrid.dropCell.createIcon();

            $("#jfgrid-cell-selected-move").hide();

            $("#jfgrid-sheettable").css("cursor", "default");
            clearTimeout(jfcountfuncTimeout);
            jfcountfuncTimeout = setTimeout(function () { jfcountfunc() }, 500);

            event.stopPropagation();
        });

        $("#jfgrid-cell-main, #jfgridTableContent").mousedown(function (event) {
            $("#jfgrid-cell-selected").find(".jfgrid-cs-fillhandle").css("cursor","default").end().find(".jfgrid-cs-draghandle").css("cursor","default");
            $("#jfgrid-cell-main, #jfgridTableContent, #jfgrid-sheettable_0").css("cursor","default");

            //有批注在编辑时
            jfgrid.postil.removeActivePs();

            //jfgridautoadjustmousedown = 1;
            var mouse = mouseposition(event.pageX, event.pageY);
            if (mouse[0] >= cellmainWidth - cellMainSrollBarSize || mouse[1] >= cellmainHeight - cellMainSrollBarSize) {
                return;
            }

            var x = mouse[0] + $("#jfgrid-cell-main").scrollLeft();
            var y = mouse[1] + $("#jfgrid-cell-main").scrollTop();

            if(jfgrid.freezen.freezenverticaldata != null && mouse[0] < (jfgrid.freezen.freezenverticaldata[0] - jfgrid.freezen.freezenverticaldata[2])){
                x = mouse[0] + jfgrid.freezen.freezenverticaldata[2];
            }

            if(jfgrid.freezen.freezenhorizontaldata != null && mouse[1] < (jfgrid.freezen.freezenhorizontaldata[0] - jfgrid.freezen.freezenhorizontaldata[2])){
                y = mouse[1] + jfgrid.freezen.freezenhorizontaldata[2];
            }

            var rowLocation = jfgrid.rowLocation(y), 
                row = rowLocation[1], 
                row_pre = rowLocation[0], 
                row_index = rowLocation[2];
            
            var colLocation = jfgrid.colLocation(x), 
                col = colLocation[1], 
                col_pre = colLocation[0], 
                col_index = colLocation[2];

            var row_index_ed = row_index, col_index_ed = col_index;
            var margeset = jfgrid.menuButton.mergeborer(jfgrid.flowdata, row_index, col_index);
            if(!!margeset){
                row = margeset.row[1];
                row_pre = margeset.row[0];
                row_index = margeset.row[2];
                row_index_ed = margeset.row[3];

                col = margeset.column[1];
                col_pre = margeset.column[0];
                col_index = margeset.column[2];
                col_index_ed = margeset.column[3];
            }

            //mousedown是右键
            if (event.which == "3") {
                var isright = false;

                for(var s = 0; s < jfgird_select_save.length; s++){
                    if (jfgird_select_save[s]["row"] != null && (row_index >= jfgird_select_save[s]["row"][0] && row_index <= jfgird_select_save[s]["row"][1] && col_index >= jfgird_select_save[s]["column"][0] && col_index <= jfgird_select_save[s]["column"][1])) {
                        isright = true;
                        break;
                    }    
                }

                if(isright){
                    return;
                }
            }

            //单元格数据下钻
            if(jfgrid.flowdata[row_index] != null && jfgrid.flowdata[row_index][col_index] != null && jfgrid.flowdata[row_index][col_index].dd != null){
                if(jfgridConfigsetting.fireMousedown != null && jfgrid.getObjType(jfgridConfigsetting.fireMousedown) == "function"){
                    jfgridConfigsetting.fireMousedown(jfgrid.flowdata[row_index][col_index].dd);
                    return;
                }
            }

            jfgird_scroll_status = true;

            //公式相关
            var $input = $("#jfgrid-input-box");
            if (parseInt($input.css("top")) > 0) {
                if (jfgrid.formula.rangestart || jfgrid.formula.rangedrag_column_start || jfgrid.formula.rangedrag_row_start || jfgrid.formula.israngeseleciton()) {
                    //公式选区
                    var rowseleted = [row_index, row_index_ed];
                    var columnseleted = [col_index, col_index_ed];

                    var left = col_pre;
                    var width = col - col_pre - 1;
                    var top = row_pre;
                    var height = row - row_pre - 1;

                    if(event.shiftKey){
                        var last = jfgrid.formula.func_selectedrange;

                        var top = 0, height = 0, rowseleted = [];
                        if (last.top > row_pre) {
                            top = row_pre;
                            height = last.top + last.height - row_pre;

                            if(last.row[1] > last.row_focus){
                                last.row[1] = last.row_focus;
                            }

                            rowseleted = [row_index, last.row[1]];
                        }
                        else if (last.top == row_pre) {
                            top = row_pre;
                            height = last.top + last.height - row_pre;
                            rowseleted = [row_index, last.row[0]];
                        }
                        else {
                            top = last.top;
                            height = row - last.top - 1;

                            if(last.row[0] < last.row_focus){
                                last.row[0] = last.row_focus;
                            }

                            rowseleted = [last.row[0], row_index];
                        }

                        var left = 0, width = 0, columnseleted = [];
                        if (last.left > col_pre) {
                            left = col_pre;
                            width = last.left + last.width - col_pre;

                            if(last.column[1] > last.column_focus){
                                last.column[1] = last.column_focus;
                            }

                            columnseleted = [col_index, last.column[1]];
                        }
                        else if (last.left == col_pre) {
                            left = col_pre;
                            width = last.left + last.width - col_pre;
                            columnseleted = [col_index, last.column[0]];
                        }
                        else {
                            left = last.left;
                            width = col - last.left - 1;

                            if(last.column[0] < last.column_focus){
                                last.column[0] = last.column_focus;
                            }

                            columnseleted = [last.column[0], col_index];
                        }

                        var changeparam = jfgrid.menuButton.mergeMoveMain(columnseleted, rowseleted, last, top, height, left, width);
                        if(changeparam != null){
                            columnseleted = changeparam[0];
                            rowseleted= changeparam[1];
                            top = changeparam[2];
                            height = changeparam[3];
                            left = changeparam[4];
                            width = changeparam[5];
                        }

                        jfgrid.jfgrid_count_show(left, top, width, height, rowseleted, columnseleted);

                        last["row"] = rowseleted;
                        last["column"] = columnseleted;

                        last["left_move"] = left;
                        last["width_move"] = width;
                        last["top_move"] = top;
                        last["height_move"] = height;

                        jfgrid.formula.func_selectedrange = last;
                    }
                    else if(event.ctrlKey && $("#jfgrid-rich-text-editor").find("span").last().text() != ","){
                        //按住ctrl 选择选区时  先处理上一个选区
                        var vText = $("#jfgrid-rich-text-editor").text() + ",";
                        if(vText.length > 0 && vText.substr(0, 1) == "="){
                            vText = jfgrid.formula.functionHTMLGenerate(vText);

                            if (window.getSelection) { // all browsers, except IE before version 9
                                var currSelection = window.getSelection();
                                jfgrid.formula.functionRangeIndex = [$(currSelection.anchorNode).parent().index(), currSelection.anchorOffset];
                            } 
                            else { // Internet Explorer before version 9
                                var textRange = document.selection.createRange();
                                jfgrid.formula.functionRangeIndex = textRange;
                            }

                            $("#jfgrid-rich-text-editor").html(vText);

                            jfgrid.formula.canceFunctionrangeSelected();
                            jfgrid.formula.createRangeHightlight();
                        }

                        jfgrid.formula.rangestart = false;
                        jfgrid.formula.rangedrag_column_start = false;
                        jfgrid.formula.rangedrag_row_start = false;

                        $("#jfgrid-functionbox-cell").html(vText);
                        jfgrid.formula.rangeHightlightselected($("#jfgrid-rich-text-editor"));

                        //再进行 选区的选择
                        jfgrid.formula.israngeseleciton();
                        jfgrid.formula.func_selectedrange = {
                            "left": left, 
                            "width": width, 
                            "top": top, 
                            "height": height, 
                            "left_move": left, 
                            "width_move": width, 
                            "top_move": top, 
                            "height_move": height, 
                            "row": rowseleted, 
                            "column": columnseleted, 
                            "row_focus": row_index, 
                            "column_focus": col_index 
                        };
                    }
                    else{
                        jfgrid.formula.func_selectedrange = {
                            "left": left, 
                            "width": width, 
                            "top": top, 
                            "height": height, 
                            "left_move": left, 
                            "width_move": width, 
                            "top_move": top, 
                            "height_move": height, 
                            "row": rowseleted, 
                            "column": columnseleted, 
                            "row_focus": row_index, 
                            "column_focus": col_index 
                        };
                    }

                    jfgrid.formula.rangeSetValue({ "row": rowseleted, "column": columnseleted });

                    jfgrid.formula.rangestart = true;
                    jfgrid.formula.rangedrag_column_start = false;
                    jfgrid.formula.rangedrag_row_start = false;

                    $("#jfgrid-formula-functionrange-select").css({ "left": left, "width": width, "top": top, "height": height }).show();
                    $("#jfgrid-formula-help-c").hide();
                    jfgrid.jfgrid_count_show(left, top, width, height, rowseleted, columnseleted);

                    setTimeout(function(){
                        var currSelection = window.getSelection();
                        var anchorOffset = currSelection.anchorNode;
                        if($("#jfgrid-search-formula-parm").is(":visible")||$("#jfgrid-search-formula-parm-select").is(":visible")){
                            $editor=$("#jfgrid-rich-text-editor");
                            jfgrid.formula.rangechangeindex = jfgrid.formula.data_parm_index;
                        }
                        else{
                            $editor = $(anchorOffset).closest("div");
                        }
                        var $span = $editor.find("span[rangeindex='" + jfgrid.formula.rangechangeindex + "']");

                        jfgrid.formula.setCaretPosition($span.get(0), 0, $span.html().length);
                    }, 1);
                    
                    return;
                }
                else {
                    jfgrid.formula.updatecell(jfgridCellUpdate[0], jfgridCellUpdate[1]);
                    jfgird_select_status = true;

                    if($("#jfgrid-info").is(":visible")){
                        jfgird_select_status = false;
                    }
                }
            }
            else {
                jfgird_select_status = true;
            }

            //条件格式 应用范围可选择多个单元格
            if($("#jfgrid-multiRange-dialog").is(":visible")){
                jfgrid.conditionformat.selectStatus = true;
                jfgird_select_status = false;

                if(event.shiftKey){
                    var last = jfgrid.conditionformat.selectRange[jfgrid.conditionformat.selectRange.length - 1];

                    var top = 0, height = 0, rowseleted = [];
                    if (last.top > row_pre) {
                        top = row_pre;
                        height = last.top + last.height - row_pre;

                        if(last.row[1] > last.row_focus){
                            last.row[1] = last.row_focus;
                        }

                        rowseleted = [row_index, last.row[1]];
                    }
                    else if (last.top == row_pre) {
                        top = row_pre;
                        height = last.top + last.height - row_pre;
                        rowseleted = [row_index, last.row[0]];
                    }
                    else {
                        top = last.top;
                        height = row - last.top - 1;

                        if(last.row[0] < last.row_focus){
                            last.row[0] = last.row_focus;
                        }

                        rowseleted = [last.row[0], row_index];
                    }

                    var left = 0, width = 0, columnseleted = [];
                    if (last.left > col_pre) {
                        left = col_pre;
                        width = last.left + last.width - col_pre;

                        if(last.column[1] > last.column_focus){
                            last.column[1] = last.column_focus;
                        }

                        columnseleted = [col_index, last.column[1]];
                    }
                    else if (last.left == col_pre) {
                        left = col_pre;
                        width = last.left + last.width - col_pre;
                        columnseleted = [col_index, last.column[0]];
                    }
                    else {
                        left = last.left;
                        width = col - last.left - 1;

                        if(last.column[0] < last.column_focus){
                            last.column[0] = last.column_focus;
                        }

                        columnseleted = [last.column[0], col_index];
                    }

                    var changeparam = jfgrid.menuButton.mergeMoveMain(columnseleted, rowseleted, last, top, height, left, width);
                    if(changeparam != null){
                        columnseleted = changeparam[0];
                        rowseleted= changeparam[1];
                        top = changeparam[2];
                        height = changeparam[3];
                        left = changeparam[4];
                        width = changeparam[5];
                    }

                    last["row"] = rowseleted;
                    last["column"] = columnseleted;

                    last["left_move"] = left;
                    last["width_move"] = width;
                    last["top_move"] = top;
                    last["height_move"] = height;

                    jfgrid.conditionformat.selectRange[jfgrid.conditionformat.selectRange.length - 1] = last;
                }
                else if(event.ctrlKey){
                    jfgrid.conditionformat.selectRange.push({ 
                        "left": col_pre, 
                        "width": col - col_pre - 1, 
                        "top": row_pre, 
                        "height": row - row_pre - 1, 
                        "left_move": col_pre, 
                        "width_move": col - col_pre - 1, 
                        "top_move": row_pre, 
                        "height_move": row - row_pre - 1, 
                        "row": [row_index, row_index_ed], 
                        "column": [col_index, col_index_ed], 
                        "row_focus": row_index, 
                        "column_focus": col_index 
                    });
                }
                else{
                    jfgrid.conditionformat.selectRange = [];
                    jfgrid.conditionformat.selectRange.push({ 
                        "left": col_pre, 
                        "width": col - col_pre - 1, 
                        "top": row_pre, 
                        "height": row - row_pre - 1, 
                        "left_move": col_pre, 
                        "width_move": col - col_pre - 1, 
                        "top_move": row_pre, 
                        "height_move": row - row_pre - 1, 
                        "row": [row_index, row_index_ed], 
                        "column": [col_index, col_index_ed], 
                        "row_focus": row_index, 
                        "column_focus": col_index 
                    });
                }
                
                jfgrid.selectionCopyShow(jfgrid.conditionformat.selectRange);
                
                var range = jfgrid.conditionformat.getTxtByRange(jfgrid.conditionformat.selectRange);
                $("#jfgrid-multiRange-dialog input").val(range);
                
                return;
            }
            else{
                jfgrid.conditionformat.selectStatus = false;
                jfgrid.conditionformat.selectRange = [];
            }

            //条件格式 条件值只能选择单个单元格
            if($("#jfgrid-singleRange-dialog").is(":visible")){
                jfgird_select_status = false;

                jfgrid.selectionCopyShow([{"row": [row_index, row_index], "column": [col_index, col_index]}]);

                var range = jfgrid.sheetmanage.getRangetxt(jfgrid.currentSheetIndex, { "row": [row_index, row_index], "column": [col_index, col_index] }, jfgrid.currentSheetIndex);
                $("#jfgrid-singleRange-dialog input").val(range);

                return;
            }

            //if公式生成器
            if(jfgrid.ifFormulaGenerator.singleRangeFocus){
                $("#jfgrid-ifFormulaGenerator-dialog .singRange").click();
            }
            if($("#jfgrid-ifFormulaGenerator-singleRange-dialog").is(":visible")){
                //选择单个单元格
                jfgird_select_status = false;
                jfgrid.formula.rangestart = false;

                $("#jfgrid-formula-functionrange-select").css({ "left": col_pre, "width": col - col_pre - 1, "top": row_pre, "height": row - row_pre - 1 }).show();
                $("#jfgrid-formula-help-c").hide();

                var range = jfgrid.sheetmanage.getRangetxt(jfgrid.currentSheetIndex, { "row": [row_index, row_index], "column": [col_index, col_index] }, jfgrid.currentSheetIndex);
                $("#jfgrid-ifFormulaGenerator-singleRange-dialog input").val(range);

                return;
            }
            if($("#jfgrid-ifFormulaGenerator-multiRange-dialog").is(":visible")){
                //选择范围
                jfgird_select_status = false;
                jfgrid.formula.func_selectedrange = { "left": col_pre, "width": col - col_pre - 1, "top": row_pre, "height": row - row_pre - 1, "left_move": col_pre, "width_move": col - col_pre - 1, "top_move": row_pre, "height_move": row - row_pre - 1, "row": [row_index, row_index], "column": [col_index, col_index], "row_focus": row_index, "column_focus": col_index };
                jfgrid.formula.rangestart = true;

                $("#jfgrid-formula-functionrange-select").css({ "left": col_pre, "width": col - col_pre - 1, "top": row_pre, "height": row - row_pre - 1 }).show();
                $("#jfgrid-formula-help-c").hide();

                var range = jfgrid.sheetmanage.getRangetxt(jfgrid.currentSheetIndex, { "row": [row_index, row_index], "column": [col_index, col_index] }, jfgrid.currentSheetIndex);
                $("#jfgrid-ifFormulaGenerator-multiRange-dialog input").val(range);

                $("#jfgrid-row-count-show").hide();
                $("#jfgrid-column-count-show").hide();
                return;
            }

            if (jfgird_select_status) {
                if(event.shiftKey){
                    //按住shift点击，选择范围
                    var last = $.extend(true, {}, jfgird_select_save[jfgird_select_save.length - 1]); //选区最后一个

                    var top = 0, height = 0, rowseleted = [];
                    if (last.top > row_pre) {
                        top = row_pre;
                        height = last.top + last.height - row_pre;

                        if(last.row[1] > last.row_focus){
                            last.row[1] = last.row_focus;
                        }

                        rowseleted = [row_index, last.row[1]];
                    }
                    else if (last.top == row_pre) {
                        top = row_pre;
                        height = last.top + last.height - row_pre;
                        rowseleted = [row_index, last.row[0]];
                    }
                    else {
                        top = last.top;
                        height = row - last.top - 1;

                        if(last.row[0] < last.row_focus){
                            last.row[0] = last.row_focus;
                        }

                        rowseleted = [last.row[0], row_index];
                    }

                    var left = 0, width = 0, columnseleted = [];
                    if (last.left > col_pre) {
                        left = col_pre;
                        width = last.left + last.width - col_pre;

                        if(last.column[1] > last.column_focus){
                            last.column[1] = last.column_focus;
                        }

                        columnseleted = [col_index, last.column[1]];
                    }
                    else if (last.left == col_pre) {
                        left = col_pre;
                        width = last.left + last.width - col_pre;
                        columnseleted = [col_index, last.column[0]];
                    }
                    else {
                        left = last.left;
                        width = col - last.left - 1;

                        if(last.column[0] < last.column_focus){
                            last.column[0] = last.column_focus;
                        }

                        columnseleted = [last.column[0], col_index];
                    }

                    var changeparam = jfgrid.menuButton.mergeMoveMain(columnseleted, rowseleted, last, top, height, left, width);
                    if(changeparam != null){
                        columnseleted = changeparam[0];
                        rowseleted= changeparam[1];
                        top = changeparam[2];
                        height = changeparam[3];
                        left = changeparam[4];
                        width = changeparam[5];
                    }

                    last["row"] = rowseleted;
                    last["column"] = columnseleted;

                    last["left_move"] = left;
                    last["width_move"] = width;
                    last["top_move"] = top;
                    last["height_move"] = height;

                    jfgird_select_save[jfgird_select_save.length - 1] = last;

                    //交替颜色选择范围
                    if($("#jfgrid-alternateformat-rangeDialog").is(":visible")){
                        $("#jfgrid-alternateformat-rangeDialog input").val(jfgrid.sheetmanage.getRangetxt(jfgrid.currentSheetIndex, jfgird_select_save));
                    }

                    if (jfgrid.chartparam.jfgrid_chart_data_select_state) {
                        $("#jfgrid-datavisual-range-selection-input").val(jfgridfile[jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex)].name + "!" + jfgrid.jfgridchatatABC(jfgird_select_save[0]["column"][0]) + (jfgird_select_save[0]["row"][0] + 1) + ":" + jfgrid.jfgridchatatABC(jfgird_select_save[0]["column"][1]) + (jfgird_select_save[0]["row"][1] + 1));
                    }

                    if (jfgrid.pivotTable.jfgrid_pivotTable_select_state) {
                        $("#jfgrid-pivotTable-range-selection-input").val(jfgridfile[jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex)].name + "!" + jfgrid.jfgridchatatABC(jfgird_select_save[0]["column"][0]) + (jfgird_select_save[0]["row"][0] + 1) + ":" + jfgrid.jfgridchatatABC(jfgird_select_save[0]["column"][1]) + (jfgird_select_save[0]["row"][1] + 1));
                    }
                }
                else if(event.ctrlKey){
                    //选区添加
                    jfgird_select_save.push({ "left": col_pre, "width": col - col_pre - 1, "top": row_pre, "height": row - row_pre - 1, "left_move": col_pre, "width_move": col - col_pre - 1, "top_move": row_pre, "height_move": row - row_pre - 1, "row": [row_index, row_index_ed], "column": [col_index, col_index_ed], "row_focus": row_index, "column_focus": col_index });
                }
                else{
                    jfgird_select_save = [];
                    jfgird_select_save.push({ 
                        "left": col_pre, 
                        "width": col - col_pre - 1, 
                        "top": row_pre, 
                        "height": row - row_pre - 1, 
                        "left_move": col_pre, 
                        "width_move": col - col_pre - 1, 
                        "top_move": row_pre, 
                        "height_move": row - row_pre - 1, 
                        "row": [row_index, row_index_ed], 
                        "column": [col_index, col_index_ed], 
                        "row_focus": row_index, 
                        "column_focus": col_index 
                    });

                    //单元格格式icon对应
                    jfgrid.menuButton.menuButtonFocus(jfgrid.flowdata, row_index, col_index);
                    //函数公式显示栏
                    jfgrid.formula.fucntionboxshow(row_index, col_index);
                }

                jfgrid.selectHightlightShow();

                if(jfgrid.freezen.freezenhorizontaldata != null || jfgrid.freezen.freezenverticaldata != null){
                    jfgrid.freezen.scrollAdaptOfselect();    
                }

                jfgridactiveCell();

                if(jfgrid.server.allowUpdate){
                    //允许编辑后的后台更新时
                    jfgrid.server.saveParam("mv", jfgrid.currentSheetIndex, jfgird_select_save);
                }
            }

            clearTimeout(jfgrid.chartparam.jfgrid_chart_rangefocus_timeout);
            if (jfgrid.chartparam.jfgrid_chart_rangefocus) {
                jfgrid.chartparam.jfgrid_chart_rangefocus = false;
                $("#jfgrid-datavisual-range-button").click();
            }

            //交替颜色
            if(jfgrid.alternateformat.rangefocus){
                jfgrid.alternateformat.rangefocus = false;
                $("#jfgrid-alternateformat-range .fa-table").click();
            }

            $("#jfgrid-row-count-show, #jfgrid-column-count-show").hide();

            if(!jfgrid.isEditMode()){
                //chartMix 隐藏当前页的数据选择区域高亮
                !!window.store && store.commit("hideAllNeedRangeShow");  
            }
            
            $("#jfgrid-helpbox-cell").text(jfgrid.sheetmanage.getRangetxt(jfgrid.currentSheetIndex, jfgird_select_save[jfgird_select_save.length - 1]));

            //数据透视表
            jfgrid.pivotTable.pivotclick(row_index, col_index, jfgrid.currentSheetIndex);

            $("#" + container).attr("tabindex", 0).focus();

            //$("#jfgrid-cols-h-c .jfgrid-cols-h-cells-c .jfgrid-cols-h-cells-clip .jfgrid-cols-h-cell-sel").removeClass("jfgrid-cols-h-cell-sel").addClass("jfgrid-cols-h-cell-nosel");

            //$("#jfgrid-rows-h .jfgrid-rows-h-cells .jfgrid-rows-h-cells-c .jfgrid-rows-h-cells-clip .jfgrid-rows-h-cell-sel").removeClass("jfgrid-rows-h-cell-sel").addClass("jfgrid-rows-h-cell-nosel");


            //$("#jfgrid-cols-h-c .jfgrid-cols-h-cells-c .jfgrid-cols-h-cells-clip .jfgrid-cols-h-cell-nosel").eq(col_index).removeClass("jfgrid-cols-h-cell-nosel").addClass("jfgrid-cols-h-cell-sel");

            //$("#jfgrid-rows-h .jfgrid-rows-h-cells .jfgrid-rows-h-cells-c .jfgrid-rows-h-cells-clip .jfgrid-rows-h-cell-nosel").eq(row_index).removeClass("jfgrid-rows-h-cell-nosel").addClass("jfgrid-rows-h-cell-sel");

            //event.stopImmediatePropagation();

        }).mouseup(function (event) {
            if (event.which == "3") {
                if(jfgrid.isEditMode()){ //非编辑模式下禁止右键功能框
                    return;
                }

                var x = event.pageX;
                var y = event.pageY;
                var data = jfgrid.flowdata;

                var obj_s = jfgird_select_save[0];

                $("#jfgrid-cols-rows-data").show();
                $("#jfgrid-cols-rows-add, #jfgrid-cols-rows-shift").hide();

                if (obj_s["row"] != null && obj_s["row"][0] == 0 && obj_s["row"][1] == jfgrid.flowdata.length - 1) {
                    jfgridRightHeadClickIs = "column";
                    $("#jfgrid-rightclick-menu .jfgrid-cols-rows-shift-word").text("列");
                    $("#jfgrid-rightclick-menu .jfgrid-cols-rows-shift-size").text("宽");
                    $("#jfgrid-rightclick-menu .jfgrid-cols-rows-shift-left").text("左");
                    $("#jfgrid-rightclick-menu .jfgrid-cols-rows-shift-right").text("右");

                    $("#jfgrid-cols-rows-add").show();
                    $("#jfgrid-cols-rows-data").show();
                    $("#jfgrid-cols-rows-shift").hide();
                    
                    jfgrid_cols_menu_status = true;

                    //列宽默认值
                    var cfg = $.extend(true, {}, config);
                    if(cfg["columlen"] == null){
                        cfg["columlen"] = {};
                    }

                    var first_collen = cfg["columlen"][jfgird_select_save[0].column[0]] == null ? jfgrid.defaultcollen : cfg["columlen"][jfgird_select_save[0].column[0]];
                    var isSame = true;

                    for(var i = 0; i < jfgird_select_save.length; i++){
                        var s = jfgird_select_save[i];
                        var c1 = s.column[0], c2 = s.column[1];

                        for(var c = c1; c <= c2; c++){
                            var collen = cfg["columlen"][c] == null ? jfgrid.defaultcollen : cfg["columlen"][c];

                            if(collen != first_collen){
                                isSame = false;
                                break;
                            }
                        }
                    }

                    if(isSame){
                        $("#jfgrid-cols-rows-add").find("input[type='number'].rcsize").val(first_collen);
                    }
                    else{
                        $("#jfgrid-cols-rows-add").find("input[type='number'].rcsize").val("");
                    }
                }
                else if (obj_s["column"] != null && obj_s["column"][0] == 0 && obj_s["column"][1] == jfgrid.flowdata[0].length - 1) {
                    jfgridRightHeadClickIs = "row";
                    $("#jfgrid-rightclick-menu .jfgrid-cols-rows-shift-word").text("行");
                    $("#jfgrid-rightclick-menu .jfgrid-cols-rows-shift-size").text("高");
                    $("#jfgrid-rightclick-menu .jfgrid-cols-rows-shift-left").text("上");
                    $("#jfgrid-rightclick-menu .jfgrid-cols-rows-shift-right").text("下");
                    
                    $("#jfgrid-cols-rows-add").show();
                    $("#jfgrid-cols-rows-data").show();
                    $("#jfgrid-cols-rows-shift").hide();

                    jfgrid_cols_menu_status = true;

                    //行高默认值
                    var cfg = $.extend(true, {}, config);
                    if(cfg["rowlen"] == null){
                        cfg["rowlen"] = {};
                    }

                    var first_rowlen = cfg["rowlen"][jfgird_select_save[0].row[0]] == null ? jfgrid.defaultrowlen : cfg["rowlen"][jfgird_select_save[0].row[0]];
                    var isSame = true;

                    for(var i = 0; i < jfgird_select_save.length; i++){
                        var s = jfgird_select_save[i];
                        var r1 = s.row[0], r2 = s.row[1];

                        for(var r = r1; r <= r2; r++){
                            var rowlen = cfg["rowlen"][r] == null ? jfgrid.defaultrowlen : cfg["rowlen"][r];

                            if(rowlen != first_rowlen){
                                isSame = false;
                                break;
                            }
                        }
                    }

                    if(isSame){
                        $("#jfgrid-cols-rows-add").find("input[type='number'].rcsize").val(first_rowlen);
                    }
                    else{
                        $("#jfgrid-cols-rows-add").find("input[type='number'].rcsize").val("");
                    }
                }

                showrightclickmenu($("#jfgrid-rightclick-menu"), x, y);
            }
        }).dblclick(function (event) {
            if(parseInt($("#jfgrid-input-box").css("top")) > 0){
                return;
            }

            var mouse = mouseposition(event.pageX, event.pageY);
            if (mouse[0] >= cellmainWidth - cellMainSrollBarSize || mouse[1] >= cellmainHeight - cellMainSrollBarSize) {
                return;
            }

            var scrollLeft = $("#jfgrid-cell-main").scrollLeft(), scrollTop = $("#jfgrid-cell-main").scrollTop();
            var x = mouse[0] + scrollLeft;
            var y = mouse[1] + scrollTop;

            var rowLocation = jfgrid.rowLocation(y), row = rowLocation[1], row_pre = rowLocation[0], row_index = rowLocation[2];

            var colLocation = jfgrid.colLocation(x), col = colLocation[1], col_pre = colLocation[0], col_index = colLocation[2];

            //row_index = jfgrid.freezen.changeFreezenIndex(row_index, "h");
            //col_index = jfgrid.freezen.changeFreezenIndex(col_index, "v");

            if (jfgrid.pivotTable.isPivotRange(row_index, col_index)) {
                //数据透视表没有 任何数据
                if((jfgrid.pivotTable.filter == null || jfgrid.pivotTable.filter.length == 0) && (jfgrid.pivotTable.row == null || jfgrid.pivotTable.row.length == 0) && (jfgrid.pivotTable.column == null || jfgrid.pivotTable.column.length == 0) && (jfgrid.pivotTable.values == null || jfgrid.pivotTable.values.length == 0)){

                    return;
                }

                //数据透视表没有 数值数据
                if(jfgrid.pivotTable.values == null || jfgrid.pivotTable.values.length == 0){
                    return;
                }

                //点击位置不是 数值数据 所在区域
                if(row_index == 0 || col_index == 0){
                    return;
                }

                if(jfgrid.pivotTable.column != null && jfgrid.pivotTable.column.length > 0){
                    if(jfgrid.pivotTable.values.length >= 2 && jfgrid.pivotTable.showType == "column"){
                        if(row_index <= jfgrid.pivotTable.column.length || col_index >= jfgrid.pivotTable.pivotDatas[0].length - jfgrid.pivotTable.values.length){

                            return;
                        }
                    }
                    else{
                        if(row_index <= jfgrid.pivotTable.column.length - 1 || col_index >= jfgrid.pivotTable.pivotDatas[0].length - 1){

                            return;
                        }
                    }
                }

                if(jfgrid.pivotTable.row != null && jfgrid.pivotTable.row.length > 0){
                    if(jfgrid.pivotTable.values.length >= 2 && jfgrid.pivotTable.showType == "row"){
                        if(col_index <= jfgrid.pivotTable.row.length || row_index >= jfgrid.pivotTable.pivotDatas.length - jfgrid.pivotTable.values.length){

                            return;
                        }
                    }
                    else{
                        if(col_index <= jfgrid.pivotTable.row.length - 1 || row_index >= jfgrid.pivotTable.pivotDatas.length - 1){

                            return;
                        }
                    }
                }

                jfgrid.sheetmanage.addNewSheet(event);

                jfgrid.pivotTable.drillDown(row_index, col_index);
                
                return;
            }

            var margeset = jfgrid.menuButton.mergeborer(jfgrid.flowdata, row_index, col_index);
            if(!!margeset){
                row = margeset.row[1];
                row_pre = margeset.row[0];
                row_index = margeset.row[2];
                col = margeset.column[1];
                col_pre = margeset.column[0];
                col_index = margeset.column[2];
            }

            // $("#jfgrid-cell-selected").hide();

            if($("#jfgrid-search-formula-parm").is(":visible")||$("#jfgrid-search-formula-parm-select").is(":visible")){
                //公式参数栏显示
                $("#jfgrid-cell-selected").hide();
            }
            else if($("#jfgrid-conditionformat-dialog").is(":visible")||$("#jfgrid-administerRule-dialog").is(":visible")||$("#jfgrid-newConditionRule-dialog").is(":visible")||$("#jfgrid-editorConditionRule-dialog").is(":visible")||$("#jfgrid-singleRange-dialog").is(":visible")||$("#jfgrid-multiRange-dialog").is(":visible")){
                //条件格式
                return;
            }
            else if($("#jfgrid-modal-dialog-slider-alternateformat").is(":visible") || $("#jfgrid-alternateformat-rangeDialog").is(":visible")){
                //交替颜色
                return;
            }
            else{
                if(jfgrid.menuButton.jfgridPaintModelOn){
                    jfgrid.menuButton.cancelPaintModel();
                }
                
                jfgrid.jfgridupdateCell(row, row_pre, row_index, col, col_pre, col_index, jfgrid.flowdata);
            }

            //jfgridCellUpdate = [row_index, col_index];
            //$("#jfgrid-rich-text-editor").focus().select();
            //$("#jfgrid-input-box").css({ "background-color": "rgb(255, 255, 255)", "padding": "0px 2px", "font-size": "13px", "max-width": winW - col_pre - 20 + scrollLeft, "max-height": winH - row_index - 20 + scrollTop, "min-width": col - col_pre + 1 - 8, "min-height": row - row_pre + 1 - 4, "left": left - 2, "top": top - 2, "right": "auto" }).show();
            //$("#jfgrid-rich-text-editor").text(d[row_index][col_index]);
            //jfgridRangeLast($("#jfgrid-rich-text-editor")[0]);
        });

        $("#jfgrid-bottom-add-row, #jfgrid-bottom-add-row-input, #jfgrid-bottom-return-top").on("mousedown dblclick mouseup",function(e){
            e.stopPropagation();
        });

        $("#jfgrid-bottom-add-row").on("click",function(e){
            $("#jfgrid-rightclick-menu").hide();
            $("#" + container).attr("tabindex", 0).focus();

            var $t = $(this), value = $("#jfgrid-bottom-add-row-input").val();
            
            if(value == ""){
                value = 100;
            }

            if (isNaN(parseInt(value))) {
                if(jfgrid.isEditMode()){
                    alert("请输入数字");
                }
                else{
                    jfgrid.tooltip.info("增加错误", "请输入数字");
                }
                return;
            }

            value = parseInt(value);
            if (value < 1 || value > 100) {
                if(jfgrid.isEditMode()){
                    alert("增加范围限制在1-100");
                }
                else{
                    jfgrid.tooltip.info("增加错误", "增加范围限制在1-100");
                }
                return;
            }

            //var st_index = jfgird_select_save[jfgridRightHeadClickIs][0];
            jfgridextendtable("row", jfgrid.flowdata.length - 1, value);
        });

        $("#jfgrid-bottom-return-top").on("click",function(e){
            $("#jfgrid-scrollbar-y").scrollTop(0);
        });

        var jfgridactiveCell = function () {
            if (!!fullscreenmode) {
                setTimeout(function () {
                    $("#jfgrid-rich-text-editor").focus().select();
                }, 50);
            }
        }

        jfgrid.jfgridactiveCell = jfgridactiveCell;

        jfgrid.jfgridupdateCell = function (row, row_pre, row_index, col, col_pre, col_index, d, cover, isnotfocus) {
            if(jfgrid.isEditMode()){//此模式下禁用单元格编辑
                return;
            }

            if($("#jfgrid-dropCell-icon").is(":visible")){
                $("#jfgrid-dropCell-icon").remove();
            }

            var winH = $(window).height(), winW = $(window).width();
            var container_offset = $("#" + container).offset();
            var scrollLeft = $("#jfgrid-cell-main").scrollLeft();
            var scrollTop = $("#jfgrid-cell-main").scrollTop();

            if(jfgridConfigsetting.pointEdit){
                var left = col_pre * jfgridConfigsetting.pointEditZoom + container_offset.left + rowHeaderWidth * jfgridConfigsetting.pointEditZoom - scrollLeft,
                    top = row_pre * jfgridConfigsetting.pointEditZoom + container_offset.top + (infobarHeight + toolbarHeight + calculatebarHeight + columeHeaderHeight) * jfgridConfigsetting.pointEditZoom - scrollTop;
            }
            else{
                var left = col_pre + container_offset.left + rowHeaderWidth - scrollLeft,
                    top = row_pre + container_offset.top + infobarHeight + toolbarHeight + calculatebarHeight + columeHeaderHeight - scrollTop;
            }

            if (jfgrid.pivotTable.isPivotRange(row_index, col_index)) {
                return;
            }

            jfgridCellUpdate = [row_index, col_index];
            if (!isnotfocus) {
                $("#jfgrid-rich-text-editor").focus().select();
            }

            if(jfgridConfigsetting.pointEdit){
                $("#jfgrid-input-box").removeAttr("style").css({ 
                    "background-color": "rgb(255, 255, 255)", 
                    "padding": "0px 2px", 
                    "font-size": "13px", 
                    "max-width": winW + scrollLeft - col_pre - 20 - rowHeaderWidth, 
                    "max-height": winH + scrollTop - row_pre - 20 - 15 - toolbarHeight - infobarHeight - calculatebarHeight - sheetBarHeight - statisticBarHeight, 
                    "min-width": col - col_pre + 1 - 8, 
                    "min-height": row - row_pre + 1 - 4, 
                    "left": left - 2 * jfgridConfigsetting.pointEditZoom, 
                    "top": top - 2 * jfgridConfigsetting.pointEditZoom, 
                    "right": "auto", 
                    "overflow-y": "auto",
                    "box-sizing": "initial",
                    "transform-origin": "0 0",
                    "transform": "scale("+ jfgridConfigsetting.pointEditZoom +")",
                    "z-index": 1000
                });
            }
            else{
                $("#jfgrid-input-box").removeAttr("style").css({ 
                    "background-color": "rgb(255, 255, 255)", 
                    "padding": "0px 2px", 
                    "font-size": "13px", 
                    "max-width": winW + scrollLeft - col_pre - 20 - rowHeaderWidth, 
                    "max-height": winH + scrollTop - row_pre - 20 - 15 - toolbarHeight - infobarHeight - calculatebarHeight - sheetBarHeight - statisticBarHeight, 
                    "min-width": col - col_pre + 1 - 8, 
                    "min-height": row - row_pre + 1 - 4, 
                    "left": left - 2, 
                    "top": top - 2, 
                    "right": "auto", 
                    "overflow-y": "auto",
                    "box-sizing": "initial"
                });
            }

            if(jfgrid.freezen.freezenverticaldata != null || jfgrid.freezen.freezenhorizontaldata != null){
                $("#jfgrid-input-box").css("z-index", 10002);
            }
            
            $("#jfgrid-input-box-index").html(jfgrid.jfgridchatatABC(col_index) + (row_index + 1)).hide();
            $("#jfgrid-wa-functionbox-cancel, #jfgrid-wa-functionbox-confirm").addClass("jfgrid-wa-calculate-active");
            var value = "";
            
            if (d[row_index] != null && d[row_index][col_index] != null) {
                var cell = d[row_index][col_index];
                if (!cover) {
                    if(cell.f!=null){
                        value = jfgrid.getcellvalue(row_index, col_index, d, "f");
                    }
                    else{
                        value = jfgrid.mask.valueShowEs(row_index, col_index, d);
                    }
                }
                
                var style = jfgrid.menuButton.getStyleByCell(d, row_index, col_index);
                style = $("#jfgrid-input-box").get(0).style.cssText + style;

                $("#jfgrid-input-box").get(0).style.cssText = style;
                if($("#jfgrid-input-box").get(0).style.backgroundColor == "rgba(0, 0, 0, 0)"){
                    $("#jfgrid-input-box").get(0).style.background = "rgb(255,255,255)";
                }
            }
            else{
                //交替颜色
                var af_compute = jfgrid.alternateformat.getComputeMap();
                var checksAF = jfgrid.alternateformat.checksAF(row_index, col_index, af_compute);

                //条件格式
                var cf_compute = jfgrid.conditionformat.getComputeMap();
                var checksCF = jfgrid.conditionformat.checksCF(row_index, col_index, cf_compute);

                if(checksCF != null && checksCF["cellColor"] != null){
                    $("#jfgrid-input-box").get(0).style.background = checksCF["cellColor"];
                }
                else if(checksAF != null){
                    $("#jfgrid-input-box").get(0).style.background = checksAF[1];
                }
            }
           
            if((value == null || value.toString() == "") && !cover){
                value = "<br/>";
            }

            $("#jfgrid-rich-text-editor").html(value);
            if (!isnotfocus) {
                jfgridRangeLast($("#jfgrid-rich-text-editor")[0]);
            }
            jfgrid.formula.rangetosheet = jfgrid.currentSheetIndex;
            jfgrid.formula.createRangeHightlight();
            jfgrid.formula.rangeResizeTo = $("#jfgrid-rich-text-editor");
            jfgrid.cleargridelement();
        }

        $("#jfgrid-input-box").click(function () {
            jfgrid.formula.rangeHightlightselected($("#jfgrid-rich-text-editor"));
        }).add("#" + container).on("keydown", function (event) {
            if ($("#jfgrid-modal-dialog-mask").is(":visible") || $(event.target).hasClass("jfgrid-mousedown-cancel") || $(event.target).hasClass("formulaInputFocus")) {
                return;
            }

            var ctrlKey = event.ctrlKey;
            var altKey = event.altKey;
            var shiftKey = event.shiftKey;
            var kcode = event.keyCode;
            if ($("#jfgrid-modal-dialog-mask").is(":visible") || $(event.target).hasClass("jfgrid-mousedown-cancel") || $(event.target).hasClass("sp-input") || (parseInt($("#jfgrid-input-box").css("top")) > 0 && $(event.target).closest(".jfgrid-input-box").length > 0 && kcode != keycode.ENTER && kcode != keycode.TAB && kcode != keycode.UP && kcode != keycode.DOWN && kcode != keycode.LEFT && kcode != keycode.RIGHT)) {
                var anchor = $(window.getSelection().anchorNode);

                if(anchor.parent().is("#jfgrid-helpbox-cell") || anchor.is("#jfgrid-helpbox-cell")){
                    if(kcode == keycode.ENTER){
                        var helpboxValue = $("#jfgrid-helpbox-cell").text();
                        if(jfgrid.formula.iscelldata(helpboxValue)){
                            var cellrange = jfgrid.formula.getcellrange(helpboxValue);
                            
                            jfgird_select_save = [{ "row": cellrange["row"], "column": cellrange["column"], "row_focus": cellrange["row"][0], "column_focus": cellrange["column"][0] }];
                            jfgrid.selectHightlightShow();
                            
                            $("#jfgrid-helpbox-cell").blur();

                            var scrollLeft = $("#jfgrid-cell-main").scrollLeft(), scrollTop = $("#jfgrid-cell-main").scrollTop();
                            var winH = $("#jfgrid-cell-main").height(), winW = $("#jfgrid-cell-main").width();

                            var row = visibledatarow[cellrange["row"][1]], row_pre = cellrange["row"][0] - 1 == -1 ? 0 : visibledatarow[cellrange["row"][0] - 1];
                            var col = visibledatacolumn[cellrange["column"][1]], col_pre = cellrange["column"][0] - 1 == -1 ? 0 : visibledatacolumn[cellrange["column"][0] - 1];

                            if (col - scrollLeft - winW + 20 > 0) {
                                $("#jfgrid-scrollbar-x").scrollLeft(col - winW + 20);
                            }
                            else if (col_pre - scrollLeft - 20 < 0) {
                                $("#jfgrid-scrollbar-x").scrollLeft(col_pre - 20);
                            }

                            if (row - scrollTop - winH + 20 > 0) {
                                $("#jfgrid-scrollbar-y").scrollTop(row - winH + 20);
                            }
                            else if (row_pre - scrollTop - 20 < 0) {
                                $("#jfgrid-scrollbar-y").scrollTop(row_pre - 20);
                            }
                        }
                    }
                }

                return;
            }
            
            var $inputbox = $("#jfgrid-input-box");
            if (kcode == keycode.ENTER && parseInt($inputbox.css("top")) > 0) {
                if ($("#jfgrid-formula-search-c").is(":visible") && jfgrid.formula.searchFunctionCell != null) {
                    jfgrid.formula.searchFunctionEnter($("#jfgrid-formula-search-c").find(".jfgrid-formula-search-item-active"));
                }
                else {
                    jfgrid.formula.updatecell(jfgridCellUpdate[0], jfgridCellUpdate[1]);
                    jfgird_select_save = [{ "row": [jfgridCellUpdate[0], jfgridCellUpdate[0]], "column": [jfgridCellUpdate[1], jfgridCellUpdate[1]], "row_focus": jfgridCellUpdate[0], "column_focus": jfgridCellUpdate[1] }];
                    jfgridMoveHighlightCell("down", 1, "rangeOfSelect");
                    //$("#jfgrid-input-box").blur();
                }

                //若有参数弹出框，隐藏
                if($("#jfgrid-search-formula-parm").is(":visible")){
                    $("#jfgrid-search-formula-parm").hide();
                }
                //若有参数选取范围弹出框，隐藏
                if($("#jfgrid-search-formula-parm-select").is(":visible")){
                    $("#jfgrid-search-formula-parm-select").hide();
                }
                event.preventDefault();
            }
            else if (kcode == keycode.TAB) {
                if (parseInt($inputbox.css("top")) > 0) {
                    return;
                }

                // jfgrid.formula.updatecell(jfgridCellUpdate[0], jfgridCellUpdate[1]);
                jfgridMoveHighlightCell("right", 1, "rangeOfSelect");
                event.preventDefault();
            }
            else if(kcode == keycode.F2){
                if (parseInt($inputbox.css("top")) > 0) {
                    return;
                }

                var last = jfgird_select_save[jfgird_select_save.length - 1];

                var row_index = last["row_focus"], col_index = last["column_focus"];
                var row = visibledatarow[row_index], row_pre = row_index - 1 == -1 ? 0 : visibledatarow[row_index - 1];
                var col = visibledatacolumn[col_index], col_pre = col_index - 1 == -1 ? 0 : visibledatacolumn[col_index - 1];

                jfgrid.jfgridupdateCell(row, row_pre, row_index, col, col_pre, col_index, jfgrid.flowdata);
                event.preventDefault();
            }
            else if (kcode == keycode.F4 && parseInt($inputbox.css("top")) > 0) {
                jfgrid.formula.setfreezonFuc(event);
                event.preventDefault();
            }
            else if (kcode == keycode.ESC && parseInt($inputbox.css("top")) > 0) {
                jfgrid.formula.dontupdate();
                jfgridMoveHighlightCell("down", 0, "rangeOfSelect");
                event.preventDefault();
            }
            else if (kcode == keycode.ENTER) {
                if($(event.target).hasClass("formulaInputFocus") || $("#jfgrid-conditionformat-dialog").is(":visible")){
                    return;
                }
                else if (String.fromCharCode(kcode) != null && $("#jfgrid-cell-selected").is(":visible")) {
                    var last = jfgird_select_save[jfgird_select_save.length - 1];

                    var row_index = last["row_focus"], col_index = last["column_focus"];
                    var row = visibledatarow[row_index], row_pre = row_index - 1 == -1 ? 0 : visibledatarow[row_index - 1];
                    var col = visibledatacolumn[col_index], col_pre = col_index - 1 == -1 ? 0 : visibledatacolumn[col_index - 1];

                    var margeset = jfgrid.menuButton.mergeborer(jfgrid.flowdata, row_index, col_index);
                    if(!!margeset){
                        row = margeset.row[1];
                        row_pre = margeset.row[0];
                        row_index = margeset.row[2];
                        col = margeset.column[1];
                        col_pre = margeset.column[0];
                        col_index = margeset.column[2];
                    }

                    jfgrid.jfgridupdateCell(row, row_pre, row_index, col, col_pre, col_index, jfgrid.flowdata);
                    event.preventDefault();
                }
            }
            else {
                if (ctrlKey || event.metaKey) {
                    if (shiftKey) {
                        if (!jfgrid_shiftkeydown) {
                            jfgrid.jfgrid_shiftpositon = $.extend(true, {}, jfgird_select_save[jfgird_select_save.length - 1]);
                            jfgrid_shiftkeydown = true;
                        }

                        //Ctrl + shift + 方向键  调整选区
                        if (kcode == keycode.UP) {
                            if (parseInt($inputbox.css("top")) > 0 || $("#jfgrid-singleRange-dialog").is(":visible") || $("#jfgrid-multiRange-dialog").is(":visible")) {
                                return;
                            }

                            jfgridMoveHighlightRange2("up", "rangeOfSelect");
                        }
                        else if (kcode == keycode.DOWN) {
                            if (parseInt($inputbox.css("top")) > 0 || $("#jfgrid-singleRange-dialog").is(":visible") || $("#jfgrid-multiRange-dialog").is(":visible")) {
                                return;
                            }

                            jfgridMoveHighlightRange2("down", "rangeOfSelect");
                        }
                        else if (kcode == keycode.LEFT) {
                            if (parseInt($inputbox.css("top")) > 0 || $("#jfgrid-singleRange-dialog").is(":visible") || $("#jfgrid-multiRange-dialog").is(":visible")) {
                                return;
                            }

                            jfgridMoveHighlightRange2("left", "rangeOfSelect");
                        }
                        else if (kcode == keycode.RIGHT) {
                            if (parseInt($inputbox.css("top")) > 0 || $("#jfgrid-singleRange-dialog").is(":visible") || $("#jfgrid-multiRange-dialog").is(":visible")) {
                                return;
                            }

                            jfgridMoveHighlightRange2("right", "rangeOfSelect");
                        }
                    }
                    else if (kcode == 66) {//Ctrl + B  加粗
                        $("#jfgrid-icon-bold").click();
                    }
                    else if (kcode == 67) {//Ctrl + C  复制
                        //复制时存在格式刷状态，取消格式刷
                        if(jfgrid.menuButton.jfgridPaintModelOn){
                            jfgrid.menuButton.cancelPaintModel();
                        }
                        
                        if(jfgird_select_save.length == 0){
                            return;
                        }

                        //复制范围内包含部分合并单元格，提示
                        if(config["merge"] != null){
                            var hasPartMC = false;

                            for(var s = 0; s < jfgird_select_save.length; s++){
                                var r1 = jfgird_select_save[s].row[0], r2 = jfgird_select_save[s].row[1];
                                var c1 = jfgird_select_save[s].column[0], c2 = jfgird_select_save[s].column[1];

                                hasPartMC = jfgrid.hasPartMC(config, r1, r2, c1, c2);

                                if(hasPartMC){
                                    break;
                                }
                            }

                            if(hasPartMC){
                                if(jfgrid.isEditMode()){
                                    alert("无法对部分合并单元格执行此操作");
                                }
                                else{
                                    jfgrid.tooltip.info("无法对部分合并单元格执行此操作", ""); 
                                }
                                return;    
                            }
                        }

                        //多重选区 有条件格式时 提示
                        var cdformat = jfgridfile[jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex)].jfgrid_conditionformat_save;
                        if(jfgird_select_save.length > 1 && cdformat != null && cdformat.length > 0){
                            var hasCF = false;

                            var cf_compute = jfgrid.conditionformat.getComputeMap();

                            label:
                            for(var s = 0; s < jfgird_select_save.length; s++){
                                if(hasCF){
                                    break;
                                }
                                
                                var r1 = jfgird_select_save[s].row[0], r2 = jfgird_select_save[s].row[1];
                                var c1 = jfgird_select_save[s].column[0], c2 = jfgird_select_save[s].column[1];

                                for(var r = r1; r <= r2; r++){
                                    for(var c = c1; c <= c2; c++){
                                        if(jfgrid.conditionformat.checksCF(r, c, cf_compute) != null){
                                            hasCF = true;
                                            continue label;
                                        }
                                    }
                                }
                            }

                            if(hasCF){
                                if(jfgrid.isEditMode()){
                                    alert("无法对多重选择区域执行此操作");
                                }
                                else{
                                    jfgrid.tooltip.info("无法对多重选择区域执行此操作", "");
                                }
                                return;
                            }
                        }

                        //多重选区 行不一样且列不一样时 提示
                        if(jfgird_select_save.length > 1){ 
                            var isSameRow = true, str_r = jfgird_select_save[0].row[0], end_r = jfgird_select_save[0].row[1];
                            var isSameCol = true, str_c = jfgird_select_save[0].column[0], end_c = jfgird_select_save[0].column[1];
                            
                            for(var s = 1; s < jfgird_select_save.length; s++){
                                if(jfgird_select_save[s].row[0] != str_r || jfgird_select_save[s].row[1] != end_r){
                                    isSameRow = false;
                                }
                                if(jfgird_select_save[s].column[0] != str_c || jfgird_select_save[s].column[1] != end_c){
                                    isSameCol = false;
                                }
                            }

                            if((!isSameRow && !isSameCol) || jfgrid.selectIsOverlap()){
                                if(jfgrid.isEditMode()){
                                    alert("无法对多重选择区域执行此操作");
                                }
                                else{
                                    jfgrid.tooltip.info("无法对多重选择区域执行此操作", ""); 
                                }
                                return;
                            }    
                        }

                        jfgrid.selection.copy(event);

                        jfgrid_paste_iscut = false;
                        jfgridactiveCell();

                        event.stopPropagation();
                        return;
                    }
                    else if (kcode == 70) {//Ctrl + F  查找
                        jfgrid.searchReplace.createDialog(0);
                        jfgrid.searchReplace.init();

                        $("#jfgrid-search-replace #searchInput input").focus();
                    }
                    else if (kcode == 72) {//Ctrl + H  替换
                        jfgrid.searchReplace.createDialog(1);
                        jfgrid.searchReplace.init();

                        $("#jfgrid-search-replace #searchInput input").focus();
                    }
                    else if (kcode == 73) {//Ctrl + I  斜体
                        $("#jfgrid-icon-italic").click();
                    }
                    else if (kcode == 86) {//Ctrl + V  粘贴
                        if(jfgrid.isEditMode()){//此模式下禁用粘贴
                            return;
                        }

                        if($(event.target).hasClass("formulaInputFocus")){
                            return;
                        }

                        if(jfgird_select_save.length > 1){
                            if(jfgrid.isEditMode()){
                                alert("无法在此处粘贴此内容，请选择粘贴区域的一个单元格，然后再次尝试粘贴");
                            }
                            else{
                                jfgrid.tooltip.info("无法在此处粘贴此内容，请选择粘贴区域的一个单元格，然后再次尝试粘贴", "");
                            }
                            return;
                        }

                        jfgrid.selection.isPasteAction = true;
                        jfgridactiveCell();

                        event.stopPropagation();
                        return;
                    }
                    else if (kcode == 88) {//Ctrl + X  剪切
                        //复制时存在格式刷状态，取消格式刷
                        if(jfgrid.menuButton.jfgridPaintModelOn){
                            jfgrid.menuButton.cancelPaintModel();
                        }

                        if(jfgird_select_save.length == 0){
                            return;
                        }

                        //复制范围内包含部分合并单元格，提示
                        if(config["merge"] != null){
                            var hasPartMC = false;

                            for(var s = 0; s < jfgird_select_save.length; s++){
                                var r1 = jfgird_select_save[s].row[0], r2 = jfgird_select_save[s].row[1];
                                var c1 = jfgird_select_save[s].column[0], c2 = jfgird_select_save[s].column[1];

                                hasPartMC = jfgrid.hasPartMC(config, r1, r2, c1, c2);

                                if(hasPartMC){
                                    break;
                                }
                            }

                            if(hasPartMC){
                                if(jfgrid.jfgridConfigsetting.editMode){
                                    alert("无法对合并单元格执行此操作");
                                }
                                else{
                                    jfgrid.tooltip.info("无法对合并单元格执行此操作", ""); 
                                }
                                return;    
                            }
                        }

                        //多重选区时 提示
                        if(jfgird_select_save.length > 1){
                            if(jfgrid.isEditMode()){
                                alert("不能对多重选择区域执行此操作，请选择单个区域，然后再试");
                            }
                            else{
                                jfgrid.tooltip.info("不能对多重选择区域执行此操作，请选择单个区域，然后再试", ""); 
                            }
                            return;
                        }

                        jfgrid.selection.copy(event);

                        jfgrid_paste_iscut = true;
                        jfgridactiveCell();
                        
                        event.stopPropagation();
                        return;
                    }
                    else if (kcode == 90) {//Ctrl + Z  撤销
                        jfgrid.controlHistory.redo(event);
                        jfgridactiveCell();
                        event.stopPropagation();
                        return;
                    }
                    else if (kcode == 89) {//Ctrl + Y  重做
                        jfgrid.controlHistory.undo(event);
                        jfgridactiveCell();
                        event.stopPropagation();
                        return;
                    }
                    else if (kcode == keycode.UP) {//Ctrl + up  调整单元格
                        if (parseInt($inputbox.css("top")) > 0 || $("#jfgrid-singleRange-dialog").is(":visible") || $("#jfgrid-multiRange-dialog").is(":visible")) {
                            return;
                        }

                        jfgridMoveHighlightCell2("up", "rangeOfSelect");
                    }
                    else if (kcode == keycode.DOWN) {//Ctrl + down  调整单元格
                        if (parseInt($inputbox.css("top")) > 0 || $("#jfgrid-singleRange-dialog").is(":visible") || $("#jfgrid-multiRange-dialog").is(":visible")) {
                            return;
                        }

                        jfgridMoveHighlightCell2("down", "rangeOfSelect");
                    }
                    else if (kcode == keycode.LEFT) {//Ctrl + top  调整单元格
                        if (parseInt($inputbox.css("top")) > 0 || $("#jfgrid-singleRange-dialog").is(":visible") || $("#jfgrid-multiRange-dialog").is(":visible")) {
                            return;
                        }

                        jfgridMoveHighlightCell2("left", "rangeOfSelect");
                    }
                    else if (kcode == keycode.RIGHT) {//Ctrl + right  调整单元格
                        if (parseInt($inputbox.css("top")) > 0 || $("#jfgrid-singleRange-dialog").is(":visible") || $("#jfgrid-multiRange-dialog").is(":visible")) {
                            return;
                        }

                        jfgridMoveHighlightCell2("right", "rangeOfSelect");
                    }
                    else if (String.fromCharCode(kcode).toLocaleUpperCase() == "A") {//Ctrl + A  全选
                        $("#jfgrid-left-top").trigger("mousedown");
                        $(document).trigger("mouseup");
                    }

                    event.preventDefault();
                    return;
                }
                else if (shiftKey && (kcode == keycode.UP || kcode == keycode.DOWN || kcode == keycode.LEFT || kcode == keycode.RIGHT || (altKey && (kcode == 53 || kcode == 101)))) {
                    if (parseInt($inputbox.css("top")) > 0 || $(event.target).hasClass("formulaInputFocus")) {
                        return;
                    }

                    if (!jfgrid_shiftkeydown) {
                        jfgrid.jfgrid_shiftpositon = $.extend(true, {}, jfgird_select_save[jfgird_select_save.length - 1]);
                        jfgrid_shiftkeydown = true;
                    }

                    //shift + 方向键 调整选区
                    if (kcode == keycode.UP) {
                        if($("#jfgrid-singleRange-dialog").is(":visible") || $("#jfgrid-multiRange-dialog").is(":visible")){
                            return;
                        } 

                        jfgridMoveHighlightRange("down", -1, "rangeOfSelect");
                    }
                    else if (kcode == keycode.DOWN) {
                        if($("#jfgrid-singleRange-dialog").is(":visible") || $("#jfgrid-multiRange-dialog").is(":visible")){
                            return;
                        }

                        jfgridMoveHighlightRange("down", 1, "rangeOfSelect");
                    }
                    else if (kcode == keycode.LEFT) {
                        if($("#jfgrid-singleRange-dialog").is(":visible") || $("#jfgrid-multiRange-dialog").is(":visible")){
                            return;
                        }

                        jfgridMoveHighlightRange("right", -1, "rangeOfSelect");
                    }
                    else if (kcode == keycode.RIGHT) {
                        if($("#jfgrid-singleRange-dialog").is(":visible") || $("#jfgrid-multiRange-dialog").is(":visible")){
                            return;
                        }
                        
                        jfgridMoveHighlightRange("right", 1, "rangeOfSelect");
                    }
                    else if (altKey && (kcode == 53 || kcode == 101)) {
                        //Alt + Shift + 5（删除线）
                        $("#jfgrid-icon-strikethrough").click();
                    }

                    event.preventDefault();
                }
                else if (kcode == keycode.ESC) {
                    if(jfgrid.menuButton.jfgridPaintModelOn){
                        jfgrid.menuButton.cancelPaintModel();
                    }
                    else{
                        jfgrid.cleargridelement(event);
                        event.preventDefault(); 
                    }

                    jfgrid.selectHightlightShow();
                }
                else if (kcode == keycode.DELETE) {
                    if (jfgrid.chartparam.jfgridCurrentChartActive && !jfgrid.isEditMode()) {
                        jfgrid.chartparam.jfgridCurrentChartMoveObj.find(".jfgrid-modal-controll-del").click();
                    }
                    else {
                        $("#jfgrid-delete-text").click();
                    }

                    event.preventDefault();
                }
                else if (kcode == keycode.UP) {
                    if (parseInt($inputbox.css("top")) > 0 || $(event.target).hasClass("formulaInputFocus") || $("#jfgrid-singleRange-dialog").is(":visible") || $("#jfgrid-multiRange-dialog").is(":visible")) {
                        return;
                    }

                    jfgridMoveHighlightCell("down", -1, "rangeOfSelect");
                    event.preventDefault();
                }
                else if (kcode == keycode.DOWN) {
                    if (parseInt($inputbox.css("top")) > 0 || $(event.target).hasClass("formulaInputFocus") || $("#jfgrid-singleRange-dialog").is(":visible") || $("#jfgrid-multiRange-dialog").is(":visible")) {
                        return;
                    }

                    jfgridMoveHighlightCell("down", 1, "rangeOfSelect");
                    event.preventDefault();
                }
                else if (kcode == keycode.LEFT) {
                    if (parseInt($inputbox.css("top")) > 0 || $(event.target).hasClass("formulaInputFocus") || $("#jfgrid-singleRange-dialog").is(":visible") || $("#jfgrid-multiRange-dialog").is(":visible")) {
                        return;
                    }

                    jfgridMoveHighlightCell("right", -1, "rangeOfSelect");
                    event.preventDefault();
                }
                else if (kcode == keycode.RIGHT) {
                    if (parseInt($inputbox.css("top")) > 0 || $(event.target).hasClass("formulaInputFocus") || $("#jfgrid-singleRange-dialog").is(":visible") || $("#jfgrid-multiRange-dialog").is(":visible")) {
                        return;
                    }

                    jfgridMoveHighlightCell("right", 1, "rangeOfSelect");
                    event.preventDefault();
                }
                else if (!((kcode >= 112 && kcode <= 123) || kcode <= 46 || kcode == 144 || kcode == 108 || event.ctrlKey || event.altKey || (event.shiftKey && (kcode == 37 || kcode == 38 || kcode == 39 || kcode == 40))) || kcode == 8 || kcode == 32 || kcode == 46 || kcode == 0 || (event.ctrlKey && kcode == 86)) {
                    if (String.fromCharCode(kcode) != null && $("#jfgrid-cell-selected").is(":visible") && (kcode != keycode.CAPSLOCK && kcode != keycode.WIN && kcode != 18)) {
                        var last = jfgird_select_save[jfgird_select_save.length - 1];

                        var row_index = last["row_focus"], col_index = last["column_focus"];
                        var row = visibledatarow[row_index], row_pre = row_index - 1 == -1 ? 0 : visibledatarow[row_index - 1];
                        var col = visibledatacolumn[col_index], col_pre = col_index - 1 == -1 ? 0 : visibledatacolumn[col_index - 1];
                        
                        var margeset = jfgrid.menuButton.mergeborer(jfgrid.flowdata, row_index, col_index);
                        if(!!margeset){
                            row = margeset.row[1];
                            row_pre = margeset.row[0];
                            row_index = margeset.row[2];
                            col = margeset.column[1];
                            col_pre = margeset.column[0];
                            col_index = margeset.column[2];
                        }

                        jfgrid.jfgridupdateCell(row, row_pre, row_index, col, col_pre, col_index, jfgrid.flowdata, true);
                        if(kcode == 8){
                            $("#jfgrid-rich-text-editor").html("<br/>");
                        }
                        jfgrid.formula.functionInputHanddler($("#jfgrid-functionbox-cell"), $("#jfgrid-rich-text-editor"), kcode);
                    }
                }
            }
            
            jfgridactiveCell();

            event.stopPropagation();
        });

        var jfgridMoveEndCell = function (postion, type, isScroll, terminal, onlyvalue) {
            if (isScroll == null) {
                isScroll = true;
            }

            if (!postion) {
                postion = "down";
            }

            if (!type) {
                type = "cell";
            }

            if (onlyvalue == null) {
                onlyvalue = false;
            }

            var last = jfgird_select_save[jfgird_select_save.length - 1];

            var curR = last["row"] == null ? 0 : last["row"][0];
            var curC = last["column"] == null ? 0 : last["column"][0];

            var startR = last["row"] == null ? 0 : last["row"][0];
            var startC = last["column"] == null ? 0 : last["column"][0];

            var endR = last["row"] == null ? 0 : last["row"][1];
            var endC = last["column"] == null ? 0 : last["column"][1];

            jfgrid.formula.fucntionboxshow(curR, curC);

            if (type == "range") {
                var p_startR = jfgrid.jfgrid_shiftpositon["row"][0];
                var p_startC = jfgrid.jfgrid_shiftpositon["column"][0];

                var p_endR = jfgrid.jfgrid_shiftpositon["row"][1];
                var p_endC = jfgrid.jfgrid_shiftpositon["column"][1];

                if (postion == "down" || postion == "up") {

                    if (p_endR < endR) {
                        curR = last["row"] == null ? 0 : last["row"][1];
                    }
                    else if (p_startR > startR) {
                        curR = last["row"] == null ? 0 : last["row"][0];
                    }
                    else if (p_endR == endR && p_startR == startR) {
                        if (postion == "down") {
                            curR = last["row"] == null ? 0 : last["row"][1];
                        }
                        else {
                            curR = last["row"] == null ? 0 : last["row"][0];
                        }
                    }


                    //if (endR >= datarowlen) {
                    //    endR = datarowlen - 1;
                    //}

                    //if (endR < 0) {
                    //    endR = 0;
                    //}

                    //if (startR >= datarowlen) {
                    //    startR = datarowlen - 1;
                    //}

                    //if (startR < 0) {
                    //    startR = 0;
                    //}
                }
                else if (postion == "right" || postion == "left") {
                    if (p_endC < endC) {
                        curC = last["column"] == null ? 0 : last["column"][1];
                    }
                    else if (p_startC > startC) {
                        curC = last["column"] == null ? 0 : last["column"][0];
                    }
                    else if (p_endC == endC && p_startC == startC) {
                        if (postion == "right") {
                            curC = last["column"] == null ? 0 : last["column"][1];
                        }
                        else {
                            curC = last["column"] == null ? 0 : last["column"][0];
                        }
                    }


                    //console.log(p_startC, p_endC, startC, endC, curC);

                    //if (endC >= datacolumnlen) {
                    //    endC = datacolumnlen - 1;
                    //}

                    //if (endC < 0) {
                    //    endC = 0;
                    //}

                    //if (startC >= datacolumnlen) {
                    //    startC = datacolumnlen - 1;
                    //}

                    //if (startC < 0) {
                    //    startC = 0;
                    //}
                }
            }

            var datarowlen = jfgrid.flowdata.length, datacolumnlen = jfgrid.flowdata[0].length;

            var data = jfgrid.flowdata, moveP = "", moveV = 0;

            if (postion == "up") {
                if (curR == 0) {
                    return;
                }
                else {
                    var stvalue = [], p = null, i = 0, p_pre = null;
                    for (var c = startC; c <= endC; c++) {
                        stvalue = [];
                        i = 0;

                        for (var r = curR - 1; r >= 0; r--) {
                            var cell = data[r][c];

                            if (jfgrid.getObjType(cell) == "object" && jfgrid.func_methods.isRealNull(cell.v)) {
                                stvalue.push(false);
                            }
                            else if (jfgrid.func_methods.isRealNull(cell)) {
                                stvalue.push(false);
                            }
                            else {
                                stvalue.push(true);
                            }

                            if (stvalue.length > 1) {
                                if (stvalue[i] == true && stvalue[i - 1] == false) {
                                    p = r;
                                    break
                                }
                                else if (stvalue[i] == false && stvalue[i - 1] == true) {
                                    p = r + 1;
                                    break
                                }
                            }

                            i++;
                        }

                        if(p == null){
                            p = 0;
                        }

                        if (p_pre == null || p < p_pre) {
                            p_pre = p;
                        }
                    }
                    
                    moveP = "down";
                    moveV = p_pre - curR;
                }
            }
            else if (postion == "down") {
                if (curR == datarowlen - 1) {
                    return;
                }
                else {
                    var stvalue = [], p = null, i = 0, p_pre = null;
                    for (var c = startC; c <= endC; c++) {
                        stvalue = [];
                        i = 0;

                        for (var r = curR + 1; r < data.length; r++) {
                            var cell = data[r][c];

                            if (jfgrid.getObjType(cell) == "object" && jfgrid.func_methods.isRealNull(cell.v)) {
                                stvalue.push(false);
                            }
                            else if (jfgrid.func_methods.isRealNull(cell)) {
                                stvalue.push(false);
                            }
                            else {
                                stvalue.push(true);
                            }
                            
                            if (stvalue.length > 1) {
                                if (stvalue[i] == true && stvalue[i - 1] == false) {
                                    p = r;
                                    break
                                }
                                else if (stvalue[i] == false && stvalue[i - 1] == true) {
                                    p = r - 1;
                                    break
                                }
                            }

                            i++;
                        }

                        if(p == null){
                            p = data.length - 1;
                        }

                        if (p_pre == null || p > p_pre) {
                            p_pre = p;
                        }
                    }
                    
                    moveP = "down";
                    moveV = p_pre - curR;
                }
            }
            else if (postion == "left") {
                if (curC == 0) {
                    return;
                }
                else {
                    var stvalue = [], p = null, i = 0, p_pre = null;
                    for (var r = startR; r <= endR; r++) {
                        stvalue = [];
                        i = 0;
                        for (var c = curC - 1; c >= 0; c--) {
                            var cell = data[r][c];

                            if (jfgrid.getObjType(cell) == "object" && jfgrid.func_methods.isRealNull(cell.v)) {
                                stvalue.push(false);
                            }
                            else if (jfgrid.func_methods.isRealNull(cell)) {
                                stvalue.push(false);
                            }
                            else {
                                stvalue.push(true);
                            }

                            if (stvalue.length > 1) {
                                if (stvalue[i] == true && stvalue[i - 1] == false) {
                                    p = c;
                                    break
                                }
                                else if (stvalue[i] == false && stvalue[i - 1] == true) {
                                    p = c + 1;
                                    break
                                }
                            }

                            i++;
                        }

                        if(p == null){
                            p = 0;
                        }

                        if (p_pre == null || p < p_pre) {
                            p_pre = p;
                        }
                    }
                    
                    moveP = "right";
                    moveV = p_pre - curC;
                }
            }
            else if (postion == "right") {
                if (curC == datacolumnlen - 1) {
                    return;
                }
                else {
                    var stvalue = [], p = null, i = 0, p_pre = null;
                    for (var r = startR; r <= endR; r++) {
                        stvalue = [];
                        i = 0;
                        for (var c = curC + 1; c < data[0].length; c++) {
                            var cell = data[r][c];

                            if (jfgrid.getObjType(cell) == "object" && jfgrid.func_methods.isRealNull(cell.v)) {
                                stvalue.push(false);
                            }
                            else if (jfgrid.func_methods.isRealNull(cell)) {
                                stvalue.push(false);
                            }
                            else {
                                stvalue.push(true);
                            }

                            if (stvalue.length > 1) {
                                if (stvalue[i] == true && stvalue[i - 1] == false) {
                                    p = c;
                                    break
                                }
                                else if (stvalue[i] == false && stvalue[i - 1] == true) {
                                    p = c - 1;
                                    break
                                }
                            }

                            i++;
                        }

                        if(p == null){
                            p = data[0].length - 1;
                        }

                        if (p_pre == null || p > p_pre) {
                            p_pre = p;
                        }
                    }

                    moveP = "right";
                    moveV = p_pre - curC;
                }
            }

            //console.log("up", moveV, curR, p_endR, moveV + curR < p_endR);
            //console.log("down", moveV, curR, p_startR, moveV + curR > p_startR);
            //console.log("left", moveV, curC, p_endC, moveV + curC < p_endC);
            //console.log("right", moveV, curC, p_startC, moveV + curC > p_startC);

            if (type == "range") {
                if (postion == "up") {
                    if (p_endR < endR) {
                        if (moveV + curR < p_endR) {
                            moveV = p_endR - curR;
                        }
                    }
                }
                else if (postion == "down") {
                    if (p_startR > startR) {
                        if (moveV + curR > p_startR) {
                            moveV = p_startR - curR;
                        }
                    }
                }
                else if (postion == "left") {
                    if (p_endC < endC) {
                        if (moveV + curC < p_endC) {
                            moveV = p_endC - curC;
                        }
                    }
                    //else if (p_startC > startC) {

                    //}
                    //else if (p_endC == endC && p_startC == startC) {
                    //    if (postion == "right") {

                    //    }
                    //    else {

                    //    }
                    //}

                    //if (curC != p_endC && moveV + curC > p_endC) {
                    //    moveV = curC - p_endC;
                    //}
                }
                else if (postion == "right") {
                    if (p_startC > startC) {
                        if (moveV + curC > p_startC) {
                            moveV = p_startC - curC;
                        }
                    }
                }

                if (terminal != null && Math.abs(moveV) > Math.abs(terminal)) {
                    moveV = terminal;
                }
            }

            if (!onlyvalue) {
                if (type == "cell") {
                    jfgridMoveHighlightCell(moveP, moveV, "rangeOfSelect", isScroll);
                }
                else if (type == "range") {
                    jfgridMoveHighlightRange(moveP, moveV, "rangeOfSelect", isScroll);
                }
            }
            else {
                return moveV;
            }
        }

        jfgrid.jfgridMoveEndCell = jfgridMoveEndCell;

        //方向键  调整单元格
        var jfgridMoveHighlightCell = function (postion, index, type, isScroll) {
            if (isScroll == null) {
                isScroll = true;
            }

            if (!postion) {
                postion == "down";
            }

            var datarowlen = jfgrid.flowdata.length, datacolumnlen = jfgrid.flowdata[0].length;

            if(type == "rangeOfSelect"){
                var last = jfgird_select_save[jfgird_select_save.length - 1];
            
                if(last["row_focus"] == null){
                    var curR = last["row"][0];    
                }
                else{
                    var curR = last["row_focus"];    
                }

                if(last["column_focus"] == null){
                    var curC = last["column"][0];
                }
                else{
                    var curC = last["column_focus"];    
                }
                
                //focus单元格 是否是合并单元格
                var margeset = jfgrid.menuButton.mergeborer(jfgrid.flowdata, curR, curC);
                if(!!margeset){
                    var str_r = margeset.row[2];
                    var end_r = margeset.row[3];

                    var str_c = margeset.column[2];
                    var end_c = margeset.column[3];

                    if(index > 0){
                        if(postion == "down"){
                            curR = end_r;
                            curC = str_c;
                        }
                        else if(postion == "right"){
                            curR = str_r;
                            curC = end_c;
                        }
                    }
                    else{
                        curR = str_r;
                        curC = str_c;
                    }
                }

                var moveX = last["moveXY"] == null ? curR : last["moveXY"].x;
                var moveY = last["moveXY"] == null ? curC : last["moveXY"].y;

                if (postion == "down") {
                    curR += index;
                    moveX = curR;
                }
                else if (postion == "right") {
                    curC += index;
                    moveY = curC;
                }

                if (curR >= datarowlen) {
                    curR = datarowlen - 1;
                    moveX = curR;
                }

                if (curR < 0) {
                    curR = 0;
                    moveX = curR;
                }

                if (curC >= datacolumnlen) {
                    curC = datacolumnlen - 1;
                    moveY = curC;
                }

                if (curC < 0) {
                    curC = 0;
                    moveY = curC;
                }

                //移动的下一个单元格是否是合并的单元格
                var margeset2 = jfgrid.menuButton.mergeborer(jfgrid.flowdata, curR, curC);
                if(!!margeset2){
                    var row = margeset2.row[1];
                    var row_pre = margeset2.row[0];
                    var row_index = margeset2.row[2];
                    var row_index_ed = margeset2.row[3];

                    var col = margeset2.column[1];
                    var col_pre = margeset2.column[0];
                    var col_index = margeset2.column[2];
                    var col_index_ed = margeset2.column[3];
                }
                else{
                    var row = visibledatarow[moveX], row_pre = moveX - 1 == -1 ? 0 : visibledatarow[moveX - 1];
                    var col = visibledatacolumn[moveY], col_pre = moveY - 1 == -1 ? 0 : visibledatacolumn[moveY - 1];
                    var row_index = moveX;
                    var row_index_ed = moveX;
                    var col_index = moveY;
                    var col_index_ed = moveY;
                }

                last["row"] = [row_index, row_index_ed];
                last["column"] = [col_index, col_index_ed];
                last["row_focus"] = row_index;
                last["column_focus"] = col_index;
                last["moveXY"] = {"x": moveX,"y": moveY};

                jfgrid.selectHightlightShow();

                jfgrid.pivotTable.pivotclick(row_index, col_index);

                jfgrid.formula.fucntionboxshow(row_index, col_index);

                //图表
                if (jfgrid.chartparam.jfgrid_chart_data_select_state) {
                    $("#jfgrid-datavisual-range-selection-input").val(jfgridfile[jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex)].name + "!" + jfgrid.jfgridchatatABC(last["column"][0]) + (last["row"][0] + 1) + ":" + jfgrid.jfgridchatatABC(last["column"][1]) + (last["row"][1] + 1));
                }
            }
            else if(type == "rangeOfFormula"){
                var last = jfgrid.formula.func_selectedrange;
            
                if(last["row_focus"] == null){
                    var curR = last["row"][0];    
                }
                else{
                    var curR = last["row_focus"];    
                }

                if(last["column_focus"] == null){
                    var curC = last["column"][0];
                }
                else{
                    var curC = last["column_focus"];    
                }
                
                //focus单元格 是否是合并单元格
                var margeset = jfgrid.menuButton.mergeborer(jfgrid.flowdata, curR, curC);
                if(!!margeset){
                    var str_r = margeset.row[2];
                    var end_r = margeset.row[3];

                    var str_c = margeset.column[2];
                    var end_c = margeset.column[3];

                    if(index > 0){
                        if(postion == "down"){
                            curR = end_r;
                            curC = str_c;
                        }
                        else if(postion == "right"){
                            curR = str_r;
                            curC = end_c;
                        }
                    }
                    else{
                        curR = str_r;
                        curC = str_c;
                    }
                }

                var moveX = last["moveXY"] == null ? curR : last["moveXY"].x;
                var moveY = last["moveXY"] == null ? curC : last["moveXY"].y;

                if (postion == "down") {
                    curR += index;
                    moveX = curR;
                }
                else if (postion == "right") {
                    curC += index;
                    moveY = curC;
                }

                if (curR >= datarowlen) {
                    curR = datarowlen - 1;
                    moveX = curR;
                }

                if (curR < 0) {
                    curR = 0;
                    moveX = curR;
                }

                if (curC >= datacolumnlen) {
                    curC = datacolumnlen - 1;
                    moveY = curC;
                }

                if (curC < 0) {
                    curC = 0;
                    moveY = curC;
                }

                //移动的下一个单元格是否是合并的单元格
                var margeset2 = jfgrid.menuButton.mergeborer(jfgrid.flowdata, curR, curC);
                if(!!margeset2){
                    var row = margeset2.row[1];
                    var row_pre = margeset2.row[0];
                    var row_index = margeset2.row[2];
                    var row_index_ed = margeset2.row[3];

                    var col = margeset2.column[1];
                    var col_pre = margeset2.column[0];
                    var col_index = margeset2.column[2];
                    var col_index_ed = margeset2.column[3];
                }
                else{
                    var row = visibledatarow[moveX], row_pre = moveX - 1 == -1 ? 0 : visibledatarow[moveX - 1];
                    var col = visibledatacolumn[moveY], col_pre = moveY - 1 == -1 ? 0 : visibledatacolumn[moveY - 1];
                    var row_index = moveX;
                    var row_index_ed = moveX;
                    var col_index = moveY;
                    var col_index_ed = moveY;
                }

                jfgrid.formula.func_selectedrange = {
                    "left": col_pre,
                    "width": col - col_pre - 1,
                    "top": row_pre,
                    "height": row - row_pre - 1,
                    "left_move": col_pre,
                    "width_move": col - col_pre - 1,
                    "top_move": row_pre,
                    "height_move": row - row_pre - 1,
                    "row": [row_index, row_index_ed],
                    "column": [col_index, col_index_ed],
                    "row_focus": row_index,
                    "column_focus": col_index,
                    "moveXY": {"x": moveX, "y": moveY}
                };

                $("#jfgrid-formula-functionrange-select").css({
                    "left": col_pre,
                    "width": col - col_pre - 1,
                    "top": row_pre,
                    "height": row - row_pre - 1
                }).show();

                jfgrid.formula.rangeSetValue({
                    "row": [row_index, row_index_ed],
                    "column": [col_index, col_index_ed]
                });
            }

            //var winW = $(window).width(), winH = $(window).height();
            var scrollLeft = $("#jfgrid-cell-main").scrollLeft();
            var scrollTop = $("#jfgrid-cell-main").scrollTop();
            var winH = $("#jfgrid-cell-main").height(), winW = $("#jfgrid-cell-main").width();

            var sleft = 0, stop = 0;
            if (col - scrollLeft - winW + 20 > 0) {
                sleft = col - winW + 20;
                if (isScroll) {
                    $("#jfgrid-scrollbar-x").scrollLeft(sleft);
                }
            }
            else if (col_pre - scrollLeft - 20 < 0) {
                sleft = col_pre - 20;
                if (isScroll) {
                    $("#jfgrid-scrollbar-x").scrollLeft(sleft);
                }
            }

            if (row - scrollTop - winH + 20 > 0) {
                stop = row - winH + 20;
                if (isScroll) {
                    $("#jfgrid-scrollbar-y").scrollTop(stop);
                }
            }
            else if (row_pre - scrollTop - 20 < 0) {
                stop = row_pre - 20;
                if (isScroll) {
                    $("#jfgrid-scrollbar-y").scrollTop(stop);
                }
            }

            clearTimeout(jfcountfuncTimeout);
            jfcountfunc();
        }

        //ctrl + 方向键  调整单元格
        var jfgridMoveHighlightCell2 = function(postion, type, isScroll){
            if(!isScroll){
                isScroll = true;
            }

            if(type == "rangeOfSelect"){
                var last = jfgird_select_save[jfgird_select_save.length - 1];
                var rf = last["row_focus"], cf = last["column_focus"];

                if(config["merge"] != null && (rf + "_" + cf) in config["merge"]){
                    var focusIsMerge = true;
                    var mc = config["merge"][rf + "_" + cf];
                }
                else{
                    var focusIsMerge = false;
                }

                if(postion == "down"){
                    if(rf == jfgrid.flowdata.length - 1){
                        return;
                    }

                    if(focusIsMerge){
                        rf = jfgrid.getNextIndex("down", cf, mc.r + mc.rs - 1, jfgrid.flowdata.length - 1);
                    }
                    else{
                        rf = jfgrid.getNextIndex("down", cf, rf, jfgrid.flowdata.length - 1);
                    }
                }
                else if(postion == "up"){
                    if(rf == 0){
                        return;
                    }

                    if(focusIsMerge){
                        rf = jfgrid.getNextIndex("up", cf, 0, mc.r);
                    }
                    else{
                        rf = jfgrid.getNextIndex("up", cf, 0, rf);
                    }
                }
                else if(postion == "right"){
                    if(cf == jfgrid.flowdata[0].length - 1){
                        return;
                    }

                    if(focusIsMerge){
                        cf = jfgrid.getNextIndex("right", rf, mc.c + mc.cs - 1, jfgrid.flowdata[0].length - 1);
                    }
                    else{
                        cf = jfgrid.getNextIndex("right", rf, cf, jfgrid.flowdata[0].length - 1);
                    }
                }
                else if(postion == "left"){
                    if(cf == 0){
                        return;
                    }

                    if(focusIsMerge){
                        cf = jfgrid.getNextIndex("left", rf, 0, mc.c);
                    }
                    else{
                        cf = jfgrid.getNextIndex("left", rf, 0, cf);
                    }
                }

                var rowseleted = [rf, rf];
                var columnseleted = [cf, cf];

                var row = visibledatarow[rf], row_pre = rf - 1 == -1 ? 0 : visibledatarow[rf - 1];
                var col = visibledatacolumn[cf], col_pre = cf - 1 == -1 ? 0 : visibledatacolumn[cf - 1];

                var changeparam = jfgrid.menuButton.mergeMoveMain(columnseleted, rowseleted, last, row_pre, row - row_pre - 1, col_pre, col - col_pre - 1);
                if(changeparam != null){
                    columnseleted = changeparam[0];
                    rowseleted= changeparam[1];
                    // top = changeparam[2];
                    // height = changeparam[3];
                    // left = changeparam[4];
                    // width = changeparam[5];
                }

                jfgird_select_save = [{"row": rowseleted, "column": columnseleted}];

                jfgrid.selectHightlightShow();

                jfgrid.pivotTable.pivotclick(rf, cf);

                jfgrid.formula.fucntionboxshow(rf, cf);

                //图表
                if (jfgrid.chartparam.jfgrid_chart_data_select_state) {
                    $("#jfgrid-datavisual-range-selection-input").val(jfgridfile[jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex)].name + "!" + jfgrid.jfgridchatatABC(columnseleted[0]) + (rowseleted[0] + 1) + ":" + jfgrid.jfgridchatatABC(columnseleted[1]) + (rowseleted[1] + 1));
                }
            }
            else if(type == "rangeOfFormula"){
                var last = jfgrid.formula.func_selectedrange;
                var rf = last["row_focus"], cf = last["column_focus"];

                if(config["merge"] != null && (rf + "_" + cf) in config["merge"]){
                    var focusIsMerge = true;
                    var mc = config["merge"][rf + "_" + cf];
                }
                else{
                    var focusIsMerge = false;
                }

                if(postion == "down"){
                    if(rf == jfgrid.flowdata.length - 1){
                        return;
                    }

                    if(focusIsMerge){
                        rf = jfgrid.getNextIndex("down", cf, mc.r + mc.rs - 1, jfgrid.flowdata.length - 1);
                    }
                    else{
                        rf = jfgrid.getNextIndex("down", cf, rf, jfgrid.flowdata.length - 1);
                    }
                }
                else if(postion == "up"){
                    if(rf == 0){
                        return;
                    }

                    if(focusIsMerge){
                        rf = jfgrid.getNextIndex("up", cf, 0, mc.r);
                    }
                    else{
                        rf = jfgrid.getNextIndex("up", cf, 0, rf);
                    }
                }
                else if(postion == "right"){
                    if(cf == jfgrid.flowdata[0].length - 1){
                        return;
                    }

                    if(focusIsMerge){
                        cf = jfgrid.getNextIndex("right", rf, mc.c + mc.cs - 1, jfgrid.flowdata[0].length - 1);
                    }
                    else{
                        cf = jfgrid.getNextIndex("right", rf, cf, jfgrid.flowdata[0].length - 1);
                    }
                }
                else if(postion == "left"){
                    if(cf == 0){
                        return;
                    }

                    if(focusIsMerge){
                        cf = jfgrid.getNextIndex("left", rf, 0, mc.c);
                    }
                    else{
                        cf = jfgrid.getNextIndex("left", rf, 0, cf);
                    }
                }

                var rowseleted = [rf, rf];
                var columnseleted = [cf, cf];

                var row = visibledatarow[rf], row_pre = rf - 1 == -1 ? 0 : visibledatarow[rf - 1];
                var col = visibledatacolumn[cf], col_pre = cf - 1 == -1 ? 0 : visibledatacolumn[cf - 1];

                var top = row_pre, height = row - row_pre - 1;
                var left = col_pre, width = col - col_pre - 1;

                var changeparam = jfgrid.menuButton.mergeMoveMain(columnseleted, rowseleted, last, top, height, left, width);
                if(changeparam != null){
                    columnseleted = changeparam[0];
                    rowseleted= changeparam[1];
                    top = changeparam[2];
                    height = changeparam[3];
                    left = changeparam[4];
                    width = changeparam[5];
                }

                jfgrid.formula.func_selectedrange = {
                    "left": left,
                    "width": width,
                    "top": top,
                    "height": height,
                    "left_move": left,
                    "width_move": width,
                    "top_move": top,
                    "height_move": height,
                    "row": rowseleted,
                    "column": columnseleted,
                    "row_focus": rf,
                    "column_focus": cf
                };

                $("#jfgrid-formula-functionrange-select").css({
                    "left": left,
                    "width": width,
                    "top": top,
                    "height": height
                }).show();

                jfgrid.formula.rangeSetValue({
                    "row": rowseleted,
                    "column": columnseleted
                });
            }

            var scrollLeft = $("#jfgrid-cell-main").scrollLeft();
            var scrollTop = $("#jfgrid-cell-main").scrollTop();
            var winH = $("#jfgrid-cell-main").height(), winW = $("#jfgrid-cell-main").width();

            var sleft = 0, stop = 0;
            if (col - scrollLeft - winW + 20 > 0) {
                sleft = col - winW + 20;
                if (isScroll) {
                    $("#jfgrid-scrollbar-x").scrollLeft(sleft);
                }
            }
            else if (col_pre - scrollLeft - 20 < 0) {
                sleft = col_pre - 20;
                if (isScroll) {
                    $("#jfgrid-scrollbar-x").scrollLeft(sleft);
                }
            }

            if (row - scrollTop - winH + 20 > 0) {
                stop = row - winH + 20;
                if (isScroll) {
                    $("#jfgrid-scrollbar-y").scrollTop(stop);
                }
            }
            else if (row_pre - scrollTop - 20 < 0) {
                stop = row_pre - 20;
                if (isScroll) {
                    $("#jfgrid-scrollbar-y").scrollTop(stop);
                }
            }

            clearTimeout(jfcountfuncTimeout);
            jfcountfunc();
        }

        //shift + 方向键  调整选区
        var jfgridMoveHighlightRange = function (postion, index, type, isScroll) {
            if (isScroll == null) {
                isScroll = true;
            }

            if (!postion) {
                postion == "down";
            }

            if(type == "rangeOfSelect"){
                var last = jfgird_select_save[jfgird_select_save.length - 1];

                var curR = last["row"][0], endR = last["row"][1];
                var curC = last["column"][0], endC = last["column"][1];
                var rf = last["row_focus"], cf = last["column_focus"];

                var datarowlen = jfgrid.flowdata.length, datacolumnlen = jfgrid.flowdata[0].length;

                if(postion == "down"){ //选区上下变动
                    if(jfgrid.rowHasMerge(rf, curC, endC)){ //focus单元格所在行有合并单元格
                        var rfMerge = jfgrid.getRowMerge(rf, curC, endC);
                        var rf_str = rfMerge[0], rf_end = rfMerge[1];

                        if(rf_str > curR && rf_end == endR){
                            if(index > 0 && jfgrid.rowHasMerge(curR, curC, endC)){
                                curR = jfgrid.getRowMerge(curR, curC, endC)[1];
                            }

                            curR += index;
                        }
                        else if(rf_end < endR && rf_str == curR){
                            if(index < 0 && jfgrid.rowHasMerge(endR, curC, endC)){
                                endR = jfgrid.getRowMerge(endR, curC, endC)[0];
                            }

                            endR += index;
                        }
                        else{
                            if(index > 0){
                                endR += index;
                            }
                            else{
                                curR += index;
                            }
                        }
                    }
                    else{
                        if(rf > curR && rf == endR){
                            if(index > 0 && jfgrid.rowHasMerge(curR, curC, endC)){
                                curR = jfgrid.getRowMerge(curR, curC, endC)[1];
                            }

                            curR += index;
                        }
                        else if(rf < endR && rf == curR){
                            if(index < 0 && jfgrid.rowHasMerge(endR, curC, endC)){
                                endR = jfgrid.getRowMerge(endR, curC, endC)[0];
                            }

                            endR += index;
                        }
                        else if(rf == curR && rf == endR){
                            if(index > 0){
                                endR += index;
                            }
                            else{
                                curR += index;
                            }
                        }
                    }

                    if (endR >= datarowlen) {
                        endR = datarowlen - 1;
                    }

                    if (endR < 0) {
                        endR = 0;
                    }

                    if (curR >= datarowlen) {
                        curR = datarowlen - 1;
                    }

                    if (curR < 0) {
                        curR = 0;
                    }
                }
                else{
                    if(jfgrid.colHasMerge(cf, curR, endR)){ //focus单元格所在列有合并单元格
                        var cfMerge = jfgrid.getColMerge(cf, curR, endR);
                        var cf_str = cfMerge[0], cf_end = cfMerge[1];

                        if(cf_str > curC && cf_end == endC){
                            if(index > 0 && jfgrid.colHasMerge(curC, curR, endR)){
                                curC = jfgrid.getColMerge(curC, curR, endR)[1];
                            }

                            curC += index;
                        }
                        else if(cf_end < endC && cf_str == curC){
                            if(index < 0 && jfgrid.colHasMerge(endC, curR, endR)){
                                endC = jfgrid.getColMerge(endC, curR, endR)[0];
                            }

                            endC += index;
                        }
                        else{
                            if(index > 0){
                                endC += index;
                            }
                            else{
                                curC += index;
                            }
                        }
                    }
                    else{
                        if(cf > curC && cf == endC){
                            if(index > 0 && jfgrid.colHasMerge(curC, curR, endR)){
                                curC = jfgrid.getColMerge(curC, curR, endR)[1];
                            }

                            curC += index;
                        }
                        else if(cf < endC && cf == curC){
                            if(index < 0 && jfgrid.colHasMerge(endC, curR, endR)){
                                endC = jfgrid.getColMerge(endC, curR, endR)[0];
                            }

                            endC += index;
                        }
                        else if(cf == curC && cf == endC){
                            if(index > 0){
                                endC += index;
                            }
                            else{
                                curC += index;
                            }
                        }
                    } 

                    if (endC >= datacolumnlen) {
                        endC = datacolumnlen - 1;
                    }

                    if (endC < 0) {
                        endC = 0;
                    }

                    if (curC >= datacolumnlen) {
                        curC = datacolumnlen - 1;
                    }

                    if (curC < 0) {
                        curC = 0;
                    }
                }

                var rowseleted = [curR, endR];
                var columnseleted = [curC, endC];

                var row = visibledatarow[endR], row_pre = curR - 1 == -1 ? 0 : visibledatarow[curR - 1];
                var col = visibledatacolumn[endC], col_pre = curC - 1 == -1 ? 0 : visibledatacolumn[curC - 1];

                var changeparam = jfgrid.menuButton.mergeMoveMain(columnseleted, rowseleted, last, row_pre, row - row_pre - 1, col_pre, col - col_pre - 1);
                if(changeparam != null){
                    columnseleted = changeparam[0];
                    rowseleted= changeparam[1];
                    // top = changeparam[2];
                    // height = changeparam[3];
                    // left = changeparam[4];
                    // width = changeparam[5];
                }

                last["row"] = rowseleted;
                last["column"] = columnseleted;

                jfgrid.selectHightlightShow();

                //图表
                if (jfgrid.chartparam.jfgrid_chart_data_select_state) {
                    $("#jfgrid-datavisual-range-selection-input").val(jfgridfile[jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex)].name + "!" + jfgrid.jfgridchatatABC(last["column"][0]) + (last["row"][0] + 1) + ":" + jfgrid.jfgridchatatABC(last["column"][1]) + (last["row"][1] + 1));
                }
            }
            else if(type == "rangeOfFormula"){
                var last = jfgrid.formula.func_selectedrange;

                var curR = last["row"][0], endR = last["row"][1];
                var curC = last["column"][0], endC = last["column"][1];
                var rf = last["row_focus"], cf = last["column_focus"];

                var datarowlen = jfgrid.flowdata.length, datacolumnlen = jfgrid.flowdata[0].length;

                if(postion == "down"){ //选区上下变动
                    if(jfgrid.rowHasMerge(rf, curC, endC)){ //focus单元格所在行有合并单元格
                        var rfMerge = jfgrid.getRowMerge(rf, curC, endC);
                        var rf_str = rfMerge[0], rf_end = rfMerge[1];

                        if(rf_str > curR && rf_end == endR){
                            if(index > 0 && jfgrid.rowHasMerge(curR, curC, endC)){
                                curR = jfgrid.getRowMerge(curR, curC, endC)[1];
                            }

                            curR += index;
                        }
                        else if(rf_end < endR && rf_str == curR){
                            if(index < 0 && jfgrid.rowHasMerge(endR, curC, endC)){
                                endR = jfgrid.getRowMerge(endR, curC, endC)[0];
                            }

                            endR += index;
                        }
                        else{
                            if(index > 0){
                                endR += index;
                            }
                            else{
                                curR += index;
                            }
                        }
                    }
                    else{
                        if(rf > curR && rf == endR){
                            if(index > 0 && jfgrid.rowHasMerge(curR, curC, endC)){
                                curR = jfgrid.getRowMerge(curR, curC, endC)[1];
                            }

                            curR += index;
                        }
                        else if(rf < endR && rf == curR){
                            if(index < 0 && jfgrid.rowHasMerge(endR, curC, endC)){
                                endR = jfgrid.getRowMerge(endR, curC, endC)[0];
                            }

                            endR += index;
                        }
                        else if(rf == curR && rf == endR){
                            if(index > 0){
                                endR += index;
                            }
                            else{
                                curR += index;
                            }
                        }
                    }

                    if (endR >= datarowlen) {
                        endR = datarowlen - 1;
                    }

                    if (endR < 0) {
                        endR = 0;
                    }

                    if (curR >= datarowlen) {
                        curR = datarowlen - 1;
                    }

                    if (curR < 0) {
                        curR = 0;
                    }
                }
                else{
                    if(jfgrid.colHasMerge(cf, curR, endR)){ //focus单元格所在列有合并单元格
                        var cfMerge = jfgrid.getColMerge(cf, curR, endR);
                        var cf_str = cfMerge[0], cf_end = cfMerge[1];

                        if(cf_str > curC && cf_end == endC){
                            if(index > 0 && jfgrid.colHasMerge(curC, curR, endR)){
                                curC = jfgrid.getColMerge(curC, curR, endR)[1];
                            }

                            curC += index;
                        }
                        else if(cf_end < endC && cf_str == curC){
                            if(index < 0 && jfgrid.colHasMerge(endC, curR, endR)){
                                endC = jfgrid.getColMerge(endC, curR, endR)[0];
                            }

                            endC += index;
                        }
                        else{
                            if(index > 0){
                                endC += index;
                            }
                            else{
                                curC += index;
                            }
                        }
                    }
                    else{
                        if(cf > curC && cf == endC){
                            if(index > 0 && jfgrid.colHasMerge(curC, curR, endR)){
                                curC = jfgrid.getColMerge(curC, curR, endR)[1];
                            }

                            curC += index;
                        }
                        else if(cf < endC && cf == curC){
                            if(index < 0 && jfgrid.colHasMerge(endC, curR, endR)){
                                endC = jfgrid.getColMerge(endC, curR, endR)[0];
                            }

                            endC += index;
                        }
                        else if(cf == curC && cf == endC){
                            if(index > 0){
                                endC += index;
                            }
                            else{
                                curC += index;
                            }
                        }
                    } 

                    if (endC >= datacolumnlen) {
                        endC = datacolumnlen - 1;
                    }

                    if (endC < 0) {
                        endC = 0;
                    }

                    if (curC >= datacolumnlen) {
                        curC = datacolumnlen - 1;
                    }

                    if (curC < 0) {
                        curC = 0;
                    }
                }

                var rowseleted = [curR, endR];
                var columnseleted = [curC, endC];

                var row = visibledatarow[endR], row_pre = curR - 1 == -1 ? 0 : visibledatarow[curR - 1];
                var col = visibledatacolumn[endC], col_pre = curC - 1 == -1 ? 0 : visibledatacolumn[curC - 1];

                var top = row_pre, height = row - row_pre - 1;
                var left = col_pre, width = col - col_pre - 1;

                var changeparam = jfgrid.menuButton.mergeMoveMain(columnseleted, rowseleted, last, top, height, left, width);
                if(changeparam != null){
                    columnseleted = changeparam[0];
                    rowseleted= changeparam[1];
                    top = changeparam[2];
                    height = changeparam[3];
                    left = changeparam[4];
                    width = changeparam[5];
                }

                jfgrid.formula.func_selectedrange = {
                    "left": left,
                    "width": width,
                    "top": top,
                    "height": height,
                    "left_move": left,
                    "width_move": width,
                    "top_move": top,
                    "height_move": height,
                    "row": rowseleted,
                    "column": columnseleted,
                    "row_focus": rf,
                    "column_focus": cf
                };

                $("#jfgrid-formula-functionrange-select").css({
                    "left": left,
                    "width": width,
                    "top": top,
                    "height": height
                }).show();

                jfgrid.formula.rangeSetValue({
                    "row": rowseleted,
                    "column": columnseleted
                });
            }

            //var winW = $(window).width(), winH = $(window).height();
            var scrollLeft = $("#jfgrid-cell-main").scrollLeft();
            var scrollTop = $("#jfgrid-cell-main").scrollTop();
            var winH = $("#jfgrid-cell-main").height(), winW = $("#jfgrid-cell-main").width();

            var sleft = 0, stop = 0;
            if (col - scrollLeft - winW + 20 > 0) {
                sleft = col - winW + 20;
                if (isScroll) {
                    $("#jfgrid-scrollbar-x").scrollLeft(sleft);
                }
            }
            else if (col_pre - scrollLeft - 20 < 0) {
                sleft = col_pre - 20;
                if (isScroll) {
                    $("#jfgrid-scrollbar-x").scrollLeft(sleft);
                }
            }

            if (row - scrollTop - winH + 20 > 0) {
                stop = row - winH + 20;
                if (isScroll) {
                    $("#jfgrid-scrollbar-y").scrollTop(stop);
                }
            }
            else if (row_pre - scrollTop - 20 < 0) {
                stop = row_pre - 20;
                if (isScroll) {
                    $("#jfgrid-scrollbar-y").scrollTop(stop);
                }
            }

            clearTimeout(jfcountfuncTimeout);
            jfcountfunc();
        }

        //ctrl + shift + 方向键  调整选区
        var jfgridMoveHighlightRange2 = function(postion, type, isScroll){
            if(!isScroll){
                isScroll = true;
            }

            if(type == "rangeOfSelect"){
                var last = jfgird_select_save[jfgird_select_save.length - 1];
                var rf = last["row_focus"], cf = last["column_focus"];

                var r1 = last["row"][0], r2 = last["row"][1];
                var c1 = last["column"][0], c2 = last["column"][1];

                if(postion == "down"){
                    if(r2 == jfgrid.flowdata.length - 1){
                        return;
                    }

                    if(jfgrid.rowHasMerge(rf, c1, c2)){ //focus所在行有合并单元格
                        var rfMerge = jfgrid.getRowMerge(rf, c1, c2);
                        var rf_str = rfMerge[0], rf_end = rfMerge[1];

                        if(rf_str > r1 && rf_end == r2){
                            r1 = jfgrid.getNextIndex("down", cf, r1, r2);
                        }
                        else{
                            r2 = jfgrid.getNextIndex("down", cf, r2, jfgrid.flowdata.length - 1);
                        }
                    }
                    else{
                        if(rf > r1 && rf == r2){
                            r1 = jfgrid.getNextIndex("down", cf, r1, r2);
                        }
                        else{
                            r2 = jfgrid.getNextIndex("down", cf, r2, jfgrid.flowdata.length - 1);
                        }
                    }
                }
                else if(postion == "up"){
                    if(r1 == 0){
                        return;
                    }

                    if(jfgrid.rowHasMerge(rf, c1, c2)){ //focus所在行有合并单元格
                        var rfMerge = jfgrid.getRowMerge(rf, c1, c2);
                        var rf_str = rfMerge[0], rf_end = rfMerge[1];

                        if(rf_end < r2 && rf_str == r1){
                            r2 = jfgrid.getNextIndex("up", cf, r1, r2);
                        }
                        else{
                            r1 = jfgrid.getNextIndex("up", cf, 0, r1);
                        }
                    }
                    else{
                        if(rf < r2 && rf == r1){
                            r2 = jfgrid.getNextIndex("up", cf, r1, r2);
                        }
                        else{
                            r1 = jfgrid.getNextIndex("up", cf, 0, r1);
                        }
                    }
                }
                else if(postion == "right"){
                    if(c2 == jfgrid.flowdata[0].length - 1){
                        return;
                    }

                    if(jfgrid.colHasMerge(cf, r1, r2)){ //focus所在行有合并单元格
                        var cfMerge = jfgrid.getColMerge(cf, r1, r2);
                        var cf_str = cfMerge[0], cf_end = cfMerge[1];

                        if(cf_str > c1 && cf_end == c2){
                            c1 = jfgrid.getNextIndex("right", rf, c1, c2);
                        }
                        else{
                            c2 = jfgrid.getNextIndex("right", rf, c2, jfgrid.flowdata[0].length - 1);
                        }
                    }
                    else{
                        if(cf > c1 && cf == c2){
                            c1 = jfgrid.getNextIndex("right", rf, c1, c2);
                        }
                        else{
                            c2 = jfgrid.getNextIndex("right", rf, c2, jfgrid.flowdata[0].length - 1);
                        }
                    }
                }
                else if(postion == "left"){
                    if(c1 == 0){
                        return;
                    }

                    if(jfgrid.colHasMerge(cf, r1, r2)){ //focus所在行有合并单元格
                        var cfMerge = jfgrid.getColMerge(cf, r1, r2);
                        var cf_str = cfMerge[0], cf_end = cfMerge[1];

                        if(cf_end < c2 && cf_str == c1){
                            c2 = jfgrid.getNextIndex("left", rf, c1, c2);
                        }
                        else{
                            c1 = jfgrid.getNextIndex("left", rf, 0, c1);
                        }
                    }
                    else{
                        if(cf < c2 && cf == c1){
                            c2 = jfgrid.getNextIndex("left", rf, c1, c2);
                        }
                        else{
                            c1 = jfgrid.getNextIndex("left", rf, 0, c1);
                        }
                    }
                }

                var rowseleted = [r1, r2];
                var columnseleted = [c1, c2];

                var row = visibledatarow[r2], row_pre = r1 - 1 == -1 ? 0 : visibledatarow[r1 - 1];
                var col = visibledatacolumn[c2], col_pre = c1 - 1 == -1 ? 0 : visibledatacolumn[c1 - 1];

                var changeparam = jfgrid.menuButton.mergeMoveMain(columnseleted, rowseleted, last, row_pre, row - row_pre - 1, col_pre, col - col_pre - 1);
                if(changeparam != null){
                    columnseleted = changeparam[0];
                    rowseleted= changeparam[1];
                    // top = changeparam[2];
                    // height = changeparam[3];
                    // left = changeparam[4];
                    // width = changeparam[5];
                }

                last["row"] = rowseleted;
                last["column"] = columnseleted;

                jfgrid.selectHightlightShow();

                //图表
                if (jfgrid.chartparam.jfgrid_chart_data_select_state) {
                    $("#jfgrid-datavisual-range-selection-input").val(jfgridfile[jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex)].name + "!" + jfgrid.jfgridchatatABC(last["column"][0]) + (last["row"][0] + 1) + ":" + jfgrid.jfgridchatatABC(last["column"][1]) + (last["row"][1] + 1));
                }
            }
            else if(type == "rangeOfFormula"){
                var last = jfgrid.formula.func_selectedrange;
                var rf = last["row_focus"], cf = last["column_focus"];

                var r1 = last["row"][0], r2 = last["row"][1];
                var c1 = last["column"][0], c2 = last["column"][1];

                if(postion == "down"){
                    if(r2 == jfgrid.flowdata.length - 1){
                        return;
                    }

                    if(jfgrid.rowHasMerge(rf, c1, c2)){ //focus所在行有合并单元格
                        var rfMerge = jfgrid.getRowMerge(rf, c1, c2);
                        var rf_str = rfMerge[0], rf_end = rfMerge[1];

                        if(rf_str > r1 && rf_end == r2){
                            r1 = jfgrid.getNextIndex("down", cf, r1, r2);
                        }
                        else{
                            r2 = jfgrid.getNextIndex("down", cf, r2, jfgrid.flowdata.length - 1);
                        }
                    }
                    else{
                        if(rf > r1 && rf == r2){
                            r1 = jfgrid.getNextIndex("down", cf, r1, r2);
                        }
                        else{
                            r2 = jfgrid.getNextIndex("down", cf, r2, jfgrid.flowdata.length - 1);
                        }
                    }
                }
                else if(postion == "up"){
                    if(r1 == 0){
                        return;
                    }

                    if(jfgrid.rowHasMerge(rf, c1, c2)){ //focus所在行有合并单元格
                        var rfMerge = jfgrid.getRowMerge(rf, c1, c2);
                        var rf_str = rfMerge[0], rf_end = rfMerge[1];

                        if(rf_end < r2 && rf_str == r1){
                            r2 = jfgrid.getNextIndex("up", cf, r1, r2);
                        }
                        else{
                            r1 = jfgrid.getNextIndex("up", cf, 0, r1);
                        }
                    }
                    else{
                        if(rf < r2 && rf == r1){
                            r2 = jfgrid.getNextIndex("up", cf, r1, r2);
                        }
                        else{
                            r1 = jfgrid.getNextIndex("up", cf, 0, r1);
                        }
                    }
                }
                else if(postion == "right"){
                    if(c2 == jfgrid.flowdata[0].length - 1){
                        return;
                    }

                    if(jfgrid.colHasMerge(cf, r1, r2)){ //focus所在行有合并单元格
                        var cfMerge = jfgrid.getColMerge(cf, r1, r2);
                        var cf_str = cfMerge[0], cf_end = cfMerge[1];

                        if(cf_str > c1 && cf_end == c2){
                            c1 = jfgrid.getNextIndex("right", rf, c1, c2);
                        }
                        else{
                            c2 = jfgrid.getNextIndex("right", rf, c2, jfgrid.flowdata[0].length - 1);
                        }
                    }
                    else{
                        if(cf > c1 && cf == c2){
                            c1 = jfgrid.getNextIndex("right", rf, c1, c2);
                        }
                        else{
                            c2 = jfgrid.getNextIndex("right", rf, c2, jfgrid.flowdata[0].length - 1);
                        }
                    }
                }
                else if(postion == "left"){
                    if(c1 == 0){
                        return;
                    }

                    if(jfgrid.colHasMerge(cf, r1, r2)){ //focus所在行有合并单元格
                        var cfMerge = jfgrid.getColMerge(cf, r1, r2);
                        var cf_str = cfMerge[0], cf_end = cfMerge[1];

                        if(cf_end < c2 && cf_str == c1){
                            c2 = jfgrid.getNextIndex("left", rf, c1, c2);
                        }
                        else{
                            c1 = jfgrid.getNextIndex("left", rf, 0, c1);
                        }
                    }
                    else{
                        if(cf < c2 && cf == c1){
                            c2 = jfgrid.getNextIndex("left", rf, c1, c2);
                        }
                        else{
                            c1 = jfgrid.getNextIndex("left", rf, 0, c1);
                        }
                    }
                }

                var rowseleted = [r1, r2];
                var columnseleted = [c1, c2];

                var row = visibledatarow[r2], row_pre = r1 - 1 == -1 ? 0 : visibledatarow[r1 - 1];
                var col = visibledatacolumn[c2], col_pre = c1 - 1 == -1 ? 0 : visibledatacolumn[c1 - 1];

                var top = row_pre, height = row - row_pre - 1;
                var left = col_pre, width = col - col_pre - 1;

                var changeparam = jfgrid.menuButton.mergeMoveMain(columnseleted, rowseleted, last, top, height, left, width);
                if(changeparam != null){
                    columnseleted = changeparam[0];
                    rowseleted= changeparam[1];
                    top = changeparam[2];
                    height = changeparam[3];
                    left = changeparam[4];
                    width = changeparam[5];
                }

                jfgrid.formula.func_selectedrange = {
                    "left": left,
                    "width": width,
                    "top": top,
                    "height": height,
                    "left_move": left,
                    "width_move": width,
                    "top_move": top,
                    "height_move": height,
                    "row": rowseleted,
                    "column": columnseleted,
                    "row_focus": rf,
                    "column_focus": cf
                };

                $("#jfgrid-formula-functionrange-select").css({
                    "left": left,
                    "width": width,
                    "top": top,
                    "height": height
                }).show();

                jfgrid.formula.rangeSetValue({
                    "row": rowseleted,
                    "column": columnseleted
                });
            }

            var scrollLeft = $("#jfgrid-cell-main").scrollLeft();
            var scrollTop = $("#jfgrid-cell-main").scrollTop();
            var winH = $("#jfgrid-cell-main").height(), winW = $("#jfgrid-cell-main").width();

            var sleft = 0, stop = 0;
            if (col - scrollLeft - winW + 20 > 0) {
                sleft = col - winW + 20;
                if (isScroll) {
                    $("#jfgrid-scrollbar-x").scrollLeft(sleft);
                }
            }
            else if (col_pre - scrollLeft - 20 < 0) {
                sleft = col_pre - 20;
                if (isScroll) {
                    $("#jfgrid-scrollbar-x").scrollLeft(sleft);
                }
            }

            if (row - scrollTop - winH + 20 > 0) {
                stop = row - winH + 20;
                if (isScroll) {
                    $("#jfgrid-scrollbar-y").scrollTop(stop);
                }
            }
            else if (row_pre - scrollTop - 20 < 0) {
                stop = row_pre - 20;
                if (isScroll) {
                    $("#jfgrid-scrollbar-y").scrollTop(stop);
                }
            }

            clearTimeout(jfcountfuncTimeout);
            jfcountfunc();
        }
        jfgrid.jfgridMoveHighlightRange2 = jfgridMoveHighlightRange2;

        var jfgridRangeLast = function (obj) {
            var range;
            if(document.createRange){ //chrome, firefox, opera, safari, ie9+
                if(obj.innerHTML != obj.innerText || obj.innerHTML == ""){
                    obj.focus(); //解决ff不获取焦点无法定位问题
                    range = window.getSelection();//创建range
                    range.selectAllChildren(obj);//range 选择obj下所有子内容
                    range.collapseToEnd();//光标移至最后
                }
                else{
                    var len = obj.innerText.length;

                    range = document.createRange();
                    range.selectNodeContents(obj);
                    range.setStart(obj.childNodes[0], len);
                    range.collapse(true);

                    var selection = window.getSelection();
                    selection.removeAllRanges();
                    selection.addRange(range);    
                }
            }
            else if(document.selection){ //ie8 and lower
                range = document.body.createTextRange();
                range.moveToElementText(obj);
                range.collapse(false);
                range.select();
            }

            // if (window.getSelection) {//ie11 10 9 ff safari
            //     obj.focus(); //解决ff不获取焦点无法定位问题
            //     var range = window.getSelection();//创建range
            //     range.selectAllChildren(obj);//range 选择obj下所有子内容
            //     range.collapseToEnd();//光标移至最后
            // }
            // else if (document.selection) {//ie10 9 8 7 6 5
            //     var range = document.selection.createRange();//创建选择对象
            //     //var range = document.body.createTextRange();
            //     range.moveToElementText(obj);//range定位到obj
            //     range.collapse(false);//光标移至最后
            //     range.select();
            // }
        }

        function getCursortPosition(textDom){
            var cursorPos = 0;
            if(document.selection){
                textDom.focus();
                var selectRange = document.selection.createRange();
                selectRange.moveStart("character", -textDom.value.length);
                cursorPos = selectRange.text.length;
            }
            else if(textDom.selectionStart || textDom.selectionStart == "0"){
                cursorPos = textDom.selectionStart;
            }
            return cursorPos;
        }

        jfgrid.jfgridRangeLast = jfgridRangeLast;

        $("#jfgrid-copy-btn, #jfgrid-cols-copy-btn, #jfgrid-paste-btn-title").click(function (event) {
            $(this).parent().hide();

            //复制范围内包含部分合并单元格，提示
            if(config["merge"] != null){
                var hasPartMC = false;

                for(var s = 0; s < jfgird_select_save.length; s++){
                    var r1 = jfgird_select_save[s].row[0], r2 = jfgird_select_save[s].row[1];
                    var c1 = jfgird_select_save[s].column[0], c2 = jfgird_select_save[s].column[1];

                    hasPartMC = jfgrid.hasPartMC(config, r1, r2, c1, c2);

                    if(hasPartMC){
                        break;
                    }
                }

                if(hasPartMC){
                    if(jfgrid.isEditMode()){
                        alert("无法对部分合并单元格执行此操作");
                    }
                    else{
                        jfgrid.tooltip.info("无法对部分合并单元格执行此操作", ""); 
                    }
                    return;    
                }
            }

            //多重选区 有条件格式时 提示
            var cdformat = jfgridfile[jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex)].jfgrid_conditionformat_save;
            if(jfgird_select_save.length > 1 && cdformat != null && cdformat.length > 0){
                var hasCF = false;

                var cf_compute = jfgrid.conditionformat.getComputeMap();

                label:
                for(var s = 0; s < jfgird_select_save.length; s++){
                    if(hasCF){
                        break;
                    }
                    
                    var r1 = jfgird_select_save[s].row[0], r2 = jfgird_select_save[s].row[1];
                    var c1 = jfgird_select_save[s].column[0], c2 = jfgird_select_save[s].column[1];

                    for(var r = r1; r <= r2; r++){
                        for(var c = c1; c <= c2; c++){
                            if(jfgrid.conditionformat.checksCF(r, c, cf_compute) != null){
                                hasCF = true;
                                continue label;
                            }
                        }
                    }
                }

                if(hasCF){
                    if(jfgrid.isEditMode()){
                        alert("无法对多重选择区域执行此操作");
                    }
                    else{
                        jfgrid.tooltip.info("无法对多重选择区域执行此操作", "");
                    }
                    return;
                }
            }

            //多重选区 行不一样且列不一样时 提示       
            if(jfgird_select_save.length > 1){
                var isSameRow = true, str_r = jfgird_select_save[0].row[0], end_r = jfgird_select_save[0].row[1];
                var isSameCol = true, str_c = jfgird_select_save[0].column[0], end_c = jfgird_select_save[0].column[1];
                
                for(var s = 1; s < jfgird_select_save.length; s++){
                    if(jfgird_select_save[s].row[0] != str_r || jfgird_select_save[s].row[1] != end_r){
                        isSameRow = false;
                    }
                    if(jfgird_select_save[s].column[0] != str_c || jfgird_select_save[s].column[1] != end_c){
                        isSameCol = false;
                    }
                }

                if((!isSameRow && !isSameCol) || jfgrid.selectIsOverlap()){
                    if(jfgrid.isEditMode()){
                        alert("无法对多重选择区域执行此操作");
                    }
                    else{
                        jfgrid.tooltip.info("无法对多重选择区域执行此操作", "");  
                    }
                    return;
                }    
            }
            
            jfgrid.selection.copy(event);
        });

        $("#jfgrid-copy-paste, #jfgrid-cols-paste-btn, #jfgrid-paste-btn-title").click(function (event) {
            jfgrid.selection.paste(event, "btn");
            $(this).parent().hide();
        });

        $("#jfgrid-chart-btn-title").click(function () {
            $("#jfgriddatavisual").click();
        });

        $("#jfgrid-pivot-btn-title").click(function (e) {
            jfgrid.pivotTable.createPivotTable(e);
        });

        $("#jfgrid-selectall-btn-title").click(function () {
            $("#jfgrid-left-top").trigger("mousedown");
            $(document).trigger("mouseup");
        });

        $("#jfgrid-download-btn-title").click(function () {
            if(jfgrid.isEditMode()){
                alert("正在下载！");
            }
            else{
                jfgrid.tooltip.info("正在下载！", ""); 
            }
        });

        //截图
        $("#jfgrid-chart-btn-screenshot").click(function () {
            if(jfgird_select_save.length == 0){
                if(jfgrid.isEditMode()){
                    alert("请框选需要截图的范围");
                }
                else{
                    jfgrid.tooltip.info("提示！", "请框选需要截图的范围"); 
                }
                return;
            }

            if(jfgird_select_save.length > 1){
                if(jfgrid.isEditMode()){
                    alert("无法对多重选择区域执行此操作");
                }
                else{
                    jfgrid.tooltip.info("提示！", "无法对多重选择区域执行此操作");  
                }

                return;
            }

            //复制范围内包含部分合并单元格，提示
            if(config["merge"] != null){
                var hasPartMC = false;

                for(var s = 0; s < jfgird_select_save.length; s++){
                    var r1 = jfgird_select_save[s].row[0], r2 = jfgird_select_save[s].row[1];
                    var c1 = jfgird_select_save[s].column[0], c2 = jfgird_select_save[s].column[1];

                    hasPartMC = jfgrid.hasPartMC(config, r1, r2, c1, c2);

                    if(hasPartMC){
                        break;
                    }
                }

                if(hasPartMC){
                    if(jfgrid.isEditMode()){
                        alert("无法对合并单元格执行此操作");
                    }
                    else{
                        jfgrid.tooltip.info("提示！", "无法对合并单元格执行此操作");
                    }
                    return;    
                }
            }

            var st_r = jfgird_select_save[0].row[0], ed_r = jfgird_select_save[0].row[1];
            var st_c = jfgird_select_save[0].column[0], ed_c = jfgird_select_save[0].column[1];

            var shotData = jfgrid.datagridgrowth([], ed_r + 1, ed_c + 1);

            for(var r = st_r; r <= ed_r; r++){
                for(var c = st_c; c <= ed_c; c++){
                    shotData[r][c] = jfgrid.flowdata[r][c];
                }
            }

            if(st_r - 1 < 0){
                var scrollHeight = 0;
                var rh_height = visibledatarow[ed_r];
            }
            else{
                var scrollHeight = visibledatarow[st_r - 1];
                var rh_height = visibledatarow[ed_r] - visibledatarow[st_r - 1];
            }

            if(st_c - 1 < 0){
                var scrollWidth = 0;
                var ch_width = visibledatacolumn[ed_c];
            }
            else{
                var scrollWidth = visibledatacolumn[st_c - 1];
                var ch_width = visibledatacolumn[ed_c] - visibledatacolumn[st_c - 1];
            }

            var newCanvas = $("<canvas>").attr({ width: Math.ceil(ch_width * devicePixelRatio), height: Math.ceil(rh_height * devicePixelRatio) }).css({ width: ch_width, height: rh_height });

            var d = jfgrid.flowdata;
            jfgrid.flowdata = shotData;

            jfgridDrawMain(scrollWidth, scrollHeight, ch_width, rh_height, 1, 1, null, null, newCanvas);
            // jfgridDrawMain(scrollWidth, scrollHeight, ch_width, rh_height, 0, 0, null, null, newCanvas);

            jfgrid.flowdata = d;
            jfgrid.editor.webWorkerFlowDataCache(jfgrid.flowdata);//worker存数据

            var image = new Image();
            var url = newCanvas.get(0).toDataURL("image/png");
            image.src = url;

            if(ch_width > rh_height){
                image.style.width = "100%";
            }
            else{
                image.style.height = "100%";
            }

            var maxHeight = $(window).height() - 200;
            jfgrid.tooltip.screenshot("截取成功！", '<div id="jfgrid-confirm-screenshot-save" style="height:'+ maxHeight +'px;overflow:auto;"></div>', url);
            $("#jfgrid-confirm-screenshot-save").append(image);
            newCanvas.remove();
            //newCanvas.appendTo("body");
        });
        $(document).on("click", "a.download", function(){ //截图下载
            var dataURI = $("#jfgrid-confirm-screenshot-save img").attr("src");

            var binStr = atob(dataURI.split(",")[1]),
                len = binStr.length,
                arr = new Uint8Array(len);

            for(var i = 0; i < len; i++){
                arr[i] = binStr.charCodeAt(i);
            }

            var blob = new Blob([arr]);

            var element = document.createElement('a');
            element.setAttribute('href', URL.createObjectURL(blob));
            element.setAttribute('download', '截图.png');

            element.style.display = 'none';
            document.body.appendChild(element);

            element.click();

            var clickHandler;
            element.addEventListener('click', clickHandler=function(){
                requestAnimationFrame(function(){
                    URL.revokeObjectURL(element.href);
                });    

                element.removeAttribute('href');
                element.removeEventListener('click', clickHandler);
            })

            document.body.removeChild(element);
        })

        $("#jfgrid-share-btn-title").click(function () {
            var savedata = [];
            for (var i = 0; i < jfgridfile.length; i++) {
                var charts = jfgridfile[i].chart;
                if (charts == null) {
                    continue;
                }
                for (var c = 0; c < charts.length; c++) {
                    var chart = charts[c];
                    var data = jfgrid.getdatabyselectionD(jfgridfile[i].data, { "row": eval('(' + chart.row + ')'), "column": eval('(' + chart.column + ')') });
                    savedata.push([chart.defaultOption, chart.selfOption, chart.chartType, chart.chartStyle, chart.chartMarkConfig, chart.chartTitleConfig, data]);
                }
            }

            jfgrid.tooltip.info("正在发布数据", '<div style="width:100%;text-align:center;position:relative;top:45%;font-size: 16px;"> <div class="jfgridLoaderGif"> </div><span>正在准备！请稍后</span></div>');
            $.post("../Home/seth5js", { "text": JSON.stringify(savedata) }, function (data) {
                if (data == "0") {
                    if(jfgrid.isEditMode()){
                        alert("发布数据失败, 请稍后再试！");
                    }
                    else{
                        jfgrid.tooltip.info("发布数据失败", '请稍后再试！');
                    }
                }
                else {
                    var img = '<img src = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAYAAAB5fY51AAAgAElEQVR4nO3df2wk91038PfaPt8P3+R+5JJLd5IrKTTZhOOg5DZP9unzUFq3txS1OiOsCKEsaKEV4gTxI6qni2DFH4/8qM+W53kk949FKUhLZQRIWGAkquIjBtRSuWQDBfUaljbJNUl3Q5pr4rtJfD7bO8Mf9m721jO7M975fma+6/dLihTvrec7M9/5fjzf3wnHcRwQEWlgJOoTICLyiwGLiLTBgEVE2mDAIiJtMGARkTYYsIhIGwxYRKQNBiwi0gYDFhFpgwGLiLTBgEVE2mDAIiJtMGARkTYYsIhIGwxYRKQNBiwi0gYDFhFpgwGLiLTBgEVE2mDAIiJtMGARkTYYsIhIGwxYRKSNMdUJnD17tu93rly5Eug4uVwOhUIhULpzc3OYnJz0/H61WkU+n2//vLS0BNM0e6ZRLpdRLpcBAIZhYGVlpef3Z2ZmsLy83P45nU6jUqn0/J1sNot6vd7+ud+9siwLmUym/XOlUkE6ne75O933ql8andft5/vdaVy6dAmXLl0KdE5B829lZQWGYfRMo/M6TNPE0tJSz+/n83lUq9X2z5OTk5ibm+v5O5lMBpZltX/ud6/q9Tqy2Wz7ZxX5VyqVMD8/7/v7bmm48XOug9LyDavzofHr2Wef7fnvnUEBAGq1Wt9jNhqN9v9blrXrGN26j9n5+278HLPbM8880zPNMOzl/g/6+/3yr/s6u++Dm877X6/Xbwss/b7vlmY3P8fs1n3MoPnvx6D5F6VYBKxsNuuZsZZl3fYXB9jO1M6/pt3cHqTOvyhuisXibT/PzMz0zNhSqYTFxcXbPpuenu6ZRvfD1+9hvHDhQt/z7FStVjEzM7PrPHtde+ebUkuvguh2X4Lmn9t59ku/X/6VSqW+59mpWCzuyj+3+90paP65PQ/d59nJ7b64nWenoPmXz+d3/XvQ/ItSLAJWvV73DED5fN71wfB6GGu1mmdh8Mp4r2M9+eSTnoXHrQB5vRFZluUZaIrFouvDYlmW6+eLi4uehffJJ590/dyrkCwuLro+8G4PdUtnlbZlL/nndhyg9x8jr/zz+twr/8rlsuvveN3zveSf19uV17PTOl83QfNvZmbGM//cnvW95F9UEo7jOCoT8FP37ZZKpQJVZdLpNBqNRqAbm06nA70aG4YR+PU+6HWkUikAwapxpmkGvu5areb7WkzTRDKZDHSvVOefYRhIpVKxzL+g1fhhyL8WiTasWAYsItIPG92JiDowYBGRNhiwiEgbytuwWroHQBKR/vwMuA2T2BvWwsJCuxeMiPSXSqWwsLAgmqbYG1ZLr15DP1MEiEhO3Mor27CISBviAYvVQiL9RVWOxQOWism4RCQrqnLMKiERaUMsYFmW1Xc1AyLSx/T0dOD5mYMSC1jT09OsDhINkVqtJv4SEosVR4lIT/V6vV3GOfmZiKgDAxYRaUN5wMrlchx7RTTEUqkUcrkcksmk8rTEpuZ07zjiJshQ/0QiMegpKeN1S4Oc86DZ4pWWqnMLkl7Qc1Nl0HMO415KC3qP+7VB+9n5KUzKG91bWhfFRnii4cC5hEREPYgHLNXdnkSkXlTlWDxg9ds8lIjiL6pyLNaG1aJy1VHpRltg8AbWoOfsN72gDcJBzkPVNUt2SoR1HmGkp4rKxv+oVg8WfcPi1Byi4RFFeRYLWL12ZCYi/fTaYVqVWG2kOug4rLhUCYNUNYa9ShiH4wYVh3schjCetyDll3MJiYg6MGARkTYYsIhIG8qHNczNzeHZZ5/F/Py86qR6kh5+4JeqrmfpuYRBzsPr94OcWxjnG8b8x0GFcdwo2m475XI5nD9/XmSRA9F9CRcXF1EsFj3/XWWju+TYoThPio1zwApyjCBUBay4BEKVnTy9Gt1nZ2cxNTUV6HiDEq0SSl8cEakTRXkWb8MyDEM6SSIaEtxIlYgCi2rys/hcwn6L+A2zMAZR+j2GdHuZysGSg7b9xKHtcNhEVY45rIGItCEasPbz2xXRsImiPCuvElarVdTr9Z7DGYhIP/l8HsD28AbTNJFKpZR3qu2byc9xGIcVhKo2rDhsQhEGle1SHIf1jrhNfhZvdKfbxaWgBylMgzZ4x2XxvahHiFNwbHQnIm0of8NaWlri4n1EQ2xubg6pVAqmaSpPS/kblmmamJycRKVS4Sh3oiFiGAYqlQomJydFghUgWCWU3iGWiNSSaGTvJtqGxWk5RMMjivIs3ktommYkWwTFoUcojC5sv71ucV/CJQhVQy7CSG9QcXgu9yKq5h3xXsKo9jMjovBYlhVJuhzWQETaEA1YUS+TTEThiaI8iwWsUqmEUqkklRwRKRZFmVbe6F4ul9FoNLC4uKg6KSISNj8/D8uykEwmcfHiReXjsUQClhQdF2rTcYMEye96UbkpiKpJyjo+n360XkbS6bTygMVGdyLShvKAxek4RMPPMAyRsq68SriysoJ6vY7p6enIxm4QkRqGYWBhYUFsLqHISHfTNNuBK5vNSiRJRIotLS2JBaoW0ak5YV6crlMauoWxMqh0Y3UQ0rvbxOG5iMM5SJAOVgAb3YlII9xIlYgCi6ociwesWq0mnSQRhSyqciwasNhLSDQ8oijPogGLcwmJhkcU5Vn5voQzMzOo1Wq+1sEKsi9hUHHYl1By2kgYC/gN856CQY/hRrpXM4peVD/7ErY2Uf30pz+t/9Sc5eVlLtpHNMTq9TqWl5fRaDSUp8VhDUSkDQYsItKG8pHu6XQajUaD1UKiIWWaJpLJpMjkZ+WN7p2KxWLPhfyCNLrHpSFV1dpJQdJzE8aUnyBU7poz6D1WtYOQyo4NldcXRK9G96mpKczOzipL241olbBQKEgmR0QKRVGeRQMW18YiGh5RlGfOJSSiwPbNXEJOzyGiveLOz0QUWFSTn0UX8FP9dhVGb4mqHiWvY0vvxhKX3W2GmXR+RNWjaFmWeDuWSMCyLAsXLlxgdZBoiGQyGRiGgcuXL4sFLuVVwmw2i0wmw2BFNIQsy0Imk0E2mxWpJioPWGyzIhp+9Xpd5KWEcwmJSBsMWESkDeWN7q35gf3mEarmdx5X0J6xQRdgCzqXbNB5btI9SqrSU3luqno2pedESpCeTyg2rGF2dhbJZBLlclkqSSJSqFAoIJfLiaYpuloD0Hv296CrNfS6FFVvWEGomq3vJoyll8MQ5zcIVfdCeqybSmGV17CwDYuItCEesLhiA5H+otimHhCemgOonZ4TtBolvdtMGFWCOOz+4/f3wzgHlecR5BiSDfFe5xDWscMQ1fhKVgmJSBtiAatarSKTyUglR0SKZTIZVKtV0TSVByzLsrC8vIx8Ps/5hERDxLIs5PN5LC8vi5Vt5cMa/Owc26JyEwq/pHdMVtWGFZfrcBP3NixV5xD3XZ7dBCm/lUoF6XR64DR7EW90D0sc1pYKeh6SAUB6958gQUjl/ZEMCmH8sYnLeCtdsNGdiLSh/A2rUqmgVquhVCqpToqIIlAoFJBKpUQ2phDZ+TmdTsMwDBSLRdXJkRC/VRmV44woetLzCbWdS+gmikIwaBtWHHZGDnKMsB+XzjTi3IalatBv3AeOxm0uobaN7iRL9UhvvnGRH+IBK51OKxtsFnS1hjCOHdeenyh2EAorre57Kj28QtXvq0ovyNppYeWp6uELXsR7CaPaz4yIwhNVOebOzxQ7juPE4i2VvEVVjkUDVpRLJJN+GLjiLYryLBawyuUyhzUQDZFisSi+5Lm2cwmDimuje1y6r3Uz7PdN1RCIoNfMuYQhicMk1718P+zf9xLntdT3aq95rmoieBhj3aS/qzvOJdzHdGsj0ulcSQ0GLNIKg9b+JraRaq1W4yJ+MaJzwXcchyPjY8AwDFQqFZFJzy1ib1ipVAqVSkUqOepB52DVMgzXoDvpYAUIN7qrvjjprdXDIL0y6DAVdL/XEue3sThMlN8r6WAFRNBLaJpmZFsEUfzYjoOXrQ389dVVvP72BlbXN3H84CjMiXGcu3sC504fxfgom1rjZt/sS5hMJhmw9rG/uHodf/L8KpZfXoXTtAEHMEaAT/34aXz43cdw7q4JTIyPRn2a1EcymYwkXfGAJb0tEL0jyurgtfUtPFV7E6V/fg0jdhMJx0HugZP42P3H8d+SR9G0Hbywuo6nr76J515/C6vrmxgFcPLQGN5/5jjO3WNgYlzbYYNDJ6pyzCeAlPufz7yGLzy/irVbWxizm/jJ5FH84oMn8dg9E/iH797Ab3/lJSw89z1sbNmA7cCxmxhxHIw4Nhzbwf9t2jgyCrz/zAnM//wjUV8ORUgsYM3MzGB5eVkqOeoi/Xb1J1dv4Hf++Xt45e0tHLSb+IUfOo5fTp3Ab3z5FXzllRv4h5dWMWY3AWcnSG3ZsB0bCcfBmN2EYzuwbQdwHBx0bPzS+TP4jQ+8V/QaqLezZ89icnISc3NzYmkqn0tYLpdRrVZ9vULGYV/CoKS3+dprz5hkwPrWjQ2c+8urgOMg4Tj4fOYefKVh4a9efBPrmzZG7O3/Rp3twOTYDuzmdjVxxHGQaG5/jp23rL/7lf+KB+86uufzUZUfKnt447IwpJ+5hK19Gy5evKi8MV7byc8MWP5/f9Asfu2WjW/e2MJz1hb+5j/W8craFlY3bKze2oTj2Gg6QMoYxZnDozh1cAR//OINbGw0cWp8BB++5zAWn38DiZ3gNdLcCVhwgFZg6qoG2ls2joyNYOqhu/GJR8/g4dPGQOfPgLV3nPxMsWdtOfj4167jxbeb2MB2QIHjoGnbWN+yAceB49jYbDbRtB3YjoN/uraBrzsORne+O9Zs4sbaFhafv4kRe7s3cMS2MWY3kdhpm2pVA4+OJfBL70visfuO47H7jsM4yMeS3PHJoLYN28EfvXILv3f1Jl67ZW8HK2f7L7tt29jYCUZwbMCx28EKO1W5VrBqVe1avYHG2AiOHxjBOBz8gHEYx8ZH8a6JcbzfvAM/dPIwzhw7xLFW5IvYXMJsNsvxVzE39TULtbe20ASwge3YhI5gZdvbb1ZwbGzaDh6/7wgevmMcZ46M4r4jo9hoOnh1bQtff30NX3ju9XY18NjYCL78+EM4xjenoWOaJpaWlsTSE9uX0LIs5PP5novX69iG5UblQmsq2jY+/52b+Oy317G5s9xMqxro7FQDb23ZGIWDx+89jM+fP+nrmI/86Tdx9frGTjVwC7mH78LvfvA9A53nXoWxf2AY4rqHZS+92rBa84MNY7A2xiDE3sMNw8DCwoJUcuTTX756C5/99jrsdrBCuxrYtG1sNB3cf2QEl3/ilO9gtWU77WA1Ym8PVfiRUxNKr4PkLSwsiAYrgG1Y+9oLbzVR/Lc12A46qoHb1bhWsHIcB3/7gbtx6qC/6TL/em0Nha9+tx2sRmDjA/fegZ97+C6l10L7g3jASqVS3JswJv73t9bw9hbQhPPO6qOtN62dYDUKx1ew+uqrb+GpK6/ji1dX4TjA2E6wGoWDP/xYio3qQyaKlRqACAIWg1V8LF/bhO042MRO24Ztt9+sbNtGwrHxgHF7sPr9b6/iu29t4sUbG/jSS9exsWVjxG62hy4chIPzdx3BUxfuR/LowWgujJSLqhyzSriPbQcrp90b2A5WO0MXHMfGv642b/udn7nvKL7+xjpOHxrFyTFgbbMJYyyBcycP473HD+LcqSMwuNoCKSIWsFq9hFEZtNdFeusuCZ3BCh3VwNZYq03bQdN28OmvX8Nv/fAJHB8fxalDY/hI8ig+EmB1kX/87ipeevMm0uYx3H/yiJJrad1zVbMJVPXwBhHGyPowTU9Pi/cSig1r8DMOS+WwBt0ClsSwhnu+9PptvYGOvT3Gyna2hzK0BoWO2k2M2tsj3A80bRw/kMBd4wnceWBku5G+6eDaW+tY39zC6voWbNtB7VfSOPt7X4PdbOIT70vi46m78ei9x/d0nn70ClhxeVakt14L41npNzVHehyW8jesIHORSNZtwWrnrcreebNqBauE806wSjhAwnFgrW/hrZsOvmPbGGluz/87lLAxPpLAe44dwrm7J3Di8AFc+dXHAAAnDh9wTf/VGzfx9L+/hofvuQOP3OdvyATFS71eb5dxziUkpZrN7RHsrWqg3VEN3A5QNkZ2qoyJnZ6/wwkb5Q+ewYPHD+HQaAITB0aQAGAcGL1tpdAX3ljD899fw8urN/HJ9H270m5cv4nH/v/TeHtjE0+cfzcDFvnCgLWPzaeP4/GV77ffrNa37Pab1qht31YNTOzMDdy0bXzy6asYaToYc7baE6O/8YlH8Jmvfgef/6c6Rh0bP376KH70tIH0vccAAOtbTTz78ps4f98JPPyZL6HZdPD3v/5BvOfU3peNof1HecC6dOmS7/WwgpBuq5Buwwjzu17n89F7DuGT9x/BUy/cwKb9TrUw4di7qoGticxwnHY18GPvOQHjwAiOHhjFnYcPYPaDP4hL5+/FCIB7jIOwHQcvfP9t/Nqf/wue/tb3cGNtA43/9TFUP/URHBwbxVEFcwsHXcIl6DFUCeN5kzrn1npYEuu8iwQsgCuORimRSHg+vP/n3HE0bm7iz15+ux2suquBrWCV6AhWI7DxBx994LZjXV/fxGvWOmrX1vAX33gVz/3Hdbzx9i0kbBuHRoGffug0AODOCY7PGhZDt+Jot16N8EF6Cd30+qskuYed9KRaP/xcf3LhBbxxc3NXNXDEtnHq4BgeOj6OxvU13FjfwvpmE81NG5l7DfzZ9I/A/Ozf4UAigdMTB/DAnRN44seSeOTeYzg1cRAvv7mGv//29/DFb9bxmx95GO+790To17eXvI9Dr10YVBZhleV1L9iGtU/0estqufLxH8DvfuP7+P1/fwMbW7dXA2cfS+LxB+8EsD25eaNpAwAOjW1PufnW//jvSCQSOHJgu+H9+vomvvriNXz5hWv4wjMvYqvpYHwsgffeFf6YHV3GvdHgxANWOp3mVl8xdfLgKD5z/m586uxJfPyLL6D2xhYSjoPRpoNff/pFPPUvDfzUu4/h+MEx3DE+ihEACThIAHhjbQOHRkfwE/efxLtPHMEj/28Za7e2AMfBhx84jY8+9C589OF3KWm3Inmqhy94EX96Go2GdJK0w89bFgCcOjSGlZ99sP2z7Ti4traJq9fXsfLKdby0ehOrNzexvrG5vfio4+DMHQfx3jsn2gHp+d/+KWXX0YlvV9GIqhyLB6ywVh2Nw6YAe0nTr0HbXcI8r5FEAndPjOPuiXH8l+QdoR03DCru/6DtnUHOSWXbmMq2rahWDxZd84MrNRANjyjKs1jAqtVqkU5+JqJw9VvyXAXOJSSiPbEsC9PT0+2fJeYSchlIItIGAxYRaWNfD4oJYz6i9KJsqo4xLCTnfAa973GYj6j7s6L8DWtubg65XE51MkQUkVwuh0qlIrIxhehcwsXFRRSLRc9/H3TF0TjP9/KicuzYfhTnNyxVVM6J7NVpNjs7i6mpqUDHG5RoG5b0xRGROlGUZ/FGd+mdYokofFGV40g2UlU1+TmKpWFUVQuiTi8u1Z0whJGnbt8NmkfS1XmVx943G6lypQY9dBauYQpeFI6oyjHHYVFfXBGB4kI0YC0uLkomRyFKJBIMXHSbKMqz8mEN1WoVtVoNpVKp73dVbqTqF9uw9iYu7TaqlgxSNVwi7svL+JkLXCgUkEqlkEqllDfGKw9YQSY/M2DFLz2/GLD2lt4wBKwWbqTaQ9CHatCeHy/SU3PiMKhx0GOHsR1bGOnFIfiHETTj8sdCAhvdiUgbygPWysqK6L5lRCRrbm4OKysrIhtTKA9YhmFgcnISlUqFo9yJhohhGKhUKpicnBQr22JVwnQ6jUqlIpUcESkm0cjeTbTRPczh/EEbFAdtgFTVo6SqAVplQ/OgPWYqz03V9Uk3gqucZhaWKKbniDe6m6YpnSQRhSyq5h3xgBXVfmZEFB7LsiJJl8MaiEgbogFrfn5eMjkiUqhcLounKdboXiwWOfmZaIiUy2U0Gg3Mzs6Kpak8YLUuKupgJTk/TCW/PU1x39EliDisEhGHxfe87oPKNd37aZXrZDKJixcvKu9UEwlYRDS8WkErnU4rD1hsdCcibSgPWBx3RTT8TNMUGZulvEq4tLQEy7Jw4cKFyMZuEJEahmHg8uXLYgNJRXoJDcPAysoKLMtCJpORSJKIFFtZWREf8S46l1CH1RrisuLooFT2rKmaHyg9f046T1X1VEclivLMRnci0oZ4wIpqA0YiCk9U5Vg8YNVqNekkiShkUZVj0YDFXkKi4RFFeRYNWH72JlSltRFo539+v9erYdTr+0GOMSi3tBzHCfSfmzC+G8a5+T2HIPdnL7sjqfhP5TmoFkV5Vr4vYT6fR6PR8LUO1qD7EgZdcVSa5LZSYWwfJrl6ZxjH9Tp2GKu6xuH5CUpqX0LTNJFMJtsbqqqkfFhDtVpVnQQRRaher6Ner4tUETmsgYi0wYBFRNpQXiWcnJxErVYLfS13Hdd7khzJLT3yvFdj/CDH9TqGyh12/J6fdFtcXJmmiVQqhWQyqTwt5Y3unfqtOhqk0V1HqgJWHBYiVDkFZ9BHNIztuIL8fhBxD1i9Gt2npqZEVxsFhKuEhUJBMjkiUiiK8iwasHSY/ExE/uyLyc+cS0ikv30zl5DTc4j0F1U5Fl0PCwhv5+c4jzwOo8csSIOwdM+fZAO9V3px2cUoyDkMmk9hXHNYjflR7eAu+obFbeqJhkcU5VkkYNXrdWQyGWSzWYnkiEhANptFJpMRDVzKq4SZTIbtVkRDyrKs9ovIwsKC8sZ45W9YDFZE+wMnPxMRdRDvJVQpiukM0r1Sg15jkJ4mVWtOSeeTdI+iynmOqtLThfI3rCtXruDKlSvI5XKqkyIiYblcrl3G0+m08vTEqoSFQoFzCYmGSBRlWrQNi29ZRMMjivLMRnci0oZ4o7thGJEMdZCeTjLoOcRhnSRVDb/SHRWq1sPS8TrCen5M0wzlOEFx8jMRBbYv5hISEQ1CLGBVq1VkMhmp5IhIsUwmI76Nn/KAVa/Xsby8jHw+z+og0RCxLAv5fB7Ly8tiVUTlm1D42Tm2Jc47P4fRsCm5a05QKhto/aQVlMq1oeKwplYc1k4DgpXfSqWifPDoUE3N0VFctpQfVFyCUJDjhvX9bmFMadJt0UIpbHQnIm0of8OqVCqo1+soFouqkyKiCMzOzrY3U1VNecBKp9Ptem2pVGLDO9GQMAwDhUIBU1NTYmmK7vwM9G7E24+N7nFpw5Lc3MJLXO7xoKSX5VG5tE9Y5TUsbHSPmPQOK0GEcW6DNjQHTU+VIPdYei2r/dQYL97oLrFmDhGpFVU5Fg9Y0iNjiSh8tVotknQ5rIGIAouq80w0YC0uLkomR0QKRVGexQJWuVzmWCyiIVIsFlEul0XT3DdzCVVRNRxg0J4fHeczeonDsAbpXYHiMgQmbnMJ2YZFRNpgwCIibTBgEZE2lI90b7VL1Wo1zMzMRLYWNBGFyzRNzM3NiUx6bhF7w0qlUpibm5NKjogUkw5WgPBcQtUXN4xzp/xQtTqllzjMXZTeMi2MOZGDnkPcnm/pYAVE0IYV1X5mRBSefbMvYTKZlE6SiEIWVTnm5GciCiyqcsxhDUSkDbFG93w+H2pUjsOibmFQtaOL9E4xYZBe+G5QKs8hDtfXz9mzZ5FOp1GpVMTSVD6XsFQqoVqt+lo/J4olV4nIm5+5hKlUCul0Gk888YTyxnjlb1jz8/OqkyCiCNVqNdRqNXzoQx9SHrDYhkVE2mDAIiJtiM0lzGaznEdINGRM08TS0pJYemJvWAsLC5EM5SciNVKpFBYWFkTT1HYjVSJSL27llW1YRKQN8YDFaiGR/qIqx+IBK6oNGIkoPNxIlYioD7FGd8uykM/n+YZFNCRSqRQqlQoMwxBLUyxgcRwW0fCRHocVq41UiUhf3EiViKgDAxYRaYMBi4i0EcuAFXRQWjqdDrQOj2EYgevae1nnJ+h1pFKpwOkE7aFJp9OBfsc0zcD3ivnn317yLwiJ/JMkui9hL14TKaenpz2HQrjNZeq1w/Ts7CympqZ2fV6tVpHP53d9bhgGKpXKrgycn59HqVRyPaelpSXXh7ZYLGJxcXHX51NTUygUCrseXMuykMlkXNO4dOkSLl26tOvzTCYDy7Jcf8ftXi0uLqJYLO763Ou6Ae9OlDDzL5/Pu16HV/4FvY5e+beysuKaF6VSKVD+1et1ZLNZ1zQKhQJyudyuz73yzzAMrKys7Prc67p77cgcZv5FIRZvWKZpeq4LXalUXAOA11+NXjtMuz3svY71uc99zjXTc7mc6wNnGIbnX9jZ2VnPz93+yhqG4fr51NSUa7BqnW+QtL2O5RWsAGBycnLXZ3vJP7fjAO+M7fE63yCf98o/t9/xuueGYQTOP9M0XT/3enZa5+umUCi4fu6Vf712ZHZ71veSf1GJRcBaWlryfDU2DGPXOI9eD3Xr37t5PSQt3Q/k3Nxcz1fpQqGw66Hvt9RGd8b3exAuX77c9zw7pdPpXcHa7Tw7uT3wvaoEbvclaP65nWe/9PvlX3eh7pd/bm9rbve7U9D8c3sevIIP4H5fvN4qW4Lmn9sfo6D5F6VYBKyg9jLW4/z58z3/vfvh81OP79xMstfbldcx+21G6eeY3R599NGeaYZh0LE2KvKv+zq774Obzvvv9Ubk9X23NLv5OWa37mOqeLtRPVZKJeUDR/1s7eXnBnYeJ5lM9s3I7nRTqVTPh8eyrNvq6n7OqV6vo9FoANgOLv0e4M7v+/2dWq12W7tG0HvV77q7v+8nje7r2C/5150Xfq5jGPPPi59zHZT4An5ERHulZZWQiPYnBiwi0gYDFhFpgwGLiLTBgEVE2mDAIiJtMGARkTYYsIhIGwxYRKQNBiwi0gYDFhFpgwGLiLTBgEVE2mDAIiJtMGARkTYYsIhIGwxYRKQNBiwi0gYDFgsBXbcAAAAcSURBVBFpgwGLiLTBgEVE2mDAIiJtMGARkTb+E290dzfWDONJAAAAAElFTkSuQmCC" />';

                    jfgrid.tooltip.info("发布成功！请扫二维码", img);
                    
                }
            });
        });
        
        //分列
        $("#jfgrid-splitColumn-btn-title").click(function(){
            if(jfgird_select_save == null || jfgird_select_save.length == 0){
                return;
            }

            if(jfgird_select_save.length > 1){
                jfgrid.tooltip.info("不能对多重选择区域执行此操作，请选择单个区域，然后再试", "");
                return;
            }

            if(jfgird_select_save[0].column[0] != jfgird_select_save[0].column[1]){
                jfgrid.tooltip.info("一次只能转换一列数据，选定区域可以有多行，但不能有多列，请在选定单列区域以后再试", "");
                return;   
            }

            jfgrid.splitColumn.createDialog();
            jfgrid.splitColumn.init();
        });

        $("#jfgrid-freezen-btn-horizontal").click(function () {
            if($.trim($(this).text())=="取消冻结"){
                if (jfgrid.freezen.freezenverticaldata != null) {
                    jfgrid.freezen.cancelFreezenVertical();
                    jfgrid.freezen.createAssistCanvas();
                    jfgrid.jfgridrefreshgrid();
                }

                if (jfgrid.freezen.freezenhorizontaldata != null) {
                    jfgrid.freezen.cancelFreezenHorizontal();
                    jfgrid.freezen.createAssistCanvas();
                    jfgrid.jfgridrefreshgrid();
                }

                jfgrid.freezen.scrollAdapt();
            }
            else{
                if (jfgrid.freezen.freezenverticaldata != null) {
                    jfgrid.freezen.cancelFreezenVertical();
                    jfgrid.freezen.createAssistCanvas();
                    jfgrid.jfgridrefreshgrid();
                }

                if (jfgrid.freezen.freezenhorizontaldata == null) {
                    jfgrid.freezen.createFreezenHorizontal();
                    jfgrid.freezen.createAssistCanvas();
                }
            }
        });

        $("#jfgrid-freezen-btn-vertical").click(function () {
            if (jfgrid.freezen.freezenverticaldata != null) {
                jfgrid.freezen.cancelFreezenVertical();
                jfgrid.jfgridrefreshgrid();
            }
            else {
                jfgrid.freezen.createFreezenVertical();
            }
            jfgrid.freezen.createAssistCanvas();
        });


        var submenuhide = null, rightclickmenu = null;
        $(".jfgrid-cols-menu .jfgrid-cols-submenu").hover(
            function () {
                var $t = $(this), attrid = $t.attr("id"), $attr = $("#" + attrid + "_sub"), $con = $t.parent();
                var winW = $(window).width(), winH = $(window).height();
                var menuW = $con.width(), attrH = $attr.height() + 25, attrW = $attr.width() + 5;
                var offset = $t.offset();
                var top = offset.top, left = offset.left + menuW;

                if (left + attrW > winW) {
                    left = offset.left - attrW;
                }

                if (top + attrH > winH) {
                    top = winH - attrH;
                }

                $attr.css({ "top": top, "left": left }).show();
                rightclickmenu = $t;
            },
            function () {
                var $t = $(this), attrid = $t.attr("id"), $attr = $("#" + attrid + "_sub");
                submenuhide = setTimeout(function () { $attr.hide(); }, 200);
            }
        );

        $(".jfgrid-rightgclick-menu-sub").hover(
            function () {
                rightclickmenu.addClass("jfgrid-cols-menuitem-hover");
                clearTimeout(submenuhide);
            },
            function () {
                rightclickmenu.removeClass("jfgrid-cols-menuitem-hover");
                $(this).hide();
            }
        );

        $(".jfgrid-grid-container, #jfgrid-rightclick-menu").on("contextmenu", function (e) {
            e.preventDefault();
        });

        $("#jfgrid-rightclick-menu input").on("keydown", function (e) {
            e.stopPropagation();
        });

        var copychange = function () {
            if (document.hidden || document.webkitHidden || document.msHidden) {
                iscopyself = false;
            }
        }

        $("#jfgrid-modal-dialog-mask").on("click dbclick mousedown mousemove mouseup", function (e) {
            e.stopPropagation();
            e.preventDefault();
        });

        //$("#" + container).mouseover(function () {
        //    jfgrid.jfgridactiveCell();
        //});

        $(document).on("visibilitychange webkitvisibilitychange msvisibilitychange", copychange).mouseleave(function () {
            iscopyself = false;
        }).mousedown(function (event) {
            //有批注在编辑时
            jfgrid.postil.removeActivePs();

            //jfgrid.jfgridactiveCell();
            if (!$(event.target).hasClass("jfgrid-mousedown-cancel") && $(event.target).filter("[class*='sp-palette']").length == 0 && $(event.target).filter("[class*='sp-thumb']").length == 0 && $(event.target).filter("[class*='sp-']").length == 0) {
                $("#jfgrid-rightclick-menu").hide();
                $("#jfgrid-cols-h-hover").hide();
                $("#jfgrid-cols-menu-btn").hide();
                $("#jfgrid-rightclick-menu").hide();
                $("#jfgrid-sheet-list, #jfgrid-rightclick-sheet-menu, #jfgrid-user-menu").hide();
                $("body > .jfgrid-filter-menu, body > .jfgrid-filter-submenu, body > .jfgrid-cols-menu").hide();
                //$("body > jfgrid-menuButton").hide();
                jfgrid_cols_menu_status = false;
            }

            //点击功能栏时 如果是单元格编辑模式 则退出编辑模式 
            if($(event.target).closest("#jfgrid-wa-editor").length > 0 && parseInt($("#jfgrid-input-box").css("top")) > 0){
                jfgrid.formula.updatecell(jfgridCellUpdate[0], jfgridCellUpdate[1]);
                jfgridMoveHighlightCell("down", 0, "rangeOfSelect");
            }
        });

        $("#" + container).add("#jfgrid-input-box").keydown(function (event) {
            if ($("#jfgrid-modal-dialog-mask").is(":visible") || $(event.target).hasClass("jfgrid-mousedown-cancel") || $(event.target).hasClass("formulaInputFocus")) {
                return;
            }

            var ctrlKey = event.ctrlKey;
            var altKey = event.altKey;
            var shiftKey = event.shiftKey;
            var kcode = event.keyCode;
            //jfgrid.formula.rangeHightlightselected();
            var $inputbox = $("#jfgrid-input-box");
            if (kcode == keycode.ESC && parseInt($("#jfgrid-input-box").css("top")) > 0) {
                jfgrid.formula.dontupdate();
                jfgridMoveHighlightCell("down", 0, "rangeOfSelect");
                event.preventDefault();
            }
            else if (kcode == keycode.ENTER && parseInt($inputbox.css("top")) > 0) {
                if ($("#jfgrid-formula-search-c").is(":visible") && jfgrid.formula.searchFunctionCell != null) {
                    jfgrid.formula.searchFunctionEnter($("#jfgrid-formula-search-c").find(".jfgrid-formula-search-item-active"));
                    event.preventDefault();
                }
            }
            else if(kcode == keycode.TAB && parseInt($inputbox.css("top")) > 0){
                if ($("#jfgrid-formula-search-c").is(":visible") && jfgrid.formula.searchFunctionCell != null) {
                    jfgrid.formula.searchFunctionEnter($("#jfgrid-formula-search-c").find(".jfgrid-formula-search-item-active"));
                }
                else{
                    jfgrid.formula.updatecell(jfgridCellUpdate[0], jfgridCellUpdate[1]);
                    jfgridMoveHighlightCell("right", 1, "rangeOfSelect");
                }

                event.preventDefault();
            }
            else if (kcode == keycode.F4 && parseInt($inputbox.css("top")) > 0) {
                jfgrid.formula.setfreezonFuc(event);
                event.preventDefault();
            }
            else if (kcode == keycode.UP && parseInt($inputbox.css("top")) > 0) {
                if($("#jfgrid-formula-search-c").is(":visible")){
                    var $up = $("#jfgrid-formula-search-c").find(".jfgrid-formula-search-item-active").prev();
                    if ($up.length == 0) {
                        $up = $("#jfgrid-formula-search-c").find(".jfgrid-formula-search-item").last();
                    }

                    $("#jfgrid-formula-search-c").find(".jfgrid-formula-search-item").removeClass("jfgrid-formula-search-item-active");
                    $up.addClass("jfgrid-formula-search-item-active");

                    event.preventDefault();
                }
                else if(ctrlKey && shiftKey){ 
                    if($("#jfgrid-formula-functionrange-select").is(":visible")){
                        jfgridMoveHighlightRange2("up", "rangeOfFormula");
                    }
                    else if(jfgrid.formula.israngeseleciton()){
                        var anchor = $(window.getSelection().anchorNode);
                        if(anchor.parent().next().text() == null || anchor.parent().next().text() == ""){
                            var vText = $("#jfgrid-input-box #jfgrid-input-box-index").text();
                            var range = jfgrid.formula.getcellrange(vText);

                            if(range == null){
                                range = jfgrid.formula.getcellrange($("#jfgrid-input-box-index").text());
                            }

                            var r1 = range["row"][0], r2 = range["row"][1];
                            var c1 = range["column"][0], c2 = range["column"][1];

                            var row = visibledatarow[r2], row_pre = r1 - 1 == -1 ? 0 : visibledatarow[r1 - 1];
                            var col = visibledatacolumn[c2], col_pre = c1 - 1 == -1 ? 0 : visibledatacolumn[c1 - 1];

                            jfgrid.formula.func_selectedrange = {
                                "left": col_pre,
                                "width": col - col_pre - 1,
                                "top": row_pre,
                                "height": row - row_pre - 1,
                                "left_move": col_pre,
                                "width_move": col - col_pre - 1,
                                "top_move": row_pre,
                                "height_move": row - row_pre - 1,
                                "row": [r1, r2],
                                "column": [c1, c2],
                                "row_focus": r1,
                                "column_focus": c1
                            };

                            jfgrid.formula.rangeSetValue({ "row": [r1, r2], "column": [c1, c2] });

                            jfgrid.formula.rangestart = true;
                            jfgrid.formula.rangedrag_column_start = false;
                            jfgrid.formula.rangedrag_row_start = false;

                            jfgridMoveHighlightRange2("up", "rangeOfFormula");
                        }

                        event.preventDefault();
                    }
                }
                else if(ctrlKey){ 
                    if($("#jfgrid-formula-functionrange-select").is(":visible")){
                        jfgridMoveHighlightCell2("up", "rangeOfFormula");
                    }
                    else if(jfgrid.formula.israngeseleciton()){
                        var anchor = $(window.getSelection().anchorNode);
                        if(anchor.parent().next().text() == null || anchor.parent().next().text() == ""){
                            var vText = $("#jfgrid-input-box #jfgrid-input-box-index").text();
                            var range = jfgrid.formula.getcellrange(vText);

                            if(range == null){
                                range = jfgrid.formula.getcellrange($("#jfgrid-input-box-index").text());
                            }

                            var r1 = range["row"][0], r2 = range["row"][1];
                            var c1 = range["column"][0], c2 = range["column"][1];

                            var row = visibledatarow[r2], row_pre = r1 - 1 == -1 ? 0 : visibledatarow[r1 - 1];
                            var col = visibledatacolumn[c2], col_pre = c1 - 1 == -1 ? 0 : visibledatacolumn[c1 - 1];

                            jfgrid.formula.func_selectedrange = {
                                "left": col_pre,
                                "width": col - col_pre - 1,
                                "top": row_pre,
                                "height": row - row_pre - 1,
                                "left_move": col_pre,
                                "width_move": col - col_pre - 1,
                                "top_move": row_pre,
                                "height_move": row - row_pre - 1,
                                "row": [r1, r2],
                                "column": [c1, c2],
                                "row_focus": r1,
                                "column_focus": c1
                            };

                            jfgrid.formula.rangeSetValue({ "row": [r1, r2], "column": [c1, c2] });

                            jfgrid.formula.rangestart = true;
                            jfgrid.formula.rangedrag_column_start = false;
                            jfgrid.formula.rangedrag_row_start = false;

                            jfgridMoveHighlightCell2("up", "rangeOfFormula");
                        }
                    }

                    event.preventDefault();
                }
                else if(shiftKey){
                    if($("#jfgrid-formula-functionrange-select").is(":visible")){
                        jfgridMoveHighlightRange("down", -1, "rangeOfFormula");
                    }
                    else if(jfgrid.formula.israngeseleciton()){
                        var anchor = $(window.getSelection().anchorNode);
                        if(anchor.parent().next().text() == null || anchor.parent().next().text() == ""){
                            var vText = $("#jfgrid-input-box #jfgrid-input-box-index").text();
                            var range = jfgrid.formula.getcellrange(vText);

                            if(range == null){
                                range = jfgrid.formula.getcellrange($("#jfgrid-input-box-index").text());
                            }

                            var r1 = range["row"][0], r2 = range["row"][1];
                            var c1 = range["column"][0], c2 = range["column"][1];

                            var row = visibledatarow[r2], row_pre = r1 - 1 == -1 ? 0 : visibledatarow[r1 - 1];
                            var col = visibledatacolumn[c2], col_pre = c1 - 1 == -1 ? 0 : visibledatacolumn[c1 - 1];

                            jfgrid.formula.func_selectedrange = {
                                "left": col_pre,
                                "width": col - col_pre - 1,
                                "top": row_pre,
                                "height": row - row_pre - 1,
                                "left_move": col_pre,
                                "width_move": col - col_pre - 1,
                                "top_move": row_pre,
                                "height_move": row - row_pre - 1,
                                "row": [r1, r2],
                                "column": [c1, c2],
                                "row_focus": r1,
                                "column_focus": c1
                            };

                            jfgrid.formula.rangeSetValue({ "row": [r1, r2], "column": [c1, c2] });

                            jfgrid.formula.rangestart = true;
                            jfgrid.formula.rangedrag_column_start = false;
                            jfgrid.formula.rangedrag_row_start = false;

                            jfgridMoveHighlightRange("down", -1, "rangeOfFormula");
                        }
                    }

                    event.preventDefault();
                }
                else{
                    if($("#jfgrid-formula-functionrange-select").is(":visible")){
                        jfgridMoveHighlightCell("down", -1, "rangeOfFormula");

                        event.preventDefault();
                    }
                    else if(jfgrid.formula.israngeseleciton()){
                        var anchor = $(window.getSelection().anchorNode);
                        if(anchor.parent().next().text() == null || anchor.parent().next().text() == ""){
                            var vText = $("#jfgrid-input-box #jfgrid-input-box-index").text();
                            var range = jfgrid.formula.getcellrange(vText);

                            if(range == null){
                                range = jfgrid.formula.getcellrange($("#jfgrid-input-box-index").text());
                            }

                            var r1 = range["row"][0], r2 = range["row"][1];
                            var c1 = range["column"][0], c2 = range["column"][1];

                            var row = visibledatarow[r2], row_pre = r1 - 1 == -1 ? 0 : visibledatarow[r1 - 1];
                            var col = visibledatacolumn[c2], col_pre = c1 - 1 == -1 ? 0 : visibledatacolumn[c1 - 1];

                            jfgrid.formula.func_selectedrange = {
                                "left": col_pre,
                                "width": col - col_pre - 1,
                                "top": row_pre,
                                "height": row - row_pre - 1,
                                "left_move": col_pre,
                                "width_move": col - col_pre - 1,
                                "top_move": row_pre,
                                "height_move": row - row_pre - 1,
                                "row": [r1, r2],
                                "column": [c1, c2],
                                "row_focus": r1,
                                "column_focus": c1
                            };

                            jfgrid.formula.rangeSetValue({ "row": [r1, r2], "column": [c1, c2] });

                            jfgrid.formula.rangestart = true;
                            jfgrid.formula.rangedrag_column_start = false;
                            jfgrid.formula.rangedrag_row_start = false;

                            jfgridMoveHighlightCell("down", -1, "rangeOfFormula");

                            event.preventDefault();
                        }
                    }
                    else{
                        var anchor = $(window.getSelection().anchorNode);
                        var anchorOffset = window.getSelection().anchorOffset;

                        if(anchor.parent().is("span") && anchor.parent().next().length == 0 && anchorOffset > 0){
                            jfgrid.formula.updatecell(jfgridCellUpdate[0], jfgridCellUpdate[1]);
                            jfgridMoveHighlightCell("down", -1, "rangeOfSelect");

                            event.preventDefault();
                        }
                        else if(anchor.is("#jfgrid-rich-text-editor") && anchor.context.childElementCount == anchorOffset){
                            jfgrid.formula.updatecell(jfgridCellUpdate[0], jfgridCellUpdate[1]);
                            jfgridMoveHighlightCell("down", -1, "rangeOfSelect");

                            event.preventDefault();
                        }
                        else if(anchor.parent().is("#jfgrid-rich-text-editor") && anchor.context.length == anchorOffset){
                            jfgrid.formula.updatecell(jfgridCellUpdate[0], jfgridCellUpdate[1]);
                            jfgridMoveHighlightCell("down", -1, "rangeOfSelect");

                            event.preventDefault();
                        }
                    }
                }
            }
            else if (kcode == keycode.DOWN && parseInt($inputbox.css("top")) > 0) {
                if ($("#jfgrid-formula-search-c").is(":visible")) {
                    var $up = $("#jfgrid-formula-search-c").find(".jfgrid-formula-search-item-active").next();
                    if ($up.length == 0) {
                        $up = $("#jfgrid-formula-search-c").find(".jfgrid-formula-search-item").first();
                    }

                    $("#jfgrid-formula-search-c").find(".jfgrid-formula-search-item").removeClass("jfgrid-formula-search-item-active");
                    $up.addClass("jfgrid-formula-search-item-active");

                    event.preventDefault();
                }
                else if(ctrlKey && shiftKey){ //ctrl + shift + up 调整公式选区
                    if($("#jfgrid-formula-functionrange-select").is(":visible")){
                        jfgridMoveHighlightRange2("down", "rangeOfFormula");
                    }
                    else if(jfgrid.formula.israngeseleciton()){
                        var anchor = $(window.getSelection().anchorNode);
                        if(anchor.parent().next().text() == null || anchor.parent().next().text() == ""){
                            var vText = $("#jfgrid-input-box #jfgrid-input-box-index").text();
                            var range = jfgrid.formula.getcellrange(vText);

                            if(range == null){
                                range = jfgrid.formula.getcellrange($("#jfgrid-input-box-index").text());
                            }

                            var r1 = range["row"][0], r2 = range["row"][1];
                            var c1 = range["column"][0], c2 = range["column"][1];

                            var row = visibledatarow[r2], row_pre = r1 - 1 == -1 ? 0 : visibledatarow[r1 - 1];
                            var col = visibledatacolumn[c2], col_pre = c1 - 1 == -1 ? 0 : visibledatacolumn[c1 - 1];

                            jfgrid.formula.func_selectedrange = {
                                "left": col_pre,
                                "width": col - col_pre - 1,
                                "top": row_pre,
                                "height": row - row_pre - 1,
                                "left_move": col_pre,
                                "width_move": col - col_pre - 1,
                                "top_move": row_pre,
                                "height_move": row - row_pre - 1,
                                "row": [r1, r2],
                                "column": [c1, c2],
                                "row_focus": r1,
                                "column_focus": c1
                            };

                            jfgrid.formula.rangeSetValue({ "row": [r1, r2], "column": [c1, c2] });

                            jfgrid.formula.rangestart = true;
                            jfgrid.formula.rangedrag_column_start = false;
                            jfgrid.formula.rangedrag_row_start = false;

                            jfgridMoveHighlightRange2("down", "rangeOfFormula");
                        }
                    }

                    event.preventDefault();
                }
                else if(ctrlKey){
                    if($("#jfgrid-formula-functionrange-select").is(":visible")){
                        jfgridMoveHighlightCell2("down", "rangeOfFormula");
                    }
                    else if(jfgrid.formula.israngeseleciton()){
                        var anchor = $(window.getSelection().anchorNode);
                        if(anchor.parent().next().text() == null || anchor.parent().next().text() == ""){
                            var vText = $("#jfgrid-input-box #jfgrid-input-box-index").text();
                            var range = jfgrid.formula.getcellrange(vText);

                            if(range == null){
                                range = jfgrid.formula.getcellrange($("#jfgrid-input-box-index").text());
                            }

                            var r1 = range["row"][0], r2 = range["row"][1];
                            var c1 = range["column"][0], c2 = range["column"][1];

                            var row = visibledatarow[r2], row_pre = r1 - 1 == -1 ? 0 : visibledatarow[r1 - 1];
                            var col = visibledatacolumn[c2], col_pre = c1 - 1 == -1 ? 0 : visibledatacolumn[c1 - 1];

                            jfgrid.formula.func_selectedrange = {
                                "left": col_pre,
                                "width": col - col_pre - 1,
                                "top": row_pre,
                                "height": row - row_pre - 1,
                                "left_move": col_pre,
                                "width_move": col - col_pre - 1,
                                "top_move": row_pre,
                                "height_move": row - row_pre - 1,
                                "row": [r1, r2],
                                "column": [c1, c2],
                                "row_focus": r1,
                                "column_focus": c1
                            };

                            jfgrid.formula.rangeSetValue({ "row": [r1, r2], "column": [c1, c2] });

                            jfgrid.formula.rangestart = true;
                            jfgrid.formula.rangedrag_column_start = false;
                            jfgrid.formula.rangedrag_row_start = false;

                            jfgridMoveHighlightCell2("down", "rangeOfFormula");
                        }
                    }

                    event.preventDefault();
                }
                else if(shiftKey){
                    if($("#jfgrid-formula-functionrange-select").is(":visible")){
                        jfgridMoveHighlightRange("down", 1, "rangeOfFormula");
                    }
                    else if(jfgrid.formula.israngeseleciton()){
                        var anchor = $(window.getSelection().anchorNode);
                        if(anchor.parent().next().text() == null || anchor.parent().next().text() == ""){
                            var vText = $("#jfgrid-input-box #jfgrid-input-box-index").text();
                            var range = jfgrid.formula.getcellrange(vText);

                            if(range == null){
                                range = jfgrid.formula.getcellrange($("#jfgrid-input-box-index").text());
                            }

                            var r1 = range["row"][0], r2 = range["row"][1];
                            var c1 = range["column"][0], c2 = range["column"][1];

                            var row = visibledatarow[r2], row_pre = r1 - 1 == -1 ? 0 : visibledatarow[r1 - 1];
                            var col = visibledatacolumn[c2], col_pre = c1 - 1 == -1 ? 0 : visibledatacolumn[c1 - 1];

                            jfgrid.formula.func_selectedrange = {
                                "left": col_pre,
                                "width": col - col_pre - 1,
                                "top": row_pre,
                                "height": row - row_pre - 1,
                                "left_move": col_pre,
                                "width_move": col - col_pre - 1,
                                "top_move": row_pre,
                                "height_move": row - row_pre - 1,
                                "row": [r1, r2],
                                "column": [c1, c2],
                                "row_focus": r1,
                                "column_focus": c1
                            };

                            jfgrid.formula.rangeSetValue({ "row": [r1, r2], "column": [c1, c2] });

                            jfgrid.formula.rangestart = true;
                            jfgrid.formula.rangedrag_column_start = false;
                            jfgrid.formula.rangedrag_row_start = false;

                            jfgridMoveHighlightRange("down", 1, "rangeOfFormula");
                        }
                    }

                    event.preventDefault();
                }
                else{
                    if($("#jfgrid-formula-functionrange-select").is(":visible")){
                        jfgridMoveHighlightCell("down", 1, "rangeOfFormula");

                        event.preventDefault();
                    }
                    else if(jfgrid.formula.israngeseleciton()){
                        var anchor = $(window.getSelection().anchorNode);
                        if(anchor.parent().next().text() == null || anchor.parent().next().text() == ""){
                            var vText = $("#jfgrid-input-box #jfgrid-input-box-index").text();
                            var range = jfgrid.formula.getcellrange(vText);

                            if(range == null){
                                range = jfgrid.formula.getcellrange($("#jfgrid-input-box-index").text());
                            }

                            var r1 = range["row"][0], r2 = range["row"][1];
                            var c1 = range["column"][0], c2 = range["column"][1];

                            var row = visibledatarow[r2], row_pre = r1 - 1 == -1 ? 0 : visibledatarow[r1 - 1];
                            var col = visibledatacolumn[c2], col_pre = c1 - 1 == -1 ? 0 : visibledatacolumn[c1 - 1];

                            jfgrid.formula.func_selectedrange = {
                                "left": col_pre,
                                "width": col - col_pre - 1,
                                "top": row_pre,
                                "height": row - row_pre - 1,
                                "left_move": col_pre,
                                "width_move": col - col_pre - 1,
                                "top_move": row_pre,
                                "height_move": row - row_pre - 1,
                                "row": [r1, r2],
                                "column": [c1, c2],
                                "row_focus": r1,
                                "column_focus": c1
                            };

                            jfgrid.formula.rangeSetValue({ "row": [r1, r2], "column": [c1, c2] });

                            jfgrid.formula.rangestart = true;
                            jfgrid.formula.rangedrag_column_start = false;
                            jfgrid.formula.rangedrag_row_start = false;

                            jfgridMoveHighlightCell("down", 1, "rangeOfFormula");

                            event.preventDefault();
                        }
                    }
                    else{
                        var anchor = $(window.getSelection().anchorNode);
                        var anchorOffset = window.getSelection().anchorOffset;

                        if(anchor.parent().is("span") && anchor.parent().next().length == 0 && anchorOffset > 0){
                            jfgrid.formula.updatecell(jfgridCellUpdate[0], jfgridCellUpdate[1]);
                            jfgridMoveHighlightCell("down", 1, "rangeOfSelect");

                            event.preventDefault();
                        }
                        else if(anchor.is("#jfgrid-rich-text-editor") && anchor.context.childElementCount == anchorOffset){
                            jfgrid.formula.updatecell(jfgridCellUpdate[0], jfgridCellUpdate[1]);
                            jfgridMoveHighlightCell("down", 1, "rangeOfSelect");

                            event.preventDefault();
                        }
                        else if(anchor.parent().is("#jfgrid-rich-text-editor") && anchor.context.length == anchorOffset){
                            jfgrid.formula.updatecell(jfgridCellUpdate[0], jfgridCellUpdate[1]);
                            jfgridMoveHighlightCell("down", 1, "rangeOfSelect");

                            event.preventDefault();
                        }
                    }
                }
            }
            else if (kcode == keycode.LEFT && parseInt($inputbox.css("top")) > 0) {
                if ($("#jfgrid-formula-search-c").is(":visible")){
                    event.preventDefault();
                }
                else if(ctrlKey && shiftKey){ //ctrl + shift + up 调整公式选区
                    if($("#jfgrid-formula-functionrange-select").is(":visible")){
                        jfgridMoveHighlightRange2("left", "rangeOfFormula");
                    }
                    else if(jfgrid.formula.israngeseleciton()){
                        var anchor = $(window.getSelection().anchorNode);
                        if(anchor.parent().next().text() == null || anchor.parent().next().text() == ""){
                            var vText = $("#jfgrid-input-box #jfgrid-input-box-index").text();
                            var range = jfgrid.formula.getcellrange(vText);

                            if(range == null){
                                range = jfgrid.formula.getcellrange($("#jfgrid-input-box-index").text());
                            }

                            var r1 = range["row"][0], r2 = range["row"][1];
                            var c1 = range["column"][0], c2 = range["column"][1];

                            var row = visibledatarow[r2], row_pre = r1 - 1 == -1 ? 0 : visibledatarow[r1 - 1];
                            var col = visibledatacolumn[c2], col_pre = c1 - 1 == -1 ? 0 : visibledatacolumn[c1 - 1];

                            jfgrid.formula.func_selectedrange = {
                                "left": col_pre,
                                "width": col - col_pre - 1,
                                "top": row_pre,
                                "height": row - row_pre - 1,
                                "left_move": col_pre,
                                "width_move": col - col_pre - 1,
                                "top_move": row_pre,
                                "height_move": row - row_pre - 1,
                                "row": [r1, r2],
                                "column": [c1, c2],
                                "row_focus": r1,
                                "column_focus": c1
                            };

                            jfgrid.formula.rangeSetValue({ "row": [r1, r2], "column": [c1, c2] });

                            jfgrid.formula.rangestart = true;
                            jfgrid.formula.rangedrag_column_start = false;
                            jfgrid.formula.rangedrag_row_start = false;

                            jfgridMoveHighlightRange2("left", "rangeOfFormula");
                        }
                    }

                    event.preventDefault();
                }
                else if(ctrlKey){
                    if($("#jfgrid-formula-functionrange-select").is(":visible")){
                        jfgridMoveHighlightCell2("left", "rangeOfFormula");
                    }
                    else if(jfgrid.formula.israngeseleciton()){
                        var anchor = $(window.getSelection().anchorNode);
                        if(anchor.parent().next().text() == null || anchor.parent().next().text() == ""){
                            var vText = $("#jfgrid-input-box #jfgrid-input-box-index").text();
                            var range = jfgrid.formula.getcellrange(vText);

                            if(range == null){
                                range = jfgrid.formula.getcellrange($("#jfgrid-input-box-index").text());
                            }

                            var r1 = range["row"][0], r2 = range["row"][1];
                            var c1 = range["column"][0], c2 = range["column"][1];

                            var row = visibledatarow[r2], row_pre = r1 - 1 == -1 ? 0 : visibledatarow[r1 - 1];
                            var col = visibledatacolumn[c2], col_pre = c1 - 1 == -1 ? 0 : visibledatacolumn[c1 - 1];

                            jfgrid.formula.func_selectedrange = {
                                "left": col_pre,
                                "width": col - col_pre - 1,
                                "top": row_pre,
                                "height": row - row_pre - 1,
                                "left_move": col_pre,
                                "width_move": col - col_pre - 1,
                                "top_move": row_pre,
                                "height_move": row - row_pre - 1,
                                "row": [r1, r2],
                                "column": [c1, c2],
                                "row_focus": r1,
                                "column_focus": c1
                            };

                            jfgrid.formula.rangeSetValue({ "row": [r1, r2], "column": [c1, c2] });

                            jfgrid.formula.rangestart = true;
                            jfgrid.formula.rangedrag_column_start = false;
                            jfgrid.formula.rangedrag_row_start = false;

                            jfgridMoveHighlightCell2("left", "rangeOfFormula");
                        }
                    }

                    event.preventDefault();
                }
                else if(shiftKey){
                    if($("#jfgrid-formula-functionrange-select").is(":visible")){
                        jfgridMoveHighlightRange("right", -1, "rangeOfFormula");

                        event.preventDefault();
                    }
                    else if(jfgrid.formula.israngeseleciton()){
                        var anchor = $(window.getSelection().anchorNode);
                        if(anchor.parent().next().text() == null || anchor.parent().next().text() == ""){
                            var vText = $("#jfgrid-input-box #jfgrid-input-box-index").text();
                            var range = jfgrid.formula.getcellrange(vText);

                            if(range == null){
                                range = jfgrid.formula.getcellrange($("#jfgrid-input-box-index").text());
                            }

                            var r1 = range["row"][0], r2 = range["row"][1];
                            var c1 = range["column"][0], c2 = range["column"][1];

                            var row = visibledatarow[r2], row_pre = r1 - 1 == -1 ? 0 : visibledatarow[r1 - 1];
                            var col = visibledatacolumn[c2], col_pre = c1 - 1 == -1 ? 0 : visibledatacolumn[c1 - 1];

                            jfgrid.formula.func_selectedrange = {
                                "left": col_pre,
                                "width": col - col_pre - 1,
                                "top": row_pre,
                                "height": row - row_pre - 1,
                                "left_move": col_pre,
                                "width_move": col - col_pre - 1,
                                "top_move": row_pre,
                                "height_move": row - row_pre - 1,
                                "row": [r1, r2],
                                "column": [c1, c2],
                                "row_focus": r1,
                                "column_focus": c1
                            };

                            jfgrid.formula.rangeSetValue({ "row": [r1, r2], "column": [c1, c2] });

                            jfgrid.formula.rangestart = true;
                            jfgrid.formula.rangedrag_column_start = false;
                            jfgrid.formula.rangedrag_row_start = false;

                            jfgridMoveHighlightRange("right", -1, "rangeOfFormula");

                            event.preventDefault();
                        }
                    }
                }
                else{
                    if($("#jfgrid-formula-functionrange-select").is(":visible")){
                        jfgridMoveHighlightCell("right", -1, "rangeOfFormula");

                        event.preventDefault();
                    }
                    else if(jfgrid.formula.israngeseleciton()){
                        var anchor = $(window.getSelection().anchorNode);
                        if(anchor.parent().next().text() == null || anchor.parent().next().text() == ""){
                            var vText = $("#jfgrid-input-box #jfgrid-input-box-index").text();
                            var range = jfgrid.formula.getcellrange(vText);

                            if(range == null){
                                range = jfgrid.formula.getcellrange($("#jfgrid-input-box-index").text());
                            }

                            var r1 = range["row"][0], r2 = range["row"][1];
                            var c1 = range["column"][0], c2 = range["column"][1];

                            var row = visibledatarow[r2], row_pre = r1 - 1 == -1 ? 0 : visibledatarow[r1 - 1];
                            var col = visibledatacolumn[c2], col_pre = c1 - 1 == -1 ? 0 : visibledatacolumn[c1 - 1];

                            jfgrid.formula.func_selectedrange = {
                                "left": col_pre,
                                "width": col - col_pre - 1,
                                "top": row_pre,
                                "height": row - row_pre - 1,
                                "left_move": col_pre,
                                "width_move": col - col_pre - 1,
                                "top_move": row_pre,
                                "height_move": row - row_pre - 1,
                                "row": [r1, r2],
                                "column": [c1, c2],
                                "row_focus": r1,
                                "column_focus": c1
                            };

                            jfgrid.formula.rangeSetValue({ "row": [r1, r2], "column": [c1, c2] });

                            jfgrid.formula.rangestart = true;
                            jfgrid.formula.rangedrag_column_start = false;
                            jfgrid.formula.rangedrag_row_start = false;

                            jfgridMoveHighlightCell("right", -1, "rangeOfFormula");

                            event.preventDefault();
                        }
                    }
                    else{
                        var anchor = $(window.getSelection().anchorNode);
                        var anchorOffset = window.getSelection().anchorOffset;

                        if(anchor.parent().is("span") && anchor.parent().prev().length == 0 && anchorOffset == 0){
                            jfgrid.formula.updatecell(jfgridCellUpdate[0], jfgridCellUpdate[1]);
                            jfgridMoveHighlightCell("right", -1, "rangeOfSelect");

                            event.preventDefault();
                        }
                        else if(anchor.is("#jfgrid-rich-text-editor") && anchorOffset == 1){
                            jfgrid.formula.updatecell(jfgridCellUpdate[0], jfgridCellUpdate[1]);
                            jfgridMoveHighlightCell("right", -1, "rangeOfSelect");

                            event.preventDefault();
                        }
                        else if(anchor.parent().is("#jfgrid-rich-text-editor") && anchorOffset == 0){
                            jfgrid.formula.updatecell(jfgridCellUpdate[0], jfgridCellUpdate[1]);
                            jfgridMoveHighlightCell("right", -1, "rangeOfSelect");

                            event.preventDefault();
                        }
                    }
                }
            }
            else if (kcode == keycode.RIGHT && parseInt($inputbox.css("top")) > 0) {
                if ($("#jfgrid-formula-search-c").is(":visible")){
                    event.preventDefault();
                }
                else if(ctrlKey && shiftKey){ //ctrl + shift + up 调整公式选区
                    if($("#jfgrid-formula-functionrange-select").is(":visible")){
                        jfgridMoveHighlightRange2("right", "rangeOfFormula");
                    }
                    else if(jfgrid.formula.israngeseleciton()){
                        var anchor = $(window.getSelection().anchorNode);
                        if(anchor.parent().next().text() == null || anchor.parent().next().text() == ""){
                            var vText = $("#jfgrid-input-box #jfgrid-input-box-index").text();
                            var range = jfgrid.formula.getcellrange(vText);

                            if(range == null){
                                range = jfgrid.formula.getcellrange($("#jfgrid-input-box-index").text());
                            }

                            var r1 = range["row"][0], r2 = range["row"][1];
                            var c1 = range["column"][0], c2 = range["column"][1];

                            var row = visibledatarow[r2], row_pre = r1 - 1 == -1 ? 0 : visibledatarow[r1 - 1];
                            var col = visibledatacolumn[c2], col_pre = c1 - 1 == -1 ? 0 : visibledatacolumn[c1 - 1];

                            jfgrid.formula.func_selectedrange = {
                                "left": col_pre,
                                "width": col - col_pre - 1,
                                "top": row_pre,
                                "height": row - row_pre - 1,
                                "left_move": col_pre,
                                "width_move": col - col_pre - 1,
                                "top_move": row_pre,
                                "height_move": row - row_pre - 1,
                                "row": [r1, r2],
                                "column": [c1, c2],
                                "row_focus": r1,
                                "column_focus": c1
                            };

                            jfgrid.formula.rangeSetValue({ "row": [r1, r2], "column": [c1, c2] });

                            jfgrid.formula.rangestart = true;
                            jfgrid.formula.rangedrag_column_start = false;
                            jfgrid.formula.rangedrag_row_start = false;

                            jfgridMoveHighlightRange2("right", "rangeOfFormula");
                        }
                    }

                    event.preventDefault();
                }
                else if(ctrlKey){
                    if($("#jfgrid-formula-functionrange-select").is(":visible")){
                        jfgridMoveHighlightCell2("right", "rangeOfFormula");
                    }
                    else if(jfgrid.formula.israngeseleciton()){
                        var anchor = $(window.getSelection().anchorNode);
                        if(anchor.parent().next().text() == null || anchor.parent().next().text() == ""){
                            var vText = $("#jfgrid-input-box #jfgrid-input-box-index").text();
                            var range = jfgrid.formula.getcellrange(vText);

                            if(range == null){
                                range = jfgrid.formula.getcellrange($("#jfgrid-input-box-index").text());
                            }

                            var r1 = range["row"][0], r2 = range["row"][1];
                            var c1 = range["column"][0], c2 = range["column"][1];

                            var row = visibledatarow[r2], row_pre = r1 - 1 == -1 ? 0 : visibledatarow[r1 - 1];
                            var col = visibledatacolumn[c2], col_pre = c1 - 1 == -1 ? 0 : visibledatacolumn[c1 - 1];

                            jfgrid.formula.func_selectedrange = {
                                "left": col_pre,
                                "width": col - col_pre - 1,
                                "top": row_pre,
                                "height": row - row_pre - 1,
                                "left_move": col_pre,
                                "width_move": col - col_pre - 1,
                                "top_move": row_pre,
                                "height_move": row - row_pre - 1,
                                "row": [r1, r2],
                                "column": [c1, c2],
                                "row_focus": r1,
                                "column_focus": c1
                            };

                            jfgrid.formula.rangeSetValue({ "row": [r1, r2], "column": [c1, c2] });

                            jfgrid.formula.rangestart = true;
                            jfgrid.formula.rangedrag_column_start = false;
                            jfgrid.formula.rangedrag_row_start = false;

                            jfgridMoveHighlightCell2("right", "rangeOfFormula");
                        }
                    }

                    event.preventDefault();
                }
                else if(shiftKey){
                    if($("#jfgrid-formula-functionrange-select").is(":visible")){
                        jfgridMoveHighlightRange("right", 1, "rangeOfFormula");

                        event.preventDefault();
                    }
                    else if(jfgrid.formula.israngeseleciton()){
                        var anchor = $(window.getSelection().anchorNode);
                        if(anchor.parent().next().text() == null || anchor.parent().next().text() == ""){
                            var vText = $("#jfgrid-input-box #jfgrid-input-box-index").text();
                            var range = jfgrid.formula.getcellrange(vText);

                            if(range == null){
                                range = jfgrid.formula.getcellrange($("#jfgrid-input-box-index").text());
                            }

                            var r1 = range["row"][0], r2 = range["row"][1];
                            var c1 = range["column"][0], c2 = range["column"][1];

                            var row = visibledatarow[r2], row_pre = r1 - 1 == -1 ? 0 : visibledatarow[r1 - 1];
                            var col = visibledatacolumn[c2], col_pre = c1 - 1 == -1 ? 0 : visibledatacolumn[c1 - 1];

                            jfgrid.formula.func_selectedrange = {
                                "left": col_pre,
                                "width": col - col_pre - 1,
                                "top": row_pre,
                                "height": row - row_pre - 1,
                                "left_move": col_pre,
                                "width_move": col - col_pre - 1,
                                "top_move": row_pre,
                                "height_move": row - row_pre - 1,
                                "row": [r1, r2],
                                "column": [c1, c2],
                                "row_focus": r1,
                                "column_focus": c1
                            };

                            jfgrid.formula.rangeSetValue({ "row": [r1, r2], "column": [c1, c2] });

                            jfgrid.formula.rangestart = true;
                            jfgrid.formula.rangedrag_column_start = false;
                            jfgrid.formula.rangedrag_row_start = false;

                            jfgridMoveHighlightRange("right", 1, "rangeOfFormula");

                            event.preventDefault();
                        }
                    }
                }
                else{
                    if($("#jfgrid-formula-functionrange-select").is(":visible")){
                        jfgridMoveHighlightCell("right", 1, "rangeOfFormula");

                        event.preventDefault();
                    }
                    else if(jfgrid.formula.israngeseleciton()){
                        var anchor = $(window.getSelection().anchorNode);
                        if(anchor.parent().next().text() == null || anchor.parent().next().text() == ""){
                            var vText = $("#jfgrid-input-box #jfgrid-input-box-index").text();
                            var range = jfgrid.formula.getcellrange(vText);

                            if(range == null){
                                range = jfgrid.formula.getcellrange($("#jfgrid-input-box-index").text());
                            }

                            var r1 = range["row"][0], r2 = range["row"][1];
                            var c1 = range["column"][0], c2 = range["column"][1];

                            var row = visibledatarow[r2], row_pre = r1 - 1 == -1 ? 0 : visibledatarow[r1 - 1];
                            var col = visibledatacolumn[c2], col_pre = c1 - 1 == -1 ? 0 : visibledatacolumn[c1 - 1];

                            jfgrid.formula.func_selectedrange = {
                                "left": col_pre,
                                "width": col - col_pre - 1,
                                "top": row_pre,
                                "height": row - row_pre - 1,
                                "left_move": col_pre,
                                "width_move": col - col_pre - 1,
                                "top_move": row_pre,
                                "height_move": row - row_pre - 1,
                                "row": [r1, r2],
                                "column": [c1, c2],
                                "row_focus": r1,
                                "column_focus": c1
                            };

                            jfgrid.formula.rangeSetValue({ "row": [r1, r2], "column": [c1, c2] });

                            jfgrid.formula.rangestart = true;
                            jfgrid.formula.rangedrag_column_start = false;
                            jfgrid.formula.rangedrag_row_start = false;

                            jfgridMoveHighlightCell("right", 1, "rangeOfFormula");

                            event.preventDefault();
                        }
                    }
                    else{
                        var anchor = $(window.getSelection().anchorNode);
                        var anchorOffset = window.getSelection().anchorOffset;

                        if(anchor.parent().is("span") && anchor.parent().next().length == 0 && anchorOffset > 0){
                            jfgrid.formula.updatecell(jfgridCellUpdate[0], jfgridCellUpdate[1]);
                            jfgridMoveHighlightCell("right", 1, "rangeOfSelect");

                            event.preventDefault();
                        }
                        else if(anchor.is("#jfgrid-rich-text-editor") && anchor.context.childElementCount == anchorOffset){
                            jfgrid.formula.updatecell(jfgridCellUpdate[0], jfgridCellUpdate[1]);
                            jfgridMoveHighlightCell("right", 1, "rangeOfSelect");

                            event.preventDefault();
                        }
                        else if(anchor.parent().is("#jfgrid-rich-text-editor") && anchor.context.length == anchorOffset){
                            jfgrid.formula.updatecell(jfgridCellUpdate[0], jfgridCellUpdate[1]);
                            jfgridMoveHighlightCell("right", 1, "rangeOfSelect");

                            event.preventDefault();
                        }
                    }
                }
            }
            else if (!((kcode >= 112 && kcode <= 123) || kcode <= 46 || kcode == 144 || kcode == 108 || event.ctrlKey || event.altKey || (event.shiftKey && (kcode == 37 || kcode == 38 || kcode == 39 || kcode == 40))) || kcode == 8 || kcode == 32 || kcode == 46 || (event.ctrlKey && kcode == 86)) {
                jfgrid.formula.functionInputHanddler($("#jfgrid-functionbox-cell"), $("#jfgrid-rich-text-editor"), kcode);
            }
        }).keyup(function (e) {
            var kcode = e.keyCode;
            if (!e.shiftKey && kcode == 16) {
                jfgrid_shiftkeydown = false;
                jfgrid.jfgrid_shiftpositon = null;
            }
            e.preventDefault();
        });

        //表格计数栏
        var jfcountfunc = function () {
            if(jfgird_select_save.length == 0){
                return;
            }

            var min = Infinity, max = -Infinity, sum = 0, count = 0, mean = 0;

            for(var s = 0; s < jfgird_select_save.length; s++){
                var data = jfgrid.getdatabyselectionNoCopy(jfgird_select_save[s]);

                for (var r = 0; r < data.length; r++) {
                    for (var c = 0; c < data[0].length; c++) {
                        if(jfgrid.func_methods.isRealNull(data[r][c])){
                            continue;
                        }

                        count++;

                        if(data[r][c].ct != null && data[r][c].ct.t == "d"){
                            continue;
                        }

                        var value = data[r][c].v;

                        if(!jfgrid.func_methods.isRealNum(value)){
                            continue;
                        }

                        value = parseFloat(value);

                        sum += value;

                        if(value < min){
                            min = value;
                        }

                        if(value > max){
                            max = value;
                        }
                    }
                }
            }

            var ret = "";
            ret += "<span>计数:" + count + "</span>";

            // if (sum != 0 && (isFinite(max) || isFinite(min))) {
            if (isFinite(max) || isFinite(min)) {
                //ret += "<span>求和:" + jfgrid.numFormat(sum) + "</span>";
                //ret += "<span>平均值:" + jfgrid.numFormat(sum / count, 4) + "</span>";

                //new runze 
                //处理成亿万格式
                // ret += "<span>求和:" + jfgrid.mask.update("w", jfgrid.numFormat(sum)) + "</span>";
                ret += "<span>求和:" + jfgrid.mask.update("w", sum) + "</span>";
                // ret += "<span>平均值:" + jfgrid.mask.update("w", jfgrid.numFormat(sum / count, 4)) + "</span>";
                ret += "<span>平均值:" + jfgrid.mask.update("w", Math.round(sum / count * 10000) / 10000) + "</span>";
            }

            if (isFinite(max)) {
                //ret += "<span>最大值:" + jfgrid.numFormat(max) + "</span>";
                // ret += "<span>最大值:" + jfgrid.mask.update("w", jfgrid.numFormat(max)) + "</span>";
                ret += "<span>最大值:" + jfgrid.mask.update("w", max) + "</span>";
            }

            if (isFinite(min)) {
                //ret += "<span>最小值:" + jfgrid.numFormat(min) + "</span>";
                // ret += "<span>最小值:" + jfgrid.mask.update("w", jfgrid.numFormat(min)) + "</span>";
                ret += "<span>最小值:" + jfgrid.mask.update("w", min) + "</span>";
            }
            $("#jfgrid-sta-content").html(ret);
        }

        jfgrid.jfcountfunc = jfcountfunc;

        $(document).mousemove(function (event) {
            jfgrid.postil.overshow(event); //有批注显示

            clearInterval(jfautoscrollTimeout);
            if(jfgrid.formula.functionResizeStatus){
                var y = event.pageY;
                var movepx = y - jfgrid.formula.functionResizeData.y;
                var mpx = jfgrid.formula.functionResizeData.calculatebarHeight + movepx;
                var winh = Math.round($(window).height()/2);
                if(mpx <= 28){
                    if(mpx <= 20){
                        return;
                    }
                    mpx = 28;
                }
                else if(mpx >= winh){
                    if(mpx >= winh + 8){
                        return;
                    }
                    mpx = winh;
                }
                calculatebarHeight = mpx;
                $("#jfgrid-wa-calculate").css("height", calculatebarHeight - 2);
                $("#jfgrid-wa-calculate-size").css({"background":"#5e5e5e", "cursor":"ns-resize"});
                clearTimeout(jfgrid.formula.functionResizeTimeout);
                jfgrid.formula.functionResizeTimeout = setTimeout(function(){
                    jfgrid.jfgridsizeauto();
                }, 15);
            }
            else if (!!jfgrid.freezen.horizontalmovestate) {
                var mouse = mouseposition(event.pageX, event.pageY);
                var scrollLeft = $("#jfgrid-cell-main").scrollLeft();
                var scrollTop = $("#jfgrid-cell-main").scrollTop();
                var x = mouse[0] + scrollLeft;
                var y = mouse[1] + scrollTop;

                var rowLocation = jfgrid.rowLocation(y), row = rowLocation[1], row_pre = rowLocation[0], row_index = rowLocation[2];
                var top = mouse[1] + columeHeaderHeight;

                if (top < columeHeaderHeight) {
                    top = columeHeaderHeight;
                }

                if (top > jfgrid.freezen.windowHeight - 4) {
                    top = jfgrid.freezen.windowHeight - 4;
                }

                $("#jfgrid-freezebar-horizontal").find(".jfgrid-freezebar-horizontal-handle").css({ "top": top });

                if (top + scrollTop - columeHeaderHeight >= row_pre + (row - row_pre) / 2) {
                    top = row - 2 - scrollTop + columeHeaderHeight;
                    jfgrid.freezen.freezenhorizontaldata = [row, row_index + 1, scrollTop, jfgrid.freezen.cutVolumn(visibledatarow, row_index + 1), top];
                }
                else {
                    top = row_pre - 2 - scrollTop + columeHeaderHeight;
                    jfgrid.freezen.freezenhorizontaldata = [row_pre, row_index, scrollTop, jfgrid.freezen.cutVolumn(visibledatarow, row_index), top];
                }

                $("#jfgrid-freezebar-horizontal").find(".jfgrid-freezebar-horizontal-drop").css({ "top": top });
                jfgrid.freezen.saveFreezen(jfgrid.freezen.freezenhorizontaldata, top, null, null);
            }
            else if (!!jfgrid.freezen.verticalmovestate) {
                var mouse = mouseposition(event.pageX, event.pageY);
                var scrollLeft = $("#jfgrid-cell-main").scrollLeft();
                var scrollTop = $("#jfgrid-cell-main").scrollTop();
                var x = mouse[0] + scrollLeft;
                var y = mouse[1] + scrollTop;

                var colLocation = jfgrid.colLocation(x), col = colLocation[1], col_pre = colLocation[0], col_index = colLocation[2];

                var left = mouse[0] + rowHeaderWidth;

                if (left < rowHeaderWidth) {
                    left = rowHeaderWidth;
                }

                if (left > jfgrid.freezen.windowWidth - 4) {
                    left = jfgrid.freezen.windowWidth - 4;
                }

                $("#jfgrid-freezebar-vertical").find(".jfgrid-freezebar-vertical-handle").css({ "left": left });

                if (left + scrollLeft - rowHeaderWidth >= col_pre + (col - col_pre) / 2) {
                    left = col - 2 - scrollLeft + rowHeaderWidth;
                    jfgrid.freezen.freezenverticaldata = [col, col_index + 1, scrollLeft, jfgrid.freezen.cutVolumn(visibledatacolumn, col_index + 1), left];
                }
                else {
                    left = col_pre - 2 - scrollLeft + rowHeaderWidth;
                    jfgrid.freezen.freezenverticaldata = [col_pre, col_index, scrollLeft, jfgrid.freezen.cutVolumn(visibledatacolumn, col_index), left];
                }

                $("#jfgrid-freezebar-vertical").find(".jfgrid-freezebar-vertical-drop").css({ "left": left });
                jfgrid.freezen.saveFreezen(null, null, jfgrid.freezen.freezenverticaldata, left);
                jfgrid.jfgridsizeauto();//调节选区时下部单元格溢出
            }
            else if (!!jfgrid.pivotTable && jfgrid.pivotTable.movestate) {
                var x = event.pageX, y = event.pageY;
                $("#jfgrid-modal-dialog-slider-pivot-move").css({ "left": x - jfgrid.pivotTable.movesave.width / 2, "top": y - jfgrid.pivotTable.movesave.height });
            }
            else if (!!jfgrid.chartparam.jfgrid_chart_point_config && jfgrid.chartparam.jfgrid_chart_point_config.movestart) {
                var x = event.pageX, y = event.pageY, $container = jfgrid.chartparam.jfgrid_chart_point_config.container;
                var curleft = x - $container.offset().left + $container.scrollLeft();
                var curtop = y - $container.offset().top + $container.scrollTop();
                //var $cur = $(event.target), $item = $(event.target).closest(".jfgrid-chart-point-searchitem");
                //$item.addClass("jfgrid-chart-point-searchitem-active");
                var top = 0, height = 0;
                if (jfgrid.chartparam.jfgrid_chart_point_config.top > curtop) {
                    top = curtop;
                    height = jfgrid.chartparam.jfgrid_chart_point_config.top - curtop;
                }
                else if (jfgrid.chartparam.jfgrid_chart_point_config.top == curtop) {
                    top = curtop;
                    height = jfgrid.chartparam.jfgrid_chart_point_config.top - curtop;
                }
                else {
                    top = jfgrid.chartparam.jfgrid_chart_point_config.top;
                    height = curtop - jfgrid.chartparam.jfgrid_chart_point_config.top - 1;
                }

                var left = 0, width = 0;
                if (jfgrid.chartparam.jfgrid_chart_point_config.left > curleft) {
                    left = curleft;
                    width = jfgrid.chartparam.jfgrid_chart_point_config.left - curleft;
                }
                else if (jfgrid.chartparam.jfgrid_chart_point_config.left == curleft) {
                    left = curleft;
                    width = jfgrid.chartparam.jfgrid_chart_point_config.left - curleft;
                }
                else {
                    left = jfgrid.chartparam.jfgrid_chart_point_config.left;
                    width = curleft - jfgrid.chartparam.jfgrid_chart_point_config.left - 1;
                }

                for (var i = 0; i < jfgrid.chartparam.jfgrid_chart_point_config.objectIndicator.length; i++) {
                    var obj = jfgrid.chartparam.jfgrid_chart_point_config.objectIndicator[i];
                    if (!(((obj.left + obj.width + $container.scrollLeft()) <= left || (obj.top + obj.height + $container.scrollTop()) <= top) || ((obj.left + $container.scrollLeft()) >= (left + width) || (obj.top + $container.scrollTop()) >= (top + height)))) {
                        if (obj.isselected) {
                            obj.item.removeClass("jfgrid-chart-point-searchitem-active");
                        }
                        else {
                            obj.item.addClass("jfgrid-chart-point-searchitem-active");
                        }
                    }
                    else {
                        if (!obj.isselected) {
                            obj.item.removeClass("jfgrid-chart-point-searchitem-active");
                        }
                    }
                }

                $("#jfgrid-chart-point-selectedhelp").css({ "left": left, "width": width, "top": top, "height": height });
            }
            else if (jfgird_sheet_move_status) {
                var scrollLeft = $("#jfgrid-sheet-container-c").scrollLeft();
                var x = event.pageX + scrollLeft;

                if (Math.abs(event.pageX - jfgird_sheet_move_data.pageX) < 3) {
                    return;
                }

                var winW = $("#jfgrid-sheet-container").width();
                var left = x - jfgird_sheet_move_data.curleft - $("#jfgrid-sheet-container").offset().left;
                jfgird_sheet_move_data.activeobject.css({ "left": left });
                var row_index = jfgrid_searcharray(jfgird_sheet_move_data.widthlist, left + jfgird_sheet_move_data.curleft);
                jfgird_sheet_move_data.cursorobject.css({ "cursor": "move" });

                if (left - scrollLeft <= 6) {
                    $("#jfgrid-sheets-leftscroll").click();
                }

                if (left - scrollLeft >= winW - 40) {
                    $("#jfgrid-sheets-rightscroll").click();
                }

                if (row_index != jfgird_sheet_move_data.curindex) {
                    if (row_index == -1 && left > 0) {
                        row_index = jfgird_sheet_move_data.widthlist.length - 1;
                        $("#jfgrid-sheets-item-clone").insertAfter($("#jfgrid-sheet-area div.jfgrid-sheets-item:visible").eq(row_index));
                    }
                    else if (row_index == -1 && left <= 0) {
                        $("#jfgrid-sheets-item-clone").insertBefore($("#jfgrid-sheet-area div.jfgrid-sheets-item:visible").eq(0));
                    }
                    else {
                        $("#jfgrid-sheets-item-clone").insertAfter($("#jfgrid-sheet-area div.jfgrid-sheets-item:visible").eq(row_index));
                    }

                    jfgird_sheet_move_data.widthlist = [];
                    //jfgird_sheet_move_data.curleft = x;
                    $("#jfgrid-sheet-area div.jfgrid-sheets-item:visible").each(function (i) {
                        if (i == 0) {
                            jfgird_sheet_move_data.widthlist.push(parseInt($(this).outerWidth()));
                        }
                        else {
                            jfgird_sheet_move_data.widthlist.push(parseInt($(this).outerWidth()) + jfgird_sheet_move_data.widthlist[i - 1]);
                        }
                    });

                    jfgird_sheet_move_data.curindex = $("#jfgrid-sheet-area div.jfgrid-sheets-item:visible").index($("#jfgrid-sheets-item-clone"));
                }
            }
            else if (jfgrid_model_move_state) {
                var scrollTop = $(document).scrollTop(), scrollLeft = $(document).scrollLeft();
                var y = event.pageY + scrollTop, x = event.pageX + scrollLeft;
                var winH = $(window).height(), winW = $(window).width();
                var myh = jfgrid_model_move_obj.height(), myw = jfgrid_model_move_obj.width();
                var top = y - jfgrid_model_xy[1], left = x - jfgrid_model_xy[0];

                if (top < 0) {
                    top = 0;
                }

                if (top + myh + 62 > winH) {
                    top = winH - myh - 62;
                }

                if (left < 0) {
                    left = 0;
                }

                if (left + myw + 86 > winW) {
                    left = winW - myw - 86;
                }

                jfgrid_model_move_obj.css({ "top": top, "left": left });
                event.preventDefault();
            }
            else if (!!jfgird_scroll_status || !!jfgird_select_status || !!jfgrid_rows_selected_status || !!jfgrid_cols_selected_status || !!jfgrid_cell_selected_move || !!jfgrid_cell_selected_move || !!jfgrid_cell_selected_extend || !!jfgrid_cols_change_size || !!jfgrid_rows_change_size || !!jfgrid.chartparam.jfgridCurrentChartMove || !!jfgrid.chartparam.jfgridCurrentChartResize || !!jfgrid.formula.rangeResize || !!jfgrid.formula.rangeMove) {
                if (jfgird_select_status) {
                    clearTimeout(jfcountfuncTimeout);
                    jfcountfuncTimeout = setTimeout(function () { jfcountfunc() }, 500);
                }
                
                jfautoscrollTimeout = setInterval(function () {
                    if (jfgird_scroll_status  && !jfgrid_cols_change_size && !jfgrid_rows_change_size) {
                        var mouse = mouseposition(event.pageX, event.pageY);
                        var left = $("#jfgrid-scrollbar-x").scrollLeft(), top = $("#jfgrid-scrollbar-y").scrollTop();
                        var x = mouse[0];
                        var y = mouse[1];
                        var winH = $("#jfgrid-cell-main").height() - 20, winW = $("#jfgrid-cell-main").width() - 60;

                        if (y < 0 || y > winH) {
                            var stop;
                            if (y < 0) {
                                stop = top + y/2;
                            }
                            else {
                                stop = top + (y - winH)/2;
                            }
                            $("#jfgrid-scrollbar-y").scrollTop(stop);
                        }

                        if (x < 0 || x > winW) {
                            var sleft;
                            if (x < 0) {
                                sleft = left + x/2;
                            }
                            else {
                                sleft = left + (x - winW)/2;
                            }
                            $("#jfgrid-scrollbar-x").scrollLeft(sleft);
                        }
                    }
                    if (jfgird_select_status) {
                        var mouse = mouseposition(event.pageX, event.pageY);
                        var x = mouse[0] + $("#jfgrid-cell-main").scrollLeft();
                        var y = mouse[1] + $("#jfgrid-cell-main").scrollTop();

                        var rowLocation = jfgrid.rowLocation(y), row = rowLocation[1], row_pre = rowLocation[0], row_index = rowLocation[2];
                        var colLocation = jfgrid.colLocation(x), col = colLocation[1], col_pre = colLocation[0], col_index = colLocation[2];

                        var last = $.extend(true, {}, jfgird_select_save[jfgird_select_save.length - 1]);

                        var top = 0, height = 0, rowseleted = [];
                        if (last.top > row_pre) {
                            top = row_pre;
                            height = last.top + last.height - row_pre;

                            if(last.row[1] > last.row_focus){
                                last.row[1] = last.row_focus;
                            }

                            rowseleted = [row_index, last.row[1]];
                        }
                        else if (last.top == row_pre) {
                            top = row_pre;
                            height = last.top + last.height - row_pre;
                            rowseleted = [row_index, last.row[0]];
                        }
                        else {
                            top = last.top;
                            height = row - last.top - 1;

                            if(last.row[0] < last.row_focus){
                                last.row[0] = last.row_focus;
                            }

                            rowseleted = [last.row[0], row_index];
                        }

                        var left = 0, width = 0, columnseleted = [];
                        if (last.left > col_pre) {
                            left = col_pre;
                            width = last.left + last.width - col_pre;

                            if(last.column[1] > last.column_focus){
                                last.column[1] = last.column_focus;
                            }

                            columnseleted = [col_index, last.column[1]];
                        }
                        else if (last.left == col_pre) {
                            left = col_pre;
                            width = last.left + last.width - col_pre;
                            columnseleted = [col_index, last.column[0]];
                        }
                        else {
                            left = last.left;
                            width = col - last.left - 1;

                            if(last.column[0] < last.column_focus){
                                last.column[0] = last.column_focus;
                            }

                            columnseleted = [last.column[0], col_index];
                        }

                        var changeparam = jfgrid.menuButton.mergeMoveMain(columnseleted, rowseleted, last, top, height, left, width);
                        if(changeparam != null){
                            columnseleted = changeparam[0];
                            rowseleted= changeparam[1];
                            top = changeparam[2];
                            height = changeparam[3];
                            left = changeparam[4];
                            width = changeparam[5];
                        }

                        last["row"] = rowseleted;
                        last["column"] = columnseleted;

                        last["left_move"] = left;
                        last["width_move"] = width;
                        last["top_move"] = top;
                        last["height_move"] = height;

                        jfgird_select_save[jfgird_select_save.length - 1] = last;

                        jfgrid.selectHightlightShow();
                        
                        jfgrid.freezen.scrollFreezen();

                        $("#jfgrid-helpbox-cell").text(jfgrid.sheetmanage.getRangetxt(jfgrid.currentSheetIndex, jfgird_select_save[jfgird_select_save.length - 1]));

                        //交替颜色选择范围
                        if($("#jfgrid-alternateformat-rangeDialog").is(":visible")){
                            $("#jfgrid-alternateformat-rangeDialog input").val(jfgrid.sheetmanage.getRangetxt(jfgrid.currentSheetIndex, jfgird_select_save[jfgird_select_save.length - 1]));
                        }

                        if (jfgrid.chartparam.jfgrid_chart_data_select_state) {
                            $("#jfgrid-datavisual-range-selection-input").val(jfgridfile[jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex)].name + "!" + jfgrid.jfgridchatatABC(jfgird_select_save[0]["column"][0]) + (jfgird_select_save[0]["row"][0] + 1) + ":" + jfgrid.jfgridchatatABC(jfgird_select_save[0]["column"][1]) + (jfgird_select_save[0]["row"][1] + 1));
                        }

                        if (jfgrid.pivotTable.jfgrid_pivotTable_select_state) {
                            $("#jfgrid-pivotTable-range-selection-input").val(jfgridfile[jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex)].name + "!" + jfgrid.jfgridchatatABC(jfgird_select_save[0]["column"][0]) + (jfgird_select_save[0]["row"][0] + 1) + ":" + jfgrid.jfgridchatatABC(jfgird_select_save[0]["column"][1]) + (jfgird_select_save[0]["row"][1] + 1));
                        }
                    }
                    else if(jfgrid.conditionformat.selectStatus){
                        var mouse = mouseposition(event.pageX, event.pageY);
                        var x = mouse[0] + $("#jfgrid-cell-main").scrollLeft();
                        var y = mouse[1] + $("#jfgrid-cell-main").scrollTop();

                        var rowLocation = jfgrid.rowLocation(y), row = rowLocation[1], row_pre = rowLocation[0], row_index = rowLocation[2];
                        var colLocation = jfgrid.colLocation(x), col = colLocation[1], col_pre = colLocation[0], col_index = colLocation[2];

                        var last = jfgrid.conditionformat.selectRange[jfgrid.conditionformat.selectRange.length - 1];

                        var top = 0, height = 0, rowseleted = [];
                        if (last.top > row_pre) {
                            top = row_pre;
                            height = last.top + last.height - row_pre;

                            if(last.row[1] > last.row_focus){
                                last.row[1] = last.row_focus;
                            }

                            rowseleted = [row_index, last.row[1]];
                        }
                        else if (last.top == row_pre) {
                            top = row_pre;
                            height = last.top + last.height - row_pre;
                            rowseleted = [row_index, last.row[0]];
                        }
                        else {
                            top = last.top;
                            height = row - last.top - 1;

                            if(last.row[0] < last.row_focus){
                                last.row[0] = last.row_focus;
                            }

                            rowseleted = [last.row[0], row_index];
                        }

                        var left = 0, width = 0, columnseleted = [];
                        if (last.left > col_pre) {
                            left = col_pre;
                            width = last.left + last.width - col_pre;

                            if(last.column[1] > last.column_focus){
                                last.column[1] = last.column_focus;
                            }

                            columnseleted = [col_index, last.column[1]];
                        }
                        else if (last.left == col_pre) {
                            left = col_pre;
                            width = last.left + last.width - col_pre;
                            columnseleted = [col_index, last.column[0]];
                        }
                        else {
                            left = last.left;
                            width = col - last.left - 1;

                            if(last.column[0] < last.column_focus){
                                last.column[0] = last.column_focus;
                            }

                            columnseleted = [last.column[0], col_index];
                        }

                        var changeparam = jfgrid.menuButton.mergeMoveMain(columnseleted, rowseleted, last, top, height, left, width);
                        if(changeparam != null){
                            columnseleted = changeparam[0];
                            rowseleted= changeparam[1];
                            top = changeparam[2];
                            height = changeparam[3];
                            left = changeparam[4];
                            width = changeparam[5];
                        }

                        last["row"] = rowseleted;
                        last["column"] = columnseleted;

                        last["left_move"] = left;
                        last["width_move"] = width;
                        last["top_move"] = top;
                        last["height_move"] = height;

                        jfgrid.conditionformat.selectRange[jfgrid.conditionformat.selectRange.length - 1] = last;

                        jfgrid.selectionCopyShow(jfgrid.conditionformat.selectRange);

                        var range = jfgrid.conditionformat.getTxtByRange(jfgrid.conditionformat.selectRange);
                        $("#jfgrid-multiRange-dialog input").val(range);
                    }
                    else if (jfgrid.formula.rangestart) {
                        jfgrid.formula.rangedrag(event);
                    }
                    else if (jfgrid.formula.rangedrag_row_start) {
                        jfgrid.formula.rangedrag_row(event);
                    }
                    else if (jfgrid.formula.rangedrag_column_start) {
                        jfgrid.formula.rangedrag_column(event);
                    }
                    else if (jfgrid_rows_selected_status) {
                        var mouse = mouseposition(event.pageX, event.pageY);
                        var y = mouse[1] + $("#jfgrid-rows-h").scrollTop();
                        if (y < 0) {
                            return false;
                        }

                        var rowLocation = jfgrid.rowLocation(y), row = rowLocation[1], row_pre = rowLocation[0], row_index = rowLocation[2];
                        var col_index = visibledatacolumn.length - 1, col = visibledatacolumn[col_index], col_pre = 0;

                        var last = $.extend(true, {}, jfgird_select_save[jfgird_select_save.length - 1]);

                        var top = 0, height = 0, rowseleted = [];
                        if (last.top > row_pre) {
                            top = row_pre;
                            height = last.top + last.height - row_pre;

                            if(last.row[1] > last.row_focus){
                                last.row[1] = last.row_focus;
                            }

                            rowseleted = [row_index, last.row[1]];
                        }
                        else if (last.top == row_pre) {
                            top = row_pre;
                            height = last.top + last.height - row_pre;
                            rowseleted = [row_index, last.row[0]];
                        }
                        else {
                            top = last.top;
                            height = row - last.top - 1;

                            if(last.row[0] < last.row_focus){
                                last.row[0] = last.row_focus;
                            }

                            rowseleted = [last.row[0], row_index];
                        }

                        // var changeparam = jfgrid.menuButton.mergeMoveMain([0, col_index], rowseleted, last, top, height, col_pre, col);
                        // if(changeparam != null){
                        //     //columnseleted = changeparam[0];
                        //     rowseleted= changeparam[1];
                        //     top = changeparam[2];
                        //     height = changeparam[3];
                        //     //left = changeparam[4];
                        //     //width = changeparam[5];
                        // }

                        last["row"] = rowseleted;

                        last["top_move"] = top;
                        last["height_move"] = height;

                        jfgird_select_save[jfgird_select_save.length - 1] = last;

                        jfgrid.selectHightlightShow();
                        
                        clearTimeout(jfcountfuncTimeout);
                        jfcountfuncTimeout = setTimeout(function () { jfcountfunc() }, 500);
                        //event.preventDefault();
                    }
                    else if (jfgrid_cols_selected_status) {
                        var mouse = mouseposition(event.pageX, event.pageY);
                        var x = mouse[0] + $("#jfgrid-cols-h-c").scrollLeft();
                        if (x < 0) {
                            return false;
                        }

                        var row_index = visibledatarow.length - 1, row = visibledatarow[row_index], row_pre = 0;
                        var colLocation = jfgrid.colLocation(x), col = colLocation[1], col_pre = colLocation[0], col_index = colLocation[2];

                        var last = $.extend(true, {}, jfgird_select_save[jfgird_select_save.length - 1]);

                        var left = 0, width = 0, columnseleted = [];
                        if (last.left > col_pre) {
                            left = col_pre;
                            width = last.left + last.width - col_pre;

                            if(last.column[1] > last.column_focus){
                                last.column[1] = last.column_focus;
                            }

                            columnseleted = [col_index, last.column[1]];
                        }
                        else if (last.left == col_pre) {
                            left = col_pre;
                            width = last.left + last.width - col_pre;
                            columnseleted = [col_index, last.column[0]];
                        }
                        else {
                            left = last.left;
                            width = col - last.left - 1;

                            if(last.column[0] < last.column_focus){
                                last.column[0] = last.column_focus;
                            }

                            columnseleted = [last.column[0], col_index];
                        }

                        // var changeparam = jfgrid.menuButton.mergeMoveMain(columnseleted, [0, row_index], last, row_pre, row, left, width);
                        // if(changeparam != null){
                        //     columnseleted = changeparam[0];
                        //     //rowseleted= changeparam[1];
                        //     //top = changeparam[2];
                        //     //height = changeparam[3];
                        //     left = changeparam[4];
                        //     width = changeparam[5];
                        // }

                        last["column"] = columnseleted;

                        last["left_move"] = left;
                        last["width_move"] = width;

                        jfgird_select_save[jfgird_select_save.length - 1] = last;

                        jfgrid.selectHightlightShow();
                        
                        clearTimeout(jfcountfuncTimeout);
                        jfcountfuncTimeout = setTimeout(function () { jfcountfunc() }, 500);
                        //event.preventDefault();
                    }
                    else if (jfgrid_cell_selected_move) {
                        var mouse = mouseposition(event.pageX, event.pageY);

                        var scrollLeft = $("#jfgrid-cell-main").scrollLeft();
                        var scrollTop = $("#jfgrid-cell-main").scrollTop();

                        var x = mouse[0] + scrollLeft;
                        var y = mouse[1] + scrollTop;

                        var winH = $(window).height() + scrollTop - sheetBarHeight - statisticBarHeight, winW = $(window).width() + scrollLeft;

                        var rowLocation = jfgrid.rowLocation(y), row = rowLocation[1], row_pre = rowLocation[0], row_index = rowLocation[2];

                        var colLocation = jfgrid.colLocation(x), col = colLocation[1], col_pre = colLocation[0], col_index = colLocation[2];

                        var row_index_original = jfgrid_cell_selected_move_index[0], col_index_original = jfgrid_cell_selected_move_index[1];

                        var row_s = jfgird_select_save[0]["row"][0] - row_index_original + row_index, row_e = jfgird_select_save[0]["row"][1] - row_index_original + row_index;

                        var col_s = jfgird_select_save[0]["column"][0] - col_index_original + col_index, col_e = jfgird_select_save[0]["column"][1] - col_index_original + col_index;

                        if (row_s < 0 || y < 0) {
                            row_s = 0;
                            row_e = jfgird_select_save[0]["row"][1] - jfgird_select_save[0]["row"][0];
                        }

                        if (col_s < 0 || x < 0) {
                            col_s = 0;
                            col_e = jfgird_select_save[0]["column"][1] - jfgird_select_save[0]["column"][0];
                        }

                        if (row_e >= visibledatarow[visibledatarow.length - 1] || y > winH) {
                            row_s = visibledatarow.length - 1 - jfgird_select_save[0]["row"][1] + jfgird_select_save[0]["row"][0];
                            row_e = visibledatarow.length - 1;
                        }

                        if (col_e >= visibledatacolumn[visibledatacolumn.length - 1] || x > winW) {
                            col_s = visibledatacolumn.length - 1 - jfgird_select_save[0]["column"][1] + jfgird_select_save[0]["column"][0];
                            col_e = visibledatacolumn.length - 1;
                        }

                        var col_pre = col_s - 1 == -1 ? 0 : visibledatacolumn[col_s - 1], col = visibledatacolumn[col_e];
                        var row_pre = row_s - 1 == -1 ? 0 : visibledatarow[row_s - 1], row = visibledatarow[row_e];

                        $("#jfgrid-cell-selected-move").css({ "left": col_pre, "width": col - col_pre - 2, "top": row_pre, "height": row - row_pre - 2, "display": "block" });
                        //clearTimeout(jfcountfuncTimeout);
                        //jfcountfuncTimeout = setTimeout(function () { jfcountfunc() }, 500);
                        //event.preventDefault();
                    }
                    else if (jfgrid_cell_selected_extend) {
                        var mouse = mouseposition(event.pageX, event.pageY);
                        var scrollLeft = $("#jfgrid-cell-main").scrollLeft() - 5;
                        var scrollTop = $("#jfgrid-cell-main").scrollTop() - 5;

                        var x = mouse[0] + scrollLeft;
                        var y = mouse[1] + scrollTop;

                        var winH = $(window).height() + scrollTop - sheetBarHeight - statisticBarHeight, winW = $(window).width() + scrollLeft;

                        /*                        if (x < 0 || y < 0) {
                                                    return;
                                                }*/

                        var rowLocation = jfgrid.rowLocation(y), row = rowLocation[1], row_pre = rowLocation[0], row_index = rowLocation[2];

                        var colLocation = jfgrid.colLocation(x), col = colLocation[1], col_pre = colLocation[0], col_index = colLocation[2];

                        var row_index_original = jfgrid_cell_selected_extend_index[0], col_index_original = jfgrid_cell_selected_extend_index[1];

                        var row_s = jfgird_select_save[0]["row"][0], row_e = jfgird_select_save[0]["row"][1];
                        var col_s = jfgird_select_save[0]["column"][0], col_e = jfgird_select_save[0]["column"][1];

                        if (row_s < 0 || y < 0) {
                            row_s = 0;
                            row_e = jfgird_select_save[0]["row"][1] - jfgird_select_save[0]["row"][0];
                        }

                        if (col_s < 0 || x < 0) {
                            col_s = 0;
                            col_e = jfgird_select_save[0]["column"][1] - jfgird_select_save[0]["column"][0];
                        }

                        if (row_e >= visibledatarow[visibledatarow.length - 1] || y > winH) {
                            row_s = visibledatarow.length - 1 - jfgird_select_save[0]["row"][1] + jfgird_select_save[0]["row"][0];
                            row_e = visibledatarow.length - 1;
                        }

                        if (col_e >= visibledatacolumn[visibledatacolumn.length - 1] || x > winW) {
                            col_s = visibledatacolumn.length - 1 - jfgird_select_save[0]["column"][1] + jfgird_select_save[0]["column"][0];
                            col_e = visibledatacolumn.length - 1;
                        }

                        var top = jfgird_select_save[0].top_move, height = jfgird_select_save[0].height_move;
                        var left = jfgird_select_save[0].left_move, width = jfgird_select_save[0].width_move;

                        if (Math.abs(row_index_original - row_index) > Math.abs(col_index_original - col_index)) {
                            if (!(row_index >= row_s && row_index <= row_e)) {
                                if (jfgird_select_save[0].top_move >= row_pre) {
                                    top = row_pre;
                                    height = jfgird_select_save[0].top_move + jfgird_select_save[0].height_move - row_pre;
                                }
                                else {
                                    top = jfgird_select_save[0].top_move;
                                    height = row - jfgird_select_save[0].top_move - 1;
                                }
                            }
                        }
                        else {
                            if (!(col_index >= col_s && col_index <= col_e)) {
                                if (jfgird_select_save[0].left_move >= col_pre) {
                                    left = col_pre;
                                    width = jfgird_select_save[0].left_move + jfgird_select_save[0].width_move - col_pre;
                                }
                                else {
                                    left = jfgird_select_save[0].left_move;
                                    width = col - jfgird_select_save[0].left_move - 1;
                                }
                            }
                        }

                        $("#jfgrid-cell-selected-extend").css({ "left": left, "width": width, "top": top, "height": height, "display": "block" });
                        //event.preventDefault();
                    }
                    else if (jfgrid_cols_change_size) {
                        var mouse = mouseposition(event.pageX, event.pageY);
                        var scrollLeft = $("#jfgrid-cols-h-c").scrollLeft();
                        var x = mouse[0] + scrollLeft;
                        var winW = $(window).width();

                        var row_index = visibledatarow.length - 1, row = visibledatarow[row_index], row_pre = 0;
                        var colLocation = jfgrid.colLocation(x), col = colLocation[1], col_pre = colLocation[0], col_index = colLocation[2];

                        if(jfgridConfigsetting.pointEdit){//编辑器qksheet表格编辑状态
                            if ((x + 3) / jfgridConfigsetting.pointEditZoom - jfgrid_cols_change_size_start[0] > 30 && x / jfgridConfigsetting.pointEditZoom < winW + scrollLeft - 100) {
                                $("#jfgrid-change-size-line").css({ "left": x / jfgridConfigsetting.pointEditZoom });
                                $("#jfgrid-cols-change-size").css({ "left": (x - 2) / jfgridConfigsetting.pointEditZoom });
                            }
                        }
                        else{
                            if ((x + 3) - jfgrid_cols_change_size_start[0] > 30 && x < winW + scrollLeft - 100) {
                                $("#jfgrid-change-size-line").css({ "left": x });
                                $("#jfgrid-cols-change-size").css({ "left": x - 2 });
                            }
                        }
                        //event.preventDefault();
                    }
                    else if (jfgrid_rows_change_size) {
                        var mouse = mouseposition(event.pageX, event.pageY);
                        var scrollTop = $("#jfgrid-rows-h").scrollTop();
                        var y = mouse[1] + scrollTop;
                        var winH = $(window).height();

                        var rowLocation = jfgrid.rowLocation(y), row = rowLocation[1], row_pre = rowLocation[0], row_index = rowLocation[2];

                        if(jfgridConfigsetting.pointEdit){//编辑器qksheet表格编辑状态
                            if ((y + 3) / jfgridConfigsetting.pointEditZoom - jfgrid_rows_change_size_start[0] > 19 && y / jfgridConfigsetting.pointEditZoom < winH + scrollTop - 200) {
                                $("#jfgrid-change-size-line").css({ "top": y / jfgridConfigsetting.pointEditZoom });
                                $("#jfgrid-rows-change-size").css({ "top": y / jfgridConfigsetting.pointEditZoom });
                            }
                        }
                        else{
                            if ((y + 3) - jfgrid_rows_change_size_start[0] > 19 && y < winH + scrollTop - 200) {
                                $("#jfgrid-change-size-line").css({ "top": y });
                                $("#jfgrid-rows-change-size").css({ "top": y });
                            }
                        }
                        //event.preventDefault();
                    }
                    else if (jfgrid.chartparam.jfgridCurrentChartMove) {
                        var mouse = mouseposition(event.pageX, event.pageY);
                        var x = mouse[0] + $("#jfgrid-cell-main").scrollLeft();
                        var y = mouse[1] + $("#jfgrid-cell-main").scrollTop();
                        // var scrollTop = $("#jfgrid-cell-main").scrollTop(), scrollLeft = $("#jfgrid-cell-main").scrollLeft();
                        // var y = event.pageY + scrollTop, x = event.pageX + scrollLeft;

                        var myh = jfgrid.chartparam.jfgridCurrentChartMoveObj.height(), myw = jfgrid.chartparam.jfgridCurrentChartMoveObj.width();
                        var top = y - jfgrid.chartparam.jfgridCurrentChartMoveXy[1], left = x - jfgrid.chartparam.jfgridCurrentChartMoveXy[0];

                        if (top < 0) {
                            top = 0;
                        }

                        if (top + myh + 42 + 6 > jfgrid.chartparam.jfgridCurrentChartMoveWinH) {
                            top = jfgrid.chartparam.jfgridCurrentChartMoveWinH - myh - 42 - 6;
                        }

                        if (left < 0) {
                            left = 0;
                        }

                        if (left + myw + 22 + 36 > jfgrid.chartparam.jfgridCurrentChartMoveWinW) {
                            left = jfgrid.chartparam.jfgridCurrentChartMoveWinW - myw - 22 - 36;
                        }

                        jfgrid.chartparam.jfgridCurrentChartMoveObj.css({ "top": top, "left": left });

                        if(jfgrid.freezen.freezenhorizontaldata != null || jfgrid.freezen.freezenverticaldata != null){
                            jfgrid.freezen.scrollAdapt();

                            var toffset = jfgrid.chartparam.jfgridCurrentChartMoveObj.offset();
                            var tpsition = jfgrid.chartparam.jfgridCurrentChartMoveObj.position();
                            jfgrid.chartparam.jfgridCurrentChartMoveXy = [event.pageX - toffset.left, event.pageY - toffset.top, tpsition.left, tpsition.top, $("#jfgrid-scrollbar-x").scrollLeft(), $("#jfgrid-scrollbar-y").scrollTop()];
                        }
                        //event.preventDefault();
                    }
                    else if (!!jfgrid.chartparam.jfgridCurrentChartResize) {
                        var scrollTop = $("#jfgrid-cell-main").scrollTop(), scrollLeft = $("#jfgrid-cell-main").scrollLeft();
                        var mouse = mouseposition(event.pageX, event.pageY);
                        var x = mouse[0] + scrollLeft;
                        var y = mouse[1] + scrollTop;

                        if (x < 0 || y < 0) {
                            return false;
                        }

                        var myh = jfgrid.chartparam.jfgridCurrentChartResizeObj.height(), myw = jfgrid.chartparam.jfgridCurrentChartResizeObj.width();
                        var topchange = y - jfgrid.chartparam.jfgridCurrentChartResizeXy[1], leftchange = x - jfgrid.chartparam.jfgridCurrentChartResizeXy[0];

                        var top = jfgrid.chartparam.jfgridCurrentChartResizeXy[5], height = jfgrid.chartparam.jfgridCurrentChartResizeXy[3], left = jfgrid.chartparam.jfgridCurrentChartResizeXy[4], width = jfgrid.chartparam.jfgridCurrentChartResizeXy[2];

                        if (jfgrid.chartparam.jfgridCurrentChartResize == "lm" || jfgrid.chartparam.jfgridCurrentChartResize == "lt" || jfgrid.chartparam.jfgridCurrentChartResize == "lb") {
                            left = x;
                            width = jfgrid.chartparam.jfgridCurrentChartResizeXy[2] - leftchange;
                            if (left > jfgrid.chartparam.jfgridCurrentChartResizeXy[2] + jfgrid.chartparam.jfgridCurrentChartResizeXy[4] - 60) {
                                left = jfgrid.chartparam.jfgridCurrentChartResizeXy[2] + jfgrid.chartparam.jfgridCurrentChartResizeXy[4] - 60;
                                width = jfgrid.chartparam.jfgridCurrentChartResizeXy[2] - (jfgrid.chartparam.jfgridCurrentChartResizeXy[2] + jfgrid.chartparam.jfgridCurrentChartResizeXy[4] - 60 - jfgrid.chartparam.jfgridCurrentChartResizeXy[0]);
                            }
                            else if (left <= 0) {
                                left = 0;
                                width = jfgrid.chartparam.jfgridCurrentChartResizeXy[2] + jfgrid.chartparam.jfgridCurrentChartResizeXy[0];
                            }
                        }

                        if (jfgrid.chartparam.jfgridCurrentChartResize == "rm" || jfgrid.chartparam.jfgridCurrentChartResize == "rt" || jfgrid.chartparam.jfgridCurrentChartResize == "rb") {
                            width = jfgrid.chartparam.jfgridCurrentChartResizeXy[2] + leftchange;
                            if (width < 60) {
                                width = 60;
                            }
                            else if (width >= jfgrid.chartparam.jfgridCurrentChartResizeWinW - jfgrid.chartparam.jfgridCurrentChartResizeXy[4] - 22 - 36) {
                                width = jfgrid.chartparam.jfgridCurrentChartResizeWinW - jfgrid.chartparam.jfgridCurrentChartResizeXy[4] - 22 - 36;
                            }
                        }

                        if (jfgrid.chartparam.jfgridCurrentChartResize == "mt" || jfgrid.chartparam.jfgridCurrentChartResize == "lt" || jfgrid.chartparam.jfgridCurrentChartResize == "rt") {
                            top = y;
                            height = jfgrid.chartparam.jfgridCurrentChartResizeXy[3] - topchange;
                            if (top > jfgrid.chartparam.jfgridCurrentChartResizeXy[3] + jfgrid.chartparam.jfgridCurrentChartResizeXy[5] - 60) {
                                top = jfgrid.chartparam.jfgridCurrentChartResizeXy[3] + jfgrid.chartparam.jfgridCurrentChartResizeXy[5] - 60;
                                height = jfgrid.chartparam.jfgridCurrentChartResizeXy[3] - (jfgrid.chartparam.jfgridCurrentChartResizeXy[3] + jfgrid.chartparam.jfgridCurrentChartResizeXy[5] - 60 - jfgrid.chartparam.jfgridCurrentChartResizeXy[1]);
                            }
                            else if (top <= 0) {
                                top = 0;
                                height = jfgrid.chartparam.jfgridCurrentChartResizeXy[3] + jfgrid.chartparam.jfgridCurrentChartResizeXy[1];
                            }
                        }

                        if (jfgrid.chartparam.jfgridCurrentChartResize == "mb" || jfgrid.chartparam.jfgridCurrentChartResize == "lb" || jfgrid.chartparam.jfgridCurrentChartResize == "rb") {
                            height = jfgrid.chartparam.jfgridCurrentChartResizeXy[3] + topchange;
                            if (height < 60) {
                                height = 60;
                            }
                            else if (height >= jfgrid.chartparam.jfgridCurrentChartResizeWinH - jfgrid.chartparam.jfgridCurrentChartResizeXy[5] - 42 - 6) {
                                height = jfgrid.chartparam.jfgridCurrentChartResizeWinH - jfgrid.chartparam.jfgridCurrentChartResizeXy[5] - 42 - 6;
                            }
                        }

                        //if (top < 0) {
                        //    top = 0;
                        //}

                        //if (top + myh > jfgrid.chartparam.jfgridCurrentChartResizeWinH) {
                        //    top = jfgrid.chartparam.jfgridCurrentChartResizeWinH - myh;
                        //}

                        //if (left < 0) {
                        //    left = 0;
                        //}

                        //if (left + myw > jfgrid.chartparam.jfgridCurrentChartResizeWinW) {
                        //    left = jfgrid.chartparam.jfgridCurrentChartResizeWinW - myw;
                        //}

                        var resizedata = { "top": top, "left": left, "height": height, "width": width };
                        jfgrid.chartparam.jfgridCurrentChartResizeObj.css(resizedata);
                        //echarts.getInstanceById(jfgrid.chartparam.jfgridCurrentChartResizeObj.find(".jfgrid-modal-dialog-content").attr("_echarts_instance_")).resize();
                        !!window.generator && generator.resize(jfgrid.chartparam.jfgridcurrentChart);
                        //event.preventDefault();
                    }
                    else if (jfgrid.postil.move){
                        var mouse = mouseposition(event.pageX, event.pageY);
                        var x = mouse[0] + $("#jfgrid-cell-main").scrollLeft();
                        var y = mouse[1] + $("#jfgrid-cell-main").scrollTop();

                        var myh = jfgrid.postil.currentObj.outerHeight(), 
                            myw = jfgrid.postil.currentObj.outerWidth();
                        
                        var top = y - jfgrid.postil.moveXY[1], left = x - jfgrid.postil.moveXY[0];

                        if (top < 0) {
                            top = 0;
                        }

                        if (top + myh + 42 + 6 > jfgrid.postil.currentWinH) {
                            top = jfgrid.postil.currentWinH - myh - 42 - 6;
                        }

                        if (left < 0) {
                            left = 0;
                        }

                        if (left + myw + 22 + 36 > jfgrid.postil.currentWinW) {
                            left = jfgrid.postil.currentWinW - myw - 22 - 36;
                        }

                        jfgrid.postil.currentObj.css({ "left": left, "top": top });
                    }
                    else if (!!jfgrid.postil.resize){
                        var mouse = jfgrid.mouseposition(event.pageX, event.pageY);
                        var x = mouse[0] + $("#jfgrid-cell-main").scrollLeft();
                        var y = mouse[1] + $("#jfgrid-cell-main").scrollTop();

                        if (x < 0 || y < 0) {
                            return false;
                        }

                        var topchange = y - jfgrid.postil.resizeXY[1], 
                            leftchange = x - jfgrid.postil.resizeXY[0];
                        
                        var top = jfgrid.postil.resizeXY[5],
                            height = jfgrid.postil.resizeXY[3],
                            left = jfgrid.postil.resizeXY[4],
                            width = jfgrid.postil.resizeXY[2];

                        if(jfgrid.postil.resize == "lm" || jfgrid.postil.resize == "lt" || jfgrid.postil.resize == "lb"){
                            left = x;
                            width = jfgrid.postil.resizeXY[2] - leftchange;

                            if(left > jfgrid.postil.resizeXY[2] + jfgrid.postil.resizeXY[4] - 60){
                                left = jfgrid.postil.resizeXY[2] + jfgrid.postil.resizeXY[4] - 60;
                                width = jfgrid.postil.resizeXY[2] - (jfgrid.postil.resizeXY[2] + jfgrid.postil.resizeXY[4] - 60 - jfgrid.postil.resizeXY[0]);
                            }
                            else if(left <= 0){
                                left = 0;
                                width = jfgrid.postil.resizeXY[2] + jfgrid.postil.resizeXY[0];
                            }
                        }

                        if(jfgrid.postil.resize == "rm" || jfgrid.postil.resize == "rt" || jfgrid.postil.resize == "rb"){
                            width = jfgrid.postil.resizeXY[2] + leftchange;

                            if(width < 60){
                                width = 60;
                            }
                            else if(width >= jfgrid.postil.currentWinW - jfgrid.postil.resizeXY[4] - 22 - 36){
                                width = jfgrid.postil.currentWinW - jfgrid.postil.resizeXY[4] - 22 - 36;
                            }
                        }

                        if(jfgrid.postil.resize == "mt" || jfgrid.postil.resize == "lt" || jfgrid.postil.resize == "rt"){
                            top = y;
                            height = jfgrid.postil.resizeXY[3] - topchange;

                            if(top > jfgrid.postil.resizeXY[3] + jfgrid.postil.resizeXY[5] - 60){
                                top = jfgrid.postil.resizeXY[3] + jfgrid.postil.resizeXY[5] - 60;
                                height = jfgrid.postil.resizeXY[3] - (jfgrid.postil.resizeXY[3] + jfgrid.postil.resizeXY[5] - 60 - jfgrid.postil.resizeXY[1]);
                            }
                            else if(top <= 0){
                                top = 0;
                                height = jfgrid.postil.resizeXY[3] + jfgrid.postil.resizeXY[1];
                            }
                        }

                        if(jfgrid.postil.resize == "mb" || jfgrid.postil.resize == "lb" || jfgrid.postil.resize == "rb"){
                            height = jfgrid.postil.resizeXY[3] + topchange;

                            if(height < 60){
                                height = 60;
                            }
                            else if(height >= jfgrid.postil.currentWinH - jfgrid.postil.resizeXY[5] - 42 - 6){
                                height = jfgrid.postil.currentWinH - jfgrid.postil.resizeXY[5] - 42 - 6;
                            }
                        }

                        jfgrid.postil.currentObj.css({ "width": width, "height": height, "left": left, "top": top });
                    }
                    else if (!!jfgrid.formula.rangeResize) {
                        jfgrid.formula.rangeResizeDraging(event, jfgrid.formula.rangeResizeObj, jfgrid.formula.rangeResizexy, jfgrid.formula.rangeResize, jfgrid.formula.rangeResizeWinW, jfgrid.formula.rangeResizeWinH, ch_width, rh_height);
                    }
                    else if (!!jfgrid.formula.rangeMove) {
                        jfgrid.formula.rangeMoveDraging(event, jfgrid.formula.rangeMovexy, jfgrid.formula.rangeMoveObj.data("range"), jfgrid.formula.rangeMoveObj, sheetBarHeight, statisticBarHeight);
                    }
                    else if (!!jfgrid.chart_selection.rangeResize) {
                        jfgrid.chart_selection.rangeResizeDraging(event, sheetBarHeight, statisticBarHeight);
                    }
                    else if (!!jfgrid.chart_selection.rangeMove) {
                        jfgrid.chart_selection.rangeMoveDraging(event, sheetBarHeight, statisticBarHeight);
                    }
                }, 1);
            }
        });

        $(document).mouseup(function (event) {
            //数据窗格主体

            if (jfgird_select_status) {
                clearTimeout(jfcountfuncTimeout);
                jfcountfuncTimeout = setTimeout(function(){
                    jfcountfunc();
                }, 0);

                //格式刷
                if(jfgrid.menuButton.jfgridPaintModelOn){
                    jfgrid.selection.pasteHandlerOfPaintModel(jfgrid_copy_save);

                    if(jfgrid.menuButton.jfgridPaintSingle){
                        //单次 格式刷
                        jfgrid.menuButton.cancelPaintModel();
                    }
                }
            }

            //$("#text-select").remove();

            jfgird_select_status = false;
            clearTimeout(jfautoscrollTimeout);
            jfgird_scroll_status = false;

            $("#jfgrid-cell-selected").find(".jfgrid-cs-fillhandle").css("cursor","crosshair").end().find(".jfgrid-cs-draghandle").css("cursor","move");
            $("#jfgrid-cell-main, #jfgridTableContent, #jfgrid-sheettable_0").css("cursor","default");

            //行标题窗格主体
            jfgrid_rows_selected_status = false;

            //列标题窗格主体
            jfgrid_cols_selected_status = false;

            jfgrid_model_move_state = false;

            // if (jfgridautoadjustmousedown == 1) {
            //     //jfgrid.jfgridscrollevent(true);
            //     jfgridautoadjustmousedown = 2;
            // }

            if(jfgrid.formula.functionResizeStatus){
                jfgrid.formula.functionResizeStatus = false;
                $("#jfgrid-wa-calculate-size").removeAttr("style");
            }


            if (!!jfgrid.freezen.horizontalmovestate) {
                jfgrid.freezen.horizontalmovestate = false;
                $("#jfgrid-freezebar-horizontal").removeClass("jfgrid-freezebar-active");
                $("#jfgrid-freezebar-horizontal").find(".jfgrid-freezebar-horizontal-handle").css("cursor", "-webkit-grab");
                if (jfgrid.freezen.freezenhorizontaldata[4] <= columeHeaderHeight) {
                    jfgrid.freezen.cancelFreezenHorizontal();
                }
                jfgrid.freezen.createAssistCanvas();
                jfgrid.jfgridrefreshgrid();
            }

            if (!!jfgrid.freezen.verticalmovestate) {
                jfgrid.freezen.verticalmovestate = false;
                $("#jfgrid-freezebar-vertical").removeClass("jfgrid-freezebar-active");
                $("#jfgrid-freezebar-vertical").find(".jfgrid-freezebar-vertical-handle").css("cursor", "-webkit-grab");
                if (jfgrid.freezen.freezenverticaldata[4] <= rowHeaderWidth) {
                    jfgrid.freezen.cancelFreezenVertical();
                }
                jfgrid.freezen.createAssistCanvas();
                jfgrid.jfgridrefreshgrid();
            }

            if (!!jfgrid.pivotTable && jfgrid.pivotTable.movestate) {
                $("#jfgrid-modal-dialog-slider-pivot-move").remove();
                jfgrid.pivotTable.movestate = false;
                $("#jfgrid-modal-dialog-pivotTable-list, #jfgrid-modal-dialog-config-filter, #jfgrid-modal-dialog-config-row, #jfgrid-modal-dialog-config-column, #jfgrid-modal-dialog-config-value").css("cursor", "default");
                if (jfgrid.pivotTable.movesave.containerid != "jfgrid-modal-dialog-pivotTable-list") {
                    var $cur = $(event.target).closest(".jfgrid-modal-dialog-slider-config-list");
                    if ($cur.length == 0) {
                        if (jfgrid.pivotTable.movesave.containerid == "jfgrid-modal-dialog-config-value") {
                            jfgrid.pivotTable.resetOrderby(jfgrid.pivotTable.movesave.obj);
                        }
                        jfgrid.pivotTable.movesave.obj.remove();
                        jfgrid.pivotTable.showvaluecolrow();
                        $("#jfgrid-modal-dialog-pivotTable-list").find(".jfgrid-modal-dialog-slider-list-item").each(function () {
                            $(this).find(".jfgrid-slider-list-item-selected").find("i").remove();
                        });

                        $("#jfgrid-modal-dialog-config-filter, #jfgrid-modal-dialog-config-row, #jfgrid-modal-dialog-config-column, #jfgrid-modal-dialog-config-value").find(".jfgrid-modal-dialog-slider-config-item").each(function () {
                            var index = $(this).data("index");

                            $("#jfgrid-modal-dialog-pivotTable-list").find(".jfgrid-modal-dialog-slider-list-item").each(function () {
                                var $seleted = $(this).find(".jfgrid-slider-list-item-selected");
                                if ($(this).data("index") == index && $seleted.find("i").length == 0) {
                                    $seleted.append('<i class="fa fa-check jfgrid-mousedown-cancel"></i>');
                                }
                            });

                        });
                        jfgrid.pivotTable.refreshPivotTable();
                    }
                }
            }

            if (!!jfgrid.chartparam.jfgrid_chart_point_config && jfgrid.chartparam.jfgrid_chart_point_config.movestart) {
                clearTimeout(jfgrid.chartparam.jfgrid_chart_point_config.lagTimeoutclick);
                jfgrid.chartparam.jfgrid_chart_point_config.mouseupdone = true;
                jfgrid.chartparam.jfgrid_chart_point_config.movestart = false;

                $("#jfgrid-chart-point-selectedhelp").hide();

                jfgrid.chartparam.jfgrid_chart_point_config.objectIndicator = [];
                jfgrid.chartparam.jfgrid_chart_point_config.changeindex = [];

                var dataOpt = null, initialpointset = true;
                var currentOpt = jfgrid.chartparam.jfgrid_chart_point_config.pointchart.getOption();
                $("#jfgrid-chart-point-config .jfgrid-chart-point-searchitem-c").find(".jfgrid-chart-point-searchitem-active").each(function () {
                    jfgrid.chartparam.jfgrid_chart_point_config.changeindex.push($(this).data("index"));

                    var dataOpt1 = currentOpt.series[0].data[$(this).data("index")];
                    if (initialpointset && !(dataOpt1 instanceof Array)) {
                        initialpointset = false;
                        dataOpt = dataOpt1;
                    }
                });

                jfgrid.jfgridactivepointconfig(currentOpt, dataOpt);
                //var data = jfgrid.chartparam.jfgrid_chart_point_config.pointchart.series[0].data[jfgrid.chartparam.jfgrid_chart_point_config.changeindex[0]]
            }

            if (jfgird_sheet_move_status) {
                jfgird_sheet_move_status = false;
                jfgird_sheet_move_data.activeobject.insertBefore($("#jfgrid-sheets-item-clone"));
                jfgird_sheet_move_data.activeobject.removeAttr("style");
                //jfgird_sheet_move_data.activeobject.css({ "position": "relative", "opacity": 1, "cursor": "pointer", "transition": "all 0.1s", "z-index": "initial" });
                $("#jfgrid-sheets-item-clone").remove();
                jfgird_sheet_move_data.cursorobject.css({ "cursor": "pointer" });
                jfgird_sheet_move_data = {};
                jfgrid.sheetmanage.reOrderAllSheet();
            }

            clearTimeout(jfgrid.chartparam.jfgridCurrentChartMoveTimeout);
            
            //图表拖动 chartMix
            if (jfgrid.chartparam.jfgridCurrentChartMove) {
                jfgrid.chartparam.jfgridCurrentChartMove = false;
                if (jfgrid.chartparam.jfgridInsertChartTosheetChange) {

                    //myTop, myLeft: 本次的chart框位置，scrollLeft,scrollTop: 上一次的滚动条位置
                    var myTop = jfgrid.chartparam.jfgridCurrentChartMoveObj.css("top"), myLeft = jfgrid.chartparam.jfgridCurrentChartMoveObj.css("left"), scrollLeft = $("#jfgrid-cell-main").scrollLeft(), scrollTop = $("#jfgrid-cell-main").scrollTop();

                    //点击时候存储的信息，即上一次操作结束的图表信息，x,y: chart框位置，scrollLeft1,scrollTop1: 滚动条位置
                    var x = jfgrid.chartparam.jfgridCurrentChartMoveXy[2];
                    var y = jfgrid.chartparam.jfgridCurrentChartMoveXy[3];

                    var scrollLeft1 = jfgrid.chartparam.jfgridCurrentChartMoveXy[4];
                    var scrollTop1 = jfgrid.chartparam.jfgridCurrentChartMoveXy[5];

                    var chart_id = jfgrid.chartparam.jfgridCurrentChartMoveObj.find(".jfgrid-modal-dialog-content").attr("id");

                    var sheetIndex = !!window.store && store.state.chartSetting.chartList[chart_id].sheetIndex;

                    //去除chartobj,改用chart_id代替即可定位到此图表
                    jfgrid.jfredo.push({ "type": "moveChart", "chart_id": chart_id, "sheetIndex": sheetIndex, "myTop": myTop, "myLeft": myLeft, "scrollTop": scrollTop, "scrollLeft": scrollLeft, "x": x, "y": y, "scrollTop1": scrollTop1, "scrollLeft1": scrollLeft1  });
                    
                    //在store中更新数据
                    !!window.store && store.commit({
                        type:"updateChartItem",
                        key:"left",
                        value:myLeft,
                        chartId:chart_id
                    });

                    !!window.store && store.commit({
                        type:"updateChartItem",
                        key:"top",
                        value:myTop,
                        chartId:chart_id
                    });

                    // jfgrid.sheetmanage.saveChart({ "chart_id": chart_id, "sheetIndex": sheetIndex, "top": myTop, "left": myLeft });
                    //存储滚动条位置
                    jfgrid.server.saveParam("c", sheetIndex, { "left":myLeft, "top":myTop,"scrollTop": scrollTop, "scrollLeft": scrollLeft }, { "op":"xy", "cid": chart_id});
                    //协同编辑时可能影响用户操作，可以考虑不存储滚动条位置（google sheet没有存储滚动条位置）
                    // jfgrid.server.saveParam("c", sheetIndex, { "left":myLeft, "top":myTop }, { "op":"xy", "cid": chart_id});
                }
            }

            if (!!jfgrid.formula.rangeResize) {
                jfgrid.formula.rangeResizeDragged(event, jfgrid.formula.rangeResizeObj, jfgrid.formula.rangeResize, jfgrid.formula.rangeResizexy, jfgrid.formula.rangeResizeWinW, jfgrid.formula.rangeResizeWinH);
            }


             //图表改变大小 chartMix
            if (!!jfgrid.chartparam.jfgridCurrentChartResize) {
                jfgrid.chartparam.jfgridCurrentChartResize = null;
                if (jfgrid.chartparam.jfgridInsertChartTosheetChange) {
                    var myHeight = jfgrid.chartparam.jfgridCurrentChartResizeObj.height(), myWidth = jfgrid.chartparam.jfgridCurrentChartResizeObj.width(), scrollLeft = $("#jfgrid-cell-main").scrollLeft(), scrollTop = $("#jfgrid-cell-main").scrollTop();

                    var myTop = jfgrid.chartparam.jfgridCurrentChartMoveObj.css("top"),
                        myLeft = jfgrid.chartparam.jfgridCurrentChartMoveObj.css("left")

                   
                    var chart_id = jfgrid.chartparam.jfgridCurrentChartResizeObj.find(".jfgrid-modal-dialog-content").attr("id");
                    var sheetIndex = !!window.store && store.state.chartSetting.chartList[chart_id].sheetIndex;

                    var myWidth1 = jfgrid.chartparam.jfgridCurrentChartResizeXy[2];
                    var myHeight1 = jfgrid.chartparam.jfgridCurrentChartResizeXy[3];
                    var x = jfgrid.chartparam.jfgridCurrentChartResizeXy[4];//增加上一次的位置x，y
                    var y = jfgrid.chartparam.jfgridCurrentChartResizeXy[5];
                    var scrollLeft1 = jfgrid.chartparam.jfgridCurrentChartResizeXy[6];
                    var scrollTop1 = jfgrid.chartparam.jfgridCurrentChartResizeXy[7];

                    jfgrid.jfredo.push({ "type": "resizeChart", "chart_id": chart_id, "sheetIndex": sheetIndex,"myTop": myTop, "myLeft": myLeft, "myHeight": myHeight, "myWidth": myWidth, "scrollTop": scrollTop, "scrollLeft": scrollLeft, "x": x, "y": y, "myWidth1": myWidth1, "myHeight1": myHeight1, "scrollTop1": scrollTop1, "scrollLeft1": scrollLeft1 });

                    !!window.store && store.commit({
                        type:"updateChartItem",
                        key:"height",
                        value:myHeight,
                        chartId:chart_id
                    });

                    !!window.store && store.commit({
                        type:"updateChartItem",
                        key:"width",
                        value:myWidth,
                        chartId:chart_id
                    });

                    !!window.store && store.commit({
                        type:"updateChartItem",
                        key:"left",
                        value:myLeft,
                        chartId:chart_id
                    });

                    !!window.store && store.commit({
                        type:"updateChartItem",
                        key:"top",
                        value:myTop,
                        chartId:chart_id
                    });

                    //加上滚动条的位置
                    // jfgrid.sheetmanage.saveChart({ "chart_id": chart_id, "sheetIndex": sheetIndex, "height": myHeight, "width": myWidth, "top": myTop, "left": myLeft, "scrollTop": scrollTop, "scrollLeft": scrollLeft });

                    jfgrid.server.saveParam("c", sheetIndex, { "width":myWidth, "height":myHeight, "top": myTop, "left": myLeft, "scrollTop": scrollTop, "scrollLeft": scrollLeft}, { "op":"wh", "cid": chart_id});
                    // jfgrid.server.saveParam("c", sheetIndex, { "width":myWidth, "height":myHeight, "top": myTop, "left": myLeft }, { "op":"wh", "cid": chart_id});
                }
            }

            //批注框 移动
            if (jfgrid.postil.move) {
                jfgrid.postil.move = false;

                var ps_id = jfgrid.postil.currentObj.closest(".jfgrid-postil-show").attr("id");

                var ps_r = ps_id.split("jfgrid-postil-show_")[1].split("_")[0];
                var ps_c = ps_id.split("jfgrid-postil-show_")[1].split("_")[1];

                var d = jfgrid.editor.deepCopyFlowData(jfgrid.flowdata);
                var rc = [];

                d[ps_r][ps_c].ps.left = jfgrid.postil.currentObj.position().left;
                d[ps_r][ps_c].ps.top = jfgrid.postil.currentObj.position().top;
                d[ps_r][ps_c].ps.value = jfgrid.postil.currentObj.find(".formulaInputFocus").text();

                rc.push(ps_r + "_" + ps_c);

                jfgrid.postil.ref(d, rc);

                $("#" + ps_id).remove();

                if(d[ps_r][ps_c].ps.isshow){
                    jfgrid.postil.buildPs(ps_r, ps_c, d[ps_r][ps_c].ps);
                    $("#" + ps_id).addClass("jfgrid-postil-show-active");
                    $("#" + ps_id).find(".jfgrid-postil-dialog-resize").show();
                }
                else{
                    jfgrid.postil.editPs(ps_r, ps_c);
                }
            }

            //批注框 改变大小
            if (!!jfgrid.postil.resize) {
                jfgrid.postil.resize = null;

                var ps_id = jfgrid.postil.currentObj.closest(".jfgrid-postil-show").attr("id");

                var ps_r = ps_id.split("jfgrid-postil-show_")[1].split("_")[0];
                var ps_c = ps_id.split("jfgrid-postil-show_")[1].split("_")[1];

                var d = jfgrid.editor.deepCopyFlowData(jfgrid.flowdata);
                var rc = [];

                d[ps_r][ps_c].ps.left = jfgrid.postil.currentObj.position().left;
                d[ps_r][ps_c].ps.top = jfgrid.postil.currentObj.position().top;
                d[ps_r][ps_c].ps.width = jfgrid.postil.currentObj.outerWidth();
                d[ps_r][ps_c].ps.height = jfgrid.postil.currentObj.outerHeight();
                d[ps_r][ps_c].ps.value = jfgrid.postil.currentObj.find(".formulaInputFocus").text();

                rc.push(ps_r + "_" + ps_c);

                jfgrid.postil.ref(d, rc);

                $("#" + ps_id).remove();

                if(d[ps_r][ps_c].ps.isshow){
                    jfgrid.postil.buildPs(ps_r, ps_c, d[ps_r][ps_c].ps);
                    $("#" + ps_id).addClass("jfgrid-postil-show-active");
                    $("#" + ps_id).find(".jfgrid-postil-dialog-resize").show();
                }
                else{
                    jfgrid.postil.editPs(ps_r, ps_c);
                }
            }

            //改变行高
            if (jfgrid_rows_change_size) {
                jfgrid_rows_change_size = false;

                $("#jfgrid-change-size-line").hide();
                $("#jfgrid-rows-change-size").css("opacity", 0);
                $("#jfgrid-sheettable, #jfgrid-rows-h, #jfgrid-rows-h canvas").css("cursor", "default");

                var mouse = mouseposition(event.pageX, event.pageY);
                var scrollTop = $("#jfgrid-rows-h").scrollTop();
                var y = mouse[1] + scrollTop;
                var winH = $(window).height();

                var rowLocation = jfgrid.rowLocation(y), row = rowLocation[1], row_pre = rowLocation[0], row_index = rowLocation[2];

                if(jfgridConfigsetting.pointEdit){//编辑器qksheet表格编辑状态
                    var size = (y + 3) / jfgridConfigsetting.pointEditZoom - jfgrid_rows_change_size_start[0];

                    if ((y + 3) / jfgridConfigsetting.pointEditZoom - jfgrid_rows_change_size_start[0] < 19) {
                        size = 19;
                    }

                    if (y / jfgridConfigsetting.pointEditZoom >= winH - 200 + scrollTop) {
                        size = winW - 200 - jfgrid_rows_change_size_start[0] + scrollTop;
                    }
                }
                else{
                    var size = (y + 3) - jfgrid_rows_change_size_start[0];

                    if ((y + 3) - jfgrid_rows_change_size_start[0] < 19) {
                        size = 19;
                    }

                    if (y >= winH - 200 + scrollTop) {
                        size = winW - 200 - jfgrid_rows_change_size_start[0] + scrollTop;
                    }
                }

                var cfg = $.extend(true, {}, config);
                if (cfg["rowlen"] == null) {
                    cfg["rowlen"] = {};
                }

                cfg["rowlen"][jfgrid_rows_change_size_start[1]] = Math.ceil(size);

                if (clearjfundo) {
                    jfgrid.jfundo = [];

                    jfgrid.jfredo.push({
                        "type": "resize",
                        "ctrlType": "resizeR",
                        "config": $.extend(true, {}, config),
                        "curconfig": $.extend(true, {}, cfg),
                        "sheetIndex": jfgrid.currentSheetIndex
                    });
                }

                //config
                config = cfg;
                jfgridfile[jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex)].config = config;

                jfgrid.server.saveParam("cg", jfgrid.currentSheetIndex, cfg["rowlen"], { "k": "rowlen" });

                jfgrid.jfrefreshgrid_rhcw(jfgrid.flowdata.length, null);

                // if ($("#jfgrid-filter-options-sheet" + jfgrid.currentSheetIndex).length > 0) {
                //     var $t = $("#jfgrid-filter-options-sheet" + jfgrid.currentSheetIndex).find(".jfgrid-filter-options").eq(0);
                //     var st_r = $t.data("str"), ed_r = $t.data("edr"), cindex = $t.data("cindex"), st_c = $t.data("stc"), ed_c = $t.data("edc");
                //     jfgrid.filterseletedbyindex(st_r, ed_r, st_c, ed_c);
                // }

                //jfgrid.cleargridelement(event);
            }

            //改变列宽
            if (jfgrid_cols_change_size) {
                jfgrid_cols_change_size = false;
                
                $("#jfgrid-change-size-line").hide();
                $("#jfgrid-cols-change-size").css("opacity", 0);
                $("#jfgrid-sheettable, #jfgrid-cols-h-c, .jfgrid-cols-h-cells, .jfgrid-cols-h-cells canvas").css("cursor", "default");

                var mouse = mouseposition(event.pageX, event.pageY);
                var scrollLeft = $("#jfgrid-cols-h-c").scrollLeft();
                var x = mouse[0] + scrollLeft;
                var winW = $(window).width();

                var row_index = visibledatarow.length - 1, row = visibledatarow[row_index], row_pre = 0;
                var colLocation = jfgrid.colLocation(x), col = colLocation[1], col_pre = colLocation[0], col_index = colLocation[2];

                if(jfgridConfigsetting.pointEdit){//编辑器qksheet表格编辑状态
                    var size = (x + 3) / jfgridConfigsetting.pointEditZoom - jfgrid_cols_change_size_start[0];
                }
                else{
                    var size = (x + 3) - jfgrid_cols_change_size_start[0];
                }

                var firstcolumlen = defaultcollen;
                if (config["columlen"] != null && config["columlen"][jfgrid_cols_change_size_start[1]] != null) {
                    firstcolumlen = config["columlen"][jfgrid_cols_change_size_start[1]];
                }

                if (Math.abs(size - firstcolumlen) < 3) {
                    return;
                }

                if(jfgridConfigsetting.pointEdit){//编辑器qksheet表格编辑状态
                    if ((x + 3) / jfgridConfigsetting.pointEditZoom - jfgrid_cols_change_size_start[0] < 30) {
                        size = 30;
                    }

                    if (x / jfgridConfigsetting.pointEditZoom >= winW - 100 + scrollLeft) {
                        size = winW - 100 - jfgrid_cols_change_size_start[0] + scrollLeft;
                    }
                }
                else{
                    if ((x + 3) - jfgrid_cols_change_size_start[0] < 30) {
                        size = 30;
                    }

                    if (x >= winW - 100 + scrollLeft) {
                        size = winW - 100 - jfgrid_cols_change_size_start[0] + scrollLeft;
                    }
                }

                var cfg = $.extend(true, {}, config);
                if (cfg["columlen"] == null) {
                    cfg["columlen"] = {};
                }

                cfg["columlen"][jfgrid_cols_change_size_start[1]] = Math.ceil(size);

                if (clearjfundo) {
                    jfgrid.jfundo = [];

                    jfgrid.jfredo.push({
                        "type": "resize",
                        "ctrlType": "resizeC",
                        "config": $.extend(true, {}, config),
                        "curconfig": $.extend(true, {}, cfg),
                        "sheetIndex": jfgrid.currentSheetIndex
                    });
                }

                //config
                config = cfg;
                jfgridfile[jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex)].config = config;

                jfgrid.server.saveParam("cg", jfgrid.currentSheetIndex, cfg["columlen"], { "k": "columlen" });

                jfgrid.jfrefreshgrid_rhcw(null, jfgrid.flowdata[0].length);

                // if ($("#jfgrid-filter-options-sheet" + jfgrid.currentSheetIndex).length > 0) {
                //     var $t = $("#jfgrid-filter-options-sheet" + jfgrid.currentSheetIndex).find(".jfgrid-filter-options").eq(0);
                //     var st_r = $t.data("str"), ed_r = $t.data("edr"), cindex = $t.data("cindex"), st_c = $t.data("stc"), ed_c = $t.data("edc");
                //     jfgrid.filterseletedbyindex(st_r, ed_r, st_c, ed_c);
                // }

                setTimeout(function () {
                    jfgrid.jfgridrefreshgrid();
                }, 1);
                //jfgrid.cleargridelement(event);
            }

            if (jfgrid.formula.rangeMove) {
                jfgrid.formula.rangeMoveDragged(jfgrid.formula.rangeMoveObj);
            }

            //改变选择框的位置并替换目标单元格
            if (jfgrid_cell_selected_move) {
                $("#jfgrid-cell-selected-move").hide();

                jfgrid_cell_selected_move = false;
                var mouse = mouseposition(event.pageX, event.pageY);

                var scrollLeft = $("#jfgrid-cell-main").scrollLeft();
                var scrollTop = $("#jfgrid-cell-main").scrollTop();

                var x = mouse[0] + scrollLeft;
                var y = mouse[1] + scrollTop;

                var winH = $(window).height() + scrollTop - sheetBarHeight - statisticBarHeight, winW = $(window).width() + scrollLeft;

                var rowLocation = jfgrid.rowLocation(y), row_index = rowLocation[2];
                var colLocation = jfgrid.colLocation(x), col_index = colLocation[2];

                var row_index_original = jfgrid_cell_selected_move_index[0], col_index_original = jfgrid_cell_selected_move_index[1];

                if(row_index == row_index_original && col_index == col_index_original){
                    return;
                }

                var d = jfgrid.editor.deepCopyFlowData(jfgrid.flowdata);
                var last = jfgird_select_save[jfgird_select_save.length - 1];
               
                var data = jfgrid.getdatabyselection(last);

                var cfg = $.extend(true, {}, config);
                if(cfg["merge"] == null){
                    cfg["merge"] = {};
                }
                if(cfg["rowlen"] == null){
                    cfg["rowlen"] = {};
                }

                //选区包含部分单元格
                if(jfgrid.hasPartMC(cfg, last["row"][0], last["row"][1], last["column"][0], last["column"][1])){
                    if(jfgrid.isEditMode()){
                        alert("无法对合并单元格执行此操作");
                    }
                    else{
                        jfgrid.tooltip.info('<i class="fa fa-exclamation-triangle"></i>提示',"无法对合并单元格执行此操作");
                    }
                    return;
                }

                var row_s = last["row"][0] - row_index_original + row_index, row_e = last["row"][1] - row_index_original + row_index;
                var col_s = last["column"][0] - col_index_original + col_index, col_e = last["column"][1] - col_index_original + col_index;
                
                if (row_s < 0 || y < 0) {
                    row_s = 0;
                    row_e = last["row"][1] - last["row"][0];
                }

                if (col_s < 0 || x < 0) {
                    col_s = 0;
                    col_e = last["column"][1] - last["column"][0];
                }

                if (row_e >= visibledatarow[visibledatarow.length - 1] || y > winH) {
                    row_s = visibledatarow.length - 1 - last["row"][1] + last["row"][0];
                    row_e = visibledatarow.length - 1;
                }

                if (col_e >= visibledatacolumn[visibledatacolumn.length - 1] || x > winW) {
                    col_s = visibledatacolumn.length - 1 - last["column"][1] + last["column"][0];
                    col_e = visibledatacolumn.length - 1;
                }

                //替换的位置包含部分单元格
                if(jfgrid.hasPartMC(cfg, row_s, row_e, col_s, col_e)){
                    if(jfgrid.isEditMode()){
                        alert("无法对合并单元格执行此操作");
                    }
                    else{
                        jfgrid.tooltip.info('<i class="fa fa-exclamation-triangle"></i>提示',"无法对合并单元格执行此操作");
                    }
                    return;
                }

                var borderInfoCompute = jfgrid.getBorderInfoCompute(jfgrid.currentSheetIndex);


                //删除原本位置的数据
                var RowlChange = null;
                for (var r = last["row"][0]; r <= last["row"][1]; r++) {
                    if(r in cfg["rowlen"]){
                        RowlChange = true;
                    }

                    for (var c = last["column"][0]; c <= last["column"][1]; c++) {
                        var cell = d[r][c];

                        if(jfgrid.getObjType(cell) == "object" && ("mc" in cell)){
                            if((cell["mc"].r + "_" + cell["mc"].c) in cfg["merge"]){
                                delete cfg["merge"][cell["mc"].r + "_" + cell["mc"].c];
                            }
                        }

                        d[r][c] = null;
                    }
                }

                //边框
                if(cfg["borderInfo"] && cfg["borderInfo"].length > 0){
                    var borderInfo = [];

                    for(var i = 0; i < cfg["borderInfo"].length; i++){
                        var bd_rangeType = cfg["borderInfo"][i].rangeType;

                        if(bd_rangeType == "range"){
                            var bd_range = cfg["borderInfo"][i].range;
                            var bd_emptyRange = [];

                            for(var j = 0; j < bd_range.length; j++){
                                bd_emptyRange = bd_emptyRange.concat(jfgrid.conditionformat.CFSplitRange(bd_range[j], {"row": last["row"], "column": last["column"]}, {"row": [row_s, row_e], "column": [col_s, col_e]}, "restPart"));
                            }

                            cfg["borderInfo"][i].range = bd_emptyRange;

                            borderInfo.push(cfg["borderInfo"][i]);
                        }
                        else if(bd_rangeType == "cell"){
                            var bd_r = cfg["borderInfo"][i].value.row_index;
                            var bd_c = cfg["borderInfo"][i].value.col_index;

                            if(!(bd_r >= last["row"][0] && bd_r <= last["row"][1] && bd_c >= last["column"][0] && bd_c <= last["column"][1])){
                                borderInfo.push(cfg["borderInfo"][i]);
                            }
                        }
                    }

                    cfg["borderInfo"] = borderInfo;
                }
                
                //替换位置数据更新
                var offsetMC = {};
                for (var r = 0; r < data.length; r++) {
                    for (var c = 0; c < data[0].length; c++) {
                        if(borderInfoCompute[(r + last["row"][0]) + "_" + (c + last["column"][0])]){
                            var bd_obj = {
                                "rangeType": "cell",
                                "value": {
                                    "row_index": r + row_s,
                                    "col_index": c + col_s,
                                    "l": borderInfoCompute[(r + last["row"][0]) + "_" + (c + last["column"][0])].l,
                                    "r": borderInfoCompute[(r + last["row"][0]) + "_" + (c + last["column"][0])].r,
                                    "t": borderInfoCompute[(r + last["row"][0]) + "_" + (c + last["column"][0])].t,
                                    "b": borderInfoCompute[(r + last["row"][0]) + "_" + (c + last["column"][0])].b
                                }
                            }

                            if(cfg["borderInfo"] == null){
                                cfg["borderInfo"] = [];
                            }

                            cfg["borderInfo"].push(bd_obj);
                        }

                        var value = "";
                        if (data[r] != null && data[r][c] != null) {
                            value = data[r][c];
                        }

                        if(jfgrid.getObjType(value) == "object" && ("mc" in value)){
                            var mc = $.extend(true, {}, value["mc"]);
                            if("rs" in value["mc"]){
                                offsetMC[mc.r + "_" + mc.c] = [r + row_s, c + col_s];

                                value["mc"].r = r + row_s;
                                value["mc"].c = c + col_s;

                                cfg["merge"][(r + row_s) + "_" + (c + col_s)] = value["mc"];
                            }
                            else{
                                value["mc"].r = offsetMC[mc.r + "_" + mc.c][0];
                                value["mc"].c = offsetMC[mc.r + "_" + mc.c][1];   
                            }
                        }
                        d[r + row_s][c + col_s] = value;
                    }
                }

                if(RowlChange){
                    cfg = jfgrid.rowlenByRange(d, last["row"][0], last["row"][1], cfg);
                    cfg = jfgrid.rowlenByRange(d, row_s, row_e, cfg);
                }

                //条件格式
                var cdformat = $.extend(true, [], jfgridfile[jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex)]["jfgrid_conditionformat_save"]);
                if(cdformat != null && cdformat.length > 0){
                    for(var i = 0; i < cdformat.length; i++){
                        var cdformat_cellrange = cdformat[i].cellrange;
                        var emptyRange = [];
                        for(var j = 0; j < cdformat_cellrange.length; j++){
                            var range = jfgrid.conditionformat.CFSplitRange(cdformat_cellrange[j], {"row": last["row"], "column": last["column"]}, {"row": [row_s, row_e], "column": [col_s, col_e]}, "allPart");
                            emptyRange = emptyRange.concat(range);
                        }
                        cdformat[i].cellrange = emptyRange;
                    }
                }

                if(jfgird_select_save[0].row_focus == jfgird_select_save[0].row[0]){
                    var rf = row_s;
                }
                else{
                    var rf = row_e;
                }

                if(jfgird_select_save[0].column_focus == jfgird_select_save[0].column[0]){
                    var cf = col_s;
                }
                else{
                    var cf = col_e;
                }

                var range = [];
                range.push({ "row": last["row"], "column": last["column"] });
                range.push({ "row": [row_s, row_e], "column": [col_s, col_e] });

                last["row"] = [row_s, row_e];
                last["column"] = [col_s, col_e];
                last["row_focus"] = rf;
                last["column_focus"] = cf;

                jfgrid.jfrefreshgrid(d, range, cfg, cdformat, RowlChange);

                jfgrid.selectHightlightShow();

                $("#jfgrid-sheettable").css("cursor", "default");
                clearTimeout(jfcountfuncTimeout);
                jfcountfuncTimeout = setTimeout(function () { jfcountfunc() }, 500);
            }

            //图表选区拖拽移动
            if (jfgrid.chart_selection.rangeMove) {
                jfgrid.chart_selection.rangeMoveDragged();
            }

            //图表选区拖拽拉伸
            if (!!jfgrid.chart_selection.rangeResize) {
                jfgrid.chart_selection.rangeResizeDragged();
            }

            //选区下拉
            if (jfgrid_cell_selected_extend) {
                jfgrid_cell_selected_extend = false;
                $("#jfgrid-cell-selected-extend").hide();

                var mouse = mouseposition(event.pageX, event.pageY);
                var scrollLeft = $("#jfgrid-cell-main").scrollLeft();
                var scrollTop = $("#jfgrid-cell-main").scrollTop();

                var x = mouse[0] + scrollLeft - 5;
                var y = mouse[1] + scrollTop - 5;

                var winH = $(window).height() + scrollTop - sheetBarHeight - statisticBarHeight, winW = $(window).width() + scrollLeft;

                var rowLocation = jfgrid.rowLocation(y), row = rowLocation[1], row_pre = rowLocation[0], row_index = rowLocation[2];
                var colLocation = jfgrid.colLocation(x), col = colLocation[1], col_pre = colLocation[0], col_index = colLocation[2];

                var row_index_original = jfgrid_cell_selected_extend_index[0], col_index_original = jfgrid_cell_selected_extend_index[1];

                var last = jfgird_select_save[jfgird_select_save.length - 1];
                var row_s = last["row"][0], row_e = last["row"][1];
                var col_s = last["column"][0], col_e = last["column"][1];

                if (row_s < 0 || y < 0) {
                    row_s = 0;
                    row_e = last["row"][1] - last["row"][0];
                }

                if (col_s < 0 || x < 0) {
                    col_s = 0;
                    col_e = last["column"][1] - last["column"][0];
                }

                if (row_e >= visibledatarow[visibledatarow.length - 1] || y > winH) {
                    row_s = visibledatarow.length - 1 - last["row"][1] + last["row"][0];
                    row_e = visibledatarow.length - 1;
                }

                if (col_e >= visibledatacolumn[visibledatacolumn.length - 1] || x > winW) {
                    col_s = visibledatacolumn.length - 1 - last["column"][1] + last["column"][0];
                    col_e = visibledatacolumn.length - 1;
                }

                //复制范围
                jfgrid.dropCell.copyRange = {"row": $.extend(true, [], last["row"]), "column": $.extend(true, [], last["column"])};
                //applyType
                var typeItemHide = jfgrid.dropCell.typeItemHide();
                
                if(!typeItemHide[0] && !typeItemHide[1] && !typeItemHide[2] && !typeItemHide[3] && !typeItemHide[4] && !typeItemHide[5] && !typeItemHide[6]){
                    jfgrid.dropCell.applyType = "0";
                }
                else{
                    jfgrid.dropCell.applyType = "1";
                }

                if (Math.abs(row_index_original - row_index) > Math.abs(col_index_original - col_index)) {
                    if (!(row_index >= row_s && row_index <= row_e)) {
                        if (jfgird_select_save[0].top_move >= row_pre) {//当往上拖拽时
                            jfgrid.dropCell.applyRange = {"row": [row_index, last["row"][0] - 1], "column": last["column"]};
                            jfgrid.dropCell.direction = "up";

                            row_s -= last["row"][0] - row_index;

                            //是否有数据透视表范围
                            if(jfgrid.pivotTable.isPivotRange(row_s, col_e)){
                                jfgrid.tooltip.info("无法对所选单元格进行此更改，因为它会影响数据透视表！","");
                                return;
                            }
                        }
                        else {//当往下拖拽时
                            jfgrid.dropCell.applyRange = {"row": [last["row"][1] + 1, row_index], "column": last["column"]};
                            jfgrid.dropCell.direction = "down";

                            row_e += row_index - last["row"][1];

                            //是否有数据透视表范围
                            if(jfgrid.pivotTable.isPivotRange(row_e, col_e)){
                                jfgrid.tooltip.info("无法对所选单元格进行此更改，因为它会影响数据透视表！","");
                                return;
                            }
                        }
                    }
                    else{
                        return;
                    }
                }
                else {
                    if (!(col_index >= col_s && col_index <= col_e)) {
                        if (jfgird_select_save[0].left_move >= col_pre) {//当往左拖拽时
                            jfgrid.dropCell.applyRange = {"row": last["row"], "column": [col_index, last["column"][0] - 1]};
                            jfgrid.dropCell.direction = "left";

                            col_s -= last["column"][0] - col_index;

                            //是否有数据透视表范围
                            if(jfgrid.pivotTable.isPivotRange(row_e, col_s)){
                                jfgrid.tooltip.info("无法对所选单元格进行此更改，因为它会影响数据透视表！","");
                                return;
                            }
                        }
                        else {//当往右拖拽时
                            jfgrid.dropCell.applyRange = {"row": last["row"], "column": [last["column"][1] + 1, col_index]};
                            jfgrid.dropCell.direction = "right";

                            col_e += col_index - last["column"][1];

                            //是否有数据透视表范围
                            if(jfgrid.pivotTable.isPivotRange(row_e, col_e)){
                                jfgrid.tooltip.info("无法对所选单元格进行此更改，因为它会影响数据透视表！","");
                                return;
                            }
                        }
                    }
                    else{
                        return;
                    }
                }

                if(config["merge"] != null){
                    var hasMc = false;

                    for(var r = last["row"][0]; r <= last["row"][1]; r++){
                        for(var c = last["column"][0]; c <= last["column"][1]; c++){
                            var cell = jfgrid.flowdata[r][c];

                            if(cell != null && cell.mc != null){
                                hasMc = true;
                                break;
                            }
                        }
                    }

                    if(hasMc){
                        if(jfgrid.isEditMode()){
                            alert("无法对合并单元格执行此操作");
                        }
                        else{
                            jfgrid.tooltip.info("无法对合并单元格执行此操作", ""); 
                        }

                        return;
                    }

                    for(var r = row_s; r <= row_e; r++){
                        for(var c = col_s; c <= col_e; c++){
                            var cell = jfgrid.flowdata[r][c];

                            if(cell != null && cell.mc != null){
                                hasMc = true;
                                break;
                            }
                        }
                    }

                    if(hasMc){
                        if(jfgrid.isEditMode()){
                            alert("无法对合并单元格执行此操作");
                        }
                        else{
                            jfgrid.tooltip.info("无法对合并单元格执行此操作", ""); 
                        }

                        return;
                    }
                }

                last["row"] = [row_s, row_e];
                last["column"] = [col_s, col_e];

                jfgrid.dropCell.update();
                jfgrid.dropCell.createIcon();

                $("#jfgrid-cell-selected-move").hide();

                $("#jfgrid-sheettable").css("cursor", "default");
                clearTimeout(jfcountfuncTimeout);
                jfcountfuncTimeout = setTimeout(function () { jfcountfunc() }, 500);
            }
        });

        $("#jfgrid-left-top").mousedown(function (event) {
            $("#jfgrid-wa-functionbox-confirm").click();
            jfgird_select_status = false;
            
            jfgird_select_save = [{ "row": [0, jfgrid.flowdata.length - 1], "column": [0, jfgrid.flowdata[0].length - 1], "row_focus": 0, "column_focus": 0 }];
            jfgrid.selectHightlightShow();
            
            clearTimeout(jfcountfuncTimeout);
            jfcountfuncTimeout = setTimeout(function () { jfcountfunc() }, 500);

            event.stopPropagation();
        });

        var jfgrid_rows_selected_status = false;
        $("#jfgrid-rows-h").mousedown(function (event) {
            //有批注在编辑时
            jfgrid.postil.removeActivePs();

            var mouse = mouseposition(event.pageX, event.pageY);
            var y = mouse[1] + $("#jfgrid-rows-h").scrollTop();

            var rowLocation = jfgrid.rowLocation(y), row = rowLocation[1], row_pre = rowLocation[0], row_index = rowLocation[2];
            var col_index = visibledatacolumn.length - 1, col = visibledatacolumn[col_index], col_pre = 0;

            $("#jfgrid-rightclick-menu").hide();
            $("#jfgrid-sheet-list, #jfgrid-rightclick-sheet-menu").hide();

            //mousedown是右键
            if (event.which == "3") {
                var isright = false;

                for(var s = 0; s < jfgird_select_save.length; s++){
                    var obj_s = jfgird_select_save[s];

                    if(obj_s["row"] != null && (row_index >= obj_s["row"][0] && row_index <= obj_s["row"][1]) && (obj_s["column"][0] == 0 && obj_s["column"][1] == jfgrid.flowdata[0].length - 1)){
                        isright = true;
                        break;
                    }
                }

                if(isright){
                    return;
                }
            }

            var top = row_pre, height = row - row_pre - 1;
            var rowseleted = [row_index, row_index];

            jfgird_scroll_status = true;

            //公式相关
            var $input = $("#jfgrid-input-box");
            if (parseInt($input.css("top")) > 0) {
                if (jfgrid.formula.rangestart || jfgrid.formula.rangedrag_column_start || jfgrid.formula.rangedrag_row_start || jfgrid.formula.israngeseleciton() || $("#jfgrid-ifFormulaGenerator-multiRange-dialog").is(":visible")) {
                    //公式选区
                    var changeparam = jfgrid.menuButton.mergeMoveMain([0, col_index], rowseleted, {"row_focus": row_index, "column_focus": 0}, top, height, col_pre, col);
                    if(changeparam != null){
                        //columnseleted = changeparam[0];
                        rowseleted = changeparam[1];
                        top = changeparam[2];
                        height = changeparam[3];
                        //left = changeparam[4];
                        //width = changeparam[5];
                    }

                    if(event.shiftKey){
                        var last = jfgrid.formula.func_selectedrange;

                        var top = 0, height = 0, rowseleted = [];
                        if (last.top > row_pre) {
                            top = row_pre;
                            height = last.top + last.height - row_pre;

                            if(last.row[1] > last.row_focus){
                                last.row[1] = last.row_focus;
                            }

                            rowseleted = [row_index, last.row[1]];
                        }
                        else if (last.top == row_pre) {
                            top = row_pre;
                            height = last.top + last.height - row_pre;
                            rowseleted = [row_index, last.row[0]];
                        }
                        else {
                            top = last.top;
                            height = row - last.top - 1;

                            if(last.row[0] < last.row_focus){
                                last.row[0] = last.row_focus;
                            }

                            rowseleted = [last.row[0], row_index];
                        }

                        var changeparam = jfgrid.menuButton.mergeMoveMain([0, col_index], rowseleted, {"row_focus": row_index, "column_focus": 0}, top, height, col_pre, col);
                        if(changeparam != null){
                            // columnseleted = changeparam[0];
                            rowseleted = changeparam[1];
                            top = changeparam[2];
                            height = changeparam[3];
                            // left = changeparam[4];
                            // width = changeparam[5];
                        }

                        last["row"] = rowseleted;

                        last["top_move"] = top;
                        last["height_move"] = height;

                        jfgrid.formula.func_selectedrange = last;
                    }
                    else if(event.ctrlKey && $("#jfgrid-rich-text-editor").find("span").last().text() != ","){
                        //按住ctrl 选择选区时  先处理上一个选区
                        var vText = $("#jfgrid-rich-text-editor").text() + ",";
                        if(vText.length > 0 && vText.substr(0, 1) == "="){
                            vText = jfgrid.formula.functionHTMLGenerate(vText);

                            if (window.getSelection) { // all browsers, except IE before version 9
                                var currSelection = window.getSelection();
                                jfgrid.formula.functionRangeIndex = [$(currSelection.anchorNode).parent().index(), currSelection.anchorOffset];
                            } 
                            else { // Internet Explorer before version 9
                                var textRange = document.selection.createRange();
                                jfgrid.formula.functionRangeIndex = textRange;
                            }

                            $("#jfgrid-rich-text-editor").html(vText);

                            jfgrid.formula.canceFunctionrangeSelected();
                            jfgrid.formula.createRangeHightlight();
                        }

                        jfgrid.formula.rangestart = false;
                        jfgrid.formula.rangedrag_column_start = false;
                        jfgrid.formula.rangedrag_row_start = false;

                        $("#jfgrid-functionbox-cell").html(vText);
                        jfgrid.formula.rangeHightlightselected($("#jfgrid-rich-text-editor"));

                        //再进行 选区的选择
                        jfgrid.formula.israngeseleciton();
                        jfgrid.formula.func_selectedrange = {
                            "left": jfgrid.colLocationByIndex(0)[0],
                            "width": jfgrid.colLocationByIndex(0)[1] - jfgrid.colLocationByIndex(0)[0] - 1,
                            "top": top,
                            "height": height,
                            "left_move": col_pre, 
                            "width_move": col - col_pre - 1, 
                            "top_move": top, 
                            "height_move": height, 
                            "row": rowseleted, 
                            "column": [0, col_index], 
                            "row_focus": row_index, 
                            "column_focus": 0
                        }
                    }
                    else{
                        jfgrid.formula.func_selectedrange = {
                            "left": jfgrid.colLocationByIndex(0)[0],
                            "width": jfgrid.colLocationByIndex(0)[1] - jfgrid.colLocationByIndex(0)[0] - 1,
                            "top": top,
                            "height": height,
                            "left_move": col_pre, 
                            "width_move": col - col_pre - 1, 
                            "top_move": top, 
                            "height_move": height, 
                            "row": rowseleted, 
                            "column": [0, col_index], 
                            "row_focus": row_index, 
                            "column_focus": 0
                        }
                    }

                    if(jfgrid.formula.rangestart || jfgrid.formula.rangedrag_column_start || jfgrid.formula.rangedrag_row_start || jfgrid.formula.israngeseleciton()){
                        jfgrid.formula.rangeSetValue({ "row": rowseleted, "column": [null, null] });
                    }
                    else if($("#jfgrid-ifFormulaGenerator-multiRange-dialog").is(":visible")){//if公式生成器
                        var range = jfgrid.sheetmanage.getRangetxt(jfgrid.currentSheetIndex, { "row": rowseleted, "column": [0, col_index] }, jfgrid.currentSheetIndex);
                        $("#jfgrid-ifFormulaGenerator-multiRange-dialog input").val(range);
                    }

                    jfgrid.formula.rangedrag_row_start = true;
                    jfgrid.formula.rangestart = false;
                    jfgrid.formula.rangedrag_column_start = false;

                    $("#jfgrid-formula-functionrange-select").css({ "left": col_pre, "width": col - col_pre - 1, "top": top, "height": height }).show();
                    $("#jfgrid-formula-help-c").hide();

                    jfgrid.jfgrid_count_show(col_pre, top, col - col_pre - 1, height, rowseleted, [0, col_index]);

                    setTimeout(function(){
                        var currSelection = window.getSelection();
                        var anchorOffset = currSelection.anchorNode;
                        if($("#jfgrid-search-formula-parm").is(":visible")||$("#jfgrid-search-formula-parm-select").is(":visible")){
                            $editor=$("#jfgrid-rich-text-editor");
                            jfgrid.formula.rangechangeindex = jfgrid.formula.data_parm_index;
                        }
                        else{
                            $editor = $(anchorOffset).closest("div");
                        }
                        var $span = $editor.find("span[rangeindex='" + jfgrid.formula.rangechangeindex + "']");

                        jfgrid.formula.setCaretPosition($span.get(0), 0, $span.html().length);
                    }, 1);

                    return;
                }
                else {
                    jfgrid.formula.updatecell(jfgridCellUpdate[0], jfgridCellUpdate[1]);
                    jfgrid_rows_selected_status = true;
                }
            }
            else {
                jfgrid_rows_selected_status = true;
            }

            if (jfgrid_rows_selected_status) {
                if(event.shiftKey){
                    //按住shift点击行索引选取范围
                    var last = $.extend(true, {}, jfgird_select_save[jfgird_select_save.length - 1]); //选区最后一个

                    var top = 0, height = 0, rowseleted = [];
                    if (last.top > row_pre) {
                        top = row_pre;
                        height = last.top + last.height - row_pre;

                        if(last.row[1] > last.row_focus){
                            last.row[1] = last.row_focus;
                        }

                        rowseleted = [row_index, last.row[1]];
                    }
                    else if (last.top == row_pre) {
                        top = row_pre;
                        height = last.top + last.height - row_pre;
                        rowseleted = [row_index, last.row[0]];
                    }
                    else {
                        top = last.top;
                        height = row - last.top - 1;

                        if(last.row[0] < last.row_focus){
                            last.row[0] = last.row_focus;
                        }

                        rowseleted = [last.row[0], row_index];
                    }

                    last["row"] = rowseleted;

                    last["top_move"] = top;
                    last["height_move"] = height;

                    jfgird_select_save[jfgird_select_save.length - 1] = last;
                }
                else if(event.ctrlKey){
                    jfgird_select_save.push({ 
                        "left": jfgrid.colLocationByIndex(0)[0],
                        "width": jfgrid.colLocationByIndex(0)[1] - jfgrid.colLocationByIndex(0)[0] - 1,
                        "top": top,
                        "height": height,
                        "left_move": col_pre,
                        "width_move": col - col_pre - 1,
                        "top_move": top,
                        "height_move": height,
                        "row": rowseleted,
                        "column": [0, col_index],
                        "row_focus": row_index,
                        "column_focus": 0
                    });
                }
                else{
                    jfgird_select_save = [];
                    jfgird_select_save.push({ 
                        "left": jfgrid.colLocationByIndex(0)[0],
                        "width": jfgrid.colLocationByIndex(0)[1] - jfgrid.colLocationByIndex(0)[0] - 1,
                        "top": top,
                        "height": height,
                        "left_move": col_pre, 
                        "width_move": col - col_pre - 1, 
                        "top_move": top, 
                        "height_move": height, 
                        "row": rowseleted, 
                        "column": [0, col_index], 
                        "row_focus": row_index, 
                        "column_focus": 0
                    });
                }

                jfgrid.selectHightlightShow();

                if(jfgrid.server.allowUpdate){
                    //允许编辑后的后台更新时
                    jfgrid.server.saveParam("mv", jfgrid.currentSheetIndex, jfgird_select_save);
                }
            }

            $("#jfgrid-helpbox-cell").text(jfgrid.sheetmanage.getRangetxt(jfgrid.currentSheetIndex, jfgird_select_save[jfgird_select_save.length - 1]));

            setTimeout(function () {
                clearTimeout(jfcountfuncTimeout);
                jfcountfunc();
            }, 101);
        }).mousemove(function (event) {
            if (jfgrid_rows_selected_status || jfgrid_rows_change_size || jfgird_select_status) {
                $("#jfgrid-rows-h-hover").hide();
                return;
            }

            var mouse = mouseposition(event.pageX, event.pageY);
            var y = mouse[1] + $("#jfgrid-rows-h").scrollTop();

            var rowLocation = jfgrid.rowLocation(y), row = rowLocation[1], row_pre = rowLocation[0], row_index = rowLocation[2];

            $("#jfgrid-rows-h-hover").css({ "top": row_pre, "height": row - row_pre - 1, "display": "block" });

            if (y < row - 1 && y >= row - 5) {
                $("#jfgrid-rows-change-size").css({ "top": row - 3, "opacity": 0 });
            }
            else {
                //$("#jfgrid-rows-change-size").hide();
                $("#jfgrid-rows-change-size").css("opacity", 0);
            }
        }).mouseleave(function (event) {
            $("#jfgrid-rows-h-hover").hide();
            //$("#jfgrid-rows-change-size").hide();
            $("#jfgrid-rows-change-size").css("opacity", 0);
        }).mouseup(function (event) {
            if (event.which == 3) {
                if(jfgrid.isEditMode()){ //非编辑模式下禁止右键功能框
                    return;
                }

                $("#jfgrid-cols-rows-shift").hide();
                jfgridRightHeadClickIs = "row";
                $("#jfgrid-rightclick-menu .jfgrid-cols-rows-shift-word").text("行");
                $("#jfgrid-rightclick-menu .jfgrid-cols-rows-shift-size").text("高");
                $("#jfgrid-rightclick-menu .jfgrid-cols-rows-shift-left").text("上");
                $("#jfgrid-rightclick-menu .jfgrid-cols-rows-shift-right").text("下");

                $("#jfgrid-cols-rows-add").show();
                $("#jfgrid-cols-rows-data").show();
                $("#jfgrid-cols-rows-shift").hide();

                showrightclickmenu($("#jfgrid-rightclick-menu"), $(this).offset().left + 46, event.pageY);
                jfgrid_cols_menu_status = true;

                //行高默认值
                var cfg = $.extend(true, {}, config);
                if(cfg["rowlen"] == null){
                    cfg["rowlen"] = {};
                }

                var first_rowlen = cfg["rowlen"][jfgird_select_save[0].row[0]] == null ? jfgrid.defaultrowlen : cfg["rowlen"][jfgird_select_save[0].row[0]];
                var isSame = true;

                for(var i = 0; i < jfgird_select_save.length; i++){
                    var s = jfgird_select_save[i];
                    var r1 = s.row[0], r2 = s.row[1];

                    for(var r = r1; r <= r2; r++){
                        var rowlen = cfg["rowlen"][r] == null ? jfgrid.defaultrowlen : cfg["rowlen"][r];

                        if(rowlen != first_rowlen){
                            isSame = false;
                            break;
                        }
                    }
                }

                if(isSame){
                    $("#jfgrid-cols-rows-add").find("input[type='number'].rcsize").val(first_rowlen);
                }
                else{
                    $("#jfgrid-cols-rows-add").find("input[type='number'].rcsize").val("");
                }
            }
        });


        jfgrid.jfgrid_count_show = function (left, top, width, height, rowseleted, columnseleted) {
            var rowl = rowseleted[1] - rowseleted[0] + 1, coll = columnseleted[1] - columnseleted[0] + 1;
            var drawWidth = jfgridTableContentHW[0], drawHeight = jfgridTableContentHW[1];
            var scrollWidth = $("#jfgrid-cell-main").scrollLeft(), scrollHeight = $("#jfgrid-cell-main").scrollTop();

            if (rowl >= 4) {
                var leftv = left - 25;
                if (leftv < 0) {
                    leftv = left + 5;
                }

                if (leftv < scrollWidth) {
                    leftv = scrollWidth + 10;
                }

                var topv = top + height / 2;
                if (height > drawHeight) {
                    topv = scrollHeight + drawHeight / 2;
                }

                $("#jfgrid-row-count-show").css({ "left": leftv, "top": topv, "display": "block" }).html("<div>" + rowl.toString().split("").join("</div><div>") + "</div><div>行</div>");
            }
            else {
                $("#jfgrid-row-count-show").hide();
            }

            if (coll >= 4) {
                var topv = top - 25;
                if (topv < 0) {
                    topv = top + 5;
                }

                if (topv < scrollHeight) {
                    topv = scrollHeight + 10;
                }

                var leftv = left + width / 2;
                if (width > drawWidth) {
                    leftv = scrollWidth + drawWidth / 2;
                }

                $("#jfgrid-column-count-show").css({ "left": leftv, "top": topv, "display": "block" }).text(coll + "列");
            }
            else {
                $("#jfgrid-column-count-show").hide();
            }
        }

        var jfgrid_cols_selected_status = false;
        $("#jfgrid-cols-h-c").mousedown(function (event) {
            //有批注在编辑时
            jfgrid.postil.removeActivePs();

            var mouse = mouseposition(event.pageX, event.pageY);
            var x = mouse[0] + $(this).scrollLeft();

            var row_index = visibledatarow.length - 1, row = visibledatarow[row_index], row_pre = 0;
            var colLocation = jfgrid.colLocation(x), col = colLocation[1], col_pre = colLocation[0], col_index = colLocation[2];

            orderbyindex = col_index;//排序全局函数

            $("#jfgrid-rightclick-menu").hide();
            $("#jfgrid-sheet-list, #jfgrid-rightclick-sheet-menu").hide();
            $("#jfgrid-filter-menu, #jfgrid-filter-submenu").hide();

            //mousedown是右键
            if (event.which == "3") {
                var isright = false;

                for(var s = 0; s < jfgird_select_save.length; s++){
                    var obj_s = jfgird_select_save[s];

                    if(obj_s["column"] != null && (col_index >= obj_s["column"][0] && col_index <= obj_s["column"][1]) && (obj_s["row"][0] == 0 && obj_s["row"][1] == jfgrid.flowdata.length - 1)){
                        isright = true;
                        break;
                    }
                }

                if(isright){
                    return;
                }
            }

            var left = col_pre, width = col - col_pre - 1;
            var columnseleted = [col_index, col_index];

            // var changeparam = jfgrid.menuButton.mergeMoveMain(columnseleted , [0, row_index], jfgird_select_save[jfgird_select_save.length - 1], row_pre, row, left, width);
            // if(changeparam != null){
            //     columnseleted = changeparam[0];
            //     //rowseleted= changeparam[1];
            //     //top = changeparam[2];
            //     //height = changeparam[3];
            //     left = changeparam[4];
            //     width = changeparam[5];
            // }

            jfgird_scroll_status = true;

            //公式相关
            var $input = $("#jfgrid-input-box");
            if (parseInt($input.css("top")) > 0) {

                if (jfgrid.formula.rangestart || jfgrid.formula.rangedrag_column_start || jfgrid.formula.rangedrag_row_start || jfgrid.formula.israngeseleciton() || $("#jfgrid-ifFormulaGenerator-multiRange-dialog").is(":visible")) {
                    //公式选区
                    var changeparam = jfgrid.menuButton.mergeMoveMain(columnseleted, [0, row_index], {"row_focus": 0, "column_focus": col_index}, row_pre, row, left, width);
                    if(changeparam != null){
                        columnseleted = changeparam[0];
                        //rowseleted= changeparam[1];
                        //top = changeparam[2];
                        //height = changeparam[3];
                        left = changeparam[4];
                        width = changeparam[5];
                    }

                    if(event.shiftKey){
                        var last = jfgrid.formula.func_selectedrange;

                        var left = 0, width = 0, columnseleted = [];
                        if (last.left > col_pre) {
                            left = col_pre;
                            width = last.left + last.width - col_pre;

                            if(last.column[1] > last.column_focus){
                                last.column[1] = last.column_focus;
                            }

                            columnseleted = [col_index, last.column[1]];
                        }
                        else if (last.left == col_pre) {
                            left = col_pre;
                            width = last.left + last.width - col_pre;
                            columnseleted = [col_index, last.column[0]];
                        }
                        else {
                            left = last.left;
                            width = col - last.left - 1;

                            if(last.column[0] < last.column_focus){
                                last.column[0] = last.column_focus;
                            }

                            columnseleted = [last.column[0], col_index];
                        }

                        var changeparam = jfgrid.menuButton.mergeMoveMain(columnseleted , [0, row_index], {"row_focus": 0, "column_focus": col_index}, row_pre, row, left, width);
                        if(changeparam != null){
                            columnseleted = changeparam[0];
                            //rowseleted= changeparam[1];
                            //top = changeparam[2];
                            //height = changeparam[3];
                            left = changeparam[4];
                            width = changeparam[5];
                        }

                        last["column"] = columnseleted;

                        last["left_move"] = left;
                        last["width_move"] = width;

                        jfgrid.formula.func_selectedrange = last;
                    }
                    else if(event.ctrlKey && $("#jfgrid-rich-text-editor").find("span").last().text() != ","){
                        //按住ctrl 选择选区时  先处理上一个选区
                        var vText = $("#jfgrid-rich-text-editor").text() + ",";
                        if(vText.length > 0 && vText.substr(0, 1) == "="){
                            vText = jfgrid.formula.functionHTMLGenerate(vText);

                            if (window.getSelection) { // all browsers, except IE before version 9
                                var currSelection = window.getSelection();
                                jfgrid.formula.functionRangeIndex = [$(currSelection.anchorNode).parent().index(), currSelection.anchorOffset];
                            } 
                            else { // Internet Explorer before version 9
                                var textRange = document.selection.createRange();
                                jfgrid.formula.functionRangeIndex = textRange;
                            }

                            $("#jfgrid-rich-text-editor").html(vText);

                            jfgrid.formula.canceFunctionrangeSelected();
                            jfgrid.formula.createRangeHightlight();
                        }

                        jfgrid.formula.rangestart = false;
                        jfgrid.formula.rangedrag_column_start = false;
                        jfgrid.formula.rangedrag_row_start = false;

                        $("#jfgrid-functionbox-cell").html(vText);
                        jfgrid.formula.rangeHightlightselected($("#jfgrid-rich-text-editor"));

                        //再进行 选区的选择
                        jfgrid.formula.israngeseleciton();
                        jfgrid.formula.func_selectedrange = {
                            "left": left, 
                            "width": width, 
                            "top": jfgrid.rowLocationByIndex(0)[0], 
                            "height": jfgrid.rowLocationByIndex(0)[1] - jfgrid.rowLocationByIndex(0)[0] - 1, 
                            "left_move": left, 
                            "width_move": width, 
                            "top_move": row_pre, 
                            "height_move": row - row_pre - 1, 
                            "row": [0, row_index], 
                            "column": columnseleted,
                            "row_focus": 0, 
                            "column_focus": col_index 
                        }
                    }
                    else{
                        jfgrid.formula.func_selectedrange = {
                            "left": left, 
                            "width": width, 
                            "top": jfgrid.rowLocationByIndex(0)[0], 
                            "height": jfgrid.rowLocationByIndex(0)[1] - jfgrid.rowLocationByIndex(0)[0] - 1, 
                            "left_move": left, 
                            "width_move": width, 
                            "top_move": row_pre, 
                            "height_move": row - row_pre - 1, 
                            "row": [0, row_index], 
                            "column": columnseleted,
                            "row_focus": 0, 
                            "column_focus": col_index 
                        }
                    }

                    if(jfgrid.formula.rangestart || jfgrid.formula.rangedrag_column_start || jfgrid.formula.rangedrag_row_start || jfgrid.formula.israngeseleciton()){
                        jfgrid.formula.rangeSetValue({ "row": [null, null], "column": columnseleted });
                    }
                    else if($("#jfgrid-ifFormulaGenerator-multiRange-dialog").is(":visible")){//if公式生成器
                        var range = jfgrid.sheetmanage.getRangetxt(jfgrid.currentSheetIndex, { "row": [0, row_index], "column": columnseleted }, jfgrid.currentSheetIndex);
                        $("#jfgrid-ifFormulaGenerator-multiRange-dialog input").val(range);
                    }

                    jfgrid.formula.rangedrag_column_start = true;
                    jfgrid.formula.rangestart = false;
                    jfgrid.formula.rangedrag_row_start = false;

                    $("#jfgrid-formula-functionrange-select").css({ "left": left, "width": width, "top": row_pre, "height": row - row_pre - 1 }).show();
                    $("#jfgrid-formula-help-c").hide();

                    jfgrid.jfgrid_count_show(left, row_pre, width, row - row_pre - 1, [0, row_index], columnseleted);

                    return;
                }
                else {
                    jfgrid.formula.updatecell(jfgridCellUpdate[0], jfgridCellUpdate[1]);
                    jfgrid_cols_selected_status = true;
                }
            }
            else {
                jfgrid_cols_selected_status = true;
            }

            if (jfgrid_cols_selected_status) {
                if(event.shiftKey){
                    //按住shift点击列索引选取范围
                    var last = $.extend(true, {}, jfgird_select_save[jfgird_select_save.length - 1]); //选区最后一个

                    var left = 0, width = 0, columnseleted = [];
                    if (last.left > col_pre) {
                        left = col_pre;
                        width = last.left + last.width - col_pre;

                        if(last.column[1] > last.column_focus){
                            last.column[1] = last.column_focus;
                        }

                        columnseleted = [col_index, last.column[1]];
                    }
                    else if (last.left == col_pre) {
                        left = col_pre;
                        width = last.left + last.width - col_pre;
                        columnseleted = [col_index, last.column[0]];
                    }
                    else {
                        left = last.left;
                        width = col - last.left - 1;

                        if(last.column[0] < last.column_focus){
                            last.column[0] = last.column_focus;
                        }

                        columnseleted = [last.column[0], col_index];
                    }

                    last["column"] = columnseleted;

                    last["left_move"] = left;
                    last["width_move"] = width;

                    jfgird_select_save[jfgird_select_save.length - 1] = last;
                }
                else if(event.ctrlKey){
                    //选区添加
                    jfgird_select_save.push({ 
                        "left": left, 
                        "width": width, 
                        "top": jfgrid.rowLocationByIndex(0)[0], 
                        "height": jfgrid.rowLocationByIndex(0)[1] - jfgrid.rowLocationByIndex(0)[0] - 1, 
                        "left_move": left, 
                        "width_move": width, 
                        "top_move": row_pre, 
                        "height_move": row - row_pre - 1, 
                        "row": [0, row_index], 
                        "column": columnseleted,
                        "row_focus": 0,  
                        "column_focus": col_index 
                    });
                }
                else{
                    jfgird_select_save = [];
                    jfgird_select_save.push({ 
                        "left": left, 
                        "width": width, 
                        "top": jfgrid.rowLocationByIndex(0)[0], 
                        "height": jfgrid.rowLocationByIndex(0)[1] - jfgrid.rowLocationByIndex(0)[0] - 1, 
                        "left_move": left, 
                        "width_move": width, 
                        "top_move": row_pre, 
                        "height_move": row - row_pre - 1, 
                        "row": [0, row_index], 
                        "column": columnseleted,
                        "row_focus": 0, 
                        "column_focus": col_index 
                    });
                }

                jfgrid.selectHightlightShow();

                if(jfgrid.server.allowUpdate){
                    //允许编辑后的后台更新时
                    jfgrid.server.saveParam("mv", jfgrid.currentSheetIndex, jfgird_select_save);
                }
            }
            
            $("#jfgrid-helpbox-cell").text(jfgrid.sheetmanage.getRangetxt(jfgrid.currentSheetIndex, jfgird_select_save[jfgird_select_save.length - 1]));

            setTimeout(function () {
                clearTimeout(jfcountfuncTimeout);
                jfcountfunc();
            }, 101);

            if (jfgrid_cols_menu_status) {
                $("#jfgrid-rightclick-menu").hide();
                $("#jfgrid-cols-h-hover").hide();
                $("#jfgrid-cols-menu-btn").hide();
                jfgrid_cols_menu_status = false;
            }
            event.stopPropagation();
        }).mousemove(function (event) {
            if (jfgrid_cols_selected_status || jfgird_select_status) {
                $("#jfgrid-cols-h-hover").hide();
                $("#jfgrid-cols-menu-btn").hide();
                return;
            }

            if (jfgrid_cols_menu_status || jfgrid_cols_change_size) {
                return;
            }

            var mouse = mouseposition(event.pageX, event.pageY);
            var x = mouse[0] + $("#jfgrid-cols-h-c").scrollLeft();

            var colLocation = jfgrid.colLocation(x), col = colLocation[1], col_pre = colLocation[0], col_index = colLocation[2];

            $("#jfgrid-cols-h-hover").css({ "left": col_pre, "width": col - col_pre - 1, "display": "block" });
            $("#jfgrid-cols-menu-btn").css({ "left": col - 19, "display": "block" });

            $("#jfgrid-cols-change-size").css({ "left": col - 5 });
            if (x < col && x >= col - 5) {
                $("#jfgrid-cols-change-size").css({ "opacity": 0 });
                $("#jfgrid-cols-menu-btn").hide();
            }
            else {
                $("#jfgrid-change-size-line").hide();
                $("#jfgrid-cols-change-size").css("opacity", 0);
            }
        }).mouseleave(function (event) {
            if (jfgrid_cols_menu_status || jfgrid_cols_change_size) {
                return;
            }

            $("#jfgrid-cols-h-hover").hide();
            $("#jfgrid-cols-menu-btn").hide();
            $("#jfgrid-cols-change-size").css("opacity", 0);
        }).mouseup(function (event) {
            if (event.which == 3) {
                if(jfgrid.isEditMode()){ //非编辑模式下禁止右键功能框
                    return;
                }

                jfgridRightHeadClickIs = "column";
                $("#jfgrid-rightclick-menu .jfgrid-cols-rows-shift-word").text("列");
                $("#jfgrid-rightclick-menu .jfgrid-cols-rows-shift-size").text("宽");
                $("#jfgrid-rightclick-menu .jfgrid-cols-rows-shift-left").text("左");
                $("#jfgrid-rightclick-menu .jfgrid-cols-rows-shift-right").text("右");

                $("#jfgrid-cols-rows-add").show();
                $("#jfgrid-cols-rows-data").show();
                $("#jfgrid-cols-rows-shift").hide();

                showrightclickmenu($("#jfgrid-rightclick-menu"), event.pageX, $(this).offset().top + 18);
                jfgrid_cols_menu_status = true;

                //列宽默认值
                var cfg = $.extend(true, {}, config);
                if(cfg["columlen"] == null){
                    cfg["columlen"] = {};
                }

                var first_collen = cfg["columlen"][jfgird_select_save[0].column[0]] == null ? jfgrid.defaultcollen : cfg["columlen"][jfgird_select_save[0].column[0]];
                var isSame = true;

                for(var i = 0; i < jfgird_select_save.length; i++){
                    var s = jfgird_select_save[i];
                    var c1 = s.column[0], c2 = s.column[1];

                    for(var c = c1; c <= c2; c++){
                        var collen = cfg["columlen"][c] == null ? jfgrid.defaultcollen : cfg["columlen"][c];

                        if(collen != first_collen){
                            isSame = false;
                            break;
                        }
                    }
                }

                if(isSame){
                    $("#jfgrid-cols-rows-add").find("input[type='number'].rcsize").val(first_collen);
                }
                else{
                    $("#jfgrid-cols-rows-add").find("input[type='number'].rcsize").val("");
                }
            }
        });

        var jfgrid_cols_change_size = false, jfgrid_cols_change_size_start = [], jfgrid_cols_dbclick_timeout = null, jfgrid_cols_dbclick_times = 0;
        $("#jfgrid-cols-change-size").mousedown(function (event) {
            //有批注在编辑时
            jfgrid.postil.removeActivePs();

            $("#jfgrid-input-box").hide();
            $("#jfgrid-cols-change-size").css({ "opacity": 1 });

            var mouse = mouseposition(event.pageX, event.pageY);
            var scrollLeft = $("#jfgrid-cols-h-c").scrollLeft();
            var scrollTop = $("#jfgrid-cell-main").scrollTop();
            var winH = $("#jfgrid-cell-main").height();
            var x = mouse[0] + scrollLeft;

            var row_index = visibledatarow.length - 1, row = visibledatarow[row_index], row_pre = 0;
            var colLocation = jfgrid.colLocation(x), col = colLocation[1], col_pre = colLocation[0], col_index = colLocation[2];

            jfgrid_cols_change_size = true;
            jfgird_scroll_status = true;
            $("#jfgrid-change-size-line").css({ "height": winH + scrollTop, "border-width": "0 1px 0 0", "top": 0, "left": col - 3, "width": "1px", "display": "block", "cursor": "ew-resize" });
            $("#jfgrid-sheettable, #jfgrid-cols-h-c, .jfgrid-cols-h-cells, .jfgrid-cols-h-cells canvas").css("cursor", "ew-resize");
            jfgrid_cols_change_size_start = [col_pre, col_index];
            $("#jfgrid-rightclick-menu").hide();
            $("#jfgrid-cols-h-hover").hide();
            $("#jfgrid-cols-menu-btn").hide();
            jfgrid_cols_dbclick_times = 0;
            event.stopPropagation();
        }).dblclick(function () {
            jfgridcolsdbclick();
            // console.log(jfgrid_cols_dbclick_times, jfgrid_cols_dbclick_timeout);
            // jfgrid_cols_dbclick_times += 1;
            // if(jfgrid_cols_dbclick_times>=2){
            // 	jfgrid_cols_dbclick_times = 0;
            // 	jfgridcolsdbclick();
            // 	clearTimeout(jfgrid_cols_dbclick_timeout);
            // }

            // jfgrid_cols_dbclick_timeout = setTimeout(function(){
            // 	jfgrid_cols_dbclick_times = 0;
            // }, 300);
        })


        function jfgridcolsdbclick() {
            jfgrid_cols_change_size = false;
            //$("#jfgrid-change-size-line, #jfgrid-cols-change-size").hide();
            $("#jfgrid-change-size-line").hide();
            $("#jfgrid-cols-change-size").css("opacity", 0);
            $("#jfgrid-sheettable, #jfgrid-cols-h-c, .jfgrid-cols-h-cells, .jfgrid-cols-h-cells canvas").css("cursor", "default");

            var mouse = mouseposition(event.pageX, event.pageY);
            var scrollLeft = $("#jfgrid-cols-h-c").scrollLeft();
            var x = mouse[0] + scrollLeft;
            var winW = $(window).width();

            var row_index = visibledatarow.length - 1, row = visibledatarow[row_index], row_pre = 0;
            var colLocation = jfgrid.colLocation(x), col = colLocation[1], col_pre = colLocation[0], col_index = colLocation[2];
            //console.log(jfgird_select_save["column"], col_index, jfgird_select_save["column"][0], col_index, jfgird_select_save["column"][1]);
            jfgrid_cols_change_size_start = [col_pre, col_index];
            var dataflow = $("#jfgridTableContent").get(0).getContext("2d");
            var cfg = $.extend(true, {}, config);

            var matchColumn = {};
            for(var s = 0; s < jfgird_select_save.length; s++){
                var c1 = jfgird_select_save[s].column[0], c2 = jfgird_select_save[s].column[1];

                if (col_index < c1 || col_index > c2) {
                    if(col_index in matchColumn){//此列已计算过
                        continue;
                    }

                    x = -Infinity;
                    var countret = 0;
                    var fontsize = 13;
                    for (var r = 0; r < jfgrid.flowdata.length; r++) {
                        if (countret >= 15) {
                            break;
                        }

                        var value = jfgrid.getcellvalue(r, jfgrid_cols_change_size_start[1], jfgrid.flowdata);
                        var mask = jfgrid.getcellvalue(r, jfgrid_cols_change_size_start[1], jfgrid.flowdata, "m");

                        if(mask != null){
                            value = mask;
                        }

                        var cell = jfgrid.flowdata[r][jfgrid_cols_change_size_start[1]];
                        if(jfgrid.getObjType(cell) == "object" && ("fs" in cell)){
                            if(cell.fs > fontsize){
                                fontsize = cell.fs;
                            }
                        }

                        if (value == null || value.toString().length == 0) {
                            countret++;
                            continue;
                        }
                        var textMetrics = dataflow.measureText(value).width;
                        if (textMetrics > x) {
                            x = textMetrics;
                        }
                    }

                    var size = x + fontsize * 1.5;
                    if ((x + 3) < 30) {
                        size = 30;
                    }

                    if (x >= winW - 100 + scrollLeft) {
                        size = winW - 100 + scrollLeft;
                    }

                    if (cfg["columlen"] == null) {
                        cfg["columlen"] = {};
                    }

                    cfg["columlen"][jfgrid_cols_change_size_start[1]] = Math.ceil(size);

                    matchColumn[col_index] = 1;
                }
                else {
                    for (var c = c1; c <= c2; c++) {
                        if(c in matchColumn){//此列已计算过
                            continue;
                        }

                        x = -Infinity;
                        var countret = 0;
                        var fontsize = 13;
                        for (var r = 0; r < jfgrid.flowdata.length; r++) {
                            if (countret >= 15) {
                                break;
                            }
                            var value = jfgrid.getcellvalue(r, c, jfgrid.flowdata);

                            var cell = jfgrid.flowdata[r][c];
                            if(jfgrid.getObjType(cell) == "object" && ("fs" in cell)){
                                if(cell.fs > fontsize){
                                    fontsize = cell.fs;
                                }
                            }

                            if (jfgrid.func_methods.isRealNull(value)) {
                                countret++;
                                continue;
                            }

                            var textMetrics = dataflow.measureText(value).width;
                            if (textMetrics > x) {
                                x = textMetrics;
                            }
                        }

                        var size = x + fontsize*1.5;;
                        if ((x + 3) < 30) {
                            size = 30;
                        }

                        if (x >= winW - 100 + scrollLeft) {
                            size = winW - 100 + scrollLeft;
                        }

                        if (cfg["columlen"] == null) {
                            cfg["columlen"] = {};
                        }
                        cfg["columlen"][c] = Math.ceil(size);

                        matchColumn[c] = 1;
                    }
                }
            }

            // if (jfgird_select_save[0]["column"] == null || col_index < jfgird_select_save[0]["column"][0] || col_index > jfgird_select_save[0]["column"][1]) {
            //     x = -Infinity;
            //     var countret = 0;
            //     var fontsize = 13;
            //     for (var r = 0; r < jfgrid.flowdata.length; r++) {
            //         if (countret >= 15) {
            //             break;
            //         }

            //         var value = jfgrid.getcellvalue(r, jfgrid_cols_change_size_start[1], jfgrid.flowdata);
            //         var mask = jfgrid.getcellvalue(r, jfgrid_cols_change_size_start[1], jfgrid.flowdata, "m");

            //         if(mask != null){
            //             value = mask;
            //         }

            //         var cell = jfgrid.flowdata[r][jfgrid_cols_change_size_start[1]];
            //         if((cell instanceof Object) && "fs" in cell){
            //             if(cell.fs > fontsize){
            //                 fontsize = cell.fs;
            //             }
            //         }

            //         if (value == null || value.toString().length == 0) {
            //             countret++;
            //             continue;
            //         }
            //         var textMetrics = dataflow.measureText(value).width;
            //         if (textMetrics > x) {
            //             x = textMetrics;
            //         }
            //     }

            //     var size = x + fontsize*1.5;
            //     if ((x + 3) < 30) {
            //         size = 30;
            //     }

            //     if (x >= winW - 100 + scrollLeft) {
            //         size = winW - 100 + scrollLeft;
            //     }

            //     if (cfg["columlen"] == null) {
            //         cfg["columlen"] = {};
            //     }

            //     cfg["columlen"][jfgrid_cols_change_size_start[1]] = Math.ceil(size);
            // }
            // else {
            //     for (var c = jfgird_select_save[0]["column"][0]; c <= jfgird_select_save[0]["column"][1]; c++) {
            //         x = -Infinity;
            //         var countret = 0;
            //         var fontsize = 13;
            //         for (var r = 0; r < jfgrid.flowdata.length; r++) {
            //             if (countret >= 15) {
            //                 break;
            //             }
            //             var value = jfgrid.getcellvalue(r, c, jfgrid.flowdata);

            //             var cell = jfgrid.flowdata[r][c];
            //             if((cell instanceof Object) && "fs" in cell){
            //                 if(cell.fs > fontsize){
            //                     fontsize = cell.fs;
            //                 }
            //             }

            //             if (value==null || value.toString().length == 0) {
            //                 countret++;
            //                 continue;
            //             }

            //             var textMetrics = dataflow.measureText(value).width;
            //             if (textMetrics > x) {
            //                 x = textMetrics;
            //             }
            //         }

            //         var size = x + fontsize*1.5;;
            //         if ((x + 3) < 30) {
            //             size = 30;
            //         }

            //         if (x >= winW - 100 + scrollLeft) {
            //             size = winW - 100 + scrollLeft;
            //         }

            //         if (cfg["columlen"] == null) {
            //             cfg["columlen"] = {};
            //         }
            //         cfg["columlen"][c] = Math.ceil(size);
            //     }
            // }
            //console.log(jfgrid.flowdata[0].length, jfgrid.flowdata.length, jfgrid.flowdata);
            jfgrid.jfrefreshgridall(jfgrid.flowdata[0].length, jfgrid.flowdata.length, jfgrid.flowdata, cfg, jfgird_select_save, "resizeC", "columlen");

            //console.log($("jfgrid-filter-options-sheet" + jfgrid.currentSheetIndex).length);
            // if ($("#jfgrid-filter-options-sheet" + jfgrid.currentSheetIndex).length > 0) {
            //     var $t = $("#jfgrid-filter-options-sheet" + jfgrid.currentSheetIndex).find(".jfgrid-filter-options").eq(0);
            //     var st_r = $t.data("str"), ed_r = $t.data("edr"), cindex = $t.data("cindex"), st_c = $t.data("stc"), ed_c = $t.data("edc");
            //     //console.log(st_r, ed_r, st_c, ed_c);
            //     jfgrid.filterseletedbyindex(st_r, ed_r, st_c, ed_c);
            // }

            //jfgrid.cleargridelement();
        }

        var jfgrid_rows_change_size = false, jfgrid_rows_change_size_start = [];
        $("#jfgrid-rows-change-size").mousedown(function (event) {
            //有批注在编辑时
            jfgrid.postil.removeActivePs();
            
            $("#jfgrid-input-box").hide();
            $("#jfgrid-rows-change-size").css({ "opacity": 1 });

            var mouse = mouseposition(event.pageX, event.pageY);
            var y = mouse[1] + $("#jfgrid-rows-h").scrollTop();

            var scrollLeft = $("#jfgrid-cell-main").scrollLeft();
            var winW = $("#jfgrid-cell-main").width();

            var rowLocation = jfgrid.rowLocation(y), row = rowLocation[1], row_pre = rowLocation[0], row_index = rowLocation[2];

            jfgrid_rows_change_size = true;
            jfgird_scroll_status = true;
            $("#jfgrid-change-size-line").css({ "height": "1px", "border-width": "0 0px 1px 0", "top": row - 3, "left": 0, "width": scrollLeft + winW, "display": "block", "cursor": "ns-resize" });
            $("#jfgrid-sheettable, #jfgrid-rows-h, #jfgrid-rows-h canvas").css("cursor", "ns-resize");
            jfgrid_rows_change_size_start = [row_pre, row_index];
            $("#jfgrid-rightclick-menu").hide();
            $("#jfgrid-rows-h-hover").hide();
            $("#jfgrid-cols-menu-btn").hide();
            event.stopPropagation();
        });

        //改为全局变量
        window.jfgrid_cols_menu_status = false;
        $("#jfgrid-cols-menu-btn").click(function (event) {
            var $menu = $("#jfgrid-rightclick-menu");
            var offset = $(this).offset();
            //console.log(offset);
            $("#jfgrid-cols-rows-shift").show();
            jfgridRightHeadClickIs = "column";
            $("#jfgrid-rightclick-menu .jfgrid-cols-rows-shift-word").text("列");
            $("#jfgrid-rightclick-menu .jfgrid-cols-rows-shift-left").text("左");
            $("#jfgrid-rightclick-menu .jfgrid-cols-rows-shift-right").text("右");

            $("#jfgrid-cols-rows-add").show();
            $("#jfgrid-cols-rows-data").hide();
            $("#jfgrid-cols-rows-shift").show();

            showrightclickmenu($menu, offset.left, offset.top + 18);
            jfgrid_cols_menu_status = true;
        });

        var orderbyindex = 0;
        $("#jfgridorderbyasc, #jfgridorderbyasc_t").mousedown(function (event) {
            jfgrid.cleargridelement(event);
            jfgrid.sortColumnSeletion(orderbyindex, true);
            jfgrid.selectHightlightShow();
        });

        $("#jfgridorderbydesc, #jfgridorderbydesc_t").click(function (event) {
            jfgrid.cleargridelement(event);
            jfgrid.sortColumnSeletion(orderbyindex, false);
            jfgrid.selectHightlightShow();
        });

        //右键功能键

        //复制为json格式字符串，首行为标题
        $("#jfgrid-copy-json-head").click(function (event) {
            $("body .jfgrid-cols-menu").hide();
            $("#" + container).attr("tabindex", 0).focus();

            if(jfgird_select_save.length > 1){
                if(jfgrid.isEditMode()){
                    alert("不能对多重选定区域执行此操作，请选择单个区域，然后再试");
                }
                else{
                    jfgrid.tooltip.info("不能对多重选定区域执行此操作，请选择单个区域，然后再试", "");   
                }
                return;
            }

            //复制范围内包含部分合并单元格，提示
            if(config["merge"] != null){
                var hasPartMC = false;

                for(var s = 0; s < jfgird_select_save.length; s++){
                    var r1 = jfgird_select_save[s].row[0], r2 = jfgird_select_save[s].row[1];
                    var c1 = jfgird_select_save[s].column[0], c2 = jfgird_select_save[s].column[1];

                    hasPartMC = jfgrid.hasPartMC(config, r1, r2, c1, c2);

                    if(hasPartMC){
                        break;
                    }
                }

                if(hasPartMC){
                    if(jfgrid.isEditMode()){
                        alert("无法对部分合并单元格执行此操作");
                    }
                    else{
                        jfgrid.tooltip.info("无法对部分合并单元格执行此操作", ""); 
                    }
                    return;    
                }
            }

            var getdata = jfgrid.getdatabyselection(jfgird_select_save[0]);
            var arr = [];
            if (getdata.length == 0) {
                return;
            }

            if (getdata.length == 1) {
                var obj = {};
                for (var i = 0; i < getdata[0].length; i++) {
                    obj[jfgrid.getcellvalue(0, i, getdata)] = "";
                }
                arr.push(obj);
            }
            else {
                for (var r = 1; r < getdata.length; r++) {
                    var obj = {};
                    for (var c = 0; c < getdata[0].length; c++) {
                        if(jfgrid.getcellvalue(0, c, getdata) == undefined){
                            obj[""] = jfgrid.getcellvalue(r, c, getdata);
                        }else{
                            obj[jfgrid.getcellvalue(0, c, getdata)] = jfgrid.getcellvalue(r, c, getdata);
                        }
                    }
                    arr.push(obj);
                }
            }
            jfgrid.selection.copybyformat(event, JSON.stringify(arr));
        });

        //复制为json格式字符串，无标题，采用ABCD作为标题
        $("#jfgrid-copy-json-nohead").click(function (event) {
            $("body .jfgrid-cols-menu").hide();
            $("#" + container).attr("tabindex", 0).focus();

            if(jfgird_select_save.length > 1){
                if(jfgrid.isEditMode()){
                    alert("不能对多重选定区域执行此操作，请选择单个区域，然后再试");
                }
                else{
                    jfgrid.tooltip.info("不能对多重选定区域执行此操作，请选择单个区域，然后再试", "");
                }
                return;
            }

            //复制范围内包含部分合并单元格，提示
            if(config["merge"] != null){
                var hasPartMC = false;

                for(var s = 0; s < jfgird_select_save.length; s++){
                    var r1 = jfgird_select_save[s].row[0], r2 = jfgird_select_save[s].row[1];
                    var c1 = jfgird_select_save[s].column[0], c2 = jfgird_select_save[s].column[1];

                    hasPartMC = jfgrid.hasPartMC(config, r1, r2, c1, c2);

                    if(hasPartMC){
                        break;
                    }
                }

                if(hasPartMC){
                    if(jfgrid.isEditMode()){
                        alert("无法对部分合并单元格执行此操作");
                    }
                    else{
                        jfgrid.tooltip.info("无法对部分合并单元格执行此操作", ""); 
                    }
                    return;    
                }
            }

            var getdata = jfgrid.getdatabyselection(jfgird_select_save[0]);
            var arr = [];
            if (getdata.length == 0) {
                return;
            }
            var st = jfgird_select_save[0]["column"][0];
            for (var r = 0; r < getdata.length; r++) {
                var obj = {};
                for (var c = 0; c < getdata[0].length; c++) {
                    obj[jfgrid.jfgridchatatABC(c + st)] = jfgrid.getcellvalue(r, c, getdata);
                }
                arr.push(obj);
            }

            jfgrid.selection.copybyformat(event, JSON.stringify(arr));
        });

        //复制为一维数组
        $("#jfgrid-copy-array1").click(function (event) {
            $("body .jfgrid-cols-menu").hide();
            $("#" + container).attr("tabindex", 0).focus();

            if(jfgird_select_save.length > 1){
                if(jfgrid.isEditMode()){
                    alert("不能对多重选定区域执行此操作，请选择单个区域，然后再试");
                }
                else{
                    jfgrid.tooltip.info("不能对多重选定区域执行此操作，请选择单个区域，然后再试", "");
                }
                return;
            }

            //复制范围内包含部分合并单元格，提示
            if(config["merge"] != null){
                var hasPartMC = false;

                for(var s = 0; s < jfgird_select_save.length; s++){
                    var r1 = jfgird_select_save[s].row[0], r2 = jfgird_select_save[s].row[1];
                    var c1 = jfgird_select_save[s].column[0], c2 = jfgird_select_save[s].column[1];

                    hasPartMC = jfgrid.hasPartMC(config, r1, r2, c1, c2);

                    if(hasPartMC){
                        break;
                    }
                }

                if(hasPartMC){
                    if(jfgrid.isEditMode()){
                        alert("无法对部分合并单元格执行此操作");
                    }
                    else{
                        jfgrid.tooltip.info("无法对部分合并单元格执行此操作", ""); 
                    }
                    return;    
                }
            }

            var getdata = jfgrid.getdatabyselection(jfgird_select_save[0]);
            var arr = [];
            if (getdata.length == 0) {
                return;
            }
            for (var r = 0; r < getdata.length; r++) {
                for (var c = 0; c < getdata[0].length; c++) {
                    arr.push(jfgrid.getcellvalue(r, c, getdata));
                }
            }

            jfgrid.selection.copybyformat(event, JSON.stringify(arr));
        });

        //复制为二维数组
        $("#jfgrid-copy-array2").click(function (event) {
            $("body .jfgrid-cols-menu").hide();
            $("#" + container).attr("tabindex", 0).focus();

            if(jfgird_select_save.length > 1){
                if(jfgrid.isEditMode()){
                    alert("不能对多重选定区域执行此操作，请选择单个区域，然后再试");
                }
                else{
                    jfgrid.tooltip.info("不能对多重选定区域执行此操作，请选择单个区域，然后再试", "");
                }
                return;
            }

            //复制范围内包含部分合并单元格，提示
            if(config["merge"] != null){
                var hasPartMC = false;

                for(var s = 0; s < jfgird_select_save.length; s++){
                    var r1 = jfgird_select_save[s].row[0], r2 = jfgird_select_save[s].row[1];
                    var c1 = jfgird_select_save[s].column[0], c2 = jfgird_select_save[s].column[1];

                    hasPartMC = jfgrid.hasPartMC(config, r1, r2, c1, c2);

                    if(hasPartMC){
                        break;
                    }
                }

                if(hasPartMC){
                    if(jfgrid.isEditMode()){
                        alert("无法对部分合并单元格执行此操作");
                    }
                    else{
                        jfgrid.tooltip.info("无法对部分合并单元格执行此操作", ""); 
                    }
                    return;    
                }
            }

            var getdata = jfgrid.getdatabyselection(jfgird_select_save[0]);
            var arr = [];
            if (getdata.length == 0) {
                return;
            }
            for (var r = 0; r < getdata.length; r++) {
                var a = [];
                for (var c = 0; c < getdata[0].length; c++) {
                    a.push(jfgrid.getcellvalue(r, c, getdata));
                }
                arr.push(a);
            }

            jfgrid.selection.copybyformat(event, JSON.stringify(arr));
        });

        //复制为多维数组
        $("#jfgrid-copy-arraymore-confirm").click(function (event) {
            $("body .jfgrid-cols-menu").hide();

            if(jfgird_select_save.length > 1){
                if(jfgrid.isEditMode()){
                    alert("不能对多重选定区域执行此操作，请选择单个区域，然后再试");
                }
                else{
                    jfgrid.tooltip.info("不能对多重选定区域执行此操作，请选择单个区域，然后再试", "");
                }
                return;
            }

            //复制范围内包含部分合并单元格，提示
            if(config["merge"] != null){
                var hasPartMC = false;

                for(var s = 0; s < jfgird_select_save.length; s++){
                    var r1 = jfgird_select_save[s].row[0], r2 = jfgird_select_save[s].row[1];
                    var c1 = jfgird_select_save[s].column[0], c2 = jfgird_select_save[s].column[1];

                    hasPartMC = jfgrid.hasPartMC(config, r1, r2, c1, c2);

                    if(hasPartMC){
                        break;
                    }
                }

                if(hasPartMC){
                    if(jfgrid.isEditMode()){
                        alert("无法对部分合并单元格执行此操作");
                    }
                    else{
                        jfgrid.tooltip.info("无法对部分合并单元格执行此操作", ""); 
                    }
                    return;    
                }
            }

            var getdata = jfgrid.getdatabyselection(jfgird_select_save[0]);
            var arr = [];
            if (getdata.length == 0) {
                return;
            }

            for (var r = 0; r < getdata.length; r++) {
                for (var c = 0; c < getdata[0].length; c++) {
                    arr.push(getdata[r][c]);
                }
            }

            var row = $("#jfgrid-copy-arraymore-row").val(), col = $("#jfgrid-copy-arraymore-col").val();

            if (row == "" && col == "") {
                jfgrid.selection.copybyformat(event, JSON.stringify(arr));
                $("body .jfgrid-cols-menu").hide();
                return;
            }

            if (row == "") {
                row = 1;
            }
            else {
                row = parseInt(row);
                if (row == null) {
                    row = 1;
                }
            }

            if (col == "") {
                col = 1;
            }
            else {
                col = parseInt(col);
                if (col == null) {
                    col = 1;
                }
            }

            if(row.toString() == "NaN" || col.toString() == "NaN"){
                if(jfgrid.isEditMode()){
                    alert("请输入正确的数值!");
                }
                else{
                    jfgrid.tooltip.info("请输入正确的数值!", "");
                }
                return;
            }

            if(row < 1 || col < 1){
                if(jfgrid.isEditMode()){
                    alert("行列数不能小于1!");
                }
                else{
                    jfgrid.tooltip.info("行列数不能小于1!", "");
                }
                return;
            }

            var arrlen = arr.length, i = 0, ret = [];
            for (var r = 0; r < row; r++) {
                var a = [];
                for (var c = 0; c < col; c++) {
                    a.push(arr[i++]);
                    if (i >= arrlen) {
                        jfgrid.selection.copybyformat(event, JSON.stringify(ret));
                        $("body .jfgrid-cols-menu").hide();
                        return;
                    }
                }
                ret.push(a);
            }

            jfgrid.selection.copybyformat(event, JSON.stringify(ret));
        });

        //复制为对角线
        $("#jfgrid-copy-diagonal").click(function (event) {
            $("body .jfgrid-cols-menu").hide();
            $("#" + container).attr("tabindex", 0).focus();

            if(jfgird_select_save.length > 1){
                if(jfgrid.isEditMode()){
                    alert("不能对多重选定区域执行此操作，请选择单个区域，然后再试");
                }
                else{
                    jfgrid.tooltip.info("不能对多重选定区域执行此操作，请选择单个区域，然后再试", "");
                }
                return;
            }

            //复制范围内包含部分合并单元格，提示
            if(config["merge"] != null){
                var hasPartMC = false;

                for(var s = 0; s < jfgird_select_save.length; s++){
                    var r1 = jfgird_select_save[s].row[0], r2 = jfgird_select_save[s].row[1];
                    var c1 = jfgird_select_save[s].column[0], c2 = jfgird_select_save[s].column[1];

                    hasPartMC = jfgrid.hasPartMC(config, r1, r2, c1, c2);

                    if(hasPartMC){
                        break;
                    }
                }

                if(hasPartMC){
                    if(jfgrid.isEditMode()){
                        alert("无法对部分合并单元格执行此操作");
                    }
                    else{
                        jfgrid.tooltip.info("无法对部分合并单元格执行此操作", ""); 
                    }
                    return;    
                }
            }

            var getdata = jfgrid.getdatabyselection(jfgird_select_save[0]);
            var arr = [];
            if (getdata.length == 0) {
                return;
            }

            var clen = getdata[0].length;
            for (var r = 0; r < getdata.length; r++) {
                if (r >= clen) {
                    break;
                }
                arr.push(getdata[r][r]);
            }

            jfgrid.selection.copybyformat(event, JSON.stringify(arr));
            copyType = "diagonal";
            copysetting = [];
        });

        //复制为反对角线
        $("#jfgrid-copy-antidiagonal").click(function (event) {
            $("body .jfgrid-cols-menu").hide();
            $("#" + container).attr("tabindex", 0).focus();

            if(jfgird_select_save.length > 1){
                if(jfgrid.isEditMode()){
                    alert("不能对多重选定区域执行此操作，请选择单个区域，然后再试");
                }
                else{
                    jfgrid.tooltip.info("不能对多重选定区域执行此操作，请选择单个区域，然后再试", "");
                }
                return;
            }

            //复制范围内包含部分合并单元格，提示
            if(config["merge"] != null){
                var hasPartMC = false;

                for(var s = 0; s < jfgird_select_save.length; s++){
                    var r1 = jfgird_select_save[s].row[0], r2 = jfgird_select_save[s].row[1];
                    var c1 = jfgird_select_save[s].column[0], c2 = jfgird_select_save[s].column[1];

                    hasPartMC = jfgrid.hasPartMC(config, r1, r2, c1, c2);

                    if(hasPartMC){
                        break;
                    }
                }

                if(hasPartMC){
                    if(jfgrid.isEditMode()){
                        alert("无法对部分合并单元格执行此操作");
                    }
                    else{
                        jfgrid.tooltip.info("无法对部分合并单元格执行此操作", ""); 
                    }
                    return;    
                }
            }

            var getdata = jfgrid.getdatabyselection(jfgird_select_save[0]);
            var arr = [];
            if (getdata.length == 0) {
                return;
            }

            var clen = getdata[0].length;
            for (var r = 0; r < getdata.length; r++) {
                if (r >= clen) {
                    break;
                }
                arr.push(getdata[r][clen - r - 1]);
            }

            jfgrid.selection.copybyformat(event, JSON.stringify(arr));
            copyType = "antidiagonal";
            copysetting = [];
        });

        //复制为对角偏移n列
        $("#jfgrid-copy-diagonaloffset").click(function (event) {
            $("body .jfgrid-cols-menu").hide();
            $("#" + container).attr("tabindex", 0).focus();

            if(jfgird_select_save.length > 1){
                if(jfgrid.isEditMode()){
                    alert("不能对多重选定区域执行此操作，请选择单个区域，然后再试");
                }
                else{
                    jfgrid.tooltip.info("不能对多重选定区域执行此操作，请选择单个区域，然后再试", "");
                }
                return;
            }

            //复制范围内包含部分合并单元格，提示
            if(config["merge"] != null){
                var hasPartMC = false;

                for(var s = 0; s < jfgird_select_save.length; s++){
                    var r1 = jfgird_select_save[s].row[0], r2 = jfgird_select_save[s].row[1];
                    var c1 = jfgird_select_save[s].column[0], c2 = jfgird_select_save[s].column[1];

                    hasPartMC = jfgrid.hasPartMC(config, r1, r2, c1, c2);

                    if(hasPartMC){
                        break;
                    }
                }

                if(hasPartMC){
                    if(jfgrid.isEditMode()){
                        alert("无法对部分合并单元格执行此操作");
                    }
                    else{
                        jfgrid.tooltip.info("无法对部分合并单元格执行此操作", ""); 
                    }
                    return;    
                }
            }

            var getdata = jfgrid.getdatabyselection(jfgird_select_save[0]);
            var arr = [];
            if (getdata.length == 0) {
                return;
            }

            var clen = getdata[0].length, offset = parseInt($("#jfgrid-copy-diagonaloffset-value").val());

            if(offset.toString() == "NaN"){
                if(jfgrid.isEditMode()){
                    alert("请输入正确的数值！");
                }
                else{
                    jfgrid.tooltip.info("请输入正确的数值！", "");
                }
                return;
            }

            if(offset < 0){
                if(jfgrid.isEditMode()){
                    alert("偏移列不能为负数！");
                }
                else{
                    jfgrid.tooltip.info("偏移列不能为负数！", "");
                }
                return;
            }

            if (offset == null) {
                offset = 1;
            }

            var clen = getdata[0].length;
            for (var r = 0; r < getdata.length; r++) {
                console.log(r, offset, clen);
                if (r + offset >= clen) {
                    break;
                }
                arr.push(getdata[r][r + offset]);
            }

            jfgrid.selection.copybyformat(event, JSON.stringify(arr));
            copyType = "diagonaloffset";
            copysetting = [offset];
        });

        //复制为布尔值
        $("#jfgrid-copy-boolvalue").click(function (event) {
            $("body .jfgrid-cols-menu").hide();
            $("#" + container).attr("tabindex", 0).focus();

            if(jfgird_select_save.length > 1){
                if(jfgrid.isEditMode()){
                    alert("不能对多重选定区域执行此操作，请选择单个区域，然后再试");
                }
                else{
                    jfgrid.tooltip.info("不能对多重选定区域执行此操作，请选择单个区域，然后再试", "");
                }
                return;
            }

            //复制范围内包含部分合并单元格，提示
            if(config["merge"] != null){
                var hasPartMC = false;

                for(var s = 0; s < jfgird_select_save.length; s++){
                    var r1 = jfgird_select_save[s].row[0], r2 = jfgird_select_save[s].row[1];
                    var c1 = jfgird_select_save[s].column[0], c2 = jfgird_select_save[s].column[1];

                    hasPartMC = jfgrid.hasPartMC(config, r1, r2, c1, c2);

                    if(hasPartMC){
                        break;
                    }
                }

                if(hasPartMC){
                    if(jfgrid.isEditMode()){
                        alert("无法对部分合并单元格执行此操作");
                    }
                    else{
                        jfgrid.tooltip.info("无法对部分合并单元格执行此操作", ""); 
                    }
                    return;    
                }
            }

            var getdata = jfgrid.getdatabyselection(jfgird_select_save[0]);
            var arr = [];
            if (getdata.length == 0) {
                return;
            }
            for (var r = 0; r < getdata.length; r++) {
                var a = [];
                for (var c = 0; c < getdata[0].length; c++) {
                    var bool = false;

                    if(jfgrid.getObjType(getdata[r][c]) == "object"){
                        var v = getdata[r][c].v;
                    }
                    else{
                        var v = getdata[r][c];
                    }

                    if (v == null || v == "") {
                        bool = false;
                    }
                    else {
                        v = parseInt(v);
                        if (v == null || v > 0) {
                            bool = true;
                        }
                        else {
                            bool = false;
                        }
                    }
                    a.push(bool);
                }
                arr.push(a);
            }

            jfgrid.selection.copybyformat(event, JSON.stringify(arr));
            copyType = "boolvalue";
            copysetting = [];
        });

        //矩阵操作选区 翻转 上下
        $("#jfgrid-matrix-turn-up").click(function (event) {
            $("body .jfgrid-cols-menu").hide();
            $("#" + container).attr("tabindex", 0).focus();

            if(jfgird_select_save.length > 1){
                if(jfgrid.isEditMode()){
                    alert("不能对多重选定区域执行此操作，请选择单个区域，然后再试");
                }
                else{
                    jfgrid.tooltip.info("不能对多重选定区域执行此操作，请选择单个区域，然后再试", "");
                }
                return;
            }

            var getdata = jfgrid.getdatabyselection(jfgird_select_save[0]);
            if (getdata.length == 0) {
                return;
            }

            var arr = [];
            for (var r = getdata.length - 1; r >= 0; r--) {
                var a = [];
                for (var c = 0; c < getdata[0].length; c++) {
                    var value = "";
                    if (getdata[r] != null && getdata[r][c] != null) {
                        value = getdata[r][c];
                    }
                    a.push(value);
                }
                arr.push(a);
            }

            jfgrid.editor.controlHandler(arr);
        });

        //矩阵操作选区 翻转 左右
        $("#jfgrid-matrix-turn-left").click(function (event) {
            $("body .jfgrid-cols-menu").hide();
            $("#" + container).attr("tabindex", 0).focus();

            if(jfgird_select_save.length > 1){
                if(jfgrid.isEditMode()){
                    alert("不能对多重选定区域执行此操作，请选择单个区域，然后再试");
                }
                else{
                    jfgrid.tooltip.info("不能对多重选定区域执行此操作，请选择单个区域，然后再试", "");
                }
                return;
            }

            var getdata = jfgrid.getdatabyselection(jfgird_select_save[0]);
            if (getdata.length == 0) {
                return;
            }

            var arr = [];
            for (var r = 0; r < getdata.length; r++) {
                var a = [];
                for (var c = getdata[0].length - 1; c >= 0; c--) {
                    var value = "";
                    if (getdata[r] != null && getdata[r][c] != null) {
                        value = getdata[r][c];
                    }
                    a.push(value);
                }
                arr.push(a);
            }

            jfgrid.editor.controlHandler(arr);
        });

        //矩阵操作选区 翻转 顺时针
        $("#jfgrid-matrix-turn-cw").click(function (event) {
            $("body .jfgrid-cols-menu").hide();
            $("#" + container).attr("tabindex", 0).focus();

            if(jfgird_select_save.length > 1){
                if(jfgrid.isEditMode()){
                    alert("不能对多重选定区域执行此操作，请选择单个区域，然后再试");
                }
                else{
                    jfgrid.tooltip.info("不能对多重选定区域执行此操作，请选择单个区域，然后再试", "");
                }
                return;
            }

            var getdata = jfgrid.getdatabyselection(jfgird_select_save[0]);
            if (getdata.length == 0) {
                return;
            }

            var arr = [];
            for (var c = 0; c < getdata[0].length; c++) {
                var a = [];
                for (var r = getdata.length - 1; r >= 0; r--) {
                    var value = "";
                    if (getdata[r] != null && getdata[r][c] != null) {
                        value = getdata[r][c];
                    }
                    a.push(value);
                }
                arr.push(a);
            }

            jfgrid.editor.controlHandlerD(arr);
        });

        //矩阵操作选区 翻转 逆时针
        $("#jfgrid-matrix-turn-anticw").click(function (event) {
            $("body .jfgrid-cols-menu").hide();
            $("#" + container).attr("tabindex", 0).focus();

            if(jfgird_select_save.length > 1){
                if(jfgrid.isEditMode()){
                    alert("不能对多重选定区域执行此操作，请选择单个区域，然后再试");
                }
                else{
                    jfgrid.tooltip.info("不能对多重选定区域执行此操作，请选择单个区域，然后再试", "");
                }
                return;
            }

            var getdata = jfgrid.getdatabyselection(jfgird_select_save[0]);
            if (getdata.length == 0) {
                return;
            }
            
            var arr = [];
            for (var c = getdata[0].length - 1; c >= 0; c--) {
                var a = [];
                for (var r = 0; r < getdata.length; r++) {
                    var value = "";
                    if (getdata[r] != null && getdata[r][c] != null) {
                        value = getdata[r][c];
                    }
                    a.push(value);
                }
                arr.push(a);
            }

            jfgrid.editor.controlHandlerD(arr);
        });

        //矩阵操作选区 转置
        $("#jfgrid-matrix-turn-trans").click(function (event) {
            $("body .jfgrid-cols-menu").hide();
            $("#" + container).attr("tabindex", 0).focus();

            if(jfgird_select_save.length > 1){
                if(jfgrid.isEditMode()){
                    alert("不能对多重选定区域执行此操作，请选择单个区域，然后再试");
                }
                else{
                    jfgrid.tooltip.info("不能对多重选定区域执行此操作，请选择单个区域，然后再试", "");
                }
                return;
            }

            var getdata = jfgrid.getdatabyselection(jfgird_select_save[0]);
            if (getdata.length == 0) {
                return;
            }

            var arr = [];
            for (var c = 0; c < getdata[0].length; c++) {
                var a = [];
                for (var r = 0; r < getdata.length; r++) {
                    var value = "";
                    if (getdata[r] != null && getdata[r][c] != null) {
                        value = getdata[r][c];
                    }
                    a.push(value);
                }
                arr.push(a);
            }

            jfgrid.editor.controlHandlerD(arr);
        });

        var jfnqrt = function (x, p) {
            if (x == 0)
                return 0;
            var x0, x1;
            x0 = x;
            x1 = ((p - 1) * x0 / p) + (x / (Math.pow(x0, p - 1) * p));//利用迭代法求解
            while (Math.abs(x1 - x0) > 0.000001) {
                x0 = x1;
                x1 = ((p - 1) * x0 / p) + (x / (Math.pow(x0, p - 1) * p));
            }
            return x1;
        }

        //矩阵操作选区 矩阵计算
        $("#jfgrid-matrix-cal-confirm").click(function (event) {
            $("body .jfgrid-cols-menu").hide();
            $("#" + container).attr("tabindex", 0).focus();

            if(jfgird_select_save.length > 1){
                if(jfgrid.isEditMode()){
                    alert("不能对多重选定区域执行此操作，请选择单个区域，然后再试");
                }
                else{
                    jfgrid.tooltip.info("不能对多重选定区域执行此操作，请选择单个区域，然后再试", "");
                }
                return;
            }

            var getdata = jfgrid.getdatabyselection(jfgird_select_save[0]);
            if (getdata.length == 0) {
                return;
            }

            var caltype = $("#jfgrid-matrix-cal-type").val(), 
                calvalue = parseInt($("#jfgrid-matrix-cal-value").val());

            if(calvalue.toString() == "NaN"){
                if(jfgrid.isEditMode()){
                    alert("请输入正确的数值！");
                }
                else{
                    jfgrid.tooltip.info("请输入正确的数值！", "");
                }
                return;
            }

            if (calvalue == null) {
                calvalue = 2;
            }

            var arr = [];

            for (var r = 0; r < getdata.length; r++) {
                var a = [];

                for (var c = 0; c < getdata[0].length; c++) {
                    var value = "";
                    if (getdata[r] != null && getdata[r][c] != null) {
                        value = getdata[r][c];
                        if (parseInt(value) != null && getdata[r][c].ct != undefined && getdata[r][c].ct.t == "n") {
                            if (caltype == "minus") {
                                value.v = value.v - calvalue;
                            }
                            else if (caltype == "multiply") {
                                value.v = value.v * calvalue;
                            }
                            else if (caltype == "divided") {
                                value.v = jfgrid.numFormat(value.v / calvalue, 4);
                            }
                            else if (caltype == "power") {
                                value.v = Math.pow(value.v, calvalue);
                            }
                            else if (caltype == "root") {
                                if (calvalue == 2) {
                                    value.v = jfgrid.numFormat(Math.sqrt(value.v), 4);
                                }
                                else if (calvalue == 3 && Math.cbrt) {
                                    value.v = jfgrid.numFormat(Math.cbrt(value.v), 4);
                                }
                                else {
                                    value.v = jfgrid.numFormat(jfnqrt(value.v, calvalue), 4);
                                }
                            }
                            else if (caltype == "log") {
                                value.v = jfgrid.numFormat(Math.log(value.v) * 10000 / Math.log(Math.abs(calvalue)), 4);
                            }
                            else {
                                value.v = value.v + calvalue;
                            }

                            if(value.v == null){
                                value.m = "";
                            }
                            else{
                                value.m = value.v.toString();
                            }
                        }
                    }
                    a.push(value);
                }
                arr.push(a);
            }

            jfgrid.editor.controlHandler(arr);
        });

        //矩阵操作选区 删除两端0值 按行
        $("#jfgrid-matrix-delezero-row").click(function (event) {
            $("body .jfgrid-cols-menu").hide();
            $("#" + container).attr("tabindex", 0).focus();

            if(jfgird_select_save.length > 1){
                if(jfgrid.isEditMode()){
                    alert("不能对多重选定区域执行此操作，请选择单个区域，然后再试");
                }
                else{
                    jfgrid.tooltip.info("不能对多重选定区域执行此操作，请选择单个区域，然后再试", "");
                }
                return;
            }

            var getdata = jfgrid.getdatabyselection(jfgird_select_save[0]);
            if (getdata.length == 0) {
                return;
            }
            
            var arr = [];
            var getdatalen = getdata[0].length;
            for (var r = 0; r < getdata.length; r++) {
                var a = [], stdel = true, eddel = true;
                for (var c = 0; c < getdatalen; c++) {
                    var value = "";
                    if (getdata[r] != null && getdata[r][c] != null) {
                        value = getdata[r][c];
                        if ((value.v == "0" || value.v == 0) && stdel) {
                            continue;
                        }
                        else {
                            stdel = false;
                        }
                    }
                    a.push(value);
                }

                var a1 = [];
                if (a.length == getdatalen) {
                    a1 = a;
                }
                else {
                    for (var c = a.length - 1; c >= 0; c--) {
                        var value = "";
                        if (a[c] != null) {
                            value = a[c];
                            if ((value.v == "0" || value.v == 0) && eddel) {
                                continue;
                            }
                            else {
                                eddel = false;
                            }
                        }
                        a1.unshift(value);
                    }

                    var l = getdatalen - a1.length;
                    for (var c1 = 0; c1 < l; c1++) {
                        a1.push("");
                    }
                }
                arr.push(a1);
            }

            jfgrid.editor.controlHandler(arr);
        });

        //矩阵操作选区 删除两端0值 按列
        $("#jfgrid-matrix-delezero-column").click(function (event) {
            $("body .jfgrid-cols-menu").hide();
            $("#" + container).attr("tabindex", 0).focus();

            if(jfgird_select_save.length > 1){
                if(jfgrid.isEditMode()){
                    alert("不能对多重选定区域执行此操作，请选择单个区域，然后再试");
                }
                else{
                    jfgrid.tooltip.info("不能对多重选定区域执行此操作，请选择单个区域，然后再试", "");
                }
                return;
            }

            var getdata = jfgrid.getdatabyselection(jfgird_select_save[0]);
            if (getdata.length == 0) {
                return;
            }

            var arr = [];
            var getdatalen = getdata.length, collen = getdata[0].length;
            for (var c = 0; c < collen; c++) {
                var a = [], stdel = true, eddel = true;
                for (var r = 0; r < getdatalen; r++) {
                    var value = "";
                    if (getdata[r] != null && getdata[r][c] != null) {
                        value = getdata[r][c];
                        if ((value.v == "0" || value.v == 0) && stdel) {
                            continue;
                        }
                        else {
                            stdel = false;
                        }
                    }
                    a.push(value);
                }

                var a1 = [];
                if (a.length == getdatalen) {
                    a1 = a;
                }
                else {
                    for (var r = a.length - 1; r >= 0; r--) {
                        var value = "";
                        if (a[r] != null) {
                            value = a[r];
                            if ((value.v == "0" || value.v == 0) && eddel) {
                                continue;
                            }
                            else {
                                eddel = false;
                            }
                        }
                        a1.unshift(value);
                    }

                    var l = getdatalen - a1.length;
                    for (var r1 = 0; r1 < l; r1++) {
                        a1.push("");
                    }
                }
                arr.push(a1);
            }

            var arr1 = [];
            for (var c = 0; c < arr[0].length; c++) {
                var a = [];
                for (var r = 0; r < arr.length; r++) {
                    var value = "";
                    if (arr[r] != null && arr[r][c] != null) {
                        value = arr[r][c];
                    }
                    a.push(value);
                }
                arr1.push(a);
            }

            jfgrid.editor.controlHandler(arr1);
        });

        //矩阵操作选区 删除重复值 按行
        $("#jfgrid-matrix-delerpt-row").click(function (event) {
            $("body .jfgrid-cols-menu").hide();
            $("#" + container).attr("tabindex", 0).focus();

            if(jfgird_select_save.length > 1){
                if(jfgrid.isEditMode()){
                    alert("不能对多重选定区域执行此操作，请选择单个区域，然后再试");
                }
                else{
                    jfgrid.tooltip.info("不能对多重选定区域执行此操作，请选择单个区域，然后再试", "");
                }
                return;
            }

            var getdata = jfgrid.getdatabyselection(jfgird_select_save[0]);
            if (getdata.length == 0) {
                return;
            }

            var arr = [];
            var getdatalen = getdata[0].length;
            for (var r = 0; r < getdata.length; r++) {
                var a = [], repeat = {};

                for (var c = 0; c < getdatalen; c++) {
                    var value = null;
                    if (getdata[r] != null && getdata[r][c] != null) {
                        value = getdata[r][c];

                        if(value.v in repeat){
                            repeat[value.v].push(value);
                        }
                        else{
                            repeat[value.v] = [];
                            repeat[value.v].push(value);
                        }
                    }
                }

                for (var c = 0; c < getdatalen; c++) {
                    var value = null;
                    if (getdata[r] != null && getdata[r][c] != null) {
                        value = getdata[r][c];

                        if(repeat[value.v].length == 1){
                            a.push(value);
                        }
                    }
                }

                var l = getdatalen - a.length;
                for (var c1 = 0; c1 < l; c1++) {
                    a.push(null);
                }
                arr.push(a);
            }

            jfgrid.editor.controlHandler(arr);
        });

        //矩阵操作选区 删除重复值 按列
        $("#jfgrid-matrix-delerpt-column").click(function (event) {
            $("body .jfgrid-cols-menu").hide();
            $("#" + container).attr("tabindex", 0).focus();

            if(jfgird_select_save.length > 1){
                if(jfgrid.isEditMode()){
                    alert("不能对多重选定区域执行此操作，请选择单个区域，然后再试");
                }
                else{
                    jfgrid.tooltip.info("不能对多重选定区域执行此操作，请选择单个区域，然后再试", "");
                }
                return;
            }

            var getdata = jfgrid.getdatabyselection(jfgird_select_save[0]);
            if (getdata.length == 0) {
                return;
            }

            var arr = [];
            var getdatalen = getdata.length, collen = getdata[0].length;
            for (var c = 0; c < collen; c++) {
                var a = [], repeat = {};

                for (var r = 0; r < getdatalen; r++) {
                    var value = null;
                    if (getdata[r] != null && getdata[r][c] != null) {
                        value = getdata[r][c];

                        if(value.v in repeat){
                            repeat[value.v].push(value);
                        }
                        else{
                            repeat[value.v] = [];
                            repeat[value.v].push(value);
                        }
                    }
                }

                for (var r = 0; r < getdatalen; r++) {
                    var value = null;
                    if (getdata[r] != null && getdata[r][c] != null) {
                        value = getdata[r][c];

                        if(repeat[value.v].length == 1){
                            a.push(value);
                        }
                    }
                }

                a1 = a;
                var l = getdatalen - a1.length;
                for (var r1 = 0; r1 < l; r1++) {
                    a1.push(null);
                }
                arr.push(a1);
            }

            var arr1 = [];
            for (var c = 0; c < arr[0].length; c++) {
                var a = [];
                for (var r = 0; r < arr.length; r++) {
                    var value = null;
                    if (arr[r] != null && arr[r][c] != null) {
                        value = arr[r][c];
                    }
                    a.push(value);
                }
                arr1.push(a);
            }

            jfgrid.editor.controlHandler(arr1);
        });

        $("#jfgrid-icon-undo").click(function (event) {
            jfgrid.controlHistory.redo(event);
        });

        $("#jfgrid-icon-redo").click(function (event) {
            jfgrid.controlHistory.undo(event);
        });

        var isInitialSheetConfig = false, jfgridcurrentSheetitem = null, jfdbclicklagTimeout = null;

        function showsheetconfigmenu() {
            if (!isInitialSheetConfig) {
                isInitialSheetConfig = true;
                $("#jfgridsheetconfigcolorur").spectrum({
                    showPalette: true,
                    preferredFormat: "hex",
                    clickoutFiresChange: false,
                    showInitial: true,
                    showInput: true,
                    flat: true,
                    hideAfterPaletteSelect: false,
                    showSelectionPalette: true,
                    maxPaletteSize: 10,
                    cancelText: "取消",
                    chooseText: "确定颜色",
                    togglePaletteMoreText: "更多",
                    togglePaletteLessText: "少于",
                    clearText: "清除颜色选择",
                    noColorSelectedText: "没有颜色被选择",
                    palette: [["rgb(0, 0, 0)", "rgb(67, 67, 67)", "rgb(102, 102, 102)", "rgb(204, 204, 204)", "rgb(217, 217, 217)", "rgb(255, 255, 255)"], ["rgb(152, 0, 0)", "rgb(255, 0, 0)", "rgb(255, 153, 0)", "rgb(255, 255, 0)", "rgb(0, 255, 0)", "rgb(0, 255, 255)", "rgb(74, 134, 232)", "rgb(0, 0, 255)", "rgb(153, 0, 255)", "rgb(255, 0, 255)"], ["rgb(230, 184, 175)", "rgb(244, 204, 204)", "rgb(252, 229, 205)", "rgb(255, 242, 204)", "rgb(217, 234, 211)", "rgb(208, 224, 227)", "rgb(201, 218, 248)", "rgb(207, 226, 243)", "rgb(217, 210, 233)", "rgb(234, 209, 220)"], ["rgb(221, 126, 107)", "rgb(234, 153, 153)", "rgb(249, 203, 156)", "rgb(255, 229, 153)", "rgb(182, 215, 168)", "rgb(162, 196, 201)", "rgb(164, 194, 244)", "rgb(159, 197, 232)", "rgb(180, 167, 214)", "rgb(213, 166, 189)"], ["rgb(204, 65, 37)", "rgb(224, 102, 102)", "rgb(246, 178, 107)", "rgb(255, 217, 102)", "rgb(147, 196, 125)", "rgb(118, 165, 175)", "rgb(109, 158, 235)", "rgb(111, 168, 220)", "rgb(142, 124, 195)", "rgb(194, 123, 160)"], ["rgb(166, 28, 0)", "rgb(204, 0, 0)", "rgb(230, 145, 56)", "rgb(241, 194, 50)", "rgb(106, 168, 79)", "rgb(69, 129, 142)", "rgb(60, 120, 216)", "rgb(61, 133, 198)", "rgb(103, 78, 167)", "rgb(166, 77, 121)"], ["rgb(91, 15, 0)", "rgb(102, 0, 0)", "rgb(120, 63, 4)", "rgb(127, 96, 0)", "rgb(39, 78, 19)", "rgb(12, 52, 61)", "rgb(28, 69, 135)", "rgb(7, 55, 99)", "rgb(32, 18, 77)", "rgb(76, 17, 48)"], ["#c1232b", "#27727b", "#fcce10", "#e87c25", "#b5c334", "#fe8463", "#9bca63", "#fad860", "#f3a43b", "#60c0dd", "#d7504b", "#c6e579", "#f4e001", "#f0805a", "#26c0c0", "#c12e34", "#e6b600", "#0098d9", "#2b821d", "#005eaa", "#339ca8", "#cda819", "#32a487", "#3fb1e3", "#6be6c1", "#626c91", "#a0a7e6", "#c4ebad", "#96dee8"]],
                    change: function (color) {
                        var $input = $(this);
                        if (color != null) {
                            color = color.toHexString();
                        }
                        else {
                            color = "rgb(0, 0, 0)";
                        }

                        var oldcolor = null;
                        if(jfgridcurrentSheetitem.find(".jfgrid-sheets-item-color").length>0){
                            oldcolor = jfgridcurrentSheetitem.find(".jfgrid-sheets-item-color").css("background-color");
                        }

                        jfgridcurrentSheetitem.find(".jfgrid-sheets-item-color").remove();
                        jfgridcurrentSheetitem.append('<div class="jfgrid-sheets-item-color" style=" position: absolute; width: 100%; height: 3px; bottom: 0px; left: 0px; background-color: ' + color + ';"></div>');
                        var index = jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex);
                        jfgridfile[index].color = color;
                        jfgrid.server.saveParam("all", jfgrid.currentSheetIndex, color, { "k": "color" });

                        if (clearjfundo) {
                            var redo = {};
                            redo["type"] = "sheetColor";
                            redo["sheetIndex"] = jfgrid.currentSheetIndex;
                            
                            redo["oldcolor"] = oldcolor;
                            redo["color"] = color;
                            
                            jfgrid.jfundo = [];
                            jfgrid.jfredo.push(redo);
                        }
                    }
                });

                $("#jfgridsheetconfigcolorreset").click(function () {
                    var oldcolor = null;
                    if(jfgridcurrentSheetitem.find(".jfgrid-sheets-item-color").length>0){
                        oldcolor = jfgridcurrentSheetitem.find(".jfgrid-sheets-item-color").css("background-color");
                    }

                    jfgridcurrentSheetitem.find(".jfgrid-sheets-item-color").remove();
                    var index = jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex);
                    jfgridfile[index].color = null;
                    jfgrid.server.saveParam("all", jfgrid.currentSheetIndex, null, { "k": "color" } );

                    if (clearjfundo) {
                        var redo = {};
                        redo["type"] = "sheetColor";
                        redo["sheetIndex"] = jfgrid.currentSheetIndex;
                        
                        redo["oldcolor"] = oldcolor;
                        redo["color"] = null;

                        jfgrid.jfundo = [];
                        jfgrid.jfredo.push(redo);
                    }
                });
            }

            var index = jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex);
            if (jfgridfile[index].color != null && jfgridfile[index].color.length > 0) {
                $("#jfgridsheetconfigcolorur").spectrum("set", jfgridfile[index].color);

            }

            //showrightclickmenu($("#jfgrid-rightclick-sheet-menu"), jfgridcurrentSheetitem.offset().left + 46, event.pageY);
            $("#jfgridsheetconfigcolorur").parent().find("span, div, button, input, a").addClass("jfgrid-mousedown-cancel");
            setTimeout(function(){
                mouseclickposition($("#jfgrid-rightclick-sheet-menu"), jfgridcurrentSheetitem.offset().left + jfgridcurrentSheetitem.width(), jfgridcurrentSheetitem.offset().top - 18, "leftbottom");
            },1);
            
        }


        var jfgridsheetrightclick = function ($t, $cur, e) {
            //var $t = $(this), $cur = $(e.target);
            clearTimeout(jfdbclicklagTimeout);
            //console.log($cur, $cur.hasClass("jfgrid-sheets-item-name"), $cur.attr("contenteditable"));
            if ($cur.hasClass("jfgrid-sheets-item-name") && $cur.attr("contenteditable") == "true") {
                return;
            }
            if (jfgrid.formula.rangestart || jfgrid.formula.rangedrag_column_start || jfgrid.formula.rangedrag_row_start || jfgrid.formula.israngeseleciton()) {
                //jfgrid.formula.rangeSetValue({ "row": [row_index, row_index], "column": [col_index, col_index] });
                //jfgrid.formula.rangestart = true;
                //this.rangeSetValueTo.parent();

                setTimeout(function () {
                    jfgrid.formula.setCaretPosition(jfgrid.formula.rangeSetValueTo.get(0), 0, jfgrid.formula.rangeSetValueTo.text().length);
                    jfgrid.formula.createRangeHightlight();
                    $("#jfgrid-input-box-index").find(".jfgrid-input-box-index-sheettxt").remove().end().prepend("<span class='jfgrid-input-box-index-sheettxt'>" + jfgrid.sheetmanage.getSheetName(jfgrid.formula.rangetosheet) + "!</span>").show();
                    $("#jfgrid-input-box-index").css({"left": $("#jfgrid-input-box").css("left"), "top": (parseInt($("#jfgrid-input-box").css("top")) - 20) + "px", "z-index": $("#jfgrid-input-box").css("z-index")});
                }, 1);
                //$("#jfgrid-formula-functionrange-select").css({ "left": col_pre, "width": col - col_pre - 1, "top": row_pre, "height": row - row_pre - 1 }).show();
            }
            else {
                $("#jfgrid-input-box").removeAttr("style");
                $("#jfgrid-formula-functionrange .jfgrid-formula-functionrange-highlight").remove();
            }

            $("#jfgrid-sheet-area div.jfgrid-sheets-item").removeClass("jfgrid-sheets-item-active");
            $t.addClass("jfgrid-sheets-item-active");
            jfgrid.cleargridelement(e);
            jfgrid.sheetmanage.changeSheet($t.data("index"));
            //$("#jfgrid-input-box").hide();
            //console.log(jfgrid.formula.rangestart);


            $("#jfgrid-sheet-list, #jfgrid-rightclick-sheet-menu").hide();

            if ($cur.hasClass("jfgrid-sheets-item-menu") || $cur.hasClass("fa-sort-desc") || e.which == "3") {
                jfgridcurrentSheetitem = $cur.closest(".jfgrid-sheets-item");
                showsheetconfigmenu();
            }
        }

        $("#jfgrid-sheet-area").on("mousedown", "div.jfgrid-sheets-item", function (e) {
            if(jfgrid.isEditMode()){
                // alert("非编辑模式下不允许该操作！");
                return;
            }

            var $t = $(this), $cur = $(e.target), $item = $cur.closest(".jfgrid-sheets-item");

            if (e.which == "3") {
                jfgridsheetrightclick($t, $cur, e);
                jfgridcurrentSheetitem = $item;
                showsheetconfigmenu();

                return;
            }

            if ($item.hasClass("jfgrid-sheets-item-active") && $item.find(".jfgrid-sheets-item-name").attr("contenteditable") == "false") {
                jfdbclicklagTimeout = setTimeout(function () {
                    jfgird_sheet_move_status = true;
                    jfgird_sheet_move_data = {};
                    jfgird_sheet_move_data.widthlist = [];
                    
                    $("#jfgrid-sheet-area div.jfgrid-sheets-item:visible").each(function (i) {
                        if (i == 0) {
                            jfgird_sheet_move_data.widthlist.push(parseInt($(this).outerWidth()));
                        }
                        else {
                            jfgird_sheet_move_data.widthlist.push(parseInt($(this).outerWidth()) + jfgird_sheet_move_data.widthlist[i - 1]);
                        }
                    });

                    jfgird_sheet_move_data.curindex = $("#jfgrid-sheet-area div.jfgrid-sheets-item").index($item);
                    var x = e.pageX;
                    jfgird_sheet_move_data.curleft = x - $item.offset().left;
                    jfgird_sheet_move_data.pageX = x;
                    jfgird_sheet_move_data.activeobject = $item;
                    jfgird_sheet_move_data.cursorobject = $cur;
                    var $itemclone = $item.clone().css("visibility", "hidden").attr("id", "jfgrid-sheets-item-clone");
                    $item.after($itemclone);
                    $item.css({ "position": "absolute", "opacity": 0.8, "cursor": "move", "transition": "initial", "z-index": 10 });
                    //$cur.css({ "cursor": "move" });
                }, 200);
            }
        }).on("click", "div.jfgrid-sheets-item", function (e) {
            if(jfgrid.isEditMode()){
                // alert("非编辑模式下不允许该操作！");
                return;
            }
            
            var $t = $(this), $cur = $(e.target);
            jfgridsheetrightclick($t, $cur, e);
        });


        var jfgridsheetnameeditor = function ($t) {
            //var $t = $(this);
            $t.attr("contenteditable", "true").addClass("jfgrid-mousedown-cancel").data("oldtxt", $t.text());

            setTimeout(function () {
                if (document.selection) {
                    var range = document.body.createTextRange();
                    range.moveToElementText($t.get(0));
                    range.select();
                } else if (window.getSelection) {
                    var range = document.createRange();
                    range.selectNodeContents($t.get(0));
                    window.getSelection().removeAllRanges();
                    window.getSelection().addRange(range);
                }
            }, 1);
        }

        $("#jfgrid-sheet-area").on("dblclick", "span.jfgrid-sheets-item-name", function (e) {
            jfgridsheetnameeditor($(this));
        });

        $("#jfgrid-sheet-area").on("blur", "span.jfgrid-sheets-item-name", function (e) {
            var $t = $(this);
            var txt = $t.text(), oldtxt = $t.data("oldtxt");
            var index = jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex);
            for (var i = 0; i < jfgridfile.length; i++) {
                if (index != i && jfgridfile[i].name == txt) {
                    if(jfgrid.isEditMode()){
                        alert("标签页的名称不能重复！请重新修改");
                    }
                    else{
                        jfgrid.tooltip.info("提示", "标签页的名称不能重复！请重新修改");
                    }
                    $t.text(oldtxt).attr("contenteditable", "false");
                    return;
                }
            }

            var winW = $(window).width();

            var c_width = 0;
            $("#jfgrid-sheet-container-c > div.jfgrid-sheets-item:visible").each(function(){
                c_width += $(this).outerWidth();
            });

            if (c_width >= winW * 0.7) {
                $("#jfgrid-sheet-area .jfgrid-sheets-scroll").css("display", "inline-block");
                $("#jfgrid-sheet-container .docs-sheet-fade-left").show();
            }

            jfgridfile[index].name = txt;
            jfgrid.server.saveParam("all", jfgrid.currentSheetIndex, txt, { "k": "name" });

            $t.attr("contenteditable", "false").removeClass("jfgrid-mousedown-cancel");

            if (clearjfundo) {
                var redo = {};
                redo["type"] = "sheetName";
                redo["sheetIndex"] = jfgrid.currentSheetIndex;
                
                redo["oldtxt"] = oldtxt;
                redo["txt"] = txt;

                jfgrid.jfundo = [];
                jfgrid.jfredo.push(redo);
            }
        });

        $("#jfgrid-sheet-area").on("keydown", "span.jfgrid-sheets-item-name", function (e) {
            var kcode = e.keyCode;
            var $t = $(this);
            if (kcode == keycode.ENTER) {
                var index = jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex);
                jfgridfile[index].name = $t.text();
                $t.attr("contenteditable", "false");
            }
        });

        $("#jfgridsheetconfigrename").click(function () {
            jfgridsheetnameeditor(jfgridcurrentSheetitem.find("span.jfgrid-sheets-item-name"));
            $("#jfgrid-input-box").removeAttr("style");
            $("#jfgrid-sheet-list, #jfgrid-rightclick-sheet-menu").hide();
        });

        $("#jfgridsheetconfigshow").click(function () {
            $("#jfgrid-sheets-m").click();
            $("#jfgrid-input-box").removeAttr("style");
            $("#jfgrid-rightclick-sheet-menu").hide();
        });

        $("#jfgridsheetconfigmoveleft").click(function () {
            //var oldorders = jfgrid.sheetmanage.getCurrentOrder();
            if (jfgridcurrentSheetitem.prevAll(":visible").length > 0) {
                jfgridcurrentSheetitem.insertBefore(jfgridcurrentSheetitem.prevAll(":visible").eq(0));
                jfgrid.sheetmanage.reOrderAllSheet();
            }
            $("#jfgrid-input-box").removeAttr("style");
            $("#jfgrid-sheet-list, #jfgrid-rightclick-sheet-menu").hide();
            //var orders = jfgrid.sheetmanage.getCurrentOrder();

            // if (clearjfundo) {
            //     var redo = {};
            //     redo["type"] = "sheetorder";
            //     jfgrid.jfundo = [];
            //     redo["oldorders"] = oldorders;
            //     redo["orders"] = orders;
            //     jfgrid.jfredo.push(redo);
            // }
        });

        $("#jfgridsheetconfigmoveright").click(function () {
            if (jfgridcurrentSheetitem.nextAll(":visible").length > 0) {
                jfgridcurrentSheetitem.insertAfter(jfgridcurrentSheetitem.nextAll(":visible").eq(0));
                jfgrid.sheetmanage.reOrderAllSheet();
            }
            $("#jfgrid-input-box").removeAttr("style");
            $("#jfgrid-sheet-list, #jfgrid-rightclick-sheet-menu").hide();
        });

        $("#jfgridsheetconfigdelete").click(function (e) {
            $("#jfgrid-sheet-list, #jfgrid-rightclick-sheet-menu").hide();

            if($("#jfgrid-sheet-container-c .jfgrid-sheets-item:visible").length <= 1){
                if(jfgrid.isEditMode()){
                    alert("工作薄内至少含有一张可视工作表。若需删除选定的工作表，请先插入一张新工作表或显示一张隐藏的工作表。");
                }
                else{
                    jfgrid.tooltip.info("工作薄内至少含有一张可视工作表。若需删除选定的工作表，请先插入一张新工作表或显示一张隐藏的工作表。", "");
                }

                return;
            }

            var index = jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex);

            jfgrid.tooltip.confirm("是否删除【" + jfgridfile[index].name + "】？", "<span style='color:#9e9e9e;font-size:12px;'>可以通过Ctrl+Z撤销删除</span>", function () {
                jfgrid.sheetmanage.deleteSheet(jfgridcurrentSheetitem.data("index"));
            }, null);
            
            $("#jfgrid-input-box").removeAttr("style");
        });


        $("#jfgridsheetconfigcopy").click(function (e) {
            //var index = jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex);
            jfgrid.sheetmanage.copySheet(jfgridcurrentSheetitem.data("index"), e);
            $("#jfgrid-input-box").removeAttr("style");
            $("#jfgrid-sheet-list, #jfgrid-rightclick-sheet-menu").hide();
        });

        $("#jfgridsheetconfighide").click(function () {
            if ($("#jfgrid-sheet-area div.jfgrid-sheets-item:visible").length == 1) {
                if(jfgrid.isEditMode()){
                    alert("不能隐藏, 至少保留一个sheet标签");
                }
                else{
                    jfgrid.tooltip.info("不能隐藏", "至少保留一个sheet标签");
                }
                return;
            }
            jfgrid.sheetmanage.setSheetHide(jfgridcurrentSheetitem.data("index"));
            $("#jfgrid-input-box").removeAttr("style");
            $("#jfgrid-sheet-list, #jfgrid-rightclick-sheet-menu").hide();
        });


        $("#jfgrid-sheets-add").click(function (e) {
            jfgrid.sheetmanage.addNewSheet(e);

            jfgrid.sheetmanage.locationSheet();
            // var $c = $("#jfgrid-sheet-container-c"), c_width = $c.width(), winW = $("#"+container).width();
            // $c.scrollLeft(100000000000);

            // if (c_width + $c.scrollLeft() >= winW * 0.7) {
            //     //console.log(c_width, $c.scrollLeft(), winW * 0.7);
            //     $("#jfgrid-sheet-area .jfgrid-sheets-scroll").css("display", "inline-block");
            //     $("#jfgrid-sheet-container .docs-sheet-fade-left").show();
            // }
            //$("#jfgrid-input-box").hide();
            $("#jfgrid-input-box").removeAttr("style");
        });

        var sheetscrollani = null, sheetscrollstart = 0, sheetscrollend = 0, sheetscrollstep = 150;
        $("#jfgrid-sheets-leftscroll").click(function () {
            var $c = $("#jfgrid-sheet-container-c");
            sheetscrollstart = $c.scrollLeft();
            sheetscrollend = $c.scrollLeft() - sheetscrollstep;
            if (sheetscrollend <= 0) {
                $("#jfgrid-sheet-container .docs-sheet-fade-left").hide();
            }
            $("#jfgrid-sheet-container .docs-sheet-fade-right").show();
            clearInterval(sheetscrollani);
            sheetscrollani = setInterval(function () {
                //console.log(sheetscrollstart, sheetscrollend);
                sheetscrollstart -= 4;
                $c.scrollLeft(sheetscrollstart);
                if (sheetscrollstart <= sheetscrollend) {
                    clearInterval(sheetscrollani);
                }
            }, 1);

        });


        $("#jfgrid-sheets-rightscroll").click(function () {
            var $c = $("#jfgrid-sheet-container-c");
            sheetscrollstart = $c.scrollLeft();
            sheetscrollend = $c.scrollLeft() + sheetscrollstep;
            if (sheetscrollstart > 0) {
                $("#jfgrid-sheet-container .docs-sheet-fade-right").hide();
            }
            $("#jfgrid-sheet-container .docs-sheet-fade-left").show();
            clearInterval(sheetscrollani);
            sheetscrollani = setInterval(function () {
                //console.log(sheetscrollstart, sheetscrollend);
                sheetscrollstart += 4;
                $c.scrollLeft(sheetscrollstart);
                if (sheetscrollstart >= sheetscrollend) {
                    clearInterval(sheetscrollani);
                }
            }, 1);

        });

        var initialOpenSheet = true;
        $("#jfgrid-sheets-m").click(function (e) {

            $("#jfgrid-sheet-list").html("");

            var item = "";
            for (var i = 0; i < jfgridfile.length; i++) {
                var f = jfgridfile[i], icon = '', style = "";
                //console.log(f.status);
                if (f["status"] == 1) {
                    icon = '<i class="fa fa-check" aria-hidden="true"></i>';
                }

                if (f["hide"] == 1) {
                    icon = '<i class="fa fa-low-vision" aria-hidden="true"></i>';
                    style += "color:#BBBBBB;";
                }

                if (f["color"] != null && f["color"].length > 0) {
                    style += "border-right:4px solid " + f["color"] + ";";
                }

                item += jfgrid.replaceHtml(sheetselectlistitemHTML, { "index": f["index"], "name": f["name"], "icon": icon, "style": style });
            }

            if (initialOpenSheet) {
                $("#" + container).append(jfgrid.replaceHtml(sheetselectlistHTML, { "item": item }));
                $("#jfgrid-sheet-list").on("click", ".jfgrid-cols-menuitem", function (e) {
                    if(jfgrid.isEditMode()){
                        // jfgrid.tooltip.info("提示", "图表编辑模式下不允许该操作！");
                        alert("图表编辑模式下不允许该操作！");
                        return;
                    }

                    var $item = $(this), index = $item.data("index");

                    if ($item.data("index") != jfgrid.currentSheetIndex) {
                        jfgrid.sheetmanage.setSheetShow(index);

                        jfgrid.sheetmanage.locationSheet();
                    }
                });
                initialOpenSheet = false;
            }
            else {
                $("#jfgrid-sheet-list").html(item);
            }

            $t = $("#jfgrid-sheet-list");

            //$t.find("span.icon").html("");
            //$("#jfgrid-sheet-btn" + jfgrid.currentSheetIndex + " span.icon").html('<i class="fa fa-check" aria-hidden="true"></i>');

            mouseclickposition($t, $(this).offset().left, $(this).offset().top - 12, "leftbottom");
            //$("#jfgrid-input-box").hide();
            $("#jfgrid-input-box").removeAttr("style");
            //$t.css({"left":"", "top":"", "display":"block"});
        });

        var jfgridextendtable = function (type, index, value, direction) {
            var d = jfgrid.editor.deepCopyFlowData(jfgrid.flowdata);
            var file = jfgridfile[jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex)];

            value = Math.floor(value);
            var cfg = $.extend(true, {}, config);

            //合并单元格配置变动
            if(cfg["merge"] == null){
                cfg["merge"] = {};
            }

            var merge_new = {};
            for(var m in cfg["merge"]){
                var mc = cfg["merge"][m];

                var r = mc.r,
                    c = mc.c,
                    rs = mc.rs,
                    cs = mc.cs;

                if(type == "row"){
                    if(index < r){
                        merge_new[(r + value) + "_" + c] = { "r": r + value, "c": c, "rs": rs, "cs": cs };
                    }
                    else if(index == r){
                        if(direction == "lefttop"){
                            merge_new[(r + value) + "_" + c] = { "r": r + value, "c": c, "rs": rs, "cs": cs };
                        }
                        else{
                            merge_new[r + "_" + c] = { "r": r, "c": c, "rs": rs + value, "cs": cs };
                        }
                    }
                    else if(index < r + rs - 1){
                        merge_new[r + "_" + c] = { "r": r, "c": c, "rs": rs + value, "cs": cs };
                    }
                    else if(index == r + rs - 1){
                        if(direction == "lefttop"){
                            merge_new[r + "_" + c] = { "r": r, "c": c, "rs": rs + value, "cs": cs };
                        }
                        else{
                            merge_new[r + "_" + c] = { "r": r, "c": c, "rs": rs, "cs": cs };
                        }
                    }
                    else{
                        merge_new[r + "_" + c] = { "r": r, "c": c, "rs": rs, "cs": cs };
                    }
                }
                else if(type == "column"){
                    if(index < c){
                        merge_new[r + "_" + (c + value)] = { "r": r, "c": c + value, "rs": rs, "cs": cs };
                    }
                    else if(index == c){
                        if(direction == "lefttop"){
                            merge_new[r + "_" + (c + value)] = { "r": r, "c": c + value, "rs": rs, "cs": cs };
                        }
                        else{
                            merge_new[r + "_" + c] = { "r": r, "c": c, "rs": rs, "cs": cs + value };
                        }
                    }
                    else if(index < c + cs - 1){
                        merge_new[r + "_" + c] = { "r": r, "c": c, "rs": rs, "cs": cs + value };
                    }
                    else if(index == c + cs - 1){
                        if(direction == "lefttop"){
                            merge_new[r + "_" + c] = { "r": r, "c": c, "rs": rs, "cs": cs + value };
                        }
                        else{
                            merge_new[r + "_" + c] = { "r": r, "c": c, "rs": rs, "cs": cs };
                        }
                    }
                    else{
                        merge_new[r + "_" + c] = { "r": r, "c": c, "rs": rs, "cs": cs };
                    }
                }
            }
            cfg["merge"] = merge_new;

            //公式配置变动
            var calcChain = file.calcChain;
            var newCalcChain = [];
            if(calcChain != null && calcChain.length > 0){
                for(var i = 0; i < calcChain.length; i++){
                    var calc = $.extend(true, {}, calcChain[i]);
                    var calc_r = calc.r, calc_c = calc.c, calc_i = calc.index, calc_funcStr = calc.func[2];

                    if(type == "row"){
                        var functionStr = "=" + jfgrid.formula.functionStrChange(calc_funcStr, "add", "row", direction, index, value);

                        if(d[calc_r][calc_c].f == calc_funcStr){
                            d[calc_r][calc_c].f = functionStr;
                        }

                        calc.func[2] = functionStr;

                        if(direction == "lefttop"){
                            if(calc_r >= index){
                                calc.r += value;
                            }
                        }
                        else if(direction == "rightbottom"){
                            if(calc_r > index){
                                calc.r += value;
                            }
                        }

                        newCalcChain.push(calc);
                    }
                    else if(type == "column"){
                        var functionStr = "=" + jfgrid.formula.functionStrChange(calc_funcStr, "add", "col", direction, index, value);

                        if(d[calc_r][calc_c].f == calc_funcStr){
                            d[calc_r][calc_c].f = functionStr;
                        }

                        calc.func[2] = functionStr;

                        if(direction == "lefttop"){
                            if(calc_c >= index){
                                calc.c += value;
                            }
                        }
                        else if(direction == "rightbottom"){
                            if(calc_c > index){
                                calc.c += value;
                            }
                        }

                        newCalcChain.push(calc);
                    }
                }
            }

            //筛选配置变动
            var filter_select = file.filter_select;
            var filter = file.filter;
            var newFilterObj = null;
            if(filter_select != null && JSON.stringify(filter_select) != "{}"){
                newFilterObj = { "filter_select": null, "filter": null };

                var f_r1 = filter_select.row[0], f_r2 = filter_select.row[1];
                var f_c1 = filter_select.column[0], f_c2 = filter_select.column[1];

                if(type == "row"){
                    if(f_r1 < index){
                        if(f_r2 == index && direction == "lefttop"){
                            f_r2 += value; 
                        }
                        else if(f_r2 > index){
                            f_r2 += value;   
                        }
                    }
                    else if(f_r1 == index){
                        if(direction == "lefttop"){
                            f_r1 += value;
                            f_r2 += value;
                        }
                        else if(direction == "rightbottom" && f_r2 > index){
                            f_r2 += value;
                        }
                    }
                    else{
                        f_r1 += value;
                        f_r2 += value;
                    }

                    if(filter != null){
                        newFilterObj.filter = {};

                        for(var k in filter){
                            var f_rowhidden = filter[k].rowhidden;
                            var f_rowhidden_new = {};

                            for(var n in f_rowhidden){
                                n = parseFloat(n);

                                if(n < index){
                                    f_rowhidden_new[n] = 0;
                                }
                                else if(n == index){
                                    if(direction == "lefttop"){
                                        f_rowhidden_new[n + value] = 0;
                                    }
                                    else if(direction == "rightbottom"){
                                        f_rowhidden_new[n] = 0;
                                    }
                                }
                                else{
                                    f_rowhidden_new[n + value] = 0;
                                }
                            }

                            newFilterObj.filter[k] = $.extend(true, {}, filter[k]);
                            newFilterObj.filter[k].rowhidden = f_rowhidden_new;
                            newFilterObj.filter[k].str = f_r1;
                            newFilterObj.filter[k].edr = f_r2;
                        }
                    }
                }
                else if(type == "column"){
                    if(f_c1 < index){
                        if(f_c2 == index && direction == "lefttop"){
                            f_c2 += value; 
                        }
                        else if(f_c2 > index){
                            f_c2 += value;   
                        }
                    }
                    else if(f_c1 == index){
                        if(direction == "lefttop"){
                            f_c1 += value;
                            f_c2 += value;
                        }
                        else if(direction == "rightbottom" && f_c2 > index){
                            f_c2 += value;
                        }
                    }
                    else{
                        f_c1 += value;
                        f_c2 += value;
                    }

                    if(filter != null){
                        newFilterObj.filter = {};

                        for(var k in filter){
                            var f_cindex = filter[k].cindex;

                            if(f_cindex == index && direction == "lefttop"){
                                f_cindex += value;
                            }
                            else if(f_cindex > index){
                                f_cindex += value;
                            }

                            newFilterObj.filter[f_cindex - f_c1] = $.extend(true, {}, filter[k]);
                            newFilterObj.filter[f_cindex - f_c1].cindex = f_cindex;
                            newFilterObj.filter[f_cindex - f_c1].stc = f_c1;
                            newFilterObj.filter[f_cindex - f_c1].edc = f_c2;
                        }
                    }
                }

                newFilterObj.filter_select = { "row": [f_r1, f_r2], "column": [f_c1, f_c2] };
            }

            if(newFilterObj != null && newFilterObj.filter != null){
                cfg["rowhidden"] = {};

                for(var k in newFilterObj.filter){
                    var f_rowhidden = newFilterObj.filter[k].rowhidden;

                    for(var n in f_rowhidden){
                        cfg["rowhidden"][n] = 0;
                    }
                }
            }
            else{
                delete cfg["rowhidden"];
            }

            //条件格式配置变动
            var CFarr = file.jfgrid_conditionformat_save;
            var newCFarr = [];
            if(CFarr != null && CFarr.length > 0){
                for(var i = 0; i < CFarr.length; i++){
                    var cf_range = CFarr[i].cellrange;
                    var cf_new_range = [];

                    for(var j = 0; j < cf_range.length; j++){
                        var CFr1 = cf_range[j].row[0],
                            CFr2 = cf_range[j].row[1],
                            CFc1 = cf_range[j].column[0],
                            CFc2 = cf_range[j].column[1];

                        if(type == "row"){
                            if(CFr1 < index){
                                if(CFr2 == index && direction == "lefttop"){
                                    CFr2 += value; 
                                }
                                else if(CFr2 > index){
                                    CFr2 += value;   
                                }
                            }
                            else if(CFr1 == index){
                                if(direction == "lefttop"){
                                    CFr1 += value;
                                    CFr2 += value;
                                }
                                else if(direction == "rightbottom" && CFr2 > index){
                                    CFr2 += value;
                                }
                            }
                            else{
                                CFr1 += value;
                                CFr2 += value;
                            }
                        }
                        else if(type == "column"){
                            if(CFc1 < index){
                                if(CFc2 == index && direction == "lefttop"){
                                    CFc2 += value; 
                                }
                                else if(CFc2 > index){
                                    CFc2 += value;   
                                }
                            }
                            else if(CFc1 == index){
                                if(direction == "lefttop"){
                                    CFc1 += value;
                                    CFc2 += value;
                                }
                                else if(direction == "rightbottom" && CFc2 > index){
                                    CFc2 += value;
                                }
                            }
                            else{
                                CFc1 += value;
                                CFc2 += value;
                            }
                        }

                        cf_new_range.push({ "row": [CFr1, CFr2], "column": [CFc1, CFc2] });
                    }

                    var cf = $.extend(true, {}, CFarr[i]);
                    cf.cellrange = cf_new_range;

                    newCFarr.push(cf);
                }
            }

            //交替颜色配置变动
            var AFarr = file.jfgrid_alternateformat_save;
            var newAFarr = [];
            if(AFarr != null && AFarr.length > 0){
                for(var i = 0; i < AFarr.length; i++){
                    var AFr1 = AFarr[i].cellrange.row[0],
                        AFr2 = AFarr[i].cellrange.row[1],
                        AFc1 = AFarr[i].cellrange.column[0],
                        AFc2 = AFarr[i].cellrange.column[1];

                    var af = $.extend(true, {}, AFarr[i]);

                    if(type == "row"){
                        if(AFr1 < index){
                            if(AFr2 == index && direction == "lefttop"){
                                AFr2 += value; 
                            }
                            else if(AFr2 > index){
                                AFr2 += value;   
                            }
                        }
                        else if(AFr1 == index){
                            if(direction == "lefttop"){
                                AFr1 += value;
                                AFr2 += value;
                            }
                            else if(direction == "rightbottom" && AFr2 > index){
                                AFr2 += value;
                            }
                        }
                        else{
                            AFr1 += value;
                            AFr2 += value;
                        }
                    }
                    else if(type == "column"){
                        if(AFc1 < index){
                            if(AFc2 == index && direction == "lefttop"){
                                AFc2 += value; 
                            }
                            else if(AFc2 > index){
                                AFc2 += value;   
                            }
                        }
                        else if(AFc1 == index){
                            if(direction == "lefttop"){
                                AFc1 += value;
                                AFc2 += value;
                            }
                            else if(direction == "rightbottom" && AFc2 > index){
                                AFc2 += value;
                            }
                        }
                        else{
                            AFc1 += value;
                            AFc2 += value;
                        }
                    }

                    af.cellrange = { "row": [AFr1, AFr2], "column": [AFc1, AFc2] };

                    newAFarr.push(af);
                }
            }

            //冻结配置变动
            var newFreezen = { "freezenhorizontaldata": null, "freezenverticaldata": null };
            if(jfgrid.freezen.freezenhorizontaldata != null && type == "row"){
                var freezen_scrollTop = jfgrid.freezen.freezenhorizontaldata[2];
                var freezen_row_st = jfgrid.freezen.freezenhorizontaldata[1] - 1;

                if(freezen_row_st == index && direction == "lefttop"){
                    freezen_row_st += value;
                }
                else if(freezen_row_st > index){
                    freezen_row_st += value;
                }

                var freezen_top = visibledatarow[freezen_row_st] - 2 - freezen_scrollTop + columeHeaderHeight;

                newFreezen.freezenhorizontaldata = [visibledatarow[freezen_row_st], freezen_row_st + 1, freezen_scrollTop, jfgrid.freezen.cutVolumn(visibledatarow, freezen_row_st + 1), freezen_top];
            }
            else{
                newFreezen.freezenhorizontaldata = jfgrid.freezen.freezenhorizontaldata;
            }

            if(jfgrid.freezen.freezenverticaldata != null && type == "column"){
                var freezen_scrollLeft = jfgrid.freezen.freezenverticaldata[2];
                var freezen_col_st = jfgrid.freezen.freezenverticaldata[1] - 1;

                if(freezen_col_st == index && direction == "lefttop"){
                    freezen_col_st += value;
                }
                else if(freezen_col_st > index){
                    freezen_col_st += value;
                }

                var freezen_left = visibledatacolumn[freezen_col_st] - 2 - freezen_scrollLeft + rowHeaderWidth;

                newFreezen.freezenverticaldata = [visibledatacolumn[freezen_col_st], freezen_col_st + 1, freezen_scrollLeft, jfgrid.freezen.cutVolumn(visibledatacolumn, freezen_col_st + 1), freezen_left];
            }
            else{
                newFreezen.freezenverticaldata = jfgrid.freezen.freezenverticaldata;
            }

            if (type == "row") {
                var type1 = "r";

                //行高配置变动
                if(cfg["rowlen"] != null){
                    var rowlen_new = {};

                    for(var r in cfg["rowlen"]){
                        r = parseFloat(r);

                        if(r < index){
                            rowlen_new[r] = cfg["rowlen"][r];
                        }
                        else if(r == index){
                            if(direction == "lefttop"){
                                rowlen_new[(r + value)] = cfg["rowlen"][r];
                            }
                            else if(direction == "rightbottom"){
                                rowlen_new[r] = cfg["rowlen"][r];
                            }
                        }
                        else{
                            rowlen_new[(r + value)] = cfg["rowlen"][r];
                        }
                    }

                    cfg["rowlen"] = rowlen_new;
                }

                //空行模板
                var row = [];
                for(var c = 0; c < d[0].length; c++){
                    row.push(null);
                }

                //边框
                if(cfg["borderInfo"] && cfg["borderInfo"].length > 0){
                    var borderInfo = []; 

                    for(var i = 0; i < cfg["borderInfo"].length; i++){
                        var rangeType = cfg["borderInfo"][i].rangeType;

                        if(rangeType == "range"){
                            var borderRange = cfg["borderInfo"][i].range;

                            var emptyRange = [];

                            for(var j = 0; j < borderRange.length; j++){
                                var bd_r1 = borderRange[j].row[0],
                                    bd_r2 = borderRange[j].row[1];

                                if(direction == "lefttop"){
                                    if(index <= bd_r1){
                                        bd_r1 += value;
                                        bd_r2 += value;
                                    }
                                    else if(index <= bd_r2){
                                        bd_r2 += value;
                                    }
                                }
                                else{
                                    if(index < bd_r1){
                                        bd_r1 += value;
                                        bd_r2 += value;
                                    }
                                    else if(index < bd_r2){
                                        bd_r2 += value;
                                    }
                                }

                                if(bd_r2 >= bd_r1){
                                    emptyRange.push({ "row": [bd_r1, bd_r2], "column": borderRange[j].column });
                                }   
                            }

                            if(emptyRange.length > 0){
                                var bd_obj = {
                                    "rangeType": "range",
                                    "borderType": cfg["borderInfo"][i].borderType,
                                    "style": cfg["borderInfo"][i].style,
                                    "color": cfg["borderInfo"][i].color,
                                    "range": emptyRange
                                }

                                borderInfo.push(bd_obj);
                            }
                        }
                        else if(rangeType == "cell"){
                            var row_index = cfg["borderInfo"][i].value.row_index;

                            if(direction == "lefttop"){
                                if(index <= row_index){
                                    row_index += value;
                                }
                            }
                            else{
                                if(index < row_index){
                                    row_index += value;
                                }
                            }
                            
                            cfg["borderInfo"][i].value.row_index = row_index;
                            borderInfo.push(cfg["borderInfo"][i]);
                        }
                    }

                    cfg["borderInfo"] = borderInfo;
                }
                
                var arr = [];
                for (var r = 0; r < value; r++) {
                    arr.push(JSON.stringify(row));
                }

                if(direction == "lefttop"){
                    if(index == 0){
                        eval('d.unshift(' + arr.join(",") + ')');
                    }
                    else{
                        eval('d.splice(' + index + ', 0, ' + arr.join(",") + ')');
                    }
                }
                else{
                    eval('d.splice(' + (index + 1) + ', 0, ' + arr.join(",") + ')');    
                }
            }
            else {
                var type1 = "c";

                //行高配置变动
                if(cfg["columlen"] != null){
                    var columlen_new = {};

                    for(var c in cfg["columlen"]){
                        c = parseFloat(c);
                        
                        if(c < index){
                            columlen_new[c] = cfg["columlen"][c];
                        }
                        else if(c == index){
                            if(direction == "lefttop"){
                                columlen_new[(c + value)] = cfg["columlen"][c];
                            }
                            else if(direction == "rightbottom"){
                                columlen_new[c] = cfg["columlen"][c];
                            }
                        }
                        else{
                            columlen_new[(c + value)] = cfg["columlen"][c];
                        }
                    }

                    cfg["columlen"] = columlen_new;
                }

                //空列模板
                var col = [];
                for(var r = 0; r < d.length; r++){
                    col.push(null);
                }

                //边框
                if(cfg["borderInfo"] && cfg["borderInfo"].length > 0){
                    var borderInfo = []; 

                    for(var i = 0; i < cfg["borderInfo"].length; i++){
                        var rangeType = cfg["borderInfo"][i].rangeType;

                        if(rangeType == "range"){
                            var borderRange = cfg["borderInfo"][i].range;

                            var emptyRange = [];

                            for(var j = 0; j < borderRange.length; j++){
                                var bd_c1 = borderRange[j].column[0],
                                    bd_c2 = borderRange[j].column[1];

                                if(direction == "lefttop"){
                                    if(index <= bd_c1){
                                        bd_c1 += value;
                                        bd_c2 += value;
                                    }
                                    else if(index <= bd_c2){
                                        bd_c2 += value;
                                    }
                                }
                                else{
                                    if(index < bd_c1){
                                        bd_c1 += value;
                                        bd_c2 += value;
                                    }
                                    else if(index < bd_c2){
                                        bd_c2 += value;
                                    }
                                }

                                if(bd_c2 >= bd_c1){
                                    emptyRange.push({ "row": borderRange[j].row, "column": [bd_c1, bd_c2] });
                                }   
                            }

                            if(emptyRange.length > 0){
                                var bd_obj = {
                                    "rangeType": "range",
                                    "borderType": cfg["borderInfo"][i].borderType,
                                    "style": cfg["borderInfo"][i].style,
                                    "color": cfg["borderInfo"][i].color,
                                    "range": emptyRange
                                }

                                borderInfo.push(bd_obj);
                            }
                        }
                        else if(rangeType == "cell"){
                            var col_index = cfg["borderInfo"][i].value.col_index;

                            if(direction == "lefttop"){
                                if(index <= col_index){
                                    col_index += value;
                                }
                            }
                            else{
                                if(index < col_index){
                                    col_index += value;
                                }
                            }
                            
                            cfg["borderInfo"][i].value.col_index = col_index;
                            borderInfo.push(cfg["borderInfo"][i]);
                        }
                    }

                    cfg["borderInfo"] = borderInfo;
                }
                
                for (var r = 0; r < d.length; r++) {
                    var row = d[r];

                    for(var i = 0; i < value; i++){
                        if(direction == "lefttop"){
                            if(index == 0){
                                row.unshift(col[r]);
                            }
                            else{
                                row.splice(index, 0, col[r]);
                            }
                        }
                        else{
                            row.splice((index + 1), 0, col[r]);
                        }
                    }
                }
            }

            jfgrid.jfrefreshgrid_adRC(d, cfg, "addRC", { "index": index, "len": value, "direction": direction, "rc": type1, "restore": false }, newCalcChain, newFilterObj, newCFarr, newAFarr, newFreezen);
            
            var range = null;
            if(type == "row"){
                if(direction == "lefttop"){
                    range = [{ "row": [index, index + value - 1], "column": [0 , d[0].length - 1] }];
                }
                else{
                    range = [{ "row": [index + 1, index + value], "column": [0 , d[0].length - 1] }];
                }
            }
            else{
                if(direction == "lefttop"){
                    range = [{ "row": [0, d.length - 1], "column": [index, index + value - 1] }];
                }
                else{
                    range = [{ "row": [0, d.length - 1], "column": [index + 1, index + value] }];
                }
            }
            jfgird_select_save = range;
            jfgrid.selectHightlightShow();

            if (type == "row"){
                var scrollLeft = $("#jfgrid-cell-main").scrollLeft(), scrollTop = $("#jfgrid-cell-main").scrollTop();
                var winH = $("#jfgrid-cell-main").height(), winW = $("#jfgrid-cell-main").width();

                var row = visibledatarow[range[0].row[1]], row_pre = range[0].row[0] - 1 == -1 ? 0 : visibledatarow[range[0].row[0] - 1];
                // var col = visibledatacolumn[range[0].column[1]], col_pre = range[0].column[0] - 1 == -1 ? 0 : visibledatacolumn[range[0].column[0] - 1];

                // if (col - scrollLeft - winW + 20 > 0) {
                //     $("#jfgrid-scrollbar-x").scrollLeft(col - winW + 20);
                // }
                // else if (col_pre - scrollLeft - 20 < 0) {
                //     $("#jfgrid-scrollbar-x").scrollLeft(col_pre - 20);
                // }

                if (row - scrollTop - winH + 20 > 0) {
                    $("#jfgrid-scrollbar-y").scrollTop(row - winH + 20);
                }
                else if (row_pre - scrollTop - 20 < 0) {
                    $("#jfgrid-scrollbar-y").scrollTop(row_pre - 20);
                }

                if(value > 30){
                    $("#jfgrid-row-count-show").hide();
                    $("#jfgrid-column-count-show").hide();
                }
            }
        }
        jfgrid.jfgridextendtable = jfgridextendtable;

        var jfgridextendData = function (rowlen, newData) {
            var d = jfgrid.editor.deepCopyFlowData(jfgrid.flowdata);

            var cfg = $.extend(true, {}, config);
            if(cfg["merge"] == null){
                cfg["merge"] = {};
            }

            var collen = d[0].length;
            var addNullData = jfgrid.datagridgrowth([], rowlen, collen);

            d = d.concat(addNullData);

            for(var i = 0; i < newData.length; i++){
                var r = newData[i].r,
                    c = newData[i].c,
                    v = newData[i].v;

                jfgrid.setcellvalue(r, c, d, v);

                if(v != null && v.mc != null && v.mc.rs != null){
                    cfg["merge"][v.mc.r + "_" + v.mc.c] = $.extend(true, {}, v.mc);
                }
            }

            //jfgrid.flowdata
            jfgrid.flowdata = d;
            jfgrid.editor.webWorkerFlowDataCache(jfgrid.flowdata);//worker存数据
            jfgridfile[jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex)].data = d;           

            //config
            config = cfg;
            jfgridfile[jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex)].config = config;

            //行高、列宽刷新
            jfgrid.jfrefreshgrid_rhcw(jfgrid.flowdata.length, jfgrid.flowdata[0].length);
        }
        jfgrid.jfgridextendData = jfgridextendData;

        //向左增加列，向上增加行
        $("#jfgrid-add-lefttop, #jfgrid-add-lefttop_t").click(function (event) {
            $("#jfgrid-rightclick-menu").hide();
            $("#" + container).attr("tabindex", 0).focus();
            
            if(jfgird_select_save.length > 1){
                if(jfgrid.isEditMode()){
                    alert("不能对多重选择区域执行此操作，请选择单个区域，然后再试");
                }
                else{
                    jfgrid.tooltip.info("不能对多重选择区域执行此操作，请选择单个区域，然后再试", "");
                }

                return;
            }

            var $t = $(this), value = $t.parent().find("input").val();
            if (!jfgrid.func_methods.isRealNum(value)) {
                if(jfgrid.isEditMode()){
                    alert("增加错误, 请输入数字");
                }
                else{
                    jfgrid.tooltip.info("增加错误, 请输入数字", "");
                }

                return;
            }

            value = parseInt(value);

            if (value < 1 || value > 100) {
                if(jfgrid.isEditMode()){
                    alert("增加错误, 增加范围限制在1-100");
                }
                else{
                    jfgrid.tooltip.info("增加错误, 增加范围限制在1-100", ""); 
                }
                return;
            }

            var st_index = jfgird_select_save[0][jfgridRightHeadClickIs][0];
            jfgridextendtable(jfgridRightHeadClickIs, st_index, value, "lefttop");
        });

        //向右增加列，向下增加行
        $("#jfgrid-add-rightbottom, #jfgrid-add-rightbottom_t").click(function (event) {
            $("#jfgrid-rightclick-menu").hide();
            $("#" + container).attr("tabindex", 0).focus();

            if(jfgird_select_save.length > 1){
                if(jfgrid.isEditMode()){
                    alert("不能对多重选择区域执行此操作，请选择单个区域，然后再试");
                }
                else{
                    jfgrid.tooltip.info("不能对多重选择区域执行此操作，请选择单个区域，然后再试", "");
                }

                return;
            }

            var $t = $(this), value = $t.parent().find("input").val();
            if (!jfgrid.func_methods.isRealNum(value)) {
                if(jfgrid.isEditMode()){
                    alert("增加错误, 请输入数字");
                }
                else{
                    jfgrid.tooltip.info("增加错误, 请输入数字", ""); 
                }

                return;
            }

            value = parseInt(value);

            if (value < 1 || value > 100) {
                if(jfgrid.isEditMode()){
                    alert("增加错误, 增加范围限制在1-100");
                }
                else{
                    jfgrid.tooltip.info("增加错误, 增加范围限制在1-100", "");
                }

                return;
            }

            var st_index = jfgird_select_save[0][jfgridRightHeadClickIs][1];
            jfgridextendtable(jfgridRightHeadClickIs, st_index, value, "rightbottom");
        });

        var jfgriddeletetable = function (type, st, ed) {
            var d = jfgrid.editor.deepCopyFlowData(jfgrid.flowdata);
            var file = jfgridfile[jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex)];

            var slen = ed - st + 1;
            var cfg = $.extend(true, {}, config);

            //合并单元格配置变动
            if(cfg["merge"] == null){
                cfg["merge"] = {};
            }

            var merge_new = {};
            for(var m in cfg["merge"]){
                var mc = cfg["merge"][m];

                var r = mc.r,
                    c = mc.c,
                    rs = mc.rs,
                    cs = mc.cs;

                if(type == "row"){
                    if(r < st){
                        if(r + rs - 1 < st){
                            merge_new[r + "_" + c] = { "r": r, "c": c, "rs": rs, "cs": cs };
                        }
                        else if(r + rs - 1 >= st && r + rs - 1 < ed){
                            merge_new[r + "_" + c] = { "r": r, "c": c, "rs": st - r, "cs": cs };
                        }
                        else if(r + rs - 1 >= ed){
                            merge_new[r + "_" + c] = { "r": r, "c": c, "rs": rs - slen, "cs": cs };
                        }
                    }
                    else if(r >= st && r <= ed){
                        if(r + rs - 1 > ed){
                            merge_new[st + "_" + c] = { "r": st, "c": c, "rs": r + rs - 1 - ed, "cs": cs };
                        }
                    }
                    else if(r > ed){
                        merge_new[(r - slen) + "_" + c] = { "r": r - slen, "c": c, "rs": rs, "cs": cs };
                    }
                }
                else if(type == "column"){
                    if(c < st){
                        if(c + cs - 1 < st){
                            merge_new[r + "_" + c] = { "r": r, "c": c, "rs": rs, "cs": cs };
                        }
                        else if(c + cs - 1 >= st && c + cs - 1 < ed){
                            merge_new[r + "_" + c] = { "r": r, "c": c, "rs": rs, "cs": st - c };
                        }
                        else if(c + cs - 1 >= ed){
                            merge_new[r + "_" + c] = { "r": r, "c": c, "rs": rs, "cs": cs - slen };
                        }
                    }
                    else if(c >= st && c <= ed){
                        if(c + cs - 1 > ed){
                            merge_new[r + "_" + st] = { "r": r, "c": st, "rs": rs, "cs": c + cs - 1 - ed };
                        }
                    }
                    else if(c > ed){
                        merge_new[r + "_" + (c - slen)] = { "r": r, "c": c - slen, "rs": rs, "cs": cs };
                    }
                }
            }
            cfg["merge"] = merge_new;

            //公式配置变动
            var calcChain = file.calcChain;
            var newCalcChain = [];
            if(calcChain != null && calcChain.length > 0){
                for(var i = 0; i < calcChain.length; i++){
                    var calc = $.extend(true, {}, calcChain[i]);
                    var calc_r = calc.r, calc_c = calc.c, calc_i = calc.index, calc_funcStr = calc.func[2];

                    if(type == "row"){
                        if(calc_r < st || calc_r > ed){
                            var functionStr = "=" + jfgrid.formula.functionStrChange(calc_funcStr, "del", "row", null, st, slen);

                            if(d[calc_r][calc_c].f == calc_funcStr){
                                d[calc_r][calc_c].f = functionStr;
                            }

                            calc.func[2] = functionStr;

                            if(calc_r > ed){
                                calc.r = calc_r - slen;
                            }

                            newCalcChain.push(calc);
                        }
                    }
                    else if(type == "column"){
                        if(calc_c < st || calc_c > ed){
                            var functionStr = "=" + jfgrid.formula.functionStrChange(calc_funcStr, "del", "col", null, st, slen);

                            if(d[calc_r][calc_c].f == calc_funcStr){
                                d[calc_r][calc_c].f = functionStr;
                            }

                            calc.func[2] = functionStr;

                            if(calc_c > ed){
                                calc.c = calc_c - slen;
                            }

                            newCalcChain.push(calc);
                        }
                    }
                }
            }

            //筛选配置变动
            var filter_select = file.filter_select;
            var filter = file.filter;
            var newFilterObj = null;
            if(filter_select != null && JSON.stringify(filter_select) != "{}"){
                newFilterObj = { "filter_select": null, "filter": null };

                var f_r1 = filter_select.row[0], f_r2 = filter_select.row[1];
                var f_c1 = filter_select.column[0], f_c2 = filter_select.column[1];

                if(type == "row"){
                    if(f_r1 > ed){
                        f_r1 -= slen;
                        f_r2 -= slen;

                        newFilterObj.filter_select = { "row": [f_r1, f_r2], "column": [f_c1, f_c2] };
                    }
                    else if(f_r1 < st){
                        if(f_r2 < st){

                        }
                        else if(f_r2 <= ed){
                            f_r2 = st - 1;
                        }
                        else{
                            f_r2 -= slen;
                        }

                        newFilterObj.filter_select = { "row": [f_r1, f_r2], "column": [f_c1, f_c2] };
                    }

                    if(newFilterObj.filter_select != null && filter != null){
                        for(var k in filter){
                            var f_rowhidden = filter[k].rowhidden;
                            var f_rowhidden_new = {};

                            for(var n in f_rowhidden){
                                if(n < st){
                                    f_rowhidden_new[n] = 0;
                                }
                                else if(n > ed){
                                    f_rowhidden_new[n - slen] = 0;
                                }
                            }

                            if(JSON.stringify(f_rowhidden_new) != "{}"){
                                if(newFilterObj.filter == null){
                                    newFilterObj.filter = {};
                                }

                                newFilterObj.filter[k] = $.extend(true, {}, filter[k]);
                                newFilterObj.filter[k].rowhidden = f_rowhidden_new;
                                newFilterObj.filter[k].str = f_r1;
                                newFilterObj.filter[k].edr = f_r2;
                            }
                        }
                    }
                }
                else if(type == "column"){
                    if(f_c1 > ed){
                        f_c1 -= slen;
                        f_c2 -= slen;

                        newFilterObj.filter_select = { "row": [f_r1, f_r2], "column": [f_c1, f_c2] };
                    }
                    else if(f_c1 < st){
                        if(f_c2 < st){

                        }
                        else if(f_c2 <= ed){
                            f_c2 = st - 1;
                        }
                        else{
                            f_c2 -= slen;
                        }

                        newFilterObj.filter_select = { "row": [f_r1, f_r2], "column": [f_c1, f_c2] };
                    }
                    else{
                        if(f_c2 > ed){
                            f_c1 = st;
                            f_c2 -= slen;

                            newFilterObj.filter_select = { "row": [f_r1, f_r2], "column": [f_c1, f_c2] };
                        }
                    }

                    if(newFilterObj.filter_select != null && filter != null){
                        for(var k in filter){
                            var f_cindex = filter[k].cindex;

                            if(f_cindex < st){
                                if(newFilterObj.filter == null){
                                    newFilterObj.filter = {};
                                }

                                newFilterObj.filter[f_cindex - f_c1] = $.extend(true, {}, filter[k]);
                                newFilterObj.filter[f_cindex - f_c1].edc = f_c2;
                            }
                            else if(f_cindex > ed){
                                f_cindex -= slen;

                                if(newFilterObj.filter == null){
                                    newFilterObj.filter = {};
                                }

                                newFilterObj.filter[f_cindex - f_c1] = $.extend(true, {}, filter[k]);
                                newFilterObj.filter[f_cindex - f_c1].cindex = f_cindex;
                                newFilterObj.filter[f_cindex - f_c1].stc = f_c1;
                                newFilterObj.filter[f_cindex - f_c1].edc = f_c2;
                            }
                        }
                    }
                }
            }

            if(newFilterObj != null && newFilterObj.filter != null){
                cfg["rowhidden"] = {};

                for(var k in newFilterObj.filter){
                    var f_rowhidden = newFilterObj.filter[k].rowhidden;

                    for(var n in f_rowhidden){
                        cfg["rowhidden"][n] = 0;
                    }
                }
            }
            else{
                delete cfg["rowhidden"];
            }

            //条件格式配置变动
            var CFarr = file.jfgrid_conditionformat_save;
            var newCFarr = [];
            if(CFarr != null && CFarr.length > 0){
                for(var i = 0; i < CFarr.length; i++){
                    var cf_range = CFarr[i].cellrange;
                    var cf_new_range = [];

                    for(var j = 0; j < cf_range.length; j++){
                        var CFr1 = cf_range[j].row[0],
                            CFr2 = cf_range[j].row[1],
                            CFc1 = cf_range[j].column[0],
                            CFc2 = cf_range[j].column[1];

                        if(type == "row"){
                            if(!(CFr1 >= st && CFr2 <= ed)){
                                if(CFr1 > ed){
                                    CFr1 -= slen;
                                    CFr2 -= slen;
                                }
                                else if(CFr1 < st){
                                    if(CFr2 < st){

                                    }
                                    else if(CFr2 <= ed){
                                        CFr2 = st - 1;
                                    }
                                    else{
                                        CFr2 -= slen;
                                    }
                                }
                                else{
                                    if(CFr2 > ed){
                                        CFr1 = st;
                                        CFr2 -= slen;
                                    }
                                }

                                cf_new_range.push({ "row": [CFr1, CFr2], "column": [CFc1, CFc2] });
                            }
                        }
                        else if(type == "column"){
                            if(!(CFc1 >= st && CFc2 <= ed)){
                                if(CFc1 > ed){
                                    CFc1 -= slen;
                                    CFc2 -= slen;
                                }
                                else if(CFc1 < st){
                                    if(CFc2 < st){

                                    }
                                    else if(CFc2 <= ed){
                                        CFc2 = st - 1;
                                    }
                                    else{
                                        CFc2 -= slen;
                                    }
                                }
                                else{
                                    if(CFc2 > ed){
                                        CFc1 = st;
                                        CFc2 -= slen;
                                    }
                                }

                                cf_new_range.push({ "row": [CFr1, CFr2], "column": [CFc1, CFc2] });
                            }
                        }
                    }

                    if(cf_new_range.length > 0){
                        var cf = $.extend(true, {}, CFarr[i]);
                        cf.cellrange = cf_new_range;

                        newCFarr.push(cf);
                    }
                }
            }

            //交替颜色配置变动
            var AFarr = file.jfgrid_alternateformat_save;
            var newAFarr = [];
            if(AFarr != null && AFarr.length > 0){
                for(var i = 0; i < AFarr.length; i++){
                    var AFr1 = AFarr[i].cellrange.row[0],
                        AFr2 = AFarr[i].cellrange.row[1],
                        AFc1 = AFarr[i].cellrange.column[0],
                        AFc2 = AFarr[i].cellrange.column[1];

                    if(type == "row"){
                        if(!(AFr1 >= st && AFr2 <= ed)){
                            var af = $.extend(true, {}, AFarr[i]);

                            if(AFr1 > ed){
                                AFr1 -= slen;
                                AFr2 -= slen;
                            }
                            else if(AFr1 < st){
                                if(AFr2 < st){

                                }
                                else if(AFr2 <= ed){
                                    AFr2 = st - 1;
                                }
                                else{
                                    AFr2 -= slen;
                                }
                            }
                            else{
                                if(AFr2 > ed){
                                    AFr1 = st;
                                    AFr2 -= slen;
                                }
                            }

                            af.cellrange = { "row": [AFr1, AFr2], "column": [AFc1, AFc2] };

                            newAFarr.push(af);
                        }
                    }
                    else if(type == "column"){
                        if(!(AFc1 >= st && AFc2 <= ed)){
                            var af = $.extend(true, {}, AFarr[i]);

                            if(AFc1 > ed){
                                AFc1 -= slen;
                                AFc2 -= slen;
                            }
                            else if(AFc1 < st){
                                if(AFc2 < st){

                                }
                                else if(AFc2 <= ed){
                                    AFc2 = st - 1;
                                }
                                else{
                                    AFc2 -= slen;
                                }
                            }
                            else{
                                if(AFc2 > ed){
                                    AFc1 = st;
                                    AFc2 -= slen;
                                }
                            }

                            af.cellrange = { "row": [AFr1, AFr2], "column": [AFc1, AFc2] };

                            newAFarr.push(af);
                        }
                    }
                }
            }

            //冻结配置变动
            var newFreezen = { "freezenhorizontaldata": null, "freezenverticaldata": null };
            if(jfgrid.freezen.freezenhorizontaldata != null && type == "row"){
                var freezen_scrollTop = jfgrid.freezen.freezenhorizontaldata[2];
                var freezen_st = jfgrid_searcharray(visibledatarow, freezen_scrollTop);
                if(freezen_st == -1){
                    freezen_st = 0;
                }

                var freezen_row_st = jfgrid.freezen.freezenhorizontaldata[1] - 1;

                if(freezen_row_st >= st){
                    if(freezen_row_st < ed){
                        freezen_row_st = st - 1;
                    }
                    else{
                        freezen_row_st -= slen;
                    }
                }

                if(freezen_row_st < freezen_st){
                    freezen_row_st = freezen_st;
                }

                var freezen_top = visibledatarow[freezen_row_st] - 2 - freezen_scrollTop + columeHeaderHeight;

                newFreezen.freezenhorizontaldata = [visibledatarow[freezen_row_st], freezen_row_st + 1, freezen_scrollTop, jfgrid.freezen.cutVolumn(visibledatarow, freezen_row_st + 1), freezen_top];
            }
            else{
                newFreezen.freezenhorizontaldata = jfgrid.freezen.freezenhorizontaldata;
            }

            if(jfgrid.freezen.freezenverticaldata != null && type == "column"){
                var freezen_scrollLeft = jfgrid.freezen.freezenverticaldata[2];
                var freezen_st2 = jfgrid_searcharray(visibledatacolumn, freezen_scrollLeft);
                if(freezen_st2 == -1){
                    freezen_st2 = 0;
                }

                var freezen_col_st = jfgrid.freezen.freezenverticaldata[1] - 1;

                if(freezen_col_st >= st){
                    if(freezen_col_st < ed){
                        freezen_col_st = st - 1;
                    }
                    else{
                        freezen_col_st -= slen;
                    }
                }

                if(freezen_col_st < freezen_st2){
                    freezen_col_st = freezen_st2;
                }

                var freezen_left = visibledatacolumn[freezen_col_st] - 2 - freezen_scrollLeft + rowHeaderWidth;

                newFreezen.freezenverticaldata = [visibledatacolumn[freezen_col_st], freezen_col_st + 1, freezen_scrollLeft, jfgrid.freezen.cutVolumn(visibledatacolumn, freezen_col_st + 1), freezen_left];
            }
            else{
                newFreezen.freezenverticaldata = jfgrid.freezen.freezenverticaldata;
            }

            //主逻辑
            if (type == "row") {
                var type1 = "r";

                //行高配置变动
                if(cfg["rowlen"] == null){
                    cfg["rowlen"] = {};
                }

                var rowlen_new = {};
                for(var r in cfg["rowlen"]){
                    if(r < st){
                        rowlen_new[r] = cfg["rowlen"][r];
                    }
                    else if(r > ed){
                        rowlen_new[r - slen] = cfg["rowlen"][r];
                    }
                }

                cfg["rowlen"] = rowlen_new;

                //边框配置变动
                if(cfg["borderInfo"] && cfg["borderInfo"].length > 0){
                    var borderInfo = []; 

                    for(var i = 0; i < cfg["borderInfo"].length; i++){
                        var rangeType = cfg["borderInfo"][i].rangeType;

                        if(rangeType == "range"){
                            var borderRange = cfg["borderInfo"][i].range;

                            var emptyRange = [];

                            for(var j = 0; j < borderRange.length; j++){
                                var bd_r1 = borderRange[j].row[0],
                                    bd_r2 = borderRange[j].row[1];

                                for(var r = st; r <= ed; r++){
                                    if(r < borderRange[j].row[0]){
                                        bd_r1 -= 1;
                                        bd_r2 -= 1;
                                    }
                                    else if(r <= borderRange[j].row[1]){
                                        bd_r2 -= 1;
                                    }
                                } 

                                if(bd_r2 >= bd_r1){
                                    emptyRange.push({ "row": [bd_r1, bd_r2], "column": borderRange[j].column });
                                }   
                            }

                            if(emptyRange.length > 0){
                                var bd_obj = {
                                    "rangeType": "range",
                                    "borderType": cfg["borderInfo"][i].borderType,
                                    "style": cfg["borderInfo"][i].style,
                                    "color": cfg["borderInfo"][i].color,
                                    "range": emptyRange
                                }

                                borderInfo.push(bd_obj);
                            }
                        }
                        else if(rangeType == "cell"){
                            var row_index = cfg["borderInfo"][i].value.row_index;

                            if(row_index < st){
                                borderInfo.push(cfg["borderInfo"][i]);
                            }
                            else if(row_index > ed){
                                cfg["borderInfo"][i].value.row_index = row_index - (ed - st + 1);
                                borderInfo.push(cfg["borderInfo"][i]);
                            }
                        }
                    }

                    cfg["borderInfo"] = borderInfo;
                }

                //删除选中行
                d.splice(st, slen);

                if(!jfgridConfigsetting.pointEdit){//非编辑器qksheet表格编辑状态
                    //空白行模板
                    var row = [];
                    for (var c = 0; c < d[0].length; c++) {
                        row.push(null);
                    }

                    //删除多少行，增加多少行空白行                
                    for (var r = 0; r < slen; r++) {
                        d.push(row);
                    }
                }
            }
            else {
                var type1 = "c";

                //列宽配置变动
                if(cfg["columlen"] == null){
                    cfg["columlen"] = {};
                }

                var columlen_new = {};
                for(var c in cfg["columlen"]){
                    if(c < st){
                        columlen_new[c] = cfg["columlen"][c];
                    }
                    else if(c > ed){
                        columlen_new[c - slen] = cfg["columlen"][c];
                    }
                }

                cfg["columlen"] = columlen_new;

                //边框配置变动
                if(cfg["borderInfo"] && cfg["borderInfo"].length > 0){
                    var borderInfo = [];

                    for(var i = 0; i < cfg["borderInfo"].length; i++){
                        var rangeType = cfg["borderInfo"][i].rangeType;

                        if(rangeType == "range"){
                            var borderRange = cfg["borderInfo"][i].range;

                            var emptyRange = [];

                            for(var j = 0; j < borderRange.length; j++){
                                var bd_c1 = borderRange[j].column[0],
                                    bd_c2 = borderRange[j].column[1];

                                for(var c = st; c <= ed; c++){
                                    if(c < borderRange[j].column[0]){
                                        bd_c1 -= 1;
                                        bd_c2 -= 1;
                                    }
                                    else if(c <= borderRange[j].column[1]){
                                        bd_c2 -= 1;
                                    }
                                } 

                                if(bd_c2 >= bd_c1){
                                    emptyRange.push({ "row": borderRange[j].row, "column": [bd_c1, bd_c2] });
                                }   
                            }

                            if(emptyRange.length > 0){
                                var bd_obj = {
                                    "rangeType": "range",
                                    "borderType": cfg["borderInfo"][i].borderType,
                                    "style": cfg["borderInfo"][i].style,
                                    "color": cfg["borderInfo"][i].color,
                                    "range": emptyRange
                                }

                                borderInfo.push(bd_obj);
                            }
                        }
                        else if(rangeType == "cell"){
                            var col_index = cfg["borderInfo"][i].value.col_index;

                            if(col_index < st){
                                borderInfo.push(cfg["borderInfo"][i]);
                            }
                            else if(col_index > ed){
                                cfg["borderInfo"][i].value.col_index = col_index - (ed - st + 1);
                                borderInfo.push(cfg["borderInfo"][i]);
                            }
                        }
                    }

                    cfg["borderInfo"] = borderInfo;
                }
                
                //空白列模板
                var addcol = [];
                if(!jfgridConfigsetting.pointEdit){//非编辑器qksheet表格编辑状态
                    for (var r = 0; r < slen; r++) {
                        addcol.push(null);
                    }
                }

                for (var r = 0; r < d.length; r++) {
                    var row = [].concat(d[r]);
                    
                    //删除选中列
                    row.splice(st, slen);
                    
                    d[r] = row.concat(addcol);
                }
            }

            jfgrid.jfrefreshgrid_adRC(d, cfg, "delRC", { "index": st, "len": ed - st + 1, "rc": type1 }, newCalcChain, newFilterObj, newCFarr, newAFarr, newFreezen);
        }
        jfgrid.jfgriddeletetable = jfgriddeletetable;

        //删除选中行列
        $("#jfgrid-del-selected, #jfgrid-del-selected_t").click(function (event) {
            $("#jfgrid-rightclick-menu").hide();
            $("#" + container).attr("tabindex", 0).focus();

            if(jfgird_select_save.length > 1){
                if(jfgridRightHeadClickIs == "row"){
                    if(jfgrid.isEditMode()){
                        alert("不能对多重选择区域执行此操作，请选择单个区域，然后再试");
                    }
                    else{
                        jfgrid.tooltip.info("不能对多重选择区域执行此操作，请选择单个区域，然后再试", "");
                    }
                }
                else if(jfgridRightHeadClickIs == "column"){
                    if(jfgrid.isEditMode()){
                        alert("不能对多重选择区域执行此操作，请选择单个区域，然后再试");
                    }
                    else{
                        jfgrid.tooltip.info("不能对多重选择区域执行此操作，请选择单个区域，然后再试", ""); 
                    }
                }
                return;
            }

            var st_index = jfgird_select_save[0][jfgridRightHeadClickIs][0], ed_index = jfgird_select_save[0][jfgridRightHeadClickIs][1];
            jfgriddeletetable(jfgridRightHeadClickIs, st_index, ed_index);
        });

        //清除单元格内容
        $("#jfgrid-delete-text").click(function(){
            $("#jfgrid-rightclick-menu").hide();
            $("#" + container).attr("tabindex", 0).focus();

            if(jfgird_select_save.length > 0){
                var d = jfgrid.editor.deepCopyFlowData(jfgrid.flowdata);

                var hasPartMC = false;

                for(var s = 0; s < jfgird_select_save.length; s++){
                    var r1 = jfgird_select_save[s].row[0], r2 = jfgird_select_save[s].row[1];
                    var c1 = jfgird_select_save[s].column[0], c2 = jfgird_select_save[s].column[1];

                    if(jfgrid.hasPartMC(config, r1, r2, c1, c2)){
                        hasPartMC = true;
                        break;
                    }
                }

                if(hasPartMC){
                    if(jfgrid.isEditMode()){
                        alert("无法对部分合并单元格执行此操作");
                    }
                    else{
                        jfgrid.tooltip.info("无法对部分合并单元格执行此操作", "");
                    }

                    return;
                }

                for(var s = 0; s < jfgird_select_save.length; s++){
                    var r1 = jfgird_select_save[s].row[0], r2 = jfgird_select_save[s].row[1];
                    var c1 = jfgird_select_save[s].column[0], c2 = jfgird_select_save[s].column[1];

                    for(var r = r1; r <= r2; r++){
                        for(var c = c1; c <= c2; c++){
                            if(jfgrid.pivotTable.isPivotRange(r, c)){
                                continue;
                            }

                            if(jfgrid.getObjType(d[r][c]) == "object"){
                                delete d[r][c]["m"];
                                delete d[r][c]["v"];

                                if(d[r][c]["f"] != null){
                                    delete d[r][c]["f"];
                                    jfgrid.formula.delFunctionGroup(r, c, jfgrid.currentSheetIndex);

                                    delete d[r][c]["spl"];
                                }
                            }
                            else{
                                d[r][c] = null;
                            }
                        }
                    }
                }

                jfgrid.jfrefreshgrid(d, jfgird_select_save);
            }
        });

        //行高列宽设置
        $("#jfgrid-rows-cols-changesize").click(function(){
            $("#jfgrid-rightclick-menu").hide();
            $("#" + container).attr("tabindex", 0).focus();

            var size = parseInt($(this).siblings("input[type='number']").val().trim());

            if(size < 0 || size > 255){
                if(jfgrid.isEditMode()){
                    alert("数值必须在0 ~ 255之间");
                }
                else{
                    jfgrid.tooltip.info("数值必须在0 ~ 255之间", "");
                }
                
                return;
            }

            var cfg = $.extend(true, {}, config);
            var type;

            if(jfgridRightHeadClickIs == "row"){
                type = "resizeR";

                if(cfg["rowlen"] == null){
                    cfg["rowlen"] = {};
                }

                for(var s = 0; s < jfgird_select_save.length; s++){
                    var r1 = jfgird_select_save[s].row[0];
                    var r2 = jfgird_select_save[s].row[1];

                    for(var r = r1; r <= r2; r++){
                        cfg["rowlen"][r] = size;
                    }
                }
            }
            else if(jfgridRightHeadClickIs == "column"){
                type = "resizeC";

                if(cfg["columlen"] == null){
                    cfg["columlen"] = {};
                }

                for(var s = 0; s < jfgird_select_save.length; s++){
                    var c1 = jfgird_select_save[s].column[0];
                    var c2 = jfgird_select_save[s].column[1];

                    for(var c = c1; c <= c2; c++){
                        cfg["columlen"][c] = size;
                    }
                }
            }

            if (clearjfundo) {
                jfgrid.jfundo = [];

                jfgrid.jfredo.push({
                    "type": "resize",
                    "ctrlType": type,
                    "config": $.extend(true, {}, config),
                    "curconfig": $.extend(true, {}, cfg),
                    "sheetIndex": jfgrid.currentSheetIndex
                });
            }

            //config
            config = cfg;
            jfgridfile[jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex)].config = config;

            if(jfgridRightHeadClickIs == "row"){
                jfgrid.server.saveParam("cg", jfgrid.currentSheetIndex, cfg["rowlen"], { "k": "rowlen" });

                jfgrid.jfrefreshgrid_rhcw(jfgrid.flowdata.length, null);
            }
            else if(jfgridRightHeadClickIs == "column"){
                jfgrid.server.saveParam("cg", jfgrid.currentSheetIndex, cfg["columlen"], { "k": "columlen" });

                jfgrid.jfrefreshgrid_rhcw(null, jfgrid.flowdata[0].length);
            }
        });

        var jfgrid_sort_existSort = {}, jfgrid_sort_initial = true, jfgrid_model_move_state = false, jfgrid_model_xy = [0, 0], jfgrid_model_move_obj = null;

        $(document).on("mousedown", "div.jfgrid-modal-dialog", function (e) {
            if (!$(e.target).is(".jfgrid-modal-dialog")) {
                return;
            }

            jfgrid_model_move_state = true;

            jfgrid_model_move_obj = $(e.currentTarget);
            var toffset = jfgrid_model_move_obj.offset();
            jfgrid_model_xy = [e.pageX - toffset.left, e.pageY - toffset.top];
        });

        $(document).on("click", ".jfgrid-modal-dialog-title-close, .jfgrid-model-close-btn", function (e) {
            //选择文本颜色和单元格颜色弹出框取消
            if($("#textcolorselect").is(":visible")||$("#cellcolorselect").is(":visible")){
                $("#jfgrid-conditionformat-dialog").show();
            }
            $(e.currentTarget).parents(".jfgrid-modal-dialog").hide();
            $("#jfgrid-modal-dialog-mask").hide();
            //函数查找功能所有弹出框关闭和取消
            if($(this).parents(".jfgrid-modal-dialog").hasClass("jfgrid-search-formula")){
                jfgrid.formula.dontupdate();
                jfgridMoveHighlightCell("down", 0, "rangeOfSelect");
            }
            if($(this).parents(".jfgrid-modal-dialog").hasClass("jfgrid-search-formula-parm")){
                jfgrid.formula.dontupdate();
                jfgridMoveHighlightCell("down", 0, "rangeOfSelect");
            }
            if($(this).parents(".jfgrid-modal-dialog").hasClass("jfgrid-search-formula-parm-select")){
                jfgrid.formula.dontupdate();
                jfgridMoveHighlightCell("down", 0, "rangeOfSelect");
            }

            $("#" + container).attr("tabindex", 0).focus();
        });


        $("#jfgridorderby").click(function () {
            $("body .jfgrid-cols-menu").hide();

            if(jfgird_select_save.length > 1){
                if(jfgrid.isEditMode()){
                    alert("不能对多重选择区域执行此操作，请选择单个区域，然后再试");
                }
                else{
                    jfgrid.tooltip.info("不能对多重选择区域执行此操作，请选择单个区域，然后再试", ""); 
                }
                return;
            }

            var last = jfgird_select_save[0];
            var r1 = last["row"][0], r2 = last["row"][1];
            var c1 = last["column"][0], c2 = last["column"][1];

            if (jfgrid_sort_initial) {
                jfgrid_sort_initial = false;
                var content = '<div style="overflow: hidden;" class="jfgrid-sort-modal"><div><label><input type="checkbox" id="jfgrid-sort-haveheader"/><span>数据具有标题行</span></label></div><div style="overflow-y:auto;" id="jfgrid-sort-dialog-tablec"><table data-itemcount="0" cellspacing="0"> <tr><td>排序依据 <select name="sort_0"> <option value="1">1</option> <option value="2">2</option> <option value="3">3</option> <option value="4">4</option> </select> </td> <td> <div><label><input value="asc" type="radio" checked="checked" name="sort_0"><span>正序A-Z</span></label></div> <div><label><input value="desc" type="radio" name="sort_0"><span>倒序Z-A</span></label></div></td></tr></table></div><div style="background: #e5e5e5;border-top: 1px solid #f5f5f5; height: 1px; width: 100%;margin:2px 0px;margin-bottom:10px;"></div> <div> <span style="font-weight: bold; text-decoration: underline;text-align:center;color: blue;cursor: pointer;" class="jfgrid-sort-dialog-additem">+ 添加其他排序列</span> </div> </div>';

                $("body").append(jfgrid.replaceHtml(modelHTML, { "id": "jfgrid-sort-dialog", "addclass": "", "title": "排序范围", "content": content, "botton": '<button id="jfgrid-sort-modal-confirm" class="btn btn-primary">排序</button><button class="btn btn-default jfgrid-model-close-btn">关闭</button>' }));

                $("#jfgrid-sort-dialog .jfgrid-sort-dialog-additem").click(function () {
                    var last = jfgird_select_save[0];
                    var r1 = last["row"][0], r2 = last["row"][1];
                    var c1 = last["column"][0], c2 = last["column"][1];

                    var option = "", i = $("#jfgrid-sort-dialog table").data("itemcount") + 1;
                    var t = $("#jfgrid-sort-haveheader").is(':checked');

                    for (var c = c1; c <= c2; c++) {
                        if (t) {
                            var v = jfgrid.getcellvalue(r1, c, jfgrid.flowdata, "m");

                            if(v == null){
                                v = "列" + (c - c1 + 1); 
                            }

                            option += '<option value="' + c + '">' + v + '</option>';
                        }
                        else {
                            option += '<option value="' + c + '">' + jfgrid.jfgridchatatABC(c) + '</option>';
                        }
                    }

                    $("#jfgrid-sort-dialog table").append('<tr class="jfgrid-sort-dialog-tr"><td><span class="jfgrid-sort-item-close" onclick="$(this).parent().parent().remove();"><i class="fa fa-times" aria-hidden="true"></i></span>次要排序 <select name="sort_' + i + '">' + option + '</select> </td> <td> <div><label><input value="asc" type="radio" checked="checked" name="sort_' + i + '"><span>正序A-Z</span></label></div> <div><label><input value="desc" type="radio" name="sort_' + i + '"><span>倒序Z-A</span></label></div></td></tr>');
                    $("#jfgrid-sort-dialog table").data("itemcount", i);
                });

                $("#jfgrid-sort-haveheader").change(function () {
                    var last = jfgird_select_save[0];
                    var r1 = last["row"][0], r2 = last["row"][1];
                    var c1 = last["column"][0], c2 = last["column"][1];

                    var t = $(this).is(':checked');
                    var option = "";

                    for (var c = c1; c <= c2; c++) {
                        if (t) {
                            var v = jfgrid.getcellvalue(r1, c, jfgrid.flowdata, "m");
                            
                            if(v == null){
                                v = "列" + (c - c1 + 1); 
                            }

                            option += '<option value="' + c + '">' + v + '</option>';
                        }
                        else {
                            option += '<option value="' + c + '">' + jfgrid.jfgridchatatABC(c) + '</option>';
                        }
                    }

                    $("#jfgrid-sort-dialog tr select").each(function () {
                        $(this).html(option);
                    });
                });

                //自定义排序
                $("#jfgrid-sort-modal-confirm").click(function () {
                    if(jfgird_select_save.length > 1){
                        if(jfgrid.isEditMode()){
                            alert("不能对多重选择区域执行此操作，请选择单个区域，然后再试");
                        }
                        else{
                            jfgrid.tooltip.info("不能对多重选择区域执行此操作，请选择单个区域，然后再试", "");
                        }

                        return;
                    }

                    var d = jfgrid.editor.deepCopyFlowData(jfgrid.flowdata);

                    var last = jfgird_select_save[0];
                    var r1 = last["row"][0], r2 = last["row"][1];
                    var c1 = last["column"][0], c2 = last["column"][1];

                    //数据具有标题行
                    var t = $("#jfgrid-sort-haveheader").is(':checked');

                    if(t){
                        var str = r1 + 1;
                    }
                    else{
                        var str = r1;
                    }

                    var hasMc = false; //排序选区是否有合并单元格
                    var data = [];

                    for(var r = str; r <= r2; r++){
                        var data_row = [];

                        for(var c = c1; c <= c2; c++){
                            if(d[r][c] != null && d[r][c].mc != null){
                                hasMc = true;
                                break;
                            }

                            data_row.push(d[r][c]);
                        }

                        data.push(data_row);
                    }

                    if(hasMc){
                        if(jfgrid.isEditMode()){
                            alert("选区有合并单元格，无法执行此操作！");
                        }
                        else{
                            jfgrid.tooltip.info("选区有合并单元格，无法执行此操作！", "");
                        }

                        return;
                    }
                    
                    $($("#jfgrid-sort-dialog table tr").toArray().reverse()).each(function () {
                        var i = $(this).find("select").val(), 
                            asc = $(this).find('input:radio:checked').val();
                        
                        i -= c1;
                        
                        if (asc == "asc") {
                            asc = true;
                        }
                        else {
                            asc = false;
                        }

                        data = jfgrid.orderbydata([].concat(data), i, asc);
                    });

                    for(var r = str; r <= r2; r++){
                        for(var c = c1; c <= c2; c++){
                            d[r][c] = data[r - str][c - c1];
                        }
                    }

                    if(config["rowlen"] != null){
                        var cfg = $.extend(true, {}, config);
                        cfg = jfgrid.rowlenByRange(d, str, r2, cfg);

                        jfgrid.jfrefreshgrid(d, [{ "row": [str, r2], "column": [c1, c2] }], cfg, null, true);
                    }
                    else{
                        jfgrid.jfrefreshgrid(d, [{ "row": [str, r2], "column": [c1, c2] }]);
                    }

                    $("#jfgrid-sort-dialog").hide();
                    $("#jfgrid-modal-dialog-mask").hide();
                });
            }

            var option = "";
            for (var c = c1; c <= c2; c++) {
                option += '<option value="' + c + '">' + jfgrid.jfgridchatatABC(c) + '</option>';
            }

            $("#jfgrid-sort-dialog select").html(option);

            $("#jfgrid-sort-dialog .jfgrid-sort-dialog-tr").remove();

            $("#jfgrid-sort-haveheader").prop("checked", false);
            $("#jfgrid-sort-dialog input:radio:first").prop("checked", "checked");

            $("#jfgrid-sort-dialog .jfgrid-modal-dialog-title-text").html("排序范围从<span>" + jfgrid.jfgridchatatABC(c1) + (r1 + 1) + "</span>到<span>" + jfgrid.jfgridchatatABC(c2) + (r2 + 1) + "</span>");

            var $t = $("#jfgrid-sort-dialog"), myh = $t.outerHeight(), myw = $t.outerWidth();
            var winw = $(window).width(), winh = $(window).height();
            var scrollLeft = $(document).scrollLeft(), scrollTop = $(document).scrollTop();

            $("#jfgrid-sort-dialog-tablec").css("max-height", (winh - myh) / 2);
            $("#jfgrid-sort-dialog").css({ "left": (winw + scrollLeft - myw) / 2, "top": (winh + scrollTop - myh) / 2 }).show();
            $("#jfgrid-modal-dialog-mask").show();
            

            if (r1 < r2) {
                setTimeout(function () {
                    var flowrowdata1 = jfgrid.flowdata[r1], flowrowdata2 = jfgrid.flowdata[r1 + 1], hastitle = false;
                    
                    for (var i = c1; i <= c2; i++) {
                        var isdatatype_r1 = jfgrid.isdatatype(flowrowdata1[i]), isdatatype_r2 = jfgrid.isdatatype(flowrowdata2[i]);
                        
                        if (isdatatype_r1 != isdatatype_r2) {
                            hastitle = true;
                        }
                    }

                    if (hastitle) {
                        $("#jfgrid-sort-haveheader").prop("checked", true).change();
                    }
                }, 10);
            }
        });



        //筛选事件处理
        var hidefilersubmenu = null;
        $("#jfgrid-filter-menu").mouseover(function () {
            clearTimeout(hidefilersubmenu);
            
            hidefilersubmenu = setTimeout(function () {
                $("#jfgrid-filter-submenu").hide();
            }, 500);
        });

        $("#jfgrid-filter-submenu").mouseover(function () {
            clearTimeout(hidefilersubmenu);
        }).find(".jfgrid-cols-menuitem").click(function (e) {
            $("#jfgrid-filter-selected span").html($(this).find(".jfgrid-cols-menuitem-content").text()).data("value", $(this).data("value"));
            $("#jfgrid-filter-menu .jfgrid-filter-selected-input").hide();

            var $type = $(this).data("type");
            var $value = $(this).attr("data-value");
            
            if ($type == "2") {
                $("#jfgrid-filter-selected span").data("type", "2");
                $("#jfgrid-filter-menu .jfgrid-filter-selected-input2").show();
                $("#jfgrid-filter-menu .jfgrid-filter-selected-input input").prop("type", "number");
            }
            else if ($type == "0") {
                $("#jfgrid-filter-selected span").data("type", "0");
            }
            else {
                $("#jfgrid-filter-selected span").data("type", "1");
                $("#jfgrid-filter-menu .jfgrid-filter-selected-input").eq(0).show();
                
                //若是日期 改变input type类型为date
                if($value == "dateequal" || $value == "datelessthan" || $value == "datemorethan"){
                    $("#jfgrid-filter-menu .jfgrid-filter-selected-input input").prop("type", "date");
                }
                else if($value == "morethan" || $value == "moreequalthan" || $value == "lessthan" || $value == "lessequalthan" || $value == "equal" || $value == "noequal"){
                    $("#jfgrid-filter-menu .jfgrid-filter-selected-input input").prop("type", "number");
                }
                else{
                    $("#jfgrid-filter-menu .jfgrid-filter-selected-input input").prop("type", "text");
                }
            }

            $("#jfgrid-filter-byvalue").next().slideUp();
            $("#jfgrid-filter-submenu").hide();
        });

        $("#jfgrid-filter-bycondition, #jfgrid-filter-byvalue").click(function () {
            var $t = $(this);
            $t.next().slideToggle(200);

            setTimeout(function () {
                if ($t.attr("id") == "jfgrid-filter-bycondition" && $("#jfgrid-filter-bycondition").next().is(":visible")) {
                    if ($("#jfgrid-filter-selected span").text() != "无") {
                        $("#jfgrid-filter-byvalue").next().slideUp(200);
                    }
                }

                if ($t.is($("#jfgrid-filter-bycondition"))) {
                    if ($("#jfgrid-filter-bycondition").next().is(":hidden") && $("#jfgrid-filter-byvalue").next().is(":hidden")) {
                        $("#jfgrid-filter-byvalue").next().slideDown(200);
                    }
                }
            }, 300);
        });

        //筛选取消
        $("#jfgrid-filter-cancel").click(function () {
            $("#jfgrid-filter-menu, #jfgrid-filter-submenu").hide();
        });

        //筛选 确认
        $("#jfgrid-filter-confirm").click(function () {
            var $menu = $("#jfgrid-filter-menu");
            var st_r = $menu.data("str"), 
                ed_r = $menu.data("edr"), 
                cindex = $menu.data("cindex"), 
                st_c = $menu.data("stc"), 
                ed_c = $menu.data("edc");

            var rowhiddenother = {}; //其它筛选列的隐藏行
            $("#jfgrid-filter-options-sheet" + jfgrid.currentSheetIndex + " .jfgrid-filter-options").not($("#jfgrid-filter-options-sheet" + jfgrid.currentSheetIndex + " .jfgrid-filter-options").eq(cindex - st_c).get(0)).each(function () {
                var $t = $(this), rh = $t.data("rowhidden");

                if (rh == "") {
                    return true;
                }

                rh = JSON.parse(rh.replace(/\'/g, '"'));
                
                for (var r in rh) {
                    rowhiddenother[r] = 0;
                }
            });

            var filterdata = {};
            var rowhidden = {};
            var caljs = {};

            if ($("#jfgrid-filter-bycondition").next().is(":visible") && $("#jfgrid-filter-byvalue").next().is(":hidden") && $("#jfgrid-filter-selected span").data("value") != "null") {
                var $t = $("#jfgrid-filter-selected span");
                var type = $t.data("type"), value = $t.data("value");

                caljs["value"] = value;
                caljs["text"] = $t.text();

                if (type == "0") {
                    caljs["type"] = "0";
                }
                else if (type == "2") {
                    var $input = $("#jfgrid-filter-menu .jfgrid-filter-selected-input2 input");
                    caljs["type"] = "2";
                    caljs["value1"] = $input.eq(0).val();
                    caljs["value2"] = $input.eq(1).val();
                }
                else {
                    caljs["type"] = "1";
                    caljs["value1"] = $("#jfgrid-filter-menu .jfgrid-filter-selected-input").eq(0).find("input").val();
                }

                for (var r = st_r + 1; r <= ed_r; r++) {
                    if(r in rowhiddenother){
                        continue;
                    }

                    if(jfgrid.flowdata[r] == null){
                        continue;
                    }

                    var cell = jfgrid.flowdata[r][cindex];
                    
                    if (value == "cellnull") { //单元格为空
                        if(cell != null && !jfgrid.func_methods.isRealNull(cell.v)){
                            rowhidden[r] = 0;
                        }
                    }
                    else if (value == "cellnonull") { //单元格有数据
                        if(cell == null || jfgrid.func_methods.isRealNull(cell.v)){
                            rowhidden[r] = 0;
                        }
                    }
                    else if (value == "textinclude") { //文本包含 
                        var value1 = caljs["value1"];

                        if(cell == null || jfgrid.func_methods.isRealNull(cell.v)){
                            rowhidden[r] = 0;
                        }
                        else{
                            if(cell.m.indexOf(value1) == -1){
                                rowhidden[r] = 0;
                            }
                        }
                    }
                    else if (value == "textnotinclude") { //文本不包含
                        var value1 = caljs["value1"];

                        if(cell == null || jfgrid.func_methods.isRealNull(cell.v)){

                        }
                        else{
                            if(cell.m.indexOf(value1) > -1){
                                rowhidden[r] = 0;
                            }
                        }
                    }
                    else if (value == "textstart") { //文本开头为
                        var value1 = caljs["value1"], valuelen = value1.length;

                        if(cell == null || jfgrid.func_methods.isRealNull(cell.v)){
                            rowhidden[r] = 0;
                        }
                        else{
                            if(cell.m.substr(0, valuelen) != value1){
                                rowhidden[r] = 0;
                            }
                        }
                    }
                    else if (value == "textend") { //文本结尾为
                        var value1 = caljs["value1"], valuelen = value1.length;

                        if(cell == null || jfgrid.func_methods.isRealNull(cell.v)){
                            rowhidden[r] = 0;
                        }
                        else{
                            if(valuelen > cell.m.length || cell.m.substr(cell.m.length - valuelen, valuelen) != value1){
                                rowhidden[r] = 0;
                            }
                        }
                    }
                    else if (value == "textequal") { //文本等于
                        var value1 = caljs["value1"];

                        if(cell == null || jfgrid.func_methods.isRealNull(cell.v)){
                            rowhidden[r] = 0;
                        }
                        else{
                            if(cell.m != value1){
                                rowhidden[r] = 0;
                            }
                        }
                    }
                    else if (value == "dateequal") { //日期等于
                        var value1 = jfgrid.mask.genarate(caljs["value1"])[2];

                        if(cell == null || jfgrid.func_methods.isRealNull(cell.v)){
                            rowhidden[r] = 0;
                        }
                        else if(cell.ct != null && cell.ct.t == "d"){
                            if(parseInt(cell.v) != value1){
                                rowhidden[r] = 0;
                            }
                        }
                        else{
                            rowhidden[r] = 0;
                        }
                    }
                    else if (value == "datelessthan") { //日期早于
                        var value1 = jfgrid.mask.genarate(caljs["value1"])[2];

                        if(cell == null || jfgrid.func_methods.isRealNull(cell.v)){
                            rowhidden[r] = 0;
                        }
                        else if(cell.ct != null && cell.ct.t == "d"){
                            if(parseInt(cell.v) >= value1){
                                rowhidden[r] = 0;
                            }
                        }
                        else{
                            rowhidden[r] = 0;
                        }
                    }
                    else if (value == "datemorethan") { //日期晚于
                        var value1 = jfgrid.mask.genarate(caljs["value1"])[2];

                        if(cell == null || jfgrid.func_methods.isRealNull(cell.v)){
                            rowhidden[r] = 0;
                        }
                        else if(cell.ct != null && cell.ct.t == "d"){
                            if(parseInt(cell.v) <= value1){
                                rowhidden[r] = 0;
                            }
                        }
                        else{
                            rowhidden[r] = 0;
                        }
                    }
                    else if (value == "morethan") { //大于
                        var value1 = parseFloat(caljs["value1"]);

                        if(cell == null || jfgrid.func_methods.isRealNull(cell.v)){
                            rowhidden[r] = 0;
                        }
                        else if(cell.ct != null && cell.ct.t == "n"){
                            if(cell.v <= value1){
                                rowhidden[r] = 0;
                            }
                        }
                        else{
                            rowhidden[r] = 0;
                        }
                    }
                    else if (value == "moreequalthan") { //大于等于
                        var value1 = parseFloat(caljs["value1"]);

                        if(cell == null || jfgrid.func_methods.isRealNull(cell.v)){
                            rowhidden[r] = 0;
                        }
                        else if(cell.ct != null && cell.ct.t == "n"){
                            if(cell.v < value1){
                                rowhidden[r] = 0;
                            }
                        }
                        else{
                            rowhidden[r] = 0;
                        }
                    }
                    else if (value == "lessthan") { //小于
                        var value1 = parseFloat(caljs["value1"]);

                        if(cell == null || jfgrid.func_methods.isRealNull(cell.v)){
                            rowhidden[r] = 0;
                        }
                        else if(cell.ct != null && cell.ct.t == "n"){
                            if(cell.v >= value1){
                                rowhidden[r] = 0;
                            }
                        }
                        else{
                            rowhidden[r] = 0;
                        }
                    }
                    else if (value == "lessequalthan") { //小于等于
                        var value1 = parseFloat(caljs["value1"]);

                        if(cell == null || jfgrid.func_methods.isRealNull(cell.v)){
                            rowhidden[r] = 0;
                        }
                        else if(cell.ct != null && cell.ct.t == "n"){
                            if(cell.v > value1){
                                rowhidden[r] = 0;
                            }
                        }
                        else{
                            rowhidden[r] = 0;
                        }
                    }
                    else if (value == "equal") { //等于
                        var value1 = parseFloat(caljs["value1"]);

                        if(cell == null || jfgrid.func_methods.isRealNull(cell.v)){
                            rowhidden[r] = 0;
                        }
                        else if(cell.ct != null && cell.ct.t == "n"){
                            if(cell.v != value1){
                                rowhidden[r] = 0;
                            }
                        }
                        else{
                            rowhidden[r] = 0;
                        }
                    }
                    else if (value == "noequal") { //不等于
                        var value1 = parseFloat(caljs["value1"]);

                        if(cell == null || jfgrid.func_methods.isRealNull(cell.v)){
                            rowhidden[r] = 0;
                        }
                        else if(cell.ct != null && cell.ct.t == "n"){
                            if(cell.v == value1){
                                rowhidden[r] = 0;
                            }
                        }
                        else{
                            rowhidden[r] = 0;
                        }
                    }
                    else if (value == "include") { //介于
                        var value1 = parseFloat(caljs["value1"]), value2 = parseFloat(caljs["value2"]);

                        if(value1 < value2){
                            var min = value1;
                            var max = value2;
                        }
                        else{
                            var max = value1;
                            var min = value2;   
                        }

                        if(cell == null || jfgrid.func_methods.isRealNull(cell.v)){
                            rowhidden[r] = 0;
                        }
                        else if(cell.ct != null && cell.ct.t == "n"){
                            if(cell.v < min || cell.v > max){
                                rowhidden[r] = 0;
                            }
                        }
                        else{
                            rowhidden[r] = 0;
                        }
                    }
                    else if (value == "noinclude") { //不在其中
                        var value1 = parseFloat(caljs["value1"]), value2 = parseFloat(caljs["value2"]);

                        if(value1 < value2){
                            var min = value1;
                            var max = value2;
                        }
                        else{
                            var max = value1;
                            var min = value2;   
                        }

                        if(cell == null || jfgrid.func_methods.isRealNull(cell.v)){
                            rowhidden[r] = 0;
                        }
                        else if(cell.ct != null && cell.ct.t == "n"){
                            if(cell.v >= min && cell.v <= max){
                                rowhidden[r] = 0;
                            }
                        }
                        else{
                            rowhidden[r] = 0;
                        }
                    }
                }
            }
            else {
                $("#jfgrid-filter-byvalue-select .ListBox input[type='checkbox']").each(function(i, e){
                    if($(e).is(":visible") && $(e).is(":checked")){
                        return true;
                    }

                    if($(e).closest(".day").length > 0){
                        var day = $(e).siblings("label").text();
                        if(Number(day) < 10){
                            day = "0" + Number(day);
                        }

                        var month = $(e).closest(".monthBox").find(".month label").text().replace("月", "");
                        if(Number(month) < 10){
                            month = "0" + Number(month);
                        }

                        var year = $(e).closest(".yearBox").find(".year label").text().replace("年", "");

                        var itemV = "日期格式#$$$#" + year + "-" + month + "-" + day;

                        filterdata[itemV] = "1";
                    }

                    if($(e).closest(".textBox").length > 0){
                        var itemV = $(e).closest(".textBox").data("filter");

                        filterdata[itemV] = "1";
                    }
                });
                
                for (var r = st_r + 1; r <= ed_r; r++) {
                    if(r in rowhiddenother){
                        continue;
                    }

                    if(jfgrid.flowdata[r] == null){
                        continue;
                    }

                    var cell = jfgrid.flowdata[r][cindex];

                    if(cell == null || jfgrid.func_methods.isRealNull(cell.v)){
                        var value = "null#$$$#null";
                    }
                    else if(cell.ct != null && cell.ct.t == "d"){
                        var fmt = jfgrid.mask.update("YYYY-MM-DD", cell.v);
                        var value = "日期格式#$$$#" + fmt;
                    }
                    else{
                        var value = cell.v + "#$$$#" + cell.m;
                    }

                    if(value in filterdata){
                        rowhidden[r] = 0;
                    }
                }
            }

            var $top = $("#jfgrid-filter-options-sheet" + jfgrid.currentSheetIndex + " .jfgrid-filter-options").eq(cindex - st_c);

            var optionstate = $("#jfgrid-filter-byvalue-select .ListBox input[type='checkbox']:visible:checked").length < $("#jfgrid-filter-byvalue-select .ListBox input[type='checkbox']:visible").length || $("#jfgrid-filter-byvalue-input").val().length > 0 || ($("#jfgrid-filter-bycondition").next().is(":visible") && $("#jfgrid-filter-byvalue").next().is(":hidden") && $("#jfgrid-filter-selected span").data("value") != "null");

            var rowhiddenall = $.extend(true, rowhiddenother, rowhidden), 
                rowhidenPre = jfgrid.json.parseJsonParm($top.data("rowhidden"));

            jfgrid.labelFilterOptionState($top, optionstate, rowhidden, caljs, true, st_r, ed_r, cindex, st_c, ed_c);

            var cfg = $.extend(true, {}, config);
            cfg["rowhidden"] = rowhiddenall;

            //保存撤销
            if(clearjfundo){
                var redo = {};
                redo["type"] = "datachangeAll_filter";
                redo["sheetIndex"] = jfgrid.currentSheetIndex;

                redo["config"] = $.extend(true, {}, config);
                redo["curconfig"] = cfg;

                redo["optionstate"] = optionstate;
                redo["optionsindex"] = cindex - st_c;

                redo["rowhidden"] = $.extend(true, {}, rowhidden);
                redo["rowhidenPre"] = $.extend(true, {}, rowhidenPre);

                if (caljs != null) {
                    redo["caljs"] = caljs;
                }

                jfgrid.jfundo = [];
                jfgrid.jfredo.push(redo);
            }

            //config
            config = cfg;
            jfgridfile[jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex)].config = config;

            jfgrid.server.saveParam("cg", jfgrid.currentSheetIndex, cfg["rowhidden"], { "k": "rowhidden" });

            //行高、列宽 刷新  
            jfgrid.jfrefreshgrid_rhcw(jfgrid.flowdata.length, jfgrid.flowdata[0].length);

            // jfgrid.filterseletedbyindex(st_r, ed_r, st_c, ed_c);
            $("#jfgrid-filter-menu, #jfgrid-filter-submenu").hide();
            jfgrid.cleargridelement();
        });

        jfgrid.json = {
            parseJsonParm: function(obj){
                if(obj == null){
                    return {};
                }
                else if(jfgrid.getObjType(obj) == "string"){
                    try {
                        var json = eval('('+ obj +')');
                        return json;
                    } 
                    catch(e) {
                        return {};
                    }
                }
                else{
                    return obj;
                }
            },
            hasKey: function(obj){
                var _this = this;
                var json = _this.parseJsonParm(obj);
                
                for(var item in json){
                    return true;
                }

                return false;
            }
        }
		
        jfgrid.labelFilterOptionState = function($top, optionstate, rowhidden, caljs, notSave, str, edr, cindex, stc, edc){
            if (optionstate) {
                $top.addClass("jfgrid-filter-options-active").data("rowhidden", JSON.stringify(rowhidden)).data("caljs", JSON.stringify(caljs)).html('<i class="fa fa-filter jfgrid-mousedown-cancel" aria-hidden="true"></i>');

                if (caljs != null) {
                    $top.data("byconditionvalue", caljs["value"]).data("byconditiontype", caljs["type"]).data("byconditiontext", caljs["text"]);
                    
                    if (caljs["value1"] != null) {
                        $top.data("byconditionvalue1", caljs["value1"]);
                    }

                    if (caljs["value2"] != null) {
                        $top.data("byconditionvalue2", caljs["value2"]);
                    }
                }
            }
            else {
                $top.removeClass("jfgrid-filter-options-active").data("rowhidden", "").data("caljs", "").html('<i class="fa fa-caret-down jfgrid-mousedown-cancel" aria-hidden="true"></i>');

                $top.data("byconditionvalue", "null").data("byconditiontype", "0").data("byconditiontext", "无").data("byconditionvalue1", "").data("byconditionvalue2", "");
            }

            if(!!notSave){
                var file = jfgridfile[jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex)];

                if(file.filter == null){
                    file.filter = {};
                }

                if (optionstate) {
                    var param = {
                        "caljs": caljs, 
                        "rowhidden": rowhidden, 
                        "optionstate": optionstate,
                        "str": str,
                        "edr": edr,
                        "cindex": cindex,
                        "stc": stc,
                        "edc": edc
                    };

                    // jfgrid.server.saveParam("f", jfgrid.currentSheetIndex, param, { "op": "upOrAdd", "pos": cindex - stc });

                    file.filter[cindex - stc] = param;
                }
                else {
                    // jfgrid.server.saveParam("f", jfgrid.currentSheetIndex, null, { "op": "del", "pos": cindex - stc });

                    delete file.filter[cindex - stc];
                    // file.filter[cindex - stc] = null;
                }

                jfgrid.server.saveParam("all", jfgrid.currentSheetIndex, file.filter, { "k": "filter" });
            }
        }

        $("#jfgrid-filter-selected").click(function () {
            var $t = $(this), toffset = $t.offset(), $menu = $("#jfgrid-filter-submenu");
            $menu.hide();

            var winH = $(window).height(), winW = $(window).width();
            var menuW = $menu.width(), menuH = $menu.height();
            var top = toffset.top, left = toffset.left, mheight = winH - toffset.top - 20;
            
            if (toffset.left + menuW > winW) {
                left = toffset.left - menuW;
            }

            if (toffset.top > winH / 2) {
                top = winH - toffset.top;
                
                if (top < 0) {
                    top = 0;
                }

                mheight = toffset.top - 20;
            }

            $menu.css({ "top": top, "left": left, "height": mheight }).show();
            clearTimeout(hidefilersubmenu);
        });

        var orderbydatafiler = function (str, stc, edr, edc, index, asc) {
            var d = jfgrid.editor.deepCopyFlowData(jfgrid.flowdata);

            str = str + 1;

            var hasMc = false; //排序选区是否有合并单元格
            var data = [];

            for(var r = str; r <= edr; r++){
                var data_row = [];

                for(var c = stc; c <= edc; c++){
                    if(d[r][c] != null && d[r][c].mc != null){
                        hasMc = true;
                        break;
                    }

                    data_row.push(d[r][c]);
                }

                data.push(data_row);
            }

            if(hasMc){
                if(jfgrid.isEditMode()){
                    alert("筛选选区有合并单元格，无法执行此操作！");
                }
                else{
                    jfgrid.tooltip.info("筛选选区有合并单元格，无法执行此操作！", "");
                }

                return;
            }

            data = jfgrid.orderbydata(data, index - stc, asc);

            for(var r = str; r <= edr; r++){
                for(var c = stc; c <= edc; c++){
                    d[r][c] = data[r - str][c - stc];
                }
            }

            if(config["rowlen"] != null){
                var cfg = $.extend(true, {}, config);
                cfg = jfgrid.rowlenByRange(d, str, edr, cfg);

                jfgrid.jfrefreshgrid(d, [{ "row": [str, edr], "column": [stc, edc] }], cfg, null, true);
            }
            else{
                jfgrid.jfrefreshgrid(d, [{ "row": [str, edr], "column": [stc, edc] }]);
            }
        }

        //创建筛选按钮
        jfgrid.createFilter = function () {
            if(jfgird_select_save.length > 1){
                $("#jfgrid-rightclick-menu").hide();
                $("#jfgrid-filter-menu, #jfgrid-filter-submenu").hide();
                $("#" + container).attr("tabindex", 0).focus();

                if(jfgrid.isEditMode()){
                    alert("不能对多重选择区域执行此操作，请选择单个区域，然后再试");
                }
                else{
                    jfgrid.tooltip.info("不能对多重选择区域执行此操作，请选择单个区域，然后再试", "");
                }

                return;
            }

            if(jfgridfile[jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex)].isPivotTable){
                return;
            }

            $('#jfgrid-filter-selected-sheet' + jfgrid.currentSheetIndex + ', #jfgrid-filter-options-sheet' + jfgrid.currentSheetIndex).remove();

            var last = jfgird_select_save[0];
            if (last["row"][0] == last["row"][1] && last["column"][0] == last["column"][1]) {
                var st_c, ed_c, curR = last["row"][1];

                for (var c = 0; c < jfgrid.flowdata[curR].length; c++) {
                    var cell = jfgrid.flowdata[curR][c];

                    if (cell != null && !jfgrid.func_methods.isRealNull(cell.v)) {
                        if (st_c == null) {
                            st_c = c;
                        }
                    }
                    else if (st_c != null) {
                        ed_c = c - 1;
                        break;
                    }
                }

                if (ed_c == null) {
                    ed_c = jfgrid.flowdata[curR].length - 1;
                }

                jfgird_select_save = [{ "row": [curR, curR], "column": [st_c, ed_c] }];
                jfgrid.selectHightlightShow();

                jfgrid.jfgrid_shiftpositon = $.extend(true, {}, last);
                jfgridMoveEndCell("down", "range");
            }
            else if (last["row"][1] - last["row"][0] < 2) {
                jfgrid.jfgrid_shiftpositon = $.extend(true, {}, last);
                jfgridMoveEndCell("down", "range");
            }

            jfgird_filter_save = $.extend(true, {}, jfgird_select_save[0]);

            jfgrid.createFilterOptions(jfgird_filter_save);

            jfgrid.server.saveParam("all", jfgrid.currentSheetIndex, jfgird_filter_save, { "k": "filter_select" });

            if (filterchage) {
                jfgrid.jfredo.push({ 
                    "type": "filtershow", 
                    "data": [], 
                    "curdata": [], 
                    "sheetIndex": jfgrid.currentSheetIndex, 
                    "filter_save": jfgird_filter_save 
                });
            }
        }

        jfgrid.createFilterOptions = function(jfgird_filter_save, filterObj){
            $("#jfgrid-filter-selected-sheet" + jfgrid.currentSheetIndex).remove();
            $("#jfgrid-filter-options-sheet" + jfgrid.currentSheetIndex).remove();
            
            if(jfgird_filter_save == null || JSON.stringify(jfgird_filter_save) == "{}"){
                return;
            }

            var r1 = jfgird_filter_save.row[0], r2 = jfgird_filter_save.row[1];
            var c1 = jfgird_filter_save.column[0], c2 = jfgird_filter_save.column[1];

            var row = visibledatarow[r2], row_pre = r1 - 1 == -1 ? 0 : visibledatarow[r1 - 1];
            var col = visibledatacolumn[c2], col_pre = c1 - 1 == -1 ? 0 : visibledatacolumn[c1 - 1];
            
            var newSelectedHTML = '<div id="jfgrid-filter-selected-sheet'+ jfgrid.currentSheetIndex +'" class="jfgrid-cell-selected jfgrid-filter-selected"  style="left:'+ col_pre +'px;width:'+ (col - col_pre - 1) +'px;top:'+ row_pre +'px;height:'+ (row - row_pre - 1) +'px;display:block;border-color:#897BFF;z-index:20;background:none;"></div>';
            $("#jfgrid-cell-main").append(newSelectedHTML);
            
            var optionHTML = "";

            for (var c = c1; c <= c2; c++) {
                if(filterObj == null || filterObj[c - c1] == null){
                    optionHTML += '<div data-rowhidden="" data-str="'+ r1 +'" data-edr="'+ r2 +'" data-cindex="'+ c +'" data-stc="'+ c1 +'" data-edc="'+ c2 +'" class="jfgrid-filter-options" style="left:'+ (visibledatacolumn[c] - 20) +'px;top:'+ row_pre +'px;display:block;"><i class="fa fa-caret-down" aria-hidden="true"></i></div>';
                }
                else{
                    if(filterObj[c - c1].caljs != null){
                        if (filterObj[c - c1].caljs["value1"] != null) {
                            var caljs_value1_data = 'data-byconditionvalue1="'+ filterObj[c - c1].caljs["value1"] +'" ';
                        }
                        else{
                            var caljs_value1_data = '';
                        }

                        if (filterObj[c - c1].caljs["value2"] != null) {
                            var caljs_value2_data = 'data-byconditionvalue2="'+ filterObj[c - c1].caljs["value2"] +'" ';
                        }
                        else{
                            var caljs_value2_data = '';
                        }

                        var caljs_data = 'data-caljs="'+ JSON.stringify(filterObj[c - c1].caljs) +'" ' +
                                         'data-byconditionvalue="'+ filterObj[c - c1].caljs["value"] +'" ' + 
                                         'data-byconditiontype="'+ filterObj[c - c1].caljs["type"] +'" ' +
                                         'data-byconditiontext="'+ filterObj[c - c1].caljs["text"] +'" ' +
                                         caljs_value1_data + caljs_value2_data;
                    }
                    else{
                        var caljs_data = '';
                    }

                    optionHTML += '<div data-rowhidden="'+ JSON.stringify(filterObj[c - c1].rowhidden).replace(/\"/g, "'") +'" '+ caljs_data +' data-str="'+ r1 +'" data-edr="'+ r2 +'" data-cindex="'+ c +'" data-stc="'+ c1 +'" data-edc="'+ c2 +'" class="jfgrid-filter-options jfgrid-filter-options-active" style="left:'+ (visibledatacolumn[c] - 20) +'px;top:'+ row_pre +'px;display:block;"><i class="fa fa-filter jfgrid-mousedown-cancel" aria-hidden="true"></i></div>';
                }
            }

            $("#jfgrid-cell-main").append('<div id="jfgrid-filter-options-sheet'+ jfgrid.currentSheetIndex +'" class="jfgrid-filter-options-c">' + optionHTML + '</div>');
            $("#jfgrid-rightclick-menu").hide();
            $("#jfgrid-filter-menu, #jfgrid-filter-submenu").hide();

            if ($("#jfgrid-cell-main").scrollTop() > jfgird_filter_save["top_move"]) {
                $("#jfgrid-scrollbar-y").scrollTop(jfgird_filter_save["top_move"]);
            }

            var file = jfgridfile[jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex)];

            file.filter_select = jfgird_filter_save;
        }

        $("#jfgridfilter").click(jfgrid.createFilter);

        //按颜色筛选
        var submenuhide = null;
        $("#jfgrid-filter-orderby-color").hover(
            function(){
                //遍历筛选列颜色
                var $menu = $("#jfgrid-filter-menu");
                var st_r = $menu.data("str"), 
                    ed_r = $menu.data("edr"), 
                    cindex = $menu.data("cindex"), 
                    st_c = $menu.data("stc"), 
                    ed_c = $menu.data("edc");
                var bgMap = {}; //单元格颜色
                var fcMap = {}; //字体颜色

                var af_compute = jfgrid.alternateformat.getComputeMap();
                var cf_compute = jfgrid.conditionformat.getComputeMap();

                for (var r = st_r + 1; r <= ed_r; r++) {
                    var cell = jfgrid.flowdata[r][cindex];

                    //单元格颜色
                    var bg = jfgrid.menuButton.checkstatus(jfgrid.flowdata, r, cindex , "bg");

                    var checksAF = jfgrid.alternateformat.checksAF(r, cindex, af_compute);
                    if(checksAF != null){//若单元格有交替颜色
                        bg = checksAF[1];
                    }

                    var checksCF = jfgrid.conditionformat.checksCF(r, cindex, cf_compute);
                    if(checksCF != null && checksCF["cellColor"] != null){//若单元格有条件格式
                        bg = checksCF["cellColor"];
                    }

                    if(bg.indexOf("rgb") > -1){
                        bg = jfgrid.rgbTohex(bg);
                    }

                    if(bg.length == 4){
                        bg = bg.substr(0, 1) + bg.substr(1, 1).repeat(2) + bg.substr(2, 1).repeat(2) + bg.substr(3, 1).repeat(2);
                    }

                    //字体颜色
                    var fc = jfgrid.menuButton.checkstatus(jfgrid.flowdata, r, cindex , "fc");
                    
                    if(checksAF != null){//若单元格有交替颜色
                        fc = checksAF[0];
                    }

                    if(checksCF != null && checksCF["textColor"] != null){//若单元格有条件格式
                        fc = checksCF["textColor"];
                    }

                    if(fc.indexOf("rgb") > -1){
                        fc = jfgrid.rgbTohex(fc);
                    }

                    if(fc.length == 4){
                        fc = fc.substr(0, 1) + fc.substr(1, 1).repeat(2) + fc.substr(2, 1).repeat(2) + fc.substr(3, 1).repeat(2);
                    }

                    if(config != null && config["rowhidden"] != null && r in config["rowhidden"]){
                        bgMap[bg] = 1;

                        if(cell != null && !jfgrid.func_methods.isRealNull(cell.v)){
                            fcMap[fc] = 1;
                        }
                    }
                    else{
                        bgMap[bg] = 0;

                        if(cell != null && !jfgrid.func_methods.isRealNull(cell.v)){
                            fcMap[fc] = 0;
                        }
                    }
                }
                //
                var filterBgColorHtml = '';
                if(JSON.stringify(bgMap).length > 2 && Object.keys(bgMap).length > 1){
                    var bgColorItemHtml = '';
                    for(b in bgMap){
                        if(bgMap[b] == 0){
                            bgColorItemHtml += '<div class="item jfgrid-mousedown-cancel"><label class="jfgrid-mousedown-cancel" style="background-color: ' + b + '" title="' + b + '"></label><input class="jfgrid-mousedown-cancel" type="checkbox" checked="checked"/></div>';
                        }
                        else{
                            bgColorItemHtml += '<div class="item jfgrid-mousedown-cancel"><label class="jfgrid-mousedown-cancel" style="background-color: ' + b + '" title="' + b + '"></label><input class="jfgrid-mousedown-cancel" type="checkbox"/></div>';
                        }
                    }
                    filterBgColorHtml = '<div id="filterBgColor" class="box jfgrid-mousedown-cancel"><div class="title jfgrid-mousedown-cancel">按单元格颜色筛选</div><div style="max-height:128px;overflow:auto;" class="jfgrid-mousedown-cancel">' + bgColorItemHtml + '</div></div>';
                }

                var filterFcColorHtml = '';
                if(JSON.stringify(fcMap).length > 2 && Object.keys(fcMap).length > 1){
                    var fcColorItemHtml = '';
                    for(f in fcMap){
                        if(fcMap[f] == 0){
                            fcColorItemHtml += '<div class="item jfgrid-mousedown-cancel"><label class="jfgrid-mousedown-cancel" style="background-color: ' + f + '" title="' + f + '"></label><input class="jfgrid-mousedown-cancel" type="checkbox" checked="checked"/></div>';
                        }
                        else{
                            fcColorItemHtml += '<div class="item jfgrid-mousedown-cancel"><label class="jfgrid-mousedown-cancel" style="background-color: ' + f + '" title="' + f + '"></label><input class="jfgrid-mousedown-cancel" type="checkbox"/></div>';
                        }
                    }
                    filterFcColorHtml = '<div id="filterFcColor" class="box jfgrid-mousedown-cancel"><div class="title jfgrid-mousedown-cancel">按字体颜色筛选</div><div style="max-height:128px;overflow:auto;" class="jfgrid-mousedown-cancel">' + fcColorItemHtml + '</div></div>';
                }
                //
                if(filterBgColorHtml == '' && filterFcColorHtml == ''){
                    var content = '<div class="jfgrid-mousedown-cancel" style="padding: 10px 30px;text-align: center;">本列仅包含一种颜色</div>';
                }
                else{
                    var content = filterBgColorHtml + filterFcColorHtml + '<div class="jfgrid-mousedown-cancel"><button id="jfgrid-filter-orderby-color-confirm" class="btn btn-primary jfgrid-mousedown-cancel" style="margin: 5px 20px;width: 70px;">确认</button></div>';
                }
                //颜色筛选子菜单
                $("#jfgrid-filter-orderby-color-submenu").remove();
                $("body").append('<div id="jfgrid-filter-orderby-color-submenu" class="jfgrid-cols-menu jfgrid-mousedown-cancel">'+content+'</div>');
                var $t = $("#jfgrid-filter-orderby-color-submenu").end(), myh = $t.outerHeight(), myw = $t.outerWidth();
                var $con = $(this).parent();
                var winW = $(window).width(), winH = $(window).height();
                var menuW = $con.width(), myh = $t.height() + 25, myw = $t.width() + 5;
                var offset = $(this).offset();
                var top = offset.top, left = offset.left + menuW;

                if (left + myw > winW) {
                    left = offset.left - myw;
                }

                if (top + myh > winH) {
                    top = winH - myh;
                }

                $("#jfgrid-filter-orderby-color-submenu").css({ "top": top, "left": left }).show();
            },
            function(){
                submenuhide = setTimeout(function () { $("#jfgrid-filter-orderby-color-submenu").hide(); }, 200);
            }
        );
        $(document).on("mouseover mouseleave", "#jfgrid-filter-orderby-color-submenu", function(e){
            if (e.type === "mouseover") {
                clearTimeout(submenuhide);
            } 
            else {
                $(this).hide();
            }
        });
        $(document).on("click", "#jfgrid-filter-orderby-color-submenu .item label", function(){
            $(this).siblings("input[type='checkbox']").click();
        });
        $(document).off("click.orderbyColorConfirm").on("click.orderbyColorConfirm", "#jfgrid-filter-orderby-color-submenu #jfgrid-filter-orderby-color-confirm", function(){
            var bg_colorMap = {};
            var fc_colorMap = {};
            
            $("#jfgrid-filter-orderby-color-submenu .item").each(function(i, e){
                if($(e).find("input[type='checkbox']").is(":checked")){
                    var color = $(this).find("label").attr("title");
                    var $id = $(this).closest(".box").attr("id");

                    if($id == "filterBgColor"){
                        bg_colorMap[color] = 0;
                    }
                    else if($id == "filterFcColor"){
                        fc_colorMap[color] = 0;
                    }
                }
            });

            if($("#jfgrid-filter-orderby-color-submenu #filterBgColor").length > 0){
                var bg_filter = true;
            }
            else{
                var bg_filter = false;
            }

            if($("#jfgrid-filter-orderby-color-submenu #filterFcColor").length > 0){
                var fc_filter = true;
            }
            else{
                var fc_filter = false;
            }

            var $menu = $("#jfgrid-filter-menu");
            var st_r = $menu.data("str"), 
                ed_r = $menu.data("edr"), 
                cindex = $menu.data("cindex"), 
                st_c = $menu.data("stc"), 
                ed_c = $menu.data("edc");

            var rowhiddenother = {}; //其它筛选列的隐藏行
            $("#jfgrid-filter-options-sheet" + jfgrid.currentSheetIndex + " .jfgrid-filter-options").not($("#jfgrid-filter-options-sheet" + jfgrid.currentSheetIndex + " .jfgrid-filter-options").eq(cindex - st_c).get(0)).each(function () {
                var $t = $(this), rh = $t.data("rowhidden");

                if (rh == "") {
                    return true;
                }

                rh = JSON.parse(rh);
                
                for (var r in rh) {
                    rowhiddenother[r] = 0;
                }
            });

            var filterdata = {};
            var rowhidden = {};
            var caljs = {};

            var af_compute = jfgrid.alternateformat.getComputeMap();
            var cf_compute = jfgrid.conditionformat.getComputeMap();

            for (var r = st_r + 1; r <= ed_r; r++) {
                if(r in rowhiddenother){
                    continue;
                }

                if(jfgrid.flowdata[r] == null){
                    continue;
                }

                var cell = jfgrid.flowdata[r][cindex];

                //单元格颜色
                var bg = jfgrid.menuButton.checkstatus(jfgrid.flowdata, r, cindex , "bg");

                var checksAF = jfgrid.alternateformat.checksAF(r, cindex, af_compute);
                if(checksAF != null){//若单元格有交替颜色
                    bg = checksAF[1];
                }

                var checksCF = jfgrid.conditionformat.checksCF(r, cindex, cf_compute);
                if(checksCF != null && checksCF["cellColor"] != null){//若单元格有条件格式
                    bg = checksCF["cellColor"];
                }

                if(bg.indexOf("rgb") > -1){
                    bg = jfgrid.rgbTohex(bg);
                }

                if(bg.length == 4){
                    bg = bg.substr(0, 1) + bg.substr(1, 1).repeat(2) + bg.substr(2, 1).repeat(2) + bg.substr(3, 1).repeat(2);
                }

                //文本颜色
                var fc = jfgrid.menuButton.checkstatus(jfgrid.flowdata, r, cindex , "fc");

                if(checksAF != null){//若单元格有交替颜色
                    fc = checksAF[0];
                }

                if(checksCF != null && checksCF["textColor"] != null){//若单元格有条件格式
                    fc = checksCF["textColor"];
                }

                if(fc.indexOf("rgb") > -1){
                    fc = jfgrid.rgbTohex(fc);
                }

                if(fc.length == 4){
                    fc = fc.substr(0, 1) + fc.substr(1, 1).repeat(2) + fc.substr(2, 1).repeat(2) + fc.substr(3, 1).repeat(2);
                }

                if(bg_filter && fc_filter){
                    if(!(bg in bg_colorMap) && (!(fc in fc_colorMap) || cell == null || jfgrid.func_methods.isRealNull(cell.v))){
                        rowhidden[r] = 0;
                    }
                }
                else if(bg_filter){
                    if(!(bg in bg_colorMap)){
                        rowhidden[r] = 0;
                    }
                }
                else if(fc_filter){
                    if(!(fc in fc_colorMap) || cell == null || jfgrid.func_methods.isRealNull(cell.v)){
                        rowhidden[r] = 0;
                    }
                }
            }

            var $top = $("#jfgrid-filter-options-sheet" + jfgrid.currentSheetIndex + " .jfgrid-filter-options").eq(cindex - st_c);

            var optionstate = Object.keys(rowhidden).length > 0;

            var rowhiddenall = $.extend(true, rowhiddenother, rowhidden), 
                rowhidenPre = jfgrid.json.parseJsonParm($top.data("rowhidden"));

            jfgrid.labelFilterOptionState($top, optionstate, rowhidden, caljs, true, st_r, ed_r, cindex, st_c, ed_c);

            var cfg = $.extend(true, {}, config);
            cfg["rowhidden"] = rowhiddenall;

            //保存撤销
            if(clearjfundo){
                var redo = {};
                redo["type"] = "datachangeAll_filter";
                redo["sheetIndex"] = jfgrid.currentSheetIndex;

                redo["config"] = $.extend(true, {}, config);
                redo["curconfig"] = cfg;

                redo["optionstate"] = optionstate;
                redo["optionsindex"] = cindex - st_c;

                redo["rowhidden"] = $.extend(true, {}, rowhidden);
                redo["rowhidenPre"] = $.extend(true, {}, rowhidenPre);

                if (caljs != null) {
                    redo["caljs"] = caljs;
                }

                jfgrid.jfundo = [];
                jfgrid.jfredo.push(redo);
            }

            //config
            config = cfg;
            jfgridfile[jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex)].config = config;

            jfgrid.server.saveParam("cg", jfgrid.currentSheetIndex, cfg["rowhidden"], { "k": "rowhidden" });

            //行高、列宽 刷新  
            jfgrid.jfrefreshgrid_rhcw(jfgrid.flowdata.length, jfgrid.flowdata[0].length);

            // jfgrid.filterseletedbyindex(st_r, ed_r, st_c, ed_c);
            $("#jfgrid-filter-menu, #jfgrid-filter-submenu, #jfgrid-filter-orderby-color-submenu").hide();
            jfgrid.cleargridelement();
        });

        //筛选按钮点击事件
        $("#jfgrid-cell-main").on("click", ".jfgrid-filter-options", function (e) {
            var $t = $(e.currentTarget), 
                toffset = $t.offset(), 
                $menu = $("#jfgrid-filter-menu"), 
                winH = $(window).height(), 
                winW = $(window).width();

            var st_r = $t.data("str"), 
                ed_r = $t.data("edr"), 
                cindex = $t.data("cindex"), 
                st_c = $t.data("stc"), 
                ed_c = $t.data("edc"), 
                rowhidden = $t.data("rowhidden") == "" ? {} : JSON.parse($t.data("rowhidden").replace(/\'/g, '"'));

            $("body .jfgrid-cols-menu").hide();
            $("#jfgrid-filter-menu, #jfgrid-filter-submenu").hide();
            $("#jfgrid-filter-byvalue-input").val("");
            $("#jfgrid-filter-bycondition").next().hide();
            $("#jfgrid-filter-byvalue").next().show();
            
            $menu.data("str", st_r);
            $menu.data("edr", ed_r);
            $menu.data("cindex", cindex);
            $menu.data("stc", st_c);
            $menu.data("edc", ed_c);

            $("#jfgrid-filter-menu .jfgrid-filter-selected-input").hide().find("input").val();
            $("#jfgrid-filter-selected span").data("type", "0").data("type", null).text("无");

            var byconditiontype = $t.data("byconditiontype");
            $("#jfgrid-filter-selected span").data("value", $t.data("byconditionvalue")).data("type", byconditiontype).text($t.data("byconditiontext"));

            if (byconditiontype == "2") {
                var $input = $("#jfgrid-filter-menu .jfgrid-filter-selected-input2").show().find("input");
                $input.eq(0).val($t.data("byconditionvalue1"));
                $input.eq(1).val($t.data("byconditionvalue2"));
            }
            else if (byconditiontype == "1") {
                $("#jfgrid-filter-menu .jfgrid-filter-selected-input").eq(0).show().find("input").val($t.data("byconditionvalue1"));
            }

            $("#jfgrid-filter-orderby-asc").off("click").on("click", function () {
                orderbydatafiler(st_r, st_c, ed_r, ed_c, cindex, true);
            });

            $("#jfgrid-filter-orderby-desc").off("click").on("click", function () {
                orderbydatafiler(st_r, st_c, ed_r, ed_c, cindex, false);
            });

            $("#jfgrid-filter-byvalue-select").empty().html('<div style="width:100%;text-align:center;position:relative;top:45%;font-size:14px;"><div class="jfgridLoaderGif"></div><span>数据量大！请稍后</span></div>');

            var rowhiddenother = {}; //其它筛选列的隐藏行
            $("#jfgrid-filter-options-sheet" + jfgrid.currentSheetIndex + " .jfgrid-filter-options").not(this).each(function () {
                var $t = $(this), rh = $t.data("rowhidden");
                
                if (rh == "") {
                    return true;
                }

                rh = JSON.parse(rh.replace(/\'/g, '"'));
                
                for (var r in rh) {
                    rowhiddenother[r] = 0;
                }
            });

            var data = jfgrid.flowdata;

            setTimeout(function () {
                //日期值
                var dvmap = {};  
                var dvmap_uncheck = {};

                //除日期以外的值
                var vmap = {}; 
                var vmap_uncheck = {};  

                for (var r = st_r + 1; r <= ed_r; r++) {
                    if(r in rowhiddenother){
                        continue;
                    }

                    if(jfgrid.flowdata[r] == null){
                        continue;
                    }

                    var cell = jfgrid.flowdata[r][cindex];

                    if(cell != null && !jfgrid.func_methods.isRealNull(cell.v) && cell.ct != null && cell.ct.t == "d" ){ //单元格是日期
                        var v = jfgrid.mask.update("YYYY-MM-DD", cell.v);

                        var y = v.split("-")[0];
                        var m = v.split("-")[1];
                        var d = v.split("-")[2];

                        if(!(y in dvmap)){
                            dvmap[y] = {};
                        }

                        if(!(m in dvmap[y])){
                            dvmap[y][m] = {};
                        }

                        if(!(d in dvmap[y][m])){
                            dvmap[y][m][d] = 0;
                        }
                        
                        dvmap[y][m][d]++;

                        if(r in rowhidden){
                            dvmap_uncheck[y] = 0;
                            dvmap_uncheck[m] = 0;
                            dvmap_uncheck[d] = 0;
                        }
                    }
                    else{
                        if(cell == null || jfgrid.func_methods.isRealNull(cell.v)){
                            var v = null;
                            var m = null;
                        }
                        else{
                            var v = cell.v;
                            var m = cell.m;
                        }

                        if(!(v in vmap)){
                            vmap[v] = {};
                        }

                        if(!(m in vmap[v])){
                            vmap[v][m] = 0;                            
                        }

                        vmap[v][m]++;

                        if(r in rowhidden){
                            vmap_uncheck[v + "#$$$#" + m] = 0;
                        }
                    }
                }

                //遍历数据加到页面
                var item = [];

                if(JSON.stringify(dvmap).length > 2){
                    for(y in dvmap){
                        var ysum = 0;
                        var monthHtml = '';

                        for(m in dvmap[y]){
                            var msum = 0;
                            var dayHtml = '';

                            for(d in dvmap[y][m]){
                                var dayL = dvmap[y][m][d];
                                msum += dayL;

                                //月 小于 10
                                if(Number(m) < 10){
                                    var mT = "0" + Number(m);
                                }
                                else{
                                    var mT = m;    
                                }

                                //日 小于 10
                                if(Number(d) < 10){
                                    var dT = "0" + Number(d);
                                }
                                else{
                                    var dT = d;    
                                }

                                //日是否选中状态
                                if((y in dvmap_uncheck) && (m in dvmap_uncheck) && (d in dvmap_uncheck)){
                                    dayHtml +=  '<div class="day jfgrid-mousedown-cancel cf" data-check="false" title="'+ y +'-'+ mT +'-'+ dT +'">' +
                                                    '<input class="jfgrid-mousedown-cancel" type="checkbox"/>' +
                                                    '<label class="jfgrid-mousedown-cancel">' + d + '</label>' +
                                                    '<span class="count jfgrid-mousedown-cancel">( ' + dayL + ' )</span>' +
                                                '</div>';
                                }
                                else{
                                    dayHtml +=  '<div class="day jfgrid-mousedown-cancel cf" data-check="true" title="'+ y +'-'+ mT +'-'+ dT +'">' +
                                                    '<input class="jfgrid-mousedown-cancel" type="checkbox" checked="checked"/>' +
                                                    '<label class="jfgrid-mousedown-cancel">' + d + '</label>' +
                                                    '<span class="count jfgrid-mousedown-cancel">( ' + dayL + ' )</span>' +
                                                '</div>';
                                }
                            }

                            ysum += msum;
                            
                            //月 小于 10
                            if(Number(m) < 10){
                                var mT2 = "0" + Number(m);
                            }
                            else{
                                var mT2 = m;    
                            }

                            //月是否选中状态
                            if((y in dvmap_uncheck) && (m in dvmap_uncheck)){
                                monthHtml += '<div class="monthBox jfgrid-mousedown-cancel">' +
                                                '<div class="month jfgrid-mousedown-cancel cf" data-check="false" title="'+ y +'-'+ mT2 +'">' +
                                                    '<i class="fa fa-caret-right jfgrid-mousedown-cancel" aria-hidden="true"></i>' +
                                                    '<input class="jfgrid-mousedown-cancel" type="checkbox"/>' +
                                                    '<label class="jfgrid-mousedown-cancel">' + m + '月</label>' +
                                                    '<span class="count jfgrid-mousedown-cancel">( ' + msum + ' )</span>' +
                                                '</div>' +
                                                '<div class="dayList jfgrid-mousedown-cancel">' + dayHtml + '</div>' +
                                             '</div>';
                            }
                            else{
                                monthHtml += '<div class="monthBox jfgrid-mousedown-cancel">' +
                                                '<div class="month jfgrid-mousedown-cancel cf" data-check="true" title="'+ y +'-'+ mT2 +'">' +
                                                    '<i class="fa fa-caret-right jfgrid-mousedown-cancel" aria-hidden="true"></i>' +
                                                    '<input class="jfgrid-mousedown-cancel" type="checkbox" checked="checked"/>' +
                                                    '<label class="jfgrid-mousedown-cancel">' + m + '月</label>' +
                                                    '<span class="count jfgrid-mousedown-cancel">( ' + msum + ' )</span>' +
                                                '</div>' +
                                                '<div class="dayList jfgrid-mousedown-cancel">' + dayHtml + '</div>' +
                                             '</div>';
                            }
                        }

                        //年是否选中状态
                        if(y in dvmap_uncheck){
                            var yearHtml =  '<div class="yearBox jfgrid-mousedown-cancel">' +
                                                '<div class="year jfgrid-mousedown-cancel cf" data-check="false" title="'+ y +'">' +
                                                    '<i class="fa fa-caret-right jfgrid-mousedown-cancel" aria-hidden="true"></i>' +
                                                    '<input class="jfgrid-mousedown-cancel" type="checkbox"/>' +
                                                    '<label class="jfgrid-mousedown-cancel">' + y + '年</label>' +
                                                    '<span class="count jfgrid-mousedown-cancel">( ' + ysum + ' )</span>' +
                                                '</div>' +
                                                '<div class="monthList jfgrid-mousedown-cancel">' + monthHtml + '</div>' +
                                            '</div>';
                        }
                        else{
                            var yearHtml =  '<div class="yearBox jfgrid-mousedown-cancel">' +
                                                '<div class="year jfgrid-mousedown-cancel cf" data-check="true" title="'+ y +'">' +
                                                    '<i class="fa fa-caret-right jfgrid-mousedown-cancel" aria-hidden="true"></i>' +
                                                    '<input class="jfgrid-mousedown-cancel" type="checkbox" checked="checked"/>' +
                                                    '<label class="jfgrid-mousedown-cancel">' + y + '年</label>' +
                                                    '<span class="count jfgrid-mousedown-cancel">( ' + ysum + ' )</span>' +
                                                '</div>' +
                                                '<div class="monthList jfgrid-mousedown-cancel">' + monthHtml + '</div>' +
                                            '</div>';
                        }

                        item.unshift(yearHtml);
                    }
                }

                if(JSON.stringify(vmap).length > 2){
                    var vmapKeys = Object.keys(vmap);
                    vmapKeys = jfgrid.orderbydata1D(vmapKeys, true);

                    for(var i = 0; i < vmapKeys.length; i++){
                        var v = vmapKeys[i];

                        for(x in vmap[v]){
                            if((v + "#$$$#" + x) == "null#$$$#null"){
                                var text = "(空白)";
                            }
                            else{
                                var text = x;
                            }

                            //是否选中状态
                            if((v + "#$$$#" + x) in vmap_uncheck){
                                var dataHtml =  '<div class="textBox jfgrid-mousedown-cancel cf" data-check="false" data-filter="'+ (v + "#$$$#" + x) +'" title="'+ text +'">' +
                                                    '<input class="jfgrid-mousedown-cancel" type="checkbox"/>' +
                                                    '<label class="jfgrid-mousedown-cancel">' + text + '</label>' +
                                                    '<span class="jfgrid-mousedown-cancel count">( ' + vmap[v][x] + ' )</span>' +
                                                '</div>';
                            }
                            else{
                                var dataHtml =  '<div class="textBox jfgrid-mousedown-cancel cf" data-check="true" data-filter="'+ (v + "#$$$#" + x) +'" title="'+ text +'">' +
                                                    '<input class="jfgrid-mousedown-cancel" type="checkbox" checked="checked"/>' +
                                                    '<label class="jfgrid-mousedown-cancel">' + text + '</label>' +
                                                    '<span class="jfgrid-mousedown-cancel count">( ' + vmap[v][x] + ' )</span>' +
                                                '</div>';
                            }

                            item.push(dataHtml);
                        }
                    }
                }

                $("#jfgrid-filter-byvalue-select").html("<div class='ListBox jfgrid-mousedown-cancel' style='min-height: 100px; max-height: " + (winH - toffset.top - 350) + "px; overflow-y: auto; overflow-x: hidden;'><table cellspacing='0' style='width:100%;' class='jfgrid-mousedown-cancel'>" + item.join("") + "</table></div>");
            }, 1);

            showrightclickmenu($menu, toffset.left, toffset.top + 20);

            e.stopPropagation();
            return false;
        });

        //点击复选框
        $(document).off("click.filterCheckbox1").on("click.filterCheckbox1", "#jfgrid-filter-byvalue-select .textBox",function(){
            if($(this).attr("data-check") == "true"){
                $(this).attr("data-check", "false");
                $(this).find("input[type='checkbox']").removeAttr("checked");
            }
            else{
                $(this).attr("data-check", "true");
                $(this).find("input[type='checkbox']").prop("checked", true);
            }
        })
        $(document).off("click.filterCheckbox2").on("click.filterCheckbox2", "#jfgrid-filter-byvalue-select .year",function(){
            if($(this).attr("data-check") == "true"){
                $(this).attr("data-check", "false");
                $(this).parents(".yearBox").find(".month").attr("data-check", "false");
                $(this).parents(".yearBox").find(".day").attr("data-check", "false");
                $(this).parents(".yearBox").find("input[type='checkbox']").removeAttr("checked");
            }
            else{
                $(this).attr("data-check", "true");
                $(this).parents(".yearBox").find(".month").attr("data-check", "true");
                $(this).parents(".yearBox").find(".day").attr("data-check", "true");
                $(this).parents(".yearBox").find("input[type='checkbox']").prop("checked", true);
            }
        })
        $(document).off("click.filterCheckbox3").on("click.filterCheckbox3", "#jfgrid-filter-byvalue-select .month",function(){
            //月份 对应的 天
            if($(this).attr("data-check") == "true"){
                $(this).attr("data-check", "false");
                $(this).parents(".monthBox").find(".day").attr("data-check", "false");
                $(this).parents(".monthBox").find("input[type='checkbox']").removeAttr("checked");
            }
            else{
                $(this).attr("data-check", "true");
                $(this).parents(".monthBox").find(".day").attr("data-check", "true");
                $(this).parents(".monthBox").find("input[type='checkbox']").prop("checked", true);
            }
            //月份 对应的 年份
            var yearDayAllCheck = true;
            var $yearDay = $(this).parents(".yearBox").find(".day");
            $yearDay.each(function(i,e){
                if($(e).attr("data-check") == "true"){
                    
                }
                else{
                    yearDayAllCheck = false;
                }
            });
            if(yearDayAllCheck){
                $(this).parents(".yearBox").find(".year").attr("data-check", "true");
                $(this).parents(".yearBox").find(".year input[type='checkbox']").prop("checked", true);
            }
            else{
                $(this).parents(".yearBox").find(".year").attr("data-check", "false");
                $(this).parents(".yearBox").find(".year input[type='checkbox']").removeAttr("checked");
            }
        })
        $(document).off("click.filterCheckbox4").on("click.filterCheckbox4", "#jfgrid-filter-byvalue-select .day",function(){
            if($(this).attr("data-check") == "true"){
                $(this).attr("data-check", "false");
                $(this).find("input[type='checkbox']").removeAttr("checked");
            }
            else{
                $(this).attr("data-check", "true");
                $(this).find("input[type='checkbox']").prop("checked", true);
            }
            //天 对应的 月份
            var monthDayAllCheck = true;
            var $monthDay = $(this).parents(".monthBox").find(".day");
            $monthDay.each(function(i,e){
                if($(e).attr("data-check") == "true"){
                    
                }
                else{
                    monthDayAllCheck = false;
                }
            });
            if(monthDayAllCheck){
                $(this).parents(".monthBox").find(".month").attr("data-check", "true");
                $(this).parents(".monthBox").find(".month input[type='checkbox']").prop("checked", true);
            }
            else{
                $(this).parents(".monthBox").find(".month").attr("data-check", "false");
                $(this).parents(".monthBox").find(".month input[type='checkbox']").removeAttr("checked");
            }
            //天 对应的 年份
            var yearDayAllCheck = true;
            var $yearDay = $(this).parents(".yearBox").find(".day");
            $yearDay.each(function(i,e){
                if($(e).attr("data-check") == "true"){
                    
                }
                else{
                    yearDayAllCheck = false;
                }
            });
            if(yearDayAllCheck){
                $(this).parents(".yearBox").find(".year").attr("data-check", "true");
                $(this).parents(".yearBox").find(".year input[type='checkbox']").prop("checked", true);
            }
            else{
                $(this).parents(".yearBox").find(".year").attr("data-check", "false");
                $(this).parents(".yearBox").find(".year input[type='checkbox']").removeAttr("checked");
            }
        })

        //日期 三级下拉显示
        $(document).off("click.filterYearDropdown").on("click.filterYearDropdown", "#jfgrid-filter-byvalue-select .yearBox .fa-caret-right",function(event){
            var $p = $(this).parents(".jfgrid-mousedown-cancel");
            if($p.hasClass("year")){
                $(this).parents(".yearBox").find(".monthList").slideToggle();
            }
            if($p.hasClass("month")){
                $(this).parents(".monthBox").find(".dayList").slideToggle();
            }

            event.stopPropagation();
        });

        //全选
        $("#jfgrid-filter-byvalue-btn-all").click(function () {
            $("#jfgrid-filter-byvalue-select .ListBox input[type='checkbox']").prop("checked", true);
            $("#jfgrid-filter-byvalue-select .ListBox input[type='checkbox']").parents(".jfgrid-mousedown-cancel").attr("data-check", "true");
        });

        //清除
        $("#jfgrid-filter-byvalue-btn-clear").click(function () {
            $("#jfgrid-filter-byvalue-select .ListBox input[type='checkbox']").removeAttr("checked");
            $("#jfgrid-filter-byvalue-select .ListBox input[type='checkbox']").parents(".jfgrid-mousedown-cancel").attr("data-check", "false");
        });

        //反选
        $("#jfgrid-filter-byvalue-btn-contra").click(function () {
            var $input = $("#jfgrid-filter-byvalue-select .ListBox input[type='checkbox']");
            $input.each(function(i, e){
                if($(e).is(":checked")){
                    $(e).removeAttr("checked");
                    $(e).parents(".jfgrid-mousedown-cancel").attr("data-check", "false");
                }
                else{
                    $(e).prop("checked", true);
                    $(e).parents(".jfgrid-mousedown-cancel").attr("data-check", "true");
                }
            });
            //天 对应的 月份
            var $month = $("#jfgrid-filter-byvalue-select .ListBox .monthBox");
            $month.each(function(index, event){
                var monthDayAllCheck = true;
                var $monthDay = $(event).find(".day input[type='checkbox']");
                $monthDay.each(function(i,e){
                    if($(e).is(":checked")){
                        
                    }
                    else{
                        monthDayAllCheck = false;
                    }
                });
                if(monthDayAllCheck){
                    $(event).find(".month input[type='checkbox']").prop("checked", true);
                    $(event).attr("data-check", "true");
                }
                else{
                    $(event).find(".month input[type='checkbox']").removeAttr("checked");
                    $(event).attr("data-check", "false");
                }
            });
            //天 对应的 年份
            var $year = $("#jfgrid-filter-byvalue-select .ListBox .yearBox");
            $year.each(function(index, event){
                var yearDayAllCheck = true;
                var $yearDay = $(event).find(".day input[type='checkbox']");
                $yearDay.each(function(i,e){
                    if($(e).is(":checked")){
                        
                    }
                    else{
                        yearDayAllCheck = false;
                    }
                });
                if(yearDayAllCheck){
                    $(event).find(".year input[type='checkbox']").prop("checked", true);
                    $(event).attr("data-check", "true");
                }
                else{
                    $(event).find(".year input[type='checkbox']").removeAttr("checked");
                    $(event).attr("data-check", "false");
                }
            });
        });

        //清除筛选
        $("#jfgrid-filter-initial").click(function () {
            $("#jfgrid-filter-menu .jfgrid-filter-selected-input").hide().find("input").val();
            $("#jfgrid-filter-selected span").data("type", "0").data("type", null).text("无");

            $('#jfgrid-filter-selected-sheet' + jfgrid.currentSheetIndex + ', #jfgrid-filter-options-sheet' + jfgrid.currentSheetIndex).remove();
            $("#jfgrid-filter-menu, #jfgrid-filter-submenu").hide();

            var redo = {};
            redo["type"] = "datachangeAll_filter_clear";
            redo["sheetIndex"] = jfgrid.currentSheetIndex;

            redo["config"] = $.extend(true, {}, config);
            config["rowhidden"] = {};
            redo["curconfig"] = $.extend(true, {}, config);

            redo["filter_save"] = $.extend(true, {}, jfgird_filter_save);

            var optiongroups = [];
            $("#jfgrid-filter-options-sheet" + jfgrid.currentSheetIndex + " .jfgrid-filter-options").each(function () {
                var $t = $(this);

                var optionstate = $t.hasClass("jfgrid-filter-options-active");
                var rowhidden = jfgrid.json.parseJsonParm($t.data("rowhidden"));
                var caljs = jfgrid.json.parseJsonParm($t.data("caljs"));

                optiongroups.push({
                    "optionstate":optionstate,
                    "rowhidden": rowhidden, 
                    "caljs":caljs, 
                    "str": $t.data("str"),
                    "edr": $t.data("edr"),
                    "cindex": $t.data("cindex"),
                    "stc": $t.data("stc"),
                    "edc": $t.data("edc")
                });
            });
            redo["optiongroups"] = optiongroups;

            jfgrid.jfundo = [];
            jfgrid.jfredo.push(redo);

            //清除筛选发送给后台
            jfgridfile[jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex)].filter = null;
            jfgridfile[jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex)].filter_select = null;

            jfgrid.server.saveParam("fsc", jfgrid.currentSheetIndex, null);

            //config
            jfgridfile[jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex)].config = config;

            jfgrid.server.saveParam("cg", jfgrid.currentSheetIndex, {}, { "k": "rowhidden" });

            //行高、列宽 刷新  
            jfgrid.jfrefreshgrid_rhcw(jfgrid.flowdata.length, jfgrid.flowdata[0].length);
        });

        //按照值进行筛选
        $("#jfgrid-filter-byvalue-input").on('input propertychange', function () {
            var v = $(this).val().toString();
            $("#jfgrid-filter-byvalue-select .ListBox .jfgrid-mousedown-cancel").show();
            
            if(v != ""){
                $("#jfgrid-filter-byvalue-select .ListBox input[type='checkbox']").each(function(i, e){
                    if($(e).closest(".day").length > 0){
                        var day = $(e).siblings("label").text().toString();
                        var month = $(e).closest(".monthBox").find(".month label").text().toString();
                        var year = $(e).closest(".yearBox").find(".year label").text().toString();
                        var itemV = year + "-" + month + "-" + day;

                        if(itemV.indexOf(v) == -1){
                            $(e).closest(".day").hide();
                            
                            //天 对应的 月份
                            var $monthDay = $(e).closest(".dayList").find(".day:visible");
                            if($monthDay.length == 0){
                                $(e).closest(".monthBox").find(".month").hide();
                            }

                            //天 对应的 年份
                            var $yearDay = $(e).closest(".monthList").find(".day:visible");
                            if($yearDay.length == 0){
                                $(e).closest(".yearBox").find(".year").hide();
                            }
                        }
                    }

                    if($(e).closest(".textBox").length > 0){
                        var itemV = $(e).siblings("label").text().toString();
                        
                        if(itemV.indexOf(v) == -1){
                            $(e).parents(".textBox").hide();
                        }
                    }
                });
            }
        });

        //info处理
        $("#jfgrid_info_detail_user").html(jfgridConfigsetting.userInfo+'&nbsp;<i class="fa fa-caret-down" aria-hidden="true"></i>').click(function(){
            if(jfgridConfigsetting.userMenuItem.length==0){
                return
            }

            var userlen = $(this).outerWidth();
            var tlen = $("#jfgrid-user-menu").outerWidth();

            var menuleft = $(this).offset().left;
            if(tlen>userlen && (tlen + menuleft)>$("#"+container).width()){
                menuleft = menuleft - tlen + userlen;
            }

            mouseclickposition($("#jfgrid-user-menu"), menuleft, $(this).offset().top+20, "lefttop");
        });
        if(jfgridConfigsetting.userMenuItem.length>0){
            $("body").append('<div class="jfgrid-cols-menu jfgrid-rightgclick-menu jfgrid-mousedown-cancel" id="jfgrid-user-menu">${item}</div>');
            var itemset = "";
            for(var i=0;i<jfgridConfigsetting.userMenuItem.length;i++){
                var item = jfgridConfigsetting.userMenuItem[i];
                itemset += '<div data-src="'+ item.url +'" class="jfgrid-cols-menuitem jfgrid-mousedown-cancel"><div class="jfgrid-cols-menuitem-content jfgrid-mousedown-cancel" style="padding: 6px 0px 6px 5px;"><span style="margin-right:3px;" class="icon jfgrid-mousedown-cancel">'+ item.icon +'</span> '+ item.name +'</div></div>';
            }
            $("#jfgrid-user-menu").html(itemset).find("i").addClass("jfgrid-mousedown-cancel").end().find(".jfgrid-cols-menuitem").click(function(){
                window.open($(this).data("src"), "_self");
            });
        }

        $("#jfgrid_info_detail_title").click(function(){
            window.open(jfgridConfigsetting.myFolderUrl, "_self");
        });


        $("#jfgrid_info_detail_input").val(jfgrid.server.title).css("width", jfgrid.getByteLen(jfgrid.server.title)*10).keydown(function(){
            var ctrlKey = event.ctrlKey;
            var altKey = event.altKey;
            var shiftKey = event.shiftKey;
            var kcode = event.keyCode;
            var $t = $(this);
            if(kcode == keycode.ENTER){
                $t.blur().change();
            }
        }).bind('input propertychange', function() { 
            var $t = $(this);
            var inputlen = jfgrid.getByteLen($t.val())*10;
            var updatelen = $("#jfgrid_info_detail_update").outerWidth();
            var savelen = $("#jfgrid_info_detail_save").outerWidth();
            var userlen = $("#jfgrid_info_detail_user").parent().outerWidth()+60;
            var containerlen = $("#"+container).outerWidth();
            var otherlen = 100;

            var minuslen = containerlen- savelen - updatelen - userlen - otherlen;
            if(inputlen > minuslen){
                $("#jfgrid_info_detail_input").css("width", minuslen);
            }
            else{
                $("#jfgrid_info_detail_input").css("width", inputlen);
            }
        }).change(function(){
            jfgrid.server.saveParam("na", null, $(this).val());
        });


        //公式处理
        $("#jfgrid-functionbox-cell").focus(function () {
            if(jfgrid.isEditMode()){//此模式下禁用公式栏
                return;
            }

            if(jfgird_select_save.length > 0){
                var last = jfgird_select_save[jfgird_select_save.length - 1];

                var row_index = last["row_focus"], col_index = last["column_focus"];
                var row = visibledatarow[row_index], row_pre = row_index - 1 == -1 ? 0 : visibledatarow[row_index - 1];
                var col = visibledatacolumn[col_index], col_pre = col_index - 1 == -1 ? 0 : visibledatacolumn[col_index - 1];

                var margeset = jfgrid.menuButton.mergeborer(jfgrid.flowdata, row_index, col_index);
                if(!!margeset){
                    row = margeset.row[1];
                    row_pre = margeset.row[0];
                    row_index = margeset.row[2];
                    col = margeset.column[1];
                    col_pre = margeset.column[0];
                    col_index = margeset.column[2];
                }
                
                jfgrid.jfgridupdateCell(row, row_pre, row_index, col, col_pre, col_index, jfgrid.flowdata, null, true);
                jfgrid.formula.rangeResizeTo = $("#jfgrid-functionbox-cell");
            }
        }).keydown(function (event) {
            if(jfgrid.isEditMode()){//此模式下禁用公式栏
                return;
            }

            var ctrlKey = event.ctrlKey;
            var altKey = event.altKey;
            var shiftKey = event.shiftKey;
            var kcode = event.keyCode;
            var $inputbox = $("#jfgrid-input-box");
            //jfgrid.formula.rangeHightlightselected();


            if (kcode == keycode.ENTER && parseInt($inputbox.css("top")) > 0) {
                if ($("#jfgrid-formula-search-c").is(":visible") && jfgrid.formula.searchFunctionCell != null) {
                    jfgrid.formula.searchFunctionEnter($("#jfgrid-formula-search-c").find(".jfgrid-formula-search-item-active"));
                }
                else {
                    jfgrid.formula.updatecell(jfgridCellUpdate[0], jfgridCellUpdate[1]);
                    jfgird_select_save = [{ "row": [jfgridCellUpdate[0], jfgridCellUpdate[0]], "column": [jfgridCellUpdate[1], jfgridCellUpdate[1]], "row_focus": jfgridCellUpdate[0], "column_focus": jfgridCellUpdate[1] }];
                    jfgridMoveHighlightCell("down", 1, "rangeOfSelect");
                    $("#jfgrid-functionbox-cell").blur();
                }
                event.preventDefault();
            }
            else if (kcode == keycode.ESC && parseInt($inputbox.css("top")) > 0) {
                jfgrid.formula.dontupdate();
                jfgridMoveHighlightCell("down", 0, "rangeOfSelect");
                event.preventDefault();
            }
            else if (kcode == keycode.F4 && parseInt($inputbox.css("top")) > 0) {
                jfgrid.formula.setfreezonFuc(event);
                event.preventDefault();
            }
            else if (kcode == keycode.UP && parseInt($inputbox.css("top")) > 0) {
                if ($("#jfgrid-formula-search-c").is(":visible")) {
                    var $up = $("#jfgrid-formula-search-c").find(".jfgrid-formula-search-item-active").prev();
                    if ($up.length == 0) {
                        $up = $("#jfgrid-formula-search-c").find(".jfgrid-formula-search-item").last();
                    }
                    $("#jfgrid-formula-search-c").find(".jfgrid-formula-search-item").removeClass("jfgrid-formula-search-item-active");
                    $up.addClass("jfgrid-formula-search-item-active");
                    event.preventDefault();
                }
            }
            else if (kcode == keycode.DOWN && parseInt($inputbox.css("top")) > 0) {
                if ($("#jfgrid-formula-search-c").is(":visible")) {
                    var $up = $("#jfgrid-formula-search-c").find(".jfgrid-formula-search-item-active").next();
                    if ($up.length == 0) {
                        $up = $("#jfgrid-formula-search-c").find(".jfgrid-formula-search-item").first();
                    }
                    $("#jfgrid-formula-search-c").find(".jfgrid-formula-search-item").removeClass("jfgrid-formula-search-item-active");
                    $up.addClass("jfgrid-formula-search-item-active");
                    event.preventDefault();
                }
            }
            else if (kcode == keycode.LEFT && parseInt($inputbox.css("top")) > 0) {
                jfgrid.formula.rangeHightlightselected($("#jfgrid-functionbox-cell"));
            }
            else if (kcode == keycode.RIGHT && parseInt($inputbox.css("top")) > 0) {
                jfgrid.formula.rangeHightlightselected($("#jfgrid-functionbox-cell"));
            }
            else if (!((kcode >= 112 && kcode <= 123) || kcode <= 46 || kcode == 144 || kcode == 108 || event.ctrlKey || event.altKey || (event.shiftKey && (kcode == 37 || kcode == 38 || kcode == 39 || kcode == 40))) || kcode == 8 || kcode == 32 || kcode == 46 || (event.ctrlKey && kcode == 86)) {
                jfgrid.formula.functionInputHanddler($("#jfgrid-rich-text-editor"), $("#jfgrid-functionbox-cell"), kcode);
                //         var value1 = $("#jfgrid-functionbox-cell").html(), value1txt = $("#jfgrid-functionbox-cell").text();
                //     	setTimeout(function(){
                //             var value = $("#jfgrid-functionbox-cell").text(), valuetxt = value;
                //             if (value.length > 0 && value.substr(0, 1) == "=" && kcode != 229) {
                //                 value = jfgrid.formula.functionHTMLGenerate(value);
                //                 value1 = jfgrid.formula.functionHTMLGenerate(value1txt);
                //                 if (window.getSelection) {  // all browsers, except IE before version 9
                //                     var currSelection = window.getSelection();
                //                     jfgrid.formula.functionRangeIndex = [$(currSelection.anchorNode).parent().index(), currSelection.anchorOffset];
                //                 }
                //                 else {  // Internet Explorer before version 9
                //                     var textRange = document.selection.createRange();
                //                     jfgrid.formula.functionRangeIndex = textRange;
                //                 }

                //                 $("#jfgrid-functionbox-cell").html(value);

                //          		jfgrid.formula.functionRange($("#jfgrid-functionbox-cell"), value, value1);

                //                 //console.log(value, value1, jfgrid.formula.functionRangeIndex);
                //                 // if (jfgrid.formula.functionRangeIndex != null) {
                //                 //     jfgrid.formula.functionRange($("#jfgrid-functionbox-cell"), value, value1);
                //                 // }
                //                 // else{
                //                 //     jfgridRangeLast($("#jfgrid-functionbox-cell")[0]);
                //                 // }

                //             }
                //             $("#jfgrid-rich-text-editor").html(value);

                //},1);
            }

        }).click(function () {
            if(jfgrid.isEditMode()){//此模式下禁用公式栏
                return;
            }

            jfgrid.formula.rangeHightlightselected($("#jfgrid-functionbox-cell"));
            //console.log(window.getSelection().getRangeAt(0));
            //if ($(this).text().length == 0) {
            //    jfgrid.formula.functionRangeIndex = null;
            //}
            //else{
            //    if (window.getSelection) {  // all browsers, except IE before version 9
            //        var currSelection = window.getSelection();
            //        jfgrid.formula.functionRangeIndex = currSelection.getRangeAt(0).endOffset;
            //        //currSelection.removeAllRanges();
            //    }
            //    else {  // Internet Explorer before version 9
            //        var textRange = document.selection.createRange();
            //        jfgrid.formula.functionRangeIndex = textRange;
            //    }
            //}
            //console.log(jfgrid.formula.functionRangeIndex);
        });

        $("#jfgrid-wa-functionbox-cancel").click(function () {
            if (!$(this).hasClass("jfgrid-wa-calculate-active")) {
                return;
            }
            //若有参数弹出框，隐藏
            if($("#jfgrid-search-formula-parm").is(":visible")){
                $("#jfgrid-search-formula-parm").hide();
            }
            //若有参数选取范围弹出框，隐藏
            if($("#jfgrid-search-formula-parm-select").is(":visible")){
                $("#jfgrid-search-formula-parm-select").hide();
            }

            jfgrid.formula.dontupdate();
            jfgridMoveHighlightCell("down", 0, "rangeOfSelect");
        });

        $("#jfgrid-wa-functionbox-confirm").click(function () {
            if (!$(this).hasClass("jfgrid-wa-calculate-active")) {
                return;
            }
            //若有参数弹出框，隐藏
            if($("#jfgrid-search-formula-parm").is(":visible")){
                $("#jfgrid-search-formula-parm").hide();
            }
            //若有参数选取范围弹出框，隐藏
            if($("#jfgrid-search-formula-parm-select").is(":visible")){
                $("#jfgrid-search-formula-parm-select").hide();
            }

            jfgrid.formula.updatecell(jfgridCellUpdate[0], jfgridCellUpdate[1]);
            jfgridMoveHighlightCell("down", 0, "rangeOfSelect");
            //$("#jfgrid-functionbox-cell").html($("#jfgrid-rich-text-editor").html());
        });

        $("#jfgrid-wa-functionbox-fx").click(function () {
            //点击函数查找弹出框
            if(jfgird_select_save.length == 0){
                if(jfgrid.isEditMode()){
                    alert("请选择单元格插入函数");
                }
                else{
                    jfgrid.tooltip.info("请选择单元格插入函数","");
                }

                return;
            }

            var last = jfgird_select_save[jfgird_select_save.length - 1];

            var row_index = last["row_focus"], col_index = last["column_focus"];
            var row = visibledatarow[row_index], row_pre = row_index - 1 == -1 ? 0 : visibledatarow[row_index - 1];
            var col = visibledatacolumn[col_index], col_pre = col_index - 1 == -1 ? 0 : visibledatacolumn[col_index - 1];

            jfgrid.jfgridupdateCell(row, row_pre, row_index, col, col_pre, col_index, jfgrid.flowdata);
            
            var cell = jfgrid.flowdata[row_index][col_index];
            if(cell != null && cell.f != null){
                //单元格有计算
                var functionStr = jfgrid.formula.getfunctionParam(cell.f);
                if(functionStr.fn != null){
                    //有函数公式
                    jfgrid.insertFormula.formulaParmDialog(functionStr.fn, functionStr.param);
                }
                else{
                    //无函数公式
                    jfgrid.insertFormula.formulaListDialog();
                }
            }
            else{
                //单元格无计算
                $("#jfgrid-rich-text-editor").html('<span dir="auto" class="jfgrid-formula-text-color">=</span>');
                $("#jfgrid-functionbox-cell").html($("#jfgrid-rich-text-editor").html());
                jfgrid.insertFormula.formulaListDialog();
            }

            jfgrid.insertFormula.init();
        });

        $("#jfgrid-formula-functionrange").on("mousedown", ".jfgrid-copy", function (event) {
            jfgrid.formula.rangeMove = true;
            jfgird_scroll_status = true;
            jfgrid.formula.rangeMoveObj = $(this).parent();
            jfgrid.formula.rangeMoveIndex = $(this).parent().attr("rangeindex");
            var mouse = mouseposition(event.pageX, event.pageY);
            var x = mouse[0] + $("#jfgrid-cell-main").scrollLeft();
            var y = mouse[1] + $("#jfgrid-cell-main").scrollTop();
            $("#jfgrid-formula-functionrange-highlight-" + jfgrid.formula.rangeMoveIndex).find(".jfgrid-selection-copy-hc").css("opacity", 0.13);
            var type = $(this).data("type");
            if (type == "top") {
                y += 3;
            }
            else if (type == "right") {
                x -= 3;
            }
            else if (type == "bottom") {
                y -= 3;
            }
            else if (type == "left") {
                x += 3;
            }

            var rowLocation = jfgrid.rowLocation(y), row_index = rowLocation[2];

            var colLocation = jfgrid.colLocation(x), col_index = colLocation[2];

            jfgrid.formula.rangeMovexy = [row_index, col_index];
            $("#jfgrid-sheettable").css("cursor", "move");
            event.stopPropagation();
        });

        $("#jfgrid-formula-functionrange").on("mousedown", ".jfgrid-highlight", function (e) {
            jfgrid.formula.rangeResize = $(this).data("type");//开始状态resize
            jfgrid.formula.rangeResizeIndex = $(this).parent().attr("rangeindex");
            var mouse = mouseposition(e.pageX, e.pageY), scrollLeft = $("#jfgrid-cell-main").scrollLeft(), scrollTop = $("#jfgrid-cell-main").scrollTop();
            var x = mouse[0] + scrollLeft;
            var y = mouse[1] + scrollTop;
            jfgrid.formula.rangeResizeObj = $(this).parent();
            $("#jfgrid-formula-functionrange-highlight-" + jfgrid.formula.rangeResizeIndex).find(".jfgrid-selection-copy-hc").css("opacity", 0.13);
            if (jfgrid.formula.rangeResize == "lt") {
                x += 3;
                y += 3;
            }
            else if (jfgrid.formula.rangeResize == "lb") {
                x += 3;
                y -= 3;
            }
            else if (jfgrid.formula.rangeResize == "rt") {
                x -= 3;
                y += 3;
            }
            else if (jfgrid.formula.rangeResize == "rb") {
                x -= 3;
                y -= 3;
            }

            var rowLocation = jfgrid.rowLocation(y), row = rowLocation[1], row_pre = rowLocation[0], row_index = rowLocation[2];

            var colLocation = jfgrid.colLocation(x), col = colLocation[1], col_pre = colLocation[0], col_index = colLocation[2];

            var position = jfgrid.formula.rangeResizeObj.position();
            jfgrid.formula.rangeResizexy = [col_pre, row_pre, jfgrid.formula.rangeResizeObj.width(), jfgrid.formula.rangeResizeObj.height(), position.left + scrollLeft, position.top + scrollTop, col, row];
            jfgrid.formula.rangeResizeWinH = $("#jfgrid-cell-main")[0].scrollHeight
            jfgrid.formula.rangeResizeWinW = $("#jfgrid-cell-main")[0].scrollWidth;
            jfgird_scroll_status = true;
            event.stopPropagation();
        });

        //图表选区mousedown
        $("#jfgrid-chart-rangeShow").on("mousedown.chartRangeShowMove", ".jfgrid-chart-rangeShow-move", function(event){
            jfgrid.chart_selection.rangeMove = true;
            jfgird_scroll_status = true;

            jfgrid.chart_selection.rangeMoveObj = $(this).parent();

            var chart_id = jfgrid.chartparam.jfgridCurrentChartMoveObj.find(".jfgrid-modal-dialog-content").attr("id");
            // var vue = !!window.generator && generator.chartEditorComponent;
            var chart_json = !!window.store && store.state.chartSetting.chartList[chart_id];
            
            var $id = $(this).parent().attr("id");
            if($id == "jfgrid-chart-rangeShow-content"){
                var row_s = chart_json.rangeArray[0].row[0] + chart_json.rangeSplitArray.content.row[0];
                var col_s = chart_json.rangeArray[0].column[0] + chart_json.rangeSplitArray.content.column[0];

                jfgrid.chart_selection.rangeMoveIndex = [row_s, col_s];
            }
            else if($id == "jfgrid-chart-rangeShow-rowtitle"){
                var row_s = chart_json.rangeArray[0].row[0] + chart_json.rangeSplitArray.rowtitle.row[0];
                var col_s = chart_json.rangeArray[0].column[0] + chart_json.rangeSplitArray.rowtitle.column[0];

                jfgrid.chart_selection.rangeMoveIndex = [row_s, col_s];
            }
            else if($id == "jfgrid-chart-rangeShow-coltitle"){
                var row_s = chart_json.rangeArray[0].row[0] + chart_json.rangeSplitArray.coltitle.row[0];
                var col_s = chart_json.rangeArray[0].column[0] + chart_json.rangeSplitArray.coltitle.column[0];
                
                jfgrid.chart_selection.rangeMoveIndex = [row_s, col_s];
            }

            var mouse = jfgrid.mouseposition(event.pageX, event.pageY);
            var x = mouse[0] + $("#jfgrid-cell-main").scrollLeft();
            var y = mouse[1] + $("#jfgrid-cell-main").scrollTop();
            
            var type = $(this).data("type");
            if (type == "top") {
                y += 3;
            }
            else if (type == "right") {
                x -= 3;
            }
            else if (type == "bottom") {
                y -= 3;
            }
            else if (type == "left") {
                x += 3;
            }

            var rowLocation = jfgrid.rowLocation(y), row_index = rowLocation[2];
            var colLocation = jfgrid.colLocation(x), col_index = colLocation[2];

            jfgrid.chart_selection.rangeMovexy = [row_index, col_index];

            event.stopPropagation();
        });

        $("#jfgrid-chart-rangeShow").on("mousedown.chartRangeShowResize", ".jfgrid-chart-rangeShow-resize", function(event){
            jfgrid.chart_selection.rangeResize = $(this).data("type");//开始状态resize
            jfgird_scroll_status = true;

            jfgrid.chart_selection.rangeResizeObj = $(this).parent();

            var chart_id = jfgrid.chartparam.jfgridCurrentChartMoveObj.find(".jfgrid-modal-dialog-content").attr("id");
            // var vue = !!window.generator && generator.chartEditorComponent;
            var chart_json = !!window.store && store.state.chartSetting.chartList[chart_id];
            
            var $id = $(this).parent().attr("id");
            if($id == "jfgrid-chart-rangeShow-content"){
                if(chart_json.rangeRowCheck.exits){
                    var row_s = chart_json.rangeArray[0].row[0] + chart_json.rangeSplitArray.content.row[0];
                    var row_e = chart_json.rangeArray[0].row[0] + chart_json.rangeSplitArray.content.row[1];
                }
                else{
                    var row_s = chart_json.rangeSplitArray.content.row[0];
                    var row_e = chart_json.rangeSplitArray.content.row[0];
                }

                if(chart_json.rangeColCheck.exits){
                    var col_s = chart_json.rangeArray[0].column[0] + chart_json.rangeSplitArray.content.column[0];
                    var col_e = chart_json.rangeArray[0].column[0] + chart_json.rangeSplitArray.content.column[1];
                }
                else{
                    var col_s = chart_json.rangeSplitArray.content.column[0];
                    var col_e = chart_json.rangeSplitArray.content.column[1];
                }

                jfgrid.chart_selection.rangeResizeIndex = { "row": [row_s, row_e], "column": [col_s, col_e] };
            }
            else if($id == "jfgrid-chart-rangeShow-rowtitle"){
                var row_s = chart_json.rangeArray[0].row[0] + chart_json.rangeSplitArray.rowtitle.row[0];
                var row_e = chart_json.rangeArray[0].row[0] + chart_json.rangeSplitArray.rowtitle.row[1];

                var col_s = chart_json.rangeArray[0].column[0] + chart_json.rangeSplitArray.rowtitle.column[0];
                var col_e = chart_json.rangeArray[0].column[0] + chart_json.rangeSplitArray.rowtitle.column[1];

                jfgrid.chart_selection.rangeResizeIndex = { "row": [row_s, row_e], "column": [col_s, col_e] };
            }
            else if($id == "jfgrid-chart-rangeShow-coltitle"){
                var row_s = chart_json.rangeArray[0].row[0] + chart_json.rangeSplitArray.coltitle.row[0];
                var row_e = chart_json.rangeArray[0].row[0] + chart_json.rangeSplitArray.coltitle.row[1];

                var col_s = chart_json.rangeArray[0].column[0] + chart_json.rangeSplitArray.coltitle.column[0];
                var col_e = chart_json.rangeArray[0].column[0] + chart_json.rangeSplitArray.coltitle.column[1];
                
                jfgrid.chart_selection.rangeResizeIndex = { "row": [row_s, row_e], "column": [col_s, col_e] };
            }

            var mouse = jfgrid.mouseposition(event.pageX, event.pageY);
            var x = mouse[0] + $("#jfgrid-cell-main").scrollLeft();
            var y = mouse[1] + $("#jfgrid-cell-main").scrollTop();

            if (jfgrid.chart_selection.rangeResize == "lt") {
                x += 3;
                y += 3;
            }
            else if (jfgrid.chart_selection.rangeResize == "lb") {
                x += 3;
                y -= 3;
            }
            else if (jfgrid.chart_selection.rangeResize == "rt") {
                x -= 3;
                y += 3;
            }
            else if (jfgrid.chart_selection.rangeResize == "rb") {
                x -= 3;
                y -= 3;
            }

            var rowLocation = jfgrid.rowLocation(y), row_index = rowLocation[2];
            var colLocation = jfgrid.colLocation(x), col_index = colLocation[2];

            jfgrid.chart_selection.rangeResizexy = [row_index, col_index];

            event.stopPropagation();
        })

        $("#jfgrid-wa-calculate-size").mousedown(function(e){
            var y = e.pageY;
            jfgrid.formula.functionResizeData.y = y;
            jfgrid.formula.functionResizeStatus = true;
            jfgrid.formula.functionResizeData.calculatebarHeight = calculatebarHeight;
            if(jfgrid.formula.rangetosheet!=null){
            	jfgrid.formula.updatecell(jfgridCellUpdate[0], jfgridCellUpdate[1]);
            }
            
        });

        var jfgrid_function_exe = {};

        for (var i = 0; i < jfgrid.functionlist.length; i++) {
            var func = jfgrid.functionlist[i];
            jfgrid_function_exe[func.n] = func;
        }
        window.jfgrid_function = jfgrid_function_exe;


        //toolbar菜单
        $("#"+ container +" .jfgrid-wa-editor").on("click", ".jfgrid-toolbar-zoom-combobox", function(e){
            $(e.currentTarget).addClass("jfgrid-toolbar-combo-button-open");
            $(e.currentTarget).find(".jfgrid-toolbar-combo-button-input").focus();
        });

        $("#"+ container +" .jfgrid-wa-editor").on("blur", ".jfgrid-toolbar-combo-button-input", function(e){
            $(e.currentTarget).closest(".jfgrid-toolbar-zoom-combobox").removeClass("jfgrid-toolbar-combo-button-open");
        });

        //表格格式处理
        jfgrid.menuButton.initialMenuButton();

        var devicePixelRatio = window.devicePixelRatio || 1;
        devicePixelRatio = Math.ceil(devicePixelRatio);
        
        jfgrid.dpi_x = document.getElementById('testdpidiv').offsetWidth * devicePixelRatio;
        jfgrid.dpi_y = document.getElementById('testdpidiv').offsetHeight * devicePixelRatio;
        $("#testdpidiv").remove();

        //粘贴事件处理
        $(document).on("paste", function(e){
            if(jfgrid.isEditMode()){//此模式下禁用粘贴
                return;
            }

            if(jfgrid.selection.isPasteAction){
                $("#jfgrid-rich-text-editor").blur();
                jfgrid.selection.isPasteAction = false;

                var clipboardData = window.clipboardData; //for IE
                if (!clipboardData) { // for chrome
                    clipboardData = e.originalEvent.clipboardData;
                }

                var txtdata = clipboardData.getData("text/html");

                //如果标示是qksheet复制的内容，判断剪贴板内容是否是当前页面复制的内容
                if(txtdata.indexOf("jfgrid_copy_action_table") >- 1 && jfgrid_copy_save["copyRange"] != null && jfgrid_copy_save["copyRange"].length > 0){
                    //剪贴板内容解析
                    var cpDataArr = [];

                    var reg = new RegExp('<tr.*?>(.*?)</tr>', 'g');
                    var reg2 = new RegExp('<td.*?>(.*?)</td>', 'g');

                    var regArr = txtdata.match(reg);

                    for(var i = 0; i < regArr.length; i++){
                        var cpRowArr = [];

                        var reg2Arr = regArr[i].match(reg2);

                        for(var j = 0; j < reg2Arr.length; j++){
                            var cpValue = reg2Arr[j].replace(/<td.*?>/g, "").replace(/<\/td>/g, "");
                            cpRowArr.push(cpValue);
                        }

                        cpDataArr.push(cpRowArr);
                    }

                    //当前页面复制区内容
                    var copy_r1 = jfgrid_copy_save["copyRange"][0].row[0],
                        copy_r2 = jfgrid_copy_save["copyRange"][0].row[1],
                        copy_c1 = jfgrid_copy_save["copyRange"][0].column[0],
                        copy_c2 = jfgrid_copy_save["copyRange"][0].column[1];

                    var copy_index = jfgrid_copy_save["dataSheetIndex"];

                    if(copy_index == jfgrid.currentSheetIndex){
                        var d = jfgrid.editor.deepCopyFlowData(jfgrid.flowdata);
                    }
                    else{
                        var d = jfgridfile[jfgrid.sheetmanage.getSheetIndex(copy_index)].data;
                    }

                    var isEqual = true;

                    for(var r = copy_r1; r <= copy_r2; r++){
                        if(r - copy_r1 > 5){
                            break;
                        }

                        for(var c = copy_c1; c <= copy_c2; c++){
                            var cell = d[r][c];

                            if(cell != null && cell.ct != null && cell.ct.fa.indexOf("w") > -1){
                                var v = d[r][c].v;
                            }
                            else{
                                var v = d[r][c].m;
                            }

                            if(v != cpDataArr[r - copy_r1][c - copy_c1]){
                                isEqual = false;
                                break;
                            }
                        }
                    }
                }

                if(txtdata.indexOf("jfgrid_copy_action_table") >- 1 && jfgrid_copy_save["copyRange"] != null && jfgrid_copy_save["copyRange"].length > 0 && isEqual){
                    //剪切板内容 和 jfgrid本身复制的内容 一致
                    if(jfgrid_paste_iscut){
                        jfgrid_paste_iscut = false;
                        jfgrid.selection.pasteHandlerOfCutPaste(jfgrid_copy_save);
                        jfgrid.selection.clearcopy(e);
                    }
                    else{
                        jfgrid.selection.pasteHandlerOfCopyPaste(jfgrid_copy_save);
                    }
                }
                else{
                    // if(txtdata.indexOf("table") > -1 && txtdata.indexOf("microsoft") > -1 && txtdata.indexOf("office") > -1 && txtdata.indexOf("excel") > -1 && txtdata.indexOf("mso-") > -1){
                    if(txtdata.indexOf("table") > -1){
                        $("#jfgird-copy-content").html(txtdata);

                        var data = new Array($("#jfgird-copy-content").find("table tr").length);
                        var colLen = 0;
                        $("#jfgird-copy-content").find("table tr").eq(0).find("td").each(function(){
                            var colspan = parseInt($(this).attr("colspan"));
                            if(isNaN(colspan)){
                                colspan = 1;
                            }
                            colLen += colspan;
                        });

                        for(var i = 0; i < data.length; i++){
                            data[i] = new Array(colLen);
                        }

                        var r = 0;
                        var borderInfo = {};
                        $("#jfgird-copy-content").find("table tr").each(function(){
                            var $tr = $(this);
                            var c = 0;
                            $tr.find("td").each(function(){
                                var $td = $(this);
                                var cell = {};
                                var txt = $td.text();

                                if($.trim(txt).length == 0){
                                    cell.v = null;
                                    cell.m = "";
                                }
                                else{
                                    var mask = jfgrid.mask.genarate($td.text());
                                    cell.v = mask[2];
                                    cell.ct = mask[1];
                                    cell.m = mask[0]; 
                                }

                                var bg = $td.css("background-color");
                                if(bg == "rgba(0, 0, 0, 0)"){
                                    bg = "rgba(255,255,255)";
                                }
                                // console.log(bg);
                                // if(bg.indexOf("rgb")>-1){
                                //     bg = jfgrid.rgbTohex(bg);
                                // }
                                // console.log(bg);
                                cell.bg = bg;

                                var bl = $td.css("font-weight");
                                if(bl == 400 || bl == "normal"){
                                    cell.bl = 0;
                                }
                                else{
                                    cell.bl = 1;
                                }

                                var it = $td.css("font-style");
                                if(it == "normal"){
                                    cell.it = 0;
                                }
                                else{
                                    cell.it = 1;
                                }

                                var ff = $td.css("font-family");
                                var ffs = ff.split(",");
                                for(var i = 0; i < ffs.length; i++){
                                    var fa = $.trim(ffs[i].toLowerCase());
                                    fa = jfgrid.menuButton.fontjson[fa];
                                    if(fa == null){
                                        cell.ff = 0;
                                    }
                                    else{
                                        cell.ff = fa;
                                        break;
                                    }
                                }

                                var fs = Math.floor(parseInt($td.css("font-size")) * 72 / jfgrid.dpi_y) + 1;
                                cell.fs = fs;

                                var fc = $td.css("color");
                                // if(fc.indexOf("rgb")>-1){
                                //     fc = jfgrid.rgbTohex(fc);
                                // }
                                cell.fc = fc;

                                var ht = $td.css("text-align");
                                if(ht == "center"){
                                    cell.ht = 0;
                                }
                                else if(ht == "right"){
                                    cell.ht = 2;
                                }
                                else{
                                    cell.ht = 1;
                                }

                                var vt = $td.css("vertical-align");
                                if(vt == "middle"){
                                    cell.vt = 0;
                                }
                                else if(vt == "top" || vt == "text-top"){
                                    cell.vt = 1;
                                }
                                else{
                                    cell.vt = 2;
                                }

                                // var borderstyle = $td.css("border");

                                // if(borderstyle != null && borderstyle.length > 0 && borderstyle.substr(0, 3).toLowerCase() != "0px"){
                                //     var width = $td.css("border-width");
                                //     var type = $td.css("border-style");
                                //     var color = $td.css("border-color");
                                //     var borderconfig = jfgrid.menuButton.getQKBorder(width, type, color);
                                //     cell.bs = borderconfig[0];
                                //     cell.bc = borderconfig[1];
                                // }
                                // else{
                                //     var bt = $td.css("border-top");
                                //     if(bt != null && bt.length > 0 && bt.substr(0, 3).toLowerCase() != "0px"){
                                //         var width = $td.css("border-top-width");
                                //         var type = $td.css("border-top-style");
                                //         var color = $td.css("border-top-color");
                                //         var borderconfig = jfgrid.menuButton.getQKBorder(width, type, color);
                                //         cell.bs_t = borderconfig[0];
                                //         cell.bc_t = borderconfig[1];
                                //     }
                                //     var bb = $td.css("border-bottom");
                                //     if(bb != null && bb.length > 0 && bb.substr(0, 3).toLowerCase() != "0px"){
                                //         var width = $td.css("border-bottom-width");
                                //         var type = $td.css("border-bottom-style");
                                //         var color = $td.css("border-bottom-color");
                                //         var borderconfig = jfgrid.menuButton.getQKBorder(width, type, color);
                                //         cell.bs_b = borderconfig[0];
                                //         cell.bc_b = borderconfig[1];
                                //     }
                                //     var bl = $td.css("border-left");
                                //     if(bl != null && bl.length > 0 && bl.substr(0, 3).toLowerCase() != "0px"){
                                //         var width = $td.css("border-left-width");
                                //         var type = $td.css("border-left-style");
                                //         var color = $td.css("border-left-color");
                                //         var borderconfig = jfgrid.menuButton.getQKBorder(width, type, color);
                                //         cell.bs_l = borderconfig[0];
                                //         cell.bc_l = borderconfig[1];
                                //     }
                                //     var br = $td.css("border-right");
                                //     if(br != null && br.length > 0 && br.substr(0, 3).toLowerCase() != "0px"){
                                //         var width = $td.css("border-right-width");
                                //         var type = $td.css("border-right-style");
                                //         var color = $td.css("border-right-color");
                                //         var borderconfig = jfgrid.menuButton.getQKBorder(width, type, color);
                                //         cell.bs_r = borderconfig[0];
                                //         cell.bc_r = borderconfig[1];

                                //         if(bl != null && bl.length > 0 && bl.substr(0, 3).toLowerCase() != "0px"){

                                //         }
                                //         else{
                                //             if(bb != null && bb.length > 0 && bb.substr(0, 3).toLowerCase() != "0px"){
                                //                 cell.bs_l = borderconfig[0];
                                //                 cell.bc_l = borderconfig[1];
                                //             }
                                //         }
                                //     }
                                // }

                                while (c < colLen && data[r][c] != null) {
                                    c++;
                                }

                                if(c == colLen){
                                    return true;
                                }

                                if(data[r][c] == null){
                                    data[r][c] = cell;
                                    var rowspan = parseInt($td.attr("rowspan"));
                                    var colspan = parseInt($td.attr("colspan"));
                                    
                                    if(isNaN(rowspan)){
                                        rowspan = 1;
                                    }

                                    if(isNaN(colspan)){
                                        colspan = 1;
                                    }

                                    var r_ab = jfgird_select_save[0]["row"][0] + r;
                                    var c_ab = jfgird_select_save[0]["column"][0] + c;
                                    for(var rp = 0; rp < rowspan; rp++){
                                        for(var cp = 0; cp < colspan; cp++){
                                            if(rp == 0){
                                                var bt = $td.css("border-top");
                                                if(bt != null && bt.length > 0 && bt.substr(0, 3).toLowerCase() != "0px"){
                                                    var width = $td.css("border-top-width");
                                                    var type = $td.css("border-top-style");
                                                    var color = $td.css("border-top-color");
                                                    var borderconfig = jfgrid.menuButton.getQKBorder(width, type, color);

                                                    if(borderInfo[(r + rp) + "_" + (c + cp)] == null){
                                                        borderInfo[(r + rp) + "_" + (c + cp)] = {};
                                                    }

                                                    borderInfo[(r + rp) + "_" + (c + cp)].t = { "style": borderconfig[0], "color": borderconfig[1] }; 
                                                }
                                            }

                                            if(rp == rowspan - 1){
                                                var bb = $td.css("border-bottom");
                                                if(bb != null && bb.length > 0 && bb.substr(0, 3).toLowerCase() != "0px"){
                                                    var width = $td.css("border-bottom-width");
                                                    var type = $td.css("border-bottom-style");
                                                    var color = $td.css("border-bottom-color");
                                                    var borderconfig = jfgrid.menuButton.getQKBorder(width, type, color);

                                                    if(borderInfo[(r + rp) + "_" + (c + cp)] == null){
                                                        borderInfo[(r + rp) + "_" + (c + cp)] = {};
                                                    }

                                                    borderInfo[(r + rp) + "_" + (c + cp)].b = { "style": borderconfig[0], "color": borderconfig[1] };
                                                }
                                            }

                                            if(cp == 0){
                                                var bl = $td.css("border-left");
                                                if(bl != null && bl.length > 0 && bl.substr(0, 3).toLowerCase() != "0px"){
                                                    var width = $td.css("border-left-width");
                                                    var type = $td.css("border-left-style");
                                                    var color = $td.css("border-left-color");
                                                    var borderconfig = jfgrid.menuButton.getQKBorder(width, type, color);

                                                    if(borderInfo[(r + rp) + "_" + (c + cp)] == null){
                                                        borderInfo[(r + rp) + "_" + (c + cp)] = {};
                                                    }

                                                    borderInfo[(r + rp) + "_" + (c + cp)].l = { "style": borderconfig[0], "color": borderconfig[1] };
                                                }
                                            }

                                            if(cp == colspan - 1){
                                                var br = $td.css("border-right");
                                                if(br != null && br.length > 0 && br.substr(0, 3).toLowerCase() != "0px"){
                                                    var width = $td.css("border-right-width");
                                                    var type = $td.css("border-right-style");
                                                    var color = $td.css("border-right-color");
                                                    var borderconfig = jfgrid.menuButton.getQKBorder(width, type, color);

                                                    if(borderInfo[(r + rp) + "_" + (c + cp)] == null){
                                                        borderInfo[(r + rp) + "_" + (c + cp)] = {};
                                                    }
                                                    
                                                    borderInfo[(r + rp) + "_" + (c + cp)].r = { "style": borderconfig[0], "color": borderconfig[1] };
                                                }
                                            }

                                            if(rp == 0 && cp == 0){
                                                continue;
                                            }
                                            data[r + rp][c + cp] = { "mc": {"r": r_ab, "c": c_ab} };
                                        }
                                    }

                                    if(rowspan > 1 || colspan > 1){
                                        var first = { "rs": rowspan, "cs": colspan, "r": r_ab, "c": c_ab};
                                        data[r][c].mc = first;
                                        // mclist.push(first);
                                    }
                                }
                                
                                c++;

                                if(c == colLen){
                                    return true;
                                }
                                //row.push(cell);
                            });

                            r++;
                            //data.push(row);
                        });

                        jfgrid_selection_range = [];
                        jfgrid.selection.pasteHandler(data, borderInfo);
                        $("#jfgird-copy-content").empty();
                    }
                    else{
                        txtdata = clipboardData.getData("text/plain");
                        jfgrid.selection.pasteHandler(txtdata);
                    }
                }
            }
        });

        if(jfgridConfigsetting.enablePage){
            $("#jfgrid-bottom-page-next").click(function(){
          
                // rptapp
                var queryExps = jfgridConfigsetting.pageInfo.queryExps;
                var reportId = jfgridConfigsetting.pageInfo.reportId;
                var fields = jfgridConfigsetting.pageInfo.fields;
                var mobile = jfgridConfigsetting.pageInfo.mobile;
                var frezon = jfgridConfigsetting.pageInfo.frezon;
                var currentPage = jfgridConfigsetting.pageInfo.currentPage;
                var totalPage = jfgridConfigsetting.pageInfo.totalPage;
                var pageUrl = jfgridConfigsetting.pageInfo.pageUrl;

                // rptapp
                jfgrid.method.addDataAjax({"queryExps":queryExps, "reportId":reportId, "fields":fields, "mobile":mobile, "frezon":frezon ,"pageIndex": currentPage,"currentPage":currentPage}, jfgrid.currentSheetIndex, pageUrl, function(){

                    jfgridConfigsetting.pageInfo.currentPage++;
                    //$("#jfgrid-bottom-page-info").html('共'+ jfgridConfigsetting.pageInfo.totalPage +'页，当前已显示'+ (jfgridConfigsetting.pageInfo.currentPage+1) +'页，每页'+ jfgridConfigsetting.pageInfo.pageSize +'条');
                    if(jfgridConfigsetting.pageInfo.totalPage == (jfgridConfigsetting.pageInfo.currentPage)){
                        $("#jfgrid-bottom-page-next").hide();
                        $("#jfgrid-bottom-page-info").html('共'+jfgridConfigsetting.total +'条，'+ jfgridConfigsetting.pageInfo.totalPage +'页，'+'已显示全部数据');
                    }
                    else{
                        $("#jfgrid-bottom-page-info").html('共'+jfgridConfigsetting.total +'条，'+ jfgridConfigsetting.pageInfo.totalPage +'页，当前已显示'+ (jfgridConfigsetting.pageInfo.currentPage) +'页');
                    }
                });
            }).mousedown(function(e){
                e.stopPropagation();
            });

        }
        $("#jfgrid-bottom-bottom-top").click(function(){
            $("#jfgrid-scrollbar-y").scrollTop(0);
        }).mousedown(function(e){
            e.stopPropagation();
        });
        

    }




    var showrightclickmenu = function ($menu, x, y) {
        var winH = $(window).height(), winW = $(window).width();
        var menuW = $menu.width(), menuH = $menu.height();
        var top = y, left = x;
        if (x + menuW > winW) {
            left = x - menuW;
        }

        if (y + menuH > winH) {
            top = y - menuH;
        }

        if (top < 0) {
            top = 0;
        }

        $menu.css({ "top": top, "left": left }).show();
    }

    jfgrid.showrightclickmenu = showrightclickmenu;

    function mouseclickposition($menu, x, y, p) {
        var winH = $(window).height(), winW = $(window).width();
        var menuW = $menu.width(), menuH = $menu.height();
        var top = y, left = x;

        if (p == null) {
            p = "lefttop";
        }

        if (p == "lefttop") {
            $menu.css({ "top": y, "left": x }).show();
        }
        else if (p == "righttop") {
            $menu.css({ "top": y, "left": x - menuW }).show();
        }
        else if (p == "leftbottom") {
            $menu.css({ "bottom": winH - y - 12, "left": x }).show();
        }
        else if (p == "rightbottom") {
            $menu.css({ "bottom": winH - y - 12, "left": x - menuW }).show();
        }
    }

    //function jfgridsliderlistitemfilter($filter) {

    //}


    var jfgridfontformat = function(format){
        if(jfgrid.getObjType(format) == "object"){
            var font = "";

            //font-style
            if(format.it == "0" || format.it == null){
                font += "normal ";
            }
            else{
                font += "italic ";
            }

            //font-variant
            font += "normal ";

            //font-weight
            if(format.bl == "0"  || format.bl == null){
                font += "normal ";
            }
            else{
                font += "bold ";
            }

            //font-size/line-height
            if(!format.fs){
                font += Math.ceil(10 * devicePixelRatio) + "pt ";
            }
            else{
                font += Math.ceil(format.fs * devicePixelRatio) + "pt ";
            }

            if(!format.ff){
                font += '微软雅黑, "Helvetica Neue", Helvetica, Arial, "PingFang SC", "Hiragino Sans GB", "Heiti SC", "Microsoft YaHei", "WenQuanYi Micro Hei", sans-serif';
            }
            else{
                var fontarray = jfgrid.menuButton.fontarray;
                var fontfamily = null;
                if(jfgrid.isdatatypemulti(format.ff)["num"]){
                    fontfamily = fontarray[parseInt(format.ff)];
                }
                else{
                    fontfamily = fontarray[jfgrid.menuButton.fontjson[format.ff]];
                }

                if(fontfamily == null){
                    fontfamily = "微软雅黑";
                }
                font += fontfamily + ', "Helvetica Neue", Helvetica, Arial, "PingFang SC", "Hiragino Sans GB", "Heiti SC", "Microsoft YaHei", "WenQuanYi Micro Hei", sans-serif';
            }

            return font;
        }
        else{
            return jfgriddefaultstyle.font;
        }
    }
    jfgrid.jfgridfontformat = jfgridfontformat;

    jfgrid.menuButton = {
        "menu":'<div class="jfgrid-cols-menu jfgrid-rightgclick-menu jfgrid-menuButton ${subclass} jfgrid-mousedown-cancel" id="jfgrid-icon-${id}-menuButton">${item}</div>',
        "item":'<div itemvalue="${value}" itemname="${name}" class="jfgrid-cols-menuitem ${sub} jfgrid-mousedown-cancel"><div class="jfgrid-cols-menuitem-content jfgrid-mousedown-cancel" style="padding: 3px 0px 3px 1px;"><span style="margin-right:3px;width:13px;display:inline-block;" class="icon jfgrid-mousedown-cancel"></span> ${name} <span class="jfgrid-submenu-arrow jfgrid-mousedown-cancel" style="user-select: none;">${example}</span></div></div>',
        "split":'<div class="jfgrid-menuseparator jfgrid-mousedown-cancel" role="separator"></div>',
        "color":'<div class="jfgrid-cols-menu jfgrid-rightgclick-menu jfgrid-rightgclick-menu-sub jfgrid-mousedown-cancel jfgrid-menuButton ${sub}" id="${id}"><div class="jfgrid-cols-menuitem jfgrid-mousedown-cancel jfgrid-color-reset"><div class="jfgrid-cols-menuitem-content jfgrid-mousedown-cancel">重置颜色</div></div> <div class="jfgrid-mousedown-cancel"> <div class="jfgrid-mousedown-cancel"> <input type="text" class="jfgrid-color-selected" /> </div> </div> <div class="jfgrid-menuseparator jfgrid-mousedown-cancel" role="separator"></div> ${coloritem}</div>',
        "coloritem":'<div class="jfgrid-cols-menuitem jfgrid-mousedown-cancel ${class}"><div class="jfgrid-cols-menuitem-content jfgrid-mousedown-cancel">${name}</div></div>',
        "subcolor":'<div id="jfgrid-icon-${id}-menuButton" class="jfgrid-cols-menu jfgrid-rightgclick-menu jfgrid-rightgclick-menu-sub jfgrid-menuButton-sub jfgrid-mousedown-cancel"> <div class="jfgrid-mousedown-cancel"> <div class="jfgrid-mousedown-cancel"> <input type="text" class="jfgrid-color-selected" /> </div> </div></div>',
        "rightclickmenu":null,
        "submenuhide":null,
        "focus":function($obj, value){
            $obj.find(".jfgrid-cols-menuitem").find("span.icon").html("");
            if(value==null){
                $obj.find(".jfgrid-cols-menuitem").eq(0).find("span.icon").html('<i class="fa fa-check jfgrid-mousedown-cancel"></i>');
            }
            else{
                $obj.find(".jfgrid-cols-menuitem[itemvalue='"+ value +"']").find("span.icon").html('<i class="fa fa-check jfgrid-mousedown-cancel"></i>');
            }
        },
        "createButtonMenu":function(itemdata){
            var itemset = "";
            var _this = this;
            for(var i=0;i<itemdata.length;i++){
                var item = itemdata[i];
                if(item.value=="split"){
                    itemset += _this.split;
                }
                else{
                    if(item.example=="more"){
                        itemset += jfgrid.replaceHtml(_this.item, {"value":item.value, "name":item.text, "example":"►", "sub":"jfgrid-cols-submenu"});
                    }
                    else{
                        itemset += jfgrid.replaceHtml(_this.item, {"value":item.value, "name":item.text, "example":item.example, "sub":""});
                    }
                }
            }
            return itemset;
        },
        cancelPaintModel:function(){
            var _this = this;
            $("#jfgrid-sheettable_0").removeClass("jfgridPaintCursor");

            if(jfgrid_copy_save["dataSheetIndex"] == jfgrid.currentSheetIndex){
                jfgrid_selection_range = [];
                jfgrid.selectionCopyShow();
            }
            else{
                jfgridfile[jfgrid.sheetmanage.getSheetIndex(jfgrid_copy_save["dataSheetIndex"])].jfgrid_selection_range = [];
            }
            
            jfgrid_copy_save = {};

            _this.jfgridPaintModelOn = false;
            $("#jfgridpopover").fadeOut(200,function(){
                $("#jfgridpopover").remove();
            });
        },
        jfgridPaintModelOn:false,
        jfgridPaintSingle: false,
        "initialMenuButton": function(){
            
            var _this = this;

            //格式刷
            $("#jfgrid-icon-paintformat").click(function(){
                if(jfgird_select_save == null || jfgird_select_save.length == 0){
                    if(jfgrid.isEditMode()){
                        alert("请选择需要复制格式的区域");
                    }
                    else{
                        jfgrid.tooltip.info("提示","请选择需要复制格式的区域");
                    }
                    return;
                }
                else if(jfgird_select_save.length > 1){
                    if(jfgrid.isEditMode()){
                        alert("无法对多重选择区域执行此操作");
                    }
                    else{
                        jfgrid.tooltip.info("提示","无法对多重选择区域执行此操作");
                    }
                    return;
                }

                jfgrid.tooltip.popover("<i class='fa fa-paint-brush'></i> 格式刷开启", "topCenter", true, null, "ESC键退出",function(){
                    //alert("关闭格式刷");
                    // $("#jfgrid-sheettable_0").removeClass("jfgridPaintCursor");
                    // $("#jfgrid-selection-copy").hide();
                    // jfgrid_selection_range=null;
                    _this.cancelPaintModel();
                });
                $("#jfgrid-sheettable_0").addClass("jfgridPaintCursor");

                jfgrid_selection_range = [{ "row": jfgird_select_save[0].row, "column": jfgird_select_save[0].column }];
                jfgrid.selectionCopyShow();

                var RowlChange = false, HasMC = false;
                for(var r = jfgird_select_save[0].row[0]; r <= jfgird_select_save[0].row[1]; r++){
                    if (config["rowhidden"] != null && config["rowhidden"][r] != null) {
                        continue;
                    }

                    if (config["rowlen"] != null && (r in config["rowlen"])){
                        RowlChange = true;
                    }

                    for(var c = jfgird_select_save[0].column[0]; c <= jfgird_select_save[0].column[1]; c++){
                        var cell = jfgrid.flowdata[r][c];
                        
                        if(jfgrid.getObjType(cell) == "object" && ("mc" in cell) && cell.mc.rs != null){
                            HasMC = true;
                        }
                    }
                }
                jfgrid_copy_save = { "dataSheetIndex": jfgrid.currentSheetIndex, "copyRange": [{ "row": jfgird_select_save[0].row, "column": jfgird_select_save[0].column }], "RowlChange": RowlChange, "HasMC": HasMC };

                _this.jfgridPaintModelOn = true;
                _this.jfgridPaintSingle = true;
            });
            $("#jfgrid-icon-paintformat").dblclick(function(){
                if(jfgird_select_save == null || jfgird_select_save.length == 0){
                    if(jfgrid.isEditMode()){
                        alert("请选择需要复制格式的区域");
                    }
                    else{
                        jfgrid.tooltip.info("提示","请选择需要复制格式的区域");  
                    }
                    return;
                }
                else if(jfgird_select_save.length > 1){
                    if(jfgrid.isEditMode()){
                        alert("无法对多重选择区域执行此操作");
                    }
                    else{
                        jfgrid.tooltip.info("提示","无法对多重选择区域执行此操作");
                    }
                    return;
                }

                jfgrid.tooltip.popover("<i class='fa fa-paint-brush'></i> 格式刷开启", "topCenter", true, null, "ESC键退出",function(){
                    //alert("关闭格式刷");
                    // $("#jfgrid-sheettable_0").removeClass("jfgridPaintCursor");
                    // $("#jfgrid-selection-copy").hide();
                    // jfgrid_selection_range=null;
                    _this.cancelPaintModel();
                });
                $("#jfgrid-sheettable_0").addClass("jfgridPaintCursor");

                jfgrid_selection_range = [{ "row": jfgird_select_save[0].row, "column": jfgird_select_save[0].column }];
                jfgrid.selectionCopyShow();

                var RowlChange = false, HasMC = false;
                for(var r = jfgird_select_save[0].row[0]; r <= jfgird_select_save[0].row[1]; r++){
                    if (config["rowhidden"] != null && config["rowhidden"][r] != null) {
                        continue;
                    }

                    if (config["rowlen"] != null && (r in config["rowlen"])){
                        RowlChange = true;
                    }

                    for(var c = jfgird_select_save[0].column[0]; c <= jfgird_select_save[0].column[1]; c++){
                        var cell = jfgrid.flowdata[r][c];
                        
                        if(jfgrid.getObjType(cell) == "object" && ("mc" in cell) && cell.mc.rs != null){
                            HasMC = true;
                        }
                    }
                }
                jfgrid_copy_save = { "dataSheetIndex": jfgrid.currentSheetIndex, "copyRange": [{ "row": jfgird_select_save[0].row, "column": jfgird_select_save[0].column }], "RowlChange": RowlChange, "HasMC": HasMC };
                
                _this.jfgridPaintModelOn = true;
                _this.jfgridPaintSingle = false;
            });

            //货币格式
            $("#jfgrid-icon-currency").click(function(){
                var d = jfgrid.editor.deepCopyFlowData(jfgrid.flowdata);//取数据

                _this.updateFormat(d, "ct", "¥ #.00");
            });

            //百分比
            $("#jfgrid-icon-percent").click(function(){
                var d = jfgrid.editor.deepCopyFlowData(jfgrid.flowdata);//取数据

                _this.updateFormat(d, "ct", "0.00%");
            });

            //减少小数位数
            $("#jfgrid-icon-fmt-decimal-decrease").click(function(){
                var d = jfgrid.editor.deepCopyFlowData(jfgrid.flowdata);//取数据
                var row_index = jfgird_select_save[0]["row_focus"], 
                    col_index = jfgird_select_save[0]["column_focus"];
                var foucsStatus = _this.checkstatus(d, row_index, col_index, "ct");
                var cell = d[row_index][col_index];

                if(foucsStatus == null || foucsStatus.t != "n"){
                    return;
                }

                if(foucsStatus.fa == "General"){
                    var mask = jfgrid.mask.genarate(cell.v);
                    foucsStatus = mask[1];
                }

                //万亿格式
                var reg = /^(w|W)((0?)|(0\.0+))$/;
                if(reg.test(foucsStatus.fa)){
                    if(foucsStatus.fa.indexOf(".") > -1){
                        if(foucsStatus.fa.substr(-2) == ".0"){
                            _this.updateFormat(d, "ct", foucsStatus.fa.split(".")[0]);
                        }
                        else{
                            _this.updateFormat(d, "ct", foucsStatus.fa.substr(0, foucsStatus.fa.length - 1));   
                        }
                    }
                    else{
                        _this.updateFormat(d, "ct", foucsStatus.fa);
                    }

                    return;
                }

                var prefix = "", main = "";
                if(foucsStatus.fa.indexOf(".")>-1){
                    fa = foucsStatus.fa.split(".");
                    prefix = fa[0];
                    main = fa[1];
                }
                else{
                    return;
                }

                var fa = main.split("");
                var tail = "";
                for(i=fa.length-1;i>=0;i--){
                    var c = fa[i];
                    if((c!="#" && c!="0" && c!="," && isNaN(parseInt(c)))) {
                        tail = c + tail;
                    }
                    else{
                        break;
                    }
                }

                var fmt = "";
                if(foucsStatus.fa.indexOf(".")>-1){
                    var suffix = main;
                    if(tail.length>0){
                        suffix = main.replace(tail, "");
                    }

                    var pos = suffix.replace(/#/g, "0");
                    pos = pos.substr(0, pos.length-1);
                    if(pos==""){
                        fmt = prefix + tail;
                    }
                    else{
                        fmt = prefix + "." + pos + tail;
                    }
                }

                _this.updateFormat(d, "ct", fmt);
            });

            //增加小数位数
            $("#jfgrid-icon-fmt-decimal-increase").click(function(){
                var d = jfgrid.editor.deepCopyFlowData(jfgrid.flowdata);//取数据
                var row_index = jfgird_select_save[0]["row_focus"], 
                    col_index = jfgird_select_save[0]["column_focus"];
                var foucsStatus = _this.checkstatus(d, row_index, col_index, "ct");
                var cell = d[row_index][col_index];

                if(foucsStatus== null || foucsStatus.t != "n"){
                    return;
                }

                if(foucsStatus.fa == "General"){
                    var mask = jfgrid.mask.genarate(cell.v);
                    foucsStatus = mask[1];
                }

                if(foucsStatus.fa == "General"){
                    _this.updateFormat(d, "ct", "#.0");
                    return;
                }

                //万亿格式
                var reg = /^(w|W)((0?)|(0\.0+))$/;
                if(reg.test(foucsStatus.fa)){
                    if(foucsStatus.fa.indexOf(".") > -1){
                        _this.updateFormat(d, "ct", foucsStatus.fa + "0");
                    }
                    else{
                        if(foucsStatus.fa.substr(-1) == "0"){
                            _this.updateFormat(d, "ct", foucsStatus.fa + ".0");
                        }
                        else{
                            _this.updateFormat(d, "ct", foucsStatus.fa + "0.0");
                        }
                    }

                    return;
                }

                var prefix = "", main = "";
                if(foucsStatus.fa.indexOf(".")>-1){
                    fa = foucsStatus.fa.split(".");
                    prefix = fa[0];
                    main = fa[1];
                }
                else{
                    main = foucsStatus.fa;
                }

                var fa = main.split("");
                var tail = "";
                for(i=fa.length-1;i>=0;i--){
                    var c = fa[i];
                    if(( c!="#" && c!="0" && c!="," && isNaN(parseInt(c)))) {
                        tail = c + tail;
                    }
                    else{
                        break;
                    }
                }

                var fmt = "";
                if(foucsStatus.fa.indexOf(".")>-1){
                    var suffix = main;
                    if(tail.length>0){
                        suffix = main.replace(tail, "");
                    }

                    var pos = suffix.replace(/#/g, "0");
                    pos += "0";
                    fmt = prefix + "." + pos + tail;
                }
                else{
                    if(tail.length>0){
                        fmt = main.replace(tail, "") + ".0" + tail;
                    }
                    else{
                        fmt = main + ".0" + tail;
                    }
                }


                _this.updateFormat(d, "ct", fmt);
            });

            //更多格式
            $("#jfgrid-icon-fmt-other").click(function(){
                var menuButtonId = $(this).attr("id")+"-menuButton";
                var $menuButton = $("#"+menuButtonId);
                if($menuButton.length == 0){
                    var itemdata = [
                        { "text": "自动", "value": "General", "example": "" },
                        { "text": "纯文本", "value": "@", "example": "" },
                        { "text": "", "value": "split", "example": "" },
                        { "text": "数字", "value": "##0.00", "example": "1000.12" },
                        { "text": "百分比", "value": "#0.00%", "example": "12.21%" },
                        { "text": "科学计数", "value": "0.00E+00", "example": "1.01E+5" },
                        { "text": "", "value": "split", "example": "" },
                        { "text": "会计", "value": "¥(0.00)", "example": "¥(1200.09)" },
                        //{ "text": "财务", "value": "(#.####)", "example": "(1200.09)" },
                        { "text": "万元", "value": "w", "example": "1亿2000万2500" },
                        { "text": "货币", "value": "¥0.00", "example": "¥1200.09" },
                        //{ "text": "货币整数", "value": "¥####", "example": "¥1200" },
                        { "text": "万元2位小数", "value": "w0.00", "example": "2万2500.55" },
                        { "text": "", "value": "split", "example": "" },
                        { "text": "日期", "value": "yyyy-MM-dd", "example": "2017-11-29" },
                        { "text": "时间", "value": "hh:mm AM/PM", "example": "3:00 PM" },
                        { "text": "时间24H", "value": "hh:mm", "example": "15:00" },
                        { "text": "日期时间", "value": "yyyy-MM-dd hh:mm AM/PM", "example": "2017-11-29 3:00 PM" },
                        { "text": "日期时间24H", "value": "yyyy-MM-dd hh:mm", "example": "2017-11-29 15:00" },
                        { "text": "", "value": "split", "example": "" },
                        { "text": "自定义格式", "value": "fmtOtherSelf", "example": "more" }
                    ];

                    var itemset = _this.createButtonMenu(itemdata);

                    // jfgrid-menuButton-sub
                    var menu = jfgrid.replaceHtml(_this.menu, {"id":"fmt-other", "item": itemset, "subclass":"", "sub":""});

                    var subitemdata = [
                        {"text":"更多货币格式...", "value":"morecurrency", "example":""},
                        {"text":"更多日期与时间格式...", "value":"moredatetime", "example":""},
                        {"text":"更多数字格式...", "value":"moredigit", "example":""}
                    ];
                    var subitemset = _this.createButtonMenu(subitemdata);
                    var submenu = jfgrid.replaceHtml(_this.menu, {"id":"fmtOtherSelf", "item": subitemset, "subclass":"jfgrid-menuButton-sub"});
                    //jfgrid-icon-fmt-other-menuButton_sub
                    $("body").append(menu+submenu);
                    $menuButton = $("#"+menuButtonId).width(250);
                    _this.focus($menuButton);

                    $menuButton.find(".jfgrid-cols-menuitem").click(function(){
                        $menuButton.hide();
                        $("#" + container).attr("tabindex", 0).focus();

                        var $t = $(this), itemvalue = $t.attr("itemvalue");

                        if(itemvalue == "fmtOtherSelf"){
                            return;
                        }

                        var d = jfgrid.editor.deepCopyFlowData(jfgrid.flowdata);//取数据
                        _this.focus($menuButton, itemvalue);

                        _this.updateFormat(d, "ct", itemvalue);
                    });

                    //更多格式
                    $("#jfgrid-icon-fmtOtherSelf-menuButton").find(".jfgrid-cols-menuitem").click(function(){
                        $menuButton.hide();
                        $("#jfgrid-icon-fmtOtherSelf-menuButton").hide();
                        $("#" + container).attr("tabindex", 0).focus();

                        var itemvalue = $(this).attr("itemvalue");

                        jfgrid.moreFormat.createDialog(itemvalue);
                        jfgrid.moreFormat.init();
                    })
                }

                var userlen = $(this).outerWidth();
                var tlen = $menuButton.outerWidth();

                var menuleft = $(this).offset().left;
                if(tlen>userlen && (tlen + menuleft)>$("#"+container).width()){
                    menuleft = menuleft - tlen + userlen;
                }
                mouseclickposition($menuButton, menuleft, $(this).offset().top+25, "lefttop");
            });

            //字体设置
            $("#jfgrid-icon-font-family").click(function(){
                var menuButtonId = $(this).attr("id")+"-menuButton";
                var $menuButton = $("#"+menuButtonId);
                if($menuButton.length == 0){
                    var itemdata = [
                        { "value": "0", "text": "<span class='jfgrid-mousedown-cancel' style='font-size:16px;font-family:微软雅黑'>微软雅黑</span>", "example": "" },
                        { "value": "1", "text": "<span class='jfgrid-mousedown-cancel' style='font-size:16px;font-family:宋体'>宋体</span>", "example": "" },
                        { "value": "2", "text": "<span class='jfgrid-mousedown-cancel' style='font-size:16px;font-family:黑体'>黑体</span>", "example": "" },
                        { "value": "3", "text": "<span class='jfgrid-mousedown-cancel' style='font-size:16px;font-family:楷体'>楷体</span>", "example": "" },
                        { "value": "4", "text": "<span class='jfgrid-mousedown-cancel' style='font-size:16px;font-family:仿宋'>仿宋</span>", "example": "" },
                        { "value": "5", "text": "<span class='jfgrid-mousedown-cancel' style='font-size:16px;font-family:新宋体'>新宋体</span>", "example": "" },
                        { "value": "6", "text": "<span class='jfgrid-mousedown-cancel' style='font-size:16px;font-family:华文新魏'>华文新魏</span>", "example": "" },
                        { "value": "7", "text": "<span class='jfgrid-mousedown-cancel' style='font-size:16px;font-family:华文行楷'>华文行楷</span>", "example": "" },
                        { "value": "8", "text": "<span class='jfgrid-mousedown-cancel' style='font-size:16px;font-family:华文隶书'>华文隶书</span>", "example": "" },
                        { "value": "9", "text": "<span class='jfgrid-mousedown-cancel' style='font-size:16px;font-family:Arial'>Arial</span>", "example": "" },
                        { "value": "10", "text": "<span class='jfgrid-mousedown-cancel' style='font-size:16px;font-family:Times New Roman'>Times New Roman</span>", "example": "" },
                        { "value": "11", "text": "<span class='jfgrid-mousedown-cancel' style='font-size:16px;font-family:Tahoma'>Tahoma</span>", "example": "" },
                        { "value": "12", "text": "<span class='jfgrid-mousedown-cancel' style='font-size:16px;font-family:Verdana'>Verdana</span>", "example": "" }
                    ];

                    var itemset = _this.createButtonMenu(itemdata);

                    var menu = jfgrid.replaceHtml(_this.menu, {"id": "font-family", "item": itemset, "subclass":"", "sub": ""});

                    $("body").append(menu);
                    $menuButton = $("#"+menuButtonId).width(150);
                    _this.focus($menuButton);

                    $menuButton.find(".jfgrid-cols-menuitem").click(function(){
                        $menuButton.hide();
                        $("#" + container).attr("tabindex", 0).focus();

                        var $t = $(this), itemvalue = $t.attr("itemvalue"), itemname = $t.attr("itemname");
                        _this.focus($menuButton, itemvalue);
                        $("#jfgrid-icon-font-family").find(".jfgrid-toolbar-menu-button-caption").html(" "+ itemname +" ");

                        var d = jfgrid.editor.deepCopyFlowData(jfgrid.flowdata);

                        _this.updateFormat(d, "ff", itemvalue);
                    });
                }

                var userlen = $(this).outerWidth();
                var tlen = $menuButton.outerWidth();

                var menuleft = $(this).offset().left;
                if(tlen>userlen && (tlen + menuleft)>$("#"+container).width()){
                    menuleft = menuleft - tlen + userlen;
                }
                mouseclickposition($menuButton, menuleft, $(this).offset().top+25, "lefttop");
            });

            //字体颜色
            $("#jfgrid-icon-text-color").click(function(){
                var d = jfgrid.editor.deepCopyFlowData(jfgrid.flowdata);
                var color =  $(this).attr("color");
                if(color==null){
                    color = "#000000";
                }
                _this.updateFormat(d, "fc", color);
            });

            
            $("#jfgrid-icon-text-color-menu").click(function(){
                var menuButtonId = $(this).attr("id")+"-menuButton";
                var $menuButton = $("#"+menuButtonId);
                console.log($menuButton.length);
                if($menuButton.length==0){
                    var itemdata = [
                        {"name":"交替颜色...", "id":"jfgrid-color-alternate", "example":""}
                    ];

                    var itemset = _this.createButtonMenu(itemdata);
                    var subid = "text-color-self";
                    var coloritem = jfgrid.replaceHtml(_this.coloritem, {"class":"jfgrid-icon-alternateformat", "name":"交替颜色..."});
                    // jfgrid-menuButton-sub
                    var menu = jfgrid.replaceHtml(_this.color, {"id":menuButtonId, "coloritem": coloritem, "colorself":subid, "sub":""});

                    //var submenu = jfgrid.replaceHtml(_this.subcolor, {"id": subid,  "subclass":"jfgrid-menuButton-sub"});
                    //jfgrid-icon-fmt-other-menuButton_sub
                    $("body").append(menu);
                    $menuButton = $("#"+menuButtonId);

                    // $menuButton.find(".jfgrid-cols-menuitem").click(function(){
                    //     var $t = $(this), itemvalue = $t.attr("itemvalue");
                    //     if(itemvalue=="fmtOtherSelf"){
                    //         return;
                    //     }
                    //     _this.focus($menuButton, itemvalue);
                    //     $menuButton.hide();
                    // });

                    //console.log(111)

                    $("#"+ menuButtonId).find(".jfgrid-color-selected").spectrum({
                        showPalette: true,
                        showPaletteOnly:true,
                        preferredFormat: "hex",
                        clickoutFiresChange: false,
                        showInitial: true,
                        showInput: true,
                        flat: true,
                        hideAfterPaletteSelect: true,
                        showSelectionPalette: true,
                        maxPaletteSize: 8,
                        maxSelectionSize: 8,
                        cancelText: "取消",
                        chooseText: "确定颜色",
                        togglePaletteMoreText: "自定义",
                        togglePaletteLessText: "收起",
                        togglePaletteOnly: true,
                        clearText: "清除颜色选择",
                        color:"#000",
                        noColorSelectedText: "没有颜色被选择",
                        localStorageKey: "spectrum.textcolor" + jfgrid.server.gridKey,
                        palette: [["#000","#444","#666","#999","#ccc","#eee","#f3f3f3","#fff"],
                        ["#f00","#f90","#ff0","#0f0","#0ff","#00f","#90f","#f0f"],
                        ["#f4cccc","#fce5cd","#fff2cc","#d9ead3","#d0e0e3","#cfe2f3","#d9d2e9","#ead1dc"],
                        ["#ea9999","#f9cb9c","#ffe599","#b6d7a8","#a2c4c9","#9fc5e8","#b4a7d6","#d5a6bd"],
                        ["#e06666","#f6b26b","#ffd966","#93c47d","#76a5af","#6fa8dc","#8e7cc3","#c27ba0"],
                        ["#c00","#e69138","#f1c232","#6aa84f","#45818e","#3d85c6","#674ea7","#a64d79"],
                        ["#900","#b45f06","#bf9000","#38761d","#134f5c","#0b5394","#351c75","#741b47"],
                        ["#600","#783f04","#7f6000","#274e13","#0c343d","#073763","#20124d","#4c1130"]],
                        change: function (color) {
                            var $input = $(this);
                            if (color != null) {
                                color = color.toHexString();
                            }
                            else {
                                color = "#000";
                            }

                            var oldcolor = null;
                            $("#jfgrid-icon-text-color .jfgrid-color-menu-button-indicator").css("border-bottom-color", color);
                            // var $input = $("#"+ menuButtonId).find(".jfgrid-color-selected");
                            // $input.spectrum("set", $input.val());
                            $("#jfgrid-icon-text-color").attr("color", color);

                            var d = jfgrid.editor.deepCopyFlowData(jfgrid.flowdata);
                            _this.updateFormat(d, "fc", color);

                            $menuButton.hide();
                            $("#" + container).attr("tabindex", 0).focus();
                        },
                    });

                    $menuButton.find(".jfgrid-color-reset").click(function(){
                        $menuButton.hide();
                        $("#" + container).attr("tabindex", 0).focus();

                        var $input = $("#"+ menuButtonId).find(".jfgrid-color-selected");
                        $input.val("#000000");
                        $("#jfgrid-icon-text-color").attr("color", null);
                        $input.spectrum("set", "#000000");
                        $("#jfgrid-icon-text-color .jfgrid-color-menu-button-indicator").css("border-bottom-color", "#000000");
                        
                        var d = jfgrid.editor.deepCopyFlowData(jfgrid.flowdata);
                        _this.updateFormat(d, "fc", null);
                    });

                    //交替颜色
                    $menuButton.find(".jfgrid-icon-alternateformat").click(function(){
                        $menuButton.hide();
                        $("#" + container).attr("tabindex", 0).focus();

                        if(jfgird_select_save.length > 1){
                            if(jfgrid.isEditMode()){
                                alert("不能对多重选择区域执行此操作，请选择单个区域，然后再试");
                            }
                            else{
                                jfgrid.tooltip.info("不能对多重选择区域执行此操作，请选择单个区域，然后再试", "");
                            }
                            return;
                        }

                        var range = $.extend(true, {}, jfgird_select_save[0]);

                        var isExists = jfgrid.alternateformat.rangeIsExists(range)[0];
                        if(!isExists){
                            jfgrid.alternateformat.modelfocusIndex = 0;
                            jfgrid.alternateformat.new(range);    
                        }

                        jfgrid.alternateformat.init();
                        jfgrid.alternateformat.perfect();
                    });
                }

                var userlen = $(this).outerWidth();
                var tlen = $menuButton.outerWidth();

                var menuleft = $(this).offset().left;
                if(tlen>userlen && (tlen + menuleft)>$("#"+container).width()){
                    menuleft = menuleft - tlen + userlen;
                }

                var offsetTop = $(this).offset().top+26;
                setTimeout(function(){
                    var $input = $("#"+ menuButtonId).find(".jfgrid-color-selected");
                    $input.spectrum("set", $input.val());
                    mouseclickposition($menuButton, menuleft-28, offsetTop, "lefttop");
                }, 1);
                
            });

            
            //背景颜色
            $("#jfgrid-icon-cell-color").click(function(){
                var d = jfgrid.editor.deepCopyFlowData(jfgrid.flowdata);
                var color =  $(this).attr("color");
                if(color == null){
                    color = "#ffffff";
                }
                _this.updateFormat(d, "bg", color);
            });


            $("#jfgrid-icon-cell-color-menu").click(function(){
                var menuButtonId = $(this).attr("id") + "-menuButton";
                var $menuButton = $("#" + menuButtonId);
                
                if($menuButton.length == 0){
                    var subid = "cell-color-self";
                    var coloritem = jfgrid.replaceHtml(_this.coloritem, { "class": "jfgrid-icon-alternateformat", "name": "交替颜色..." });
                    var menu = jfgrid.replaceHtml(_this.color, { "id": menuButtonId, "coloritem": coloritem, "colorself": subid, "sub": "" });
                    
                    $("body").append(menu);
                    $menuButton = $("#" + menuButtonId);

                    $("#" + menuButtonId).find(".jfgrid-color-selected").spectrum({
                        showPalette: true,
                        showPaletteOnly: true,
                        preferredFormat: "hex",
                        clickoutFiresChange: false,
                        showInitial: true,
                        showInput: true,
                        flat: true,
                        hideAfterPaletteSelect: true,
                        showSelectionPalette: true,
                        maxPaletteSize: 8,
                        maxSelectionSize: 8,
                        color: "#fff",
                        cancelText: "取消",
                        chooseText: "确定颜色",
                        togglePaletteMoreText: "自定义",
                        togglePaletteLessText: "收起",
                        togglePaletteOnly: true,
                        clearText: "清除颜色选择",
                        noColorSelectedText: "没有颜色被选择",
                        localStorageKey: "spectrum.bgcolor" + jfgrid.server.gridKey,
                        palette: [
                            ["#000", "#444", "#666", "#999", "#ccc", "#eee", "#f3f3f3", "#fff"],
                            ["#f00", "#f90", "#ff0", "#0f0", "#0ff", "#00f", "#90f", "#f0f"],
                            ["#f4cccc", "#fce5cd", "#fff2cc", "#d9ead3", "#d0e0e3", "#cfe2f3", "#d9d2e9", "#ead1dc"],
                            ["#ea9999", "#f9cb9c", "#ffe599", "#b6d7a8", "#a2c4c9", "#9fc5e8", "#b4a7d6", "#d5a6bd"],
                            ["#e06666", "#f6b26b", "#ffd966", "#93c47d", "#76a5af", "#6fa8dc", "#8e7cc3", "#c27ba0"],
                            ["#c00", "#e69138", "#f1c232", "#6aa84f", "#45818e", "#3d85c6", "#674ea7", "#a64d79"],
                            ["#900", "#b45f06", "#bf9000", "#38761d", "#134f5c", "#0b5394", "#351c75", "#741b47"],
                            ["#600", "#783f04", "#7f6000", "#274e13", "#0c343d", "#073763", "#20124d", "#4c1130"]
                        ],
                        change: function (color) {
                            var $input = $(this);
                            if (color != null) {
                                color = color.toHexString();
                            }
                            else {
                                color = "#fff";
                            }

                            var oldcolor = null;
                            $("#jfgrid-icon-cell-color .jfgrid-color-menu-button-indicator").css("border-bottom-color", color);
                            
                            $("#jfgrid-icon-cell-color").attr("color", color);
                            var d = jfgrid.editor.deepCopyFlowData(jfgrid.flowdata);
                            _this.updateFormat(d, "bg", color);

                            $menuButton.hide();
                            $("#" + container).attr("tabindex", 0).focus();
                        }
                    });

                    $menuButton.find(".jfgrid-color-reset").click(function(){
                        $menuButton.hide();
                        $("#" + container).attr("tabindex", 0).focus();

                        var $input = $("#" + menuButtonId).find(".jfgrid-color-selected");
                        $input.val("#ffffff");
                        $("#jfgrid-icon-cell-color").attr("color", null);
                        $input.spectrum("set", "#ffffff");
                        $("#jfgrid-icon-cell-color .jfgrid-color-menu-button-indicator").css("border-bottom-color", "#ffffff");
                        
                        var d = jfgrid.editor.deepCopyFlowData(jfgrid.flowdata);
                        _this.updateFormat(d, "bg", null);
                    });

                    //交替颜色
                    $menuButton.find(".jfgrid-icon-alternateformat").click(function(){
                        $menuButton.hide();
                        $("#" + container).attr("tabindex", 0).focus();

                        if(jfgird_select_save.length > 1){
                            if(jfgrid.isEditMode()){
                                alert("不能对多重选择区域执行此操作，请选择单个区域，然后再试");
                            }
                            else{
                                jfgrid.tooltip.info("不能对多重选择区域执行此操作，请选择单个区域，然后再试", "");
                            }
                            return;
                        }

                        var range = $.extend(true, {}, jfgird_select_save[0]);

                        var isExists = jfgrid.alternateformat.rangeIsExists(range)[0];
                        if(!isExists){
                            jfgrid.alternateformat.modelfocusIndex = 0;
                            jfgrid.alternateformat.new(range);    
                        }

                        jfgrid.alternateformat.init();
                        jfgrid.alternateformat.perfect();
                    });

                    $("#" + menuButtonId).find(".jfgrid-color-selected").val("#fff");
                }

                var userlen = $(this).outerWidth();
                var tlen = $menuButton.outerWidth();

                var menuleft = $(this).offset().left;
                if(tlen > userlen && (tlen + menuleft) > $("#" + container).width()){
                    menuleft = menuleft - tlen + userlen;
                }

                var offsetTop = $(this).offset().top + 26;
                setTimeout(function(){
                    var $input = $("#"+ menuButtonId).find(".jfgrid-color-selected");
                    $input.spectrum("set", $input.val());
                    mouseclickposition($menuButton, menuleft - 28, offsetTop, "lefttop");
                }, 1);
            });
    

            //字体大小
            var jfgrid_fs_setTimeout = null;
            $("#jfgrid-icon-font-size").click(function(){
                var menuButtonId = $(this).attr("id") + "-menuButton";
                var $menuButton = $("#" + menuButtonId);
                
                if($menuButton.length == 0){
                    var itemdata = [
                        { "text": "9", "value": "9", "example": "" },
                        { "text": "10", "value": "10", "example": "" },
                        { "text": "11", "value": "11", "example": "" },
                        { "text": "12", "value": "12", "example": "" },
                        { "text": "14", "value": "14", "example": "" },
                        { "text": "16", "value": "16", "example": "" },
                        { "text": "18", "value": "18", "example": "" },
                        { "text": "20", "value": "20", "example": "" },
                        { "text": "22", "value": "22", "example": "" },
                        { "text": "24", "value": "24", "example": "" },
                        { "text": "26", "value": "26", "example": "" },
                        { "text": "28", "value": "28", "example": "" },
                        { "text": "36", "value": "36", "example": "" },
                        { "text": "48", "value": "48", "example": "" },
                        { "text": "72", "value": "72", "example": "" }
                    ];

                    var itemset = _this.createButtonMenu(itemdata);

                    var menu = jfgrid.replaceHtml(_this.menu, { "id": "font-size", "item": itemset, "subclass": "", "sub": "" });

                    $("body").append(menu);
                    $menuButton = $("#" + menuButtonId).width(150);
                    _this.focus($menuButton, 10);

                    $menuButton.find(".jfgrid-cols-menuitem").click(function(){
                        $menuButton.hide();
                        $("#" + container).attr("tabindex", 0).focus();

                        var $t = $(this), itemvalue = $t.attr("itemvalue"), $input = $("#jfgrid-icon-font-size input");
                        $("#jfgrid-icon-font-size").attr("itemvalue", itemvalue);
                        _this.focus($menuButton, itemvalue);
                        $input.val(itemvalue);

                        var d = jfgrid.editor.deepCopyFlowData(jfgrid.flowdata);
                        _this.updateFormat(d, "fs", itemvalue);
                        
                        clearTimeout(jfgrid_fs_setTimeout);
                    });
                }

                var userlen = $(this).outerWidth();
                var tlen = $menuButton.outerWidth();

                var defualtvalue = $("#jfgrid-icon-font-size").attr("itemvalue");
                if(defualtvalue == null){
                    defualtvalue = 10;
                }
                _this.focus($menuButton, defualtvalue);

                var menuleft = $(this).offset().left;
                if(tlen > userlen && (tlen + menuleft) > $("#" + container).width()){
                    menuleft = menuleft - tlen + userlen;
                }
                mouseclickposition($menuButton, menuleft, $(this).offset().top + 25, "lefttop");
            })
            // .find("input.jfgrid-toolbar-textinput").blur(function(){
            //     var itemvalue = parseInt($(this).val());
            //     var $menuButton = $("#jfgrid-icon-font-size-menuButton");
            //     _this.focus($menuButton, itemvalue);
            //     var d = jfgrid.editor.deepCopyFlowData(jfgrid.flowdata);
            //     _this.updateFormat(d, "fs", itemvalue);
            //     jfgrid_fs_setTimeout = setTimeout(function(){
            //         $menuButton.hide();
            //     }, 200);
            // });

            //边框设置
            $("#jfgrid-icon-border-all").click(function(){
                var d = jfgrid.editor.deepCopyFlowData(jfgrid.flowdata);

                var type = $(this).attr("type");
                if(type == null){
                    type = "border-all";
                }

                var subcolormenuid = "jfgrid-icon-borderColor-menuButton";
                var color = $("#" + subcolormenuid).find(".jfgrid-color-selected").val();
                var style = $("#jfgridborderSizepreview").attr("itemvalue");

                if(color == null || color == ""){
                    color = "#000";
                }

                if(style == null || style == ""){
                    style = "1";
                }

                var cfg = $.extend(true, {}, config);
                if(cfg["borderInfo"] == null){
                    cfg["borderInfo"] = [];
                }

                var borderInfo = {
                    "rangeType": "range",
                    "borderType": type,
                    "color": color,
                    "style": style,
                    "range": jfgird_select_save
                }

                cfg["borderInfo"].push(borderInfo);

                if (clearjfundo) {
                    jfgrid.jfundo = [];

                    var redo = [];

                    redo["type"] = "borderChange";

                    redo["config"] = $.extend(true, {}, config);
                    redo["curconfig"] = $.extend(true, {}, cfg);
                    
                    redo["sheetIndex"] = jfgrid.currentSheetIndex;

                    jfgrid.jfredo.push(redo);
                }

                jfgrid.server.saveParam("cg", jfgrid.currentSheetIndex, cfg["borderInfo"], { "k": "borderInfo" });

                config = cfg;
                jfgridfile[jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex)].config = config;

                setTimeout(function () {
                    jfgrid.jfgridrefreshgrid();
                }, 1);
            });

            $("#jfgrid-icon-border-menu").click(function(){
                var menuButtonId = $(this).attr("id") + "-menuButton";
                var $menuButton = $("#" + menuButtonId);

                if($menuButton.length == 0){
                    var canvasH = 10, canvasW = 120;

                    var itemdata = [
                        {"text": "上框线", "value": "border-top", "example": '<div class="jfgrid-icon jfgrid-inline-block jfgrid-material-icon jfgrid-mousedown-cancel" style="user-select: none;opacity:1;"> <div aria-hidden="true" class="jfgrid-icon-img-container jfgrid-icon-img jfgrid-icon-border-top" style="user-select: none;"> </div> </div>'},
                        {"text": "下框线", "value":"border-bottom", "example": '<div class="jfgrid-icon jfgrid-inline-block jfgrid-material-icon jfgrid-mousedown-cancel" style="user-select: none;opacity:1;"> <div aria-hidden="true" class="jfgrid-icon-img-container jfgrid-icon-img jfgrid-icon-border-bottom" style="user-select: none;"> </div> </div>'},
                        {"text": "左框线", "value":"border-left", "example": '<div class="jfgrid-icon jfgrid-inline-block jfgrid-material-icon jfgrid-mousedown-cancel" style="user-select: none;opacity:1;"> <div aria-hidden="true" class="jfgrid-icon-img-container jfgrid-icon-img jfgrid-icon-border-left" style="user-select: none;"> </div> </div>'},
                        {"text": "右框线", "value":"border-right", "example": '<div class="jfgrid-icon jfgrid-inline-block jfgrid-material-icon jfgrid-mousedown-cancel" style="user-select: none;opacity:1;"> <div aria-hidden="true" class="jfgrid-icon-img-container jfgrid-icon-img jfgrid-icon-border-right" style="user-select: none;"> </div> </div>'},
                        {"text": "", "value": "split", "example":""},
                        {"text": "无", "value": "border-none", "example": '<div class="jfgrid-icon jfgrid-inline-block jfgrid-material-icon jfgrid-mousedown-cancel" style="user-select: none;opacity:1;"> <div aria-hidden="true" class="jfgrid-icon-img-container jfgrid-icon-img jfgrid-icon-border-none" style="user-select: none;"> </div> </div>'},
                        {"text": "所有", "value": "border-all", "example": '<div class="jfgrid-icon jfgrid-inline-block jfgrid-material-icon jfgrid-mousedown-cancel" style="user-select: none;opacity:1;"> <div aria-hidden="true" class="jfgrid-icon-img-container jfgrid-icon-img jfgrid-icon-border-all" style="user-select: none;"> </div> </div>'},
                        {"text": "外侧", "value": "border-outside", "example": '<div class="jfgrid-icon jfgrid-inline-block jfgrid-material-icon jfgrid-mousedown-cancel" style="user-select: none;opacity:1;"> <div aria-hidden="true" class="jfgrid-icon-img-container jfgrid-icon-img jfgrid-icon-border-outside" style="user-select: none;"> </div> </div>'},
                        {"text": "", "value": "split", "example": ""},
                        {"text": "内侧", "value": "border-inside", "example": '<div class="jfgrid-icon jfgrid-inline-block jfgrid-material-icon jfgrid-mousedown-cancel" style="user-select: none;opacity:1;"> <div aria-hidden="true" class="jfgrid-icon-img-container jfgrid-icon-img jfgrid-icon-border-inside" style="user-select: none;"> </div> </div>'},
                        {"text": "内侧横线", "value": "border-horizontal", "example": '<div class="jfgrid-icon jfgrid-inline-block jfgrid-material-icon jfgrid-mousedown-cancel" style="user-select: none;opacity:1;"> <div aria-hidden="true" class="jfgrid-icon-img-container jfgrid-icon-img jfgrid-icon-border-horizontal" style="user-select: none;"> </div> </div>'},
                        {"text": "内侧竖线", "value": "border-vertical", "example": '<div class="jfgrid-icon jfgrid-inline-block jfgrid-material-icon jfgrid-mousedown-cancel" style="user-select: none;opacity:1;"> <div aria-hidden="true" class="jfgrid-icon-img-container jfgrid-icon-img jfgrid-icon-border-vertical" style="user-select: none;"> </div> </div>'},
                        {"text": "", "value": "split", "example": ""},
                        {"text": "<span id='jfgrid-icon-borderColor-linecolor' class='jfgrid-mousedown-cancel' style='border-bottom:3px solid #000;'>边框颜色</span>", "value":"borderColor", "example":"more"},
                        {"text": "边框粗细<img id='jfgridborderSizepreview' width=100 height=10 src='data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==' style='position:absolute;bottom:-5px;right:0px;width:100px;height:10px;'>", "value":"borderSize", "example":"more"}
                    ];

                    var itemset = _this.createButtonMenu(itemdata);

                    var menu = jfgrid.replaceHtml(_this.menu, { "id": "border-menu", "item": itemset, "subclass": "", "sub": "" });

                    var subitemdata = [
                        {"text": "无边框", "value": "0", "example": ""},
                        {"text": "<canvas type='Thin' class='border-Thin' width="+ canvasW +" height="+ canvasH +" style='width:"+ canvasW +"px;height:"+ canvasH +"px;position:static;'></canvas>", "value": "1", "example": ""},
                        {"text": "<canvas type='Hair' class='border-Hair' width="+ canvasW +" height="+ canvasH +" style='width:"+ canvasW +"px;height:"+ canvasH +"px;position:static;'></canvas>", "value": "2", "example": ""},
                        {"text": "<canvas type='Dotted' class='border-Dotted' width="+ canvasW +" height="+ canvasH +" style='width:"+ canvasW +"px;height:"+ canvasH +"px;position:static;'></canvas>", "value": "3", "example": ""},
                        {"text": "<canvas type='Dashed' class='border-Dashed' width="+ canvasW +" height="+ canvasH +" style='width:"+ canvasW +"px;height:"+ canvasH +"px;position:static;'></canvas>", "value": "4", "example": ""},
                        {"text": "<canvas type='DashDot' class='border-DashDot' width="+ canvasW +" height="+ canvasH +" style='width:"+ canvasW +"px;height:"+ canvasH +"px;position:static;'></canvas>", "value": "5", "example": ""},
                        {"text": "<canvas type='DashDotDot' class='border-DashDotDot' width="+ canvasW +" height="+ canvasH +" style='width:"+ canvasW +"px;height:"+ canvasH +"px;position:static;'></canvas>", "value": "6", "example": ""},
                        // {"text":"<canvas type='Double' class='border-Double' width="+ canvasW +" height="+ canvasH +" style='width:"+ canvasW +"px;height:"+ canvasH +"px;position:static;'></canvas>", "value":"7", "example":""},
                        {"text": "<canvas type='Medium' class='border-Medium' width="+ canvasW +" height="+ canvasH +" style='width:"+ canvasW +"px;height:"+ canvasH +"px;position:static;'></canvas>", "value": "8", "example": ""},
                        {"text": "<canvas type='MediumDashed' class='border-MediumDashed' width="+ canvasW +" height="+ canvasH +" style='width:"+ canvasW +"px;height:"+ canvasH +"px;position:static;'></canvas>", "value": "9", "example": ""},
                        {"text": "<canvas type='MediumDashDot' class='border-MediumDashDot' width="+ canvasW +" height="+ canvasH +" style='width:"+ canvasW +"px;height:"+ canvasH +"px;position:static;'></canvas>", "value": "10", "example": ""},
                        {"text": "<canvas type='MediumDashDotDot' class='border-MediumDashDotDot' width="+ canvasW +" height="+ canvasH +" style='width:"+ canvasW +"px;height:"+ canvasH +"px;position:static;'></canvas>", "value": "11", "example": ""},
                        // {"text":"<canvas type='SlantedDashDot' class='border-SlantedDashDot' width="+ canvasW +" height="+ canvasH +" style='width:"+ canvasW +"px;height:"+ canvasH +"px;position:static;'></canvas>", "value":"12", "example":""},
                        {"text": "<canvas type='Thick' class='border-Thick' width="+ canvasW +" height="+ canvasH +" style='width:"+ canvasW +"px;height:"+ canvasH +"px;position:static;'></canvas>", "value": "13", "example": ""}
                    ];

                    var subitemset = _this.createButtonMenu(subitemdata);
                    var submenu = jfgrid.replaceHtml(_this.menu, { "id": "borderSize", "item": subitemset, "subclass": "jfgrid-menuButton-sub" });
                    var submenuid = "jfgrid-icon-borderSize-menuButton";
                    var subcolormenuid = "jfgrid-icon-borderColor-menuButton";
                    var colormenu = jfgrid.replaceHtml(_this.color, { "id": subcolormenuid, "coloritem": "", "colorself": "", "sub": "jfgrid-menuButton-sub" });

                    $("body").append(menu + colormenu + submenu);
                    $menuButton = $("#" + menuButtonId).width(150);
                    _this.focus($menuButton, "border-all");

                    $("#" + submenuid + " canvas").each(function(i){
                        var type = $(this).attr("type");
                        var itemvalue = $(this).closest(".jfgrid-cols-menuitem").attr("itemvalue");
                        var canvasborder = $(this).addClass("jfgrid-mousedown-cancel").get(0).getContext("2d");
                        canvasborder.translate(0.5, 0.5);

                        _this.setLineDash(canvasborder, itemvalue, "h", 0, 5, 100, 5);
                        
                        canvasborder.strokeStyle = "#000000";
                        canvasborder.stroke();
                        canvasborder.closePath();
                    });

                    $("#" + submenuid + " .jfgrid-cols-menuitem").click(function(){
                        $("#"+ submenuid).hide();

                        var $t = $(this), 
                            itemvalue = $t.attr("itemvalue");
                        
                        if(itemvalue == 0){
                            $("#jfgridborderSizepreview").attr("src", "data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==").attr("itemvalue", null);
                        }
                        else{
                            var bg = $t.find("canvas").get(0).toDataURL("image/png");
                            $("#jfgridborderSizepreview").attr("src", bg).attr("itemvalue", itemvalue);
                        }
                        
                        _this.focus($("#" + submenuid), itemvalue);
                    });

                    $menuButton.find(".jfgrid-cols-menuitem").click(function(){
                        $menuButton.hide();
                        $("#" + container).attr("tabindex", 0).focus();

                        var $t = $(this), itemvalue = $t.attr("itemvalue");
                        if(itemvalue == "borderColor" || itemvalue == "borderSize"){
                            return;
                        }

                        var d = jfgrid.editor.deepCopyFlowData(jfgrid.flowdata);

                        var color = $("#"+ subcolormenuid).find(".jfgrid-color-selected").val();
                        var style = $("#jfgridborderSizepreview").attr("itemvalue");

                        if(color == null || color == ""){
                            color = "#000";
                        }

                        if(style == null || style == ""){
                            style = "1";
                        }

                        var cfg = $.extend(true, {}, config);
                        if(cfg["borderInfo"] == null){
                            cfg["borderInfo"] = [];
                        }

                        var borderInfo = {
                            "rangeType": "range",
                            "borderType": itemvalue,
                            "color": color,
                            "style": style,
                            "range": jfgird_select_save
                        }

                        cfg["borderInfo"].push(borderInfo);

                        if (clearjfundo) {
                            jfgrid.jfundo = [];

                            var redo = [];

                            redo["type"] = "borderChange";

                            redo["config"] = $.extend(true, {}, config);
                            redo["curconfig"] = $.extend(true, {}, cfg);
                            
                            redo["sheetIndex"] = jfgrid.currentSheetIndex;

                            jfgrid.jfredo.push(redo);
                        }

                        jfgrid.server.saveParam("cg", jfgrid.currentSheetIndex, cfg["borderInfo"], { "k": "borderInfo" });

                        config = cfg;
                        jfgridfile[jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex)].config = config;

                        setTimeout(function () {
                            jfgrid.jfgridrefreshgrid();
                        }, 1);

                        $("#jfgrid-icon-border-all").attr("type", itemvalue);

                        var $icon = $("#jfgrid-icon-border-all").find(".jfgrid-icon-img-container");
                        $icon.removeAttr("class").addClass("jfgrid-icon-img-container jfgrid-icon-img jfgrid-icon-" + itemvalue);

                        _this.focus($menuButton, itemvalue);
                    });


                    $("#" + subcolormenuid).find(".jfgrid-color-selected").spectrum({
                        showPalette: true,
                        showPaletteOnly: true,
                        preferredFormat: "hex",
                        clickoutFiresChange: false,
                        showInitial: true,
                        showInput: true,
                        flat: true,
                        hideAfterPaletteSelect: true,
                        showSelectionPalette: true,
                        maxPaletteSize: 8,
                        maxSelectionSize: 8,
                        color: "#000",
                        cancelText: "取消",
                        chooseText: "确定颜色",
                        togglePaletteMoreText: "自定义",
                        togglePaletteLessText: "收起",
                        togglePaletteOnly: true,
                        clearText: "清除颜色选择",
                        noColorSelectedText: "没有颜色被选择",
                        localStorageKey: "spectrum.bordercolor" + jfgrid.server.gridKey,
                        palette: [
                            ["#000", "#444", "#666", "#999", "#ccc", "#eee", "#f3f3f3", "#fff"],
                            ["#f00", "#f90", "#ff0", "#0f0", "#0ff", "#00f", "#90f", "#f0f"],
                            ["#f4cccc", "#fce5cd", "#fff2cc", "#d9ead3", "#d0e0e3", "#cfe2f3", "#d9d2e9", "#ead1dc"],
                            ["#ea9999", "#f9cb9c", "#ffe599", "#b6d7a8", "#a2c4c9", "#9fc5e8", "#b4a7d6", "#d5a6bd"],
                            ["#e06666", "#f6b26b", "#ffd966", "#93c47d", "#76a5af", "#6fa8dc", "#8e7cc3", "#c27ba0"],
                            ["#c00", "#e69138", "#f1c232", "#6aa84f", "#45818e", "#3d85c6", "#674ea7", "#a64d79"],
                            ["#900", "#b45f06", "#bf9000", "#38761d", "#134f5c", "#0b5394", "#351c75", "#741b47"],
                            ["#600", "#783f04", "#7f6000", "#274e13", "#0c343d", "#073763", "#20124d", "#4c1130"]
                        ],
                        change: function (color) {
                            var $input = $(this);
                            if (color != null) {
                                color = color.toHexString();
                            }
                            else {
                                color = "#000";
                            }

                            var oldcolor = null;
                            $("#jfgrid-icon-borderColor-linecolor").css("border-bottom-color", color);
                            $("#"+ subcolormenuid).find(".jfgrid-color-selected").val(color);
                        }
                    });

                    $("#"+ subcolormenuid).find(".jfgrid-color-reset").click(function(){
                        var $input = $("#"+ subcolormenuid).find(".jfgrid-color-selected");
                        $input.val("#000");
                        $("#jfgrid-icon-cell-color").attr("color", null);
                        $input.spectrum("set", "#000");
                        $("#jfgrid-icon-borderColor-linecolor").css("border-bottom-color", "#000");
                        // var d = jfgrid.editor.deepCopyFlowData(jfgrid.flowdata);
                        // _this.updateFormat(d, "bg", null);
                        // $menuButton.hide();
                    });
                }

                var userlen = $(this).outerWidth();
                var tlen = $menuButton.outerWidth();

                var menuleft = $(this).offset().left;
                if(tlen>userlen && (tlen + menuleft)>$("#"+container).width()){
                    menuleft = menuleft - tlen + userlen;
                }
                mouseclickposition($menuButton, menuleft-28, $(this).offset().top+25, "lefttop");
            });

            //合并单元格
            $("#jfgrid-icon-merge-button").click(function(){
                if(jfgrid.selectIsOverlap()){
                    if(jfgrid.isEditMode()){
                        alert("不能合并重叠区域");
                    }
                    else{
                        jfgrid.tooltip.info("不能合并重叠区域", "");
                    }
                    return;
                }

                if(config["merge"] != null){
                    var hasPartMC = false;

                    for(var s = 0; s < jfgird_select_save.length; s++){
                        var r1 = jfgird_select_save[s].row[0], r2 = jfgird_select_save[s].row[1];
                        var c1 = jfgird_select_save[s].column[0], c2 = jfgird_select_save[s].column[1];

                        hasPartMC = jfgrid.hasPartMC(config, r1, r2, c1, c2);

                        if(hasPartMC){
                            break;
                        }
                    }

                    if(hasPartMC){
                        if(jfgrid.isEditMode()){
                            alert("无法对部分合并单元格执行此操作");
                        }
                        else{
                            jfgrid.tooltip.info("无法对部分合并单元格执行此操作", ""); 
                        }
                        return;    
                    }
                }

                var d = jfgrid.editor.deepCopyFlowData(jfgrid.flowdata);
                _this.updateFormat_mc(d, "mergeAll");
            });

            $("#jfgrid-icon-merge-menu").click(function(){
                var menuButtonId = $(this).attr("id") + "-menuButton";
                var $menuButton = $("#" + menuButtonId);
                
                if($menuButton.length == 0){
                    var itemdata = [
                        {"text": "全部合并", "value": "mergeAll", "example": ""},
                        {"text": "垂直合并", "value": "mergeV", "example": ""},
                        {"text": "水平合并", "value": "mergeH", "example": ""},
                        {"text": "取消合并", "value": "mergeCancel", "example": ""}
                    ];

                    var itemset = _this.createButtonMenu(itemdata);

                    var menu = jfgrid.replaceHtml(_this.menu, { "id": "merge-menu", "item": itemset, "subclass": "", "sub": "" });

                    $("body").append(menu);
                    $menuButton = $("#"+menuButtonId).width(100);
                    _this.focus($menuButton);

                    $menuButton.find(".jfgrid-cols-menuitem").click(function(){
                        $menuButton.hide();
                        $("#" + container).attr("tabindex", 0).focus();

                        if(jfgrid.selectIsOverlap()){
                            if(jfgrid.isEditMode()){
                                alert("不能合并重叠区域");
                            }
                            else{
                                jfgrid.tooltip.info("不能合并重叠区域", "");
                            }
                            return;
                        }

                        if(config["merge"] != null){
                            var hasPartMC = false;

                            for(var s = 0; s < jfgird_select_save.length; s++){
                                var r1 = jfgird_select_save[s].row[0], r2 = jfgird_select_save[s].row[1];
                                var c1 = jfgird_select_save[s].column[0], c2 = jfgird_select_save[s].column[1];

                                hasPartMC = jfgrid.hasPartMC(config, r1, r2, c1, c2);

                                if(hasPartMC){
                                    break;
                                }
                            }

                            if(hasPartMC){
                                if(jfgrid.isEditMode()){
                                    alert("无法对部分合并单元格执行此操作");
                                }
                                else{
                                    jfgrid.tooltip.info("无法对部分合并单元格执行此操作", ""); 
                                }
                                return;    
                            }
                        }

                        var $t = $(this), itemvalue = $t.attr("itemvalue");
                        _this.focus($menuButton, itemvalue);

                        var d = jfgrid.editor.deepCopyFlowData(jfgrid.flowdata);
                        _this.updateFormat_mc(d, itemvalue);
                    });
                }

                var userlen = $(this).outerWidth();
                var tlen = $menuButton.outerWidth();

                var menuleft = $(this).offset().left;
                if(tlen > userlen && (tlen + menuleft) > $("#" + container).width()){
                    menuleft = menuleft - tlen + userlen;
                }
                mouseclickposition($menuButton, menuleft - 28, $(this).offset().top + 25, "lefttop");
            });

            //水平对齐
            $("#jfgrid-icon-align").click(function(){
            	var itemvalue = $("#jfgrid-icon-align").attr("type");
            	if(itemvalue == null){
            		itemvalue = "left";
            	}

                var d = jfgrid.editor.deepCopyFlowData(jfgrid.flowdata);
                _this.updateFormat(d, "ht", itemvalue);
            });

            $("#jfgrid-icon-align-menu").click(function(){
                var menuButtonId = $(this).attr("id") + "-menuButton";
                var $menuButton = $("#" + menuButtonId);
                
                if($menuButton.length == 0){
                    var itemdata = [
                        {"text": "左对齐", "value": "left", "example": '<div class="jfgrid-icon jfgrid-inline-block" style="user-select: none;opacity:1;"> <div aria-hidden="true" class="jfgrid-icon-img-container jfgrid-icon-img jfgrid-icon-align-left" style="user-select: none;"> </div> </div>'},
                        {"text": "中间对齐", "value": "center", "example": '<div class="jfgrid-icon jfgrid-inline-block" style="user-select: none;opacity:1;"> <div aria-hidden="true" class="jfgrid-icon-img-container jfgrid-icon-img jfgrid-icon-align-center" style="user-select: none;"> </div> </div>'},
                        {"text": "右对齐", "value": "right", "example": '<div class="jfgrid-icon jfgrid-inline-block" style="user-select: none;opacity:1;"> <div aria-hidden="true" class="jfgrid-icon-img-container jfgrid-icon-img jfgrid-icon-align-right" style="user-select: none;"> </div> </div>'}
                    ];

                    var itemset = _this.createButtonMenu(itemdata);

                    var menu = jfgrid.replaceHtml(_this.menu, { "id": "align-menu", "item": itemset, "subclass": "", "sub": "" });

                    $("body").append(menu);
                    $menuButton = $("#" + menuButtonId).width(120);
                    _this.focus($menuButton);

                    $menuButton.find(".jfgrid-cols-menuitem").click(function(){
                        $menuButton.hide();
                        $("#" + container).attr("tabindex", 0).focus();

                        var $t = $(this), itemvalue = $t.attr("itemvalue");
                        _this.focus($menuButton, itemvalue);

                        var $icon = $("#jfgrid-icon-align").attr("type", itemvalue).find(".jfgrid-icon-img-container");
                        $icon.removeAttr("class").addClass("jfgrid-icon-img-container jfgrid-icon-img jfgrid-icon-align-" + itemvalue);

                        var d = jfgrid.editor.deepCopyFlowData(jfgrid.flowdata);
                        _this.updateFormat(d, "ht", itemvalue);
                    });
                }

                var userlen = $(this).outerWidth();
                var tlen = $menuButton.outerWidth();

                var menuleft = $(this).offset().left;
                if(tlen > userlen && (tlen + menuleft) > $("#" + container).width()){
                    menuleft = menuleft - tlen + userlen;
                }
                mouseclickposition($menuButton, menuleft - 28, $(this).offset().top + 25, "lefttop");
            });

            //垂直对齐
            $("#jfgrid-icon-valign").click(function(){
            	var itemvalue = $("#jfgrid-icon-valign").attr("type");
            	if(itemvalue == null){
            		itemvalue = "bottom";
            	}

                var d = jfgrid.editor.deepCopyFlowData(jfgrid.flowdata);
                _this.updateFormat(d, "vt", itemvalue);
            });

            $("#jfgrid-icon-valign-menu").click(function(){
                var menuButtonId = $(this).attr("id") + "-menuButton";
                var $menuButton = $("#" + menuButtonId);
                
                if($menuButton.length == 0){
                    var itemdata = [
                        {"text": "顶部对齐", "value": "top", "example": '<div class="jfgrid-icon jfgrid-inline-block" style="user-select: none;opacity:1;"> <div aria-hidden="true" class="jfgrid-icon-img-container jfgrid-icon-img jfgrid-icon-valign-top" style="user-select: none;"> </div> </div>'},
                        {"text": "居中对齐", "value": "middle", "example": '<div class="jfgrid-icon jfgrid-inline-block" style="user-select: none;opacity:1;"> <div aria-hidden="true" class="jfgrid-icon-img-container jfgrid-icon-img jfgrid-icon-valign-middle" style="user-select: none;"> </div> </div>'},
                        {"text": "底部对齐", "value": "bottom", "example": '<div class="jfgrid-icon jfgrid-inline-block" style="user-select: none;opacity:1;"> <div aria-hidden="true" class="jfgrid-icon-img-container jfgrid-icon-img jfgrid-icon-valign-bottom" style="user-select: none;"> </div> </div>'}
                    ];

                    var itemset = _this.createButtonMenu(itemdata);

                    var menu = jfgrid.replaceHtml(_this.menu, { "id": "valign-menu", "item": itemset, "subclass": "", "sub": "" });

                    $("body").append(menu);
                    $menuButton = $("#" + menuButtonId).width(120);
                    _this.focus($menuButton, "bottom");

                    $menuButton.find(".jfgrid-cols-menuitem").click(function(){
                        $menuButton.hide();
                        $("#" + container).attr("tabindex", 0).focus();

                        var $t = $(this), itemvalue = $t.attr("itemvalue");
                        _this.focus($menuButton, itemvalue);

                        var $icon = $("#jfgrid-icon-valign").attr("type", itemvalue).find(".jfgrid-icon-img-container");
                        $icon.removeAttr("class").addClass("jfgrid-icon-img-container jfgrid-icon-img jfgrid-icon-valign-" + itemvalue);

                        var d = jfgrid.editor.deepCopyFlowData(jfgrid.flowdata);
                        _this.updateFormat(d, "vt", itemvalue);
                    });
                }

                var userlen = $(this).outerWidth();
                var tlen = $menuButton.outerWidth();

                var menuleft = $(this).offset().left;
                if(tlen > userlen && (tlen + menuleft) > $("#" + container).width()){
                    menuleft = menuleft - tlen + userlen;
                }
                mouseclickposition($menuButton, menuleft - 28, $(this).offset().top + 25, "lefttop");
            });

            //文本换行
            $("#jfgrid-icon-textwrap-menu").click(function(){
                var menuButtonId = $(this).attr("id") + "-menuButton";
                var $menuButton = $("#" + menuButtonId);
                
                if($menuButton.length == 0){
                    var itemdata = [
                        {"text": "溢出", "value": "overflow", "example": '<div class="jfgrid-icon jfgrid-inline-block" style="user-select: none;opacity:1;"> <div aria-hidden="true" class="jfgrid-icon-img-container jfgrid-icon-img jfgrid-icon-textwrap-overflow" style="user-select: none;"> </div> </div>'},
                        {"text": "自动换行", "value": "wrap", "example": '<div class="jfgrid-icon jfgrid-inline-block" style="user-select: none;opacity:1;"> <div aria-hidden="true" class="jfgrid-icon-img-container jfgrid-icon-img jfgrid-icon-textwrap-wrap" style="user-select: none;"> </div> </div>'},
                        {"text": "截断", "value": "clip", "example": '<div class="jfgrid-icon jfgrid-inline-block" style="user-select: none;opacity:1;"> <div aria-hidden="true" class="jfgrid-icon-img-container jfgrid-icon-img jfgrid-icon-textwrap-clip" style="user-select: none;"> </div> </div>'}
                    ];

                    var itemset = _this.createButtonMenu(itemdata);

                    var menu = jfgrid.replaceHtml(_this.menu, { "id": "textwrap-menu", "item": itemset, "subclass": "", "sub": "" });

                    $("body").append(menu);
                    $menuButton = $("#" + menuButtonId).width(120);
                    _this.focus($menuButton);

                    $menuButton.find(".jfgrid-cols-menuitem").click(function(){
                        $menuButton.hide();
                        $("#" + container).attr("tabindex", 0).focus();

                        var $t = $(this), itemvalue = $t.attr("itemvalue");
                        _this.focus($menuButton, itemvalue);

                        var $icon = $("#jfgrid-icon-textwrap").attr("type", itemvalue).find(".jfgrid-icon-img-container");
                        $icon.removeAttr("class").addClass("jfgrid-icon-img-container jfgrid-icon-img jfgrid-icon-textwrap-" + itemvalue);

                        var d = jfgrid.editor.deepCopyFlowData(jfgrid.flowdata);
                        _this.updateFormat(d, "tb", itemvalue);
                    });
                }

                var userlen = $(this).outerWidth();
                var tlen = $menuButton.outerWidth();

                var menuleft = $(this).offset().left;
                if(tlen > userlen && (tlen + menuleft) > $("#" + container).width()){
                    menuleft = menuleft - tlen + userlen;
                }
                mouseclickposition($menuButton, menuleft - 28, $(this).offset().top + 25, "lefttop");
            });

            //文本旋转
            $("#jfgrid-icon-rotation-menu").click(function(){
                var menuButtonId = $(this).attr("id") + "-menuButton";
                var $menuButton = $("#" + menuButtonId);
                
                if($menuButton.length == 0){
                    var itemdata = [
                        {"text": "无旋转", "value": "none", "example": '<div class="jfgrid-icon jfgrid-inline-block" style="user-select: none;opacity:1;"> <div aria-hidden="true" class="jfgrid-icon-img-container jfgrid-icon-img jfgrid-icon-rotation-none" style="user-select: none;"> </div> </div>'},
                        {"text": "向上倾斜", "value": "angleup", "example": '<div class="jfgrid-icon jfgrid-inline-block" style="user-select: none;opacity:1;"> <div aria-hidden="true" class="jfgrid-icon-img-container jfgrid-icon-img jfgrid-icon-rotation-angleup" style="user-select: none;"> </div> </div>'},
                        {"text": "向下倾斜", "value": "angledown", "example": '<div class="jfgrid-icon jfgrid-inline-block" style="user-select: none;opacity:1;"> <div aria-hidden="true" class="jfgrid-icon-img-container jfgrid-icon-img jfgrid-icon-rotation-angledown" style="user-select: none;"> </div> </div>'},
                        {"text": "竖排文字", "value": "vertical", "example": '<div class="jfgrid-icon jfgrid-inline-block" style="user-select: none;opacity:1;"> <div aria-hidden="true" class="jfgrid-icon-img-container jfgrid-icon-img jfgrid-icon-rotation-vertical" style="user-select: none;"> </div> </div>'},
                        {"text": "向上90°", "value": "rotation-up", "example": '<div class="jfgrid-icon jfgrid-inline-block" style="user-select: none;opacity:1;"> <div aria-hidden="true" class="jfgrid-icon-img-container jfgrid-icon-img jfgrid-icon-rotation-rotation-up" style="user-select: none;"> </div> </div>'},
                        {"text": "向下90°", "value": "rotation-down", "example": '<div class="jfgrid-icon jfgrid-inline-block" style="user-select: none;opacity:1;"> <div aria-hidden="true" class="jfgrid-icon-img-container jfgrid-icon-img jfgrid-icon-rotation-rotation-down" style="user-select: none;"> </div> </div>'},
                    ];

                    var itemset = _this.createButtonMenu(itemdata);

                    var menu = jfgrid.replaceHtml(_this.menu, { "id": "rotation-menu", "item": itemset, "subclass": "", "sub": "" });

                    $("body").append(menu);
                    $menuButton = $("#" + menuButtonId).width(120);
                    _this.focus($menuButton);

                    $menuButton.find(".jfgrid-cols-menuitem").click(function(){
                        $menuButton.hide();
                        $("#" + container).attr("tabindex", 0).focus();

                        var $t = $(this), itemvalue = $t.attr("itemvalue");
                        _this.focus($menuButton, itemvalue);

                        var $icon = $("#jfgrid-icon-rotation").attr("type", itemvalue).find(".jfgrid-icon-img-container");
                        $icon.removeAttr("class").addClass("jfgrid-icon-img-container jfgrid-icon-img jfgrid-icon-rotation-" + itemvalue);
                        
                        var d = jfgrid.editor.deepCopyFlowData(jfgrid.flowdata);
                        _this.updateFormat(d, "tr", itemvalue);
                    });
                }

                var userlen = $(this).outerWidth();
                var tlen = $menuButton.outerWidth();

                var menuleft = $(this).offset().left;
                if(tlen > userlen && (tlen + menuleft) > $("#" + container).width()){
                    menuleft = menuleft - tlen + userlen;
                }
                mouseclickposition($menuButton, menuleft - 28, $(this).offset().top + 25, "lefttop");
            });

            //冻结行列
            $("#jfgrid-icon-freezen-menu").click(function(){
                var menuButtonId = $(this).attr("id") + "-menuButton";
                var $menuButton = $("#" + menuButtonId);
                
                if($menuButton.length == 0){
                    var itemdata = [
                        {"text": "冻结首行", "value": "freezenRow", "example": ''},
                        {"text": "冻结首列", "value": "freezenColumn", "example": ''},
                        {"text": "冻结行列", "value": "freezenRC", "example": ''},
                        {"text": "", "value": "split", "example": ""},
                        {"text": "冻结行到选区", "value": "freezenRowRange", "example": ''},
                        {"text": "冻结列到选区", "value": "freezenColumnRange", "example": ''},
                        {"text": "冻结行列到选区", "value": "freezenRCRange", "example": ''},
                        {"text": "", "value": "split", "example": ""},
                        {"text": "取消冻结", "value": "freezenCancel", "example": ''}
                    ];

                    var itemset = _this.createButtonMenu(itemdata);

                    var menu = jfgrid.replaceHtml(_this.menu, { "id": "freezen-menu", "item": itemset, "subclass": "", "sub": "" });

                    $("body").append(menu);
                    $menuButton = $("#" + menuButtonId).width(130);

                    $menuButton.find(".jfgrid-cols-menuitem").click(function(){
                        $menuButton.hide();
                        $("#" + container).attr("tabindex", 0).focus();

                        var $t = $(this), itemvalue = $t.attr("itemvalue");
                        _this.focus($menuButton, itemvalue);

                        if(itemvalue == "freezenRow"){ //首行冻结
                            var scrollTop = $("#jfgrid-cell-main").scrollTop();
                            var row_st = jfgrid_searcharray(visibledatarow, scrollTop);
                            if(row_st == -1){
                                row_st = 0;
                            }
                            var top = visibledatarow[row_st] - 2 - scrollTop + columeHeaderHeight;
                            var freezenhorizontaldata = [visibledatarow[row_st], row_st + 1, scrollTop, jfgrid.freezen.cutVolumn(visibledatarow, row_st + 1), top];
                            jfgrid.freezen.saveFreezen(freezenhorizontaldata, top, null, null);

                            if (jfgrid.freezen.freezenverticaldata != null) {
                                jfgrid.freezen.cancelFreezenVertical();
                                jfgrid.freezen.createAssistCanvas();
                                jfgrid.jfgridrefreshgrid();
                            }

                            jfgrid.freezen.createFreezenHorizontal(freezenhorizontaldata, top);
                            jfgrid.freezen.createAssistCanvas();
                            jfgrid.jfgridrefreshgrid();
                        }
                        else if(itemvalue == "freezenColumn"){ //首列冻结
                            var scrollLeft = $("#jfgrid-cell-main").scrollLeft();
                            var col_st = jfgrid_searcharray(visibledatacolumn, scrollLeft);
                            if(col_st == -1){
                                col_st = 0;
                            }
                            var left = visibledatacolumn[col_st] - 2 - scrollLeft + rowHeaderWidth;
                            var freezenverticaldata = [visibledatacolumn[col_st], col_st + 1, scrollLeft, jfgrid.freezen.cutVolumn(visibledatacolumn, col_st + 1), left];
                            jfgrid.freezen.saveFreezen(null, null, freezenverticaldata, left);

                            if (jfgrid.freezen.freezenhorizontaldata != null) {
                                jfgrid.freezen.cancelFreezenHorizontal();
                                jfgrid.freezen.createAssistCanvas();
                                jfgrid.jfgridrefreshgrid();
                            }

                            jfgrid.freezen.createFreezenVertical(freezenverticaldata, left);
                            jfgrid.freezen.createAssistCanvas();
                            jfgrid.jfgridrefreshgrid();
                        }
                        else if(itemvalue == "freezenRC"){ //首行列冻结
                            var scrollTop = $("#jfgrid-cell-main").scrollTop();
                            var row_st = jfgrid_searcharray(visibledatarow, scrollTop);
                            if(row_st == -1){
                                row_st = 0;
                            }
                            var top = visibledatarow[row_st] - 2 - scrollTop + columeHeaderHeight;
                            var freezenhorizontaldata = [visibledatarow[row_st], row_st + 1, scrollTop, jfgrid.freezen.cutVolumn(visibledatarow, row_st + 1), top];
                            jfgrid.freezen.saveFreezen(freezenhorizontaldata, top, null, null);

                            jfgrid.freezen.createFreezenHorizontal(freezenhorizontaldata, top);

                            var scrollLeft = $("#jfgrid-cell-main").scrollLeft();
                            var col_st = jfgrid_searcharray(visibledatacolumn, scrollLeft);
                            if(col_st == -1){
                                col_st = 0;
                            }
                            var left = visibledatacolumn[col_st] - 2 - scrollLeft + rowHeaderWidth;
                            var freezenverticaldata = [visibledatacolumn[col_st], col_st + 1, scrollLeft, jfgrid.freezen.cutVolumn(visibledatacolumn, col_st + 1), left];
                            jfgrid.freezen.saveFreezen(null, null, freezenverticaldata, left);

                            jfgrid.freezen.createFreezenVertical(freezenverticaldata, left);

                            jfgrid.freezen.createAssistCanvas();
                            jfgrid.jfgridrefreshgrid();
                        }
                        else if(itemvalue == "freezenRowRange"){ //选区行冻结
                            if(jfgird_select_save == null || jfgird_select_save.length == 0){
                                if(jfgrid.isEditMode()){
                                    alert("没有选区");
                                }
                                else{
                                    jfgrid.tooltip.info("没有选区", "");
                                }

                                return;
                            }
                            
                            var scrollTop = $("#jfgrid-cell-main").scrollTop();
                            var row_st = jfgrid_searcharray(visibledatarow, scrollTop);

                            var last = jfgird_select_save[jfgird_select_save.length - 1];
                            var row_focus = last["row_focus"] == null ? last["row"][0] : last["row_focus"];

                            if(row_focus > row_st){
                                row_st = row_focus;
                            }
                            
                            if(row_st == -1){
                                row_st = 0;
                            }

                            var top = visibledatarow[row_st] - 2 - scrollTop + columeHeaderHeight;
                            var freezenhorizontaldata = [visibledatarow[row_st], row_st + 1, scrollTop, jfgrid.freezen.cutVolumn(visibledatarow, row_st + 1), top];
                            jfgrid.freezen.saveFreezen(freezenhorizontaldata, top, null, null);

                            if (jfgrid.freezen.freezenverticaldata != null) {
                                jfgrid.freezen.cancelFreezenVertical();
                                jfgrid.freezen.createAssistCanvas();
                                jfgrid.jfgridrefreshgrid();
                            }

                            jfgrid.freezen.createFreezenHorizontal(freezenhorizontaldata, top);
                            jfgrid.freezen.createAssistCanvas();
                            jfgrid.jfgridrefreshgrid();
                        }
                        else if(itemvalue == "freezenColumnRange"){ //选区列冻结
                            if(jfgird_select_save == null || jfgird_select_save.length == 0){
                                if(jfgrid.isEditMode()){
                                    alert("没有选区");
                                }
                                else{
                                    jfgrid.tooltip.info("没有选区","");
                                }

                                return;
                            }
                            
                            var scrollLeft = $("#jfgrid-cell-main").scrollLeft();
                            var col_st = jfgrid_searcharray(visibledatacolumn, scrollLeft);

                            var last = jfgird_select_save[jfgird_select_save.length - 1];
                            var column_focus = last["column_focus"] == null ? last["column"][0] : last["column_focus"];

                            if(column_focus > col_st){
                                col_st = column_focus;
                            }

                            if(col_st == -1){
                                col_st = 0;
                            }

                            var left = visibledatacolumn[col_st] - 2 - scrollLeft + rowHeaderWidth;
                            var freezenverticaldata = [visibledatacolumn[col_st], col_st + 1, scrollLeft, jfgrid.freezen.cutVolumn(visibledatacolumn, col_st + 1), left];
                            jfgrid.freezen.saveFreezen(null, null, freezenverticaldata, left);

                            if (jfgrid.freezen.freezenhorizontaldata != null) {
                                jfgrid.freezen.cancelFreezenHorizontal();
                                jfgrid.freezen.createAssistCanvas();
                                jfgrid.jfgridrefreshgrid();
                            }

                            jfgrid.freezen.createFreezenVertical(freezenverticaldata, left);
                            jfgrid.freezen.createAssistCanvas();
                            jfgrid.jfgridrefreshgrid();
                        }
                        else if(itemvalue == "freezenRCRange"){ //选区行列冻结
                            if(jfgird_select_save == null || jfgird_select_save.length == 0){
                                if(jfgrid.isEditMode()){
                                    alert("没有选区");
                                }
                                else{
                                    jfgrid.tooltip.info("没有选区","");
                                }

                                return;
                            }
                            
                            var scrollTop = $("#jfgrid-cell-main").scrollTop();
                            var row_st = jfgrid_searcharray(visibledatarow, scrollTop);

                            var last = jfgird_select_save[jfgird_select_save.length - 1];
                            var row_focus = last["row_focus"] == null ? last["row"][0] : last["row_focus"];

                            if(row_focus > row_st){
                                row_st = row_focus;
                            }
                            
                            if(row_st == -1){
                                row_st = 0;
                            }

                            var top = visibledatarow[row_st] - 2 - scrollTop + columeHeaderHeight;
                            var freezenhorizontaldata = [visibledatarow[row_st], row_st + 1, scrollTop, jfgrid.freezen.cutVolumn(visibledatarow, row_st + 1), top];
                            jfgrid.freezen.saveFreezen(freezenhorizontaldata, top, null, null);

                            jfgrid.freezen.createFreezenHorizontal(freezenhorizontaldata, top);

                            var scrollLeft = $("#jfgrid-cell-main").scrollLeft();
                            var col_st = jfgrid_searcharray(visibledatacolumn, scrollLeft);

                            var last = jfgird_select_save[jfgird_select_save.length - 1];
                            var column_focus = last["column_focus"] == null ? last["column"][0] : last["column_focus"];

                            if(column_focus > col_st){
                                col_st = column_focus;
                            }

                            if(col_st == -1){
                                col_st = 0;
                            }
                            
                            var left = visibledatacolumn[col_st] - 2 - scrollLeft + rowHeaderWidth;
                            var freezenverticaldata = [visibledatacolumn[col_st], col_st + 1, scrollLeft, jfgrid.freezen.cutVolumn(visibledatacolumn, col_st + 1), left];
                            jfgrid.freezen.saveFreezen(null, null, freezenverticaldata, left);

                            jfgrid.freezen.createFreezenVertical(freezenverticaldata, left);
                            
                            jfgrid.freezen.createAssistCanvas();
                            jfgrid.jfgridrefreshgrid();
                        }
                        else if(itemvalue == "freezenCancel"){ //取消冻结
                            if (jfgrid.freezen.freezenverticaldata != null) {
                                jfgrid.freezen.cancelFreezenVertical();
                                jfgrid.freezen.createAssistCanvas();
                                jfgrid.jfgridrefreshgrid();
                            }

                            if (jfgrid.freezen.freezenhorizontaldata != null) {
                                jfgrid.freezen.cancelFreezenHorizontal();
                                jfgrid.freezen.createAssistCanvas();
                                jfgrid.jfgridrefreshgrid();
                            }

                            jfgrid.freezen.scrollAdapt();
                        }

                        setTimeout(function(){
                            jfgrid.jfgridsizeauto();
                        },0);
                    });
                }

                var userlen = $(this).outerWidth();
                var tlen = $menuButton.outerWidth();

                var menuleft = $(this).offset().left;
                if(tlen > userlen && (tlen + menuleft) > $("#" + container).width()){
                    menuleft = menuleft - tlen + userlen;
                }
                mouseclickposition($menuButton, menuleft - 68, $(this).offset().top + 25, "lefttop");
            });

            //过滤和排序
            $("#jfgrid-icon-autofilter").click(function(){
                var menuButtonId = $(this).attr("id") + "-menuButton";
                var $menuButton = $("#" + menuButtonId);
                
                if($menuButton.length == 0){
                    var itemdata = [
                        {"text": "升序", "value": "asc", "example": '<i style="font-size:14px;" class="fa fa-sort-numeric-asc" aria-hidden="true"></i>'},
                        {"text": "降序", "value": "desc", "example": '<i style="font-size:14px;" class="fa fa-sort-numeric-desc" aria-hidden="true"></i>'},
                        {"text": "自定义排序...", "value": "diysort", "example": '<i style="font-size:14px;" class="fa fa-sort" aria-hidden="true"></i>'},
                        {"text": "", "value": "split", "example": ""},
                        {"text": "筛选", "value": "filter", "example": '<i style="font-size:14px;" class="fa fa-filter" aria-hidden="true"></i>'},
                        {"text": "清除筛选", "value": "clearfilter", "example": '<i style="font-size:14px;" class="fa fa-window-close" aria-hidden="true"></i>'}
                    ];

                    var itemset = _this.createButtonMenu(itemdata);

                    var menu = jfgrid.replaceHtml(_this.menu, {"id":"autofilter", "item": itemset, "subclass":"", "sub":""});

                    $("body").append(menu);
                    $menuButton = $("#" + menuButtonId).width(150);
                    //_this.focus($menuButton);

                    $menuButton.find(".jfgrid-cols-menuitem").click(function(){
                        $menuButton.hide();
                        $("#" + container).attr("tabindex", 0).focus();

                        var $t = $(this), itemvalue = $t.attr("itemvalue");
                        //_this.focus($menuButton, itemvalue);

                        if(itemvalue == "diysort"){
                            $("#jfgridorderby").click();
                        }
                        else if(itemvalue == "asc"){
                            jfgrid.sortSelection(true);
                        }
                        else if(itemvalue == "desc"){
                            jfgrid.sortSelection(false);
                        }
                        else if(itemvalue == "filter"){
                            if($('#jfgrid-filter-options-sheet' + jfgrid.currentSheetIndex).length > 0){
                                $("#jfgrid-filter-initial").click();
                            }
                            else{
                                jfgrid.createFilter();
                            }
                        }
                        else if(itemvalue == "clearfilter"){
                            $("#jfgrid-filter-initial").click();
                        }
                    });
                }

                var userlen = $(this).outerWidth();
                var tlen = $menuButton.outerWidth();

                var menuleft = $(this).offset().left;
                if(tlen > userlen && (tlen + menuleft) > $("#" + container).width()){
                    menuleft = menuleft - tlen + userlen;
                }
                mouseclickposition($menuButton, menuleft, $(this).offset().top + 25, "lefttop");
            });

            //查找和替换
            $("#jfgrid-icon-seachmore").click(function(){
                var menuButtonId = $(this).attr("id") + "-menuButton";
                var $menuButton = $("#" + menuButtonId);
                
                if($menuButton.length == 0){
                    var itemdata = [
                        {"text": "查找 ...", "value": "search", "example": '<i style="font-size:14px;" class="fa fa-search" aria-hidden="true"></i>'},
                        {"text": "替换 ...", "value": "replace", "example": '<i style="font-size:14px;" class="fa fa-files-o" aria-hidden="true"></i>'},
                        {"text": "转到 ...", "value": "goto", "example": '<i style="font-size:14px;" class="fa fa-arrow-right" aria-hidden="true"></i>'},
                        {"text": "", "value": "split", "example": ""},
                        {"text": "定位条件 ...", "value": "location", "example": '<i style="font-size:14px;" class="fa fa-location-arrow" aria-hidden="true"></i>'},
                        {"text": "公式", "value": "locationFormula", "example": '定位'},
                        {"text": "日期", "value": "locationConstantDate", "example": '定位'},
                        {"text": "数字", "value": "locationConstantNumber", "example": '定位'},
                        {"text": "字符", "value": "locationConstantString", "example": '定位'},
                        {"text": "错误", "value": "locationConstantError", "example": '定位'},
                        {"text": "条件格式", "value": "locationCF", "example": '定位'},
                        {"text": "间隔行", "value": "locationStepRow", "example": '定位'},
                        {"text": "间隔列", "value": "locationStepColumn", "example": '定位'}
                    ];

                    var itemset = _this.createButtonMenu(itemdata);

                    var menu = jfgrid.replaceHtml(_this.menu, { "id": "seachmore", "item": itemset, "subclass": "", "sub": "" });

                    $("body").append(menu);
                    $menuButton = $("#" + menuButtonId).width(150);
                    //_this.focus($menuButton);

                    $menuButton.find(".jfgrid-cols-menuitem").click(function(){
                        $menuButton.hide();
                        $("#" + container).attr("tabindex", 0).focus();

                        var $t = $(this), itemvalue = $t.attr("itemvalue");
                        //_this.focus($menuButton, itemvalue);

                        if(itemvalue == "search" || itemvalue == "replace"){ //查找替换
                            if(itemvalue == "search"){
                                jfgrid.searchReplace.createDialog(0);
                            }
                            else if(itemvalue == "replace"){
                                jfgrid.searchReplace.createDialog(1);    
                            }
                            
                            jfgrid.searchReplace.init();

                            $("#jfgrid-search-replace #searchInput input").focus();
                        }
                        else if(itemvalue == "location"){ //定位条件
                            jfgrid.locationCell.createDialog();
                            jfgrid.locationCell.init();
                        }
                        else if(itemvalue == "locationFormula" || itemvalue == "locationConstantDate" || itemvalue == "locationConstantNumber" || itemvalue == "locationConstantString" || itemvalue == "locationConstantError" || itemvalue == "locationCF"){ 
                            if(jfgird_select_save.length == 0 || (jfgird_select_save.length == 1 && jfgird_select_save[0].row[0] == jfgird_select_save[0].row[1] && jfgird_select_save[0].column[0] == jfgird_select_save[0].column[1])){
                                //单个单元格
                                var range = [{"row": [0, jfgrid.flowdata.length - 1], "column": [0, jfgrid.flowdata[0].length - 1]}];
                            }
                            else{
                                var range = $.extend(true, [], jfgird_select_save);
                            }

                            if(itemvalue == "locationFormula"){               //公式
                                jfgrid.locationCell.apply(range, "locationFormula", "all");
                            }
                            else if(itemvalue == "locationConstantDate"){     //日期
                                jfgrid.locationCell.apply(range, "locationConstant", "d");
                            }
                            else if(itemvalue == "locationConstantNumber"){   //数字
                                jfgrid.locationCell.apply(range, "locationConstant", "n");
                            }
                            else if(itemvalue == "locationConstantString"){   //字符
                                jfgrid.locationCell.apply(range, "locationConstant", "s,g");
                            }
                            else if(itemvalue == "locationConstantError"){    //错误
                                jfgrid.locationCell.apply(range, "locationConstant", "e");
                            }
                            else if(itemvalue == "locationCF"){               //条件格式
                                jfgrid.locationCell.apply(range, "locationCF");
                            }
                        }
                        else if(itemvalue == "locationStepRow"){ //间隔行
                            if(jfgird_select_save.length == 0 || (jfgird_select_save.length == 1 && jfgird_select_save[0].row[0] == jfgird_select_save[0].row[1])){
                                if(jfgrid.isEditMode()){
                                    alert("请选择最少两行");
                                }
                                else{
                                    jfgrid.tooltip.info("提示", "请选择最少两行"); 
                                }
                                return;                            
                            }

                            var range = $.extend(true, [], jfgird_select_save);

                            jfgrid.locationCell.apply(range, "locationStepRow");
                        }
                        else if(itemvalue == "locationStepColumn"){ //间隔列
                            if(jfgird_select_save.length == 0 || (jfgird_select_save.length == 1 && jfgird_select_save[0].column[0] == jfgird_select_save[0].column[1])){
                                if(jfgrid.isEditMode()){
                                    alert("请选择最少两列");
                                }
                                else{
                                    jfgrid.tooltip.info("提示", "请选择最少两列"); 
                                }
                                return;                            
                            }

                            var range = $.extend(true, [], jfgird_select_save);

                            jfgrid.locationCell.apply(range, "locationStepColumn");
                        }
                    });
                }

                var userlen = $(this).outerWidth();
                var tlen = $menuButton.outerWidth();

                var menuleft = $(this).offset().left;
                if(tlen > userlen && (tlen + menuleft) > $("#" + container).width()){
                    menuleft = menuleft - tlen + userlen;
                }
                mouseclickposition($menuButton, menuleft, $(this).offset().top + 25, "lefttop");
            });

            //公式
            $("#jfgrid-icon-function").click(function(){
                _this.autoSelectionFormula("SUM");
            });

            //公式菜单
            $("#jfgrid-icon-function-menu").click(function(){
                var menuButtonId = $(this).attr("id") + "-menuButton";
                var $menuButton = $("#" + menuButtonId);
                
                if($menuButton.length == 0){
                    var itemdata = [
                        {"text": "求和", "value": "SUM", "example": 'SUM'},
                        {"text": "平均值", "value": "AVERAGE", "example": 'AVERAGE'},
                        {"text": "计数", "value": "COUNT", "example": 'COUNT'},
                        {"text": "最大值", "value": "MAX", "example": 'MAX'},
                        {"text": "最小值", "value": "MIN", "example": 'MIN'},
                        {"text": "", "value": "split", "example": ""},
                        {"text": "if公式生成器", "value": "if", "example": 'IF'},
                        {"text": "函数查找 ...", "value": "formula", "example": ""}
                    ];

                    var itemset = _this.createButtonMenu(itemdata);

                    var menu = jfgrid.replaceHtml(_this.menu, { "id": "function-menu", "item": itemset, "subclass": "", "sub": "" });

                    $("body").append(menu);
                    $menuButton = $("#" + menuButtonId).width(150);
                    //_this.focus($menuButton);

                    $menuButton.find(".jfgrid-cols-menuitem").click(function(){
                        $menuButton.hide();
                        $("#" + container).attr("tabindex", 0).focus();

                        var $t = $(this), itemvalue = $t.attr("itemvalue");
                        //_this.focus($menuButton, itemvalue);

                        if(itemvalue == "if"){
                            var last = jfgird_select_save[jfgird_select_save.length - 1];
                            var r = last["row_focus"] == null ? last["row"][0] : last["row_focus"];
                            var c = last["column_focus"] == null ? last["column"][0] : last["column_focus"];

                            if(!!jfgrid.flowdata[r] && !!jfgrid.flowdata[r][c] && !!jfgrid.flowdata[r][c]["f"]){
                                var fp = jfgrid.flowdata[r][c]["f"].toString();
                                if(fp.indexOf("=if(") != -1){
                                    jfgrid.ifFormulaGenerator.ifFormulaDialog(fp);
                                }
                                else{
                                    if(jfgrid.isEditMode()){
                                        alert("该单元格函数不属于if公式！");
                                    }
                                    else{
                                        jfgrid.tooltip.info("该单元格函数不属于if公式！","");
                                    }
                                    return;
                                }
                            }
                            else{
                                jfgrid.ifFormulaGenerator.ifFormulaDialog();
                            }

                            jfgrid.ifFormulaGenerator.init();
                        }
                        else if(itemvalue == "formula"){
                            //点击函数查找弹出框
                            if(jfgird_select_save.length == 0){
                                if(jfgrid.isEditMode()){
                                    alert("请选择单元格插入函数");
                                }
                                else{
                                    jfgrid.tooltip.info("请选择单元格插入函数","");
                                }

                                return;
                            }

                            var last = jfgird_select_save[jfgird_select_save.length - 1];

                            var row_index = last["row_focus"], col_index = last["column_focus"];
                            var row = visibledatarow[row_index], row_pre = row_index - 1 == -1 ? 0 : visibledatarow[row_index - 1];
                            var col = visibledatacolumn[col_index], col_pre = col_index - 1 == -1 ? 0 : visibledatacolumn[col_index - 1];

                            jfgrid.jfgridupdateCell(row, row_pre, row_index, col, col_pre, col_index, jfgrid.flowdata);
                            
                            var cell = jfgrid.flowdata[row_index][col_index];
                            if(cell != null && cell.f != null){
                                //单元格有计算
                                var functionStr = jfgrid.formula.getfunctionParam(cell.f);
                                if(functionStr.fn != null){
                                    //有函数公式
                                    jfgrid.insertFormula.formulaParmDialog(functionStr.fn, functionStr.param);
                                }
                                else{
                                    //无函数公式
                                    jfgrid.insertFormula.formulaListDialog();
                                }
                            }
                            else{
                                //单元格无计算
                                $("#jfgrid-rich-text-editor").html('<span dir="auto" class="jfgrid-formula-text-color">=</span>');
                                $("#jfgrid-functionbox-cell").html($("#jfgrid-rich-text-editor").html());
                                jfgrid.insertFormula.formulaListDialog();
                            }

                            jfgrid.insertFormula.init();
                        }
                        else {
                            _this.autoSelectionFormula(itemvalue);
                        }
                    });
                }

                var userlen = $(this).outerWidth();
                var tlen = $menuButton.outerWidth();

                var menuleft = $(this).offset().left;
                if(tlen>userlen && (tlen + menuleft)>$("#"+container).width()){
                    menuleft = menuleft - tlen + userlen;
                }
                mouseclickposition($menuButton, menuleft-48, $(this).offset().top+25, "lefttop");
            });

            //加粗
            $("#jfgrid-icon-bold").click(function(){
                var d = jfgrid.editor.deepCopyFlowData(jfgrid.flowdata);
                var row_index = jfgird_select_save[0]["row_focus"], col_index = jfgird_select_save[0]["column_focus"];
                var foucsStatus = _this.checkstatus(d, row_index, col_index, "bl");

                if(foucsStatus == 1){
                    foucsStatus = 0;
                }
                else{
                    foucsStatus = 1;
                }

                _this.updateFormat(d, "bl", foucsStatus);

                jfgrid.menuButton.menuButtonFocus(d, row_index, col_index);
            });

            //斜体
            $("#jfgrid-icon-italic").click(function(){
                var d = jfgrid.editor.deepCopyFlowData(jfgrid.flowdata);
                var row_index = jfgird_select_save[0]["row_focus"], col_index = jfgird_select_save[0]["column_focus"];
                var foucsStatus = _this.checkstatus(d, row_index, col_index, "it");

                if(foucsStatus == 1){
                    foucsStatus = 0;
                }
                else{
                    foucsStatus = 1;
                }

                _this.updateFormat(d, "it", foucsStatus);

                jfgrid.menuButton.menuButtonFocus(d, row_index, col_index);
            });

            //删除线
            $("#jfgrid-icon-strikethrough").click(function(){
                var d = jfgrid.editor.deepCopyFlowData(jfgrid.flowdata);
                var row_index = jfgird_select_save[0]["row_focus"], col_index = jfgird_select_save[0]["column_focus"];
                var foucsStatus = _this.checkstatus(d, row_index, col_index, "cl");

                if(foucsStatus == 1){
                    foucsStatus = 0;
                }
                else{
                    foucsStatus = 1;
                }

                _this.updateFormat(d, "cl", foucsStatus);

                jfgrid.menuButton.menuButtonFocus(d, row_index, col_index);
            });

            //条件格式
            $("#jfgrid-icon-conditionformat").click(function(){
                var menuButtonId = $(this).attr("id") + "-menuButton";
                var $menuButton = $("#" + menuButtonId);
                
                if($menuButton.length == 0){
                    var itemdata = [
                        {"text": "突出显示单元格规则", "value": "highlightCellRule", "example": "more"},
                        {"text": "项目选取规则", "value": "projectSelectRule", "example": "more"},
                        {"text": "数据条", "value": "dataBar", "example": "more"},
                        {"text": "色阶", "value": "colorGradation", "example": "more"},
                        {"text": "图标集", "value": "icons", "example": ""},
                        {"text": "", "value": "split", "example": ""},
                        {"text": "新建规则", "value": "newRule", "example": ""},
                        {"text": "清除规则", "value": "deleteRule", "example": "more"},
                        {"text": "管理规则", "value": "administerRule", "example": ""}
                    ];
                    var itemset = _this.createButtonMenu(itemdata);
                    var menu = jfgrid.replaceHtml(_this.menu, {"id": "conditionformat", "item": itemset, "subclass": "", "sub": ""});
                    
                    //突出显示单元格规则子菜单
                    var subitemdata = [
                        {"text": "大于", "value": "greaterThan", "example": ">"},
                        {"text": "小于", "value": "lessThan", "example": "<"},
                        {"text": "介于", "value": "betweenness", "example": "[]"},
                        {"text": "等于", "value": "equal", "example": "="},
                        {"text": "文本包含", "value": "textContains", "example": "()"},
                        {"text": "发生日期", "value": "occurrenceDate", "example": "昨天"},
                        {"text": "重复值", "value": "duplicateValue", "example": "##"}
                    ];
                    var subitemset = _this.createButtonMenu(subitemdata);
                    var submenu = jfgrid.replaceHtml(_this.menu, {"id": "highlightCellRule", "item": subitemset, "subclass": "jfgrid-menuButton-sub"});
                    
                    //项目选取规则子菜单
                    var subitemdata2 = [
                        {"text": "前 10 项", "value": "top10", "example": "前10项"},
                        {"text": "前 10%", "value": "top10%", "example": "前10%"},
                        {"text": "最后 10 项", "value": "last10", "example": "后10项"},
                        {"text": "最后 10%", "value": "last10%", "example": "后10%"},
                        {"text": "高于平均值", "value": "AboveAverage", "example": "高于均值"},
                        {"text": "低于平均值", "value": "SubAverage", "example": "低于均值"}
                    ];
                    var subitemset2 = _this.createButtonMenu(subitemdata2);
                    var submenu2 = jfgrid.replaceHtml(_this.menu, {"id": "projectSelectRule", "item": subitemset2, "subclass": "jfgrid-menuButton-sub"});
                    
                    //数据条子菜单
                    var submenu3 = '<div class="jfgrid-cols-menu jfgrid-rightgclick-menu jfgrid-menuButton jfgrid-menuButton-sub jfgrid-mousedown-cancel" id="jfgrid-icon-dataBar-menuButton" style="width: 126px;padding: 5px;top: 118.5px;left: 1321.48px;display: none;">' +
                                    '<div itemvalue="0" class="jfgrid-cols-menuitem jfgrid-mousedown-cancel" style="width: 28px; height: 26px;padding: 5px;float: left;">' +
                                        '<div class="jfgrid-mousedown-cancel bgImgBox" style="background-position: 0 0;" title="蓝-白渐变数据条"></div>' +
                                    '</div>' +
                                    '<div itemvalue="1" class="jfgrid-cols-menuitem jfgrid-mousedown-cancel" style="width: 28px; height: 26px;padding: 5px;float: left;">' +
                                        '<div class="jfgrid-mousedown-cancel bgImgBox" style="background-position: -38px 0;" title="绿-白渐变数据条"></div>' +
                                    '</div>' +
                                    '<div itemvalue="2" class="jfgrid-cols-menuitem jfgrid-mousedown-cancel" style="width: 28px; height: 26px;padding: 5px;float: left;">' +
                                        '<div class="jfgrid-mousedown-cancel bgImgBox" style="background-position: -76px 0;" title="红-白渐变数据条"></div>' +
                                    '</div>' +
                                    '<div itemvalue="3" class="jfgrid-cols-menuitem jfgrid-mousedown-cancel" style="width: 28px; height: 26px;padding: 5px;float: left;">' +
                                        '<div class="jfgrid-mousedown-cancel bgImgBox" style="background-position: 0 -36px;" title="橙-白渐变数据条"></div>' +
                                    '</div>' +
                                    '<div itemvalue="4" class="jfgrid-cols-menuitem jfgrid-mousedown-cancel" style="width: 28px; height: 26px;padding: 5px;float: left;">' +
                                        '<div class="jfgrid-mousedown-cancel bgImgBox" style="background-position: -38px -36px;" title="浅蓝-白渐变数据条"></div>' +
                                    '</div>' +
                                    '<div itemvalue="5" class="jfgrid-cols-menuitem jfgrid-mousedown-cancel" style="width: 28px; height: 26px;padding: 5px;float: left;">' +
                                        '<div class="jfgrid-mousedown-cancel bgImgBox" style="background-position: -76px -36px;" title="紫-白渐变数据条"></div>' +
                                    '</div>' +
                                    '<div itemvalue="6" class="jfgrid-cols-menuitem jfgrid-mousedown-cancel" style="width: 28px; height: 26px;padding: 5px;float: left;">' +
                                        '<div class="jfgrid-mousedown-cancel bgImgBox" style="background-position: 0 -72px;" title="蓝色数据条"></div>' +
                                    '</div>' +
                                    '<div itemvalue="7" class="jfgrid-cols-menuitem jfgrid-mousedown-cancel" style="width: 28px; height: 26px;padding: 5px;float: left;">' +
                                        '<div class="jfgrid-mousedown-cancel bgImgBox" style="background-position: -38px -72px;" title="绿色数据条"></div>' +
                                    '</div>' +
                                    '<div itemvalue="8" class="jfgrid-cols-menuitem jfgrid-mousedown-cancel" style="width: 28px; height: 26px;padding: 5px;float: left;">' +
                                        '<div class="jfgrid-mousedown-cancel bgImgBox" style="background-position: -76px -72px;" title="红色数据条"></div>' +
                                    '</div>' +
                                    '<div itemvalue="9" class="jfgrid-cols-menuitem jfgrid-mousedown-cancel" style="width: 28px; height: 26px;padding: 5px;float: left;">' +
                                        '<div class="jfgrid-mousedown-cancel bgImgBox" style="background-position: 0 -108px;" title="橙色数据条"></div>' +
                                    '</div>' +
                                    '<div itemvalue="10" class="jfgrid-cols-menuitem jfgrid-mousedown-cancel" style="width: 28px; height: 26px;padding: 5px;float: left;">' +
                                        '<div class="jfgrid-mousedown-cancel bgImgBox" style="background-position: -38px -108px;" title="浅蓝色数据条"></div>' +
                                    '</div>' +
                                    '<div itemvalue="11" class="jfgrid-cols-menuitem jfgrid-mousedown-cancel" style="width: 28px; height: 26px;padding: 5px;float: left;">' +
                                        '<div class="jfgrid-mousedown-cancel bgImgBox" style="background-position: -76px -108px;" title="紫色数据条"></div>' +
                                    '</div>' +
                                   '</div>';

                    //色阶
                    var submenu4 = '<div class="jfgrid-cols-menu jfgrid-rightgclick-menu jfgrid-menuButton jfgrid-menuButton-sub jfgrid-mousedown-cancel" id="jfgrid-icon-colorGradation-menuButton" style="width: 126px;padding: 5px;top: 143.5px;left: 1321.48px;display: none;">' +
                                    '<div itemvalue="0" class="jfgrid-cols-menuitem jfgrid-mousedown-cancel" style="width: 28px; height: 26px;padding: 5px;float: left;">' +
                                        '<div class="jfgrid-mousedown-cancel bgImgBox" style="background-position: 0 0;" title="绿-黄-红色阶"></div>' +
                                    '</div>' +
                                    '<div itemvalue="1" class="jfgrid-cols-menuitem jfgrid-mousedown-cancel" style="width: 28px; height: 26px;padding: 5px;float: left;">' +
                                        '<div class="jfgrid-mousedown-cancel bgImgBox" style="background-position: -38px 0;" title="红-黄-绿色阶"></div>' +
                                    '</div>' +
                                    '<div itemvalue="2" class="jfgrid-cols-menuitem jfgrid-mousedown-cancel" style="width: 28px; height: 26px;padding: 5px;float: left;">' +
                                        '<div class="jfgrid-mousedown-cancel bgImgBox" style="background-position: -76px 0;" title="绿-白-红色阶"></div>' +
                                    '</div>' +
                                    '<div itemvalue="3" class="jfgrid-cols-menuitem jfgrid-mousedown-cancel" style="width: 28px; height: 26px;padding: 5px;float: left;">' +
                                        '<div class="jfgrid-mousedown-cancel bgImgBox" style="background-position: -114px 0;" title="红-白-绿色阶"></div>' +
                                    '</div>' +
                                    '<div itemvalue="4" class="jfgrid-cols-menuitem jfgrid-mousedown-cancel" style="width: 28px; height: 26px;padding: 5px;float: left;">' +
                                        '<div class="jfgrid-mousedown-cancel bgImgBox" style="background-position: 0 -36px;" title="蓝-白-红色阶"></div>' +
                                    '</div>' +
                                    '<div itemvalue="5" class="jfgrid-cols-menuitem jfgrid-mousedown-cancel" style="width: 28px; height: 26px;padding: 5px;float: left;">' +
                                        '<div class="jfgrid-mousedown-cancel bgImgBox" style="background-position: -38px -36px;" title="红-白-蓝色阶"></div>' +
                                    '</div>' +
                                    '<div itemvalue="6" class="jfgrid-cols-menuitem jfgrid-mousedown-cancel" style="width: 28px; height: 26px;padding: 5px;float: left;">' +
                                        '<div class="jfgrid-mousedown-cancel bgImgBox" style="background-position: -76px -36px;" title="白-红色阶"></div>' +
                                    '</div>' +
                                    '<div itemvalue="7" class="jfgrid-cols-menuitem jfgrid-mousedown-cancel" style="width: 28px; height: 26px;padding: 5px;float: left;">' +
                                        '<div class="jfgrid-mousedown-cancel bgImgBox" style="background-position: -114px -36px;" title="红-白色阶"></div>' +
                                    '</div>' +
                                    '<div itemvalue="8" class="jfgrid-cols-menuitem jfgrid-mousedown-cancel" style="width: 28px; height: 26px;padding: 5px;float: left;">' +
                                        '<div class="jfgrid-mousedown-cancel bgImgBox" style="background-position: 0 -72px;" title="绿-白色阶"></div>' +
                                    '</div>' +
                                    '<div itemvalue="9" class="jfgrid-cols-menuitem jfgrid-mousedown-cancel" style="width: 28px; height: 26px;padding: 5px;float: left;">' +
                                        '<div class="jfgrid-mousedown-cancel bgImgBox" style="background-position: -38px -72px;" title="白-绿色阶"></div>' +
                                    '</div>' +
                                    '<div itemvalue="10" class="jfgrid-cols-menuitem jfgrid-mousedown-cancel" style="width: 28px; height: 26px;padding: 5px;float: left;">' +
                                        '<div class="jfgrid-mousedown-cancel bgImgBox" style="background-position: -76px -72px;" title="绿-黄色阶"></div>' +
                                    '</div>' +
                                    '<div itemvalue="11" class="jfgrid-cols-menuitem jfgrid-mousedown-cancel" style="width: 28px; height: 26px;padding: 5px;float: left;">' +
                                        '<div class="jfgrid-mousedown-cancel bgImgBox" style="background-position: -114px -72px;" title="黄-绿色阶"></div>' +
                                    '</div>' +
                                   '</div>';

                    //清除规则子菜单
                    var subitemdata6 = [
                        // {"text":"清除所选单元格的规则", "value":"", "example":""},
                        {"text":"清除整个工作表的规则", "value":"delSheet", "example":""}
                    ];
                    var subitemset6 = _this.createButtonMenu(subitemdata6);
                    var submenu6 = jfgrid.replaceHtml(_this.menu, {"id": "deleteRule", "item": subitemset6, "subclass":"jfgrid-menuButton-sub"});

                    $("body").append(menu + submenu + submenu2 + submenu3 + submenu4 + submenu6);
                    $menuButton = $("#"+menuButtonId).width(190);
                    $("#jfgrid-icon-highlightCellRule-menuButton").width(130);
                    $("#jfgrid-icon-projectSelectRule-menuButton").width(170);

                    $menuButton.find(".jfgrid-cols-menuitem").click(function(){
                        $menuButton.hide();
                        $("#" + container).attr("tabindex", 0).focus();

                        var $t = $(this), itemvalue = $t.attr("itemvalue");

                        if(itemvalue == "icons"){
                            if(jfgird_select_save.length == 0){
                                if(jfgrid.isEditMode()){
                                    alert("请选择应用范围");
                                }
                                else{
                                    jfgrid.tooltip.info("请选择应用范围", "");
                                }
                                return;
                            }

                            jfgrid.conditionformat.CFiconsDialog();
                            jfgrid.conditionformat.init();
                        }
                        else if(itemvalue == "newRule"){
                            if(jfgird_select_save.length == 0){
                                if(jfgrid.isEditMode()){
                                    alert("请选择应用范围");
                                }
                                else{
                                    jfgrid.tooltip.info("请选择应用范围", "");
                                }
                                return;
                            }

                            jfgrid.conditionformat.newConditionRuleDialog(0);
                            jfgrid.conditionformat.init();
                        }
                        else if(itemvalue == "administerRule"){
                            var loadSheetUrl = jfgrid.server.loadSheetUrl;
                            var file = jfgrid.getjfgridfile();

                            if(loadSheetUrl != "" && loadSheetUrl != null){
                                var sheetindex = [];
                                for(var i = 0; i < file.length; i++){
                                    sheetindex.push(file[i].index);
                                }

                                $.post(loadSheetUrl, {"gridKey" : jfgrid.server.gridKey, "index": sheetindex.join(",")}, function (d) {
                                    var dataset = eval("(" + d + ")");

                                    setTimeout(function(){
                                        $("#jfgridloadingdata").fadeOut().remove();
                                    }, 500);

                                    for(var item in dataset){
                                        if(item == jfgrid.currentSheetIndex){
                                            continue;
                                        }

                                        var otherfile = file[jfgrid.sheetmanage.getSheetIndex(item)];

                                        otherfile.celldata = dataset[item.toString()];
                                        otherfile["data"] = jfgrid.sheetmanage.buildGridData(otherfile);
                                    }

                                    jfgrid.setjfgridfile(file);

                                    jfgrid.conditionformat.fileClone =  $.extend(true, [], file);
                                    jfgrid.conditionformat.administerRuleDialog();
                                    jfgrid.conditionformat.init();
                                });
                            }
                            else{
                                jfgrid.conditionformat.fileClone =  $.extend(true, [], file);
                                jfgrid.conditionformat.administerRuleDialog();
                                jfgrid.conditionformat.init();
                            }
                        }
                    });

                    //突出显示单元格规则子菜单点击事件
                    $(document).off("click.CFhighlightCellRule").on("click.CFhighlightCellRule", "#jfgrid-icon-highlightCellRule-menuButton .jfgrid-cols-menuitem", function(){
                        $menuButton.hide();
                        $("#jfgrid-icon-highlightCellRule-menuButton").hide();
                        $("#" + container).attr("tabindex", 0).focus();

                        var $t = $(this), itemvalue = $t.attr("itemvalue");

                        if(jfgird_select_save.length == 0){
                            if(jfgrid.isEditMode()){
                                alert("请选择条件格式的应用范围");
                            }
                            else{
                                jfgrid.tooltip.info("请选择条件格式的应用范围", ""); 
                            }
                            return;
                        }
                        else{
                            var textCellColorHtml = jfgrid.conditionformat.textCellColorHtml;

                            switch(itemvalue){
                                case "greaterThan":
                                    var title = "条件格式——大于";
                                    var content = '<div class="box" data-itemvalue="greaterThan">' +
                                                    '<div class="boxTitleOne">为大于以下值的单元格设置格式：</div>' +
                                                    '<div class="inpbox range">' +
                                                        '<input id="conditionVal" class="formulaInputFocus"/>' +
                                                        '<i class="fa fa-table" aria-hidden="true" title="点击选择单元格"></i>' +
                                                    '</div>' +
                                                    '<div style="margin: 5px 0;">设置为：</div>' + 
                                                    textCellColorHtml + 
                                                  '</div>';
                                    break;
                                case "lessThan":
                                    var title = "条件格式——小于";
                                    var content = '<div class="box" data-itemvalue="lessThan">' +
                                                    '<div class="boxTitleOne">为小于以下值的单元格设置格式：</div>' +
                                                    '<div class="inpbox range">' +
                                                        '<input id="conditionVal" class="formulaInputFocus"/>' +
                                                        '<i class="fa fa-table" aria-hidden="true" title="点击选择单元格"></i>' +
                                                    '</div>' +
                                                    '<div style="margin: 5px 0;">设置为：</div>' +
                                                    textCellColorHtml +
                                                  '</div>';
                                    break;
                                case "betweenness":
                                    var title = "条件格式——介于";
                                    var content = '<div class="box" data-itemvalue="betweenness">' +
                                                    '<div class="boxTitleOne">为介于以下值的单元格设置格式：</div>' +
                                                    '<div style="height: 30px;line-height: 30px;">' +
                                                        '<div class="inpbox2 range">' +
                                                            '<input id="conditionVal" class="formulaInputFocus"/>' +
                                                            '<i class="fa fa-table" aria-hidden="true" title="点击选择单元格"></i>' +
                                                        '</div>' +
                                                        '<div style="float: left;height: 30px;line-height: 30px;margin: 0 5px;">到</div>' +
                                                        '<div class="inpbox2 range">' +
                                                            '<input id="conditionVal2" class="formulaInputFocus"/>' +
                                                            '<i class="fa fa-table" aria-hidden="true" title="点击选择单元格"></i>' +
                                                        '</div>' +
                                                    '</div>' +
                                                    '<div style="margin: 5px 0;">设置为：</div>' +
                                                    textCellColorHtml +
                                                  '</div>';
                                    break;
                                case "equal":
                                    var title = "条件格式——等于";
                                    var content = '<div class="box" data-itemvalue="equal">' +
                                                    '<div class="boxTitleOne">为等于以下值的单元格设置格式：</div>' +
                                                    '<div class="inpbox range">' +
                                                        '<input id="conditionVal" class="formulaInputFocus"/>' +
                                                        '<i class="fa fa-table" aria-hidden="true" title="点击选择单元格"></i>' +
                                                    '</div>' +
                                                    '<div style="margin: 5px 0;">设置为：</div>' +
                                                    textCellColorHtml +
                                                  '</div>';
                                    break;
                                case "textContains":
                                    var title = "条件格式——文本包含";
                                    var content = '<div class="box" data-itemvalue="textContains">' +
                                                    '<div class="boxTitleOne">为包含以下文本的单元格设置格式：</div>' +
                                                    '<div class="inpbox range">' +
                                                        '<input id="conditionVal" class="formulaInputFocus"/>' +
                                                        '<i class="fa fa-table" aria-hidden="true" title="点击选择单元格"></i>' +
                                                    '</div>' +
                                                    '<div style="margin: 5px 0;">设置为：</div>' +
                                                    textCellColorHtml +
                                                  '</div>';
                                    break; 
                                case "occurrenceDate":
                                    var title = "条件格式——发生日期";
                                    var content = '<div class="box" data-itemvalue="occurrenceDate">' +
                                                    '<div class="boxTitleOne">为包含以下日期的单元格设置格式：</div>' +
                                                    '<div class="inpbox">' +
                                                        '<input id="daterange-btn" class="formulaInputFocus" readonly="readonly" placeholder="请选择日期"/>' +
                                                    '</div>' +
                                                    '<div style="margin: 5px 0;">设置为：</div>' +
                                                    textCellColorHtml +
                                                  '</div>';
                                    break; 
                                case "duplicateValue":
                                    var title = "条件格式——重复值";
                                    var content = '<div class="box" data-itemvalue="duplicateValue">' +
                                                    '<div class="boxTitleOne">为包含以下类型值的单元格设置格式：</div>' +
                                                    '<select id="conditionVal" class="selectbox">' +
                                                        '<option value="0">重复</option>' +
                                                        '<option value="1">唯一</option>' +
                                                    '</select>' +
                                                    '<span style="margin-left: 5px;">值</span>' +
                                                    '<div style="margin:5px 0;">设置为：</div>' +
                                                    textCellColorHtml +
                                                  '</div>';
                                    break;      
                            }

                            jfgrid.conditionformat.conditionformatDialog(title, content); 
                        }
                    });

                    //项目选取规则子菜单点击事件
                    $(document).off("click.CFprojectSelectRule").on("click.CFprojectSelectRule", "#jfgrid-icon-projectSelectRule-menuButton .jfgrid-cols-menuitem", function(){
                        $menuButton.hide();
                        $("#jfgrid-icon-projectSelectRule-menuButton").hide();
                        $("#" + container).attr("tabindex", 0).focus();

                        var $t = $(this), itemvalue = $t.attr("itemvalue");

                        if(jfgird_select_save.length == 0){
                            if(jfgrid.isEditMode()){
                                alert("请选择条件格式的应用范围");
                            }
                            else{
                                jfgrid.tooltip.info("请选择条件格式的应用范围", ""); 
                            }
                            return;
                        }
                        else{
                            var textCellColorHtml = jfgrid.conditionformat.textCellColorHtml;

                            switch(itemvalue){
                                case "top10":
                                    var title = "条件格式——前 10 项";
                                    var content = '<div class="box" data-itemvalue="top10">' +
                                                    '<div class="boxTitleOne">为值最大的那些单元格设置格式：</div>' +
                                                    '<div style="height: 30px;line-height: 30px;">' +
                                                        '<div style="float: left;height: 30px;line-height: 30px;margin: 0 5px;">前</div>' +
                                                        '<div class="inpbox2">' +
                                                            '<input id="conditionVal" class="formulaInputFocus" type="number" value="10"/>' +
                                                        '</div>' +
                                                        '<div style="float: left;height: 30px;line-height: 30px;margin: 0 5px;">项</div>' +
                                                    '</div>' +
                                                    '<div style="margin: 5px 0;">设置为：</div>' +
                                                    textCellColorHtml +
                                                  '</div>';
                                    break;
                                case "top10%":
                                    var title = "条件格式——前 10%";
                                    var content = '<div class="box" data-itemvalue="top10%">' +
                                                    '<div class="boxTitleOne">为值最大的那些单元格设置格式：</div>' +
                                                    '<div style="height: 30px;line-height: 30px;">' +
                                                        '<div style="float: left;height: 30px;line-height: 30px;margin: 0 5px;">前</div>' +
                                                        '<div class="inpbox2">' +
                                                            '<input id="conditionVal" class="formulaInputFocus" type="number" value="10"/>' +
                                                        '</div>' +
                                                        '<div style="float: left;height: 30px;line-height: 30px;margin: 0 5px;">%</div>' +
                                                    '</div>' +
                                                    '<div style="margin: 5px 0;">设置为：</div>' +
                                                    textCellColorHtml +
                                                  '</div>';
                                    break;
                                case "last10":
                                    var title = "条件格式——最后 10 项";
                                    var content = '<div class="box" data-itemvalue="last10">' +
                                                    '<div class="boxTitleOne">为值最小的那些单元格设置格式：</div>' +
                                                    '<div style="height: 30px;line-height: 30px;">' +
                                                        '<div style="float: left;height: 30px;line-height: 30px;margin: 0 5px;">最后</div>' +
                                                        '<div class="inpbox2">' +
                                                            '<input id="conditionVal" class="formulaInputFocus" type="number" value="10"/>' +
                                                        '</div>' +
                                                        '<div style="float: left;height: 30px;line-height: 30px;margin: 0 5px;">项</div>' +
                                                    '</div>' +
                                                    '<div style="margin: 5px 0;">设置为：</div>' +
                                                    textCellColorHtml +
                                                  '</div>';
                                    break;
                                case "last10%":
                                    var title = "条件格式——最后 10%";
                                    var content = '<div class="box" data-itemvalue="last10%">' +
                                                    '<div class="boxTitleOne">为值最小的那些单元格设置格式：</div>' +
                                                    '<div style="height: 30px;line-height: 30px;">' +
                                                        '<div style="float: left;height: 30px;line-height: 30px;margin: 0 5px;">最后</div>' +
                                                        '<div class="inpbox2">' +
                                                            '<input id="conditionVal" class="formulaInputFocus" type="number" value="10"/>' +
                                                        '</div>' +
                                                        '<div style="float: left;height: 30px;line-height: 30px;margin: 0 5px;">%</div>' +
                                                    '</div>' +
                                                    '<div style="margin:5px 0;">设置为：</div>' +
                                                    textCellColorHtml +
                                                  '</div>';
                                    break;
                                case "AboveAverage":
                                    var title = "条件格式——高于平均值";
                                    var content = '<div class="box" data-itemvalue="AboveAverage">' +
                                                    '<div class="boxTitleOne">为高于平均值的单元格设置格式：</div>' +
                                                    '<div style="margin: 5px 0;">针对选定区域，设置为：</div>' +
                                                    textCellColorHtml +
                                                  '</div>';
                                    break; 
                                case "SubAverage":
                                    var title = "条件格式——低于平均值";
                                    var content = '<div class="box" data-itemvalue="SubAverage">' +
                                                    '<div class="boxTitleOne">为低于平均值的单元格设置格式：</div>' +
                                                    '<div style="margin: 5px 0;">针对选定区域，设置为：</div>' +
                                                    textCellColorHtml +
                                                  '</div>';
                                    break; 
                            }

                            jfgrid.conditionformat.conditionformatDialog(title,content);
                        }
                    });

                    //数据条子菜单点击事件
                    $(document).off("click.CFdataBar").on("click.CFdataBar", "#jfgrid-icon-dataBar-menuButton .jfgrid-cols-menuitem", function(){
                        $menuButton.hide();
                        $("#jfgrid-icon-dataBar-menuButton").hide();
                        $("#" + container).attr("tabindex", 0).focus();

                        var $t = $(this), itemvalue = $t.attr("itemvalue");

                        if(jfgird_select_save.length > 0){
                            var cellrange = $.extend(true, [], jfgird_select_save);
                            var format = jfgrid.conditionformat.dataBarList[itemvalue]["format"];

                            jfgrid.conditionformat.updateItem("dataBar", cellrange, format);
                        }
                    });

                    //色阶子菜单点击事件
                    $(document).off("click.CFcolorGradation").on("click.CFcolorGradation", "#jfgrid-icon-colorGradation-menuButton .jfgrid-cols-menuitem", function(){
                        $menuButton.hide();
                        $("#jfgrid-icon-colorGradation-menuButton").hide();
                        $("#" + container).attr("tabindex", 0).focus();

                        var $t = $(this), itemvalue = $t.attr("itemvalue");

                        if(jfgird_select_save.length > 0){
                            var cellrange = $.extend(true, [], jfgird_select_save);
                            var format = jfgrid.conditionformat.colorGradationList[itemvalue]["format"];

                            jfgrid.conditionformat.updateItem("colorGradation", cellrange, format);
                        }
                    });

                    //清除规则子菜单点击事件
                    $(document).off("click.CFdeleteRule").on("click.CFdeleteRule", "#jfgrid-icon-deleteRule-menuButton .jfgrid-cols-menuitem", function(){
                        $menuButton.hide();
                        $("#jfgrid-icon-deleteRule-menuButton").hide();
                        $("#" + container).attr("tabindex", 0).focus();

                        var $t = $(this), itemvalue = $t.attr("itemvalue");

                        if(itemvalue == "delSheet"){
                            jfgrid.conditionformat.updateItem("delSheet");
                        }
                    });
                }

                var userlen = $(this).outerWidth();
                var tlen = $menuButton.outerWidth();

                var menuleft = $(this).offset().left;
                if(tlen > userlen && (tlen + menuleft) > $("#" + container).width()){
                    menuleft = menuleft - tlen + userlen;
                }
                mouseclickposition($menuButton, menuleft, $(this).offset().top + 25, "lefttop");
            });

            //批注
            $("#jfgrid-icon-postil").click(function(){
                var menuButtonId = $(this).attr("id")+"-menuButton";
                var $menuButton = $("#" + menuButtonId);

                $menuButton.remove();

                // if($menuButton.length == 0){
                    jfgrid.postil.removeActivePs();

                    var last = jfgird_select_save[jfgird_select_save.length - 1];
                    
                    var row_index = last["row_focus"];
                    if(row_index == null){
                        row_index = last["row"][0];
                    }

                    var col_index = last["column_focus"];
                    if(col_index == null){
                        col_index = last["column"][0];
                    }

                    if(jfgrid.flowdata[row_index][col_index] != null && jfgrid.flowdata[row_index][col_index].ps != null){
                        var itemdata = [
                            {"text": "编辑批注", "value": "editPs", "example": ""},
                            {"text": "删除", "value": "delPs", "example": ""},
                            {"text": "", "value": "split", "example": ""},
                            {"text": "显示/隐藏批注", "value": "showHidePs", "example": ""},
                            {"text": "显示/隐藏所有批注", "value": "showHideAllPs", "example": ""}
                        ];
                    }
                    else{
                        var itemdata = [
                            {"text": "新建批注", "value": "newPs", "example": ""},
                            {"text": "", "value": "split", "example": ""},
                            {"text": "显示/隐藏所有批注", "value": "showHideAllPs", "example": ""}
                        ];
                    }
                    
                    var itemset = _this.createButtonMenu(itemdata);
                    var menu = jfgrid.replaceHtml(_this.menu, {"id": "postil", "item": itemset, "subclass": "", "sub": ""});
                    
                    $("body").append(menu);
                    $menuButton = $("#"+menuButtonId).width(150);

                    $menuButton.find(".jfgrid-cols-menuitem").click(function(){
                        $menuButton.hide();
                        $("#" + container).attr("tabindex", 0).focus();

                        var $t = $(this), itemvalue = $t.attr("itemvalue");
                        
                        if(itemvalue == "newPs"){
                            jfgrid.postil.newPs(row_index, col_index);
                        }
                        else if(itemvalue == "editPs"){
                            jfgrid.postil.editPs(row_index, col_index);
                        }
                        else if(itemvalue == "delPs"){
                            jfgrid.postil.delPs(row_index, col_index);
                        }
                        else if(itemvalue == "showHidePs"){
                            jfgrid.postil.showHidePs(row_index, col_index);
                        }
                        else if(itemvalue == "showHideAllPs"){
                            jfgrid.postil.showHideAllPs();
                        }
                    });
                // }

                var userlen = $(this).outerWidth();
                var tlen = $menuButton.outerWidth();

                var menuleft = $(this).offset().left;
                if(tlen > userlen && (tlen + menuleft) > $("#" + container).width()){
                    menuleft = menuleft - tlen + userlen;
                }
                mouseclickposition($menuButton, menuleft, $(this).offset().top + 25, "lefttop");
            });
            
            $("body").on("mouseover mouseleave",".jfgrid-menuButton .jfgrid-cols-submenu", function(e){
                var $t = $(this), attrid = $t.attr("itemvalue"), $attr = $("#jfgrid-icon-" + attrid + "-menuButton");
                //clearTimeout(_this.submenuhide);
                if (e.type === "mouseover") {
                    var $con = $t.parent();
                    var winW = $(window).width(), winH = $(window).height();
                    var menuW = $con.width(), attrH = $attr.height() + 25, attrW = $attr.width() + 5;
                    var offset = $t.offset();
                    var top = offset.top, left = offset.left + menuW;

                    if (left + attrW > winW) {
                        left = offset.left - attrW;
                    }

                    if (top + attrH > winH) {
                        top = winH - attrH;
                    }

                    $attr.css({ "top": top, "left": left }).show();
                    _this.rightclickmenu = $t;
                } else {
                    //var $t = $(this), attrid = $t.attr("itemvalue"), $attr = $("#" + attrid + "_sub");
                    _this.submenuhide = setTimeout(function () { $attr.hide(); }, 200);
                }
            }).on("mouseover mouseleave",".jfgrid-menuButton-sub", function(e){
                if (e.type === "mouseover") {
                    _this.rightclickmenu.addClass("jfgrid-cols-menuitem-hover");
                    clearTimeout(_this.submenuhide);
                } else {
                    _this.rightclickmenu.removeClass("jfgrid-cols-menuitem-hover");
                    $(this).hide();
                }
            });
        },
        fontarray:["微软雅黑","宋体","黑体","楷体","仿宋","新宋体","华文新魏","华文行楷","华文隶书","Arial","Times New Roman","Tahoma","Verdana"],
        fontjson:{"微软雅黑":0,"microsoft yahei":0,"宋体":1,"simsun":1,"黑体":2,"simhei":2,"楷体":3,"kaiti":3,"仿宋":4,"fangsong":4,"新宋体":5,"nsimsun":5,"华文新魏":6,"stxinwei":6,"华文行楷":7,"stxingkai":7,"华文隶书":8,"stliti":8,"arial":9,"times new roman":10,"tahoma":11,"verdana":12},
        getQKBorder:function(width, type, color){
            var borderType = {"0":"none", "1":"Thin", "2":"Hair", "3":"Dotted", "4":"Dashed", "5":"DashDot", "6":"DashDotDot", "7":"Double", "8":"Medium", "9":"MediumDashed", "10":"MediumDashDot", "11":"MediumDashDotDot", "12":"SlantedDashDot", "13":"Thick"};
            var style = 0;

            type = type.toLowerCase();

            // var bordertype = "solid";
            // if(type=="double"){
            //     style = 2;
            // }
            // else if(type=="dotted"){
            //     style = 2;
            // }
            // else if(type=="dashed"){
            //     style = 2;
            // }
            // else if(type=="solid"){
            //     style = 2;
            // }
            // else{
            //     style = 0;
            // }

            var bordertype = "";
            if(width.indexOf("pt")>-1){
                var width = parseFloat(width);
                if(width<1){

                }
                else if(width<1.5){
                    bordertype = "Medium";
                }
                else{
                    bordertype = "Thick";
                }
            }
            else{
                var width = parseFloat(width);
                if(width<2){

                }
                else if(width<3){
                    bordertype = "Medium";
                }
                else{
                    bordertype = "Thick";
                }
            }

            var bordertype = "solid";
            if(type=="double"){
                style = 2;
            }
            else if(type=="dotted"){
                if(bordertype=="Medium" || bordertype=="Thick"){
                    style = 3;
                }
                else{
                    style = 10;
                }
            }
            else if(type=="dashed"){
                if(bordertype=="Medium" || bordertype=="Thick"){
                    style = 4;
                }
                else{
                    style = 9;
                }
            }
            else if(type=="solid"){
                if(bordertype=="Medium"){
                    style = 8;
                }
                else if(bordertype=="Thick"){
                    style = 13;
                }
                else{
                    style = 1;
                }
            }

            
            // if(color.indexOf("rgb")>-1){
            //     color = jfgrid.rgbTohex(color);
            // }
            //console.log([style, color]);
            return [style, color];
        },
        updateFormat:function(d, attr, foucsStatus){
            var _this = this;

            var canvasElement = document.createElement('canvas');
            var canvas = canvasElement.getContext("2d");

            var cfg = $.extend(true, {}, config);
            if(cfg["rowlen"] == null){
                cfg["rowlen"] = {};
            }

            for(var s = 0; s < jfgird_select_save.length; s++){
                var row_st = jfgird_select_save[s]["row"][0], row_ed = jfgird_select_save[s]["row"][1];
                var col_st = jfgird_select_save[s]["column"][0], col_ed = jfgird_select_save[s]["column"][1];

                if(attr == "ct"){
                    for (var r = row_st; r <= row_ed; r++) {
                        if (config["rowhidden"] != null && config["rowhidden"][r] != null) {
                            continue;
                        }

                        for (var c = col_st; c <= col_ed; c++) {
                            var cell = d[r][c], value = null;
                            
                            if (jfgrid.getObjType(cell) == "object") {
                                value = d[r][c]["v"];
                            }
                            else{
                                value = d[r][c];
                            }

                            if(foucsStatus != "@" && jfgrid.func_methods.isRealNum(value)){
                                value = parseFloat(value);
                            }

                            var mask = jfgrid.mask.update(foucsStatus, value);
                            var type = "n";
                            if(jfgrid.mask.is_date(foucsStatus) || foucsStatus === 14 || foucsStatus === 15 || foucsStatus === 16 || foucsStatus === 17 || foucsStatus === 18 || foucsStatus === 19 || foucsStatus === 20 || foucsStatus === 21 || foucsStatus === 22 || foucsStatus === 45 || foucsStatus === 46 || foucsStatus === 47){
                                type = "d";
                            }
                            else if(foucsStatus == "@" || foucsStatus === 49){
                                type = "s"
                            }
                            else if(foucsStatus == "General" || foucsStatus === 0){
                                type = "g";
                            }

                            if (jfgrid.getObjType(cell) == "object") {
                                d[r][c]["m"] = mask;
                                if(d[r][c]["ct"] == null){
                                    d[r][c]["ct"] = {};
                                }
                                d[r][c]["ct"]["fa"] = foucsStatus;
                                d[r][c]["ct"]["t"] = type;
                            }
                            else{
                                d[r][c] = { "ct":{"fa":foucsStatus, "t":type}, "v": value, "m": mask };
                            }
                        }
                    }
                }
                else{
                    if(attr == "ht"){
                        if(foucsStatus == "left"){
                            foucsStatus = "1";
                        }
                        else if(foucsStatus == "center"){
                            foucsStatus = "0";
                        }
                        else if(foucsStatus == "right"){
                            foucsStatus = "2";
                        }
                    }
                    else if(attr == "vt"){
                        if(foucsStatus == "top"){
                            foucsStatus = "1";
                        }
                        else if(foucsStatus == "middle"){
                            foucsStatus = "0";
                        }
                        else if(foucsStatus == "bottom"){
                            foucsStatus = "2";
                        }
                    }
                    else if(attr == "tb"){
                        if(foucsStatus == "overflow"){
                            foucsStatus = "1";
                        }
                        else if(foucsStatus == "clip"){
                            foucsStatus = "0";
                        }
                        else if(foucsStatus == "wrap"){
                            foucsStatus = "2";
                        }
                    }
                    else if(attr == "tr"){
                        if(foucsStatus == "none"){
                            foucsStatus = "0";
                        }
                        else if(foucsStatus == "angleup"){
                            foucsStatus = "2";
                        }
                        else if(foucsStatus == "angledown"){
                            foucsStatus = "1";
                        }
                        else if(foucsStatus == "vertical"){
                            foucsStatus = "3";
                        }
                        else if(foucsStatus == "rotation-up"){
                            foucsStatus = "5";
                        }
                        else if(foucsStatus == "rotation-down"){
                            foucsStatus = "4";
                        }
                    }

                    for (var r = row_st; r <= row_ed; r++) {
                        if (config["rowhidden"] != null && config["rowhidden"][r] != null) {
                            continue;
                        }

                        for (var c = col_st; c <= col_ed; c++) {
                            var value = d[r][c];
                            
                            if (jfgrid.getObjType(value) == "object") {
                                d[r][c][attr] = foucsStatus;
                            }
                            else{
                                d[r][c] = { v: value };
                                d[r][c][attr] = foucsStatus;
                            }

                            if(attr == "tr" && d[r][c].tb != null){
                                d[r][c].tb = "0";
                            }
                        }
                    }
                }

                if(attr == "tb" && foucsStatus == "2"){
                    //自动换行
                    for (var r = row_st; r <= row_ed; r++) {
                        if (config["rowhidden"] != null && config["rowhidden"][r] != null) {
                            continue;
                        }

                        var currentRowLen = defaultrowlen;
                        if(cfg["rowlen"][r] != null){
                            currentRowLen = cfg["rowlen"][r];
                        }

                        for (var c = col_st; c <= col_ed; c++) {
                            var cell = d[r][c];

                            if(cell != null && !jfgrid.func_methods.isRealNull(cell.v)){
                                var fontset = jfgridfontformat(cell);
                                var oneLineTextHeight = jfgrid.menuButton.getTextSize("田", fontset)[1];
                                canvas.font = fontset;

                                var strValue = cell.m.toString();
                                var tbWidth = canvas.measureText(strValue).width;
                                var cellWidth = jfgrid.colLocationByIndex(c)[1] - jfgrid.colLocationByIndex(c)[0] - 8;

                                if(tbWidth > cellWidth){
                                    var strArr = [];//文本截断数组
                                    for(var strI = 1; strI <= strValue.length; strI++){
                                        var strV = strValue.substring(strArr.join("").length, strI);
                                        var strtextMetrics = canvas.measureText(strV).width;
                                        if(strtextMetrics > cellWidth){
                                            strArr.push(strValue.substring(strArr.join("").length, strI-1));
                                            strI = strI - 2;
                                        }
                                        else if(strtextMetrics <= cellWidth && strI == strValue.length){
                                            strArr.push(strV);
                                        }
                                    }
                                    var computeRowlen = oneLineTextHeight * strArr.length;
                                    //比较计算高度和当前高度取最大高度
                                    if(computeRowlen > currentRowLen){
                                        currentRowLen = computeRowlen;
                                    }
                                }
                            }
                        }

                        if(currentRowLen != defaultrowlen){
                            cfg["rowlen"][r] = currentRowLen;
                        }
                    }
                }
                else if(attr == "tr"){
                    //文本旋转
                    for (var r = row_st; r <= row_ed; r++) {
                        if (config["rowhidden"] != null && config["rowhidden"][r] != null) {
                            continue;
                        }

                        var currentRowLen = defaultrowlen;
                        if(cfg["rowlen"][r] != null){
                            currentRowLen = cfg["rowlen"][r];
                        }

                        for (var c = col_st; c <= col_ed; c++) {
                            var cell = d[r][c];

                            if(cell != null && !jfgrid.func_methods.isRealNull(cell.v)){
                                var fontset = jfgridfontformat(cell);
                                var oneLineTextHeight = jfgrid.menuButton.getTextSize("田", fontset)[1];
                                canvas.font = fontset;
                                
                                var value = cell.m.toString();
                                var textMetrics = canvas.measureText(value).width;

                                var computeRowlen; //计算高度
                                if(foucsStatus == "0"){
                                    //无旋转
                                    computeRowlen = oneLineTextHeight;    
                                }
                                else if(foucsStatus == "1" || foucsStatus == "2"){
                                    //向下倾斜（45 旋转）----向上倾斜（-45 旋转）
                                    computeRowlen = 0.707 * (textMetrics + oneLineTextHeight) + 4;
                                }
                                else if(foucsStatus == "3"){
                                    //竖排文字
                                    computeRowlen = value.length * oneLineTextHeight + 4;
                                }
                                else if(foucsStatus == "4" || foucsStatus == "5"){
                                    //向下90（90 旋转）----向上90（-90 旋转）
                                    computeRowlen = textMetrics + 4;
                                }
                                computeRowlen = Math.round(computeRowlen);
                                //比较计算高度和当前高度取最大高度
                                if(computeRowlen > currentRowLen){
                                    currentRowLen = computeRowlen;
                                }
                            }
                        }

                        if(currentRowLen != defaultrowlen){
                            cfg["rowlen"][r] = currentRowLen;
                        }
                    }
                }
                else if(attr == "fs"){
                    //字体大小
                    for (var r = row_st; r <= row_ed; r++) {
                        if (config["rowhidden"] != null && config["rowhidden"][r] != null) {
                            continue;
                        }

                        var currentRowLen = defaultrowlen;
                        if(cfg["rowlen"][r] != null){
                            currentRowLen = cfg["rowlen"][r];
                        }

                        for (var c = col_st; c <= col_ed; c++) {
                            var cell = d[r][c];

                            if(cell == null){
                                continue;
                            }

                            var fontset = jfgridfontformat(cell);
                            var oneLineTextHeight = jfgrid.menuButton.getTextSize("田", fontset)[1];
                            canvas.font = fontset;

                            //计算高度
                            var computeRowlen;
                            if(jfgrid.func_methods.isRealNull(cell.v)){
                                computeRowlen = oneLineTextHeight;
                            }
                            else{
                                if(cell.tb == "2"){
                                    //单元格有自动换行标示
                                    var strValue = cell.m.toString();
                                    var tbWidth = canvas.measureText(strValue).width;
                                    var cellWidth = jfgrid.colLocationByIndex(c)[1] - jfgrid.colLocationByIndex(c)[0] - 8;

                                    if(tbWidth > cellWidth){
                                        var strArr = [];//文本截断数组
                                        for(var strI = 1; strI <= strValue.length; strI++){
                                            var strV = strValue.substring(strArr.join("").length, strI);
                                            var strtextMetrics = canvas.measureText(strV).width;
                                            if(strtextMetrics > cellWidth){
                                                strArr.push(strValue.substring(strArr.join("").length, strI-1));
                                                strI = strI - 2;
                                            }
                                            else if(strtextMetrics <= cellWidth && strI == strValue.length){
                                                strArr.push(strV);
                                            }
                                        }
                                        
                                        computeRowlen = oneLineTextHeight * strArr.length;
                                    }
                                    else{
                                        computeRowlen = oneLineTextHeight;
                                    }
                                }
                                else if(cell.tr != null){
                                    //单元格有旋转标示
                                    var tr = cell.tr;
                                    var value = cell.m.toString();
                                    var textMetrics = canvas.measureText(value).width;

                                    if(tr == "0"){
                                        //无旋转
                                        computeRowlen = oneLineTextHeight;    
                                    }
                                    else if(tr == "1" || tr == "2"){
                                        //向下倾斜（45 旋转）----向上倾斜（-45 旋转）
                                        computeRowlen = 0.707 * (textMetrics + oneLineTextHeight) + 4;
                                    }
                                    else if(tr == "3"){
                                        //竖排文字
                                        computeRowlen = value.length * oneLineTextHeight + 4;
                                    }
                                    else if(tr == "4" || tr == "5"){
                                        //向下90（90 旋转）----向上90（-90 旋转）
                                        computeRowlen = textMetrics + 4;
                                    }

                                    computeRowlen = Math.round(computeRowlen);
                                }
                                else{
                                    computeRowlen = oneLineTextHeight;
                                }
                            }

                            //比较计算高度和当前高度取最大高度
                            if(computeRowlen > currentRowLen){
                                currentRowLen = computeRowlen;
                            }
                        }

                        if(currentRowLen != defaultrowlen){
                            cfg["rowlen"][r] = currentRowLen;
                        }
                    }
                }
            }

            if((attr == "tb" && foucsStatus == "2") || attr == "tr" || attr == "fs"){
                jfgrid.jfrefreshgrid(d, jfgird_select_save, cfg, null, true);
            }
            else{
                jfgrid.jfrefreshgrid(d, jfgird_select_save);
            }
        },
        updateFormat_mc: function(d, foucsStatus){
            var cfg = $.extend(true, {}, config);
            if(cfg["merge"] == null){
                cfg["merge"] = {};
            }

            if(foucsStatus == "mergeCancel"){
                for(var i = 0; i < jfgird_select_save.length; i++){
                    var range = jfgird_select_save[i];
                    var r1 = range["row"][0], r2 = range["row"][1];
                    var c1 = range["column"][0], c2 = range["column"][1];

                    if(r1 == r2 && c1 == c2){
                        continue;
                    }

                    var fv = {};

                    for(var r = r1; r <= r2; r++){
                        for(var c = c1; c <= c2; c++){
                            var cell = d[r][c];

                            if(cell != null && cell.mc != null){
                                var mc_r = cell.mc.r, mc_c = cell.mc.c;

                                if("rs" in cell.mc){
                                    delete cell.mc;
                                    delete cfg["merge"][mc_r + "_" + mc_c];

                                    fv[mc_r + "_" + mc_c] = $.extend(true, {}, cell);
                                }
                                else{
                                    var cell_clone = fv[mc_r + "_" + mc_c];

                                    delete cell_clone.v;
                                    delete cell_clone.m;
                                    delete cell_clone.ct;
                                    delete cell_clone.f;
                                    delete cell_clone.spl;

                                    d[r][c] = cell_clone;
                                }
                            }
                        }
                    }
                }
            }
            else{
                var isHasMc = false; //选区是否含有 合并的单元格
                for(var i = 0; i < jfgird_select_save.length; i++){
                    var range = jfgird_select_save[i];
                    var r1 = range["row"][0], r2 = range["row"][1];
                    var c1 = range["column"][0], c2 = range["column"][1];

                    for(var r = r1; r <= r2; r++){
                        for(var c = c1; c <= c2; c++){
                            var cell = d[r][c];

                            if(jfgrid.getObjType(cell) == "object" && ("mc" in cell)){
                                isHasMc = true;
                                break;
                            }
                        }
                    }
                }

                if(isHasMc){//选区有合并单元格（选区都执行 取消合并）
                    for(var i = 0; i < jfgird_select_save.length; i++){
                        var range = jfgird_select_save[i];
                        var r1 = range["row"][0], r2 = range["row"][1];
                        var c1 = range["column"][0], c2 = range["column"][1];

                        if(r1 == r2 && c1 == c2){
                            continue;
                        }

                        var fv = {};

                        for(var r = r1; r <= r2; r++){
                            for(var c = c1; c <= c2; c++){
                                var cell = d[r][c];

                                if(cell != null && cell.mc != null){
                                    var mc_r = cell.mc.r, mc_c = cell.mc.c;

                                    if("rs" in cell.mc){
                                        delete cell.mc;
                                        delete cfg["merge"][mc_r + "_" + mc_c];

                                        fv[mc_r + "_" + mc_c] = $.extend(true, {}, cell);
                                    }
                                    else{
                                        var cell_clone = fv[mc_r + "_" + mc_c];

                                        delete cell_clone.v;
                                        delete cell_clone.m;
                                        delete cell_clone.ct;
                                        delete cell_clone.f;
                                        delete cell_clone.spl;

                                        d[r][c] = cell_clone;
                                    }
                                }
                            }
                        }
                    }
                }
                else{
                    for(var i = 0; i < jfgird_select_save.length; i++){
                        var range = jfgird_select_save[i];
                        var r1 = range["row"][0], r2 = range["row"][1];
                        var c1 = range["column"][0], c2 = range["column"][1];

                        if(r1 == r2 && c1 == c2){
                            continue;
                        }

                        if(foucsStatus == "mergeAll"){
                            var fv = {}, isfirst = false;

                            for(var r = r1; r <= r2; r++){
                                for(var c = c1; c <= c2; c++){
                                    var cell = d[r][c];

                                    if(cell != null && (!jfgrid.func_methods.isRealNull(cell.v) || cell.f != null) && !isfirst){
                                        fv = $.extend(true, {}, cell);
                                        isfirst = true;
                                    }

                                    d[r][c] = { "mc": { "r": r1, "c": c1 } };
                                }
                            }

                            d[r1][c1] = fv;
                            d[r1][c1].mc = { "r": r1, "c": c1, "rs": r2 - r1 + 1, "cs": c2 - c1 + 1 };

                            cfg["merge"][r1 + "_" + c1] = { "r": r1, "c": c1, "rs": r2 - r1 + 1, "cs": c2 - c1 + 1 };
                        }
                        else if(foucsStatus == "mergeV"){
                            for(var c = c1; c <= c2; c++){
                                var fv = {}, isfirst = false;

                                for(var r = r1; r <= r2; r++){
                                    var cell = d[r][c];

                                    if(cell != null && (!jfgrid.func_methods.isRealNull(cell.v) || cell.f != null) && !isfirst){
                                        fv = $.extend(true, {}, cell);
                                        isfirst = true;
                                    }

                                    d[r][c] = { "mc": { "r": r1, "c": c } };
                                }

                                d[r1][c] = fv;
                                d[r1][c].mc = { "r": r1, "c": c, "rs": r2 - r1 + 1, "cs": 1 };

                                cfg["merge"][r1 + "_" + c] = { "r": r1, "c": c, "rs": r2 - r1 + 1, "cs": 1 };
                            }
                        }
                        else if(foucsStatus == "mergeH"){
                            for(var r = r1; r <= r2; r++){
                                var fv = {}, isfirst = false;

                                for(var c = c1; c <= c2; c++){
                                    var cell = d[r][c];

                                    if(cell != null && (!jfgrid.func_methods.isRealNull(cell.v) || cell.f != null) && !isfirst){
                                        fv = $.extend(true, {}, cell);
                                        isfirst = true;
                                    }

                                    d[r][c] = { "mc": { "r": r, "c": c1 } };
                                }

                                d[r][c1] = fv;
                                d[r][c1].mc = { "r": r, "c": c1, "rs": 1, "cs": c2 - c1 + 1 };

                                cfg["merge"][r + "_" + c1] = { "r": r, "c": c1, "rs": 1, "cs": c2 - c1 + 1 };
                            }
                        }
                    }
                }
            }

            if (clearjfundo) {
                jfgrid.jfundo = [];
                jfgrid.jfredo.push({
                    "type": "mergeChange",
                    "sheetIndex": jfgrid.currentSheetIndex,
                    "data": jfgrid.flowdata,
                    "curData": d,
                    "range": $.extend(true, [], jfgird_select_save),
                    "config": $.extend(true, {}, config),
                    "curConfig": cfg
                });
            }

            clearjfundo = false;
            jfgrid.jfrefreshgrid(d, jfgird_select_save, cfg);
            clearjfundo = true;
        },
        borderfix:function(d, r, c){
            return [-1, -1, 2, 2];

            var cell = d[r][c];
            var bg = null;
            
            if(cell == null){
                return [0, 0, 0, 0];
            }
            else if(d[r][c].bg == null || d[r][c].bg == ""){
                return [0, 0, 0, 0];
            }
            else {
                return [-1, -1, 2, 2];
            }
        },
        menuButtonFocus:function(d, r, c){
            var foucsList = ["bl", "it", "cl", "ff", "ht", "vt", "fs", "tb", "tr"];
            var _this = this;

            for(var i = 0; i < foucsList.length; i++){
                var attr = foucsList[i];
                var foucsStatus = _this.checkstatus(d, r, c, attr);

                if(attr == "bl"){
                    if(foucsStatus != "0"){
                        $("#jfgrid-icon-bold").addClass("jfgrid-toolbar-button-hover");
                    }
                    else{
                        $("#jfgrid-icon-bold").removeClass("jfgrid-toolbar-button-hover");
                    }
                }
                else if(attr == "it"){
                    if(foucsStatus != "0"){
                        $("#jfgrid-icon-italic").addClass("jfgrid-toolbar-button-hover");
                    }
                    else{
                        $("#jfgrid-icon-italic").removeClass("jfgrid-toolbar-button-hover");
                    }
                }
                else if(attr == "cl"){
                    if(foucsStatus != "0"){
                        $("#jfgrid-icon-strikethrough").addClass("jfgrid-toolbar-button-hover");
                    }
                    else{
                        $("#jfgrid-icon-strikethrough").removeClass("jfgrid-toolbar-button-hover");
                    }
                }
                else if(attr == "ff"){
                    var menuButtonId = "jfgrid-icon-font-family-menuButton";
                    var $menuButton = $("#"+menuButtonId);
                    var itemname = "微软雅黑", itemvalue = 0;
                    
                    if(foucsStatus != null){
                        var fontfamily = null;
                        
                        if(jfgrid.isdatatypemulti(foucsStatus)["num"]){
                            itemvalue = parseInt(foucsStatus);
                            itemname = _this.fontarray[itemvalue];
                        }
                        else{
                            itemvalue = _this.fontjson[foucsStatus];
                            itemname = _this.fontarray[itemvalue];
                        }   
                    }

                    _this.focus($menuButton, itemvalue);
                    $("#jfgrid-icon-font-family").find(".jfgrid-toolbar-menu-button-caption").html(" "+ itemname +" ");
                }
                else if(attr == "fs"){
                    var $menuButton = $("#jfgrid-icon-font-size-menuButton");
                    var itemvalue = foucsStatus, $input = $("#jfgrid-icon-font-size input");
                    _this.focus($menuButton, itemvalue);
                    $("#jfgrid-icon-font-size").attr("itemvalue", itemvalue);
                    $input.val(itemvalue);
                }
                else if(attr == "ht"){
                    var $menuButton = $("#jfgrid-icon-align-menu-menuButton");
                    var $t = $("jfgrid-icon-align"), itemvalue = "left";
                    
                    if(foucsStatus == "0"){
                        itemvalue = "center";
                    }
                    else if(foucsStatus == "2"){
                        itemvalue = "right";
                    }

                    _this.focus($menuButton, itemvalue);

                    var $icon = $("#jfgrid-icon-align").attr("type", itemvalue).find(".jfgrid-icon-img-container");
                    $icon.removeAttr("class").addClass("jfgrid-icon-img-container jfgrid-icon-img jfgrid-icon-align-" + itemvalue);
                    $menuButton.hide();
                }
                else if(attr == "vt"){
                    var $menuButton = $("#jfgrid-icon-valign-menu-menuButton");
                    var $t = $("jfgrid-icon-valign"), itemvalue = "bottom";
                    
                    if(foucsStatus == "1"){
                        itemvalue = "top";
                    }
                    else if(foucsStatus == "0"){
                        itemvalue = "middle";
                    }

                    _this.focus($menuButton, itemvalue);

                    var $icon = $("#jfgrid-icon-valign").attr("type", itemvalue).find(".jfgrid-icon-img-container");
                    $icon.removeAttr("class").addClass("jfgrid-icon-img-container jfgrid-icon-img jfgrid-icon-valign-" + itemvalue);
                    $menuButton.hide();
                }
                else if(attr == "tb"){
                    var $menuButton = $("#jfgrid-icon-textwrap-menu-menuButton");
                    var $t = $("jfgrid-icon-textwrap"), itemvalue = "clip";
                    
                    if(foucsStatus == "1"){
                        itemvalue = "overflow";
                    }
                    else if(foucsStatus == "2"){
                        itemvalue = "wrap";
                    }

                    _this.focus($menuButton, itemvalue);

                    var $icon = $("#jfgrid-icon-textwrap").attr("type", itemvalue).find(".jfgrid-icon-img-container");
                    $icon.removeAttr("class").addClass("jfgrid-icon-img-container jfgrid-icon-img jfgrid-icon-textwrap-" + itemvalue);
                    $menuButton.hide();
                }
                else if(attr == "tr"){
                    var $menuButton = $("#jfgrid-icon-rotation-menu-menuButton");
                    var $t = $("jfgrid-icon-rotation"), itemvalue = "none";
                    
                    if(foucsStatus == "1"){
                        itemvalue = "angledown";
                    }
                    else if(foucsStatus == "2"){
                        itemvalue = "angleup";
                    }
                    else if(foucsStatus == "3"){
                        itemvalue = "vertical";
                    }
                    else if(foucsStatus == "4"){
                        itemvalue = "rotation-down";
                    }
                    else if(foucsStatus == "5"){
                        itemvalue = "rotation-up";
                    }

                    _this.focus($menuButton, itemvalue);

                    var $icon = $("#jfgrid-icon-rotation").attr("type", itemvalue).find(".jfgrid-icon-img-container");
                    $icon.removeAttr("class").addClass("jfgrid-icon-img-container jfgrid-icon-img jfgrid-icon-rotation-" + itemvalue);
                    $menuButton.hide();
                }
            }
        },
        checkstatus:function(d, r, c, a){
            var foucsStatus = d[r][c];
            var tf = {"bl":1, "it":1 , "ff":1, "cl":1};
            if(a in tf){
                if(foucsStatus==null){
                    foucsStatus = "0";
                }
                else{
                    foucsStatus = foucsStatus[a];
                    if(foucsStatus==null){
                        foucsStatus="0";
                    }
                }
            }
            else if(a == "fc"){
                if(foucsStatus == null){
                    foucsStatus = "#000000";
                }
                else{
                    foucsStatus = foucsStatus[a];

                    if(foucsStatus == null){
                        foucsStatus = "#000000";
                    }

                    if(foucsStatus.indexOf("rgba") > -1){
                        foucsStatus = jfgrid.rgbTohex(foucsStatus);
                    }
                }
            }
            else if(a == "bg"){
                if(foucsStatus == null){
                    foucsStatus = "#ffffff";
                }
                else{
                    foucsStatus = foucsStatus[a];

                    if(foucsStatus == null){
                        foucsStatus = "#ffffff";
                    }
                    
                    if(foucsStatus.toString().indexOf("rgba") > -1){
                        foucsStatus = jfgrid.rgbTohex(foucsStatus);
                    }
                }
            }
            else if(a.substr(0, 2) == "bs"){
                if(foucsStatus==null){
                    foucsStatus = "none";
                }
                else{
                    foucsStatus = foucsStatus[a];
                    if(foucsStatus==null){
                        foucsStatus = "none";
                    }
                }
            }
            else if(a.substr(0, 2) == "bc"){
                //console.log(foucsStatus[a]);
                if(foucsStatus==null){
                    foucsStatus = "#000000";
                }
                else{
                    foucsStatus = foucsStatus[a];
                    if(foucsStatus==null){
                        foucsStatus = "#000000";
                    }
                }
            }
            else if(a == "ht"){
                if(foucsStatus == null){
                    foucsStatus = "1";
                }
                else{
                    foucsStatus = foucsStatus[a];
                    if(foucsStatus == null){
                        foucsStatus = "1";
                    }
                }

                if(["0", "1", "2"].indexOf(foucsStatus) == -1){
                    foucsStatus = "1";
                }
            }
            else if(a == "vt"){
                if(foucsStatus == null){
                    foucsStatus = "2";
                }
                else{
                    foucsStatus = foucsStatus[a];
                    if(foucsStatus == null){
                        foucsStatus = "2";
                    }
                }

                if(["0", "1", "2"].indexOf(foucsStatus) == -1){
                    foucsStatus = "2";
                }
            }
            else if(a == "ct"){
                if(foucsStatus==null){
                    foucsStatus = null;
                }
                else{
                    foucsStatus = foucsStatus[a];
                    if(foucsStatus==null){
                        foucsStatus = null;
                    }
                }
            }
            else if(a == "fs"){
                if(foucsStatus==null){
                    foucsStatus = "10";
                }
                else{
                    foucsStatus = foucsStatus[a];
                    if(foucsStatus==null){
                        foucsStatus = "10";
                    }
                }
            }
            else if(a == "tb"){
                if(foucsStatus==null){
                    foucsStatus = "0";
                }
                else{
                    foucsStatus = foucsStatus[a];
                    if(foucsStatus==null){
                        foucsStatus = "0";
                    }
                }
            }
            else if(a == "tr"){
                if(foucsStatus==null){
                    foucsStatus = "0";
                }
                else{
                    foucsStatus = foucsStatus[a];
                    if(foucsStatus==null){
                        foucsStatus = "0";
                    }
                }
            }


            return foucsStatus;
        },
        setLineDash:function(canvasborder, type, hv, m_st, m_ed, line_st, line_ed){
        
        	var borderType = {"0":"none", "1":"Thin", "2":"Hair", "3":"Dotted", "4":"Dashed", "5":"DashDot", "6":"DashDotDot", "7":"Double", "8":"Medium", "9":"MediumDashed", "10":"MediumDashDot", "11":"MediumDashDotDot", "12":"SlantedDashDot", "13":"Thick"};

        	type = borderType[type.toString()];

        	try {
	        	if(type=="Hair"){
	                canvasborder.setLineDash([1, 2]);
	            }
	            else if(type.indexOf("DashDotDot")>-1){
	                canvasborder.setLineDash([2, 2, 5, 2, 2]);
	            }
	            else if(type.indexOf("DashDot")>-1){
	                canvasborder.setLineDash([2, 5, 2]);
	            }
	            else if(type.indexOf("Dotted")>-1){
	                canvasborder.setLineDash([2]);
	            }
	            else if(type.indexOf("Dashed")>-1){
	                canvasborder.setLineDash([3]);
	            }
	            else{
	            	canvasborder.setLineDash([0]);
	            }
	        } catch(e) {
        		console.log(e);
        	}

            canvasborder.beginPath();

            if(type.indexOf("Medium")>-1){
            	if(hv=="h"){
            		canvasborder.moveTo(m_st, m_ed-0.5);
                	canvasborder.lineTo(line_st, line_ed-0.5);
            	}
            	else{
            		canvasborder.moveTo(m_st-0.5, m_ed);
                	canvasborder.lineTo(line_st-0.5, line_ed);
            	}
                
                canvasborder.lineWidth = 2*devicePixelRatio;
            }
            else if(type=="Thick"){
                canvasborder.moveTo(m_st, m_ed);
                canvasborder.lineTo(line_st, line_ed);
                canvasborder.lineWidth = 3*devicePixelRatio;
            }
            else {
                canvasborder.moveTo(m_st, m_ed);
                canvasborder.lineTo(line_st, line_ed);
                canvasborder.lineWidth = devicePixelRatio;
            }
        },
        moveMergeData:function(d, offset_r, offset_c){
            if(jfgrid.func_methods.isRealNull(d)){
                return d;
            }

            var deleMC = [], insertMC=[], hasMC = false;
            for(var r = 0; r < d.length; r++){
                for(var c = 0; c < d[0].length; c++){
                    var cell = d[r][c];
                    
                    if(jfgrid.getObjType(cell) == "object" && ("mc" in cell)){
                        if(cell.mc.rs != null){
                            //deleMC.push(cell.mc.r + "_" + cell.mc.c);
                            deleMC.push({ rs: cell.mc.rs, cs: cell.mc.cs, r: cell.mc.r, c: cell.mc.c});
                            //insertMC.push((cell.mc.r+offset_r) + "_" + (cell.mc.c+offset_c));
                            insertMC.push({ rs: cell.mc.rs, cs: cell.mc.cs, r: cell.mc.r+offset_r, c: cell.mc.c+offset_c});

                            hasMC= true;
                        }

                        d[r][c].mc.r += offset_r;
                        d[r][c].mc.c += offset_c;
                    }
                }
            }

            return {"deleMC":deleMC, "insertMC":insertMC, "hasMC": hasMC};
        },
        getRangeInMerge:function(st_r, rlen, st_c, clen, sheetIndex){
            var mergelist = [];
            var cfg = null;
            if(sheetIndex!=null){
                //cfg = $.extend(true, {}, jfgridfile[jfgrid.sheetmanage.getSheetIndex(sheetIndex)].config);
                cfg = $.extend(true, {}, jfgrid.sheetmanage.getSheetConfig());
            }
            else{
                cfg = $.extend(true, {}, config)
            }

            //console.log(cfg);

            if(cfg!=null && cfg["merge"]!=null){
                for(var key in cfg["merge"]){
                    var mc = cfg["merge"][key];
                    //console.log(!( (st_r+rlen-1) < mc.r || st_r>(mc.r+mc.rs-1)), !((st_c+clen-1) < mc.c || st_c>(mc.c+mc.cs-1)));
                    if( !( (st_r+rlen-1) < mc.r || st_r>(mc.r+mc.rs-1)) && !((st_c+clen-1) < mc.c || st_c>(mc.c+mc.cs-1)) ){
                        mergelist.push(mc);
                    }
                }
            }
            return mergelist;
        },
        mergeborer:function(d, row_index, col_index){
            var value = d[row_index][col_index];
            
            if(jfgrid.getObjType(value) == "object" && ("mc" in value)){
                var margeMaindata = value["mc"];
                col_index = margeMaindata.c;
                row_index = margeMaindata.r;

                var col_rs = d[row_index][col_index].mc.cs;
                var row_rs = d[row_index][col_index].mc.rs;

                var scrollWidth = $("#jfgrid-cell-main").scrollLeft();

                var scrollHeight = $("#jfgrid-cell-main").scrollTop();

                var start_r, end_r;
                //var r= row_index, c = col_index;
                var margeMain = d[row_index][col_index].mc;
                
                var row_pre , row , col , col_pre;
                for(var r = row_index; r < margeMain.rs + row_index; r++){
                    if (r == 0) {
                        start_r = - 1;
                    }
                    else {
                        start_r = visibledatarow[r - 1] - 1;
                    }

                    end_r = visibledatarow[r];

                    if(row_pre == null){
                        row_pre = start_r;
                        row = end_r;
                    }
                    else{
                        row += end_r - start_r - 1;
                    }
                }

                var start_c, end_c; 
                for(var c = col_index; c < margeMain.cs + col_index; c++){
                    if (c == 0) {
                        start_c = 0;
                    }
                    else {
                        start_c = visibledatacolumn[c - 1];
                    }

                    end_c = visibledatacolumn[c];

                    if(col_pre == null){
                        col_pre = start_c;
                        col = end_c;
                    }
                    else{
                        col += end_c - start_c;
                    }
                }

                return {"row": [row_pre , row, row_index, row_index + row_rs - 1], "column": [col_pre, col , col_index, col_index + col_rs - 1]};
            }
            else{
                return null;
            }
        },
        mergeMoveData:{},
        mergeMoveMain:function(columnseleted, rowseleted, s, top , height, left , width){
            var mergesetting = jfgrid.sheetmanage.getSheetMerge();
            var _this = this;
            
            if(mergesetting==null){
                return;
            }

            var mcset = [];
            for(var key in mergesetting){
                mcset.push(key);
            }

            if(rowseleted[0]>rowseleted[1]){
                rowseleted[1] = rowseleted[0];
            }

            if(columnseleted[0]>columnseleted[1]){
                columnseleted[1] = columnseleted[0];
            }

            var columnseleted1 = [].concat(columnseleted);
            var rowseleted1= [].concat(rowseleted);
            var top1 = top;
            var height1 = height;
            var left1 = left;
            var width1 = width;

            //var anchor = mcset.length;
            var offloop = true;
            _this.mergeMoveData = {};

            //console.log(rowseleted1);

            while (offloop) {
                offloop = false;
                for(var i=0;i<mcset.length;i++){
                    var key = mcset[i];
                    var mc = mergesetting[key];
                    if(key in _this.mergeMoveData){
                        continue;
                    }
                    //console.log(rowseleted[0],row_ed , rowseleted[1],row_st , columnseleted[0],col_ed , columnseleted[1],col_st);
                    //!(columnseleted[0]<=col_st && columnseleted[1]>=col_ed && rowseleted[0]<=row_st && rowseleted[1]>=row_ed) &&
                    var changeparam  = _this.mergeMove(mc, columnseleted, rowseleted, s, top , height, left , width);

                    //console.log(key, changeparam);
                    if(changeparam!=null){
                        _this.mergeMoveData[key] = mc;
                        
                        columnseleted = changeparam[0];
                        rowseleted= changeparam[1];
                        top = changeparam[2];
                        height = changeparam[3];
                        left = changeparam[4];
                        width = changeparam[5];

                        offloop = true;
                    }
                    else{
                        delete _this.mergeMoveData[key];
                    }
                }

            }
            
            //console.log(rowseleted);
            // if(rowseleted[0]>rowseleted[1]){
            //     rowseleted =  rowseleted1;
            //     height = height1;
            //     top = top1;
            // }
            return [columnseleted, rowseleted, top , height, left , width];
        },
        mergeMove:function(mc, columnseleted, rowseleted, s, top , height, left , width){
            var row_st = mc.r, row_ed = mc.r + mc.rs - 1;
            var col_st = mc.c, col_ed = mc.c + mc.cs - 1;

            var ismatch = false;
            var _this = this;

            if(columnseleted[1] < columnseleted[0]){
                columnseleted[0] = columnseleted[1];
            }

            if(rowseleted[1] < rowseleted[0]){
                rowseleted[0] = rowseleted[1];
            }

            if( (columnseleted[0] <= col_st && columnseleted[1] >= col_ed && rowseleted[0] <= row_st && rowseleted[1] >= row_ed) || (!(columnseleted[1] < col_st || columnseleted[0] > col_ed) && !(rowseleted[1] < row_st || rowseleted[0] > row_ed))){
                var margeset = jfgrid.menuButton.mergeborer(jfgrid.flowdata, mc.r, mc.c);
                if(!!margeset){
                    var row = margeset.row[1],
                        row_pre = margeset.row[0],
                        row_index = margeset.row[2],
                        col = margeset.column[1],
                        col_pre = margeset.column[0],
                        col_index = margeset.column[2];

                    // var row_edc = row_ed, row_stc = row_st;
                    // var col_edc = col_ed, col_stc = col_st;
                    // for(var key in _this.mergeMoveData){
                    //     var othermc = _this.mergeMoveData[key];
                    //     var otherMargeset = jfgrid.menuButton.mergeborer(jfgrid.flowdata, othermc.r, othermc.c);
                    //     //console.log(row, otherMargeset.row[1], row_pre, otherMargeset.row[0]);
                    //     // row = row>otherMargeset.row[1]?row:otherMargeset.row[1];
                    //     // row_pre = row_pre<otherMargeset.row[0]?row_pre:otherMargeset.row[0];

                    //     // col = col>otherMargeset.column[1]?col:otherMargeset.column[1];
                    //     // col_pre = col_pre<otherMargeset.column[0]?col_pre:otherMargeset.column[0];
                    //     //console.log(row, otherMargeset.row[1], row_pre, otherMargeset.row[0]);

                    //     var row_ed1 = othermc.r + othermc.rs - 1, row_st1 = othermc.r;
                    //     var col_ed1 = othermc.c + othermc.cs - 1, col_st1 = othermc.c;

                    //     row_edc = row_edc>row_ed1?row_edc:row_ed1;
                    //     row_stc = row_stc<row_st1?row_stc:row_st1;

                    //     col_edc = col_edc>col_ed1?col_edc:col_ed1;
                    //     col_stc = col_stc<col_st1?col_stc:col_st1;

                    // }

                    
                    // if(row_stc > rowseleted[0] && jfgird_select_save.row_focus > row_stc){
                    //     rowseleted[0] = row_stc;
                    // }

                    // if(row_edc < rowseleted[1] && jfgird_select_save.row_focus < row_edc){
                    //     rowseleted[1] = row_edc;
                    // }

                    

                    //console.log(rowseleted, row_st, row_ed, columnseleted, col_st, col_ed);
                    //console.log("sssss");
                    //_this.mergeMoveData[key] = "1";

                    var top1 = null , height1 = null, left1 = null, width1 = null;
                    if(!(columnseleted[1] < col_st || columnseleted[0] > col_ed)){
                        //向上滑动
                        if(rowseleted[0] <= row_ed && rowseleted[0] >= row_st){
                            // var fix = jfgird_select_save.height;
                            // if(jfgird_select_save.row_focus>=row_st && jfgird_select_save.row_focus<=row_ed){
                            //     fix = height;
                            // }
                            // height = jfgird_select_save.top + fix - row_pre;
                            height += top - row_pre;
                            top = row_pre;
                            rowseleted[0] = row_st;
                            //console.log("向上滑动");
                        }
                        
                        //向下滑动或者居中时往上滑动的向下补齐
                        if(rowseleted[1] >= row_st && rowseleted[1] <= row_ed){
                            if(s.row_focus >= row_st && s.row_focus <= row_ed){
                                //height =  height + row - jfgird_select_save.top-jfgird_select_save.height;
                                height = row - top;
                            }
                            else{
                                height = row - top;
                            }
                            
                            rowseleted[1] = row_ed;
                            //console.log("向下滑动");
                        }
                        // if(rowseleted[0]>=row_st && rowseleted[1]<=row_ed){
                        //     top = row_pre;
                        //     height = row - top;

                        //     rowseleted[0] = row_st;
                        //     rowseleted[1] = row_ed;
                        //     console.log("居中");
                        // }
                        // else if(rowseleted[0]>=row_st){
                        //     top = row_pre;
                        //     height = jfgird_select_save.top + height - row_pre;

                        // }
                        // else if(rowseleted[1]<=row_ed){
                        //     height =  height + row - jfgird_select_save.top;
                        // }
                    }
                    
                    if(!(rowseleted[1] < row_st || rowseleted[0] > row_ed)){
                        //console.log(columnseleted, col_st, col_ed);
                        if(columnseleted[0] <= col_ed && columnseleted[0] >= col_st){
                            // left = col_pre;
                            // var fix = jfgird_select_save.width;
                            // if(jfgird_select_save.column_focus>=col_st && jfgird_select_save.column_focus<=col_ed){
                            //     fix = width;
                            // }
                            // width = jfgird_select_save.left + fix - col_pre;
                            width += left - col_pre;
                            left = col_pre;
                            columnseleted[0] = col_st;
                        }
                        
                        //向右滑动或者居中时往左滑动的向下补齐
                        if(columnseleted[1] >= col_st && columnseleted[1] <= col_ed){
                            if(s.column_focus >= col_st && s.column_focus <= col_ed){
                                //width =  width + col - jfgird_select_save.left-jfgird_select_save.width;
                                width = col - left;
                            }
                            else{
                                width = col - left;
                            }
                            
                            columnseleted[1] = col_ed;
                        }
                        // if(columnseleted[0]>=col_st && columnseleted[1]<=col_ed){
                        //     left = col_pre;
                        //     width = col - left;

                        //     columnseleted[0] = col_st;
                        //     columnseleted[1] = col_ed;
                        // }
                    }

                    ismatch = true;
                }
            }
           
            if(ismatch){
                return [columnseleted, rowseleted, top , height, left , width];
            }
            else{
                return null;
            }
        },
        getCellRealSize:function(d, cell_r, cell_c){
            var width = jfgrid.defaultcollen;
            var height = jfgrid.defaultrowlen;
            var celldata = d[cell_r][cell_c];
            if(!!celldata && celldata["mc"]!=null){
                var mc = celldata["mc"];
                var margeset = jfgrid.menuButton.mergeborer(d, mc.r, mc.c);
                if(!!margeset){
                    var row = margeset.row[1];
                    var row_pre = margeset.row[0];
                    var row_index = margeset.row[2];
                    var row_index_ed = margeset.row[3];

                    var col = margeset.column[1];
                    var col_pre = margeset.column[0];
                    var col_index = margeset.column[2];
                    var col_index_ed = margeset.column[3];                    

                    width = col - col_pre - 1;
                    height = row - row_pre - 1;
                }
            }
            else{
                var config=jfgrid.getjfgridfile()[jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex)]["config"];
                
                if (config["columlen"] != null && config["columlen"][cell_c] != null) {
                    width = config["columlen"][cell_c];
                }
                
                if (config["rowlen"] != null && config["rowlen"][cell_r] != null) {
                    height = config["rowlen"][cell_r];
                }
            }

            return [width, height];
        },
        getTextHeightCache:{},
        getTextSize:function(text, font){
            var f = font || '10pt 微软雅黑';
            var _this = this;
            if (f in _this.getTextHeightCache){
                return _this.getTextHeightCache[f];
            }

            if($("#jfgridTextSizeTest").length==0){
                $('<span id="jfgridTextSizeTest" style="float:left;white-space:nowrap;visibility:hidden">' + text + '</span>').appendTo($('body'));
            }

            var o = $("#jfgridTextSizeTest").text(text).css({'font': f}),
                w = o.width(), h = o.height();
            _this.getTextHeightCache[f] = [w, h];
            return [w, h];
        },
        activeFormulaInput:function(row_index, col_index, rowh, columnh, formula, isnull){
            if(isnull==null){
                isnull = false;
            }
            var row_range = jfgrid.rowLocationByIndex(row_index);
            var col_range = jfgrid.colLocationByIndex(col_index);

            jfgrid.jfgridupdateCell(row_range[1], row_range[0], row_index, col_range[1], col_range[0], col_index, jfgrid.flowdata, true);

            //console.log(row_index, col_index, row, column);
            if(isnull){
                var formulaTxt = '<span dir="auto" class="jfgrid-formula-text-color">=</span><span dir="auto" class="jfgrid-formula-text-color">'+ formula.toUpperCase() +'</span><span dir="auto" class="jfgrid-formula-text-color">(</span><span dir="auto" class="jfgrid-formula-text-color">)</span>';

                $("#jfgrid-rich-text-editor").html(formulaTxt);

                var currSelection = window.getSelection();
                var $span = $("#jfgrid-rich-text-editor").find("span");
                jfgrid.formula.setCaretPosition($span.get($span.length-2), 0, 1);

                return;
            }

            var row_pre = jfgrid.rowLocationByIndex(rowh[0])[0], row = jfgrid.rowLocationByIndex(rowh[1])[1], col_pre = jfgrid.colLocationByIndex(columnh[0])[0], col = jfgrid.colLocationByIndex(columnh[1])[1];

            var formulaTxt = '<span dir="auto" class="jfgrid-formula-text-color">=</span><span dir="auto" class="jfgrid-formula-text-color">'+ formula.toUpperCase() +'</span><span dir="auto" class="jfgrid-formula-text-color">(</span><span class="jfgrid-formula-functionrange-cell" rangeindex="0" dir="auto" style="color:'+ jfgrid.jfcolor[0] +';">'+ jfgrid.sheetmanage.getRangetxt(jfgrid.currentSheetIndex, {"row":rowh, "column":columnh }, jfgrid.currentSheetIndex) +'</span><span dir="auto" class="jfgrid-formula-text-color">)</span>';

            $("#jfgrid-rich-text-editor").html(formulaTxt);
            //$("#jfgrid-rich-text-editor").html("=" + formula.toUpperCase() + "(" + jfgrid.sheetmanage.getRangetxt(jfgrid.currentSheetIndex, {"row":row, "column":column }, jfgrid.currentSheetIndex) + ")");

            jfgrid.formula.israngeseleciton();
            jfgrid.formula.rangestart = true;
            jfgrid.formula.rangedrag_column_start = false;
            jfgrid.formula.rangedrag_row_start = false;
            jfgrid.formula.rangechangeindex = 0;
            jfgrid.formula.rangeSetValue({ "row": rowh, "column": columnh });


            jfgrid.formula.func_selectedrange = { "left": col_pre, "width": col - col_pre - 1, "top": row_pre, "height": row - row_pre - 1, "left_move": col_pre, "width_move": col - col_pre - 1, "top_move": row_pre, "height_move": row - row_pre - 1, "row": [row_index, row_index], "column": [col_index, col_index] };
            
            $("#jfgrid-formula-functionrange-select").css({ "left": col_pre, "width": col - col_pre - 1, "top": row_pre, "height": row - row_pre - 1 }).show();

            $("#jfgrid-formula-help-c").hide();
        },
        backFormulaInput:function(d, r, c, rowh, columnh, formula){
            var f = '='+ formula.toUpperCase() +'('+ jfgrid.sheetmanage.getRangetxt(jfgrid.currentSheetIndex, {"row":rowh, "column":columnh }, jfgrid.currentSheetIndex) +')';
            var v = jfgrid.formula.execfunction(f, r, c);
            var value = { "v": v[1], "f": v[2] };
            jfgrid.setcellvalue(r, c, d, value);
            jfgrid.formula.execFunctionExist.push({ "r": r, "c": c, "i": jfgrid.currentSheetIndex });

            jfgrid.server.historyParam(d, jfgrid.currentSheetIndex, {"row": [r, r], "column": [c, c]});
        },
        checkNoNullValue:function(cell){
            var v = cell;
            if(jfgrid.getObjType(v) == "object"){
                v = v.v;
            }

            if(!jfgrid.func_methods.isRealNull(v) && jfgrid.isdatatypemulti(v).num && (cell.ct == null || cell.ct.t == null || cell.ct.t == "n"  || cell.ct.t == "g")   ){
                return true;
            }
            else{
                return false;
            }
        },
        checkNoNullValueAll:function(cell){
            var v = cell;
            if(jfgrid.getObjType(v) == "object"){
                v = v.v;
            }

            if(!jfgrid.func_methods.isRealNull(v)){
                return true;
            }
            else{
                return false;
            }
        },
        getNoNullValue:function(d, st_x, ed, type){
            var hasValueSum = 0, hasValueStart = null;
            var nullNum = 0, nullTime = 0;
            var _this = this;

            for(var r = ed - 1 ; r >= 0; r--){
                var cell;
                if(type == "c"){
                    cell = d[st_x][r];
                }
                else{
                    cell = d[r][st_x];
                }

                if(_this.checkNoNullValue(cell)){
                    hasValueSum++;
                    hasValueStart = r;
                }
                else if(cell == null || cell.v == null || cell.v == ""){
                    nullNum++;
                    if(nullNum >= 40){
                        if(nullTime <= 0){
                            nullTime = 1;
                        }
                        else{
                            break;
                        }
                    }
                }
                else{
                    break;
                }
            }

            return hasValueStart;
        },
        singleFormulaInput:function(d, _index, fix, st_m, ed_m, formula, type, noNum, noNull){
            if(type == null){
                type="r";
            }

            if(noNum == null){
                noNum = true;
            }

            if(noNull == null){
                noNull = true;
            }

            var _this = this;
            var isNull = true, isNum= false;
            
            for(var c = st_m; c <= ed_m; c++){
                var cell = null;
                if(type == "c"){
                    cell = d[c][fix];
                }
                else{
                    cell = d[fix][c];
                }
                if(_this.checkNoNullValue(cell)){
                    isNull = false;
                    isNum= true;
                }
                else if(_this.checkNoNullValueAll(cell)){
                    isNull = false;
                }
            } 

            if(isNull && noNull){
                var st_r_r = _this.getNoNullValue(d, _index, fix, type);
                if(st_r_r == null){
                    if(type == "c"){
                        _this.activeFormulaInput(_index, fix, null, null, formula, true);
                    }
                    else{
                        _this.activeFormulaInput(fix, _index, null, null, formula, true);
                    }
                }
                else{
                    if(_index==st_m){
                        for(var c = st_m; c <= ed_m; c++){
                            var st_r_r = _this.getNoNullValue(d, c, fix, type);
                            if(st_r_r==null){
                                break;
                            }

                            if(type == "c"){
                                _this.backFormulaInput(d, c, fix, [c, c], [st_r_r, fix-1], formula);
                            }
                            else{
                                _this.backFormulaInput(d, fix, c, [st_r_r, fix-1], [c, c], formula);
                            }
                            
                        }
                    }
                    else{
                        for(var c = ed_m; c >= st_m; c--){
                            var st_r_r = _this.getNoNullValue(d, c, fix, type);
                            if(st_r_r==null){
                                break;
                            }
                            //_this.backFormulaInput(d, st_r, c, [st_r_r, ed_r-1], [c, c], formula);
                            if(type=="c"){
                                _this.backFormulaInput(d, c, fix, [c, c], [st_r_r, fix-1], formula);
                            }
                            else{
                                _this.backFormulaInput(d, fix, c, [st_r_r, fix-1], [c, c], formula);
                            }
                        }
                    }
                }
            }
            else if(isNum && noNum){
                var cell = null;
                if(type=="c"){
                    cell = d[ed_m][fix];
                }
                else{
                    cell = d[fix][ed_m];
                }
                if(cell!=null && cell.v!=null && cell.v.toString().length>0){
                    var c = ed_m;
                    if(type=="c"){
                        cell = d[ed_m][fix];
                    }
                    else{
                        cell = d[fix][ed_m];
                    }

                    while ( cell!=null && cell.v!=null && cell.v.toString().length>0) {
                        c++;
                        var len = null;
                        if(type=="c"){
                            len = d.length;
                        }
                        else{
                            len = d[0].length;
                        }

                        if(c >= len){
                            return;
                        }
                        //cell = d[fix][c];
                        if(type=="c"){
                            cell = d[c][fix];
                        }
                        else{
                            cell = d[fix][c];
                        }
                    }

                    if(type=="c"){
                        //_this.backFormulaInput(d, c, fix, [c, c], [st_r_r, fix-1], formula);
                        _this.backFormulaInput(d, c, fix, [st_m, ed_m], [fix ,fix], formula);
                    }
                    else{
                        _this.backFormulaInput(d, fix, c, [fix ,fix], [st_m, ed_m], formula);
                    }
                }
                else{
                    if(type=="c"){
                        //_this.backFormulaInput(d, c, fix, [c, c], [st_r_r, fix-1], formula);
                        _this.backFormulaInput(d, ed_m, fix, [st_m, ed_m], [fix ,fix], formula);
                    }
                    else{
                        _this.backFormulaInput(d, fix, ed_m, [fix ,fix], [st_m, ed_m], formula);
                    }
                }
            }
            else{
                return true;
            }

            // jfgrid.formula.execFunctionExist.reverse();
            // jfgrid.formula.execFunctionGroup(null, null, null, null, d);
            // jfgrid.jfrefreshgrid(d, st_r, ed_r, st_c, ed_c);

            // clearTimeout(jfcountfuncTimeout);
            // jfcountfunc();
        },
        autoSelectionFormula:function(formula){
            var _this = this;
            var d = jfgrid.editor.deepCopyFlowData(jfgrid.flowdata);
            var nullfindnum = 40;
            var isfalse = true;
            jfgrid.formula.execFunctionExist = [];

            var execFormulaInput_c = function(){
                var st_c_c = _this.getNoNullValue(d, st_r, ed_c, "c");
                if(st_c_c == null){
                    _this.activeFormulaInput(st_r, st_c, null, null, formula, true);
                }
                else{
                    _this.activeFormulaInput(st_r, st_c, [st_r ,ed_r], [st_c_c, ed_c-1], formula);
                }
            }

            var execFormulaInput = function(){
                var st_r_c = _this.getNoNullValue(d, st_c, ed_r, "r");
                if(st_r_c == null){
                    execFormulaInput_c();
                }
                else{
                    _this.activeFormulaInput(st_r, st_c, [st_r_c, ed_r-1], [st_c ,ed_c], formula);
                }
            }

            for(var s = 0; s < jfgird_select_save.length; s++){
                var st_r = jfgird_select_save[s].row[0], ed_r = jfgird_select_save[s].row[1];
                var st_c = jfgird_select_save[s].column[0], ed_c = jfgird_select_save[s].column[1];
                var row_index = jfgird_select_save[s].row_focus, col_index = jfgird_select_save[s].column_focus;

                if(st_r == ed_r && st_c == ed_c){
                    if(ed_r - 1 < 0 && ed_c - 1 < 0){
                        _this.activeFormulaInput(st_r, st_c, null, null, formula, true);
                        return;
                    }

                    if(ed_r - 1 >= 0 && _this.checkNoNullValue(d[ed_r - 1][st_c])){
                        execFormulaInput();
                    }
                    else if(ed_c - 1 >= 0 && _this.checkNoNullValue(d[st_r][ed_c - 1])){
                        execFormulaInput_c();
                    }
                    else{
                        execFormulaInput();
                    }
                }
                else if(st_r == ed_r){
                    isfalse = _this.singleFormulaInput(d, col_index, st_r, st_c, ed_c, formula, "r");
                }
                else if(st_c == ed_c){
                    isfalse = _this.singleFormulaInput(d, row_index, st_c, st_r, ed_r, formula, "c");
                }
                else{
                    var r_false = true;
                    for(var r = st_r; r <= ed_r; r++){
                        r_false = _this.singleFormulaInput(d, col_index, r, st_c, ed_c, formula, "r",true, false) && r_false;
                    }

                    var c_false = true;
                    for(var c = st_c; c <= ed_c; c++){
                        c_false = _this.singleFormulaInput(d, row_index, c, st_r, ed_r, formula, "c", true, false) && c_false;
                    }

                    isfalse = !!r_false && !!c_false;
                }
                isfalse = isfalse && isfalse;
            }

            if(!isfalse){
                jfgrid.formula.execFunctionExist.reverse();
                jfgrid.formula.execFunctionGroup(null, null, null, null, d);
                jfgrid.jfrefreshgrid(d, [{"row": [st_r, ed_r], "column": [st_c, ed_c]}]);

                clearTimeout(jfcountfuncTimeout);
                jfcountfuncTimeout = setTimeout(function () { jfgrid.jfcountfunc() }, 500);
            }
        },
        getStyleByCell:function(d, r, c){
            var style = "";
            
            //交替颜色
            var af_compute = jfgrid.alternateformat.getComputeMap();
            var checksAF = jfgrid.alternateformat.checksAF(r, c, af_compute);

            //条件格式
            var cf_compute = jfgrid.conditionformat.getComputeMap();
            var checksCF = jfgrid.conditionformat.checksCF(r, c, cf_compute);

            var cell = d[r][c];
            for(var key in cell){
                var value = jfgrid.menuButton.checkstatus(d, r, c , key);

                if(checksAF != null || (checksCF != null && checksCF["cellColor"] != null)){
                    if(checksCF != null && checksCF["cellColor"] != null){
                        style += "background: " + checksCF["cellColor"] + ";";
                    }
                    else if(checksAF != null){
                        style += "background: " + checksAF[1] + ";";
                    }
                }

                if(jfgrid.getObjType(value) == "object"){
                    continue;
                }

                if(key == "bg" || checksAF != null || (checksCF != null && checksCF["cellColor"] != null)){
                    if(checksCF != null && checksCF["cellColor"] != null){
                        style += "background: " + checksCF["cellColor"] + ";";
                    }
                    else if(checksAF != null){
                        style += "background: " + checksAF[1] + ";";
                    }
                    else{
                        style += "background: " + value + ";";
                    }
                }

                if(key == "bl" && value != "0"){
                    style += "font-weight: bold;";
                }

                if(key == "it" && value != "0"){
                    style += "font-style:italic;";
                }

                if(key == "ff" && value != "0"){
                    var f = value;
                    if(!isNaN(parseInt(value))){
                        f = jfgrid.menuButton.fontarray[parseInt(value)];
                    }
                    style += "font-family: " + f + ";";
                }

                if(key == "fs" && value != "10"){
                    style += "font-size: "+ value + "pt;";
                }

                if((key == "fc" && value != "#000000") || checksAF != null || (checksCF != null && checksCF["textColor"] != null)){
                    if(checksCF != null && checksCF["textColor"] != null){
                        style += "color: " + checksCF["textColor"] + ";";
                    }
                    else if(checksAF != null){
                        style += "color: " + checksAF[0] + ";";
                    }
                    else{
                        style += "color: " + value + ";";  
                    }
                }

                if(key == "ht" && value != "1"){
                    if(value == "0"){
                        style += "text-align: center;";
                    }
                    else if(value == "2"){
                        style += "text-align: right;";
                    }
                }

                if(key == "vt" && value != "0"){
                    if(value == "1"){
                        style += "vertical-align: top;";
                    }
                    else if(value == "2"){
                        style += "vertical-align: bottom;";
                    }
                }
            }

            return style;
        }
    }

    jfgrid.server = {
        gridKey: null,
        loadUrl: null,
        updateUrl: null,
        updateImageUrl: null,
        title: null,
        historyParam: function(data, sheetIndex, range){
            var _this = this;

            var r1 = range.row[0], r2 = range.row[1];
            var c1 = range.column[0], c2 = range.column[1];

            if(r1 == r2 && c1 == c2){ //单个单元格更新
                var v = data[r1][c1];

                _this.saveParam("v", sheetIndex, v, { "r": r1, "c": c1 });
            }
            else{ //范围单元格更新
                var rowlen = r2 - r1 + 1;
                var collen = c2 - c1 + 1;

                var timeR = Math.floor(1000 / collen);
                var n = Math.ceil(rowlen / timeR); //分批次更新，一次最多1000个单元格

                for(var i = 0; i < n; i++){
                    var str = r1 + timeR * i;

                    if(i == n - 1){
                        var edr = r2;
                    }
                    else{
                        var edr = r1 + timeR * (i + 1) - 1;
                    }

                    var v = [];

                    for(var r = str; r <= edr; r++){
                        var v_row = [];

                        for(var c = c1; c <= c2; c++){
                            v_row.push(data[r][c]);
                        }

                        v.push(v_row);
                    }

                    _this.saveParam("rv", sheetIndex, v, { "range": { "row": [str, edr], "column": [c1, c2] } });

                    if(i == n - 1){
                        _this.saveParam("rv_end", sheetIndex, null);
                    }
                }  
            }
        },
        saveParam: function (type, index, value, params) {
            if(!jfgrid.server.allowUpdate){
                return;
            }

            if(value == undefined){
                value = null;
            }

            var d = {};
            d.t = type;
            d.i = index;
            d.v = value;

            if (type == "rv") { //单元格批量更新
                d.range = params.range;
            }
            else if (type == "v" || type == "fu" || type == "fm") {
                d.r = params.r;
                d.c = params.c;
            }
            else if (type == "fc") {
                d.op = params.op;
                d.pos = params.pos;
            }
            else if (type == "drc" || type == "arc" || type == "h" || type == "wh") {
                d.rc = params.rc;
            }
            else if (type == "c") {
                d.cid = params.cid;
                d.op = params.op;
            }
            else if (type == "f") {
                d.op = params.op;
                d.pos = params.pos;
            }
            else if (type == "s") {

            }
            else if (type == "sh") {
                d.op = params.op;
                if(params.cur!=null){
                    d.cur = params.cur;
                }
            }
            else if (type == "cg") {
                d.k = params.k;
            }
            else if (type == "all") {
                d.k = params.k;
                // d.s = params.s;
            }

            var msg = pako.gzip(encodeURIComponent(JSON.stringify(d)), { to: "string" });

            jfgrid.server.websocket.send(msg);

            // var _this = this;
            // _this.requestlast = moment();
            // _this.setlocaldata(d, function(data){
            //     _this.checksubmit(data);
            // });
        },
        websocket: null,
        wxErrorCount: 0,
        openWebSocket: function(){
            if('WebSocket' in window){
                jfgrid.server.websocket = new WebSocket(jfgrid.server.updateUrl + "?t=111&g=" + encodeURIComponent(jfgrid.server.gridKey));

                //连接建立时触发
                jfgrid.server.websocket.onopen = function(){
                    console.info('WebSocket连接成功');
                    jfgrid.jfhideloading();
                    jfgrid.server.wxErrorCount = 0;

                    setInterval(function(){
                        jfgrid.server.websocket.send("rub");
                    }, 60000);
                }

                //客户端接收服务端数据时触发
                jfgrid.server.websocket.onmessage = function(result){
                    var data = eval('(' + result.data + ')');
                    console.info(data);
                    var type = data.type;

                    if(type == 1){ //send 成功或失败

                    }
                    else if(type == 2){ //更新数据
                        var item = JSON.parse(data.data);
                        jfgrid.server.wsUpdateMsg(item);
                    }
                    else if(type == 3){ //多人操作不同选区("t": "mv")（用不同颜色显示其他人所操作的选区）
                        var id = data.id;
                        var username = data.username; 
                        var item = JSON.parse(data.data);

                        var type = item.t,
                            index = item.i,
                            value = item.v; 

                        if(jfgrid.getObjType(value) != "array"){
                            value = JSON.parse(value);
                        }

                        if(index == jfgrid.currentSheetIndex){
                            var r = value[value.length - 1].row[0];
                            var c = value[value.length - 1].column[0];

                            jfgrid.server.multipleRangeShow(id, username, r, c);
                        }
                    }
                    else if(type == 4){ //批量指令更新
                        var items = JSON.parse(data.data);
                        for(var i = 0; i < items.length; i++){
                            jfgrid.server.wsUpdateMsg(item[i]);
                        }
                    }
                }

                //通信发生错误时触发
                jfgrid.server.websocket.onerror = function(){
                    jfgrid.server.wxErrorCount++;

                    if(jfgrid.server.wxErrorCount > 3){
                        jfgrid.jfshowloading("WebSocket连接发生错误, 请刷新页面！");
                    }
                    else{
                        jfgrid.jfshowloading("WebSocket连接发生错误, 请耐心等待！");
                        jfgrid.server.openWebSocket();
                    }
                }

                //连接关闭时触发
                jfgrid.server.websocket.onclose = function(){
                    console.info('WebSocket连接关闭');
                    alert("服务器通信发生错误，请刷新页面后再试，如若不行请联系管理员！");
                }                
            }
            else{
                alert('当前浏览器 Not Support WebSocket');
            }
        },
        wsUpdateMsg: function(item){
            var type = item.t,
                index = item.i,
                value = item.v;

            var file = jfgridfile[jfgrid.sheetmanage.getSheetIndex(index)]; 

            if(file == null){
                return;
            }

            if(type == "v"){ //单个单元格数据更新
                if(file.data == null || file.data.length == 0){
                    return;
                }

                var r = item.r, c = item.c;
                file.data[r][c] = value;

                if(index == jfgrid.currentSheetIndex){
                    jfgrid.flowdata = file.data;

                    //如果更新的单元格有批注
                    if(value != null && value.ps != null){
                        jfgrid.postil.buildPs(r, c, value.ps);
                    }
                    else{
                        jfgrid.postil.buildPs(r, c, null);
                    }

                    setTimeout(function () {
                        jfgrid.jfgridrefreshgrid();
                    }, 1);
                }
            }
            else if(type == "rv"){ //范围单元格数据更新
                if(file.data == null || file.data.length == 0){
                    return;
                }

                var r1 = item.range.row[0], r2 = item.range.row[1];
                var c1 = item.range.column[0], c2 = item.range.column[1];

                for(var r = r1; r <= r2; r++){
                    for(var c = c1; c <= c2; c++){
                        file.data[r][c] = value[r - r1][c - c1];
                    }
                }

                if(index == jfgrid.currentSheetIndex){
                    jfgrid.flowdata = file.data;

                    //如果更新的单元格有批注
                    for(var r = r1; r <= r2; r++){
                        for(var c = c1; c <= c2; c++){
                            if(value[r - r1][c - c1] != null && value[r - r1][c - c1].ps != null){
                                jfgrid.postil.buildPs(r, c, value[r - r1][c - c1].ps);
                            }
                            else{
                                jfgrid.postil.buildPs(r, c, null);
                            }
                        }
                    }

                    setTimeout(function () {
                        jfgrid.jfgridrefreshgrid();
                    }, 1);
                }
            }
            else if(type == "cg"){ //config更新（rowhidden，rowlen，columlen，merge，borderInfo）
                var k = item.k;

                if(k == "borderInfo"){
                    file["config"]["borderInfo"] = value;
                }
                else{
                    if(!(k in file["config"])){
                        file["config"][k] = {};
                    }

                    for(var key in value){
                        file["config"][k][key] = value[key];
                    }
                }

                if(index == jfgrid.currentSheetIndex){
                    config = file["config"];

                    if(k == "rowlen" || k == "columlen" || k == "rowhidden"){
                        jfgrid.jfrefreshgrid_rhcw(jfgrid.flowdata.length, jfgrid.flowdata[0].length);
                    }

                    setTimeout(function () {
                        jfgrid.jfgridrefreshgrid();
                    }, 1);
                }
            }
            else if(type == "all"){ //通用保存更新
                var k = item.k;
                file[k] = value;

                if(k == "name"){ //表格名
                    $("#jfgrid-sheet-container-c #jfgrid-sheets-item" + index).find("span.jfgrid-sheets-item-name").html(value);
                }
                else if(k == "color"){ //表格颜色
                    var jfgridcurrentSheetitem = $("#jfgrid-sheet-container-c #jfgrid-sheets-item" + index);
                    jfgridcurrentSheetitem.find(".jfgrid-sheets-item-color").remove();

                    if(value != null || value != ""){
                        jfgridcurrentSheetitem.append('<div class="jfgrid-sheets-item-color" style=" position: absolute; width: 100%; height: 3px; bottom: 0px; left: 0px; background-color: ' + value + ';"></div>');
                    }
                }
                else if(k == "pivotTable"){ //数据透视表
                    // jfgrid.pivotTable.changePivotTable(index);
                }
                else if(k == "freezen"){ //冻结行列
                    if(index == jfgrid.currentSheetIndex){
                        if(file["freezen"].horizontal == null){
                            $("#jfgrid-freezen-btn-horizontal").html('<i class="fa fa-list-alt"></i> 冻结首行');
                            jfgrid.freezen.freezenhorizontaldata = null;
                            $("#jfgrid-freezebar-horizontal").hide();
                        }
                        else{
                            jfgrid.freezen.createFreezenHorizontal(file["freezen"].horizontal.freezenhorizontaldata, file["freezen"].horizontal.top);
                        }

                        if(file["freezen"].vertical == null){
                            $("#jfgrid-freezen-btn-vertical").html('<i class="fa fa-indent"></i> 冻结首列');
                            jfgrid.freezen.freezenverticaldata = null;
                            $("#jfgrid-freezebar-vertical").hide();
                        }
                        else{
                            jfgrid.freezen.createFreezenVertical(file["freezen"].vertical.freezenverticaldata, file["freezen"].vertical.left);
                        }

                        jfgrid.freezen.createAssistCanvas();
                    }
                }
                else if(k == "filter_select"){ //筛选范围
                    if(index == jfgrid.currentSheetIndex){
                        jfgrid.createFilterOptions(value);
                    }
                }
                else if(k == "filter"){ //筛选保存
                    if(index == jfgrid.currentSheetIndex){
                        jfgrid.createFilterOptions(file.filter_select, value);
                    }
                }
                else if(k == "jfgrid_conditionformat_save"){ //条件格式
                    if(index == jfgrid.currentSheetIndex){
                        setTimeout(function () {
                            jfgrid.jfgridrefreshgrid();
                        }, 1);
                    }
                }
                else if(k == "jfgrid_alternateformat_save"){ //交替颜色
                    if(index == jfgrid.currentSheetIndex){
                        setTimeout(function () {
                            jfgrid.jfgridrefreshgrid();
                        }, 1);
                    }
                }
                else if(k == "config"){ //config
                    if(index == jfgrid.currentSheetIndex){
                        config = value;
                        
                        jfgrid.jfrefreshgrid_rhcw(jfgrid.flowdata.length, jfgrid.flowdata[0].length);
                    }
                }
                else if(k == "dynamicArray"){ //动态数组
                    if(index == jfgrid.currentSheetIndex){
                        setTimeout(function () {
                            jfgrid.jfgridrefreshgrid();
                        }, 1);
                    }
                }
            }
            else if(type == "fc"){ //函数链calc
                var op = item.op, pos = item.pos;

                if(jfgrid.getObjType(value) != "object"){
                    value = eval('('+ value +')');
                }

                var r = value.r, c = value.c;
                var func = value.func;

                var calcChain = file["calcChain"] == null ? [] : file["calcChain"];

                if(op == "add"){
                    calcChain.push(value);
                }
                else if(op == "del"){
                    for(var a = 0; a < calcChain.length; a++){
                        if(r == calcChain[a].r && c == calcChain[a].c && index == calcChain[a].index){
                            calcChain.splice(a, 1);
                        }
                    }
                }
                else if(op == "update"){
                    for(var a = 0; a < calcChain.length; a++){
                        if(r == calcChain[a].r && c == calcChain[a].c && index == calcChain[a].index){
                            calcChain[a].func = func;
                        }
                    } 
                }

                setTimeout(function () {
                    jfgrid.jfgridrefreshgrid();
                }, 1);
            }
            else if(type == "drc"){ //删除行列
                if(file.data == null || file.data.length == 0){
                    return;
                }

                var rc = item.rc, st_i = value.index, len = value.len, mc = value.mc, borderInfo = value.borderInfo;
                var data = file.data;

                if(rc == "r"){
                    file["row"] -= len;

                    data.splice(st_i, len);

                    //空白行模板
                    var row = [];
                    for (var c = 0; c < data[0].length; c++) {
                        row.push(null);
                    }

                    //删除多少行，增加多少行空白行                
                    for (var r = 0; r < len; r++) {
                        data.push(row);
                    }
                }
                else{
                    file["column"] -= len;

                    //空白列模板
                    var addcol = [];
                    for (var r = 0; r < len; r++) {
                        addcol.push(null);
                    }

                    for(var i = 0; i < data.length; i++){
                        data[i].splice(st_i, len);

                        data[i] = data[i].concat(addcol);
                    }
                }

                for(x in mc){
                    var r = mc[x].r, c = mc[x].c;
                    data[r][c].mc = mc[x];
                }

                file["config"].merge = mc;
                file["config"].borderInfo = borderInfo;

                if(index == jfgrid.currentSheetIndex){
                    jfgrid.flowdata = data;

                    config["merge"] = mc;
                    config["borderInfo"] = borderInfo;

                    setTimeout(function () {
                        jfgrid.jfgridrefreshgrid();
                    }, 1);
                }
            }
            else if(type == "arc"){ //增加行列
                if(file.data == null || file.data.length == 0){
                    return;
                }

                var rc = item.rc, st_i = value.index, len = value.len, addData = value.data, mc = value.mc, borderInfo = value.borderInfo;
                var data = file.data;

                if(rc == "r"){
                    file["row"] += len;

                    var arr = [];
                    for(var i = 0; i < len; i++){
                        arr.push(JSON.stringify(addData[i]));
                    }

                    eval('data.splice(' + st_i + ', 0, ' + arr.join(",") + ')');
                }
                else{
                    file["column"] += len;

                    for(var i = 0; i < data.length; i++){
                        data[i].splice(st_i, 0, addData[i]);
                    }
                }

                for(x in mc){
                    var r = mc[x].r, c = mc[x].c;
                    data[r][c].mc = mc[x];
                }

                file["config"].merge = mc;
                file["config"].borderInfo = borderInfo;

                if(index == jfgrid.currentSheetIndex){
                    jfgrid.flowdata = data;

                    config["merge"] = mc;
                    config["borderInfo"] = borderInfo;

                    setTimeout(function () {
                        jfgrid.jfgridrefreshgrid();
                    }, 1);
                }
            }
            else if(type == "f"){ //筛选
                var op = item.op, pos = item.pos;

                var filter = file.filter;

                if(filter == null){
                    filter = {};
                }

                if(op == "upOrAdd"){
                    filter[pos] =  value;
                }
                else if(op == "del"){
                    delete filter[pos];
                }

                if(index == jfgrid.currentSheetIndex){
                    jfgrid.createFilterOptions(file.filter_select, filter);
                }
            }
            else if(type == "fsc"){ //清除筛选
                file.filter = null;
                file.filter_select = null;

                if(index == jfgrid.currentSheetIndex){
                    $('#jfgrid-filter-selected-sheet' + jfgrid.currentSheetIndex + ', #jfgrid-filter-options-sheet' + jfgrid.currentSheetIndex).remove();
                    $("#jfgrid-filter-menu, #jfgrid-filter-submenu").hide();
                }
            }
            else if(type == "fsr"){ //恢复筛选
                file.filter = value.filter;
                file.filter_select = value.filter_select;

                if(index == jfgrid.currentSheetIndex){
                    jfgrid.createFilterOptions(file.filter_select, file.filter);
                }
            }
            else if(type == "sha"){ //新建sheet
                jfgridfile.push(value);

                var colorset = '';
                if(value.color != null){
                    colorset = '<div class="jfgrid-sheets-item-color" style=" position: absolute; width: 100%; height: 3px; bottom: 0px; left: 0px; background-color: ' + value.color + ';"></div>';
                }

                $("#jfgrid-sheet-container-c").append(jfgrid.replaceHtml(sheetHTML, { "index": value.index, "active": "", "name": value.name, "style": "", "colorset": colorset }));
                $("#jfgrid-cell-main").append('<div id="jfgrid-datavisual-selection-set-' + value.index + '" class="jfgrid-datavisual-selection-set"></div>');
            }
            else if(type == "shc"){ //复制sheet
                var copyindex = value.copyindex, name = value.name;

                var copyarrindex = jfgrid.sheetmanage.getSheetIndex(copyindex);
                var copyjson = $.extend(true, {}, jfgridfile[copyarrindex]); 
                    
                copyjson.index = index;
                copyjson.name = name;

                jfgridfile.splice(copyarrindex + 1, 0, copyjson);

                var copyobject = $("#jfgrid-sheets-item" + copyindex);
                $("#jfgrid-sheet-container-c").append(jfgrid.replaceHtml(sheetHTML, { "index": copyjson.index, "active": "", "name": copyjson.name, "style": "", "colorset": "" }));
                $("#jfgrid-sheets-item" + copyjson.index).insertAfter(copyobject);
                $("#jfgrid-cell-main").append('<div id="jfgrid-datavisual-selection-set-' + copyjson.index + '" class="jfgrid-datavisual-selection-set"></div>');
            }
            else if(type == "shd"){ //删除sheet
                for(var i = 0; i < jfgridfile.length; i++){
                    if(jfgridfile[i].index == value.deleIndex){
                        jfgrid.server.sheetDeleSave.push(jfgridfile[i]);

                        jfgridfile.splice(i, 1);
                        break;
                    }
                }

                $("#jfgrid-sheets-item" + value.deleIndex).remove();
                $("#jfgrid-datavisual-selection-set-" + value.deleIndex).remove();
            }
            else if(type == "shr"){ //sheet位置
                for(x in value){
                    jfgridfile[jfgrid.sheetmanage.getSheetIndex(x)].order = value[x];
                }
            }
            else if(type == "shre"){ //删除sheet恢复操作
                for(var i = 0; i < jfgrid.server.sheetDeleSave.length; i++){
                    if(jfgrid.server.sheetDeleSave[i].index == value.reIndex){
                        var datav = jfgrid.server.sheetDeleSave[i];

                        jfgridfile.push(datav);

                        var colorset = '';
                        if(value.color != null){
                            colorset = '<div class="jfgrid-sheets-item-color" style=" position: absolute; width: 100%; height: 3px; bottom: 0px; left: 0px; background-color: ' + datav.color + ';"></div>';
                        }

                        $("#jfgrid-sheet-container-c").append(jfgrid.replaceHtml(sheetHTML, { "index": datav.index, "active": "", "name": datav.name, "style": "", "colorset": colorset }));
                        $("#jfgrid-cell-main").append('<div id="jfgrid-datavisual-selection-set-' + datav.index + '" class="jfgrid-datavisual-selection-set"></div>');
                        break;
                    }
                }
            }
            else if(type == "sh"){ //隐藏sheet
                var op = item.op, cur = item.cur;

                if(op == "hide"){
                    file.hide = 1;
                    $("#jfgrid-sheets-item" + index).hide();

                    if(index == jfgrid.currentSheetIndex){
                        $("#jfgrid-sheets-item" + cur).addClass("jfgrid-sheets-item-active");
                        jfgrid.sheetmanage.changeSheetExec(cur);
                    }
                }
                else if(op == "show"){
                    file.hide = 0;
                    $("#jfgrid-sheets-item" + index).show();
                }
            }
            else if(type == "c"){ //图表操作
                var op = item.op, cid = item.cid;

                if(op == "add"){ //插入
                    file.chart.push(value);

                    jfgrid.insertChartTosheet(value.sheetIndex, value.dataSheetIndex, value.option, value.chartType, value.selfOption, value.defaultOption, value.row, value.column, value.chart_selection_color, value.chart_id, value.chart_selection_id, value.chartStyle, value.rangeConfigCheck, value.rangeRowCheck, value.rangeColCheck, value.chartMarkConfig, value.chartTitleConfig, value.winWidth, value.winHeight, value.scrollLeft1, value.scrollTop1, value.chartTheme, value.myWidth, value.myHeight, value.myLeft, value.myTop, value.myindexrank1, true);
                }
                else if(op == "xy" || op == "wh" || op == "update"){ //移动 缩放 更新
                    for(var i = 0; i < file.chart.length; i++){
                        var chartjson = file.chart[i];

                        if(chartjson.chart_id == cid){
                            for(var item in chartjson){
                                for(var vitem in value){
                                    if(item == vitem){
                                        chartjson[item] = value[vitem];
                                    }
                                }
                            }

                            jfgrid.sheetmanage.saveChart(chartjson);

                            return;
                        }
                    }
                }
                else if(op == "del"){ //删除
                    for(var i = 0; i < file.chart.length; i++){
                        var chartjson = file.chart[i];

                        if(chartjson.chart_id == cid){
                            file.chart.splice(i, 1);

                            $("#" + cid).remove();
                            jfgrid.sheetmanage.delChart($("#" + cid).attr("chart_id"), $("#" + cid).attr("sheetIndex")); 

                            return;
                        }
                    }
                }
            }
            else if(type == "na"){ //表格名称
                $("#jfgrid_info_detail_input").val(value).css("width", jfgrid.getByteLen(value) * 10);
            }
        },
        multipleIndex: 0,
        multipleRangeShow: function(id, name, r, c){
            var r1 = r2 = r;
            var c1 = c2 = c;

            var row = visibledatarow[r2],
                row_pre = r1 - 1 == -1 ? 0 : visibledatarow[r1 - 1],
                col = visibledatacolumn[c2],
                col_pre = c1 - 1 == -1 ? 0 : visibledatacolumn[c1 - 1];

            var margeset = jfgrid.menuButton.mergeborer(jfgrid.flowdata, r1, c1);
            if(!!margeset){
                row = margeset.row[1];
                row_pre = margeset.row[0];
                
                col = margeset.column[1];
                col_pre = margeset.column[0];
            }

            if($("#jfgrid-multipleRange-show-" + id).length > 0){
                $("#jfgrid-multipleRange-show-" + id).css({ "position": "absolute", "left": col_pre - 1, "width": col - col_pre - 1, "top": row_pre - 1, "height": row - row_pre - 1 });
            }
            else{
                var itemHtml = '<div id="jfgrid-multipleRange-show-'+ id +'" data-color="'+ jfgrid.jfcolor[jfgrid.server.multipleIndex] +'" title="'+ name +'" style="position: absolute;left: '+ (col_pre - 1) +'px;width: '+ (col - col_pre - 1) +'px;top: '+ (row_pre - 1) +'px;height: '+ (row - row_pre - 1) +'px;border: 1px solid '+ jfgrid.jfcolor[jfgrid.server.multipleIndex] +';z-index: 15;">'+
                                '<div style="width: 100%;height: 100%;position: absolute;top: 0;right: 0;bottom: 0;left: 0;opacity: 0.03;background-color: '+ jfgrid.jfcolor[jfgrid.server.multipleIndex] +'"></div>'+
                               '</div>';

                $(itemHtml).appendTo($("#jfgrid-cell-main #jfgrid-multipleRange-show"));

                jfgrid.server.multipleIndex++;
            }
        },
        sheetDeleSave: [], //共享编辑模式下 删除的sheet保存下来，方便恢复时取值
        submitInterval: 1000,
        imagesubmitInterval: 5000,
        submitdatalimit: 50,
        submitcompresslimit: 1000,
        checksubmit: function(data){
            var _this = this;
            //clearTimeout(_this.requestTimeOut);

            _this.submitTimeout();

            clearTimeout(_this.imageRequestTimeout);
            _this.imageRequestTimeout = setTimeout(function(){
                _this.imageRequest();
            }, _this.imagesubmitInterval);
        },
        submitTimeout: function(){
            var _this = this;
            clearTimeout(_this.requestTimeOut);
            
            //console.log(_this.requestlast, moment(), (_this.requestlast!=null && _this.requestlast.add(10, 'seconds').isBefore(moment()) ) );
            if(!_this.requestLock && (_this.requestlast!=null && _this.requestlast.clone().add(1, 'seconds').isBefore(moment()) ) ){
                _this.request();
            }
        
            // if(!_this.imageRequestLock && (_this.imageRequestLast==null || _this.imageRequestLast.clone().add(30, 'seconds').isBefore(moment()) ) ){
                
            // }

            _this.requestTimeOut = setTimeout(function(){
                _this.submitTimeout();
            }, _this.submitInterval);
        },
        requestLock: false,
        requestlast: null,
        firstchange: true,
        requestTimeOut: null,
        request: function () {
            var _this = this;
            var key = this.gridKey;
            var cahce_key = key + "__qkcache";
            _this.cachelocaldata(function(cahce_key, params){
                if(params.length==0){
                    return;
                }
                console.log(params);

                params = encodeURIComponent(JSON.stringify(params));
                var compressBeginLen = params.length;
                var iscommpress = false;
                // if (compressBeginLen > _this.submitcompresslimit) {
                //     params = pako.gzip(params, { to: "string" });
                //     iscommpress = true;
                // }
                _this.requestLock = true;
                //console.log(params);
                console.log("request");
                if(_this.updateUrl != ""){
                    $.post(_this.updateUrl, { compress: iscommpress, gridKey: _this.gridKey, data: params }, function (data) {
                        var re = eval('('+ data +')')
                        if(re.status){
                            $("#jfgrid_info_detail_update").html("最近存档时间:"+ moment().format("M-D H:m:s"));
                            $("#jfgrid_info_detail_save").html("同步成功");
                            _this.clearcachelocaldata();
                        }
                        else{
                            $("#jfgrid_info_detail_save").html("<span style='color:#ff2121'>同步失败</span>");
                            _this.restorecachelocaldata();
                        }
                        _this.requestlast = moment();
                        _this.requestLock = false;
                    });
                 }   
            });
        },
        imageRequestLast: null,
        imageRequestLock: false,
        imageRequestTimeout: null,
        imageRequest: function(){
            var _this = this;
            html2canvas($("#" + container).find(".jfgrid-grid-window").get(0), {
              onrendered: function(canvas) {
                //var imgcut = $("#jfgrid-cell-main").find(".jfgrid-grid-window");
                //document.body.appendChild(canvas);
                var old = $(canvas).appendTo("body");
                old.hide();
                var newwidth = old.width();
                var newheight = old.height();
                var imageData = old.get(0).getContext("2d").getImageData(0, 0, newwidth, newheight);
                
                var cutW = newwidth, cutH = newheight;
                if(cutW*0.54 > cutH){
                    cutW = cutH / 0.54;
                }
                else{
                    cutH = cutW * 0.54;
                }
                var newCanvas = $("<canvas>").attr("width", cutW).attr("height", cutH)[0];

                newCanvas.getContext("2d").putImageData(imageData, 0, 0);

                old.attr("width", 350);
                old.attr("height", 189);
                old.get(0).getContext("2d").drawImage(newCanvas, 0, 0, 350, 189);
                var base64 = old.get(0).toDataURL('image/jpeg', 0.9);

                //console.log(base64);
                //console.log("压缩：", pako.gzip(base64, { to: "string" }));
                //console.log("imageRequest");
                var curindex = jfgrid.sheetmanage.getCurSheetnoset();
                _this.imageRequestLock =true;
                // var data1 = pako.gzip(encodeURIComponent(JSON.stringify({"t":"thumb", "img": base64, "curindex":curindex })), { to: "string" });
                var data1 = encodeURIComponent(JSON.stringify({"t":"thumb", "img": base64, "curindex":curindex }));
                old.remove();
                //console.log("缩略图", _this.imageRequestLast,base64);
                if(_this.updateImageUrl != ""){
                    // $.post(_this.updateImageUrl, { compress: true, gridKey: _this.gridKey, data:data1  }, function (data) {
                    $.post(_this.updateImageUrl, { compress: false, gridKey: _this.gridKey, data:data1  }, function (data) {
                        var re = eval('('+ data +')')
                        if(re.status){
                            imageRequestLast = moment();
                        }
                        else{
                            $("#jfgrid_info_detail_save").html("<span style='color:#ff2121'>网络不稳定</span>");
                        }
                        _this.imageRequestLock =true;
                    });
                }
                
              }
            });
        },
        localdata: [],
        matchOpt: function(v, d){
            for(var vitem in v){
                if(vitem == "t" && v["t"] in {"drc":1, "arc":1,"sha":1,"shc":1,"shd":1 } ){
                    return false;
                }

                if(vitem=="v"){
                    continue;
                }

                if(!(vitem in d)){
                    return false;
                }

                if(d[vitem] != v[vitem]){
                    return false;
                }
            }

            return true;
        },
        deleteRepeatOpt: function(data, value){
            //var d = $.extend(true, [], data); //原来
            var d = data;
            var _this = this;
            
            if(value instanceof Array){
                for(var i = 0; i < value.length; i++){
                    var vitem = value[i];

                    for(var a = 0; a < d.length; a++){
                        var ditem = data[i]; //var ditem = data[a];?
                        
                        if(_this.matchOpt(vitem, ditem)){
                            delete d[a];
                        }
                    }
                }
            }
            else{
                for(var a = 0; a < d.length; a++){
                    var ditem = d[a];
                    
                    if(_this.matchOpt(value, ditem)){
                        delete d[a];
                    }
                }
            }

            var ret = [];
            for(var i = 0; i < d.length; i++){
                if(d[i] != null){
                    ret.push(d[i]);
                }
            }

            return ret;
        },
        setlocaldata: function (value, func) {
            var key = this.gridKey;
            //!!window.store && store.push(key, data);
            var _this = this;
            _this.getlocaldata(function(data){
                if(data==null){
                    data = [];
                }

                //此处不去重，在request同步后台时统一循环一次去重
                //var data = _this.deleteRepeatOpt(data, value);

                if(value instanceof Array){
                    data = data.concat(value);
                }
                else{
                    data.push(value);
                }

                _this.localdata = data;
                func(_this.localdata);
                
                //console.log(value);
                // localforage.setItem(key, data).then(function () {
                //     console.log(data);
                //     func(data);
                // }).catch(function (err) {

                // });
            });
        },
        getlocaldata: function (func) {
            var key = this.gridKey;
            //return !!window.store && store.get(key);
            func(this.localdata);
            // localforage.getItem(key).then(function(readValue) {
            //     func(readValue);
            // });
        },
        clearlocaldata: function (func) {
            var key = this.gridKey;
            //!!window.store && store.remove(key);
            this.localdata = [];
            func();
            // localforage.removeItem(key, function(err,value) {
            //     func();
            // });
        },
        cachelocaldata: function (func) {
            var key = this.gridKey;
            var _this = this;
            var cahce_key = key + "__qkcache";
            //!!window.store && store.remove(key);
            //console.log(key, cahce_key);


            //处理localdata去重
            var updatedata = _this.localdata;
            var uLen = updatedata.length;
            if(uLen > 1){
                var prevData = [];
                prevData[0] = updatedata[0];
                for(var i = 1; i < uLen; i++){
                    var value = updatedata[i];
                    var flag = true;
                    for(var a=0;a<prevData.length;a++){
                        var ditem = prevData[a];
                        if(_this.matchOpt(value, ditem)){
                            prevData.splice(a,1,value);
                            flag = false; //如果已匹配重复，则后续无需再加
                            break;
                        }
                    }
                    if(flag){
                        prevData = prevData.concat(value);
                    }

                }
                updatedata = prevData;

            }
            if(updatedata==null || updatedata.length==0){
                return;
            }
            //console.log(key, cahce_key,updatedata);
            _this.clearlocaldata(function(){
                localforage.setItem(cahce_key, updatedata).then(function () {
                    func(cahce_key, updatedata);
                });
            });

            // localforage.getItem(key).then(function(readValue) {
            //     var updatedata = readValue;
            //     if(readValue==null || readValue.length==0){
            //         return;
            //     }
            //     //console.log(key, cahce_key,updatedata);
            //     _this.clearlocaldata(function(){
            //         localforage.setItem(cahce_key, updatedata).then(function () {
            //             func(cahce_key, updatedata);
            //         });
            //     });
            // });
        },
        clearcachelocaldata: function(func){
            var key = this.gridKey;
            var cahce_key = key + "__qkcache";
            //!!window.store && store.remove(key);
            localforage.removeItem(cahce_key, function(err,value) {
                if(func && typeof(func)=="function"){ 
                    func();
                }
                
            });
        },
        restorecachelocaldata: function(func){
            var key = this.gridKey;
            var cahce_key = key + "__qkcache";
            var _this = this;
            localforage.getItem(cahce_key).then(function(readValue) {
                var updatedata = readValue;
                _this.getlocaldata(function(data){
                    if(data==null){
                        data = [];
                    }
                    var newdata = updatedata.concat(data);
                    //data.unshift(updatedata);

                    _this.localdata = newdata;
                    if(func instanceof Function){
                        func(_this.localdata);
                    }
                    
                    // localforage.setItem(key, newdata).then(function () {
                    //     func(newdata);
                    // }).catch(function (err) {

                    // });
                });
            });
        }
    }

    jfgrid.method = {
        //翻页
        addDataAjax:function(param, index, url, func){
            var _this = this;
            if(index == null){
                index = jfgrid.currentSheetIndex;
            }

            if(url == null){
                url = jfgrid.server.loadSheetUrl;
            }

            $("#jfgrid-grid-window-1").append(jfgridlodingHTML);
            //param.currentPage <=1 ? param.currentPage = 2 :param.currentPage++;
            param.currentPage++;
            //var arg = {"gridKey" : jfgrid.server.gridKey, "index": index};
            //param = $.extend(true, param, arg);
            var file = jfgridfile[jfgrid.sheetmanage.getSheetIndex(index)];
            var dataType = 'application/json;charset=UTF-8';
            // var token = sessionStorage.getItem('token');
            // rptapp
            var token = sessionStorage.getItem('x-auth-token');

            $.ajax({
                method: 'POST',
                url: url,
                // rptapp
                // headers:{"x-auth-token":JSON.parse(token)},
                headers:{"x-auth-token":token},
                data:JSON.stringify(param),
                contentType: dataType,
                success: function(d) {
                    //d可能为json字符串
                    if(typeof d == "string"){
                        d = JSON.parse(d);
                    }

                    var dataset = d.data;
                    
                    // var file = dataset[jfgrid.sheetmanage.getSheetIndex(index)];
                    // var newData = file.celldata;
                    // jfgrid.jfgridextendData(file["row"], newData);
                    
                    // rptapp
                    var newData = dataset.celldata;
                    jfgrid.jfgridextendData(dataset["row"], newData);
                   

                    setTimeout(function(){
                        $("#jfgridloadingdata").fadeOut().remove();
                    }, 500);

                    if(func && typeof(func)=="function"){ 
                        func(dataset);
                    }
                }
            })
        },
        //重载
        reload:function(param, index, url, func){
            var _this = this;
            if(index == null){
                index = jfgrid.currentSheetIndex;
            }

            if(url == null){
                url = jfgrid.server.loadSheetUrl;
            }

            $("#jfgrid-grid-window-1").append(jfgridlodingHTML);

            var arg = {"gridKey" : jfgrid.server.gridKey, "index": index};
            param = $.extend(true, param, arg);
            var file = jfgridfile[jfgrid.sheetmanage.getSheetIndex(index)];

            $.post(url, param, function (d) {
                var dataset = eval("(" + d + ")");
                file.celldata = dataset[index.toString()];
                var data = jfgrid.sheetmanage.buildGridData(file);

                setTimeout(function(){
                    $("#jfgridloadingdata").fadeOut().remove();
                }, 500);

                //jfgrid.sheetmanage.setSheetParam();
                file["data"] = data;
                jfgrid.flowdata = data;
                jfgrid.editor.webWorkerFlowDataCache(data);//worker存数据

                jfgrid.jfgridcreatesheet(data[0].length, data.length, data, null, false);
                file["load"] = "1";

                jfgird_select_save = [];
                jfgrid_selection_range = [];

                jfgrid.server.saveParam("shs", null, jfgrid.currentSheetIndex);

                jfgrid.sheetmanage.changeSheet(index);

                if(func && typeof(func)=="function"){ 
                    func();
                }
            });
        },
        clearSheetByIndex:function(i){
            var index = jfgrid.sheetmanage.getSheetIndex(i);
            var sheetfile = jfgridfile[index];
            if(!sheetfile.isPivotTable){
                sheetfile.data = [];
                sheetfile.row = defaultrowNum;
                sheetfile.column = defaultcolumnNum;

                sheetfile.chart = [];
                sheetfile.config = null;
                sheetfile.filter = null;
                sheetfile.filter_select = null;
                sheetfile.celldata = [];
                sheetfile.pivotTable = {};
                sheetfile.calcChain = [];
                sheetfile.status = 0;
                sheetfile.load = 0;

                jfgrid.flowdata = [];
                jfgrid.editor.webWorkerFlowDataCache(jfgrid.flowdata);//worker存数据

                $("#"+ container +" .jfgrid-data-visualization-chart").remove();
                $("#"+ container +" .jfgrid-datavisual-selection-set").remove();

                $("#jfgrid-row-count-show, #jfgrid-formula-functionrange-select, #jfgrid-row-count-show, #jfgrid-column-count-show, #jfgrid-change-size-line, #jfgrid-cell-selected-focus, #jfgrid-selection-copy, #jfgrid-cell-selected-extend, #jfgrid-cell-selected-move, #jfgrid-cell-selected").hide();

                delete sheetfile.load;
            }
            else {
                delete sheetfile;
            }
        },
        clear:function(index){
            var _this = this;
            if(index == "all"){
                for(var i=0;i<jfgridfile.length;i++){
                    var sheetfile = jfgridfile[i];
                    _this.clearSheetByIndex(sheetfile.index);
                }
                
            }
            else{
                if(index == null){
                    index = jfgrid.currentSheetIndex;
                }
                _this.clearSheetByIndex(index);
            }

            jfgrid.sheetmanage.changeSheet(jfgridfile[0].index);
        },
        destroy:function(){
            $("#" + container).empty();
            // $("body > .jfgrid-cols-menu, body > .jfgrid-modal-dialog-slider").remove();
            $("body > .jfgrid-cols-menu").remove();

            $("#jfgrid-modal-dialog-mask, #jfgridTextSizeTest, #jfgrid-icon-morebtn-div").remove();
            $("#jfgrid-input-box").parent().remove();
            $("#jfgrid-formula-help-c").remove();
            
            //参数重置
            jfgrid.jfredo = [];
            jfgrid.jfundo = [];

            jfgrid.freezen.initialHorizontal = true;
            jfgrid.freezen.initialVertical = true;
            jfgridConfigsetting.pointEdit = false;
        },
        editorChart:function(c){
            var file = jfgridfile[0];
            var chart_selection_color = jfgrid.jfcolor[0];
            var chart_id = "jfgridEditMode-datav-chart";
            var chart_selection_id = chart_id + "_selection";
            c.chart_id = chart_id;
            var chartTheme = c.chartTheme;
            chartTheme = chartTheme==null?"default0000":chartTheme;

            jfgrid.insertChartTosheet(c.sheetIndex, c.dataSheetIndex, c.option, c.chartType, c.selfOption, c.defaultOption, c.row, c.column, chart_selection_color, chart_id, chart_selection_id, c.chartStyle, c.rangeConfigCheck, c.rangeRowCheck, c.rangeColCheck, c.chartMarkConfig, c.chartTitleConfig, c.winWidth, c.winHeight, c.scrollLeft, c.scrollTop, chartTheme, c.myWidth, c.myHeight, c.myLeft!=null?parseFloat(c.myLeft):null, c.myTop!=null?parseFloat(c.myTop):null, c.myindexrank, true);

            $("#"+chart_id).find(".jfgrid-modal-controll-update").click();
        }
    }

    jfgrid.jfrefreshchartall = function (flowdata1, r_st, r_ed, c_st, c_ed) {
        //chartMix
        !!window.generator && generator.changeChartCellDataHook(flowdata1, r_st, r_ed, c_st, c_ed);
        // $("#jfgrid-cell-main .jfgrid-data-visualization-chart[sheetindex='" + jfgrid.currentSheetIndex + "']").each(function () {
        //     jfgrid.jfrefreshchart($(this), flowdata1, r_st, r_ed, c_st, c_ed);    
        // });
    }

    jfgrid.jfrefreshchart = function ($obj, flowdata1, r_st, r_ed, c_st, c_ed) {
        var row = eval('(' + $obj.attr("row") + ')'), column = eval('(' + $obj.attr("column") + ')');

        if (r_st > row[1] || r_ed < row[0] || c_st > column[1] || c_ed < column[0]) {
            return;
        }
        //console.log(row[1], row[0], column[1], column[0], r_st, r_ed, c_st, c_ed, r_st > row[1] ,r_ed < row[0], c_st > column[1] , c_ed < column[0]);
        var type = $obj.attr("chartType"), style = $obj.attr("chartStyle"), selfOption = $obj.attr("selfOption"), defaultOption = $obj.attr("defaultOption"), chartMarkConfig = $obj.attr("chartMarkConfig"), chartTitleConfig = $obj.attr("chartTitleConfig"), chartTheme = $obj.attr("chartTheme");

        //console.log(type, style, selfOption, chartMarkConfig, chartTitleConfig, jfgrid.chartparam.jfgridcurrentChart);

        jfgrid.chartparam.jgridCurrentChartSelection = { "row": row, "column": column };
        jfgrid.chartparam.jgridCurrentChartData = jfgrid.getdatabyselectionD(flowdata1, jfgrid.chartparam.jgridCurrentChartSelection);

        if (jfgrid.chartparam.jgridCurrentChartData.length >= jfgrid.chartparam.jgridCurrentChartData[0].length) {
            rangeConfigCheck = false;
        }
        else {
            rangeConfigCheck = true;
        }

        if (jfgrid.chartparam.jgridCurrentChartData.length == 1) {
            rangeRowCheck = false;
        }
        else{
            rangeRowCheck = true;
        }

        if (jfgrid.chartparam.jgridCurrentChartData[0].length == 1) {
            rangeColCheck = false;
        }
        else{
            rangeColCheck = true;
        }

        jfgrid.range_config(rangeConfigCheck, rangeRowCheck, rangeColCheck);

        jfgrid.chartparam.jfgridcurrentChart = echarts.getInstanceById($obj.find(".jfgrid-modal-dialog-content").attr("_echarts_instance_"));
        if(jfgrid.getObjType(chartMarkConfig) != "object"){
            chartMarkConfig = eval('('+ chartMarkConfig +')');
        }

        if(jfgrid.getObjType(chartTitleConfig) != "object"){
            chartTitleConfig = eval('('+ chartTitleConfig +')');
        }

        if(jfgrid.getObjType(selfOption) != "object"){
            selfOption = eval('('+ selfOption +')');
        }

        jfgrid.chartparam.jfgrid_chart_mark_config = chartMarkConfig;
        jfgrid.chartparam.jfgrid_chart_title_config = chartTitleConfig;
        jfgrid.chartparam.jfgrid_chart_self_config = selfOption == null ? {} : selfOption;
        //jfgrid.chartparam.jfgrid_chart_default_config = defaultOption;
        jfgrid.jfgrid_datavisual_item_active("datachange", type, style);
        // = chartTheme


        if(typeof jfgrid.jfgridConfigsetting.chartConfigChange == "function" ){
            jfgrid.jfgridConfigsetting.chartConfigChange({ "sheetIndex": $obj.attr("sheetIndex"), "dataSheetIndex": $obj.attr("dataSheetIndex"), "option": jfgrid.chartparam.jfgridcurrentChart.getOption(), "chartType": type, "selfOption": selfOption, "defaultOption": defaultOption, "row": row, "column": column, "chart_id": $obj.attr("chart_id"), "chart_selection_color": $obj.attr("chart_selection_color"), "chart_selection_id": $obj.attr("chart_selection_id"), "chartStyle": style, "rangeConfigCheck": rangeConfigCheck, "rangeRowCheck": rangeRowCheck, "rangeColCheck": rangeColCheck, "chartMarkConfig": chartMarkConfig, "chartTitleConfig": chartTitleConfig, "chartTheme": chartTheme });
        }

        // jfgrid.chartparam.jfgridcurrentChart = null;
        // jfgrid.chartparam.jfgrid_chart_mark_config = null;
        // jfgrid.chartparam.jfgrid_chart_title_config = null;
    }


    //得到单元格的值
    jfgrid.getcellvalue = function (r, c, data, type) {
        if (type == null) {
            type = "v";
        }

        if (data == null) {
            data = jfgrid.flowdata;
        }

        var d_value;

        if (r != null && c != null) {
            d_value = data[r][c];
        }
        else if (r != null) {
            d_value = data[r];
        }
        else if (c != null) {
            d_value = data[c];
        }
        else {
            return data;
        }

        var retv = d_value;

        if(jfgrid.getObjType(d_value) == "object"){
            retv = d_value[type];

            if (type == "f" && retv != null) {
                retv = jfgrid.formula.functionHTMLGenerate(retv);
            }
            else if(type == "f"){
                retv = d_value["v"];
            }else if(d_value && d_value.ct && d_value.ct.fa == 'yyyy-MM-dd'){
                retv = d_value.m
            }
        }

        if(retv == undefined){
            retv = null;
        }

        return retv;
    }

    //new runze 根据亿万格式autoFormatw和精确度accuracy 转换成 w/w0/w0.00 or 0/0.0格式
    jfgrid.setAccuracy = function(autoFormatw, accuracy){
        var acc = "0.";
        var fmt;
        if(autoFormatw == "TRUE"){
            if(accuracy == undefined){
                return "w";
            }else{
                var alength = parseInt(accuracy);
                if(alength == 0){
                    return "w0";
                }else{
                   acc = "w0."
                   for(var i = 0; i < alength; i++){
                       acc += "0";
                   }
                    fmt = acc;
                }
                
            }
        }else{
            if(accuracy == undefined){
                return "General";
            }else{
                var alength = parseInt(accuracy);
                if(alength == 0){
                    return "0";
                }else{
                   for(var i = 0; i < alength; i++){
                       acc += "0";
                   }
                    fmt = acc;
                }
                
            }
        }

        return fmt.toString();     
    }

    //设置单元格的值
    jfgrid.setcellvalue = function (r, c, d, v) {
        var cell = d[r][c];

        var vupdate;

        if(jfgrid.getObjType(v) == "object"){
            cell = v;

            if(v.f != null){
                cell.f = v.f;
            }

            if(v.spl != null){
                cell.spl = v.spl;
            }

            if(jfgrid.getObjType(v.v) == "object"){
                vupdate = v.v.v;
            }
            else{
                vupdate = v.v;
            }
        }
        else{
            var vupdate = v;
        }

        if(jfgrid.func_methods.isRealNull(vupdate)){
            if(jfgrid.getObjType(cell) == "object"){
                delete cell.m;
                delete cell.v;
            }
            else{
                cell = null;
            }

            d[r][c] = cell;

            return;
        }

        if(jfgrid.func_methods.isRealNull(cell)){
            cell = {};
        }
        
        if(vupdate.toString().substr(0, 1) == "'"){
            cell.m = vupdate.toString().substr(1);
            cell.ct = { "fa": "@", "t": "s" };
            cell.v = vupdate.toString().substr(1);
        }
        else if(vupdate.toString().toUpperCase() === "TRUE"){
            cell.m = "TRUE";
            cell.ct = { "fa": "General", "t": "b" };
            cell.v = true;
        }
        else if(vupdate.toString().toUpperCase() === "FALSE"){
            cell.m = "FALSE";
            cell.ct = { "fa": "General", "t": "b" };
            cell.v = false;
        }
        else if(jfgrid.func_methods.valueIsError(vupdate)){
            cell.m = vupdate.toString();
            cell.ct = { "fa": "General", "t": "e" };
            cell.v = vupdate;
        }
        else{
            if(cell.f != null && jfgrid.func_methods.isRealNum(vupdate) && !/^\d{6}(18|19|20)?\d{2}(0[1-9]|1[12])(0[1-9]|[12]\d|3[01])\d{3}(\d|X)$/i.test(vupdate)){
                cell.v = parseFloat(vupdate);
                cell.ct = { "fa": "General", "t": "n" };

                if(cell.v == Infinity || cell.v == -Infinity){
                    cell.m = cell.v.toString();
                }
                else{
                    if(cell.v.toString().indexOf("e") > -1){
                        var len = cell.v.toString().split(".")[1].split("e")[0].length;
                        if(len > 5){
                            len = 5;
                        }

                        cell.m = cell.v.toExponential(len).toString();
                    }
                    else{
                        var mask = jfgrid.mask.genarate(Math.round(cell.v * 1000000000) / 1000000000);

                        cell.m = mask[0].toString(); 
                    }
                }
            }
            else if(cell.ct != null && cell.ct.fa == "@"){
                cell.m = vupdate.toString();
                cell.v = vupdate;
            }
            else if(cell.ct != null && cell.ct.fa != null && cell.ct.fa != "General"){
                if(jfgrid.func_methods.isRealNum(vupdate)){
                    vupdate = parseFloat(vupdate);
                }

                var mask = jfgrid.mask.update(cell.ct.fa, vupdate);

                if(mask === vupdate){ //若原来单元格格式 应用不了 要更新的值，则获取更新值的 格式
                    mask = jfgrid.mask.genarate(vupdate);

                    cell.m = mask[0].toString();
                    cell.ct = mask[1];
                    cell.v = mask[2];
                }
                else{
                    cell.m = mask.toString();
                    cell.v = vupdate;
                }
            }
            else{
                if(jfgrid.func_methods.isRealNum(vupdate) && !/^\d{6}(18|19|20)?\d{2}(0[1-9]|1[12])(0[1-9]|[12]\d|3[01])\d{3}(\d|X)$/i.test(vupdate)){
                    vupdate = parseFloat(vupdate);

                    cell.v = parseFloat(vupdate);
                    cell.ct = { "fa": "General", "t": "n" };

                    if(cell.v == Infinity || cell.v == -Infinity){
                        cell.m = cell.v.toString();
                    }
                    else{
                        var mask = jfgrid.mask.genarate(cell.v);

                        cell.m = mask[0].toString();
                    }
                }
                else{
                    var mask = jfgrid.mask.genarate(vupdate);

                    cell.m = mask[0].toString();
                    cell.ct = mask[1];
                    cell.v = mask[2];
                }
            }
        }

        if(!jfgrid.server.allowUpdate && !jfgridConfigsetting.pointEdit){ //报表模式下，强制把四位以上的数字转换成万亿格式
            if(cell.ct != null && /^(w|W)((0?)|(0\.0+))$/.test(cell.ct.fa) == false && cell.ct.t == "n" && cell.v != null && parseInt(cell.v).toString().length > 4){
                // var autoFormatw = jfgridConfigsetting.autoFormatw.toString().toUpperCase();
                // var accuracy = jfgridConfigsetting.accuracy;

                // rptapp
                //报表修改，下一页不会转换万亿 如果传的有配置，走用户传的配置，否则走默认配置  
                var autoFormatw = "", accuracy;
                if(jfgrid.rptSetting && jfgrid.rptSetting.autoFormatw){
                    autoFormatw = jfgrid.rptSetting.autoFormatw.toString().toUpperCase();
                }else{
                    autoFormatw = jfgridConfigsetting.autoFormatw.toString().toUpperCase();
                }
                if(jfgrid.rptSetting && jfgrid.rptSetting.accuracy){
                    accuracy = jfgrid.rptSetting.accuracy;
                }else{
                    accuracy = jfgridConfigsetting.accuracy;
                } 
                var sfmt = jfgrid.setAccuracy(autoFormatw, accuracy);

                if(sfmt != "General") {
                    cell.ct.fa = sfmt;
                    cell.m = jfgrid.mask.update(sfmt, cell.v);
                }
            }
        }

        d[r][c] = cell;
    }

    jfgrid.jfrefreshcell = function (value, ur, uc) {
        if (clearjfundo) {
            jfgrid.jfundo = [];
            jfgrid.jfredo.push({ "type": "cellchange", "sheetIndex": jfgrid.currentSheetIndex, "value": jfgrid.flowdata[ur][uc], "curvalue": $.extend(true, {}, value), "uprow": ur, "upcolumn": uc });
        }

        if (sourcechange) {
            var row = [].concat(jfgrid.flowdata[ur]);
            row[uc] = value;
            jfgrid.flowdata[ur] = row;
        }

        var data = jfgrid.flowdata;
        var jfgridTableContent = $("#jfgridTableContent").get(0).getContext("2d");
        var scrollWidth = $("#jfgrid-cell-main").scrollLeft(), scrollHeight = $("#jfgrid-cell-main").scrollTop();

        var start_r, start_c, end_r, end_c;

        if (ur == 0) {
            start_r = 0;
        }
        else {
            start_r = visibledatarow[ur - 1] - scrollHeight - 1;
        }
        end_r = visibledatarow[ur] - scrollHeight;

        if (uc == 0) {
            start_c = 0;
        }
        else {
            start_c = visibledatacolumn[uc - 1] - scrollWidth;
        }
        end_c = visibledatacolumn[uc] - scrollWidth;



        if ($("#jfgrid-data-visualization").length > 0 && $("#jfgrid-data-visualization").is(":visible")) {
            jfgrid.chartparam.jgridCurrentChartData = jfgrid.getdatabyselectionD(jfgrid.flowdata, jfgrid.chartparam.jgridCurrentChartSelection);
            jfgrid.jfgrid_datavisual_item_active();
        }

        if (data[ur] != null && data[ur][uc] != null) {
            var value = jfgrid.getcellvalue(ur, uc, data);

            //console.log(config);

            var firstcolumlen = defaultcollen;
            if (config["columlen"] != null && config["columlen"][uc] != null) {
                firstcolumlen = config["columlen"][uc];
            }

            var textMetrics = jfgridTableContent.measureText(value).width;
            if (textMetrics > firstcolumlen) {
                var v = "", value_array = value.toString().split("");
                for (var i = 0; i < value_array.length; i++) {
                    if (jfgridTableContent.measureText(v + "" + value_array[i]).width + 12 > firstcolumlen) {
                        break;
                    }
                    v += value_array[i];
                }
                value = v + "...";
            }

            jfgridTableContent.clearRect(start_c + rowHeaderWidth - 1, start_r + columeHeaderHeight - 1, end_c - start_c - 1, end_r - start_r - 2);
            jfgridTableContent.fillText(value==null?"":value, start_c + 4 + rowHeaderWidth, columeHeaderHeight + start_r + (end_r - start_r) / 2 - 1);

            var rowlen = defaultrowlen;
            if (config["rowlen"] != null && config["rowlen"][ur] != null) {
                rowlen = config["rowlen"][ur];
            }

            jfgridTableContent.clearRect(start_c + rowHeaderWidth - 1 + firstcolumlen - 1, start_r + columeHeaderHeight - 1, 3, end_r - start_r - 2);

            //列
            if (!jfgridcurrentisPivotTable) {
                jfgridTableContent.beginPath();
                jfgridTableContent.moveTo(start_c + rowHeaderWidth - 1 + firstcolumlen, start_r + columeHeaderHeight - 1);
                jfgridTableContent.lineTo(start_c + rowHeaderWidth - 1 + firstcolumlen, start_r + columeHeaderHeight - 1 + rowlen);
                jfgridTableContent.lineWidth = devicePixelRatio;
                jfgridTableContent.strokeStyle = jfgriddefaultstyle.strokeStyle;
                jfgridTableContent.closePath();
                jfgridTableContent.stroke();
            }
        }

        jfgrid.server.saveParam("v", jfgrid.currentSheetIndex, value, { "r":ur, "c":uc });

        jfgrid.jfrefreshchartall(jfgrid.flowdata, ur, ur, uc, uc);

        //编辑器qksheet表格编辑时
        if(jfgridConfigsetting.pointEdit){
            jfgrid.pointEdit_updateData();
        }
    }

    jfgrid.jfrefreshrange = function (data, range, cdformat) {
        //单元格数据更新联动
        jfgrid.formula.execFunctionExist = [];
        for(var s = 0; s < range.length; s++){
            for(var r = range[s].row[0]; r <= range[s].row[1]; r++){
                for(var c = range[s].column[0]; c <= range[s].column[1]; c++){
                    jfgrid.formula.execFunctionExist.push({ "r": r, "c": c, "i": jfgrid.currentSheetIndex });
                }
            }
        }
        jfgrid.formula.execFunctionExist.reverse();
        jfgrid.formula.execFunctionGroup(null, null, null, null, data);
        jfgrid.formula.execFunctionGroupData = null;

        if (clearjfundo) {
            jfgrid.jfundo = [];

            jfgrid.jfredo.push({ 
                "type": "rangechange", 
                "data": jfgrid.flowdata, 
                "curdata": data, 
                "range": range, 
                "sheetIndex": jfgrid.currentSheetIndex,
                "cdformat":  $.extend(true, [], jfgridfile[jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex)]["jfgrid_conditionformat_save"]),
                "curCdformat": cdformat 
            });
        }

        //jfgrid.flowdata
        jfgrid.flowdata = data;
        jfgrid.editor.webWorkerFlowDataCache(jfgrid.flowdata);//worker存数据

        jfgridfile[jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex)].data = jfgrid.flowdata;

        //条件格式
        if(cdformat != null){
            jfgridfile[jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex)]["jfgrid_conditionformat_save"] = cdformat;
        }

        //刷新表格
        setTimeout(function () {
            jfgrid.jfgridrefreshgrid();
        }, 1);

        //发送给后台
        for(var s = 0; s < range.length; s++){
            jfgrid.server.historyParam(jfgrid.flowdata, jfgrid.currentSheetIndex, range[s]);

            jfgrid.jfrefreshchartall(jfgrid.flowdata, range[s].row[0], range[s].row[1], range[s].column[0], range[s].column[1]);
        }

        //编辑器qksheet表格编辑时
        if(jfgridConfigsetting.pointEdit){
            jfgrid.pointEdit_updateData();
        }
    }

    jfgrid.jfrefreshgrid = function (data, range, cfg, cdformat, RowlChange) {
        //单元格数据更新联动
        jfgrid.formula.execFunctionExist = [];
        for(var s = 0; s < range.length; s++){
            for(var r = range[s].row[0]; r <= range[s].row[1]; r++){
                for(var c = range[s].column[0]; c <= range[s].column[1]; c++){
                    jfgrid.formula.execFunctionExist.push({ "r": r, "c": c, "i": jfgrid.currentSheetIndex });
                }
            }
        }
        jfgrid.formula.execFunctionExist.reverse();
        jfgrid.formula.execFunctionGroup(null, null, null, null, data);
        jfgrid.formula.execFunctionGroupData = null;

        if (clearjfundo) {
            jfgrid.jfundo = [];

            if(cfg == null){
                var curConfig = $.extend(true, {}, config);
            }
            else{
                var curConfig = $.extend(true, {}, cfg);
            }

            if(cdformat == null){
                var curCdformat = $.extend(true, [], jfgridfile[jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex)]["jfgrid_conditionformat_save"]);
            }
            else{
                var curCdformat = cdformat;
            }
            
            jfgrid.jfredo.push({ 
                "type": "datachange", 
                "data": jfgrid.flowdata, 
                "curdata": data, 
                "sheetIndex": jfgrid.currentSheetIndex, 
                "range": range, 
                "config": $.extend(true, {}, config), 
                "curConfig": curConfig,
                "cdformat":  $.extend(true, [], jfgridfile[jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex)]["jfgrid_conditionformat_save"]),
                "curCdformat": curCdformat,
                "RowlChange": RowlChange
            });
        }

        //jfgrid.flowdata
        jfgrid.flowdata = data;
        jfgrid.editor.webWorkerFlowDataCache(jfgrid.flowdata);//worker存数据

        jfgridfile[jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex)].data = jfgrid.flowdata;

        //config
        if(cfg != null){
            config = cfg;
            jfgridfile[jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex)].config = config;

            jfgrid.server.saveParam("all", jfgrid.currentSheetIndex, cfg, { "k": "config" });

            if(RowlChange != null){
                jfgrid.jfrefreshgrid_rhcw(jfgrid.flowdata.length, jfgrid.flowdata[0].length);
            }
        }

        //条件格式
        if(cdformat != null){
            jfgridfile[jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex)]["jfgrid_conditionformat_save"] = cdformat;
        
            jfgrid.server.saveParam("all", jfgrid.currentSheetIndex, cdformat, { "k": "jfgrid_conditionformat_save" });
        }

        //更新数据的范围
        for(var s = 0; s < range.length; s++){
            var r1 = range[s].row[0];
            var c1 = range[s].column[0];

            if(jfgrid.flowdata[r1][c1] != null && jfgrid.flowdata[r1][c1].spl != null){
                window.jfgridCurrentRow = r1;
                window.jfgridCurrentColumn = c1;
                window.jfgridCurrentFunction = jfgrid.flowdata[r1][c1].f;

                var fp = $.trim(jfgrid.formula.functionParser(jfgrid.flowdata[r1][c1].f));
                var sparklines = eval(fp);
                jfgrid.flowdata[r1][c1].spl = sparklines;
            }

            if(jfgrid.server.allowUpdate){ //共享编辑模式
                jfgrid.server.historyParam(jfgrid.flowdata, jfgrid.currentSheetIndex, range[s]);
            }

            jfgrid.jfrefreshchartall(jfgrid.flowdata, range[s].row[0], range[s].row[1], range[s].column[0], range[s].column[1]);
        }
        
        //刷新表格
        setTimeout(function () {
            jfgrid.jfgridrefreshgrid();
        }, 1);

        window.jfgrid_getcelldata_cache = null;

        //编辑器qksheet表格编辑时
        if(jfgridConfigsetting.pointEdit){
            jfgrid.pointEdit_updateData();
        }
    }

    jfgrid.pointEdit_updateData = function(){
        var celldata = [];

        if(jfgrid.flowdata != null && jfgrid.flowdata.length > 0){
            celldata = jfgrid.dataToCelldata(jfgrid.flowdata);
        }

        var msTable_files = $.extend(true, [], jfgrid.getjfgridfile());

        msTable_files[0].celldata = celldata;
        msTable_files[0].row = jfgrid.flowdata.length;
        msTable_files[0].column = jfgrid.flowdata[0].length;

        delete msTable_files[0].data;

        jfgridConfigsetting.pointEditUpdate(msTable_files);
    }

    jfgrid.dataToCelldata = function(data){
        var celldata = [];

        for(var r = 0; r < data.length; r++){
            for(var c = 0; c < data[0].length; c++){
                var cell = data[r][c];

                if(cell != null){
                    var obj = {
                        "r": r,
                        "c": c,
                        "v": cell
                    }

                    celldata.push(obj);
                }
            }
        }

        return celldata;
    }

    jfgrid.jfrefreshgridall = function (colwidth, rowheight, data, cfg, range, ctrlType, ctrlValue, cdformat, changeSize) {
        var redo = {};

        if (ctrlType == "cellRowChange") {
            redo["type"] = "cellRowChange";
            redo["config"] = $.extend(true, {}, config);
            redo["curconfig"] = $.extend(true, {}, cfg);

            redo["range"] = $.extend(true, [], jfgird_select_save);
            redo["currange"] = range;

            redo["ctrlType"] = ctrlType;
            redo["ctrlValue"] = ctrlValue;

            var setfield = cfg["rowlen"];

            if(setfield == null){
                setfield = {};
            }

            jfgrid.server.saveParam("cg", jfgrid.currentSheetIndex, setfield, { "k": "rowlen" });
        }
        else if (ctrlType.indexOf("extend")>-1) {
            redo["type"] = "extend";
            redo["config"] = $.extend(true, {}, config);
            redo["curconfig"] = $.extend(true, {}, cfg);

            redo["range"] = $.extend(true, [], jfgird_select_save);
            redo["currange"] = range;

            redo["ctrlType"] = ctrlType;
            redo["ctrlValue"] = ctrlValue;

            jfgrid.server.saveParam("arc", jfgrid.currentSheetIndex, {"index": ctrlValue.index, "len": ctrlValue.len, "direction": ctrlValue.direction, "mc": cfg.merge }, { "rc": ctrlValue.type });
        }
        else if (ctrlType.indexOf("dele")>-1) {
            redo["type"] = "dele";
            redo["config"] = $.extend(true, {}, config);
            redo["curconfig"] = $.extend(true, {}, cfg);

            redo["range"] = $.extend(true, [], jfgird_select_save);
            redo["currange"] = range;

            redo["ctrlType"] = ctrlType;
            redo["ctrlValue"] = ctrlValue;

            jfgrid.server.saveParam("drc", jfgrid.currentSheetIndex, {"index": ctrlValue.index, "len":ctrlValue.len, "mc": cfg.merge, "borderInfo": cfg.borderInfo }, { "rc": ctrlValue.type});
        }
        else {
            //单元格数据更新联动
            jfgrid.formula.execFunctionExist = [];
            for(var s = 0; s < range.length; s++){
                for(var r = range[s].row[0]; r <= range[s].row[1]; r++){
                    for(var c = range[s].column[0]; c <= range[s].column[1]; c++){
                        jfgrid.formula.execFunctionExist.push({ "r": r, "c": c, "i": jfgrid.currentSheetIndex });
                    }
                }
            }
            jfgrid.formula.execFunctionExist.reverse();
            jfgrid.formula.execFunctionGroup(null, null, null, null, data);
            jfgrid.formula.execFunctionGroupData = null;

            redo["type"] = "datachangeAll";

            redo["range"] = $.extend(true, [], jfgird_select_save);
            redo["currange"] = range;

            redo["ctrlType"] = ctrlType;
            redo["ctrlValue"] = ctrlValue;

            for(var s = 0; s < range.length; s++){
                jfgrid.server.historyParam(data, jfgrid.currentSheetIndex, range[s]);    
            }
        }

        if (clearjfundo) {
            jfgrid.jfundo = [];

            redo["data"] = jfgrid.flowdata;
            redo["curdata"] = data;
            redo["sheetIndex"] = jfgrid.currentSheetIndex;

            redo["cdformat"] = $.extend(true, [], jfgridfile[jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex)]["jfgrid_conditionformat_save"]);
            redo["curCdformat"] = cdformat;

            jfgrid.jfredo.push(redo);
        }

        //jfgrid.flowdata
        jfgrid.flowdata = data;
        jfgrid.editor.webWorkerFlowDataCache(data);//worker存数据
        jfgridfile[jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex)].data = jfgrid.flowdata;

        //config
        if (cfg != null) {
            config = cfg;
            jfgridfile[jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex)].config = config;

            jfgrid.server.saveParam("all", jfgrid.currentSheetIndex, cfg, { "k": "config" });
        }

        //条件格式
        if(cdformat != null){
            jfgridfile[jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex)]["jfgrid_conditionformat_save"] = cdformat;
        
            jfgrid.server.saveParam("all", jfgrid.currentSheetIndex, cdformat, { "k": "jfgrid_conditionformat_save" });
        }

        //选区
        jfgird_select_save = $.extend(true, [], range);
        if(jfgird_select_save.length > 0){
            //有选区时，刷新一下选区
            jfgrid.selectHightlightShow();
        }

        //行高、列宽 刷新  
        jfgrid.jfrefreshgrid_rhcw(rowheight, colwidth);

        setTimeout(function () {
            jfgrid.jfgridrefreshgrid();
        }, 1);

        jfgrid.sheetmanage.storeSheetParamALL();

        if (cfg == null) {
            for(var s = 0; s < range.length; s++){
                jfgrid.jfrefreshchartall(jfgrid.flowdata, range[s].row[0], range[s].row[1], range[s].column[0], range[s].column[1]);
            }
        }
        
        window.jfgrid_getcelldata_cache = null;

        //编辑器qksheet表格编辑时
        if(jfgridConfigsetting.pointEdit){
            jfgrid.pointEdit_updateData();
        }
    }

    //删除、增加行列 刷新表格
    jfgrid.jfrefreshgrid_adRC = function(data, cfg, ctrlType, ctrlValue, calc, filterObj, cf, af, freezen){
        var file = jfgridfile[jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex)];

        //merge改变对应的单元格值改变
        var mcData = [];
        for(var m in cfg["merge"]){
            var mc = cfg["merge"][m];

            for(var r = mc.r; r <= mc.r + mc.rs - 1; r++){
                for(var c = mc.c; c <= mc.c + mc.cs - 1; c++){
                    if(data[r][c] == null){
                        data[r][c] = {};
                    }

                    if(r == mc.r && c == mc.c){
                        data[r][c].mc = mc;
                    }
                    else{
                        data[r][c].mc = { "r": mc.r, "c": mc.c };
                    }

                    mcData.push({ "r": r, "c": c });                       
                }
            }
        }

        //公式链中公式范围改变对应单元格值的改变
        var funcData = [];
        if(calc.length > 0){
            jfgrid.formula.execFunctionGroupData = data;

            for(var i = 0; i < calc.length; i++){
                var clc = calc[i];
                var clc_r = clc.r, clc_c = clc.c, clc_i = clc.index, clc_funcStr = clc.func[2];
                var clc_result = jfgrid.formula.execfunction(clc_funcStr, clc_r, clc_c, null, true);
                clc.func = clc_result;

                if(data[clc_r][clc_c].f == clc_funcStr){
                    jfgrid.setcellvalue(clc_r, clc_c, data, clc_result[1]);
                    funcData.push({ "r": clc_r, "c": clc_c });
                }
            }
        }

        if(clearjfundo){
            jfgrid.jfundo = [];

            jfgrid.jfredo.push({
                "type": ctrlType,
                "sheetIndex": jfgrid.currentSheetIndex,
                "data": jfgrid.flowdata,
                "curData": data,
                "config": $.extend(true, {}, config),
                "curConfig": cfg,
                "ctrlValue": ctrlValue,
                "mcData": mcData,
                "calc": $.extend(true, [], file.calcChain),
                "curCalc": calc,
                "funcData": funcData,
                "filterObj": { "filter_select": $.extend(true, {}, file.filter_select), "filter": $.extend(true, {}, file.filter) },
                "curFilterObj": filterObj,
                "cf": $.extend(true, [], file.jfgrid_conditionformat_save),
                "curCf": cf,
                "af": $.extend(true, [], file.jfgrid_alternateformat_save),
                "curAf": af,
                "freezen": { "freezenhorizontaldata": jfgrid.freezen.freezenhorizontaldata, "freezenverticaldata": jfgrid.freezen.freezenverticaldata },
                "curFreezen": freezen
            });
        }

        var index = ctrlValue.index,
            len = ctrlValue.len,
            rc = ctrlValue.rc;

        if(ctrlType == "addRC"){
            var direction = ctrlValue.direction,
                restore = ctrlValue.restore;

            var addData = [];
            if(restore){
                if(rc == "r"){
                    if(direction == "lefttop"){
                        var st_r = index;
                    }
                    else if(direction == "rightbottom"){
                        var st_r = index + 1;
                    }
                    var ed_r = st_r + len - 1;

                    for(var r = st_r; r <= ed_r; r++){
                        var row = [];
                        for(var c = 0; c < data[0].length; c++){
                            var cell = data[r][c];
                            row.push(cell);
                        }
                        addData.push(row);
                    }
                }
                else if(rc == "c"){
                    if(direction == "lefttop"){
                        var st_c = index;
                    }
                    else if(direction == "rightbottom"){
                        var st_c = index + 1;
                    }
                    var ed_c = st_c + len - 1;

                    for(var r = 0; r < data.length; r++){
                        var row = [];
                        for(var c = st_c; c <= ed_c; c++){
                            var cell = data[r][c];
                            row.push(cell);
                        }
                        addData.push(row);
                    }
                }
            }

            jfgrid.server.saveParam("arc", jfgrid.currentSheetIndex, {"index": index, "len": len, "direction": direction, "data": addData }, { "rc": rc });
        }
        else if(ctrlType == "delRC"){
            jfgrid.server.saveParam("drc", jfgrid.currentSheetIndex, {"index": index, "len": len }, { "rc": rc });
        }

        //jfgrid.flowdata
        jfgrid.flowdata = data;
        jfgrid.editor.webWorkerFlowDataCache(jfgrid.flowdata);//worker存数据
        file.data = data;

        //config
        config = cfg;
        file.config = config;
        jfgrid.server.saveParam("all", jfgrid.currentSheetIndex, cfg, { "k": "config" });

        //mcData
        for(var i = 0; i < mcData.length; i++){
            var mcData_r = mcData[i].r,
                mcData_c = mcData[i].c;

            jfgrid.server.saveParam("v", jfgrid.currentSheetIndex, jfgrid.flowdata[mcData_r][mcData_c], { "r": mcData_r, "c": mcData_c });
        }

        //calc函数链
        file.calcChain = calc;
        jfgrid.server.saveParam("all", jfgrid.currentSheetIndex, calc, { "k": "calcChain" });
        for(var i = 0; i < funcData.length; i++){
            var funcData_r = funcData[i].r,
                funcData_c = funcData[i].c;

            jfgrid.server.saveParam("v", jfgrid.currentSheetIndex, jfgrid.flowdata[funcData_r][funcData_c], { "r": funcData_r, "c": funcData_c });
        }

        //筛选配置
        if(filterObj != null){
            file.filter_select = filterObj.filter_select;
            file.filter = filterObj.filter;
        }
        else{
            file.filter_select = null;
            file.filter = null;
        }
        jfgrid.createFilterOptions(file.filter_select, file.filter);
        jfgrid.server.saveParam("all", jfgrid.currentSheetIndex, file.filter_select, { "k": "filter_select" });
        jfgrid.server.saveParam("all", jfgrid.currentSheetIndex, file.filter, { "k": "filter" });

        //条件格式配置
        file.jfgrid_conditionformat_save = cf;
        jfgrid.server.saveParam("all", jfgrid.currentSheetIndex, file.jfgrid_conditionformat_save, { "k": "jfgrid_conditionformat_save" });

        //交替颜色配置
        file.jfgrid_alternateformat_save = af;
        jfgrid.server.saveParam("all", jfgrid.currentSheetIndex, file.jfgrid_alternateformat_save, { "k": "jfgrid_alternateformat_save" });
    
        //冻结配置
        if(freezen != null){
            jfgrid.freezen.freezenhorizontaldata = freezen.freezenhorizontaldata;
            jfgrid.freezen.freezenverticaldata = freezen.freezenverticaldata;
        }
        else{
            jfgrid.freezen.freezenhorizontaldata = null;
            jfgrid.freezen.freezenverticaldata = null;
        }

        //行高、列宽刷新
        jfgrid.jfrefreshgrid_rhcw(jfgrid.flowdata.length, jfgrid.flowdata[0].length);
    }

    //行高、列宽改变 刷新表格
    jfgrid.jfrefreshgrid_rhcw = function(rowheight, colwidth){
        //行高
        if(rowheight != null){
            visibledatarow = [];
            rh_height = 0;

            for (var i = 0; i < rowheight; i++) {
                var rowlen = defaultrowlen;

                if (config["rowlen"] != null && config["rowlen"][i] != null) {
                    rowlen = config["rowlen"][i];
                }

                if (config["rowhidden"] != null && config["rowhidden"][i] != null) {
                    rowlen = config["rowhidden"][i];
                    visibledatarow.push(rh_height);
                    continue;
                }
                else {
                    rh_height += rowlen + 1;
                }

                visibledatarow.push(rh_height); //行的临时长度分布
            }

            if(!jfgridConfigsetting.pointEdit){
                //非编辑器qksheet表格编辑状态
                rh_height += 110;
            }
        }

        //列宽
        if(colwidth != null){
            visibledatacolumn = [];
            ch_width = 0;

            for (var i = 0; i < colwidth; i++) {
                var firstcolumlen = defaultcollen;

                if (config["columlen"] != null && config["columlen"][i] != null) {
                    firstcolumlen = config["columlen"][i];
                }
                else {
                    if (jfgrid.flowdata[0] != null && jfgrid.flowdata[0][i] != null) {
                        if (firstcolumlen > 300) {
                            firstcolumlen = 300;
                        }
                        else if (firstcolumlen < defaultcollen) {
                            firstcolumlen = defaultcollen;
                        }

                        if (firstcolumlen != defaultcollen) {
                            if (config["columlen"] == null) {
                                config["columlen"] = {};
                            }

                            config["columlen"][i] = firstcolumlen;
                        }
                    }
                }

                ch_width += firstcolumlen + 1;

                visibledatacolumn.push(ch_width);//列的临时长度分布
            }

            if(!jfgridConfigsetting.pointEdit){
                //非编辑器qksheet表格编辑状态
                ch_width += 120;
            }
        }

        jfgrid.sheetmanage.storeSheetParam();

        //行高列宽改变时 重新计算sparklines
        var calcChain = jfgridfile[jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex)].calcChain;
        
        if(calcChain != null && calcChain.length > 0){
            if(config["rowlen"] == null){
                config["rowlen"] = {};
            }

            if(config["columlen"] == null){
                config["columlen"] = {};
            }            

            for(var i = 0; i < calcChain.length; i++){
                var r = calcChain[i].r, c = calcChain[i].c, index = calcChain[i].index;

                if(index == jfgrid.currentSheetIndex && jfgrid.flowdata[r][c] != null && jfgrid.flowdata[r][c].spl != null && ((r in config["rowlen"]) || (c in config["columlen"]))){
                    window.jfgridCurrentRow = r;
                    window.jfgridCurrentColumn = c;
                    window.jfgridCurrentFunction = jfgrid.flowdata[r][c].f;

                    var fp = $.trim(jfgrid.formula.functionParser(jfgrid.flowdata[r][c].f));
                    var sparklines = eval(fp);
                    jfgrid.flowdata[r][c].spl = sparklines;

                    jfgrid.server.saveParam("v", jfgrid.currentSheetIndex, jfgrid.flowdata[r][c], { "r": r, "c": c });
                }
            }

            jfgridfile[jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex)].data = jfgrid.flowdata;
        }

        //批注框同步
        jfgrid.postil.positionSync();

        //选区同步
        jfgrid.selectHightlightShow();

        //改变单元格行高，复制虚线框同步
        if($(".jfgrid-selection-copy").is(":visible")){
            jfgrid.selectionCopyShow();
        }

        //改变单元格行高，选区下拉icon隐藏
        if($("#jfgrid-dropCell-icon").is(":visible")){
            $("#jfgrid-dropCell-icon").remove();
        }

        //有冻结状态时，同步行高、列宽
        if(jfgrid.freezen.freezenhorizontaldata != null && jfgrid.freezen.freezenverticaldata != null){
            var row_st = jfgrid.freezen.freezenhorizontaldata[1] - 1;
            var col_st = jfgrid.freezen.freezenverticaldata[1] - 1;

            var scrollTop = jfgrid.freezen.freezenhorizontaldata[2];
            var scrollLeft = jfgrid.freezen.freezenverticaldata[2];

            var top = visibledatarow[row_st] - 2 - scrollTop + columeHeaderHeight;
            var freezenhorizontaldata = [visibledatarow[row_st], row_st + 1, scrollTop, jfgrid.freezen.cutVolumn(visibledatarow, row_st + 1), top];
            var left = visibledatacolumn[col_st] - 2 - scrollLeft + rowHeaderWidth;
            var freezenverticaldata = [visibledatacolumn[col_st], col_st + 1, scrollLeft, jfgrid.freezen.cutVolumn(visibledatacolumn, col_st + 1), left];

            jfgrid.freezen.saveFreezen(freezenhorizontaldata, top, freezenverticaldata, left);
            jfgrid.freezen.createFreezenHorizontal(freezenhorizontaldata, top);
            jfgrid.freezen.createFreezenVertical(freezenverticaldata, left);
            jfgrid.freezen.createAssistCanvas();
        }
        else if(jfgrid.freezen.freezenhorizontaldata != null){
            var row_st = jfgrid.freezen.freezenhorizontaldata[1] - 1;
            var scrollTop = jfgrid.freezen.freezenhorizontaldata[2];

            var top = visibledatarow[row_st] - 2 - scrollTop + columeHeaderHeight;
            var freezenhorizontaldata = [visibledatarow[row_st], row_st + 1, scrollTop, jfgrid.freezen.cutVolumn(visibledatarow, row_st + 1), top];

            jfgrid.freezen.saveFreezen(freezenhorizontaldata, top, null, null);
            jfgrid.freezen.createFreezenHorizontal(freezenhorizontaldata, top);
            jfgrid.freezen.createAssistCanvas();
        }
        else if(jfgrid.freezen.freezenverticaldata != null){
            var col_st = jfgrid.freezen.freezenverticaldata[1] - 1;
            var scrollLeft = jfgrid.freezen.freezenverticaldata[2];

            var left = visibledatacolumn[col_st] - 2 - scrollLeft + rowHeaderWidth;
            var freezenverticaldata = [visibledatacolumn[col_st], col_st + 1, scrollLeft, jfgrid.freezen.cutVolumn(visibledatacolumn, col_st + 1), left];

            jfgrid.freezen.saveFreezen(null, null, freezenverticaldata, left);
            jfgrid.freezen.createFreezenVertical(freezenverticaldata, left);
            jfgrid.freezen.createAssistCanvas();
        }
        else{
            //有筛选标志时，同步筛选按钮和筛选范围位置
            if($("#jfgrid-filter-options-sheet" + jfgrid.currentSheetIndex + " .jfgrid-filter-options").length > 0){
                $("#jfgrid-filter-options-sheet" + jfgrid.currentSheetIndex + " .jfgrid-filter-options").each(function(i, e){
                    var str = $(e).data("str"), cindex = $(e).data("cindex");

                    var left = visibledatacolumn[cindex] - 20;
                    var top = str - 1 == -1 ? 0 : visibledatarow[str - 1];

                    $(e).css({ "left": left, "top": top });
                });
            }
        }

        if($("#jfgrid-filter-selected-sheet" + jfgrid.currentSheetIndex).length > 0){
            var jfgird_filter_save = jfgridfile[jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex)].filter_select;

            var r1 = jfgird_filter_save.row[0], r2 = jfgird_filter_save.row[1];
            var c1 = jfgird_filter_save.column[0], c2 = jfgird_filter_save.column[1];

            var row = visibledatarow[r2], row_pre = r1 - 1 == -1 ? 0 : visibledatarow[r1 - 1];
            var col = visibledatacolumn[c2], col_pre = c1 - 1 == -1 ? 0 : visibledatacolumn[c1 - 1];

            $("#jfgrid-filter-selected-sheet" + jfgrid.currentSheetIndex).css({
                "left": col_pre,
                "width": col - col_pre - 1,
                "top": row_pre,
                "height": row - row_pre - 1
            });
        }

        jfgrid.sheetmanage.showSheet();

        setTimeout(function () {
            jfgrid.jfgridrefreshgrid();
        }, 1);

        //编辑器qksheet表格编辑时
        if(jfgridConfigsetting.pointEdit){
            jfgrid.pointEdit_updateData();
        }
    }

    //复制剪切 刷新表格
    jfgrid.jfrefreshgrid_pastcut = function(source, target, RowlChange){
        //单元格数据更新联动
        var execF_rc = {};
        jfgrid.formula.execFunctionExist = [];

        for(var r = source["range"].row[0]; r <= source["range"].row[1]; r++){
            for(var c = source["range"].column[0]; c <= source["range"].column[1]; c++){
                if((r + "_" + c + "_" + source["sheetIndex"]) in execF_rc){
                    continue;
                }

                execF_rc[r + "_" + c + "_" + source["sheetIndex"]] = 0;
                jfgrid.formula.execFunctionExist.push({ "r": r, "c": c, "i": source["sheetIndex"] });
            }
        }

        for(var r = target["range"].row[0]; r <= target["range"].row[1]; r++){
            for(var c = target["range"].column[0]; c <= target["range"].column[1]; c++){
                if((r + "_" + c + "_" + target["sheetIndex"]) in execF_rc){
                    continue;
                }

                execF_rc[r + "_" + c + "_" + target["sheetIndex"]] = 0;
                jfgrid.formula.execFunctionExist.push({ "r": r, "c": c, "i": target["sheetIndex"] });
            }
        }

        jfgrid.formula.execFunctionExist.reverse();
        jfgrid.formula.execFunctionGroup(null, null, null, null, target["curData"]);
        jfgrid.formula.execFunctionGroupData = null;

        if(clearjfundo){
            jfgrid.jfundo = [];

            jfgrid.jfredo.push({
                "type": "pasteCut",
                "source": source,
                "target": target,
                "RowlChange": RowlChange
            })
        }

        //config
        if(jfgrid.currentSheetIndex == source["sheetIndex"]){
            config = source["curConfig"];
            var rowHeight = source["curData"].length;
            jfgridfile[jfgrid.sheetmanage.getSheetIndex(target["sheetIndex"])]["config"] = target["curConfig"];
        }
        else if(jfgrid.currentSheetIndex == target["sheetIndex"]){
            config = target["curConfig"];
            var rowHeight = target["curData"].length;
            jfgridfile[jfgrid.sheetmanage.getSheetIndex(source["sheetIndex"])]["config"] = source["curConfig"];
        }

        if(RowlChange){
            visibledatarow = [];
            rh_height = 0;
            for (var i = 0; i < rowHeight; i++) {
                var rowlen = defaultrowlen;
                if (config["rowlen"] != null && config["rowlen"][i] != null) {
                    rowlen = config["rowlen"][i];
                }
                if (config["rowhidden"] != null && config["rowhidden"][i] != null) {
                    rowlen = config["rowhidden"][i];
                    visibledatarow.push(rh_height);
                    continue;
                }
                else {
                    rh_height += rowlen + 1;
                }
                visibledatarow.push(rh_height);//行的临时长度分布
            }
            rh_height += 110;
            jfgrid.sheetmanage.showSheet();

            if(jfgrid.currentSheetIndex == source["sheetIndex"]){
                var rowlenArr = jfgrid.computeRowlenArr(target["curData"].length, target["curConfig"]);
                jfgridfile[jfgrid.sheetmanage.getSheetIndex(target["sheetIndex"])]["visibledatarow"] = rowlenArr;
            }
            else if(jfgrid.currentSheetIndex == target["sheetIndex"]){
                var rowlenArr = jfgrid.computeRowlenArr(source["curData"].length, source["curConfig"]);
                jfgridfile[jfgrid.sheetmanage.getSheetIndex(source["sheetIndex"])]["visibledatarow"] = rowlenArr;
            }
        }

        //jfgrid.flowdata
        if(jfgrid.currentSheetIndex == source["sheetIndex"]){
            jfgrid.flowdata = source["curData"];
            jfgridfile[jfgrid.sheetmanage.getSheetIndex(target["sheetIndex"])]["data"] = target["curData"];
        }
        else if(jfgrid.currentSheetIndex == target["sheetIndex"]){
            jfgrid.flowdata = target["curData"];
            jfgridfile[jfgrid.sheetmanage.getSheetIndex(source["sheetIndex"])]["data"] = source["curData"];
        }
        jfgrid.editor.webWorkerFlowDataCache(jfgrid.flowdata);//worker存数据
        jfgridfile[jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex)].data = jfgrid.flowdata;
        
        //jfgird_select_save
        if(jfgrid.currentSheetIndex == target["sheetIndex"]){
            jfgird_select_save = [{"row": target["range"].row, "column": target["range"].column}];
        }
        else{
            jfgird_select_save = [{"row": source["range"].row, "column": source["range"].column}];
        }
        if(jfgird_select_save.length > 0){
            //有选区时，刷新一下选区
            jfgrid.selectHightlightShow();
        }

        //条件格式
        jfgridfile[jfgrid.sheetmanage.getSheetIndex(source["sheetIndex"])].jfgrid_conditionformat_save = source["curCdformat"];
        jfgridfile[jfgrid.sheetmanage.getSheetIndex(target["sheetIndex"])].jfgrid_conditionformat_save = target["curCdformat"];

        setTimeout(function () {
            jfgrid.jfgridrefreshgrid();
        }, 1);

        jfgrid.sheetmanage.storeSheetParamALL();

        jfgrid.jfrefreshchartall(jfgrid.flowdata, 0, jfgrid.flowdata.length - 1, 0, jfgrid.flowdata[0].length - 1);

        //saveparam
        //来源表
        jfgrid.server.saveParam("all", source["sheetIndex"], source["curConfig"], { "k": "config" });
        //目的表
        jfgrid.server.saveParam("all", target["sheetIndex"], target["curConfig"], { "k": "config" });
        
        //来源表
        jfgrid.server.historyParam(source["curData"], source["sheetIndex"], {"row": source["range"]["row"], "column": source["range"]["column"]});
        //目的表
        jfgrid.server.historyParam(target["curData"], target["sheetIndex"], {"row": target["range"]["row"], "column": target["range"]["column"]});
    
        //编辑器qksheet表格编辑时
        if(jfgridConfigsetting.pointEdit){
            jfgrid.pointEdit_updateData();
        }
    }

    jfgrid.jfgridcreatesheet = function (colwidth, rowheight, data, cfg, active) {
        if(active == null){
            active = true;
        }

        visibledatarow = [];
        visibledatacolumn = [];
        rowsplit = [];
        colsplit = [];
        ch_width = 0;
        rh_height = 0;

        if(cfg != null){
            config = cfg;
        }
        else{
            config = {};
        }

        if (data.length == 0) {
            jfgrid.flowdata = jfgrid.datagridgrowth(data, rowheight, colwidth);
        }
        else if (data.length < rowheight && data[0].length < colwidth) {
            jfgrid.flowdata = jfgrid.datagridgrowth(data, rowheight - data.length, colwidth - data[0].length);
        }
        else if (data.length < rowheight) {
            jfgrid.flowdata = jfgrid.datagridgrowth(data, rowheight - data.length, 0);
        }
        else if (data[0].length < colwidth) {
            jfgrid.flowdata = jfgrid.datagridgrowth(data, 0, colwidth - data[0].length);
        }
        else {
            jfgrid.flowdata = data;
        }

        jfgrid.editor.webWorkerFlowDataCache(jfgrid.flowdata);//worker存数据

        var flowHTML = flow;
        for (var i = 0; i < colwidth; i++) {
            var firstcolumlen = defaultcollen;
            if (config["columlen"] != null && config["columlen"][i] != null) {
                firstcolumlen = config["columlen"][i];
            }
            else {
                if (data[0] != null && data[0][i] != null) {
                    firstcolumlen = Math.ceil(jfgrid.getByteLen(data[0][i]) * 11.5);
                    if (firstcolumlen > 300) {
                        firstcolumlen = 300;
                    }
                    else if (firstcolumlen < defaultcollen) {
                        firstcolumlen = defaultcollen;
                    }

                    if (firstcolumlen != defaultcollen) {
                        if (config["columlen"] == null) {
                            config["columlen"] = {};
                        }
                        config["columlen"][i] = firstcolumlen;
                    }
                }
            }
            ch_width += firstcolumlen + 1;
            visibledatacolumn.push(ch_width); //列的临时长度分布
        }

        for (var i = 0; i < rowheight; i++) {
            var rowlen = defaultrowlen;
            if (config["rowlen"] != null && config["rowlen"][i] != null) {
                rowlen = config["rowlen"][i];
            }
            if (config["rowhidden"] != null && config["rowhidden"][i] != null) {
                rowlen = config["rowhidden"][i];
                visibledatarow.push(rh_height);
                continue;
            }
            else {
                rh_height += rowlen + 1;
            }
            visibledatarow.push(rh_height); //行的临时长度分布
        }


        rh_height+= 110;
        ch_width+= 120;


        if(active){
            jfgrid.sheetmanage.showSheet();

            setTimeout(function () {
                jfgrid.sheetmanage.restoreCache();
                jfgrid.formula.execFunctionGroup();
                jfgrid.sheetmanage.restoreSheetAll(jfgrid.currentSheetIndex);
                jfgrid.jfgridrefreshgrid();
            }, 1);
        }
        else{
            
        }

        // setTimeout(function () {
        //     for (var i = 0; i < refreshcanvas.length; i++) {
        //         refreshcanvas[i].stroke();
        //     }
        // }, 1);
    }


    //按照scrollHeight, scrollWidth刷新canvas展示数据
    jfgrid.jfgridrefreshgrid = function (scrollWidth, scrollHeight) {
        jfgrid.formula.groupValuesRefresh();
        
        if (scrollWidth == null) {
            scrollWidth = $("#jfgrid-cell-main").scrollLeft();
        }
        if (scrollHeight == null) {
            scrollHeight = $("#jfgrid-cell-main").scrollTop();
        }

        if (jfgrid.freezen.freezenverticaldata != null || jfgrid.freezen.freezenhorizontaldata != null) {
            var freezen_horizon_px, freezen_horizon_ed, freezen_horizon_scrollTop;
            var freezen_vertical_px, freezen_vertical_ed, freezen_vertical_scrollTop;
            var drawWidth = jfgridTableContentHW[0], drawHeight = jfgridTableContentHW[1];
            
            if (jfgrid.freezen.freezenverticaldata != null && jfgrid.freezen.freezenhorizontaldata != null) {
                freezen_horizon_px = jfgrid.freezen.freezenhorizontaldata[0];
                freezen_horizon_ed = jfgrid.freezen.freezenhorizontaldata[1];
                freezen_horizon_scrollTop = jfgrid.freezen.freezenhorizontaldata[2];

                freezen_vertical_px = jfgrid.freezen.freezenverticaldata[0];
                freezen_vertical_ed = jfgrid.freezen.freezenverticaldata[1];
                freezen_vertical_scrollTop = jfgrid.freezen.freezenverticaldata[2];

                //左上canvas freezen_3
                jfgridDrawMain(freezen_vertical_scrollTop, freezen_horizon_scrollTop, freezen_vertical_px, freezen_horizon_px, 1, 1, null, null, "freezen_3");

                //上右canvas freezen_4
                jfgridDrawMain(scrollWidth + freezen_vertical_px - freezen_vertical_scrollTop, freezen_horizon_scrollTop, drawWidth - freezen_vertical_px + freezen_vertical_scrollTop, freezen_horizon_px, 1, 1, null, null, "freezen_4");

                //左下canvas freezen_7
                jfgridDrawMain(freezen_vertical_scrollTop, scrollHeight + freezen_horizon_px - freezen_horizon_scrollTop, freezen_vertical_px, drawHeight - freezen_horizon_px + freezen_horizon_scrollTop, 1, 1, null, null, "freezen_7");

                //右下canvas jfgridTableContent
                jfgridDrawMain(scrollWidth + freezen_vertical_px - freezen_vertical_scrollTop, scrollHeight + freezen_horizon_px - freezen_horizon_scrollTop, drawWidth - freezen_vertical_px + freezen_vertical_scrollTop, drawHeight - freezen_horizon_px + freezen_horizon_scrollTop, freezen_vertical_px - freezen_vertical_scrollTop + rowHeaderWidth, freezen_horizon_px - freezen_horizon_scrollTop + columeHeaderHeight);

                //标题
                jfgridDrawgridColumnTitle(freezen_vertical_scrollTop, freezen_vertical_px, rowHeaderWidth);
                jfgridDrawgridColumnTitle(scrollWidth + freezen_vertical_px - freezen_vertical_scrollTop, drawWidth - freezen_vertical_px + freezen_vertical_scrollTop, freezen_vertical_px - freezen_vertical_scrollTop + rowHeaderWidth);
                
                jfgridDrawgridRowTitle(freezen_horizon_scrollTop, freezen_horizon_px, columeHeaderHeight);
                jfgridDrawgridRowTitle(scrollHeight + freezen_horizon_px - freezen_horizon_scrollTop, drawHeight - freezen_horizon_px + freezen_horizon_scrollTop, freezen_horizon_px - freezen_horizon_scrollTop + columeHeaderHeight);
            }
            else if (jfgrid.freezen.freezenhorizontaldata != null) {
                freezen_horizon_px = jfgrid.freezen.freezenhorizontaldata[0];
                freezen_horizon_ed = jfgrid.freezen.freezenhorizontaldata[1];
                freezen_horizon_scrollTop = jfgrid.freezen.freezenhorizontaldata[2];

                jfgridDrawMain(scrollWidth, freezen_horizon_scrollTop, drawWidth, freezen_horizon_px, 1, 1, null, null, "freezen_h");
                jfgridDrawMain(scrollWidth, scrollHeight + freezen_horizon_px - freezen_horizon_scrollTop, drawWidth, drawHeight - freezen_horizon_px + freezen_horizon_scrollTop, null, freezen_horizon_px - freezen_horizon_scrollTop + columeHeaderHeight);
            
                jfgridDrawgridColumnTitle(scrollWidth, drawWidth, null);

                jfgridDrawgridRowTitle(freezen_horizon_scrollTop, freezen_horizon_px, columeHeaderHeight);
                jfgridDrawgridRowTitle(scrollHeight + freezen_horizon_px - freezen_horizon_scrollTop, drawHeight - freezen_horizon_px + freezen_horizon_scrollTop, freezen_horizon_px - freezen_horizon_scrollTop + columeHeaderHeight);
            }
            else if (jfgrid.freezen.freezenverticaldata != null) {
                freezen_vertical_px = jfgrid.freezen.freezenverticaldata[0];
                freezen_vertical_ed = jfgrid.freezen.freezenverticaldata[1];
                freezen_vertical_scrollTop = jfgrid.freezen.freezenverticaldata[2];
                
                jfgridDrawMain(freezen_vertical_scrollTop, scrollHeight, freezen_vertical_px, drawHeight, 1, 1, null, null, "freezen_v");
                jfgridDrawMain(scrollWidth + freezen_vertical_px - freezen_vertical_scrollTop, scrollHeight, drawWidth - freezen_vertical_px + freezen_vertical_scrollTop, drawHeight, freezen_vertical_px - freezen_vertical_scrollTop + rowHeaderWidth, null);
                
                jfgridDrawgridRowTitle(scrollHeight, drawHeight, null);

                jfgridDrawgridColumnTitle(freezen_vertical_scrollTop, freezen_vertical_px, rowHeaderWidth);
                jfgridDrawgridColumnTitle(scrollWidth + freezen_vertical_px - freezen_vertical_scrollTop, drawWidth - freezen_vertical_px + freezen_vertical_scrollTop, freezen_vertical_px - freezen_vertical_scrollTop + rowHeaderWidth);
            }
        }
        else {
            jfgridDrawgrid(scrollWidth, scrollHeight);
        }
    }

    function jfgridDrawgrid(scrollWidth, scrollHeight, drawWidth, drawHeight, offsetLeft, offsetTop) {
        if($("#jfgridTableContent").length == 0){
            return;
        }

        if(jfgridfile[jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex)]["isPivotTable"]){
            jfgridDrawMain_back(scrollWidth, scrollHeight, drawWidth, drawHeight, offsetLeft, offsetTop);  
        }
        else{
            jfgridDrawMain(scrollWidth, scrollHeight, drawWidth, drawHeight, offsetLeft, offsetTop);
        }
        
        $("#jfgridTableContent").get(0).getContext("2d").clearRect(0, 0, 46, 20);
        
        jfgridDrawgridColumnTitle(scrollWidth, drawWidth, offsetLeft);
        jfgridDrawgridRowTitle(scrollHeight, drawHeight, offsetTop);
    }

    function jfgridDrawgridRowTitle(scrollHeight, drawHeight, offsetTop) {
        if (scrollHeight == null) {
            scrollHeight = $("#jfgrid-cell-main").scrollTop();
        }

        if (drawHeight == null) {
            drawHeight = jfgridTableContentHW[1];
        }

        if (offsetTop == null) {
            offsetTop = columeHeaderHeight;
        }

        //jfgridTableContentHW = [$("#jfgrid-grid-window-1").width() - 13, $("#jfgrid-grid-window-1").height() - 13];
        var jfgridTableContent = $("#jfgridTableContent").get(0).getContext("2d");
        jfgridTableContent.clearRect(0, offsetTop*devicePixelRatio, (rowHeaderWidth-1)*devicePixelRatio, drawHeight*devicePixelRatio);


        jfgridTableContent.font = jfgriddefaultstyle.font;
        jfgridTableContent.textBaseline = jfgriddefaultstyle.textBaseline;
        jfgridTableContent.fillStyle = jfgriddefaultstyle.fillStyle;

        var dataset_row_st, dataset_row_ed;
        dataset_row_st = jfgrid_searcharray(visibledatarow, scrollHeight);
        dataset_row_ed = jfgrid_searcharray(visibledatarow, scrollHeight + drawHeight);
        if (dataset_row_st == -1) {
            dataset_row_st = 0;
        }
        if (dataset_row_ed == -1) {
            dataset_row_ed = visibledatarow.length - 1;
        }

        //console.log(dataset_row_st, dataset_row_ed, dataset_col_st, dataset_col_ed);
        var end_r, start_r, end_c, start_c, flow_index = 0, flow_cols_index = 0, rowfix = 0, colfix = 0, colLineState = true;

        // $("#jfgrid-cell-main").scrollLeft(visibledatarow[dataset_row_st]);
        // $("#jfgrid-cell-main").scrollTop(visibledatacolumn[dataset_col_st]);

        for (var r = dataset_row_st; r <= dataset_row_ed; r++) {

            if (r == 0) {
                start_r = -scrollHeight - 1;
            }
            else {
                start_r = visibledatarow[r - 1] - scrollHeight - 1;
            }
            end_r = visibledatarow[r] - scrollHeight;



            if (end_r <= drawHeight && start_r >= -1) {

                if (config["rowhidden"] != null && config["rowhidden"][r] != null) {

                }
                else {
                    //jfgridTableContent.clearRect(offsetLeft-1, start_r - 1 + offsetTop, 1, end_r - start_r - 1);

                    //jfgridTableContent.clearRect(start_c + offsetLeft - 1, offsetTop+drawHeight - 1, end_c - start_c - 1, 1);

                    var textMetrics = jfgridTableContent.measureText(r + 1);

                    jfgridTableContent.fillText(r + 1, (rowHeaderWidth*devicePixelRatio - textMetrics.width) / 2, (start_r + (end_r - start_r) / 2 - 2 + offsetTop)*devicePixelRatio);
                }

                jfgridTableContent.beginPath();
                jfgridTableContent.moveTo(-1, (end_r + offsetTop - 2 + 0.5)*devicePixelRatio);
                jfgridTableContent.lineTo((rowHeaderWidth-1)*devicePixelRatio, (end_r + offsetTop - 2 + 0.5)*devicePixelRatio);
                jfgridTableContent.lineWidth = devicePixelRatio;
                jfgridTableContent.strokeStyle = jfgriddefaultstyle.strokeStyle;
                jfgridTableContent.closePath();
                jfgridTableContent.stroke();

                //jfgridTableContent.beginPath();
                //jfgridTableContent.moveTo(end_c - 2 + offsetLeft, 0.5 + offsetTop);
                //jfgridTableContent.lineTo(end_c - 2 + offsetLeft, rh_height + offsetTop);
                //jfgridTableContent.lineWidth = 1;
                //jfgridTableContent.strokeStyle = jfgriddefaultstyle.strokeStyle;
                //jfgridTableContent.closePath();
                //jfgridTableContent.stroke();
            }

        }

        //竖线
        jfgridTableContent.beginPath();
        jfgridTableContent.moveTo((rowHeaderWidth - 2 + 0.5)*devicePixelRatio,  (offsetTop-1)*devicePixelRatio);
        jfgridTableContent.lineTo((rowHeaderWidth - 2 + 0.5)*devicePixelRatio, (rh_height + offsetTop)*devicePixelRatio);
        jfgridTableContent.lineWidth = devicePixelRatio;
        jfgridTableContent.strokeStyle = jfgriddefaultstyle.strokeStyle;
        jfgridTableContent.closePath();
        jfgridTableContent.stroke();


        ////横线
        //jfgridTableContent.beginPath();
        //jfgridTableContent.moveTo(-0.5,  -2 + offsetTop);
        //jfgridTableContent.lineTo(ch_width + offsetLeft, -2 + offsetTop);
        //jfgridTableContent.lineWidth = 1;
        //jfgridTableContent.strokeStyle = jfgriddefaultstyle.strokeStyle;
        //jfgridTableContent.closePath();
        //jfgridTableContent.stroke();

        //jfgridTableContent.clearRect(0, 0, offsetLeft - 2, offsetTop - 2);


        //jfgridTableContent.clearRect(drawWidth > (ch_width + offsetLeft) ? (ch_width + offsetLeft - 2) : drawWidth - 2 + offsetLeft, offsetTop, drawWidth, drawHeight);
    }

    function jfgridDrawgridColumnTitle(scrollWidth, drawWidth, offsetLeft) {
        if (scrollWidth == null) {
            scrollWidth = $("#jfgrid-cell-main").scrollLeft();
        }

        if (drawWidth == null) {
            drawWidth = jfgridTableContentHW[0];
        }

        if (offsetLeft == null) {
            offsetLeft = rowHeaderWidth;
        }

        //jfgridTableContentHW = [$("#jfgrid-grid-window-1").width() - 13, $("#jfgrid-grid-window-1").height() - 13];
        var jfgridTableContent = $("#jfgridTableContent").get(0).getContext("2d");
        jfgridTableContent.clearRect(offsetLeft*devicePixelRatio, -0.5, drawWidth*devicePixelRatio, (columeHeaderHeight-1.5)*devicePixelRatio);


        jfgridTableContent.font = jfgriddefaultstyle.font;
        jfgridTableContent.textBaseline = jfgriddefaultstyle.textBaseline;
        jfgridTableContent.fillStyle = jfgriddefaultstyle.fillStyle;

        var dataset_col_st, dataset_col_ed;
        dataset_col_st = jfgrid_searcharray(visibledatacolumn, scrollWidth);
        dataset_col_ed = jfgrid_searcharray(visibledatacolumn, scrollWidth + drawWidth);
        if (dataset_col_st == -1) {
            dataset_col_st = 0;
        }
        if (dataset_col_ed == -1) {
            dataset_col_ed = visibledatacolumn.length - 1;
        }
        //console.log(dataset_row_st, dataset_row_ed, dataset_col_st, dataset_col_ed);
        var end_r, start_r, end_c, start_c, flow_index = 0, flow_cols_index = 0, rowfix = 0, colfix = 0, colLineState = true;

        // $("#jfgrid-cell-main").scrollLeft(visibledatarow[dataset_row_st]);
        // $("#jfgrid-cell-main").scrollTop(visibledatacolumn[dataset_col_st]);

        for (var r = 0; r <= 0; r++) {


            //行
            //jfgridTableContent.beginPath();
            //jfgridTableContent.moveTo(0, end_r + columeHeaderHeight);
            //jfgridTableContent.lineTo(rowHeaderWidth, end_r + columeHeaderHeight);
            //jfgridTableContent.lineWidth = 1;
            //jfgridTableContent.strokeStyle = jfgriddefaultstyle.strokeStyle;
            //jfgridTableContent.closePath();
            //jfgridTableContent.stroke();



            for (var c = dataset_col_st; c <= dataset_col_ed; c++) {

                if (c == 0) {
                    start_c = -scrollWidth;
                }
                else {
                    start_c = visibledatacolumn[c - 1] - scrollWidth;
                }
                end_c = visibledatacolumn[c] - scrollWidth;

                if (r == 0 && start_c >= -1 && end_c <= drawWidth + 18) {
                    var abc = jfgrid.jfgridchatatABC(c);
                    var textMetrics = jfgridTableContent.measureText(abc);
                    jfgridTableContent.fillText(abc, Math.round(start_c*devicePixelRatio + offsetLeft*devicePixelRatio + (end_c*devicePixelRatio - start_c*devicePixelRatio - textMetrics.width) / 2), Math.round((columeHeaderHeight / 2 - 2)*devicePixelRatio));

                    jfgridTableContent.beginPath();
                    jfgridTableContent.moveTo((end_c + offsetLeft - 2 + 0.5)*devicePixelRatio, 0.5);
                    jfgridTableContent.lineTo((end_c + offsetLeft - 2 + 0.5)*devicePixelRatio, (columeHeaderHeight - 2)*devicePixelRatio);
                    jfgridTableContent.lineWidth = devicePixelRatio;
                    jfgridTableContent.strokeStyle = jfgriddefaultstyle.strokeStyle;
                    jfgridTableContent.closePath();
                    jfgridTableContent.stroke();

                    //jfgridTableContent.clearRect(start_c + offsetLeft - 1, offsetTop-1, end_c - start_c - 1, 1);

                    // jfgridTableContent.clearRect(start_c + offsetLeft - 1, offsetTop+drawHeight, end_c - start_c - 1, 1);

                    if (!jfgridcurrentisPivotTable && end_c <= drawWidth + 18 && start_c >= -1) {
                        //列


                        //jfgridTableContent.beginPath();
                        //jfgridTableContent.moveTo(0.5 + offsetLeft, end_r + offsetTop);
                        //jfgridTableContent.lineTo(ch_width + offsetLeft, end_r + offsetTop);
                        //jfgridTableContent.lineWidth = 1;
                        //jfgridTableContent.strokeStyle = jfgriddefaultstyle.strokeStyle;
                        //jfgridTableContent.closePath();
                        //jfgridTableContent.stroke();
                    }
                }

                //if (r == dataset_row_ed) {
                //    jfgridTableContent.beginPath();
                //    jfgridTableContent.moveTo(end_c + rowHeaderWidth, -0.5);
                //    jfgridTableContent.lineTo(end_c + rowHeaderWidth, columeHeaderHeight+rh_height);
                //    jfgridTableContent.lineWidth = 1;
                //    jfgridTableContent.strokeStyle = jfgriddefaultstyle.strokeStyle;
                //    jfgridTableContent.closePath();
                //    jfgridTableContent.stroke();
                //    console.log("end_c, rh_height", dataset_col_st, dataset_col_ed, dataset_row_st, dataset_row_ed, r_set, c_set, rowfix, $("#jfgridsheettable_" + jfgrid.currentSheetIndex + "_" + r_set + "_" + c_set + ""), end_c, h, r,c);
                //}

            }

            if (config["rowhidden"] != null && config["rowhidden"][r] != null) {

            }
            else {
                //jfgridTableContent.clearRect(offsetLeft-1, start_r - 1 + offsetTop, 1, end_r - start_r - 1);

                //jfgridTableContent.clearRect(start_c + offsetLeft - 1, offsetTop+drawHeight - 1, end_c - start_c - 1, 1);

                //var textMetrics = jfgridTableContent.measureText(r + 1);
                //jfgridTableContent.fillText(r + 1, (offsetLeft - textMetrics.width) / 2, start_r + (end_r - start_r) / 2 - 2 + offsetTop);
            }

        }

        ////竖线
        //jfgridTableContent.beginPath();
        //jfgridTableContent.moveTo(offsetLeft - 2 , -0.5);
        //jfgridTableContent.lineTo(offsetLeft - 2 ,rh_height + offsetTop);
        //jfgridTableContent.lineWidth = 1;
        //jfgridTableContent.strokeStyle = jfgriddefaultstyle.strokeStyle;
        //jfgridTableContent.closePath();
        //jfgridTableContent.stroke();


        //横线
        jfgridTableContent.beginPath();
        jfgridTableContent.moveTo((offsetLeft-1)*devicePixelRatio,   (columeHeaderHeight-2 + 0.5)*devicePixelRatio);
        jfgridTableContent.lineTo((ch_width + offsetLeft - 2)*devicePixelRatio,   (columeHeaderHeight-2 + 0.5)*devicePixelRatio);
        jfgridTableContent.lineWidth = devicePixelRatio;
        jfgridTableContent.strokeStyle = jfgriddefaultstyle.strokeStyle;
        jfgridTableContent.closePath();
        jfgridTableContent.stroke();

        //jfgridTableContent.clearRect(0, 0, offsetLeft - 2, offsetTop - 2);


        //jfgridTableContent.clearRect(drawWidth > (ch_width + offsetLeft) ? (ch_width + offsetLeft - 2) : drawWidth - 2 + offsetLeft, offsetTop, drawWidth, drawHeight);
    }

    function jfgridDrawMain(scrollWidth, scrollHeight, drawWidth, drawHeight, offsetLeft, offsetTop, columnOffsetCell, rowOffsetCell, mycanvas, ctx, ctxdata) {
        if(ctxdata != null){
            jfgrid.flowdata = ctxdata;
        }

        if(jfgrid.flowdata == null){
            return;
        }

        if (scrollWidth == null) {
            scrollWidth = $("#jfgrid-cell-main").scrollLeft();
        }
        if (scrollHeight == null) {
            scrollHeight = $("#jfgrid-cell-main").scrollTop();
        }

        if (drawWidth == null) {
            drawWidth = jfgridTableContentHW[0];
        }
        if (drawHeight == null) {
            drawHeight = jfgridTableContentHW[1];
        }

        if (offsetLeft == null) {
            offsetLeft = rowHeaderWidth;
        }
        if (offsetTop == null) {
            offsetTop = columeHeaderHeight;
        }

        if (columnOffsetCell == null) {
            columnOffsetCell = 0;
        }
        if (rowOffsetCell == null) {
            rowOffsetCell = 0;
        }

        var jfgridTableContent = null;
        if(ctx != null){
            var jfgridTableElement = document.createElement('canvas');
            jfgridTableElement.width = drawWidth;
            jfgridTableElement.height = drawHeight;
            jfgridTableContent = jfgridTableElement.getContext("2d");
        }
        else{
            if(mycanvas == null){
                jfgridTableContent = $("#jfgridTableContent").get(0).getContext("2d");
            }
            else {
                if(jfgrid.getObjType(mycanvas) == "object"){
                    try{
                        jfgridTableContent = mycanvas.get(0).getContext("2d");
                    }
                    catch(err){
                        jfgridTableContent = mycanvas;
                    }
                }
                else{
                    jfgridTableContent = $("#" + mycanvas).get(0).getContext("2d");
                }
            }
        }
        
        jfgridTableContent.clearRect(0, 0, jfgridTableContentHW[0] * devicePixelRatio, jfgridTableContentHW[1] * devicePixelRatio);

        //离屏canvas
        var offlinecanvas = null;
        if(ctx != null){
            var offlineElement = document.createElement('canvas');
            offlineElement.width = drawWidth;
            offlineElement.height = drawHeight;
            offlinecanvas = offlineElement.getContext("2d");
        }
        else{
            offlinecanvas = $("#jfgridTableContentF").get(0).getContext("2d");
        }
        //offlinecanvas.clearRect(0, 0, jfgridTableContentHW[0], jfgridTableContentHW[1]);
        offlinecanvas.fillStyle="#ffffff";
        offlinecanvas.fillRect(0, 0, jfgridTableContentHW[0]*devicePixelRatio, jfgridTableContentHW[1]*devicePixelRatio);
        offlinecanvas.font = jfgriddefaultstyle.font;
        offlinecanvas.textBaseline = "top";
        offlinecanvas.fillStyle = jfgriddefaultstyle.fillStyle;

        //
        var dataset_row_st, dataset_row_ed, dataset_col_st, dataset_col_ed;

        dataset_row_st = jfgrid_searcharray(visibledatarow, scrollHeight);
        dataset_row_ed = jfgrid_searcharray(visibledatarow, scrollHeight + drawHeight);

        if (dataset_row_st == -1) {
            dataset_row_st = 0;
        }

        dataset_row_st += rowOffsetCell;

        if (dataset_row_ed == -1) {
            dataset_row_ed = visibledatarow.length - 1;
        }

        dataset_row_ed += rowOffsetCell;

        if (dataset_row_ed >= visibledatarow.length) {
            dataset_row_ed = visibledatarow.length - 1;
        }

        dataset_col_st = jfgrid_searcharray(visibledatacolumn, scrollWidth);
        dataset_col_ed = jfgrid_searcharray(visibledatacolumn, scrollWidth + drawWidth);
        
        if (dataset_col_st == -1) {
            dataset_col_st = 0;
        }

        dataset_col_st += columnOffsetCell;

        if (dataset_col_ed == -1) {
            dataset_col_ed = visibledatacolumn.length - 1;
        }

        dataset_col_ed += columnOffsetCell;

        if (dataset_col_ed >= visibledatacolumn.length) {
            dataset_col_ed = visibledatacolumn.length - 1;
        }


        var fill_row_st, fill_row_ed, fill_col_st, fill_col_ed;
        if(dataset_row_st == 0){
            fill_row_st = 0;
        }
        else{
            fill_row_st = visibledatarow[dataset_row_st-1];
        }

        fill_row_ed = visibledatarow[dataset_row_ed];

        if(dataset_col_st == 0){
            fill_col_st = 0;
        }
        else{
            fill_col_st = visibledatacolumn[dataset_col_st-1];
        }

        fill_col_ed = visibledatacolumn[dataset_col_ed];

        jfgridTableContent.fillStyle="#ffffff";
        jfgridTableContent.fillRect((offsetLeft - 1) * devicePixelRatio, (offsetTop - 1) * devicePixelRatio, (fill_col_ed - fill_col_st) * devicePixelRatio, (fill_row_ed - fill_row_st) * devicePixelRatio);
        jfgridTableContent.font = jfgriddefaultstyle.font;
        jfgridTableContent.textBaseline = "top";
        jfgridTableContent.fillStyle = jfgriddefaultstyle.fillStyle;

        var end_r, start_r, end_c, start_c, flow_index = 0, flow_cols_index = 0, rowfix = 0, colfix = 0, colLineState = true;

        var cellupdate = [];
        var mergeCache = {};

        var borderOffset = {};

        for (var r = dataset_row_st; r <= dataset_row_ed; r++) {
            if (r == 0) {
                start_r = -scrollHeight - 1;
            }
            else {
                start_r = visibledatarow[r - 1] - scrollHeight - 1;
            }

            end_r = visibledatarow[r] - scrollHeight;
            
            for (var c = dataset_col_st; c <= dataset_col_ed; c++) {
                if (c == 0) {
                    start_c = -scrollWidth;
                }
                else {
                    start_c = visibledatacolumn[c - 1] - scrollWidth;
                }

                end_c = visibledatacolumn[c] - scrollWidth;

                if(c == dataset_col_ed){
                    if (!jfgridcurrentisPivotTable && end_r <= drawHeight && start_r >= -1) {
                        //行
                        jfgridTableContent.beginPath();
                        jfgridTableContent.moveTo(devicePixelRatio*(offsetLeft - 1), devicePixelRatio*(end_r + offsetTop - 2 + 0.5));
                        jfgridTableContent.lineTo(devicePixelRatio*(end_c + offsetLeft-2), devicePixelRatio*(end_r + offsetTop - 2 + 0.5));
                        jfgridTableContent.lineWidth = devicePixelRatio;
                        jfgridTableContent.strokeStyle = jfgriddefaultstyle.strokeStyle;
                        jfgridTableContent.closePath();
                        jfgridTableContent.stroke();
                    }
                }

                if(r == dataset_row_st){
                    if (!jfgridcurrentisPivotTable && end_c <= drawWidth + 18 && start_c >= -1) {
                        //列
                        jfgridTableContent.beginPath();
                        jfgridTableContent.moveTo(devicePixelRatio*(end_c + offsetLeft - 2 + 0.5), devicePixelRatio*(offsetTop - 1));
                        jfgridTableContent.lineTo(devicePixelRatio*(end_c + offsetLeft - 2 + 0.5), devicePixelRatio*(fill_row_ed - fill_row_st + offsetTop-2));
                        jfgridTableContent.lineWidth = devicePixelRatio;
                        jfgridTableContent.strokeStyle = jfgriddefaultstyle.strokeStyle;
                        jfgridTableContent.closePath();
                        jfgridTableContent.stroke();
                    }
                }

                if (!!jfgridcurrentisPivotTable && jfgrid.pivotTable.drawPivotTable) {
                    if ((c == 0 || c == 5) && r <= 11) {
                        jfgridTableContent.beginPath();
                        jfgridTableContent.moveTo(devicePixelRatio*(end_c - 2 + 0.5 + offsetLeft), devicePixelRatio*(start_r + offsetTop));
                        jfgridTableContent.lineTo(devicePixelRatio*(end_c - 2 + 0.5 + offsetLeft), devicePixelRatio*(end_r - 2 + offsetTop));
                        jfgridTableContent.lineWidth = devicePixelRatio;
                        jfgridTableContent.strokeStyle = "#000000";
                        jfgridTableContent.closePath();
                        jfgridTableContent.stroke();
                    }

                    if ((r == 2 || r == 11) && c <= 5) {
                        jfgridTableContent.beginPath();
                        jfgridTableContent.moveTo(devicePixelRatio*(start_c - 1 + offsetLeft), devicePixelRatio*(end_r - 2 + 0.5 + offsetTop));
                        jfgridTableContent.lineTo(devicePixelRatio*(end_c + offsetLeft-2), devicePixelRatio*(end_r - 2 + 0.5 + offsetTop));
                        jfgridTableContent.lineWidth = devicePixelRatio;
                        jfgridTableContent.strokeStyle = "#000000";
                        jfgridTableContent.closePath();
                        jfgridTableContent.stroke();
                    }

                    if (r == 6 && c == 3) {
                        jfgridTableContent.fillText("数据透视表", devicePixelRatio*(start_c + 4 + offsetLeft), devicePixelRatio*(start_r + (end_r - start_r) / 2 - 1 + offsetTop));
                    }
                }
                else if (!!jfgridcurrentisPivotTable) {
                    if (c < jfgrid.pivotTable.pivotTableBoundary[1] && r < jfgrid.pivotTable.pivotTableBoundary[0]) {
                        jfgridTableContent.beginPath();
                        jfgridTableContent.moveTo(devicePixelRatio*(end_c - 2 + 0.5 + offsetLeft), devicePixelRatio*(start_r + offsetTop));
                        jfgridTableContent.lineTo(devicePixelRatio*(end_c - 2 + 0.5 + offsetLeft), devicePixelRatio*(end_r - 2 + offsetTop));
                        jfgridTableContent.lineWidth = devicePixelRatio;
                        jfgridTableContent.strokeStyle = "#000000";
                        jfgridTableContent.closePath();
                        jfgridTableContent.stroke();

                        jfgridTableContent.beginPath();
                        jfgridTableContent.moveTo(devicePixelRatio*(start_c - 1 + offsetLeft), devicePixelRatio*(end_r - 2 + 0.5 + offsetTop));
                        jfgridTableContent.lineTo(devicePixelRatio*(end_c + offsetLeft-2), devicePixelRatio*(end_r - 2 + 0.5 + offsetTop));
                        jfgridTableContent.lineWidth = devicePixelRatio;
                        jfgridTableContent.strokeStyle = "#000000";
                        jfgridTableContent.closePath();
                        jfgridTableContent.stroke();
                    }
                }

                if (config["rowhidden"] != null && config["rowhidden"][r] != null) {

                }
                else {
                    var firstcolumlen = defaultcollen;
                    if (config["columlen"] != null && config["columlen"][c] != null) {
                        firstcolumlen = config["columlen"][c];
                    }

                    if (jfgrid.flowdata[r] != null && jfgrid.flowdata[r][c] != null && start_r >= -1 && start_c >= -1 ) {
                        var value = jfgrid.flowdata[r][c];

                        if(jfgrid.getObjType(value) == "object" && ("mc" in value)){
                            borderOffset[r + "_" + c] = { "start_c": start_c, "start_r": start_r, "end_r": end_r, "end_c": end_c };

                            if("rs" in value["mc"]){
                                var key = "r"+ r + "c" + c;
                                mergeCache[key] = cellupdate.length;
                            }
                            else{
                                var key = "r"+ value["mc"].r + "c" + value["mc"].c;
                                var margeMain = cellupdate[mergeCache[key]];

                                if(margeMain == null){
                                    mergeCache[key] = cellupdate.length;
                                    cellupdate.push({"r": r, "c": c, "start_c": start_c, "start_r": start_r, "end_r": end_r, "end_c": end_c, "firstcolumlen": firstcolumlen, startlist: []});
                                }
                                else{
                                    if(margeMain.c == c){
                                        margeMain.end_r += (end_r - start_r - 1);
                                        margeMain.startlist.push(start_r);

                                        // borderOffset[margeMain.r + "_" + margeMain.c].end_r = margeMain.end_r;
                                    }
                                    
                                    if(margeMain.r == r){
                                        margeMain.end_c += (end_c - start_c);
                                        margeMain.firstcolumlen += firstcolumlen;

                                        // borderOffset[margeMain.r + "_" + margeMain.c].end_c = margeMain.end_c;
                                    }

                                    var margeMaindata = jfgrid.flowdata[margeMain.r][margeMain.c];
                                    if((margeMain.c + margeMaindata.mc.cs - 1) == c && (margeMain.r + margeMaindata.mc.rs - 1) == r){
                                        //margeMain.end_r -= 10;
                                        //margeMain.end_c -= 1;
                                    }
                                }

                                continue;
                            }
                        }

                        cellupdate.push({"r": r, "c": c, "start_c": start_c, "start_r": start_r, "end_r": end_r, "end_c": end_c, "firstcolumlen": firstcolumlen, startlist: []});
                        borderOffset[r + "_" + c] = { "start_c": start_c, "start_r": start_r, "end_r": end_r, "end_c": end_c };
                    }
                    else{
                        cellupdate.push({"r": r, "c": c, "start_c": start_c, "start_r": start_r, "end_r": end_r, "end_c": end_c, "firstcolumlen": firstcolumlen, startlist: []});
                        borderOffset[r + "_" + c] = { "start_c": start_c, "start_r": start_r, "end_r": end_r, "end_c": end_c };
                    }
                }
            }
        }

        //动态数组公式计算
        var dynamicArray_compute = jfgrid.dynamicArray_compute(jfgridfile[jfgrid.sheetmanage.getSheetIndex(jfgrid.currentSheetIndex)]["dynamicArray"]);

        //交替颜色计算
        var af_compute = jfgrid.alternateformat.getComputeMap();

        //条件格式计算
        var cf_compute = jfgrid.conditionformat.getComputeMap();

        //sparklines渲染
        var sparklinesRender = function(r, c, offsetX, offsetY, canvasid, ctx){
            if(jfgrid.flowdata[r] == null || jfgrid.flowdata[r][c] == null){
                return;
            }

            var sparklines = jfgrid.flowdata[r][c].spl;
            if(sparklines != null){
                if(typeof sparklines == "string"){
                    sparklines = eval('('+ sparklines +')');
                }

                if(jfgrid.getObjType(sparklines) == "object"){
                    var temp1 = sparklines;
                    var x = temp1.offsetX;
                    var y = temp1.offsetY;
                    x = x == null ? 0 : x;
                    y = y == null ? 0 : y;
                    jfgrid.sparkline.render(temp1.shapeseq, temp1.shapes, offsetX + x, offsetY + y, temp1.pixelWidth, temp1.pixelHeight, canvasid, ctx);
                }
                else if(jfgrid.getObjType(sparklines) == "array" && jfgrid.getObjType(sparklines[0]) == "object"){
                    for(var i = 0; i < sparklines.length; i++){
                        var temp1 = sparklines[i];
                        var x = temp1.offsetX;
                        var y = temp1.offsetY;
                        x = x == null ? 0 : x;
                        y = y == null ? 0 : y;
                        jfgrid.sparkline.render(temp1.shapeseq, temp1.shapes, offsetX + x, offsetY + y, temp1.pixelWidth, temp1.pixelHeight, canvasid, ctx);
                    }
                }
            }
        }

        //空白单元格渲染 
        var nullCellRender = function(r, c, start_r, start_c, end_r, end_c){
            var checksAF = jfgrid.alternateformat.checksAF(r, c, af_compute); //交替颜色
            var checksCF = jfgrid.conditionformat.checksCF(r, c, cf_compute); //条件格式

            var borderfix = jfgrid.menuButton.borderfix(jfgrid.flowdata, r, c);

            //背景色
            jfgridTableContent.fillStyle = jfgrid.menuButton.checkstatus(jfgrid.flowdata, r, c , "bg");

            if(checksAF != null && checksAF[1] != null){//交替颜色 
                jfgridTableContent.fillStyle = checksAF[1];
            }

            if(checksCF != null && checksCF["cellColor"] != null){//条件格式 
                jfgridTableContent.fillStyle = checksCF["cellColor"];
            }

            if(jfgrid.flowdata[r][c] != null && jfgrid.flowdata[r][c].tc != null){//标题色
                jfgridTableContent.fillStyle = jfgrid.flowdata[r][c].tc;
            }

            var cellsize = [
                devicePixelRatio * (start_c + offsetLeft + borderfix[0]), 
                devicePixelRatio * (start_r + offsetTop + 1 + borderfix[1]), 
                devicePixelRatio * (end_c - start_c - 3 + borderfix[2]), 
                devicePixelRatio * (end_r - start_r - 3 - 0.5 + borderfix[3])
            ];
            jfgridTableContent.fillRect(cellsize[0], cellsize[1], cellsize[2], cellsize[3]);

            if((r + "_" + c) in dynamicArray_compute){
                var value = dynamicArray_compute[r + "_" + c].v;

                jfgridTableContent.fillStyle = "#000000";
                //文本宽度和高度
                var fontset = jfgriddefaultstyle.font;
                jfgridTableContent.font = fontset;

                var textMetrics = jfgridTableContent.measureText(value).width;
                var oneLineTextHeight = jfgrid.menuButton.getTextSize("田", fontset)[1];

                //水平对齐 (默认为1，左对齐)
                var horizonAlignPos = (start_c + 4 + offsetLeft) * devicePixelRatio;

                //垂直对齐 (默认为2，下对齐)
                var verticalFixed = jfgrid.browser.jfgridrefreshfixed();
                var verticalAlignPos = (end_r  + offsetTop - 2 + verticalFixed) * devicePixelRatio - oneLineTextHeight; 
                
                jfgridTableContent.fillText(value == null ? "" : value, horizonAlignPos, verticalAlignPos);
            }

            //若单元格有批注
            if(jfgrid.flowdata[r][c] != null && jfgrid.flowdata[r][c].ps != null){
                jfgridTableContent.beginPath();
                jfgridTableContent.moveTo(devicePixelRatio * (end_c + offsetLeft - 6), devicePixelRatio * (start_r + offsetTop));
                jfgridTableContent.lineTo(devicePixelRatio * (end_c + offsetLeft - 1), devicePixelRatio * (start_r + offsetTop));
                jfgridTableContent.lineTo(devicePixelRatio * (end_c + offsetLeft - 1), devicePixelRatio * (start_r + offsetTop + 5));
                jfgridTableContent.fillStyle = "#FC6666";
                jfgridTableContent.fill();
                jfgridTableContent.closePath();
            }

            //右边框
            jfgridTableContent.beginPath();
            jfgridTableContent.moveTo(devicePixelRatio * (end_c - 2 + 0.5 + offsetLeft), devicePixelRatio * (start_r + offsetTop));
            jfgridTableContent.lineTo(devicePixelRatio * (end_c - 2 + 0.5 + offsetLeft), devicePixelRatio * (end_r - 2 + offsetTop));
            jfgridTableContent.lineWidth = devicePixelRatio;

            if (!!jfgridcurrentisPivotTable && !jfgrid.pivotTable.drawPivotTable) {
                jfgridTableContent.strokeStyle = "#000000";
            }
            else{
                jfgridTableContent.strokeStyle = jfgriddefaultstyle.strokeStyle;
            }
            
            jfgridTableContent.stroke();
            jfgridTableContent.closePath();

            //下边框
            jfgridTableContent.beginPath();
            jfgridTableContent.moveTo(devicePixelRatio * (start_c - 2 + offsetLeft), devicePixelRatio * (end_r - 2 + 0.5 + offsetTop));
            jfgridTableContent.lineTo(devicePixelRatio * (end_c + offsetLeft - 2), devicePixelRatio * (end_r - 2 + 0.5 + offsetTop));
            jfgridTableContent.lineWidth = devicePixelRatio;

            if (!!jfgridcurrentisPivotTable && !jfgrid.pivotTable.drawPivotTable) {
                jfgridTableContent.strokeStyle = "#000000";
            }
            else{
                jfgridTableContent.strokeStyle = jfgriddefaultstyle.strokeStyle;
            }
            
            jfgridTableContent.stroke();
            jfgridTableContent.closePath();
        }

        //非空白单元格渲染
        var cellRender = function(r, c, start_r, start_c, end_r, end_c, value, canvasType){
            var checksAF = jfgrid.alternateformat.checksAF(r, c, af_compute); //交替颜色
            var checksCF = jfgrid.conditionformat.checksCF(r, c, cf_compute); //条件格式

            var borderfix = jfgrid.menuButton.borderfix(jfgrid.flowdata, r, c);

            //文本宽度和高度
            var fontset = jfgridfontformat(jfgrid.flowdata[r][c]);
            jfgridTableContent.font = fontset;

            var textMetrics = jfgridTableContent.measureText(value).width;
            var oneLineTextHeight = jfgrid.menuButton.getTextSize("田", fontset)[1];

            if(jfgrid.flowdata[r][c].tb == "2"){
                var strValue = value.toString();
                var cellWidth = end_c - start_c - 8;
                var strArr = [];
                
                for(var strI = 1; strI <= strValue.length; strI++){
                    var strV = strValue.substring(strArr.join("").length, strI);
                    var strtextMetrics = jfgridTableContent.measureText(strV).width;
                    
                    if(strtextMetrics > cellWidth){
                        strArr.push(strValue.substring(strArr.join("").length, strI - 1));
                        strI = strI - 2;
                    }
                    else if(strtextMetrics <= cellWidth && strI == strValue.length){
                        strArr.push(strV);
                    }
                }

                var textH = strArr.length * oneLineTextHeight;
            }
            else if(jfgrid.flowdata[r][c].tr != null && jfgrid.flowdata[r][c].tr != "0"){
                var tr = jfgrid.flowdata[r][c].tr;
                    
                if(tr == "1" || tr == "2"){
                    var textW = 0.707 * (textMetrics + oneLineTextHeight);
                    var textH = 0.707 * (textMetrics + oneLineTextHeight);
                }
                else if(tr == "3"){
                    value = value.toString();
                    
                    if(value.length > 1){
                        var vArr = value.split("");    
                    }
                    else{
                        var vArr = [];
                        vArr.push(value);
                    }
                    
                    var textW = jfgridTableContent.measureText(vArr[0]).width;
                    var textH = vArr.length * oneLineTextHeight;
                }
                else if(tr == "4" || tr == "5"){
                    var textW = oneLineTextHeight;
                    var textH = textMetrics;
                }
            }
            else{
                var textW = textMetrics;
                var textH = oneLineTextHeight;
            }

            //水平对齐
            var horizonAlign = jfgrid.menuButton.checkstatus(jfgrid.flowdata, r, c , "ht"); 
            var horizonAlignPos = (start_c + 4 + offsetLeft) * devicePixelRatio; //horizonAlign默认为1，左对齐
            if(horizonAlign == "0"){ //居中对齐
                horizonAlignPos = (start_c + (end_c - start_c) / 2 + offsetLeft) * devicePixelRatio - (textMetrics) / 2;
            }
            else if(horizonAlign == "2"){ //右对齐
                horizonAlignPos = (end_c + offsetLeft - 8) * devicePixelRatio - (textMetrics);
            }

            //垂直对齐
            var verticalAlign = jfgrid.menuButton.checkstatus(jfgrid.flowdata, r, c , "vt"); 
            var verticalFixed = jfgrid.browser.jfgridrefreshfixed();
            var verticalAlignPos = (end_r  + offsetTop - 2 + verticalFixed) * devicePixelRatio - oneLineTextHeight; //verticalAlign默认为2，下对齐
            if(verticalAlign == "0"){ //居中对齐
                verticalAlignPos = (start_r + (end_r - start_r) / 2  + offsetTop + verticalFixed) * devicePixelRatio - oneLineTextHeight / 2;
            }
            else if(verticalAlign == "1"){ //上对齐
                verticalAlignPos = (start_r + offsetTop + verticalFixed) * devicePixelRatio;
            }

            //水平对齐方式是 居中或居右对齐 且单元格宽度小于文字宽度 （用离屏canvas渲染） 
            if(jfgrid.browser.BrowserType() != "Safari" && (canvasType == "offline" || ((horizonAlign == "0" || horizonAlign == "2") && (end_c - start_c) < textW) || ((verticalAlign == "0" || verticalAlign == "2") && (end_r - start_r) < textH))){
            // if(canvasType == "offline" || ((horizonAlign == "0" || horizonAlign == "2") && (end_c - start_c) < textW) || ((verticalAlign == "0" || verticalAlign == "2") && (end_r - start_r) < textH) || (jfgrid.flowdata[r][c].tr != null && jfgrid.flowdata[r][c].tr != "0")){
                var canvasName = offlinecanvas;

                canvasName.font = fontset;

                var cellsize = [
                    devicePixelRatio * (start_c + offsetLeft + borderfix[0]), 
                    devicePixelRatio * (start_r + offsetTop + 0.5 + borderfix[1]), 
                    devicePixelRatio * (end_c - start_c - 3 + borderfix[2]), 
                    devicePixelRatio * (end_r - start_r - 3 - 0.5 + borderfix[3])
                ];
            }
            else{
                var canvasName = jfgridTableContent;

                var cellsize = [
                    devicePixelRatio * (start_c + offsetLeft + borderfix[0]), 
                    devicePixelRatio * (start_r + offsetTop + 1 + borderfix[1]), 
                    devicePixelRatio * (end_c - start_c - 3 + borderfix[2]), 
                    devicePixelRatio * (end_r - start_r - 3 - 0.5 + borderfix[3])
                ];
            }
                
            //单元格 背景颜色
            canvasName.fillStyle= jfgrid.menuButton.checkstatus(jfgrid.flowdata, r, c , "bg");
            
            //若单元格有交替颜色 背景颜色
            if(checksAF != null && checksAF[1] != null){ 
                canvasName.fillStyle = checksAF[1];
            }

            //若单元格有条件格式 背景颜色
            if(checksCF != null && checksCF["cellColor"] != null){ 
                canvasName.fillStyle = checksCF["cellColor"];
            }

            //若单元格有标题色
            if(jfgrid.flowdata[r][c] != null && jfgrid.flowdata[r][c].tc != null){
                jfgridTableContent.fillStyle = jfgrid.flowdata[r][c].tc;
            }
            
            canvasName.fillRect(cellsize[0], cellsize[1], cellsize[2], cellsize[3]);

            //若单元格有批注
            if(jfgrid.flowdata[r][c].ps != null){
                canvasName.beginPath();
                canvasName.moveTo(devicePixelRatio * (end_c + offsetLeft - 6), devicePixelRatio * (start_r + offsetTop));
                canvasName.lineTo(devicePixelRatio * (end_c + offsetLeft - 1), devicePixelRatio * (start_r + offsetTop));
                canvasName.lineTo(devicePixelRatio * (end_c + offsetLeft - 1), devicePixelRatio * (start_r + offsetTop + 5));
                canvasName.fillStyle = "#FC6666";
                canvasName.fill();
                canvasName.closePath();
            }

            //若单元格有条件格式数据条
            if(checksCF != null && checksCF["dataBar"] != null){
                var x = devicePixelRatio * (start_c + offsetLeft + borderfix[0] + 2);
                var y = devicePixelRatio * (start_r + offsetTop + 0.5 + borderfix[1] + 2);
                var w = devicePixelRatio * (end_c - start_c - 3 + borderfix[2] - 4);
                var h = devicePixelRatio * (end_r - start_r - 3 - 0.5 + borderfix[3] - 4);

                var valueType = checksCF["dataBar"]["valueType"];
                var valueLen = checksCF["dataBar"]["valueLen"];
                var format = checksCF["dataBar"]["format"];

                if(format.length > 1){ //渐变
                    if(valueType == "minus"){
                        //负数
                        var minusLen = checksCF["dataBar"]["minusLen"];

                        var my_gradient = canvasName.createLinearGradient(x + w * minusLen * (1 - valueLen), y, x + w * minusLen, y);
                        my_gradient.addColorStop(0, "#ffffff");
                        my_gradient.addColorStop(1, "#ff0000");
                        canvasName.fillStyle = my_gradient;
                        canvasName.fillRect(x + w * minusLen * (1 - valueLen), y, w * minusLen * valueLen, h);

                        canvasName.beginPath();
                        canvasName.moveTo(x + w * minusLen * (1 - valueLen), y);
                        canvasName.lineTo(x + w * minusLen * (1 - valueLen), y + h);
                        canvasName.lineTo(x + w * minusLen, y + h);
                        canvasName.lineTo(x + w * minusLen, y);
                        canvasName.lineTo(x + w * minusLen * (1 - valueLen), y);
                        canvasName.lineWidth = devicePixelRatio;
                        canvasName.strokeStyle = "#ff0000";
                        canvasName.stroke();
                        canvasName.closePath();
                    }
                    else if(valueType == "plus"){
                        //正数
                        var plusLen = checksCF["dataBar"]["plusLen"];

                        if(plusLen == 1){
                            var my_gradient = canvasName.createLinearGradient(x, y, x + w * valueLen, y);
                            my_gradient.addColorStop(0, format[0]);
                            my_gradient.addColorStop(1, format[1]);
                            canvasName.fillStyle = my_gradient;
                            canvasName.fillRect(x, y, w * valueLen, h);

                            canvasName.beginPath();
                            canvasName.moveTo(x, y);
                            canvasName.lineTo(x, y + h);
                            canvasName.lineTo(x + w * valueLen, y + h);
                            canvasName.lineTo(x + w * valueLen, y);
                            canvasName.lineTo(x, y);
                            canvasName.lineWidth = devicePixelRatio;
                            canvasName.strokeStyle = format[0];
                            canvasName.stroke();
                            canvasName.closePath();
                        }
                        else{
                            var minusLen = checksCF["dataBar"]["minusLen"];

                            var my_gradient = canvasName.createLinearGradient(x + w * minusLen, y, x + w * minusLen + w * plusLen * valueLen, y);
                            my_gradient.addColorStop(0, format[0]);
                            my_gradient.addColorStop(1, format[1]);
                            canvasName.fillStyle = my_gradient;
                            canvasName.fillRect(x + w * minusLen, y, w * plusLen * valueLen, h);

                            canvasName.beginPath();
                            canvasName.moveTo(x + w * minusLen, y);
                            canvasName.lineTo(x + w * minusLen, y + h);
                            canvasName.lineTo(x + w * minusLen + w * plusLen * valueLen, y + h);
                            canvasName.lineTo(x + w * minusLen + w * plusLen * valueLen, y);
                            canvasName.lineTo(x + w * minusLen, y);
                            canvasName.lineWidth = devicePixelRatio;
                            canvasName.strokeStyle = format[0];
                            canvasName.stroke();
                            canvasName.closePath();
                        }
                    }
                }
                else{ //单色
                    if(valueType == "minus"){
                        //负数
                        var minusLen = checksCF["dataBar"]["minusLen"];
                        
                        canvasName.fillStyle = "#ff0000";
                        canvasName.fillRect(x + w * minusLen * (1 - valueLen), y, w * minusLen * valueLen, h);

                        canvasName.beginPath();
                        canvasName.moveTo(x + w * minusLen * (1 - valueLen), y);
                        canvasName.lineTo(x + w * minusLen * (1 - valueLen), y + h);
                        canvasName.lineTo(x + w * minusLen, y + h);
                        canvasName.lineTo(x + w * minusLen, y);
                        canvasName.lineTo(x + w * minusLen * (1 - valueLen), y);
                        canvasName.lineWidth = devicePixelRatio;
                        canvasName.strokeStyle = "#ff0000";
                        canvasName.stroke();
                        canvasName.closePath();
                    }
                    else if(valueType == "plus"){
                        //正数
                        var plusLen = checksCF["dataBar"]["plusLen"];

                        if(plusLen == 1){
                            canvasName.fillStyle = format[0];
                            canvasName.fillRect(x, y, w * valueLen, h);

                            canvasName.beginPath();
                            canvasName.moveTo(x, y);
                            canvasName.lineTo(x, y + h);
                            canvasName.lineTo(x + w * valueLen, y + h);
                            canvasName.lineTo(x + w * valueLen, y);
                            canvasName.lineTo(x, y);
                            canvasName.lineWidth = devicePixelRatio;
                            canvasName.strokeStyle = format[0];
                            canvasName.stroke();
                            canvasName.closePath();
                        }
                        else{
                            var minusLen = checksCF["dataBar"]["minusLen"];

                            canvasName.fillStyle = format[0];
                            canvasName.fillRect(x + w * minusLen, y, w * plusLen * valueLen, h);

                            canvasName.beginPath();
                            canvasName.moveTo(x + w * minusLen, y);
                            canvasName.lineTo(x + w * minusLen, y + h);
                            canvasName.lineTo(x + w * minusLen + w * plusLen * valueLen, y + h);
                            canvasName.lineTo(x + w * minusLen + w * plusLen * valueLen, y);
                            canvasName.lineTo(x + w * minusLen, y);
                            canvasName.lineWidth = devicePixelRatio;
                            canvasName.strokeStyle = format[0];
                            canvasName.stroke();
                            canvasName.closePath();
                        }
                    }
                }
            }

            //若单元格有条件格式图标集
            if(checksCF != null && checksCF["icons"] != null){
                var l = checksCF["icons"]["left"];
                var t = checksCF["icons"]["top"];
                
                canvasName.drawImage(jfgrid_CFiconsImg, l * 42, t * 32, 32, 32, cellsize[0], verticalAlignPos + 2, oneLineTextHeight - 2, oneLineTextHeight - 2);
                
                if(horizonAlign != "0" && horizonAlign != "2"){ //左对齐时 文本渲染空出一个图标的距离
                    horizonAlignPos = horizonAlignPos + oneLineTextHeight - 2;
                }
            }

            //单元格 文本颜色
            canvasName.fillStyle = jfgrid.menuButton.checkstatus(jfgrid.flowdata, r, c , "fc");
            
            //若单元格有交替颜色 文本颜色
            if(checksAF != null && checksAF[0] != null){ 
                canvasName.fillStyle = checksAF[0];
            }
            
            //若单元格有条件格式 文本颜色
            if(checksCF != null && checksCF["textColor"] != null){ 
                canvasName.fillStyle = checksCF["textColor"];
            }

            //单元格有下钻属性，文本颜色变成超链接的颜色
            if(jfgrid.flowdata[r][c].dd != null){
                canvasName.fillStyle = "#0000ff";

                canvasName.fillText(value == null ? "" : value, horizonAlignPos, verticalAlignPos);

                canvasName.beginPath();
                canvasName.strokeStyle = "#0000ff";
                canvasName.moveTo(horizonAlignPos, verticalAlignPos + oneLineTextHeight);
                canvasName.lineTo(horizonAlignPos + textMetrics, verticalAlignPos + oneLineTextHeight);
                canvasName.closePath();
                canvasName.stroke();
            }
            else{
                //自动换行、旋转、删除线功能
                if(jfgrid.flowdata[r][c].tb == "2"){
                    var strValue = value.toString();
                    var cellWidth = end_c - start_c - 8;
                    var strArr = [];
                    
                    for(var strI = 1; strI <= strValue.length; strI++){
                        var strV = strValue.substring(strArr.join("").length, strI);
                        var strtextMetrics = canvasName.measureText(strV).width;
                        
                        if(strtextMetrics > cellWidth){
                            strArr.push(strValue.substring(strArr.join("").length, strI - 1));
                            strI = strI - 2;
                        }
                        else if(strtextMetrics <= cellWidth && strI == strValue.length){
                            strArr.push(strV);
                        }
                    }
                    
                    for(var iFill = 0; iFill < strArr.length; iFill++){
                        //水平对齐计算
                        var strWidth = canvasName.measureText(strArr[iFill]).width;
                        if(horizonAlign == "0"){
                            horizonAlignPos = (start_c + (end_c - start_c) / 2 + offsetLeft) * devicePixelRatio - (strWidth)/2;
                        }
                        else if(horizonAlign == "2"){
                            horizonAlignPos = (end_c + offsetLeft - 8) * devicePixelRatio - (strWidth);
                        }
                        
                        //垂直对齐计算
                        if(verticalAlign == "0"){
                            verticalAlignPos = (start_r + (end_r - start_r) / 2  + offsetTop + verticalFixed) * devicePixelRatio - oneLineTextHeight * strArr.length / 2;
                        }
                        else if(verticalAlign == "1"){
                            verticalAlignPos = (start_r + offsetTop + verticalFixed) * devicePixelRatio;
                        }
                        else{
                            verticalAlignPos = (end_r  + offsetTop - 2 + verticalFixed) * devicePixelRatio - oneLineTextHeight * strArr.length;
                        }
                        
                        canvasName.fillText(strArr[iFill], horizonAlignPos, (verticalAlignPos + iFill * oneLineTextHeight));
                    }
                }
                else if(jfgrid.flowdata[r][c].tr != null && jfgrid.flowdata[r][c].tr != "0"){
                    //单元格旋转属性
                    var tr = jfgrid.flowdata[r][c].tr;
                    
                    if(tr == "1" || tr == "2"){
                        //旋转重新计算水平、垂直方向坐标
                        var textW = 0.707 * (textMetrics + oneLineTextHeight);
                        var textH = 0.707 * (textMetrics + oneLineTextHeight);

                        var hAP = (start_c + 4 + offsetLeft) * devicePixelRatio;
                        if(horizonAlign == "0"){
                            hAP = (start_c + (end_c - start_c) / 2 + offsetLeft) * devicePixelRatio - (textW) / 2;
                        }
                        else if(horizonAlign == "2"){
                            hAP = (end_c + offsetLeft - 8) * devicePixelRatio - (textW);
                        }

                        var vAP = (end_r  + offsetTop - 2 + verticalFixed) * devicePixelRatio - textH;
                        if(verticalAlign == "0"){
                            vAP = (start_r + (end_r - start_r) / 2  + offsetTop + verticalFixed) * devicePixelRatio - textH / 2;
                        }
                        else if(verticalAlign == "1"){
                            vAP = (start_r + offsetTop + verticalFixed) * devicePixelRatio;
                        }
                        
                        //向下倾斜（45 旋转）
                        if(tr == "1"){
                            canvasName.save();
                            canvasName.translate(hAP, vAP);
                            canvasName.rotate(45 * Math.PI / 180);
                            canvasName.translate(-hAP, -vAP);
                            canvasName.fillText(value == null ? "" : value, hAP + (0.707 * 0.707 * oneLineTextHeight), vAP - (0.707 * 0.707 * oneLineTextHeight));
                            canvasName.restore();

                            //是否有删除线
                            var cl = jfgrid.menuButton.checkstatus(jfgrid.flowdata, r, c , "cl");
                            if(cl == "1" && !jfgrid.func_methods.isRealNull(value)){
                                canvasName.beginPath();
                                canvasName.strokeStyle = "#000";
                                canvasName.moveTo(hAP + oneLineTextHeight / 2, vAP + oneLineTextHeight / 2);
                                canvasName.lineTo(hAP + textW - oneLineTextHeight / 2, vAP + textH - oneLineTextHeight / 2);
                                canvasName.closePath();
                                canvasName.stroke();
                            }
                        }
                        
                        //向上倾斜（-45 旋转）
                        if(tr == "2"){
                            canvasName.save();
                            canvasName.translate(hAP, vAP + textH);
                            canvasName.rotate(-45 * Math.PI / 180);
                            canvasName.translate(-hAP, -(vAP + textH));
                            canvasName.fillText(value == null ? "" : value, hAP + (0.707 * 0.707 * oneLineTextHeight), vAP + textH - (0.707 * 0.707 * oneLineTextHeight));
                            canvasName.restore();
                            
                            //是否有删除线
                            var cl = jfgrid.menuButton.checkstatus(jfgrid.flowdata, r, c , "cl");
                            if(cl == "1" && !jfgrid.func_methods.isRealNull(value)){
                                canvasName.beginPath();
                                canvasName.strokeStyle = "#000";
                                canvasName.moveTo(hAP + oneLineTextHeight / 2, vAP + textH - oneLineTextHeight / 2);
                                canvasName.lineTo(hAP + textW - oneLineTextHeight / 2, vAP + oneLineTextHeight / 2);
                                canvasName.closePath();
                                canvasName.stroke();
                            }
                        }
                    }
                    else if(tr == "3"){
                        if(!jfgrid.func_methods.isRealNull(value)){
                            value = value.toString();
                            
                            if(value.length > 1){
                                var vArr = value.split("");    
                            }
                            else{
                                var vArr = [];
                                vArr.push(value);
                            }
                            
                            var textW = canvasName.measureText(vArr[0]).width;
                            var textH = vArr.length * oneLineTextHeight;
                            
                            for(var i = 0; i < vArr.length; i++){
                                var vWidth = canvasName.measureText(vArr[i]).width;
                                
                                //水平对齐计算
                                if(horizonAlign == "0"){
                                    horizonAlignPos = (start_c + (end_c - start_c) / 2 + offsetLeft) * devicePixelRatio - (vWidth)/2;
                                }
                                else if(horizonAlign == "2"){
                                    horizonAlignPos = (end_c + offsetLeft - 8) * devicePixelRatio - (vWidth);
                                }
                                else{
                                    horizonAlignPos = (start_c + 4 + offsetLeft) * devicePixelRatio;
                                }
                                
                                //垂直对齐计算
                                if(verticalAlign == "0"){
                                    verticalAlignPos = (start_r + (end_r - start_r) / 2  + offsetTop + verticalFixed) * devicePixelRatio - oneLineTextHeight * vArr.length/2;
                                }
                                else if(verticalAlign == "1"){
                                    verticalAlignPos = (start_r + offsetTop + verticalFixed) * devicePixelRatio;
                                }
                                else{
                                    verticalAlignPos = (end_r  + offsetTop - 2 + verticalFixed) * devicePixelRatio - oneLineTextHeight * vArr.length;
                                }
                                
                                canvasName.fillText(vArr[i], horizonAlignPos, (verticalAlignPos + i * oneLineTextHeight));
                            }
                            
                            //是否有删除线
                            var cl = jfgrid.menuButton.checkstatus(jfgrid.flowdata, r, c , "cl");
                            if(cl == "1" && !jfgrid.func_methods.isRealNull(value)){
                                canvasName.beginPath();
                                canvasName.strokeStyle = "#000";
                                canvasName.moveTo(horizonAlignPos + textW / 2, verticalAlignPos);
                                canvasName.lineTo(horizonAlignPos + textW / 2, verticalAlignPos + textH);
                                canvasName.closePath();
                                canvasName.stroke();
                            }
                        }
                    }
                    else if(tr == "4" || tr == "5"){
                        //旋转重新计算水平、垂直方向坐标
                        var textW = oneLineTextHeight;
                        var textH = textMetrics;

                        var hAP = (start_c + 4 + offsetLeft) * devicePixelRatio;
                        if(horizonAlign == "0"){
                            hAP = (start_c + (end_c - start_c) / 2 + offsetLeft) * devicePixelRatio - (textW) / 2;
                        }
                        else if(horizonAlign == "2"){
                            hAP = (end_c + offsetLeft - 8) * devicePixelRatio - (textW);
                        }

                        var vAP = (end_r  + offsetTop - 2 + verticalFixed) * devicePixelRatio - textH;
                        if(verticalAlign == "0"){
                            vAP = (start_r + (end_r - start_r) / 2  + offsetTop + verticalFixed) * devicePixelRatio - textH / 2;
                        }
                        else if(verticalAlign == "1"){
                            vAP = (start_r + offsetTop + verticalFixed) * devicePixelRatio;
                        }
                        
                        //向下90（90 旋转）
                        if(tr == "4"){
                            canvasName.save();
                            canvasName.translate(hAP, vAP);
                            canvasName.rotate(90 * Math.PI / 180);
                            canvasName.translate(-hAP, -vAP);
                            canvasName.fillText(value == null ? "" : value, hAP, vAP - textW);
                            canvasName.restore();

                            //是否有删除线
                            var cl = jfgrid.menuButton.checkstatus(jfgrid.flowdata, r, c , "cl");
                            if(cl == "1" && !jfgrid.func_methods.isRealNull(value)){
                                canvasName.beginPath();
                                canvasName.strokeStyle = "#000";
                                canvasName.moveTo(hAP + textW / 2, vAP);
                                canvasName.lineTo(hAP + textW / 2, vAP + textH);
                                canvasName.closePath();
                                canvasName.stroke();
                            }
                        }
                        
                        //向上90（-90 旋转）
                        if(tr == "5"){
                            canvasName.save();
                            canvasName.translate(hAP + textH, vAP);
                            canvasName.rotate(-90 * Math.PI / 180);
                            canvasName.translate(-(hAP + textH), -vAP);
                            canvasName.fillText(value == null ? "" : value, hAP, vAP - textH);
                            canvasName.restore();

                            //是否有删除线
                            var cl = jfgrid.menuButton.checkstatus(jfgrid.flowdata, r, c , "cl");
                            if(cl == "1" && !jfgrid.func_methods.isRealNull(value)){
                                canvasName.beginPath();
                                canvasName.strokeStyle = "#000";
                                canvasName.moveTo(hAP + textW / 2, vAP);
                                canvasName.lineTo(hAP + textW / 2, vAP + textH);
                                canvasName.closePath();
                                canvasName.stroke();
                            }
                        }
                    }
                }
                else{
                    canvasName.fillText(value == null ? "" : value, horizonAlignPos, verticalAlignPos);
                    
                    //是否有删除线
                    var cl = jfgrid.menuButton.checkstatus(jfgrid.flowdata, r, c , "cl");
                    if(cl == "1" && !jfgrid.func_methods.isRealNull(value)){
                        canvasName.beginPath();
                        canvasName.strokeStyle = "#000";
                        canvasName.moveTo(horizonAlignPos, verticalAlignPos + oneLineTextHeight / 2);
                        canvasName.lineTo(horizonAlignPos + textMetrics, verticalAlignPos + oneLineTextHeight / 2);
                        canvasName.closePath();
                        canvasName.stroke();
                    }
                }
            }

            //水平对齐方式是 居中或居右对齐 且单元格宽度小于文字宽度 （用离屏canvas渲染）
            if(jfgrid.browser.BrowserType() != "Safari" && (canvasType == "offline" || ((horizonAlign == "0" || horizonAlign == "2") && (end_c - start_c) < textW) || ((verticalAlign == "0" || verticalAlign == "2") && (end_r - start_r) < textH))){
                canvasName.font = jfgriddefaultstyle.font;
                
                if($("#jfgridTableContentF").length > 0){
                    jfgridTableContent.drawImage($("#jfgridTableContentF").get(0), cellsize[0], cellsize[1], cellsize[2], cellsize[3], cellsize[0], cellsize[1], cellsize[2], cellsize[3]);
                }
                else{
                    jfgridTableContent.drawImage(offlineElement, cellsize[0], cellsize[1], cellsize[2], cellsize[3], cellsize[0], cellsize[1], cellsize[2], cellsize[3]);
                }
            }

            jfgridTableContent.font = jfgriddefaultstyle.font;

            //右边框
            jfgridTableContent.beginPath();
            jfgridTableContent.moveTo(devicePixelRatio * (end_c - 2 + 0.5 + offsetLeft), devicePixelRatio * (start_r + offsetTop));
            jfgridTableContent.lineTo(devicePixelRatio * (end_c - 2 + 0.5 + offsetLeft), devicePixelRatio * (end_r - 2 + offsetTop));
            jfgridTableContent.lineWidth = devicePixelRatio;

            if (!!jfgridcurrentisPivotTable && !jfgrid.pivotTable.drawPivotTable) {
                jfgridTableContent.strokeStyle = "#000000";
            }
            else{
                jfgridTableContent.strokeStyle = jfgriddefaultstyle.strokeStyle;
            }
            
            jfgridTableContent.stroke();
            jfgridTableContent.closePath();

            //下边框
            jfgridTableContent.beginPath();
            jfgridTableContent.moveTo(devicePixelRatio * (start_c - 2 + offsetLeft), devicePixelRatio * (end_r - 2 + 0.5 + offsetTop));
            jfgridTableContent.lineTo(devicePixelRatio * (end_c + offsetLeft - 2), devicePixelRatio * (end_r - 2 + 0.5 + offsetTop));
            jfgridTableContent.lineWidth = devicePixelRatio;

            if (!!jfgridcurrentisPivotTable && !jfgrid.pivotTable.drawPivotTable) {
                jfgridTableContent.strokeStyle = "#000000";
            }
            else{
                jfgridTableContent.strokeStyle = jfgriddefaultstyle.strokeStyle;
            }
            
            jfgridTableContent.stroke();
            jfgridTableContent.closePath();
        }

        var mcArr = [];

        for(var cud = 0; cud < cellupdate.length; cud++){
            var item = cellupdate[cud];
            var r = item.r, 
                c = item.c, 
                start_r = item.start_r, 
                start_c = item.start_c, 
                end_r = item.end_r, 
                end_c = item.end_c;
            var firstcolumlen = item.firstcolumlen;

            if(jfgrid.flowdata[r] == null){
                continue;
            }
            
            if(jfgrid.flowdata[r][c] == null){ //空单元格
                nullCellRender(r, c, start_r, start_c, end_r, end_c);
            }
            else{
                var cell = jfgrid.flowdata[r][c];
                var value = null, er = r, ec = c, end_ec = end_c;

                if((typeof cell == "object") && "mc" in cell){
                    mcArr.push(cellupdate[cud]);

                    var margeMaindata = cell["mc"];
                    value = jfgrid.getcellvalue(margeMaindata.r, margeMaindata.c, null, "m");
                    
                    if(value == null){
                        value = jfgrid.getcellvalue(margeMaindata.r, margeMaindata.c);
                    }

                    r = margeMaindata.r;
                    c = margeMaindata.c;

                    er += margeMaindata.rs;
                    ec += margeMaindata.rc;

                    if (c == 0) {
                        start_c = -scrollWidth;
                    }
                    else {
                        start_c = visibledatacolumn[c - 1] - scrollWidth;
                    }

                    if (r == 0) {
                        start_r = -scrollHeight - 1;
                    }
                    else {
                        start_r = visibledatarow[r - 1] - scrollHeight - 1;
                    }

                    end_ec = visibledatacolumn[ec] - scrollWidth;
                }
                else{
                    value = jfgrid.getcellvalue(r, c, null, "m");
                    if(value == null){
                        value = jfgrid.getcellvalue(r, c);
                    }
                }  

                if(value == null || value.toString().length == 0){
                    nullCellRender(r, c, start_r, start_c, end_r, end_c);
                    
                    //sparklines渲染
                    var borderfix = jfgrid.menuButton.borderfix(jfgrid.flowdata, r, c);
                    var cellsize = [
                        devicePixelRatio * (start_c + offsetLeft + borderfix[0]), 
                        devicePixelRatio * (start_r + offsetTop + 0.5 + borderfix[1]), 
                        devicePixelRatio * (end_c - start_c - 3 + borderfix[2]), 
                        devicePixelRatio * (end_r - start_r - 3 - 0.5 + borderfix[3])
                    ];
                    sparklinesRender(r, c, cellsize[0], cellsize[1], "jfgridTableContent", jfgridTableContent);
                }
                else{
                    if((r + "_" + c) in dynamicArray_compute){//动态数组公式
                        value = dynamicArray_compute[r + "_" + c].v;
                    }

                    cellRender(r, c, start_r, start_c, end_r, end_c, value);
                }
            }
        }

        //合并单元格再处理
        for(var m = 0; m < mcArr.length; m++){
            var item = mcArr[m];
            var r = item.r, 
                c = item.c, 
                start_r = item.start_r, 
                start_c = item.start_c, 
                end_r = item.end_r, 
                end_c = item.end_c;
            var firstcolumlen = item.firstcolumlen;

            var cell = jfgrid.flowdata[r][c];
            var value = null, er = r, ec = c, end_ec = end_c;

            var margeMaindata = cell["mc"];
            value = jfgrid.getcellvalue(margeMaindata.r, margeMaindata.c, null, "m");
            
            if(value == null){
                value = jfgrid.getcellvalue(margeMaindata.r, margeMaindata.c);
            }

            r = margeMaindata.r;
            c = margeMaindata.c;

            er += margeMaindata.rs;
            ec += margeMaindata.rc;

            if (c == 0) {
                start_c = -scrollWidth;
            }
            else {
                start_c = visibledatacolumn[c - 1] - scrollWidth;
            }

            if (r == 0) {
                start_r = -scrollHeight - 1;
            }
            else {
                start_r = visibledatarow[r - 1] - scrollHeight - 1;
            }

            end_ec = visibledatacolumn[ec] - scrollWidth;

            if(value == null || value.toString().length == 0){
                nullCellRender(r, c, start_r, start_c, end_r, end_c);
                
                //sparklines渲染
                var borderfix = jfgrid.menuButton.borderfix(jfgrid.flowdata, r, c);
                var cellsize = [
                    devicePixelRatio * (start_c + offsetLeft + borderfix[0]), 
                    devicePixelRatio * (start_r + offsetTop + 0.5 + borderfix[1]), 
                    devicePixelRatio * (end_c - start_c - 3 + borderfix[2]), 
                    devicePixelRatio * (end_r - start_r - 3 - 0.5 + borderfix[3])
                ];
                sparklinesRender(r, c, cellsize[0], cellsize[1], "jfgridTableContent", jfgridTableContent);
            }
            else{
                if((r + "_" + c) in dynamicArray_compute){//动态数组公式
                    value = dynamicArray_compute[r + "_" + c].v;
                }

                cellRender(r, c, start_r, start_c, end_r, end_c, value, "offline");
            }
        }

        //边框单独渲染
        if(config["borderInfo"] != null && config["borderInfo"].length > 0){
            //边框渲染
            var borderLeftRender = function(style, color, start_r, start_c, end_r, end_c, offsetLeft, offsetTop, canvas){
                var linetype = style;

                var m_st = devicePixelRatio * (start_c - 2 + 0.5 + offsetLeft);
                var m_ed = devicePixelRatio * (start_r + offsetTop);
                var line_st = devicePixelRatio * (start_c - 2 + 0.5 + offsetLeft);
                var line_ed = devicePixelRatio * (end_r - 2 + offsetTop);

                jfgrid.menuButton.setLineDash(canvas, linetype, "v", m_st, m_ed, line_st, line_ed);

                canvas.strokeStyle = color;
                
                canvas.stroke();
                canvas.closePath();
            }

            var borderRightRender = function(style, color, start_r, start_c, end_r, end_c, offsetLeft, offsetTop, canvas){
                var linetype = style;

                var m_st = devicePixelRatio * (end_c - 2 + 0.5 + offsetLeft);
                var m_ed = devicePixelRatio * (start_r + offsetTop);
                var line_st = devicePixelRatio * (end_c - 2 + 0.5 + offsetLeft);
                var line_ed = devicePixelRatio * (end_r - 2 + offsetTop);

                jfgrid.menuButton.setLineDash(canvas, linetype, "v", m_st, m_ed, line_st, line_ed);

                canvas.strokeStyle = color;
                
                canvas.stroke();
                canvas.closePath();
            }

            var borderBottomRender = function(style, color, start_r, start_c, end_r, end_c, offsetLeft, offsetTop, canvas){
                var linetype = style;

                var m_st = devicePixelRatio * (start_c - 2 + offsetLeft);
                var m_ed = devicePixelRatio * (end_r - 2 + 0.5 + offsetTop);
                var line_st = devicePixelRatio * (end_c + offsetLeft - 2);
                var line_ed = devicePixelRatio * (end_r - 2 + 0.5 + offsetTop);

                jfgrid.menuButton.setLineDash(canvas, linetype, "h", m_st, m_ed, line_st, line_ed);

                canvas.strokeStyle = color;
                
                canvas.stroke();
                canvas.closePath();
            }

            var borderTopRender = function(style, color, start_r, start_c, end_r, end_c, offsetLeft, offsetTop, canvas){
                var linetype = style;

                var m_st = devicePixelRatio * (start_c - 2 + offsetLeft);
                var m_ed = devicePixelRatio * (start_r - 1 + 0.5 + offsetTop);
                var line_st = devicePixelRatio * (end_c + offsetLeft - 2);
                var line_ed = devicePixelRatio * (start_r - 1 + 0.5 + offsetTop);

                jfgrid.menuButton.setLineDash(canvas, linetype, "h", m_st, m_ed, line_st, line_ed);

                canvas.strokeStyle = color;
                
                canvas.stroke();
                canvas.closePath();
            }

            var borderInfoCompute = jfgrid.getBorderInfoCompute();
            
            for(x in borderInfoCompute){
                var bd_r = x.split("_")[0], bd_c = x.split("_")[1];

                if(borderOffset[bd_r + "_" + bd_c]){
                    var start_r = borderOffset[bd_r + "_" + bd_c].start_r;
                    var start_c = borderOffset[bd_r + "_" + bd_c].start_c;
                    var end_r = borderOffset[bd_r + "_" + bd_c].end_r;
                    var end_c = borderOffset[bd_r + "_" + bd_c].end_c;

                    var borderLeft = borderInfoCompute[x].l;
                    if(borderLeft != null){
                        borderLeftRender(borderLeft.style, borderLeft.color, start_r, start_c, end_r, end_c, offsetLeft, offsetTop, jfgridTableContent);
                    }

                    var borderRight = borderInfoCompute[x].r;
                    if(borderRight != null){
                        borderRightRender(borderRight.style, borderRight.color, start_r, start_c, end_r, end_c, offsetLeft, offsetTop, jfgridTableContent);
                    }

                    var borderTop = borderInfoCompute[x].t;
                    if(borderTop != null){
                        borderTopRender(borderTop.style, borderTop.color, start_r, start_c, end_r, end_c, offsetLeft, offsetTop, jfgridTableContent);
                    }

                    var borderBottom = borderInfoCompute[x].b;
                    if(borderBottom != null){
                        borderBottomRender(borderBottom.style, borderBottom.color, start_r, start_c, end_r, end_c, offsetLeft, offsetTop, jfgridTableContent);
                    }
                }
            }
        }

        //渲染表格时有尾列时，清除右边灰色区域，防止表格有值溢出
        if(dataset_col_ed == visibledatacolumn.length - 1){
            jfgridTableContent.clearRect((fill_col_ed - fill_col_st + offsetLeft - 1) * devicePixelRatio, (offsetTop - 1) * devicePixelRatio, 200, (fill_row_ed - fill_row_st));
        }

        if(ctx != null){
            ctx.drawImage(jfgridTableElement, 0, 0, drawWidth, drawHeight, -drawWidth/2 + offsetLeft, -drawHeight/2 + offsetTop, drawWidth, drawHeight);
        }
    }
    jfgrid.jfgridDrawMain = jfgridDrawMain;

    //备份jfgridDrawMain
    function jfgridDrawMain_back(scrollWidth, scrollHeight, drawWidth, drawHeight, offsetLeft, offsetTop, columnOffsetCell, rowOffsetCell, mycanvas) {
        if (scrollWidth == null) {
            scrollWidth = $("#jfgrid-cell-main").scrollLeft();
        }
        if (scrollHeight == null) {
            scrollHeight = $("#jfgrid-cell-main").scrollTop();
        }

        if (drawWidth == null) {
            drawWidth = jfgridTableContentHW[0];
        }
        if (drawHeight == null) {
            drawHeight = jfgridTableContentHW[1];
        }

        if (offsetLeft == null) {
            offsetLeft = rowHeaderWidth;
        }
        if (offsetTop == null) {
            offsetTop = columeHeaderHeight;
        }

        if (columnOffsetCell == null) {
            columnOffsetCell = 0;
        }
        if (rowOffsetCell == null) {
            rowOffsetCell = 0;
        }

        var jfgridTableContent = null;
        if(mycanvas==null){
            jfgridTableContent = $("#jfgridTableContent").get(0).getContext("2d");
        }
        else {
            if(jfgrid.getObjType(mycanvas) == "object"){
                try{
                    jfgridTableContent = mycanvas.get(0).getContext("2d");
                }
                catch(err){
                    jfgridTableContent = mycanvas;
                }
            }
            else{
                jfgridTableContent = $("#" + mycanvas).get(0).getContext("2d");
            }
        }

        //jfgridTableContentHW = [$("#jfgrid-grid-window-1").width() - 13, $("#jfgrid-grid-window-1").height() - 13];
        //var jfgridTableContent = $("#"+ mycanvas).get(0).getContext("2d");
        
        jfgridTableContent.clearRect(offsetLeft*devicePixelRatio, offsetTop*devicePixelRatio, drawWidth*devicePixelRatio, drawHeight*devicePixelRatio);

        //离屏canvas
        var offlinecanvas = $("#jfgridTableContentF").get(0).getContext("2d");
        //offlinecanvas.clearRect(0, 0, jfgridTableContentHW[0], jfgridTableContentHW[1]);
        offlinecanvas.fillStyle="#ffffff";
        offlinecanvas.fillRect(0, 0, jfgridTableContentHW[0] * devicePixelRatio, jfgridTableContentHW[1] * devicePixelRatio);


        offlinecanvas.font = jfgriddefaultstyle.font;
        offlinecanvas.textBaseline = "top";
        offlinecanvas.fillStyle = jfgriddefaultstyle.fillStyle;

        var dataset_row_st, dataset_row_ed, dataset_col_st, dataset_col_ed;

        dataset_row_st = jfgrid_searcharray(visibledatarow, scrollHeight);
        dataset_row_ed = jfgrid_searcharray(visibledatarow, scrollHeight + drawHeight);

        if (dataset_row_st == -1) {
            dataset_row_st = 0;
        }

        dataset_row_st += rowOffsetCell;

        if (dataset_row_ed == -1) {
            dataset_row_ed = visibledatarow.length - 1;
        }

        dataset_row_ed += rowOffsetCell;

        if (dataset_row_ed >= visibledatarow.length) {
            dataset_row_ed = visibledatarow.length - 1;
        }

        dataset_col_st = jfgrid_searcharray(visibledatacolumn, scrollWidth);
        dataset_col_ed = jfgrid_searcharray(visibledatacolumn, scrollWidth + drawWidth);
        
        if (dataset_col_st == -1) {
            dataset_col_st = 0;
        }

        dataset_col_st += columnOffsetCell;

        if (dataset_col_ed == -1) {
            dataset_col_ed = visibledatacolumn.length - 1;
        }

        dataset_col_ed += columnOffsetCell;

        if (dataset_col_ed >= visibledatacolumn.length) {
            dataset_col_ed = visibledatacolumn.length - 1;
        }


        var fill_row_st, fill_row_ed, fill_col_st, fill_col_ed;
        if(dataset_row_st==0){
            fill_row_st = 0;
        }
        else{
            fill_row_st = visibledatarow[dataset_row_st-1];
        }

        fill_row_ed = visibledatarow[dataset_row_ed];

        if(dataset_col_st==0){
            fill_col_st = 0;
        }
        else{
            fill_col_st = visibledatacolumn[dataset_col_st-1];
        }

        fill_col_ed = visibledatacolumn[dataset_col_ed];

        jfgridTableContent.fillStyle="#ffffff";
        jfgridTableContent.fillRect((offsetLeft - 1) * devicePixelRatio, (offsetTop - 1) * devicePixelRatio, (fill_col_ed - fill_col_st) * devicePixelRatio, (fill_row_ed - fill_row_st) * devicePixelRatio);

        var end_r, start_r, end_c, start_c, flow_index = 0, flow_cols_index = 0, rowfix = 0, colfix = 0, colLineState = true;

        // $("#jfgrid-cell-main").scrollLeft(visibledatarow[dataset_row_st]);
        // $("#jfgrid-cell-main").scrollTop(visibledatacolumn[dataset_col_st]);
        var cellupdate = [];
        var mergeCache = {};
        for (var r = dataset_row_st; r <= dataset_row_ed; r++) {

            if (r == 0) {
                start_r = -scrollHeight - 1;
            }
            else {
                start_r = visibledatarow[r - 1] - scrollHeight - 1;
            }
            end_r = visibledatarow[r] - scrollHeight;


            //行
            //jfgridTableContent.beginPath();
            //jfgridTableContent.moveTo(0, end_r + columeHeaderHeight);
            //jfgridTableContent.lineTo(rowHeaderWidth, end_r + columeHeaderHeight);
            //jfgridTableContent.lineWidth = 1;
            //jfgridTableContent.strokeStyle = jfgriddefaultstyle.strokeStyle;
            //jfgridTableContent.closePath();
            //jfgridTableContent.stroke();


            
            for (var c = dataset_col_st; c <= dataset_col_ed; c++) {

                if (c == 0) {
                    start_c = -scrollWidth;
                }
                else {
                    start_c = visibledatacolumn[c - 1] - scrollWidth;
                }
                end_c = visibledatacolumn[c] - scrollWidth;

                if(c==dataset_col_ed){
                    if (!jfgridcurrentisPivotTable && end_r <= drawHeight && start_r >= -1) {
                        //行
                        jfgridTableContent.beginPath();
                        jfgridTableContent.moveTo(devicePixelRatio*(offsetLeft - 1), devicePixelRatio*(end_r + offsetTop - 2 + 0.5));
                        jfgridTableContent.lineTo(devicePixelRatio*(end_c + offsetLeft-2), devicePixelRatio*(end_r + offsetTop - 2 + 0.5));
                        jfgridTableContent.lineWidth = devicePixelRatio;
                        jfgridTableContent.strokeStyle = jfgriddefaultstyle.strokeStyle;
                        jfgridTableContent.closePath();
                        jfgridTableContent.stroke();

                        //jfgridTableContent.beginPath();
                        //jfgridTableContent.moveTo(end_c - 2 + offsetLeft, 0.5 + offsetTop);
                        //jfgridTableContent.lineTo(end_c - 2 + offsetLeft, rh_height + offsetTop);
                        //jfgridTableContent.lineWidth = 1;
                        //jfgridTableContent.strokeStyle = jfgriddefaultstyle.strokeStyle;
                        //jfgridTableContent.closePath();
                        //jfgridTableContent.stroke();
                    }
                }

                if (r == dataset_row_st) {
                    //var abc = jfgrid.jfgridchatatABC(c);
                    //var textMetrics = jfgridTableContent.measureText(abc);
                    //jfgridTableContent.fillText(abc, Math.round(start_c + offsetLeft + (end_c - start_c - textMetrics.width) / 2), Math.round(offsetTop / 2 - 2));

                    //jfgridTableContent.clearRect(start_c + offsetLeft - 1, offsetTop-1, end_c - start_c - 1, 1);

                    // jfgridTableContent.clearRect(start_c + offsetLeft - 1, offsetTop+drawHeight, end_c - start_c - 1, 1);

                    if (!jfgridcurrentisPivotTable && end_c <= drawWidth + 18 && start_c >= -1) {
                        //列
                        jfgridTableContent.beginPath();
                        jfgridTableContent.moveTo(devicePixelRatio*(end_c + offsetLeft - 2 + 0.5), devicePixelRatio*(offsetTop - 1));
                        jfgridTableContent.lineTo(devicePixelRatio*(end_c + offsetLeft - 2 + 0.5), devicePixelRatio*(fill_row_ed - fill_row_st + offsetTop-2));
                        jfgridTableContent.lineWidth = devicePixelRatio;
                        jfgridTableContent.strokeStyle = jfgriddefaultstyle.strokeStyle;
                        jfgridTableContent.closePath();
                        jfgridTableContent.stroke();

                        //jfgridTableContent.beginPath();
                        //jfgridTableContent.moveTo(0.5 + offsetLeft, end_r + offsetTop);
                        //jfgridTableContent.lineTo(ch_width + offsetLeft, end_r + offsetTop);
                        //jfgridTableContent.lineWidth = devicePixelRatio;
                        //jfgridTableContent.strokeStyle = jfgriddefaultstyle.strokeStyle;
                        //jfgridTableContent.closePath();
                        //jfgridTableContent.stroke();
                    }
                }

                if (!!jfgridcurrentisPivotTable && jfgrid.pivotTable.drawPivotTable) {
                    if ((c == 0 || c == 5) && r <= 11) {
                        jfgridTableContent.beginPath();
                        jfgridTableContent.moveTo(devicePixelRatio*(end_c - 2 + 0.5 + offsetLeft), devicePixelRatio*(start_r + offsetTop));
                        jfgridTableContent.lineTo(devicePixelRatio*(end_c - 2 + 0.5 + offsetLeft), devicePixelRatio*(end_r - 2 + offsetTop));
                        jfgridTableContent.lineWidth = devicePixelRatio;
                        jfgridTableContent.strokeStyle = "#000000";
                        jfgridTableContent.closePath();
                        jfgridTableContent.stroke();
                        //jfgridTableContent.clearRect(end_c - 2 + offsetLeft, offsetTop, 2, offsetTop);
                    }

                    if ((r == 2 || r == 11) && c <= 5) {
                        jfgridTableContent.beginPath();
                        jfgridTableContent.moveTo(devicePixelRatio*(start_c - 1 + offsetLeft), devicePixelRatio*(end_r - 2 + 0.5 + offsetTop));
                        jfgridTableContent.lineTo(devicePixelRatio*(end_c + offsetLeft-2), devicePixelRatio*(end_r - 2 + 0.5 + offsetTop));
                        jfgridTableContent.lineWidth = devicePixelRatio;
                        jfgridTableContent.strokeStyle = "#000000";
                        jfgridTableContent.closePath();
                        jfgridTableContent.stroke();
                    }

                    if (r == 6 && c == 3) {
                        jfgridTableContent.fillText("数据透视表", devicePixelRatio*(start_c + 4 + offsetLeft), devicePixelRatio*(start_r + (end_r - start_r) / 2 - 1 + offsetTop));
                    }
                }
                else if (!!jfgridcurrentisPivotTable) {
                    if (c < jfgrid.pivotTable.pivotTableBoundary[1] && r < jfgrid.pivotTable.pivotTableBoundary[0]) {
                        jfgridTableContent.beginPath();
                        jfgridTableContent.moveTo(devicePixelRatio*(end_c - 2 + 0.5 + offsetLeft), devicePixelRatio*(start_r + offsetTop));
                        jfgridTableContent.lineTo(devicePixelRatio*(end_c - 2 + 0.5 + offsetLeft), devicePixelRatio*(end_r - 2 + offsetTop));
                        jfgridTableContent.lineWidth = devicePixelRatio;
                        jfgridTableContent.strokeStyle = "#000000";
                        jfgridTableContent.closePath();
                        jfgridTableContent.stroke();
                        //jfgridTableContent.clearRect(end_c + offsetLeft - 2, 0, 2, offsetTop);


                        jfgridTableContent.beginPath();
                        jfgridTableContent.moveTo(devicePixelRatio*(start_c - 1 + offsetLeft), devicePixelRatio*(end_r - 2 + 0.5 + offsetTop));
                        jfgridTableContent.lineTo(devicePixelRatio*(end_c + offsetLeft-2), devicePixelRatio*(end_r - 2 + 0.5 + offsetTop));
                        jfgridTableContent.lineWidth = devicePixelRatio;
                        jfgridTableContent.strokeStyle = "#000000";
                        jfgridTableContent.closePath();
                        jfgridTableContent.stroke();
                    }
                }

                if (config["rowhidden"] != null && config["rowhidden"][r] != null) {

                }
                else {
                    //&& start_r >= -2 && start_c >= -2
                    //&& end_r <= drawHeight && end_c <= drawWidth + 18
                    if (jfgrid.flowdata[r] != null && jfgrid.flowdata[r][c] != null && start_r >= -1 && start_c >= -1 ) {

                        var value = jfgrid.flowdata[r][c];

                        var firstcolumlen = defaultcollen;
                        if (config["columlen"] != null && config["columlen"][c] != null) {
                            firstcolumlen = config["columlen"][c];
                        }

                        if(jfgrid.getObjType(value) == "object" && ("mc" in value)){
                            
                            //console.log(value);
                            if("rs" in value["mc"]){
                                var key = "r"+ r + "c" + c;
                                mergeCache[key] = cellupdate.length;
                            }
                            else{
                                var key = "r"+ value["mc"].r + "c" + value["mc"].c;
                                var margeMain = cellupdate[mergeCache[key]];

                                if(margeMain==null){
                                    mergeCache[key] = cellupdate.length;
                                    cellupdate.push({"r":r, "c":c,"start_c":start_c, "start_r":start_r, "end_r":end_r, "end_c":end_c, "firstcolumlen":firstcolumlen, startlist:[]});
                                }
                                else{
                                    if(margeMain.c==c){
                                        margeMain.end_r += (end_r-start_r-1);
                                        margeMain.startlist.push(start_r);
                                    }
                                    
                                    if(margeMain.r==r){
                                        margeMain.end_c += (end_c-start_c);
                                        margeMain.firstcolumlen += firstcolumlen;
                                    }
                                    

                                    var margeMaindata = jfgrid.flowdata[margeMain.r][margeMain.c];
                                    if((margeMain.c + margeMaindata.mc.cs-1)==c && (margeMain.r + margeMaindata.mc.rs-1)==r){
                                        //margeMain.end_r -= 10;
                                        //margeMain.end_c -= 1;
                                    }
                                }

                                continue;
                                
                            }
                        }
                        cellupdate.push({"r":r, "c":c,"start_c":start_c, "start_r":start_r, "end_r":end_r, "end_c":end_c, "firstcolumlen":firstcolumlen, startlist:[]});
                    }
                    
                    //jfgridTableContent.fillText("111", start_c + 4 + offsetLeft, start_r + (end_r - start_r) / 2 - 1 + offsetTop);
                    
                }

                


                //if (r == dataset_row_ed) {
                //    jfgridTableContent.beginPath();
                //    jfgridTableContent.moveTo(end_c + rowHeaderWidth, -0.5);
                //    jfgridTableContent.lineTo(end_c + rowHeaderWidth, columeHeaderHeight+rh_height);
                //    jfgridTableContent.lineWidth = 1;
                //    jfgridTableContent.strokeStyle = jfgriddefaultstyle.strokeStyle;
                //    jfgridTableContent.closePath();
                //    jfgridTableContent.stroke();
                //    console.log("end_c, rh_height", dataset_col_st, dataset_col_ed, dataset_row_st, dataset_row_ed, r_set, c_set, rowfix, $("#jfgridsheettable_" + jfgrid.currentSheetIndex + "_" + r_set + "_" + c_set + ""), end_c, h, r,c);
                //}

            }

            if (config["rowhidden"] != null && config["rowhidden"][r] != null) {

            }
            else {
                //jfgridTableContent.clearRect(offsetLeft-1, start_r - 1 + offsetTop, 1, end_r - start_r - 1);

                //jfgridTableContent.clearRect(start_c + offsetLeft - 1, offsetTop+drawHeight - 1, end_c - start_c - 1, 1);

                //var textMetrics = jfgridTableContent.measureText(r + 1);
                //jfgridTableContent.fillText(r + 1, (offsetLeft - textMetrics.width) / 2, start_r + (end_r - start_r) / 2 - 2 + offsetTop);
            }
            

        }



        //console.log(cellupdate)
        for(var cud=0;cud<cellupdate.length;cud++){
            //console.log(i)
            var item = cellupdate[cud];
            var r= item.r, c = item.c, start_c = item.start_c, start_r = item.start_r, end_c = item.end_c, end_r = item.end_r;
            var firstcolumlen = item.firstcolumlen;

            //offlinecanvas.fillStyle="#ffffff";
            //offlinecanvas.fillRect(0, 0, jfgridTableContentHW[0], jfgridTableContentHW[1]);

            //var textMetrics = jfgridTableContent.measureText(jfgrid.flowdata[r][c]);
            var cell = jfgrid.flowdata[r][c];
            var value = null, er = r, ec = c, end_ec = end_c;
            if((typeof cell == "object") && "mc" in cell){
                var margeMaindata = cell["mc"];
                value = jfgrid.getcellvalue(margeMaindata.r, margeMaindata.c, null,"m");
                if(value==null){
                    value = jfgrid.getcellvalue(margeMaindata.r, margeMaindata.c);
                }

                r = margeMaindata.r;
                c = margeMaindata.c;

                er += margeMaindata.rs;
                ec += margeMaindata.rc;

                if (c == 0) {
                    start_c = -scrollWidth;
                }
                else {
                    start_c = visibledatacolumn[c - 1] - scrollWidth;
                }

                if (r == 0) {
                    start_r = -scrollHeight - 1;
                }
                else {
                    start_r = visibledatarow[r - 1] - scrollHeight - 1;
                }

                end_ec = visibledatacolumn[ec] - scrollWidth;


            }
            else{
                value = jfgrid.getcellvalue(r, c, null,"m");
                if(value==null){
                    value = jfgrid.getcellvalue(r, c);
                }
            }
            

            var borderfix = jfgrid.menuButton.borderfix(jfgrid.flowdata, r, c);
            //console.log(borderfix);
            //jfgridTableContent.clearRect(start_c - 1 + offsetLeft, start_r + offsetTop, end_c - start_c - 1, end_r - start_r-3);
            //console.log(borderfix);
            offlinecanvas.fillStyle= jfgrid.menuButton.checkstatus(jfgrid.flowdata, r, c , "bg");

            var cellsize = [devicePixelRatio*(start_c + offsetLeft+borderfix[0]), devicePixelRatio*(start_r + offsetTop + 0.5 +borderfix[1]), devicePixelRatio*(end_c - start_c -3+borderfix[2]), devicePixelRatio*(end_r - start_r-3 - 0.5 +borderfix[3])];
            offlinecanvas.fillRect(cellsize[0], cellsize[1], cellsize[2], cellsize[3]);


            

            // var fontsize = 13;
            // if((cell instanceof Object) && "fs" in cell){
            //     fontsize = cell.fs;
            // }

            
            // if (config["columlen"] != null && config["columlen"][c] != null) {
            //     firstcolumlen = config["columlen"][c];
            // }


            //var vformat = jfgrid.getcellformat(r, c);

            offlinecanvas.fillStyle= jfgrid.menuButton.checkstatus(jfgrid.flowdata, r, c , "fc");


            //console.log(fontsize);
            var fontset = jfgridfontformat(jfgrid.flowdata[r][c]);
            offlinecanvas.font = fontset;

            var textMetrics = offlinecanvas.measureText(value).width;
            //var oneLineTextHeight = offlinecanvas.measureText("田").width;
            var oneLineTextHeight = jfgrid.menuButton.getTextSize("田", fontset)[1];
            //console.log(oneLineTextHeight,fontset);

            //console.log(textMetrics, firstcolumlen, r, c ,value);


            offlinecanvas.fillStyle= jfgrid.menuButton.checkstatus(jfgrid.flowdata, r, c , "fc");

            var horizonAlign = jfgrid.menuButton.checkstatus(jfgrid.flowdata, r, c , "ht");
            var horizonAlignPos = (start_c + 4 + offsetLeft)*devicePixelRatio;
            if(horizonAlign=="0"){

                // if (textMetrics > firstcolumlen) {
                //     var v = "", value_array = value.toString().split("");
                //     var mid = Math.floor(value_array.length/2), posState = true, i=1, pos = mid;
                //     while (pos>=0 && pos<value_array.length) {
                //         if(posState){
                //             v = value_array[pos] + v;
                //         }
                //         else{
                //             v += value_array[pos];
                //         }
                        
                //         var measureW = offlinecanvas.measureText(v).width;
                //         //console.log(v,measureW , firstcolumlen);
                //         if (measureW > firstcolumlen) {
                //             break;
                //         }

                //         if(posState){
                //             pos = mid + i;
                //         }
                //         else{
                //             pos = mid - i++;
                //         }
                //         posState = !posState;
                //     }
                //     value = v;
                // }

                //textMetrics = offlinecanvas.measureText(value).width;

                horizonAlignPos = (start_c + (end_c - start_c) / 2 + offsetLeft)*devicePixelRatio - (textMetrics)/2;
                // if(horizonAlignPos<start_c + 2 + offsetLeft){
                //     horizonAlignPos = start_c + 2 + offsetLeft;
                // }
            }
            else if(horizonAlign=="2"){
                // if (textMetrics+fontsize > firstcolumlen) {
                //     var v = "", value_array = value.toString().split("");
                //     for (var i = value_array.length-1; i >=0; i--) {
                //         v = value_array[i] + v;
                //         var measureW = offlinecanvas.measureText(v).width;
                //         //console.log(v,measureW , firstcolumlen);
                //         if (measureW+fontsize > firstcolumlen) {
                //             break;
                //         }
                //     }
                //     value = v;
                // }

                //textMetrics = offlinecanvas.measureText(value).width;

                horizonAlignPos = (end_c + offsetLeft - 8)*devicePixelRatio - (textMetrics);
                // if(horizonAlignPos<start_c + 2 + offsetLeft){
                //     horizonAlignPos = start_c + 2 + offsetLeft;
                // }
            }
            else{
                // if (textMetrics > firstcolumlen) {
                //     var v = "", value_array = value.toString().split("");
                //     for (var i = 0; i < value_array.length; i++) {
                //         v += value_array[i];
                //         var measureW = offlinecanvas.measureText(v).width;
                //         //console.log(v,measureW , firstcolumlen);
                //         if (measureW > firstcolumlen) {
                //             break;
                //         }
                //     }
                //     value = v;
                // }
            }


            var verticalAlign = jfgrid.menuButton.checkstatus(jfgrid.flowdata, r, c , "vt");
            var verticalFixed = jfgrid.browser.jfgridrefreshfixed();
            var verticalAlignPos = (end_r  + offsetTop - 2 + verticalFixed)*devicePixelRatio - oneLineTextHeight;
            if(verticalAlign=="0"){
                verticalAlignPos = (start_r + (end_r - start_r) / 2  + offsetTop + verticalFixed)*devicePixelRatio - oneLineTextHeight/2;
                // if(verticalAlignPos<start_r+offsetTop+8){
                //     verticalAlignPos = end_r - oneLineTextHeight + offsetTop + 1;
                // }
            }
            else if(verticalAlign=="1"){
                verticalAlignPos = (start_r + offsetTop + verticalFixed)*devicePixelRatio;
            }

            //自动换行、旋转、删除线功能
            if(jfgrid.flowdata[r][c].tb == "2" && textMetrics > (end_c - start_c)){
                var strValue = value.toString();
                var cellWidth = end_c-start_c-8;
                var strArr = [];
                for(var strI = 1; strI <= strValue.length; strI++){
                    var strV = strValue.substring(strArr.join("").length,strI);
                    var strtextMetrics = offlinecanvas.measureText(strV).width;
                    if(strtextMetrics > cellWidth){
                        strArr.push(strValue.substring(strArr.join("").length,strI - 1));
                        strI = strI - 2;
                    }else if(strtextMetrics <= cellWidth && strI == strValue.length){
                        strArr.push(strV);
                    }
                }
                for(var iFill = 0; iFill < strArr.length; iFill++){
                    //水平对齐计算
                    var strWidth = offlinecanvas.measureText(strArr[iFill]).width;
                    if(horizonAlign == "0"){
                        horizonAlignPos = (start_c + (end_c - start_c) / 2 + offsetLeft)*devicePixelRatio - (strWidth)/2;
                    }else if(horizonAlign == "2"){
                        horizonAlignPos = (end_c + offsetLeft - 8)*devicePixelRatio - (strWidth);
                    }else{
                        horizonAlignPos = (start_c + 4 + offsetLeft)*devicePixelRatio;
                    }
                    //垂直对齐计算
                    if(verticalAlign == "0"){
                        verticalAlignPos = (start_r + (end_r - start_r) / 2  + offsetTop + verticalFixed)*devicePixelRatio - oneLineTextHeight*strArr.length/2;
                    }else if(verticalAlign == "1"){
                        verticalAlignPos = (start_r + offsetTop + verticalFixed)*devicePixelRatio;
                    }else{
                        verticalAlignPos = (end_r  + offsetTop - 2 + verticalFixed)*devicePixelRatio - oneLineTextHeight*strArr.length;
                    }
                    offlinecanvas.fillText(strArr[iFill], horizonAlignPos, (verticalAlignPos+iFill*oneLineTextHeight));
                }
            }
            else if(!!jfgrid.flowdata[r][c].tr && jfgrid.flowdata[r][c].tr != "0"){
                //单元格旋转属性
                var tr = jfgrid.flowdata[r][c].tr;
                if(tr == "1" || tr == "2"){
                    //旋转重新计算水平、垂直方向坐标
                    var textW = 0.707 * (textMetrics + oneLineTextHeight);
                    var textH = 0.707 * (textMetrics + oneLineTextHeight);

                    var hAP = (start_c + 4 + offsetLeft)*devicePixelRatio;
                    if(horizonAlign=="0"){
                        hAP = (start_c + (end_c - start_c) / 2 + offsetLeft)*devicePixelRatio - (textW)/2;
                    }
                    else if(horizonAlign=="2"){
                        hAP = (end_c + offsetLeft - 8)*devicePixelRatio - (textW);
                    }

                    var vAP = (end_r  + offsetTop - 2 + verticalFixed)*devicePixelRatio - textH;
                    if(verticalAlign=="0"){
                        vAP = (start_r + (end_r - start_r) / 2  + offsetTop + verticalFixed)*devicePixelRatio - textH/2;
                    }
                    else if(verticalAlign=="1"){
                        vAP = (start_r + offsetTop + verticalFixed)*devicePixelRatio;
                    }
                    //向下倾斜（45 旋转）
                    if(tr == "1"){
                        offlinecanvas.save();
                        offlinecanvas.translate(hAP, vAP);
                        offlinecanvas.rotate(45*Math.PI/180);
                        offlinecanvas.translate(-hAP, -vAP);
                        offlinecanvas.fillText(value==null?"":value, hAP + (0.707*0.707*oneLineTextHeight), vAP - (0.707*0.707*oneLineTextHeight));
                        offlinecanvas.restore();

                        //是否有删除线
                        var cl = jfgrid.menuButton.checkstatus(jfgrid.flowdata, r, c , "cl");
                        if(cl == "1" && !!value){
                            offlinecanvas.beginPath();
                            offlinecanvas.moveTo(hAP + oneLineTextHeight/2, vAP + oneLineTextHeight/2);
                            offlinecanvas.lineTo(hAP + textW - oneLineTextHeight/2, vAP + textH - oneLineTextHeight/2);
                            offlinecanvas.closePath();
                            offlinecanvas.stroke();
                        }
                    }
                    //向上倾斜（-45 旋转）
                    if(tr == "2"){
                        offlinecanvas.save();
                        offlinecanvas.translate(hAP + textW, vAP);
                        offlinecanvas.rotate(-45*Math.PI/180);
                        offlinecanvas.translate(-(hAP + textW), -vAP);
                        offlinecanvas.fillText(value==null?"":value, hAP - (0.707*0.707*oneLineTextHeight), vAP - (0.707*0.707*oneLineTextHeight));
                        offlinecanvas.restore();
                        
                        //是否有删除线
                        var cl = jfgrid.menuButton.checkstatus(jfgrid.flowdata, r, c , "cl");
                        if(cl == "1" && !!value){
                            offlinecanvas.beginPath();
                            offlinecanvas.moveTo(hAP + oneLineTextHeight/2, vAP + textH - oneLineTextHeight/2);
                            offlinecanvas.lineTo(hAP + textW - oneLineTextHeight/2, vAP + oneLineTextHeight/2);
                            offlinecanvas.closePath();
                            offlinecanvas.stroke();
                        }
                    }
                }
                else if(tr == "3"){
                    if(!!value){
                        value = value.toString();
                        if(value.length > 1){
                            var vArr = value.split("");    
                        }
                        else{
                            var vArr = [];
                            vArr.push(value);
                        }
                        
                        var textW = offlinecanvas.measureText(vArr[0]).width;
                        var textH = vArr.length * oneLineTextHeight;
                        for(var i = 0; i < vArr.length; i++){
                            var vWidth = offlinecanvas.measureText(vArr[i]).width;
                            //水平对齐计算
                            if(horizonAlign == "0"){
                                horizonAlignPos = (start_c + (end_c - start_c) / 2 + offsetLeft)*devicePixelRatio - (vWidth)/2;
                            }else if(horizonAlign == "2"){
                                horizonAlignPos = (end_c + offsetLeft - 8)*devicePixelRatio - (vWidth);
                            }else{
                                horizonAlignPos = (start_c + 4 + offsetLeft)*devicePixelRatio;
                            }
                            //垂直对齐计算
                            if(verticalAlign == "0"){
                                verticalAlignPos = (start_r + (end_r - start_r) / 2  + offsetTop + verticalFixed)*devicePixelRatio - oneLineTextHeight*vArr.length/2;
                            }else if(verticalAlign == "1"){
                                verticalAlignPos = (start_r + offsetTop + verticalFixed)*devicePixelRatio;
                            }else{
                                verticalAlignPos = (end_r  + offsetTop - 2 + verticalFixed)*devicePixelRatio - oneLineTextHeight*vArr.length;
                            }
                            offlinecanvas.fillText(vArr[i], horizonAlignPos, (verticalAlignPos+i*oneLineTextHeight));
                        }
                        //是否有删除线
                        var cl = jfgrid.menuButton.checkstatus(jfgrid.flowdata, r, c , "cl");
                        if(cl == "1" && !!value){
                            offlinecanvas.beginPath();
                            offlinecanvas.moveTo(horizonAlignPos + textW/2, verticalAlignPos);
                            offlinecanvas.lineTo(horizonAlignPos + textW/2, verticalAlignPos + textH);
                            offlinecanvas.closePath();
                            offlinecanvas.stroke();
                        }
                    }
                }
                else if(tr == "4" || tr == "5"){
                    //旋转重新计算水平、垂直方向坐标
                    var textW = oneLineTextHeight;
                    var textH = textMetrics;

                    var hAP = (start_c + 4 + offsetLeft)*devicePixelRatio;
                    if(horizonAlign=="0"){
                        hAP = (start_c + (end_c - start_c) / 2 + offsetLeft)*devicePixelRatio - (textW)/2;
                    }
                    else if(horizonAlign=="2"){
                        hAP = (end_c + offsetLeft - 8)*devicePixelRatio - (textW);
                    }

                    var vAP = (end_r  + offsetTop - 2 + verticalFixed)*devicePixelRatio - textH;
                    if(verticalAlign=="0"){
                        vAP = (start_r + (end_r - start_r) / 2  + offsetTop + verticalFixed)*devicePixelRatio - textH/2;
                    }
                    else if(verticalAlign=="1"){
                        vAP = (start_r + offsetTop + verticalFixed)*devicePixelRatio;
                    }
                    //向下90（90 旋转）
                    if(tr == "4"){
                        offlinecanvas.save();
                        offlinecanvas.translate(hAP, vAP);
                        offlinecanvas.rotate(90*Math.PI/180);
                        offlinecanvas.translate(-hAP, -vAP);
                        offlinecanvas.fillText(value==null?"":value, hAP, vAP - textW);
                        offlinecanvas.restore();

                        //是否有删除线
                        var cl = jfgrid.menuButton.checkstatus(jfgrid.flowdata, r, c , "cl");
                        if(cl == "1" && !!value){
                            offlinecanvas.beginPath();
                            offlinecanvas.moveTo(hAP + textW/2, vAP);
                            offlinecanvas.lineTo(hAP + textW/2, vAP + textH);
                            offlinecanvas.closePath();
                            offlinecanvas.stroke();
                        }
                    }
                    //向上90（-90 旋转）
                    if(tr == "5"){
                        offlinecanvas.save();
                        offlinecanvas.translate(hAP + textH, vAP);
                        offlinecanvas.rotate(-90*Math.PI/180);
                        offlinecanvas.translate(-(hAP + textH), -vAP);
                        offlinecanvas.fillText(value==null?"":value, hAP, vAP - textH);
                        offlinecanvas.restore();

                        //是否有删除线
                        var cl = jfgrid.menuButton.checkstatus(jfgrid.flowdata, r, c , "cl");
                        if(cl == "1" && !!value){
                            offlinecanvas.beginPath();
                            offlinecanvas.moveTo(hAP + textW/2, vAP);
                            offlinecanvas.lineTo(hAP + textW/2, vAP + textH);
                            offlinecanvas.closePath();
                            offlinecanvas.stroke();
                        }
                    }
                }
            }
            else{
                //是否有删除线
                var cl = jfgrid.menuButton.checkstatus(jfgrid.flowdata, r, c , "cl");
                if(cl == "1" && !!value){
                    jfgridTableContent.strokeStyle = "#000000";
                    
                    offlinecanvas.beginPath();
                    offlinecanvas.moveTo(horizonAlignPos, verticalAlignPos + oneLineTextHeight/2);
                    offlinecanvas.lineTo(horizonAlignPos + textMetrics, verticalAlignPos + oneLineTextHeight/2);
                    offlinecanvas.closePath();
                    offlinecanvas.stroke();

                    offlinecanvas.textBaseline = "middle";
                    offlinecanvas.fillText(value==null?"":value, horizonAlignPos, verticalAlignPos + oneLineTextHeight/2);
                }
                else{
                    offlinecanvas.textBaseline = "top";
                    offlinecanvas.fillText(value==null?"":value, horizonAlignPos, verticalAlignPos);
                }
            }

            offlinecanvas.font = jfgriddefaultstyle.font;

            //var imgData= offlinecanvas.getImageData(cellsize[0], cellsize[1], cellsize[2], cellsize[3]);

            //console.log(cellsize[0], cellsize[1], cellsize[2], cellsize[3], horizonAlignPos, verticalAlignPos);

            // jfgridTableContent.imageSmoothingEnabled = false;
            // jfgridTableContent.mozImageSmoothingEnabled = false;
            // jfgridTableContent.webkitImageSmoothingEnabled = false;
            // jfgridTableContent.msImageSmoothingEnabled = false;
            // jfgridTableContent.oImageSmoothingEnabled = false;


            jfgridTableContent.drawImage($("#jfgridTableContentF").get(0), cellsize[0], cellsize[1], cellsize[2], cellsize[3], cellsize[0], cellsize[1], cellsize[2], cellsize[3]);
            

            // jfgridTableContent.imageSmoothingEnabled = true;
            // jfgridTableContent.mozImageSmoothingEnabled = true;
            // jfgridTableContent.webkitImageSmoothingEnabled = true;
            // jfgridTableContent.msImageSmoothingEnabled = true;
            // jfgridTableContent.oImageSmoothingEnabled = true;

            //jfgridTableContent.drawImage($("#jfgridTableContentF").get(0), start_c - 1 + offsetLeft+borderfix[0], start_r + offsetTop+borderfix[1], end_c - start_c -2+borderfix[2], end_r - start_r-3+borderfix[3], start_c - 1 + offsetLeft+borderfix[0], start_r + offsetTop+borderfix[1], end_c - start_c -2+borderfix[2], end_r - start_r-3+borderfix[3]);

            // jfgridTableContent.fillStyle= "#fff";
            // var clearNextCellLen = defaultcollen;
            // if (config["columlen"] != null && config["columlen"][ec +1] != null) {
            //     clearNextCellLen = config["columlen"][ec+1];
            // }
            // jfgridTableContent.fillRect(end_ec - 3 + offsetLeft, start_r + offsetTop, clearNextCellLen, end_r - 2 -start_r-1);




            var bs = jfgrid.menuButton.checkstatus(jfgrid.flowdata, r, c , "bs");
            var bc = jfgrid.menuButton.checkstatus(jfgrid.flowdata, r, c , "bc");
            var bs_t = jfgrid.menuButton.checkstatus(jfgrid.flowdata, r, c , "bs_t");
            var bc_t = jfgrid.menuButton.checkstatus(jfgrid.flowdata, r, c , "bc_t");
            var bs_b = jfgrid.menuButton.checkstatus(jfgrid.flowdata, r, c , "bs_b");
            var bc_b = jfgrid.menuButton.checkstatus(jfgrid.flowdata, r, c , "bc_b");
            var bs_l = jfgrid.menuButton.checkstatus(jfgrid.flowdata, r, c , "bs_l");
            var bc_l = jfgrid.menuButton.checkstatus(jfgrid.flowdata, r, c , "bc_l");
            var bs_r = jfgrid.menuButton.checkstatus(jfgrid.flowdata, r, c , "bs_r");
            var bc_r = jfgrid.menuButton.checkstatus(jfgrid.flowdata, r, c , "bc_r");

            //左边框
            //console.log(r, c , value, bs_l, bc_l);
            if(bs_l!="none" || bs!="none"){
                var linetype = bs_l=="none" ?bs:bs_l;

                jfgrid.menuButton.setLineDash(jfgridTableContent, linetype, "v", devicePixelRatio*(start_c - 2+ 0.5 + offsetLeft), devicePixelRatio*(start_r + offsetTop), devicePixelRatio*(start_c - 2+ 0.5 + offsetLeft), devicePixelRatio*(end_r - 2 + offsetTop));

                // jfgridTableContent.beginPath();
                // jfgridTableContent.moveTo(start_c - 2 + offsetLeft, start_r + offsetTop);
                // jfgridTableContent.lineTo(start_c - 2 + offsetLeft, end_r - 2 + offsetTop);
                // jfgridTableContent.lineWidth = 1;


                jfgridTableContent.strokeStyle = bs_l=="none" ?bc:bc_l;
                
                jfgridTableContent.stroke();
                jfgridTableContent.closePath();
            }
            // else{
            //     jfgridTableContent.beginPath();
            //     jfgridTableContent.moveTo(devicePixelRatio*(start_c - 2+ 0.5 + offsetLeft), devicePixelRatio*(start_r + offsetTop));
            //     jfgridTableContent.lineTo(devicePixelRatio*(start_c - 2+ 0.5 + offsetLeft), devicePixelRatio*(end_r - 2 + offsetTop));
            //     jfgridTableContent.lineWidth = devicePixelRatio;

            //     if (!!jfgridcurrentisPivotTable && !jfgrid.pivotTable.drawPivotTable) {
            //         jfgridTableContent.strokeStyle = "#000000";
            //     }
            //     else{
            //         jfgridTableContent.strokeStyle = jfgriddefaultstyle.strokeStyle;
            //     }
                
                
            //     jfgridTableContent.stroke();
            //     jfgridTableContent.closePath();
            // }

            // //右边框
            if(bs_r!="none" || bs!="none"){
                //console.log(11112222);
                var linetype = bs_r=="none" ?bs:bs_r;

                jfgrid.menuButton.setLineDash(jfgridTableContent, linetype, "v", devicePixelRatio*(end_c - 2 + 0.5 + offsetLeft), devicePixelRatio*(start_r + offsetTop), devicePixelRatio*(end_c - 2 + 0.5 + offsetLeft), devicePixelRatio*(end_r - 2 + offsetTop));

                // jfgridTableContent.beginPath();
                // jfgridTableContent.moveTo(end_c - 2 + offsetLeft, start_r + offsetTop);
                // jfgridTableContent.lineTo(end_c - 2 + offsetLeft, end_r - 2 + offsetTop);
                // jfgridTableContent.lineWidth = devicePixelRatio;

                jfgridTableContent.strokeStyle = bs_r=="none" ?bc:bc_r;
                jfgridTableContent.stroke();
                jfgridTableContent.closePath();
            }
            // else {
            //     jfgridTableContent.beginPath();
            //     jfgridTableContent.moveTo(end_c - 2 + offsetLeft, start_r + offsetTop);
            //     jfgridTableContent.lineTo(end_c - 2 + offsetLeft, end_r - 2 + offsetTop);
            //     jfgridTableContent.lineWidth = devicePixelRatio;

            //     jfgridTableContent.strokeStyle = jfgriddefaultstyle.strokeStyle;
            //     jfgridTableContent.stroke();
            //     jfgridTableContent.closePath();
            // }

            //下边框
            if(bs_b!="none" || bs!="none"){
                //console.log(11112222);
                var linetype = bs_b=="none" ?bs:bs_b;

                jfgrid.menuButton.setLineDash(jfgridTableContent, linetype, "h", devicePixelRatio*(start_c - 2 + offsetLeft), devicePixelRatio*(end_r - 2 + 0.5 + offsetTop), devicePixelRatio*(end_c + offsetLeft-2), devicePixelRatio*(end_r - 2 + 0.5 + offsetTop));

                // jfgridTableContent.beginPath();
                // jfgridTableContent.moveTo(start_c - 2 + offsetLeft, end_r - 2 + offsetTop);
                // jfgridTableContent.lineTo(end_c + offsetLeft-2, end_r - 2 + offsetTop);
                // jfgridTableContent.lineWidth = devicePixelRatio;

                jfgridTableContent.strokeStyle = bs_b=="none" ?bc:bc_b;
                jfgridTableContent.stroke();
                jfgridTableContent.closePath();
            }
            // else{
            //     jfgridTableContent.beginPath();
            //     jfgridTableContent.moveTo(devicePixelRatio*(start_c - 2 + offsetLeft), devicePixelRatio*(end_r - 2 + 0.5 + offsetTop));
            //     jfgridTableContent.lineTo(devicePixelRatio*(end_c + offsetLeft-2), devicePixelRatio*(end_r - 2 + 0.5 + offsetTop));
            //     jfgridTableContent.lineWidth = devicePixelRatio;

            //     if (!!jfgridcurrentisPivotTable && !jfgrid.pivotTable.drawPivotTable) {
            //         jfgridTableContent.strokeStyle = "#000000";
            //     }
            //     else{
            //         jfgridTableContent.strokeStyle = jfgriddefaultstyle.strokeStyle;
            //     }
                
            //     jfgridTableContent.stroke();
            //     jfgridTableContent.closePath();
            // }

            //上边框
            if(bs_t!="none" || bs!="none"){
                //console.log(11112222);
                var linetype = bs_t=="none" ?bs:bs_t;

                jfgrid.menuButton.setLineDash(jfgridTableContent, linetype, "h", devicePixelRatio*(start_c - 2 + offsetLeft), devicePixelRatio*(start_r - 1 + 0.5 + offsetTop), devicePixelRatio*(end_c + offsetLeft-2), devicePixelRatio*(start_r - 1 + 0.5 + offsetTop));

                // jfgridTableContent.beginPath();
                // jfgridTableContent.moveTo(start_c - 2 + offsetLeft, start_r - 1 + offsetTop);
                // jfgridTableContent.lineTo(end_c + offsetLeft-2, start_r - 1 + offsetTop);
                // jfgridTableContent.lineWidth = devicePixelRatio;

                jfgridTableContent.strokeStyle = bs_t=="none" ?bc:bc_t;
                jfgridTableContent.stroke();
                jfgridTableContent.closePath();
            }

            //补全缺失的上边框
            // var startlist = item.startlist;
            // //console.log(startlist);
            // for(var i = 0;i<startlist.length;i++){
            //     jfgridTableContent.beginPath();
                
            //     jfgridTableContent.moveTo(end_c + offsetLeft-2, startlist[i] - 1 + offsetTop);
            //     jfgridTableContent.lineTo(end_c + offsetLeft+ clearNextCellLen, startlist[i] - 1 + offsetTop);

            //     jfgridTableContent.lineWidth = devicePixelRatio;
            //     jfgridTableContent.strokeStyle = jfgriddefaultstyle.strokeStyle;
            //     jfgridTableContent.stroke();
            //     jfgridTableContent.closePath();
            // }

        }

        ////竖线
        //jfgridTableContent.beginPath();
        //jfgridTableContent.moveTo(offsetLeft - 2 , -0.5);
        //jfgridTableContent.lineTo(offsetLeft - 2 ,rh_height + offsetTop);
        //jfgridTableContent.lineWidth = devicePixelRatio;
        //jfgridTableContent.strokeStyle = jfgriddefaultstyle.strokeStyle;
        //jfgridTableContent.closePath();
        //jfgridTableContent.stroke();


        ////横线
        //jfgridTableContent.beginPath();
        //jfgridTableContent.moveTo(-0.5,  -2 + offsetTop);
        //jfgridTableContent.lineTo(ch_width + offsetLeft, -2 + offsetTop);
        //jfgridTableContent.lineWidth = devicePixelRatio;
        //jfgridTableContent.strokeStyle = jfgriddefaultstyle.strokeStyle;
        //jfgridTableContent.closePath();
        //jfgridTableContent.stroke();

        //jfgridTableContent.clearRect(0, 0, offsetLeft - 2, offsetTop - 2);


        //jfgridTableContent.clearRect(drawWidth > (ch_width + offsetLeft) ? (ch_width + offsetLeft - 2) : drawWidth - 2 + offsetLeft, offsetTop, drawWidth, drawHeight);
    }
    
    function jfgridDrawgrid_c(scrollWidth, scrollHeight, drawWidth, drawHeight, offsetLeft, offsetTop) {
        if (scrollWidth == null) {
            scrollWidth = $("#jfgrid-cell-main").scrollLeft();
        }
        if (scrollHeight == null) {
            scrollHeight = $("#jfgrid-cell-main").scrollTop();
        }

        if (drawWidth == null) {
            drawWidth = jfgridTableContentHW[0];
        }
        if (drawHeight == null) {
            drawHeight = jfgridTableContentHW[1];
        }

        if (offsetLeft == null) {
            offsetLeft = 0;
        }
        if (offsetTop == null) {
            offsetTop = 0;
        }

        //jfgridTableContentHW = [$("#jfgrid-grid-window-1").width() - 13, $("#jfgrid-grid-window-1").height() - 13];
        var jfgridTableContent = $("#jfgridTableContent").get(0).getContext("2d");
        jfgridTableContent.clearRect(offsetLeft, offsetTop, drawWidth, drawHeight);


        jfgridTableContent.font = jfgriddefaultstyle.font;
        jfgridTableContent.textBaseline = jfgriddefaultstyle.textBaseline;
        jfgridTableContent.fillStyle = jfgriddefaultstyle.fillStyle;

        var dataset_row_st, dataset_row_ed, dataset_col_st, dataset_col_ed;
        dataset_row_st = jfgrid_searcharray(visibledatarow, scrollHeight);
        dataset_row_ed = jfgrid_searcharray(visibledatarow, scrollHeight + drawHeight);
        if (dataset_row_st == -1) {
            dataset_row_st = 0;
        }
        if (dataset_row_ed == -1) {
            dataset_row_ed = visibledatarow.length - 1;
        }
        dataset_col_st = jfgrid_searcharray(visibledatacolumn, scrollWidth);
        dataset_col_ed = jfgrid_searcharray(visibledatacolumn, scrollWidth + drawWidth);
        if (dataset_col_st == -1) {
            dataset_col_st = 0;
        }
        if (dataset_col_ed == -1) {
            dataset_col_ed = visibledatacolumn.length - 1;
        }
        //console.log(dataset_row_st, dataset_row_ed, dataset_col_st, dataset_col_ed);
        var end_r, start_r, end_c, start_c, flow_index = 0, flow_cols_index = 0, rowfix = 0, colfix = 0, colLineState = true;

        // $("#jfgrid-cell-main").scrollLeft(visibledatarow[dataset_row_st]);
        // $("#jfgrid-cell-main").scrollTop(visibledatacolumn[dataset_col_st]);

        for (var r = dataset_row_st; r <= dataset_row_ed; r++) {

            if (r == 0) {
                start_r = -scrollHeight - 1;
            }
            else {
                start_r = visibledatarow[r - 1] - scrollHeight - 1;
            }
            end_r = visibledatarow[r] - scrollHeight;


            //行
            //jfgridTableContent.beginPath();
            //jfgridTableContent.moveTo(0, end_r + columeHeaderHeight);
            //jfgridTableContent.lineTo(rowHeaderWidth, end_r + columeHeaderHeight);
            //jfgridTableContent.lineWidth = devicePixelRatio;
            //jfgridTableContent.strokeStyle = jfgriddefaultstyle.strokeStyle;
            //jfgridTableContent.closePath();
            //jfgridTableContent.stroke();



            for (var c = dataset_col_st; c <= dataset_col_ed; c++) {

                if (c == 0) {
                    start_c = -scrollWidth;
                }
                else {
                    start_c = visibledatacolumn[c - 1] - scrollWidth;
                }
                end_c = visibledatacolumn[c] - scrollWidth;

                if (config["rowhidden"] != null && config["rowhidden"][r] != null) {

                }
                else {
                    //&& start_r >= -2 && start_c >= -2
                    if (jfgrid.flowdata[r] != null && jfgrid.flowdata[r][c] != null) {
                        var textMetrics = jfgridTableContent.measureText(jfgrid.flowdata[r][c]);
                        jfgridTableContent.clearRect(start_c + rowHeaderWidth - 1 + offsetLeft, start_r + columeHeaderHeight + offsetTop, end_c - start_c - 1, end_r - start_r);
                        jfgridTableContent.fillText(jfgrid.flowdata[r][c], start_c + 4 + rowHeaderWidth + offsetLeft, columeHeaderHeight + start_r + (end_r - start_r) / 2 - 1 + offsetTop);

                    }
                }

                if (r == dataset_row_ed) {
                    jfgridTableContent.clearRect(start_c + rowHeaderWidth - 1, 0, end_c - start_c - 1, columeHeaderHeight - 2);

                    if (!jfgridcurrentisPivotTable) {
                        //列
                        jfgridTableContent.beginPath();
                        jfgridTableContent.moveTo(end_c + rowHeaderWidth - 2 + offsetLeft, 0.5 + offsetTop);
                        jfgridTableContent.lineTo(end_c + rowHeaderWidth - 2 + offsetLeft, columeHeaderHeight + rh_height + offsetTop);
                        jfgridTableContent.lineWidth = devicePixelRatio;
                        jfgridTableContent.strokeStyle = jfgriddefaultstyle.strokeStyle;
                        jfgridTableContent.closePath();
                        jfgridTableContent.stroke();
                    }

                    var abc = jfgrid.jfgridchatatABC(c);
                    var textMetrics = jfgridTableContent.measureText(abc);
                    jfgridTableContent.fillText(abc, Math.round(start_c + rowHeaderWidth + (end_c - start_c - textMetrics.width) / 2), Math.round(columeHeaderHeight / 2 - 2));
                    //console.log(abc, Math.round(start_c + (end_c - start_c) / 2), Math.round(columeHeaderHeight / 2 - 2));
                }

                if (!!jfgridcurrentisPivotTable && jfgrid.pivotTable.drawPivotTable) {
                    if ((c == 0 || c == 5) && r <= 11) {
                        jfgridTableContent.beginPath();
                        jfgridTableContent.moveTo(end_c + rowHeaderWidth - 2 + offsetLeft, columeHeaderHeight + start_r + offsetTop);
                        jfgridTableContent.lineTo(end_c + rowHeaderWidth - 2 + offsetLeft, columeHeaderHeight + end_r - 2 + offsetTop);
                        jfgridTableContent.lineWidth = devicePixelRatio;
                        jfgridTableContent.strokeStyle = "#000000";
                        jfgridTableContent.closePath();
                        jfgridTableContent.stroke();
                        jfgridTableContent.clearRect(end_c + rowHeaderWidth - 2 + offsetLeft, offsetTop, 2, columeHeaderHeight);
                    }

                    if ((r == 2 || r == 11) && c <= 5) {
                        jfgridTableContent.beginPath();
                        jfgridTableContent.moveTo(rowHeaderWidth - 1 + start_c + offsetLeft, end_r + columeHeaderHeight - 2 + offsetTop);
                        jfgridTableContent.lineTo(rowHeaderWidth + end_c + offsetLeft, end_r + columeHeaderHeight - 2 + offsetTop);
                        jfgridTableContent.lineWidth = devicePixelRatio;
                        jfgridTableContent.strokeStyle = "#000000";
                        jfgridTableContent.closePath();
                        jfgridTableContent.stroke();
                    }

                    if (r == 6 && c == 3) {
                        jfgridTableContent.fillText("数据透视表", start_c + 4 + rowHeaderWidth + offsetLeft, columeHeaderHeight + start_r + (end_r - start_r) / 2 - 1 + offsetTop);
                    }
                }
                else if (!!jfgridcurrentisPivotTable) {
                    if (c < jfgrid.pivotTable.pivotTableBoundary[1] && r < jfgrid.pivotTable.pivotTableBoundary[0]) {
                        jfgridTableContent.beginPath();
                        jfgridTableContent.moveTo(end_c + rowHeaderWidth - 2 + offsetLeft, columeHeaderHeight + start_r + offsetTop);
                        jfgridTableContent.lineTo(end_c + rowHeaderWidth - 2 + offsetLeft, columeHeaderHeight + end_r - 2 + offsetTop);
                        jfgridTableContent.lineWidth = devicePixelRatio;
                        jfgridTableContent.strokeStyle = "#000000";
                        jfgridTableContent.closePath();
                        jfgridTableContent.stroke();
                        jfgridTableContent.clearRect(end_c + rowHeaderWidth - 2, 0, 2, columeHeaderHeight);


                        jfgridTableContent.beginPath();
                        jfgridTableContent.moveTo(rowHeaderWidth - 1 + start_c + offsetLeft, end_r + columeHeaderHeight - 2 + offsetTop);
                        jfgridTableContent.lineTo(rowHeaderWidth + end_c + offsetLeft, end_r + columeHeaderHeight - 2 + offsetTop);
                        jfgridTableContent.lineWidth = devicePixelRatio;
                        jfgridTableContent.strokeStyle = "#000000";
                        jfgridTableContent.closePath();
                        jfgridTableContent.stroke();
                    }
                }


                //if (r == dataset_row_ed) {
                //    jfgridTableContent.beginPath();
                //    jfgridTableContent.moveTo(end_c + rowHeaderWidth, -0.5);
                //    jfgridTableContent.lineTo(end_c + rowHeaderWidth, columeHeaderHeight+rh_height);
                //    jfgridTableContent.lineWidth = devicePixelRatio;
                //    jfgridTableContent.strokeStyle = jfgriddefaultstyle.strokeStyle;
                //    jfgridTableContent.closePath();
                //    jfgridTableContent.stroke();
                //    console.log("end_c, rh_height", dataset_col_st, dataset_col_ed, dataset_row_st, dataset_row_ed, r_set, c_set, rowfix, $("#jfgridsheettable_" + jfgrid.currentSheetIndex + "_" + r_set + "_" + c_set + ""), end_c, h, r,c);
                //}

            }

            if (config["rowhidden"] != null && config["rowhidden"][r] != null) {

            }
            else {
                jfgridTableContent.clearRect(offsetLeft, start_r + columeHeaderHeight - 1 + offsetTop, rowHeaderWidth - 2, end_r - start_r - 1);
                var textMetrics = jfgridTableContent.measureText(r + 1);
                jfgridTableContent.fillText(r + 1, offsetLeft + (rowHeaderWidth - textMetrics.width) / 2, columeHeaderHeight + start_r + (end_r - start_r) / 2 - 2 + offsetTop);
                //console.log((rowHeaderWidth - textMetrics.width) / 2, rowHeaderWidth, textMetrics);
            }


            if (!jfgridcurrentisPivotTable) {
                jfgridTableContent.beginPath();
                jfgridTableContent.moveTo(-0.5 + offsetLeft, end_r + columeHeaderHeight - 2 + offsetTop);
                jfgridTableContent.lineTo(rowHeaderWidth + ch_width + offsetLeft, end_r + columeHeaderHeight - 2 + offsetTop);
                jfgridTableContent.lineWidth = devicePixelRatio;
                jfgridTableContent.strokeStyle = jfgriddefaultstyle.strokeStyle;
                jfgridTableContent.closePath();
                jfgridTableContent.stroke();
            }

        }

        //竖线
        jfgridTableContent.beginPath();
        jfgridTableContent.moveTo(rowHeaderWidth - 2 + offsetLeft, -0.5 + offsetTop);
        jfgridTableContent.lineTo(rowHeaderWidth - 2 + offsetLeft, columeHeaderHeight + rh_height + offsetTop);
        jfgridTableContent.lineWidth = devicePixelRatio;
        jfgridTableContent.strokeStyle = jfgriddefaultstyle.strokeStyle;
        jfgridTableContent.closePath();
        jfgridTableContent.stroke();

        //横线
        jfgridTableContent.beginPath();
        jfgridTableContent.moveTo(-0.5 + offsetLeft, columeHeaderHeight - 2 + offsetTop);
        jfgridTableContent.lineTo(rowHeaderWidth + ch_width + offsetLeft, columeHeaderHeight - 2 + offsetTop);
        jfgridTableContent.lineWidth = devicePixelRatio;
        jfgridTableContent.strokeStyle = jfgriddefaultstyle.strokeStyle;
        jfgridTableContent.closePath();
        jfgridTableContent.stroke();

        jfgridTableContent.clearRect(offsetLeft, offsetTop, rowHeaderWidth - 2, columeHeaderHeight - 2);


        jfgridTableContent.clearRect(drawWidth > (ch_width + rowHeaderWidth) ? (ch_width + rowHeaderWidth - 2) : drawWidth - 2 + offsetLeft, offsetTop, drawWidth, drawHeight);
    }

    jfgrid.jfgridcreatedom = function (colwidth, rowheight, data, menu, title) {
        if(!jfgridConfigsetting.pointEdit){
            //最少30行
            if(rowheight < 30){
                rowheight = 30;
            }

            //最少22列
            if(colwidth < 22){
                colwidth = 22;
            }
        }

        var gh = gridHTML;
        gh = jfgrid.replaceHtml(gh, { "logotitle": title });//设置title
        gh = jfgrid.replaceHtml(gh, { "menu": menuToolBar });//设置需要显示的菜单

        if (data.length == 0) {
            jfgrid.flowdata = jfgrid.datagridgrowth(data, rowheight, colwidth);
        }
        else if (data.length < rowheight && data[0].length < colwidth) {
            jfgrid.flowdata = jfgrid.datagridgrowth(data, rowheight - data.length, colwidth - data[0].length);
        }
        else if (data.length < rowheight) {
            jfgrid.flowdata = jfgrid.datagridgrowth(data, rowheight - data.length, 0);
        }
        else if (data[0].length < colwidth) {
            jfgrid.flowdata = jfgrid.datagridgrowth(data, 0, colwidth - data[0].length);
        }
        else {
            jfgrid.flowdata = data;
        }

        jfgrid.editor.webWorkerFlowDataCache(jfgrid.flowdata);//worker存数据
        
        var flowHTML = flow;
        if(config == null){
            config = {};
        }

        //列宽重置
        visibledatacolumn = [];
        ch_width = 0;
        for (var i = 0; i < colwidth; i++) {
            var firstcolumlen = defaultcollen;
            if (config["columlen"] != null && config["columlen"][i] != null) {
                firstcolumlen = config["columlen"][i];
            }
            else {
                if (data[0] != null && data[0][i] != null) {
                    firstcolumlen = Math.ceil(jfgrid.getByteLen(data[0][i].v) * 11.5);
                    if (firstcolumlen > 300) {
                        firstcolumlen = 300;
                    }
                    else if (firstcolumlen < defaultcollen) {
                        firstcolumlen = defaultcollen;
                    }

                    if (firstcolumlen != defaultcollen) {
                        if (config["columlen"] == null) {
                            config["columlen"] = {};
                        }
                        config["columlen"][i] = firstcolumlen;
                    }
                }
            }
            ch_width += firstcolumlen + 1;
            visibledatacolumn.push(ch_width); //列的临时长度分布
        }

        //行高重置
        visibledatarow = [];
        rh_height = 0;
        for (var i = 0; i < rowheight; i++) {
            var rowlen = defaultrowlen;
            if (config["rowlen"] != null && config["rowlen"][i] != null) {
                rowlen = config["rowlen"][i];
            }

            if (config["rowhidden"] != null && config["rowhidden"][i] != null) {
                rowlen = config["rowhidden"][i];
                visibledatarow.push(rh_height);
                continue;
            }
            else {
                rh_height += rowlen + 1;
            }
            visibledatarow.push(rh_height); //行的临时长度分布
        }

        if(!jfgridConfigsetting.pointEdit){
            //非编辑器表格编辑状态
            rh_height += 110;
            ch_width += 120;

            var addControll = '<button id="jfgrid-bottom-add-row" class="btn btn-default">添加</button><input id="jfgrid-bottom-add-row-input" type="text" class="jfgrid-datavisual-config-input jfgrid-mousedown-cancel" placeholder="100"><span style="font-size: 14px;">行</span><span style="font-size: 14px;color: #9c9c9c;">(在底部添加)</span>';
            var backControll = ' <button id="jfgrid-bottom-bottom-top" class="btn btn-default" style="">回到顶部</button>';
            // var pageControll = ' <span id="jfgrid-bottom-page-info" style="font-size: 14px;color: #f34141;">共'+ jfgridConfigsetting.pageInfo.totalPage +'页，当前已显示'+ (jfgridConfigsetting.pageInfo.currentPage) +'页，每页'+ jfgridConfigsetting.pageInfo.pageSize +'条</span> <button id="jfgrid-bottom-page-next" class="btn btn-danger" style="">下一页</button>';
            var pageControll = ' <span id="jfgrid-bottom-page-info" style="font-size: 14px;color: #f34141;">共'+ jfgridConfigsetting.total +'条，'+ jfgridConfigsetting.pageInfo.totalPage +'页，当前已显示'+ (jfgridConfigsetting.pageInfo.currentPage) +'页</span> <button id="jfgrid-bottom-page-next" class="btn btn-danger" style="">下一页</button>';
            var pageControll2 = ' <span id="jfgrid-bottom-page-info" style="font-size: 14px;color: #f34141;">共'+ jfgridConfigsetting.total +'条，'+ jfgridConfigsetting.pageInfo.totalPage +'页，当前已显示'+ (jfgridConfigsetting.pageInfo.currentPage) +'页</span>';

            var bottomControll = "";
            if(jfgridConfigsetting.enableAddRow){
                bottomControll += addControll;
            }

            if(jfgridConfigsetting.enablePage){
                if(parseInt(jfgridConfigsetting.pageInfo.totalPage) == 1){
                    bottomControll += pageControll2;
                }
                else{
                    bottomControll += pageControll;
                }
            }

            bottomControll += backControll;

            var flowstr = jfgrid.replaceHtml('<div id="jfgridcoltable_0" class="jfgrid-cell-flow-col"> <div id ="jfgrid-sheettable_0" class="jfgrid-cell-sheettable" style="height:${height}px;width:${width}px;"></div><div id="jfgrid-bottom-controll-row" class="jfgrid-bottom-controll-row"> '+ bottomControll +' </div> </div>', { "height": rh_height, "width": ch_width - 1 });
        }

        var colsheader = jfgrid.replaceHtml(columnHeaderHTML, { "width": ch_width, "index": 0, "column": "" });

        flowHTML = jfgrid.replaceHtml(flowHTML, { "width": ch_width, "flow": flowstr, "index": 0 });

        gh = jfgrid.replaceHtml(gh, { "flow": flowHTML, "rowHeader": "<div style='height:" + rh_height + "px' id='jfgridrowHeader_0' class='jfgridsheetchange'></div>", "columnHeader": colsheader, "functionButton": jfgridConfigsetting.functionButton });//设置需要显示的菜单

        $("#" + container).append(gh);

        $("#jfgrid-scrollbar-x div").width(ch_width);
        $("#jfgrid-scrollbar-y div").height(rh_height - 30);

        //新建行菜单
        $("body").append(maskHTML);
        $("body").append(colsmenuHTML);
        $("body").append(rightclickHTML);
        $("body").append(inputHTML);
        $("body").append(jfgrid.replaceHtml(filtermenuHTML, { "menuid": "filter" }));
        $("body").append(jfgrid.replaceHtml(filtersubmenuHTML, { "menuid": "filter" }));
        $("body").append(sheetconfigHTML);

        //批注
        jfgrid.postil.buildAllPs(jfgrid.flowdata);
    }

    function jfexecStroke(refreshcanvas, i) {
        refreshcanvas[i++].stroke();
        if (i < refreshcanvas.length) {
            setTimeout(function () {
                jfexecStroke(refreshcanvas, i);
            }, 1000);
        }
    }

    //sparkline设置
    (function(){

        var createClass = function (/* [baseclass, [mixin, ...]], definition */) {
            var Class, args;
            Class = function () {
                this.init.apply(this, arguments);
            };
            if (arguments.length > 1) {
                if (arguments[0]) {
                    Class.prototype = $.extend(new arguments[0](), arguments[arguments.length - 1]);
                    Class._super = arguments[0].prototype;
                } else {
                    Class.prototype = arguments[arguments.length - 1];
                }
                if (arguments.length > 2) {
                    args = Array.prototype.slice.call(arguments, 1, -1);
                    args.unshift(Class.prototype);
                    $.extend.apply($, args);
                }
            } else {
                Class.prototype = arguments[0];
            }
            Class.prototype.cls = Class;
            return Class;
        };

        /**
         * Wraps a format string for tooltips
         * {{x}}
         * {{x.2}
         * {{x:months}}
         */
        var SPFormat = createClass({
            fre: /\{\{([\w.]+?)(:(.+?))?\}\}/g,
            precre: /(\w+)\.(\d+)/,

            init: function (format, fclass) {
                this.format = format;
                this.fclass = fclass;
            },

            render: function (fieldset, lookups, options) {
                var self = this,
                    fields = fieldset,
                    match, token, lookupkey, fieldvalue, prec;
                return this.format.replace(this.fre, function () {
                    var lookup;
                    token = arguments[1];
                    lookupkey = arguments[3];
                    match = self.precre.exec(token);
                    if (match) {
                        prec = match[2];
                        token = match[1];
                    } else {
                        prec = false;
                    }
                    fieldvalue = fields[token];
                    if (fieldvalue === undefined) {
                        return '';
                    }
                    if (lookupkey && lookups && lookups[lookupkey]) {
                        lookup = lookups[lookupkey];
                        if (lookup.get) { // RangeMap
                            return lookups[lookupkey].get(fieldvalue) || fieldvalue;
                        } else {
                            return lookups[lookupkey][fieldvalue] || fieldvalue;
                        }
                    }
                    if (isNumber(fieldvalue)) {
                        if (options.get('numberFormatter')) {
                            fieldvalue = options.get('numberFormatter')(fieldvalue);
                        } else {
                            fieldvalue = formatNumber(fieldvalue, prec,
                                options.get('numberDigitGroupCount'),
                                options.get('numberDigitGroupSep'),
                                options.get('numberDecimalMark'));
                        }
                    }
                    return fieldvalue;
                });
            }
        });

        // convience method to avoid needing the new operator
        $.spformat = function(format, fclass) {
            return new SPFormat(format, fclass);
        };

        var clipval = function (val, min, max) {
            if (val < min) {
                return min;
            }
            if (val > max) {
                return max;
            }
            return val;
        };

        var quartile = function (values, q) {
            var vl;
            if (q === 2) {
                vl = Math.floor(values.length / 2);
                return values.length % 2 ? values[vl] : (values[vl-1] + values[vl]) / 2;
            } else {
                if (values.length % 2 ) { // odd
                    vl = (values.length * q + q) / 4;
                    return vl % 1 ? (values[Math.floor(vl)] + values[Math.floor(vl) - 1]) / 2 : values[vl-1];
                } else { //even
                    vl = (values.length * q + 2) / 4;
                    return vl % 1 ? (values[Math.floor(vl)] + values[Math.floor(vl) - 1]) / 2 :  values[vl-1];

                }
            }
        };

        var normalizeValue = function (val) {
            var nf;
            switch (val) {
                case 'undefined':
                    val = undefined;
                    break;
                case 'null':
                    val = null;
                    break;
                case 'true':
                    val = true;
                    break;
                case 'false':
                    val = false;
                    break;
                default:
                    nf = parseFloat(val);
                    if (val == nf) {
                        val = nf;
                    }
            }
            return val;
        };

        var normalizeValues = function (vals) {
            var i, result = [];
            for (i = vals.length; i--;) {
                result[i] = normalizeValue(vals[i]);
            }
            return result;
        };


        var all = function (val, arr, ignoreNull) {
            var i;
            for (i = arr.length; i--; ) {
                if (ignoreNull && arr[i] === null) continue;
                if (arr[i] !== val) {
                    return false;
                }
            }
            return true;
        };

        // sums the numeric values in an array, ignoring other values
        var sum = function (vals) {
            var total = 0, i;
            for (i = vals.length; i--;) {
                total += typeof vals[i] === 'number' ? vals[i] : 0;
            }
            return total;
        };

        var remove = function (vals, filter) {
            var i, vl, result = [];
            for (i = 0, vl = vals.length; i < vl; i++) {
                if (vals[i] !== filter) {
                    result.push(vals[i]);
                }
            }
            return result;
        };

        var isNumber = function (num) {
            return !isNaN(parseFloat(num)) && isFinite(num);
        };

        var formatNumber = function (num, prec, groupsize, groupsep, decsep) {
            var p, i;
            num = (prec === false ? parseFloat(num).toString() : num.toFixed(prec)).split('');
            p = (p = $.inArray('.', num)) < 0 ? num.length : p;
            if (p < num.length) {
                num[p] = decsep;
            }
            for (i = p - groupsize; i > 0; i -= groupsize) {
                num.splice(i, 0, groupsep);
            }
            return num.join('');
        };


        var RangeMap = createClass({
            init: function (map) {
                var key, range, rangelist = [];
                for (key in map) {
                    if (map.hasOwnProperty(key) && typeof key === 'string' && key.indexOf(':') > -1) {
                        range = key.split(':');
                        range[0] = range[0].length === 0 ? -Infinity : parseFloat(range[0]);
                        range[1] = range[1].length === 0 ? Infinity : parseFloat(range[1]);
                        range[2] = map[key];
                        rangelist.push(range);
                    }
                }
                this.map = map;
                this.rangelist = rangelist || false;
            },

            get: function (value) {
                var rangelist = this.rangelist,
                    i, range, result;
                if ((result = this.map[value]) !== undefined) {
                    return result;
                }
                if (rangelist) {
                    for (i = rangelist.length; i--;) {
                        range = rangelist[i];
                        if (range[0] <= value && range[1] >= value) {
                            return range[2];
                        }
                    }
                }
                return undefined;
            }
        });

        // Convenience function
        $.range_map = function(map) {
            return new RangeMap(map);
        };

        jfgrid.sparkline = {
            defaultOption:{
                // Settings common to most/all chart types
                common: {
                    type: 'line',
                    lineColor: '#2ec7c9',
                    fillColor: '#CCF3F4',
                    defaultPixelsPerValue: 3,
                    width: 'auto',
                    height: 'auto',
                    composite: false,
                    tagValuesAttribute: 'values',
                    tagOptionsPrefix: 'spark',
                    enableTagOptions: false,
                    enableHighlight: true,
                    highlightLighten: 1.4,
                    tooltipSkipNull: true,
                    tooltipPrefix: '',
                    tooltipSuffix: '',
                    disableHiddenCheck: false,
                    numberFormatter: false,
                    numberDigitGroupCount: 3,
                    numberDigitGroupSep: ',',
                    numberDecimalMark: '.',
                    disableTooltips: true,
                    disableInteraction: true,
                    offsetX:0,
                    offsetY:0
                },
                // Defaults for line charts
                //=LINESPL
                line: {
                    spotColor: 0,
                    highlightSpotColor: '#5f5',
                    highlightLineColor: '#f22',
                    spotRadius: 1.5,
                    minSpotColor: 0,
                    maxSpotColor: 0,
                    lineWidth: 1,
                    normalRangeMin: undefined,
                    normalRangeMax: undefined,
                    normalRangeColor: '#ccc',
                    drawNormalOnTop: true,
                    chartRangeMin: undefined,
                    chartRangeMax: undefined,
                    chartRangeMinX: undefined,
                    chartRangeMaxX: undefined,
                    // tooltipFormat: new SPFormat('<span style="color: {{color}}">&#9679;</span> {{prefix}}{{y}}{{suffix}}')
                },
                // Defaults for bar charts
                bar: {
                    barColor: '#fc5c5c',
                    negBarColor: '#97b552',
                    stackedBarColor: ["#2ec7c9", "#fc5c5c", "#5ab1ef", "#ffb980", "#d87a80", "#8d98b3", "#e5cf0d", "#97b552", "#95706d","#dc69aa","#07a2a4","#9a7fd1","#588dd5","#f5994e","#c05050","#59678c","#c9ab00","#7eb00a","#6f5553","#c14089"],
                    zeroColor: undefined,
                    nullColor: undefined,
                    zeroAxis: true,
                    barWidth: 4,
                    barSpacing: 1,
                    chartRangeMax: undefined,
                    chartRangeMin: undefined,
                    chartRangeClip: false,
                    colorMap: undefined,
                    // tooltipFormat: new SPFormat('<span style="color: {{color}}">&#9679;</span> {{prefix}}{{value}}{{suffix}}')
                },
                column: {
                    barColor: '#fc5c5c',
                    negBarColor: '#97b552',
                    stackedBarColor: ["#2ec7c9", "#fc5c5c", "#5ab1ef", "#ffb980", "#d87a80", "#8d98b3", "#e5cf0d", "#97b552", "#95706d","#dc69aa","#07a2a4","#9a7fd1","#588dd5","#f5994e","#c05050","#59678c","#c9ab00","#7eb00a","#6f5553","#c14089"],
                    zeroColor: undefined,
                    nullColor: undefined,
                    zeroAxis: true,
                    barWidth: 4,
                    barSpacing: 1,
                    chartRangeMax: undefined,
                    chartRangeMin: undefined,
                    chartRangeClip: false,
                    colorMap: undefined,
                    // tooltipFormat: new SPFormat('<span style="color: {{color}}">&#9679;</span> {{prefix}}{{value}}{{suffix}}')
                },
                // Defaults for tristate charts
                tristate: {
                    barWidth: 4,
                    barSpacing: 1,
                    posBarColor: '#fc5c5c',
                    negBarColor: '#97b552',
                    zeroBarColor: '#999',
                    colorMap: {},
                    // tooltipFormat: new SPFormat('<span style="color: {{color}}">&#9679;</span> {{value:map}}'),
                    // tooltipValueLookups: { map: { '-1': 'Loss', '0': 'Draw', '1': 'Win' } }
                },
                // Defaults for discrete charts
                discrete: {
                    lineHeight: 'auto',
                    thresholdColor: "#fc5c5c",
                    thresholdValue: 0,
                    chartRangeMax: undefined,
                    chartRangeMin: undefined,
                    chartRangeClip: false,
                    // tooltipFormat: new SPFormat('{{prefix}}{{value}}{{suffix}}')
                },
                // Defaults for bullet charts
                bullet: {
                    targetColor: '#f33',
                    targetWidth: 3, // width of the target bar in pixels
                    performanceColor: '#33f',
                    rangeColors: ['#d3dafe', '#a8b6ff', '#7f94ff','#6D87FF','#5876FF','#4465FF','#2F54FF','#1A43FF','#0532FF'],
                    base: undefined, // set this to a number to change the base start number
                    // tooltipFormat: new SPFormat('{{fieldkey:fields}} - {{value}}'),
                    // tooltipValueLookups: { fields: {r: 'Range', p: 'Performance', t: 'Target'} }
                },
                // Defaults for pie charts
                pie: {
                    offset: 0,
                    sliceColors: ["#2ec7c9", "#fc5c5c", "#5ab1ef", "#ffb980", "#d87a80", "#8d98b3", "#e5cf0d", "#97b552", "#95706d","#dc69aa","#07a2a4","#9a7fd1","#588dd5","#f5994e","#c05050","#59678c","#c9ab00","#7eb00a","#6f5553","#c14089"],
                    borderWidth: 0,
                    borderColor: '#000',
                    // tooltipFormat: new SPFormat('<span style="color: {{color}}">&#9679;</span> {{value}} ({{percent.1}}%)')
                },
                // Defaults for box plots
                box: {
                    raw: false,
                    boxLineColor: '#000',
                    boxFillColor: '#cdf',
                    whiskerColor: '#000',
                    outlierLineColor: '#5E5E5E',
                    outlierFillColor: '#fff',
                    medianColor: '#f00',
                    showOutliers: true,
                    outlierIQR: 1.5,
                    spotRadius: 1.5,
                    target: undefined,
                    targetColor: '#4a2',
                    chartRangeMax: undefined,
                    chartRangeMin: undefined,
                    // tooltipFormat: new SPFormat('{{field:fields}}: {{value}}'),
                    // tooltipFormatFieldlistKey: 'field',
                    // tooltipValueLookups: { fields: { lq: 'Lower Quartile', med: 'Median',
                    //     uq: 'Upper Quartile', lo: 'Left Outlier', ro: 'Right Outlier',
                    //     lw: 'Left Whisker', rw: 'Right Whisker'} }
                }
            },
            line:{
                type: 'line',
                init: function (el, values, options, width, height) {
                    //line._super.init.call(this, el, values, options, width, height);
                    this.vertices = [];
                    this.regionMap = [];
                    this.xvalues = [];
                    this.yvalues = [];
                    this.yminmax = [];
                    this.hightlightSpotId = null;
                    this.lastShapeId = null;
                    //this.initTarget();
                },
                getRegion: function (el, x, y) {
                    var i,
                        regionMap = this.regionMap; // maps regions to value positions
                    for (i = regionMap.length; i--;) {
                        if (regionMap[i] !== null && x >= regionMap[i][0] && x <= regionMap[i][1]) {
                            return regionMap[i][2];
                        }
                    }
                    return undefined;
                },
                getCurrentRegionFields: function () {
                    var currentRegion = this.currentRegion;
                    return {
                        isNull: this.yvalues[currentRegion] === null,
                        x: this.xvalues[currentRegion],
                        y: this.yvalues[currentRegion],
                        color: this.options.get('lineColor'),
                        fillColor: this.options.get('fillColor'),
                        offset: currentRegion
                    };
                },
                renderHighlight: function () {
                    var currentRegion = this.currentRegion,
                        target = this.target,
                        vertex = this.vertices[currentRegion],
                        options = this.options,
                        spotRadius = options.get('spotRadius'),
                        highlightSpotColor = options.get('highlightSpotColor'),
                        highlightLineColor = options.get('highlightLineColor'),
                        highlightSpot, highlightLine;

                    if (!vertex) {
                        return;
                    }
                    if (spotRadius && highlightSpotColor) {
                        highlightSpot = target.drawCircle(vertex[0], vertex[1],
                            spotRadius, undefined, highlightSpotColor);
                        this.highlightSpotId = highlightSpot.id;
                        target.insertAfterShape(this.lastShapeId, highlightSpot);
                    }
                    if (highlightLineColor) {
                        highlightLine = target.drawLine(vertex[0], this.canvasTop, vertex[0],
                            this.canvasTop + this.canvasHeight, highlightLineColor);
                        this.highlightLineId = highlightLine.id;
                        target.insertAfterShape(this.lastShapeId, highlightLine);
                    }
                },
                removeHighlight: function () {
                    var target = this.target;
                    if (this.highlightSpotId) {
                        target.removeShapeId(this.highlightSpotId);
                        this.highlightSpotId = null;
                    }
                    if (this.highlightLineId) {
                        target.removeShapeId(this.highlightLineId);
                        this.highlightLineId = null;
                    }
                },
                scanValues: function () {
                    var values = this.values,
                        valcount = values.length,
                        xvalues = this.xvalues,
                        yvalues = this.yvalues,
                        yminmax = this.yminmax,
                        i, val, isStr, isArray, sp;
                    for (i = 0; i < valcount; i++) {
                        val = values[i];
                        isStr = typeof(values[i]) === 'string';
                        isArray = typeof(values[i]) === 'object' && values[i] instanceof Array;
                        sp = isStr && values[i].split(':');
                        if (isStr && sp.length === 2) { // x:y
                            xvalues.push(Number(sp[0]));
                            yvalues.push(Number(sp[1]));
                            yminmax.push(Number(sp[1]));
                        } else if (isArray) {
                            xvalues.push(val[0]);
                            yvalues.push(val[1]);
                            yminmax.push(val[1]);
                        } else {
                            xvalues.push(i);
                            if (values[i] === null || values[i] === 'null') {
                                yvalues.push(null);
                            } else {
                                yvalues.push(Number(val));
                                yminmax.push(Number(val));
                            }
                        }
                    }
                    if (this.options.get('xvalues')) {
                        xvalues = this.options.get('xvalues');
                    }

                    this.maxy = this.maxyorg = Math.max.apply(Math, yminmax);
                    this.miny = this.minyorg = Math.min.apply(Math, yminmax);

                    this.maxx = Math.max.apply(Math, xvalues);
                    this.minx = Math.min.apply(Math, xvalues);

                    this.xvalues = xvalues;
                    this.yvalues = yvalues;
                    this.yminmax = yminmax;

                },
                processRangeOptions: function () {
                    var options = this.options,
                        normalRangeMin = options.get('normalRangeMin'),
                        normalRangeMax = options.get('normalRangeMax');

                    if (normalRangeMin !== undefined) {
                        if (normalRangeMin < this.miny) {
                            this.miny = normalRangeMin;
                        }
                        if (normalRangeMax > this.maxy) {
                            this.maxy = normalRangeMax;
                        }
                    }
                    if (options.get('chartRangeMin') !== undefined && (options.get('chartRangeClip') || options.get('chartRangeMin') < this.miny)) {
                        this.miny = options.get('chartRangeMin');
                    }
                    if (options.get('chartRangeMax') !== undefined && (options.get('chartRangeClip') || options.get('chartRangeMax') > this.maxy)) {
                        this.maxy = options.get('chartRangeMax');
                    }
                    if (options.get('chartRangeMinX') !== undefined && (options.get('chartRangeClipX') || options.get('chartRangeMinX') < this.minx)) {
                        this.minx = options.get('chartRangeMinX');
                    }
                    if (options.get('chartRangeMaxX') !== undefined && (options.get('chartRangeClipX') || options.get('chartRangeMaxX') > this.maxx)) {
                        this.maxx = options.get('chartRangeMaxX');
                    }

                },
                drawNormalRange: function (canvasLeft, canvasTop, canvasHeight, canvasWidth, rangey) {
                    var normalRangeMin = this.options.get('normalRangeMin'),
                        normalRangeMax = this.options.get('normalRangeMax'),
                        ytop = canvasTop + Math.round(canvasHeight - (canvasHeight * ((normalRangeMax - this.miny) / rangey))),
                        height = Math.round((canvasHeight * (normalRangeMax - normalRangeMin)) / rangey);
                    //(x1, y1, x2, y2, lineColor, lineWidth)
                    if(height==0 && normalRangeMin==normalRangeMax){
                        height=1;
                    }
                    this.target.drawRect(canvasLeft, ytop, canvasWidth, height, undefined, this.options.get('normalRangeColor')).append();
                },
                render: function (el,userValues) {
                    this.vertices = [];
                    this.regionMap = [];
                    this.xvalues = [];
                    this.yvalues = [];
                    this.yminmax = [];
                    this.hightlightSpotId = null;
                    this.lastShapeId = null;

                    this.values = userValues;

                    var options = this.options,
                        target = this.target,

                        canvasWidth = el.mergedOptions.width,
                        canvasHeight = el.mergedOptions.height,

                        vertices = this.vertices,
                        spotRadius = options.get('spotRadius'),
                        regionMap = this.regionMap,
                        rangex, rangey, yvallast,
                        canvasTop, canvasLeft,
                        vertex, path, paths, x, y, xnext, xpos, xposnext,
                        last, next, yvalcount, lineShapes, fillShapes, plen,
                        valueSpots, hlSpotsEnabled, color, xvalues, yvalues, i;

                    // if (!line._super.render.call(this)) {
                    //     return;
                    // }

                    this.scanValues();
                    this.processRangeOptions();

                    xvalues = this.xvalues;
                    yvalues = this.yvalues;

                    if (!this.yminmax.length || this.yvalues.length < 2) {
                        // empty or all null valuess
                        return;
                    }

                    canvasTop = canvasLeft = 0;

                    rangex = this.maxx - this.minx === 0 ? 1 : this.maxx - this.minx;
                    rangey = this.maxy - this.miny === 0 ? 1 : this.maxy - this.miny;
                    yvallast = this.yvalues.length - 1;

                    if (spotRadius && (canvasWidth < (spotRadius * 4) || canvasHeight < (spotRadius * 4))) {
                        spotRadius = 0;
                    }
                    if (spotRadius) {
                        // adjust the canvas size as required so that spots will fit
                        hlSpotsEnabled = options.get('highlightSpotColor') &&  !options.get('disableInteraction');
                        if (hlSpotsEnabled || options.get('minSpotColor') || (options.get('spotColor') && yvalues[yvallast] === this.miny)) {
                            canvasHeight -= Math.ceil(spotRadius);
                        }
                        if (hlSpotsEnabled || options.get('maxSpotColor') || (options.get('spotColor') && yvalues[yvallast] === this.maxy)) {
                            canvasHeight -= Math.ceil(spotRadius);
                            canvasTop += Math.ceil(spotRadius);
                        }
                        if (hlSpotsEnabled ||
                             ((options.get('minSpotColor') || options.get('maxSpotColor')) && (yvalues[0] === this.miny || yvalues[0] === this.maxy))) {
                            canvasLeft += Math.ceil(spotRadius);
                            canvasWidth -= Math.ceil(spotRadius);
                        }
                        if (hlSpotsEnabled || options.get('spotColor') ||
                            (options.get('minSpotColor') || options.get('maxSpotColor') &&
                                (yvalues[yvallast] === this.miny || yvalues[yvallast] === this.maxy))) {
                            canvasWidth -= Math.ceil(spotRadius);
                        }
                    }


                    canvasHeight--;

                    if (options.get('normalRangeMin') !== undefined && !options.get('drawNormalOnTop')) {
                        this.drawNormalRange(canvasLeft, canvasTop, canvasHeight, canvasWidth, rangey);
                    }

                    path = [];
                    paths = [path];
                    last = next = null;
                    yvalcount = yvalues.length;
                    for (i = 0; i < yvalcount; i++) {
                        x = xvalues[i];
                        xnext = xvalues[i + 1];
                        y = yvalues[i];
                        xpos = canvasLeft + Math.round((x - this.minx) * (canvasWidth / rangex));
                        xposnext = i < yvalcount - 1 ? canvasLeft + Math.round((xnext - this.minx) * (canvasWidth / rangex)) : canvasWidth;
                        next = xpos + ((xposnext - xpos) / 2);
                        regionMap[i] = [last || 0, next, i];
                        last = next;
                        if (y === null) {
                            if (i) {
                                if (yvalues[i - 1] !== null) {
                                    path = [];
                                    paths.push(path);
                                }
                                vertices.push(null);
                            }
                        } else {
                            if (y < this.miny) {
                                y = this.miny;
                            }
                            if (y > this.maxy) {
                                y = this.maxy;
                            }
                            if (!path.length) {
                                // previous value was null
                                path.push([xpos, canvasTop + canvasHeight]);
                            }
                            vertex = [xpos, canvasTop + Math.round(canvasHeight - (canvasHeight * ((y - this.miny) / rangey)))];
                            path.push(vertex);
                            vertices.push(vertex);
                        }
                    }

                    lineShapes = [];
                    fillShapes = [];
                    plen = paths.length;
                    for (i = 0; i < plen; i++) {
                        path = paths[i];
                        if (path.length) {
                            if (options.get('fillColor')) {
                                path.push([path[path.length - 1][0], (canvasTop + canvasHeight)]);
                                fillShapes.push(path.slice(0));
                                path.pop();
                            }
                            // if there's only a single point in this path, then we want to display it
                            // as a vertical line which means we keep path[0]  as is
                            if (path.length > 2) {
                                // else we want the first value
                                path[0] = [path[0][0], path[1][1]];
                            }
                            lineShapes.push(path);
                        }
                    }

                    // draw the fill first, then optionally the normal range, then the line on top of that
                    plen = fillShapes.length;
                    for (i = 0; i < plen; i++) {
                        target.drawShape(fillShapes[i],
                            options.get('fillColor'), options.get('fillColor')).append();
                    }



                    plen = lineShapes.length;
                    for (i = 0; i < plen; i++) {
                        target.drawShape(lineShapes[i], options.get('lineColor'), undefined,
                            options.get('lineWidth')).append();
                    }

                    if (options.get('normalRangeMin') !== undefined && options.get('drawNormalOnTop')) {
                        this.drawNormalRange(canvasLeft, canvasTop, canvasHeight, canvasWidth, rangey);
                    }
                    
                    if (spotRadius && options.get('valueSpots')) {
                        valueSpots = options.get('valueSpots');
                        if (valueSpots.get === undefined) {
                            valueSpots = new RangeMap(valueSpots);
                        }
                        for (i = 0; i < yvalcount; i++) {
                            color = valueSpots.get(yvalues[i]);
                            if (color) {
                                target.drawCircle(canvasLeft + Math.round((xvalues[i] - this.minx) * (canvasWidth / rangex)),
                                    canvasTop + Math.round(canvasHeight - (canvasHeight * ((yvalues[i] - this.miny) / rangey))),
                                    spotRadius, undefined,
                                    color).append();
                            }
                        }

                    }
                    if (spotRadius && options.get('spotColor') && yvalues[yvallast] !== null) {
                        target.drawCircle(canvasLeft + Math.round((xvalues[xvalues.length - 1] - this.minx) * (canvasWidth / rangex)),
                            canvasTop + Math.round(canvasHeight - (canvasHeight * ((yvalues[yvallast] - this.miny) / rangey))),
                            spotRadius, undefined,
                            options.get('spotColor')).append();
                    }
                    if (this.maxy !== this.minyorg) {
                        if (spotRadius && options.get('minSpotColor')) {
                            x = xvalues[$.inArray(this.minyorg, yvalues)];
                            target.drawCircle(canvasLeft + Math.round((x - this.minx) * (canvasWidth / rangex)),
                                canvasTop + Math.round(canvasHeight - (canvasHeight * ((this.minyorg - this.miny) / rangey))),
                                spotRadius, undefined,
                                options.get('minSpotColor')).append();
                        }
                        if (spotRadius && options.get('maxSpotColor')) {
                            x = xvalues[$.inArray(this.maxyorg, yvalues)];
                            target.drawCircle(canvasLeft + Math.round((x - this.minx) * (canvasWidth / rangex)),
                                canvasTop + Math.round(canvasHeight - (canvasHeight * ((this.maxyorg - this.miny) / rangey))),
                                spotRadius, undefined,
                                options.get('maxSpotColor')).append();
                        }
                    }

                    // this.lastShapeId = target.getLastShapeId();
                    // this.canvasTop = canvasTop;
                    // target.render();

                }
            },
            bar:{
                type: 'bar',

                init: function (el, values) {
                    var options = this.options;
                    var width = el.mergedOptions.height;
                    var height = el.mergedOptions.width;

                    this.canvasWidth = el.mergedOptions.height;
                    this.canvasHeight = el.mergedOptions.width;

                    var barWidth = parseInt(options.get('barWidth'), 10),
                        barSpacing = parseInt(options.get('barSpacing'), 10),
                        chartRangeMin = options.get('chartRangeMin'),
                        chartRangeMax = options.get('chartRangeMax'),
                        chartRangeClip = options.get('chartRangeClip'),
                        stackMin = Infinity,
                        stackMax = -Infinity,
                        isStackString, groupMin, groupMax, stackRanges,
                        numValues, i, vlen, range, zeroAxis, xaxisOffset, min, max, clipMin, clipMax,
                        stacked, vlist, j, slen, svals, val, yoffset, yMaxCalc, canvasHeightEf;
                    //bar._super.init.call(this, el, values, options, width, height);

                    this.values = values;

                    // scan values to determine whether to stack bars
                    for (i = 0, vlen = values.length; i < vlen; i++) {
                        val = values[i];
                        isStackString = typeof(val) === 'string' && val.indexOf(':') > -1;
                        if (isStackString || $.isArray(val)) {
                            stacked = true;
                            if (isStackString) {
                                val = values[i] = normalizeValues(val.split(':'));
                            }
                            val = remove(val, null); // min/max will treat null as zero
                            groupMin = Math.min.apply(Math, val);
                            groupMax = Math.max.apply(Math, val);
                            if (groupMin < stackMin) {
                                stackMin = groupMin;
                            }
                            if (groupMax > stackMax) {
                                stackMax = groupMax;
                            }
                        }
                    }

                    this.stacked = stacked;
                    this.regionShapes = {};
                    this.barWidth = Math.floor(width/values.length)-barSpacing;
                    this.barSpacing = barSpacing;
                    this.totalBarWidth = this.barWidth + barSpacing;
                    //this.width = width = (values.length * barWidth) + ((values.length - 1) * barSpacing);
                    this.width = width;
                    //this.initTarget();

                    if (chartRangeClip) {
                        clipMin = chartRangeMin === undefined ? -Infinity : chartRangeMin;
                        clipMax = chartRangeMax === undefined ? Infinity : chartRangeMax;
                    }

                    numValues = [];
                    stackRanges = stacked ? [] : numValues;
                    var stackTotals = [];
                    var stackRangesNeg = [];
                    for (i = 0, vlen = values.length; i < vlen; i++) {
                        if (stacked) {
                            vlist = values[i];
                            values[i] = svals = [];
                            stackTotals[i] = 0;
                            stackRanges[i] = stackRangesNeg[i] = 0;
                            for (j = 0, slen = vlist.length; j < slen; j++) {
                                val = svals[j] = chartRangeClip ? clipval(vlist[j], clipMin, clipMax) : vlist[j];
                                if (val !== null) {
                                    if (val > 0) {
                                        stackTotals[i] += val;
                                    }
                                    if (stackMin < 0 && stackMax > 0) {
                                        if (val < 0) {
                                            stackRangesNeg[i] += Math.abs(val);
                                        } else {
                                            stackRanges[i] += val;
                                        }
                                    } else {
                                        stackRanges[i] += Math.abs(val);
                                        // stackRanges[i] += Math.abs(val - (val < 0 ? stackMax : stackMin));
                                    }
                                    numValues.push(val);
                                }
                            }
                        } else {
                            val = chartRangeClip ? clipval(values[i], clipMin, clipMax) : values[i];
                            val = values[i] = normalizeValue(val);
                            if (val !== null) {
                                numValues.push(val);
                            }
                        }
                    }
                    this.max = max = Math.max.apply(Math, numValues);
                    this.min = min = Math.min.apply(Math, numValues);
                    this.stackMax = stackMax = stacked ? Math.max.apply(Math, stackTotals) : max;
                    this.stackMin = stackMin = stacked ? Math.min.apply(Math, numValues) : min;

                    if (options.get('chartRangeMin') !== undefined && (options.get('chartRangeClip') || options.get('chartRangeMin') < min)) {
                        min = options.get('chartRangeMin');
                    }
                    if (options.get('chartRangeMax') !== undefined && (options.get('chartRangeClip') || options.get('chartRangeMax') > max)) {
                        max = options.get('chartRangeMax');
                    }

                    this.zeroAxis = zeroAxis = options.get('zeroAxis', true);
                    if (min <= 0 && max >= 0 && zeroAxis) {
                        xaxisOffset = 0;
                    } else if (zeroAxis == false) {
                        xaxisOffset = min;
                    } else if (min > 0) {
                        xaxisOffset = 0;
                    } else {
                        xaxisOffset = max;
                    }
                    this.xaxisOffset = xaxisOffset;

                    range = stacked ? (Math.max.apply(Math, stackRanges) + Math.max.apply(Math, stackRangesNeg)) : max - xaxisOffset;

                    // as we plot zero/min values a single pixel line, we add a pixel to all other
                    // values - Reduce the effective canvas size to suit
                    this.canvasHeightEf = (zeroAxis && min < 0) ? this.canvasHeight - 2 : this.canvasHeight - 1;
                    this.isNeg = false;
                    if (min < xaxisOffset) {
                        // yMaxCalc = (stacked && max >= 0) ? stackMax : max;
                        // yoffset = (yMaxCalc - xaxisOffset) / range * this.canvasHeight;
                        yoffset = Math.floor(this.canvasHeight/2);
                        this.isNeg = true;
                        if (yoffset !== Math.ceil(yoffset)) {
                            this.canvasHeightEf -= 2;
                            yoffset = Math.ceil(yoffset);
                        }
                    } else {
                        yoffset = 0;
                    }
                    this.yoffset = yoffset;

                    if ($.isArray(options.get('colorMap'))) {
                        this.colorMapByIndex = options.get('colorMap');
                        this.colorMapByValue = null;
                    } else {
                        this.colorMapByIndex = null;
                        this.colorMapByValue = options.get('colorMap');
                        if (this.colorMapByValue && this.colorMapByValue.get === undefined) {
                            this.colorMapByValue = new RangeMap(this.colorMapByValue);
                        }
                    }

                    this.range = range;
                },

                getRegion: function (el, x, y) {
                    var result = Math.floor(x / this.totalBarWidth);
                    return (result < 0 || result >= this.values.length) ? undefined : result;
                },

                getCurrentRegionFields: function () {
                    var currentRegion = this.currentRegion,
                        values = ensureArray(this.values[currentRegion]),
                        result = [],
                        value, i;
                    for (i = values.length; i--;) {
                        value = values[i];
                        result.push({
                            isNull: value === null,
                            value: value,
                            color: this.calcColor(i, value, currentRegion),
                            offset: currentRegion
                        });
                    }
                    return result;
                },

                calcColor: function (stacknum, value, valuenum) {
                    var colorMapByIndex = this.colorMapByIndex,
                        colorMapByValue = this.colorMapByValue,
                        options = this.options,
                        color, newColor;
                    if (this.stacked) {
                        color = options.get('stackedBarColor');
                    } else {
                        color = (value < 0) ? options.get('negBarColor') : options.get('barColor');
                    }
                    if (value === 0 && options.get('zeroColor') !== undefined) {
                        color = options.get('zeroColor');
                    }
                    if (colorMapByValue && (newColor = colorMapByValue.get(value))) {
                        color = newColor;
                    } else if (colorMapByIndex && colorMapByIndex.length > valuenum) {
                        color = colorMapByIndex[valuenum];
                    }
                    return $.isArray(color) ? color[stacknum % color.length] : color;
                },

                /**
                 * Render bar(s) for a region
                 */
                renderRegion: function (valuenum, highlight) {
                    var vals = this.values[valuenum],
                        options = this.options,
                        xaxisOffset = this.xaxisOffset,
                        result = [],
                        range = this.range,
                        stacked = this.stacked,
                        target = this.target,
                        x = valuenum * this.totalBarWidth,
                        canvasHeightEf = this.canvasHeightEf,
                        yoffset = this.yoffset,
                        y, height, color, isNull, yoffsetNeg, i, valcount, val, minPlotted, allMin;

                    vals = $.isArray(vals) ? vals : [vals];
                    valcount = vals.length;
                    val = vals[0];
                    isNull = all(null, vals);
                    allMin = all(xaxisOffset, vals, true);

                    if (isNull) {
                        if (options.get('nullColor')) {
                            color = highlight ? options.get('nullColor') : this.calcHighlightColor(options.get('nullColor'), options);
                            y = (yoffset > 0) ? yoffset - 1 : yoffset;
                            return target.drawRect(y, x, 0, this.barWidth - 1, color, color);
                        } else {
                            return undefined;
                        }
                    }
                    yoffsetNeg = yoffset;
                    if(this.isNeg){
                        canvasHeightEf = Math.floor(canvasHeightEf/2);
                    }
                    for (i = 0; i < valcount; i++) {
                        val = vals[i];

                        if (stacked && val === xaxisOffset) {
                            if (!allMin || minPlotted) {
                                continue;
                            }
                            minPlotted = true;
                        }

                        if (range > 0) {
                            height = Math.floor(canvasHeightEf * ((Math.abs(val - xaxisOffset) / range)));
                        } else {
                            height = canvasHeightEf;
                        }

                        if (val < xaxisOffset || (val === xaxisOffset && yoffset === 0)) {
                            y = yoffsetNeg - height;
                            yoffsetNeg += height;
                        } else {
                            if(stacked){
                                y = yoffset;
                                yoffset += height;
                            }
                            else{
                                y = yoffset;
                                yoffset -= height;
                            }
                            
                        }
                        color = this.calcColor(i, val, valuenum);
                        if (highlight) {
                            color = this.calcHighlightColor(color, options);
                        }
                        result.push(target.drawRect(y, x,  height - 1, this.barWidth - 1,color, color));
                    }
                    if (result.length === 1) {
                        return result[0];
                    }
                    return result;
                }
            },
            column:{
                type: 'column',

                init: function (el, values) {
                    var options = this.options;
                    var width = el.mergedOptions.width;
                    var height = el.mergedOptions.height;

                    this.canvasWidth = el.mergedOptions.width;
                    this.canvasHeight = el.mergedOptions.height;

                    var barWidth = parseInt(options.get('barWidth'), 10),
                        barSpacing = parseInt(options.get('barSpacing'), 10),
                        chartRangeMin = options.get('chartRangeMin'),
                        chartRangeMax = options.get('chartRangeMax'),
                        chartRangeClip = options.get('chartRangeClip'),
                        stackMin = Infinity,
                        stackMax = -Infinity,
                        isStackString, groupMin, groupMax, stackRanges,
                        numValues, i, vlen, range, zeroAxis, xaxisOffset, min, max, clipMin, clipMax,
                        stacked, vlist, j, slen, svals, val, yoffset, yMaxCalc, canvasHeightEf;
                    //bar._super.init.call(this, el, values, options, width, height);

                    this.values = values;

                    // scan values to determine whether to stack bars
                    for (i = 0, vlen = values.length; i < vlen; i++) {
                        val = values[i];
                        isStackString = typeof(val) === 'string' && val.indexOf(':') > -1;
                        if (isStackString || $.isArray(val)) {
                            stacked = true;
                            if (isStackString) {
                                val = values[i] = normalizeValues(val.split(':'));
                            }
                            val = remove(val, null); // min/max will treat null as zero
                            groupMin = Math.min.apply(Math, val);
                            groupMax = Math.max.apply(Math, val);
                            if (groupMin < stackMin) {
                                stackMin = groupMin;
                            }
                            if (groupMax > stackMax) {
                                stackMax = groupMax;
                            }
                        }
                    }

                    this.stacked = stacked;
                    this.regionShapes = {};
                    this.barWidth = Math.floor(width/values.length)-barSpacing;
                    this.barSpacing = barSpacing;
                    this.totalBarWidth = this.barWidth + barSpacing;
                    //this.width = width = (values.length * barWidth) + ((values.length - 1) * barSpacing);
                    this.width = width;
                    //this.initTarget();

                    if (chartRangeClip) {
                        clipMin = chartRangeMin === undefined ? -Infinity : chartRangeMin;
                        clipMax = chartRangeMax === undefined ? Infinity : chartRangeMax;
                    }

                    numValues = [];
                    stackRanges = stacked ? [] : numValues;
                    var stackTotals = [];
                    var stackRangesNeg = [];
                    for (i = 0, vlen = values.length; i < vlen; i++) {
                        if (stacked) {
                            vlist = values[i];
                            values[i] = svals = [];
                            stackTotals[i] = 0;
                            stackRanges[i] = stackRangesNeg[i] = 0;
                            for (j = 0, slen = vlist.length; j < slen; j++) {
                                val = svals[j] = chartRangeClip ? clipval(vlist[j], clipMin, clipMax) : vlist[j];
                                if (val !== null) {
                                    if (val > 0) {
                                        stackTotals[i] += val;
                                    }
                                    if (stackMin < 0 && stackMax > 0) {
                                        if (val < 0) {
                                            stackRangesNeg[i] += Math.abs(val);
                                        } else {
                                            stackRanges[i] += val;
                                        }
                                    } else {
                                        stackRanges[i] += Math.abs(val);
                                        // stackRanges[i] += Math.abs(val - (val < 0 ? stackMax : stackMin));
                                    }
                                    numValues.push(val);
                                }
                            }
                        } else {
                            val = chartRangeClip ? clipval(values[i], clipMin, clipMax) : values[i];
                            val = values[i] = normalizeValue(val);
                            if (val !== null) {
                                numValues.push(val);
                            }
                        }
                    }
                    this.max = max = Math.max.apply(Math, numValues);
                    this.min = min = Math.min.apply(Math, numValues);
                    this.stackMax = stackMax = stacked ? Math.max.apply(Math, stackTotals) : max;
                    this.stackMin = stackMin = stacked ? Math.min.apply(Math, numValues) : min;

                    if (options.get('chartRangeMin') !== undefined && (options.get('chartRangeClip') || options.get('chartRangeMin') < min)) {
                        min = options.get('chartRangeMin');
                    }
                    if (options.get('chartRangeMax') !== undefined && (options.get('chartRangeClip') || options.get('chartRangeMax') > max)) {
                        max = options.get('chartRangeMax');
                    }

                    this.zeroAxis = zeroAxis = options.get('zeroAxis', true);
                    if (min <= 0 && max >= 0 && zeroAxis) {
                        xaxisOffset = 0;
                    } else if (zeroAxis == false) {
                        xaxisOffset = min;
                    } else if (min > 0) {
                        xaxisOffset = 0;
                    } else {
                        xaxisOffset = max;
                    }
                    this.xaxisOffset = xaxisOffset;

                    range = stacked ? (Math.max.apply(Math, stackRanges) + Math.max.apply(Math, stackRangesNeg)) : max - xaxisOffset;

                    // as we plot zero/min values a single pixel line, we add a pixel to all other
                    // values - Reduce the effective canvas size to suit
                    this.canvasHeightEf = (zeroAxis && min < 0) ? this.canvasHeight - 2 : this.canvasHeight - 1;
                    this.isNeg = false;
                    if (min < xaxisOffset) {
                        // yMaxCalc = (stacked && max >= 0) ? stackMax : max;
                        // yoffset = (yMaxCalc - xaxisOffset) / range * this.canvasHeight;
                        yoffset = Math.floor(this.canvasHeight/2);
                        this.isNeg = true;
                        if (yoffset !== Math.ceil(yoffset)) {
                            this.canvasHeightEf -= 2;
                            yoffset = Math.ceil(yoffset);
                        }
                    } else {
                        yoffset = this.canvasHeight;
                    }
                    this.yoffset = yoffset;

                    if ($.isArray(options.get('colorMap'))) {
                        this.colorMapByIndex = options.get('colorMap');
                        this.colorMapByValue = null;
                    } else {
                        this.colorMapByIndex = null;
                        this.colorMapByValue = options.get('colorMap');
                        if (this.colorMapByValue && this.colorMapByValue.get === undefined) {
                            this.colorMapByValue = new RangeMap(this.colorMapByValue);
                        }
                    }

                    this.range = range;
                },

                getRegion: function (el, x, y) {
                    var result = Math.floor(x / this.totalBarWidth);
                    return (result < 0 || result >= this.values.length) ? undefined : result;
                },

                getCurrentRegionFields: function () {
                    var currentRegion = this.currentRegion,
                        values = ensureArray(this.values[currentRegion]),
                        result = [],
                        value, i;
                    for (i = values.length; i--;) {
                        value = values[i];
                        result.push({
                            isNull: value === null,
                            value: value,
                            color: this.calcColor(i, value, currentRegion),
                            offset: currentRegion
                        });
                    }
                    return result;
                },

                calcColor: function (stacknum, value, valuenum) {
                    var colorMapByIndex = this.colorMapByIndex,
                        colorMapByValue = this.colorMapByValue,
                        options = this.options,
                        color, newColor;
                    if (this.stacked) {
                        color = options.get('stackedBarColor');
                    } else {
                        color = (value < 0) ? options.get('negBarColor') : options.get('barColor');
                    }
                    if (value === 0 && options.get('zeroColor') !== undefined) {
                        color = options.get('zeroColor');
                    }
                    if (colorMapByValue && (newColor = colorMapByValue.get(value))) {
                        color = newColor;
                    } else if (colorMapByIndex && colorMapByIndex.length > valuenum) {
                        color = colorMapByIndex[valuenum];
                    }
                    return $.isArray(color) ? color[stacknum % color.length] : color;
                },

                /**
                 * Render bar(s) for a region
                 */
                renderRegion: function (valuenum, highlight) {
                    var vals = this.values[valuenum],
                        options = this.options,
                        xaxisOffset = this.xaxisOffset,
                        result = [],
                        range = this.range,
                        stacked = this.stacked,
                        target = this.target,
                        x = valuenum * this.totalBarWidth,
                        canvasHeightEf = this.canvasHeightEf,
                        yoffset = this.yoffset,
                        y, height, color, isNull, yoffsetNeg, i, valcount, val, minPlotted, allMin;

                    vals = $.isArray(vals) ? vals : [vals];
                    valcount = vals.length;
                    val = vals[0];
                    isNull = all(null, vals);
                    allMin = all(xaxisOffset, vals, true);

                    if (isNull) {
                        if (options.get('nullColor')) {
                            color = highlight ? options.get('nullColor') : this.calcHighlightColor(options.get('nullColor'), options);
                            y = (yoffset > 0) ? yoffset - 1 : yoffset;
                            return target.drawRect(x, y, this.barWidth - 1, 0, color, color);
                        } else {
                            return undefined;
                        }
                    }
                    yoffsetNeg = yoffset;
                    if(this.isNeg){
                        canvasHeightEf = Math.floor(canvasHeightEf/2);
                    }
                    for (i = 0; i < valcount; i++) {
                        val = vals[i];

                        if (stacked && val === xaxisOffset) {
                            if (!allMin || minPlotted) {
                                continue;
                            }
                            minPlotted = true;
                        }

                        if (range > 0) {
                            height = Math.floor(canvasHeightEf * ((Math.abs(val - xaxisOffset) / range)));
                        } else {
                            height = canvasHeightEf;
                        }

                        if (val < xaxisOffset || (val === xaxisOffset && yoffset === 0)) {
                            y = yoffsetNeg;
                            yoffsetNeg += height;
                        } else {
                            y = yoffset - height;
                            yoffset -= height;
                        }
                        color = this.calcColor(i, val, valuenum);
                        if (highlight) {
                            color = this.calcHighlightColor(color, options);
                        }
                        result.push(target.drawRect(x, y, this.barWidth - 1, height - 1, color, color));
                    }
                    if (result.length === 1) {
                        return result[0];
                    }
                    return result;
                }
            },
            tristate:{
                type: 'tristate',
                init: function(el, values) {
                    var options = this.options;
                    var width = el.mergedOptions.width;
                    var height = el.mergedOptions.height;

                    this.canvasWidth = el.mergedOptions.width;
                    this.canvasHeight = el.mergedOptions.height;

                    var barWidth = parseInt(options.get('barWidth'), 10),
                        barSpacing = parseInt(options.get('barSpacing'), 10);
                    //tristate._super.init.call(this, el, values, options, width, height);

                    this.regionShapes = {};
                    this.barWidth = barWidth;
                    this.barSpacing = barSpacing;
                    this.totalBarWidth = barWidth + barSpacing;
                    this.values = $.map(values, Number);
                    this.width = width = (values.length * barWidth) + ((values.length - 1) * barSpacing);

                    if ($.isArray(options.get('colorMap'))) {
                        this.colorMapByIndex = options.get('colorMap');
                        this.colorMapByValue = null;
                    } else {
                        this.colorMapByIndex = null;
                        this.colorMapByValue = options.get('colorMap');
                        if (this.colorMapByValue && this.colorMapByValue.get === undefined) {
                            this.colorMapByValue = new RangeMap(this.colorMapByValue);
                        }
                    }
                    //this.initTarget();
                },

                getRegion: function (el, x, y) {
                    return Math.floor(x / this.totalBarWidth);
                },

                getCurrentRegionFields: function () {
                    var currentRegion = this.currentRegion;
                    return {
                        isNull: this.values[currentRegion] === undefined,
                        value: this.values[currentRegion],
                        color: this.calcColor(this.values[currentRegion], currentRegion),
                        offset: currentRegion
                    };
                },

                calcColor: function (value, valuenum) {
                    var values = this.values,
                        options = this.options,
                        colorMapByIndex = this.colorMapByIndex,
                        colorMapByValue = this.colorMapByValue,
                        color, newColor;

                    if (colorMapByValue && (newColor = colorMapByValue.get(value))) {
                        color = newColor;
                    } else if (colorMapByIndex && colorMapByIndex.length > valuenum) {
                        color = colorMapByIndex[valuenum];
                    } else if (values[valuenum] < 0) {
                        color = options.get('negBarColor');
                    } else if (values[valuenum] > 0) {
                        color = options.get('posBarColor');
                    } else {
                        color = options.get('zeroBarColor');
                    }
                    return color;
                },

                renderRegion: function (valuenum, highlight) {
                    var values = this.values,
                        options = this.options,
                        target = this.target,
                        canvasHeight, height, halfHeight,
                        x, y, color;

                    canvasHeight = this.canvasHeight;
                    halfHeight = Math.round(canvasHeight / 2);

                    x = valuenum * this.totalBarWidth;
                    if (values[valuenum] < 0) {
                        y = halfHeight;
                        height = halfHeight - 1;
                    } else if (values[valuenum] > 0) {
                        y = 0;
                        height = halfHeight - 1;
                    } else {
                        y = halfHeight - 1;
                        height = 2;
                    }
                    color = this.calcColor(values[valuenum], valuenum);
                    if (color === null) {
                        return;
                    }
                    if (highlight) {
                        color = this.calcHighlightColor(color, options);
                    }
                    return target.drawRect(x, y, this.barWidth - 1, height - 1, color, color);
                }
            },
            discrete:{
                type: 'discrete',

                init: function(el, values) {
                    var options = this.options;
                    var width = el.mergedOptions.width;
                    var height = el.mergedOptions.height;

                    this.canvasWidth = el.mergedOptions.width;
                    this.canvasHeight = el.mergedOptions.height;

                    this.regionShapes = {};
                    this.values = values = $.map(values, Number);
                    this.min = Math.min.apply(Math, values);
                    this.max = Math.max.apply(Math, values);
                    this.range = this.max - this.min;
                    this.width = width;
                    this.interval = Math.floor(width / values.length);
                    this.itemWidth = width / values.length;
                    if (options.get('chartRangeMin') !== undefined && (options.get('chartRangeClip') || options.get('chartRangeMin') < this.min)) {
                        this.min = options.get('chartRangeMin');
                    }
                    if (options.get('chartRangeMax') !== undefined && (options.get('chartRangeClip') || options.get('chartRangeMax') > this.max)) {
                        this.max = options.get('chartRangeMax');
                    }
                    //this.initTarget();
                    if (this.target) {
                        this.lineHeight = options.get('lineHeight') === 'auto' ? Math.round(this.canvasHeight * 0.3) : options.get('lineHeight');
                    }
                },

                getRegion: function (el, x, y) {
                    return Math.floor(x / this.itemWidth);
                },

                getCurrentRegionFields: function () {
                    var currentRegion = this.currentRegion;
                    return {
                        isNull: this.values[currentRegion] === undefined,
                        value: this.values[currentRegion],
                        offset: currentRegion
                    };
                },

                renderRegion: function (valuenum, highlight) {
                    var values = this.values,
                        options = this.options,
                        min = this.min,
                        max = this.max,
                        range = this.range,
                        interval = this.interval,
                        target = this.target,
                        canvasHeight = this.canvasHeight,
                        lineHeight = this.lineHeight,
                        pheight = canvasHeight - lineHeight,
                        ytop, val, color, x;

                    val = clipval(values[valuenum], min, max);
                    x = valuenum * interval;
                    ytop = Math.round(pheight - pheight * ((val - min) / range));
                    color = (options.get('thresholdColor') && val < options.get('thresholdValue')) ? options.get('thresholdColor') : options.get('lineColor');
                    if (highlight) {
                        color = this.calcHighlightColor(color, options);
                    }
                    //return target.drawLine(x, ytop, x, ytop + lineHeight, color);

                    return this.target.drawRect(x, ytop, interval<=2?1:interval-2, lineHeight, color, color);
                }
            },
            bullet:{
                type: 'bullet',
                init: function(el, values) {

                    var options = this.options;
                    var width = el.mergedOptions.width;
                    var height = el.mergedOptions.height;

                    this.canvasWidth = el.mergedOptions.width;
                    this.canvasHeight = el.mergedOptions.height;

                    var min, max, vals;
                    //bullet._super.init.call(this, el, values, options, width, height);

                    // values: target, performance, range1, range2, range3
                    this.values = values = normalizeValues(values);
                    // target or performance could be null
                    vals = values.slice();
                    vals[0] = vals[0] === null ? vals[2] : vals[0];
                    vals[1] = values[1] === null ? vals[2] : vals[1];
                    min = Math.min.apply(Math, values);
                    max = Math.max.apply(Math, values);
                    if (options.get('base') === undefined) {
                        min = min < 0 ? min : 0;
                    } else {
                        min = options.get('base');
                    }
                    this.min = min;
                    this.max = max;
                    this.range = max - min;
                    this.shapes = {};
                    this.valueShapes = {};
                    this.regiondata = {};
                    this.width = width;
                    //this.target = this.$el.simpledraw(width, height, options.get('composite'));
                    if (!values.length) {
                        this.disabled = true;
                    }
                    //this.initTarget();
                },

                getRegion: function (el, x, y) {
                    var shapeid = this.target.getShapeAt(el, x, y);
                    return (shapeid !== undefined && this.shapes[shapeid] !== undefined) ? this.shapes[shapeid] : undefined;
                },

                getCurrentRegionFields: function () {
                    var currentRegion = this.currentRegion;
                    return {
                        fieldkey: currentRegion.substr(0, 1),
                        value: this.values[currentRegion.substr(1)],
                        region: currentRegion
                    };
                },

                changeHighlight: function (highlight) {
                    var currentRegion = this.currentRegion,
                        shapeid = this.valueShapes[currentRegion],
                        shape;
                    delete this.shapes[shapeid];
                    switch (currentRegion.substr(0, 1)) {
                        case 'r':
                            shape = this.renderRange(currentRegion.substr(1), highlight);
                            break;
                        case 'p':
                            shape = this.renderPerformance(highlight);
                            break;
                        case 't':
                            shape = this.renderTarget(highlight);
                            break;
                    }
                    this.valueShapes[currentRegion] = shape.id;
                    this.shapes[shape.id] = currentRegion;
                    this.target.replaceWithShape(shapeid, shape);
                },

                renderRange: function (rn, highlight) {
                    var rangeval = this.values[rn],
                        rangewidth = Math.round(this.canvasWidth * ((rangeval - this.min) / this.range)),
                        color = this.options.get('rangeColors')[rn - 2];
                    if (highlight) {
                        color = this.calcHighlightColor(color, this.options);
                    }
                    return this.target.drawRect(0, 0, rangewidth - 1, this.canvasHeight - 1, color, color);
                },

                renderPerformance: function (highlight) {
                    var perfval = this.values[1],
                        perfwidth = Math.round(this.canvasWidth * ((perfval - this.min) / this.range)),
                        color = this.options.get('performanceColor');
                    if (highlight) {
                        color = this.calcHighlightColor(color, this.options);
                    }
                    return this.target.drawRect(0, Math.round(this.canvasHeight * 0.3), perfwidth - 1,
                        Math.round(this.canvasHeight * 0.4) - 1, color, color);
                },

                renderTarget: function (highlight) {
                    var targetval = this.values[0],
                        x = Math.round(this.canvasWidth * ((targetval - this.min) / this.range) - (this.options.get('targetWidth') / 2)),
                        targettop = Math.round(this.canvasHeight * 0.10),
                        targetheight = this.canvasHeight - (targettop * 2),
                        color = this.options.get('targetColor');
                    if (highlight) {
                        color = this.calcHighlightColor(color, this.options);
                    }
                    return this.target.drawRect(x, targettop, this.options.get('targetWidth') - 1, targetheight - 1, color, color);
                },

                render: function (el,userValues) {
                    this.init(el,userValues);
                    var vlen = this.values.length,
                        target = this.target,
                        i, shape;
                    // if (!bullet._super.render.call(this)) {
                    //     return;
                    // }
                    for (i = 2; i < vlen; i++) {
                        shape = this.renderRange(i).append();
                        this.shapes[shape.id] = 'r' + i;
                        this.valueShapes['r' + i] = shape.id;
                    }
                    if (this.values[1] !== null) {
                        shape = this.renderPerformance().append();
                        this.shapes[shape.id] = 'p1';
                        this.valueShapes.p1 = shape.id;
                    }
                    if (this.values[0] !== null) {
                        shape = this.renderTarget().append();
                        this.shapes[shape.id] = 't0';
                        this.valueShapes.t0 = shape.id;
                    }
                    //target.render();
                }
            },
            pie:{
                type: 'pie',

                init: function(el, values) {

                    var options = this.options;
                    var width = el.mergedOptions.width;
                    var height = el.mergedOptions.height;

                    this.canvasWidth = el.mergedOptions.width;
                    this.canvasHeight = el.mergedOptions.height;

                    var total = 0, i;

                    //pie._super.init.call(this, el, values, options, width, height);

                    this.shapes = {}; // map shape ids to value offsets
                    this.valueShapes = {}; // maps value offsets to shape ids
                    this.values = values = $.map(values, Number);

                    if (options.get('width') === 'auto') {
                        this.width = this.height;
                    }

                    if (values.length > 0) {
                        for (i = values.length; i--;) {
                            total += values[i];
                        }
                    }
                    this.total = total;
                    //this.initTarget();
                    this.radius = Math.floor(Math.min(this.canvasWidth, this.canvasHeight) / 2);
                },

                getRegion: function (el, x, y) {
                    var shapeid = this.target.getShapeAt(el, x, y);
                    return (shapeid !== undefined && this.shapes[shapeid] !== undefined) ? this.shapes[shapeid] : undefined;
                },

                getCurrentRegionFields: function () {
                    var currentRegion = this.currentRegion;
                    return {
                        isNull: this.values[currentRegion] === undefined,
                        value: this.values[currentRegion],
                        percent: this.values[currentRegion] / this.total * 100,
                        color: this.options.get('sliceColors')[currentRegion % this.options.get('sliceColors').length],
                        offset: currentRegion
                    };
                },

                changeHighlight: function (highlight) {
                    var currentRegion = this.currentRegion,
                         newslice = this.renderSlice(currentRegion, highlight),
                         shapeid = this.valueShapes[currentRegion];
                    delete this.shapes[shapeid];
                    this.target.replaceWithShape(shapeid, newslice);
                    this.valueShapes[currentRegion] = newslice.id;
                    this.shapes[newslice.id] = currentRegion;
                },

                renderSlice: function (valuenum, highlight) {
                    var target = this.target,
                        options = this.options,
                        radius = this.radius,
                        borderWidth = options.get('borderWidth'),
                        offset = options.get('offset'),
                        circle = 2 * Math.PI,
                        values = this.values,
                        total = this.total,
                        next = offset ? (2*Math.PI)*(offset/360) : 0,
                        start, end, i, vlen, color;

                    vlen = values.length;
                    for (i = 0; i < vlen; i++) {
                        start = next;
                        end = next;
                        if (total > 0) {  // avoid divide by zero
                            end = next + (circle * (values[i] / total));
                        }
                        if (valuenum === i) {
                            color = options.get('sliceColors')[i % options.get('sliceColors').length];
                            if (highlight) {
                                color = this.calcHighlightColor(color, options);
                            }

                            return target.drawPieSlice(radius, radius, radius - borderWidth, start, end, undefined, color);
                        }
                        next = end;
                    }
                },

                render: function (el,userValues) {
                    this.init(el,userValues);
                    var target = this.target,
                        values = this.values,
                        options = this.options,
                        radius = this.radius,
                        borderWidth = options.get('borderWidth'),
                        shape, i;

                    // if (!pie._super.render.call(this)) {
                    //     return;
                    // }
                    if (borderWidth) {
                        target.drawCircle(radius, radius, Math.floor(radius - (borderWidth / 2)),
                            options.get('borderColor'), undefined, borderWidth).append();
                    }
                    for (i = values.length; i--;) {
                        if (values[i]) { // don't render zero values
                            shape = this.renderSlice(i).append();
                            this.valueShapes[i] = shape.id; // store just the shapeid
                            this.shapes[shape.id] = i;
                        }
                    }
                    //target.render();
                }
            },
            box:{
                type: 'box',

                init: function(el, values) {

                    var options = this.options;
                    var width = el.mergedOptions.width;
                    var height = el.mergedOptions.height;

                    this.canvasWidth = el.mergedOptions.width;
                    this.canvasHeight = el.mergedOptions.height;

                    //box._super.init.call(this, el, values, options, width, height);
                    this.values = $.map(values, Number);
                    this.width = options.get('width') === 'auto' ? '4.0em' : width;
                    //this.initTarget();
                    if (!this.values.length) {
                        this.disabled = 1;
                    }
                },

                /**
                 * Simulate a single region
                 */
                getRegion: function () {
                    return 1;
                },

                getCurrentRegionFields: function () {
                    var result = [
                        { field: 'lq', value: this.quartiles[0] },
                        { field: 'med', value: this.quartiles[1] },
                        { field: 'uq', value: this.quartiles[2] }
                    ];
                    if (this.loutlier !== undefined) {
                        result.push({ field: 'lo', value: this.loutlier});
                    }
                    if (this.routlier !== undefined) {
                        result.push({ field: 'ro', value: this.routlier});
                    }
                    if (this.lwhisker !== undefined) {
                        result.push({ field: 'lw', value: this.lwhisker});
                    }
                    if (this.rwhisker !== undefined) {
                        result.push({ field: 'rw', value: this.rwhisker});
                    }
                    return result;
                },

                render:  function (el,userValues) {
                    this.init(el,userValues);

                    var target = this.target,
                        values = this.values,
                        vlen = values.length,
                        options = this.options,
                        canvasWidth = this.canvasWidth,
                        canvasHeight = this.canvasHeight,
                        minValue = options.get('chartRangeMin') === undefined ? Math.min.apply(Math, values) : options.get('chartRangeMin'),
                        maxValue = options.get('chartRangeMax') === undefined ? Math.max.apply(Math, values) : options.get('chartRangeMax'),
                        canvasLeft = 0,
                        lwhisker, loutlier, iqr, q1, q2, q3, rwhisker, routlier, i,
                        size, unitSize;

                    // if (!box._super.render.call(this)) {
                    //     return;
                    // }

                    if (options.get('raw')) {
                        if (options.get('showOutliers') && values.length > 5) {
                            loutlier = values[0];
                            lwhisker = values[1];
                            q1 = values[2];
                            q2 = values[3];
                            q3 = values[4];
                            rwhisker = values[5];
                            routlier = values[6];
                        } else {
                            lwhisker = values[0];
                            q1 = values[1];
                            q2 = values[2];
                            q3 = values[3];
                            rwhisker = values[4];
                        }
                    } else {
                        values.sort(function (a, b) { return a - b; });
                        q1 = quartile(values, 1);
                        q2 = quartile(values, 2);
                        q3 = quartile(values, 3);
                        iqr = q3 - q1;
                        if (options.get('showOutliers')) {
                            lwhisker = rwhisker = undefined;
                            for (i = 0; i < vlen; i++) {
                                if (lwhisker === undefined && values[i] > q1 - (iqr * options.get('outlierIQR'))) {
                                    lwhisker = values[i];
                                }
                                if (values[i] < q3 + (iqr * options.get('outlierIQR'))) {
                                    rwhisker = values[i];
                                }
                            }
                            loutlier = values[0];
                            routlier = values[vlen - 1];
                        } else {
                            lwhisker = values[0];
                            rwhisker = values[vlen - 1];
                        }
                    }
                    this.quartiles = [q1, q2, q3];
                    this.lwhisker = lwhisker;
                    this.rwhisker = rwhisker;
                    this.loutlier = loutlier;
                    this.routlier = routlier;

                    unitSize = canvasWidth / (maxValue - minValue + 1);
                    if (options.get('showOutliers')) {
                        canvasLeft = Math.ceil(options.get('spotRadius'));
                        canvasWidth -= 2 * Math.ceil(options.get('spotRadius'));
                        unitSize = canvasWidth / (maxValue - minValue + 1);
                        if (loutlier < lwhisker) {
                            target.drawCircle((loutlier - minValue) * unitSize + canvasLeft,
                                canvasHeight / 2,
                                options.get('spotRadius'),
                                options.get('outlierLineColor'),
                                options.get('outlierFillColor')).append();
                        }
                        if (routlier > rwhisker) {
                            target.drawCircle((routlier - minValue) * unitSize + canvasLeft,
                                canvasHeight / 2,
                                options.get('spotRadius'),
                                options.get('outlierLineColor'),
                                options.get('outlierFillColor')).append();
                        }
                    }

                    // box
                    target.drawRect(
                        Math.round((q1 - minValue) * unitSize + canvasLeft),
                        Math.round(canvasHeight * 0.1),
                        Math.round((q3 - q1) * unitSize),
                        Math.round(canvasHeight * 0.8),
                        options.get('boxLineColor'),
                        options.get('boxFillColor')).append();
                    // left whisker
                    target.drawLine(
                        Math.round((lwhisker - minValue) * unitSize + canvasLeft),
                        Math.round(canvasHeight / 2),
                        Math.round((q1 - minValue) * unitSize + canvasLeft),
                        Math.round(canvasHeight / 2),
                        options.get('lineColor')).append();
                    target.drawLine(
                        Math.round((lwhisker - minValue) * unitSize + canvasLeft),
                        Math.round(canvasHeight / 4),
                        Math.round((lwhisker - minValue) * unitSize + canvasLeft),
                        Math.round(canvasHeight - canvasHeight / 4),
                        options.get('whiskerColor')).append();
                    // right whisker
                    target.drawLine(Math.round((rwhisker - minValue) * unitSize + canvasLeft),
                        Math.round(canvasHeight / 2),
                        Math.round((q3 - minValue) * unitSize + canvasLeft),
                        Math.round(canvasHeight / 2),
                        options.get('lineColor')).append();
                    target.drawLine(
                        Math.round((rwhisker - minValue) * unitSize + canvasLeft),
                        Math.round(canvasHeight / 4),
                        Math.round((rwhisker - minValue) * unitSize + canvasLeft),
                        Math.round(canvasHeight - canvasHeight / 4),
                        options.get('whiskerColor')).append();
                    // median line
                    target.drawLine(
                        Math.round((q2 - minValue) * unitSize + canvasLeft),
                        Math.round(canvasHeight * 0.1),
                        Math.round((q2 - minValue) * unitSize + canvasLeft),
                        Math.round(canvasHeight * 0.9),
                        options.get('medianColor')).append();
                    if (options.get('target')) {
                        size = Math.ceil(options.get('spotRadius'));
                        target.drawLine(
                            Math.round((options.get('target') - minValue) * unitSize + canvasLeft),
                            Math.round((canvasHeight / 2) - size),
                            Math.round((options.get('target') - minValue) * unitSize + canvasLeft),
                            Math.round((canvasHeight / 2) + size),
                            options.get('targetColor')).append();
                        target.drawLine(
                            Math.round((options.get('target') - minValue) * unitSize + canvasLeft - size),
                            Math.round(canvasHeight / 2),
                            Math.round((options.get('target') - minValue) * unitSize + canvasLeft + size),
                            Math.round(canvasHeight / 2),
                            options.get('targetColor')).append();
                    }
                    //target.render();
                }
            },
            shapeCount:0,
            shapes:{},
            shapeseq:[],
            lastShapeId:null,
            mergedOptions:null,
            init:function(userValues, userOptions){
                var extendedOptions, defaults, base;
                var userOptions = userOptions || {};
                var _this = this;
                defaults = this.defaultOption;
                base = defaults.common;
                extendedOptions = defaults[userOptions.type || base.type];

                _this.shapeCount = 0;
                _this.shapes = {};
                _this.shapeseq = [];
                _this.lastShapeId = null;

                _this.mergedOptions = $.extend({}, base, extendedOptions, userOptions);
                _this.mergedOptions.width = devicePixelRatio * _this.mergedOptions.width;
                _this.mergedOptions.height = devicePixelRatio * _this.mergedOptions.height;
                _this[_this.mergedOptions.type].render(_this, userValues);

                return { shapes:_this.shapes, shapeseq:_this.shapeseq, offsetX:_this.mergedOptions.offsetX, offsetY:_this.mergedOptions.offsetY, pixelWidth:_this.mergedOptions.width, pixelHeight:_this.mergedOptions.height};

            },
            _getContext: function (lineColor, fillColor, lineWidth) {
                if(this.ctx != null){
                    var context = this.ctx;
                }
                else{
                    var context = $("#" + this._canvasID ).get(0).getContext('2d');
                }

                if (lineColor !== undefined) {
                    context.strokeStyle = lineColor;
                }
                context.lineWidth = lineWidth === undefined ? 1 : lineWidth;
                if (fillColor !== undefined) {
                    context.fillStyle = fillColor;
                }
                return context;
            },

            reset: function () {
                var context = this._getContext();
                context.clearRect(0, 0, this.pixelWidth, this.pixelHeight);
                this.shapes = {};
                this.shapeseq = [];
                this.currentTargetShapeId = undefined;
            },

            _drawShape: function (shapeid, path, lineColor, fillColor, lineWidth) {
                var context = this._getContext(lineColor, fillColor, lineWidth),
                    i, plen;
                context.beginPath();
                context.moveTo(path[0][0] + 0.5 + this.offsetX, path[0][1] + 0.5 + this.offsetY);
                
                for (i = 1, plen = path.length; i < plen; i++) {
                    context.lineTo(path[i][0] + 0.5 + this.offsetX, path[i][1] + 0.5 + this.offsetY); // the 0.5 offset gives us crisp pixel-width lines
                }
                if (lineColor !== undefined) {
                    context.stroke();
                }
                if (fillColor !== undefined) {
                    context.fill();
                }
                if (this.targetX !== undefined && this.targetY !== undefined &&
                    context.isPointInPath(this.targetX + this.offsetX, this.targetY + this.offsetY)) {
                    this.currentTargetShapeId = shapeid;
                }
            },

            _drawCircle: function (shapeid, x, y, radius, lineColor, fillColor, lineWidth) {
                var context = this._getContext(lineColor, fillColor, lineWidth);
                context.beginPath();
                x+=this.offsetX;
                y+=this.offsetY;
                context.arc(x, y, radius, 0, 2 * Math.PI, false);
                if (this.targetX !== undefined && this.targetY !== undefined &&
                    context.isPointInPath(this.targetX+this.offsetX, this.targetY+this.offsetY)) {
                    this.currentTargetShapeId = shapeid;
                }
                if (lineColor !== undefined) {
                    context.stroke();
                }
                if (fillColor !== undefined) {
                    context.fill();
                }
            },

            _drawPieSlice: function (shapeid, x, y, radius, startAngle, endAngle, lineColor, fillColor) {
                var context = this._getContext(lineColor, fillColor);
                x+=this.offsetX;
                y+=this.offsetY;
                context.beginPath();
                context.moveTo(x, y);
                context.arc(x, y, radius, startAngle, endAngle, false);
                context.lineTo(x, y);
                context.closePath();
                if (lineColor !== undefined) {
                    context.stroke();
                }
                if (fillColor) {
                    context.fill();
                }
                if (this.targetX !== undefined && this.targetY !== undefined &&
                    context.isPointInPath(this.targetX+this.offsetX, this.targetY+this.offsetY)) {
                    this.currentTargetShapeId = shapeid;
                }
            },

            _drawRect: function (shapeid, x, y, width, height, lineColor, fillColor) {
                // x+=this.offsetX;
                // y+=this.offsetY;
                return this._drawShape(shapeid, [[x, y], [x + width, y], [x + width, y + height], [x, y + height], [x, y]], lineColor, fillColor);
            },

            appendShape: function (shape) {
                this.shapes[shape.id] = shape;
                this.shapeseq.push(shape.id);
                this.lastShapeId = shape.id;
                return shape.id;
            },

            replaceWithShape: function (shapeid, shape) {
                var shapeseq = this.shapeseq,
                    i;
                this.shapes[shape.id] = shape;
                for (i = shapeseq.length; i--;) {
                    if (shapeseq[i] == shapeid) {
                        shapeseq[i] = shape.id;
                    }
                }
                delete this.shapes[shapeid];
            },

            replaceWithShapes: function (shapeids, shapes) {
                var shapeseq = this.shapeseq,
                    shapemap = {},
                    sid, i, first;

                for (i = shapeids.length; i--;) {
                    shapemap[shapeids[i]] = true;
                }
                for (i = shapeseq.length; i--;) {
                    sid = shapeseq[i];
                    if (shapemap[sid]) {
                        shapeseq.splice(i, 1);
                        delete this.shapes[sid];
                        first = i;
                    }
                }
                for (i = shapes.length; i--;) {
                    shapeseq.splice(first, 0, shapes[i].id);
                    this.shapes[shapes[i].id] = shapes[i];
                }

            },

            insertAfterShape: function (shapeid, shape) {
                var shapeseq = this.shapeseq,
                    i;
                for (i = shapeseq.length; i--;) {
                    if (shapeseq[i] === shapeid) {
                        shapeseq.splice(i + 1, 0, shape.id);
                        this.shapes[shape.id] = shape;
                        return;
                    }
                }
            },

            removeShapeId: function (shapeid) {
                var shapeseq = this.shapeseq,
                    i;
                for (i = shapeseq.length; i--;) {
                    if (shapeseq[i] === shapeid) {
                        shapeseq.splice(i, 1);
                        break;
                    }
                }
                delete this.shapes[shapeid];
            },

            getShapeAt: function (el, x, y) {
                this.targetX = x;
                this.targetY = y;
                this.render();
                return this.currentTargetShapeId;
            },
            _canvasID:"jfgridTableContent",
            render: function (shapeseq, shapes, offsetX, offsetY, pixelWidth, pixelHeight,canvasid,ctx) {
                if(canvasid==null){
                    canvasid = "jfgridTableContent";
                }
                this._canvasID = canvasid;

                if(ctx != null){
                    this.ctx = ctx;
                }

                var shapeCount = shapeseq.length,
                    context = this._getContext(),
                    shapeid, shape, i;
                this.offsetX = offsetX;
                this.offsetY = offsetY;
                this.pixelWidth = pixelWidth;
                this.pixelHeight = pixelHeight;
                //context.clearRect(this.offsetX, this.offsetY, this.pixelWidth, this.pixelHeight);

                // qkSparkSetting.currentSparkVlaue = {
                //     shapeseq : shapeseq,
                //     shapes:shapes,
                //     shapeCount:shapeCount,
                //     el:this
                // }

                for (i = 0; i < shapeCount; i++) {
                    shapeid = shapeseq[i];
                    shape = shapes[shapeid];
                    this['_draw' + shape.type].apply(this, shape.args);
                }
                // if (!this.interact) {
                //     // not interactive so no need to keep the shapes array
                //     this.shapes = {};
                //     this.shapeseq = [];
                // }
            },
            drawLine: function (x1, y1, x2, y2, lineColor, lineWidth) {
                return this.drawShape([[x1, y1], [x2, y2]], lineColor, lineWidth);
            },

            drawShape: function (path, lineColor, fillColor, lineWidth) {
                return this._genShape('Shape', [path, lineColor, fillColor, lineWidth]);
            },

            drawCircle: function (x, y, radius, lineColor, fillColor, lineWidth) {
                return this._genShape('Circle', [x, y, radius, lineColor, fillColor, lineWidth]);
            },

            drawPieSlice: function (x, y, radius, startAngle, endAngle, lineColor, fillColor) {
                return this._genShape('PieSlice', [x, y, radius, startAngle, endAngle, lineColor, fillColor]);
            },

            drawRect: function (x, y, width, height, lineColor, fillColor) {
                return this._genShape('Rect', [x, y, width, height, lineColor, fillColor]);
            },
            _genShape: function (shapetype, shapeargs) {
                var id = this.shapeCount++;
                shapeargs.unshift(id);
                // return new VShape(this, id, shapetype, shapeargs);
                // this.target = target;
                // this.id = id;
                // this.type = type;
                // this.args = args;
                var shape = { id:id, type:shapetype, args:shapeargs };
                this.shapes[id] = shape;
                this.shapeseq.push(id);
                this.lastShapeId = id;
                return {
                    append:function(){
                        return shape;
                    },
                    get:function(){
                        return id;
                    }
                };
            }

        }

        var barHighlightMixin = {
            changeHighlight: function (highlight) {
                var currentRegion = this.currentRegion,
                    target = this.target,
                    shapeids = this.regionShapes[currentRegion],
                    newShapes;
                // will be null if the region value was null
                if (shapeids) {
                    newShapes = this.renderRegion(currentRegion, highlight);
                    if ($.isArray(newShapes) || $.isArray(shapeids)) {
                        target.replaceWithShapes(shapeids, newShapes);
                        this.regionShapes[currentRegion] = $.map(newShapes, function (newShape) {
                            return newShape.id;
                        });
                    } else {
                        target.replaceWithShape(shapeids, newShapes);
                        this.regionShapes[currentRegion] = newShapes.id;
                    }
                }
            },
            render: function (el,userValues) {
                this.init(el, userValues);
                var values = this.values,
                    target = this.target,
                    regionShapes = this.regionShapes,
                    shapes, ids, i, j;

                // if (!this.cls._super.render.call(this)) {
                //     return;
                // }
                for (i = values.length; i--;) {
                    shapes = this.renderRegion(i);
                    if (shapes) {
                        if ($.isArray(shapes)) {
                            ids = [];
                            for (j = shapes.length; j--;) {
                                shapes[j].append();
                                ids.push(shapes[j].id);
                            }
                            regionShapes[i] = ids;
                        } else {
                            shapes.append();
                            regionShapes[i] = shapes.id; // store just the shapeid
                        }
                    } else {
                        // null value
                        regionShapes[i] = null;
                    }
                }
                //target.render();
            }
        };

        var _jfgridSparkLineOptions = {
            get:function(type){
                return jfgrid.sparkline.mergedOptions[type];
            }
        }

        var _jfgridSparkLineTarget = {
            drawLine:function(x1, y1, x2, y2, lineColor, lineWidth){
                return jfgrid.sparkline.drawLine(x1, y1, x2, y2, lineColor, lineWidth);
            },

            drawShape:function(path, lineColor, fillColor, lineWidth){
                return jfgrid.sparkline.drawShape(path, lineColor, fillColor, lineWidth);
            },

            drawCircle:function(x, y, radius, lineColor, fillColor, lineWidth){
                return jfgrid.sparkline.drawCircle(x, y, radius, lineColor, fillColor, lineWidth);
            },

            drawPieSlice:function(x, y, radius, startAngle, endAngle, lineColor, fillColor){
                return jfgrid.sparkline.drawPieSlice(x, y, radius, startAngle, endAngle, lineColor, fillColor);
            },

            drawRect:function(x, y, width, height, lineColor, fillColor){
                return jfgrid.sparkline.drawRect(x, y, width, height, lineColor, fillColor);
            }
        }

        // jfgrid.sparkline.line.options = _jfgridSparkLineOptions;
        // jfgrid.sparkline.line.target = _jfgridSparkLineTarget;

        // jfgrid.sparkline.bar.options = _jfgridSparkLineOptions;
        // jfgrid.sparkline.bar.target = _jfgridSparkLineTarget;

        for(item in jfgrid.sparkline){
            if(item in {"line":null, "bar":null, "column":null, "tristate":null, "discrete":null, "bullet":null, "pie":null, "box":null}){
                jfgrid.sparkline[item].options = _jfgridSparkLineOptions;
                jfgrid.sparkline[item].target = _jfgridSparkLineTarget;
            }

            if(item in {"bar":null, "column":null, "tristate":null, "discrete":null}){
                jfgrid.sparkline[item].changeHighlight = barHighlightMixin.changeHighlight;
                jfgrid.sparkline[item].render = barHighlightMixin.render;
            }
        }

        // setTimeout(function(){
        //     var temp1 = jfgrid.sparkline.init([ 1, 3, 5, 8, 10, 15, 18 ], { height:20,width:100,offsetX:100,offsetY:50, type:'box', raw: true, showOutliers:true, target: 6 }) ; jfgrid.sparkline.render(temp1.shapeseq,temp1.shapes,temp1.offsetX*devicePixelRatio,temp1.offsetY*devicePixelRatio,temp1.pixelWidth,temp1.pixelHeight);

        //     var temp1 = jfgrid.sparkline.init([20,50,80], { height:60,width:60,offsetX:100,offsetY:150, type: 'pie' }) ; jfgrid.sparkline.render(temp1.shapeseq,temp1.shapes,temp1.offsetX*devicePixelRatio,temp1.offsetY*devicePixelRatio,temp1.pixelWidth,temp1.pixelHeight);

        //     var temp1 = jfgrid.sparkline.init([10,12,12,9,7], { height:20,width:100,offsetX:100,offsetY:250, type: 'bullet' }) ; jfgrid.sparkline.render(temp1.shapeseq,temp1.shapes,temp1.offsetX*devicePixelRatio,temp1.offsetY*devicePixelRatio,temp1.pixelWidth,temp1.pixelHeight);

        //     var temp1 = jfgrid.sparkline.init([4,6,7,7,4,3,2,1,4,4,5,6,7,6,6,2,4,5], { height:20,width:100,offsetX:100,offsetY:350, type: 'discrete', thresholdValue: 4  }) ; jfgrid.sparkline.render(temp1.shapeseq,temp1.shapes,temp1.offsetX*devicePixelRatio,temp1.offsetY*devicePixelRatio,temp1.pixelWidth,temp1.pixelHeight);

        //     var temp1 = jfgrid.sparkline.init([1,2,0,5,-1,-2,1,-4,0,0,1,1], { type: 'tristate',height:20,width:100,offsetX:300,offsetY:150, colorMap: {'-2': '#fa7', '2': '#44f'}  }) ; jfgrid.sparkline.render(temp1.shapeseq,temp1.shapes,temp1.offsetX*devicePixelRatio,temp1.offsetY*devicePixelRatio,temp1.pixelidth,temp1.pixelHeight);

        //     var temp1 = jfgrid.sparkline.init([10,5,3], { type: 'bar',height:30,width:20,offsetX:300,offsetY:250 }) ; jfgrid.sparkline.render(temp1.shapeseq,temp1.shapes,temp1.offsetX*devicePixelRatio,temp1.offsetY*devicePixelRatio,temp1.pixelWidth,temp1.pixelHeight);

        //     var temp1 = jfgrid.sparkline.init([4,1,5,7,9,9,8,7,6,6,4,7,8,4,3,2,2,5,6,7], { height:50,width:90,normalRangeMin:6,normalRangeMax:6,normalRangeColor:"#000" });jfgrid.sparkline.render(temp1.shapeseq,temp1.shapes,300*devicePixelRatio,50*devicePixelRatio,temp1.pixelWidth,temp1.pixelHeight);

        //     var temp1 = jfgrid.sparkline.init([10,8,3,-5,5,8,-9], { type: 'bar',height:40,width:60,offsetX:300,offsetY:350 }) ; jfgrid.sparkline.render(temp1.shapeseq,temp1.shapes,temp1.offsetX*devicePixelRatio,temp1.offsetY*devicePixelRatio,temp1.pixelWidth,temp1.pixelHeight);

        //     var temp1 = jfgrid.sparkline.init(["0:2:12","2:6:10","7:2:5","4:10:8","10:1:4"], { type: 'bar',height:40,width:60,offsetX:500,offsetY:50 }) ; jfgrid.sparkline.render(temp1.shapeseq,temp1.shapes,temp1.offsetX*devicePixelRatio,temp1.offsetY*devicePixelRatio,temp1.pixelWidth,temp1.pixelHeight);

        //     var temp1 = jfgrid.sparkline.init(["0:2","2:4","4:2","4:1"], { type: 'bar',height:40,width:60,offsetX:500,offsetY:150 }) ; jfgrid.sparkline.render(temp1.shapeseq,temp1.shapes,temp1.offsetX*devicePixelRatio,temp1.offsetY*devicePixelRatio,temp1.pixelWidth,temp1.pixelHeight);

        //     var temp1 = jfgrid.sparkline.init(["0:2","2:4","4:2","4:1"], { type: 'column',height:40,width:60,offsetX:500,offsetY:250 }) ; jfgrid.sparkline.render(temp1.shapeseq,temp1.shapes,temp1.offsetX*devicePixelRatio,temp1.offsetY*devicePixelRatio,temp1.pixelWidth,temp1.pixelHeight);

        // },3000);

    })();
    window.jfgrid = jfgrid;
    window.jfgridConfigsetting = jfgridConfigsetting;
    return jfgrid;
})();